{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md"}, "tool_use_id": "toolu_01Bx2sNiw5pZALuvDKocYdUQ", "_ts": "2026-02-20T11:31:11+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md", "content": "# OpenClaw TODO Plugin for Slack — PRD v1.1 (DM 기반)\n\n> 변경사항 반영:\n> 1) Slack **슬래시 커맨드 미사용** → **DM(또는 앱 멘션/일반 메시지)에서 `/todo …`**로 사용  \n> 2) private 프로젝트: **same owner 내 name 유니크**  \n> 3) `/todo project set-private` 실행 시: 해당 프로젝트 내 task 중 **owner가 아닌 assignee가 하나라도 있으면 에러**  \n> 4) 프로젝트 이름 충돌 해소: **옵션 A(private 우선)** 유지  \n> 5) DB **초기 생성/마이그레이션** 절차 추가\n\n---\n\n## 1) 개요\n\n### 1.1 목표\nOpenClaw 플러그인으로 Slack에서 다음을 **LLM 호출 없이(=비용 0)** 처리하는 팀/개인용 TODO 시스템을 제공한다.\n\n- `/todo add|list|board|move|done|drop|edit`\n- `/todo project list|set-private|set-shared`\n- 저장소: **공유 SQLite3** (동일 Gateway/동일 DB 파일)\n- 담당자(assignee): **Slack 멘션만 허용** (`<@U…>` 기반)\n- due: `YYYY-MM-DD` 또는 `MM-DD` 허용, 연도 생략 시 **현재 연도**로 보정\n- Private 프로젝트: **오직 owner만** 조회/수정 가능\n\n---\n\n## 2) Slack 사용 방식 (슬래시 커맨드 미사용)\n\n### 2.1 사용 채널\n슬래시 커맨드를 쓰지 않는다면, 일반적으로 다음 중 하나로 사용한다.\n\n- **DM 채널**: OpenClaw Slack 앱(봇)과 1:1 대화에서 `/todo …` 입력  \n- **채널/스레드**(옵션): 앱 멘션(`@openclaw /todo …`) 또는 특정 메시지 패턴을 OpenClaw가 수신하도록 설정된 경우\n\n> v1은 **DM 사용을 기본 경로**로 가정한다.  \n> 이유: 권한/노이즈/오작동 리스크가 낮고 운영이 단순함.\n\n### 2.2 커맨드 인식 규칙\n- 메시지의 첫 토큰이 `/todo`이면 플러그인이 처리한다.\n- 그 외 메시지는 v1에서 무시(자연어 자동 등록은 Phase 2).\n\n---\n\n## 3) 핵심 정책\n\n### 3.1 프로젝트 이름 유니크 정책\n- **Shared 프로젝트**: 전역 유니크 (겹치면 생성/변경 거부)\n- **Private 프로젝트**: **same owner 내에서만 유니크** (owner가 다르면 동일 name 허용)\n\n### 3.2 프로젝트 이름 충돌 해소(옵션 A)\n`/p <name>` 해석:\n1) sender(owner)의 private 프로젝트 `<name>`가 존재하면 **private 우선**\n2) 없으면 shared `<name>` 사용\n3) 둘 다 없으면 (v1 정책에 따라) shared 자동 생성 또는 에러\n\n> 운영 가이드: private와 shared에 같은 이름을 쓰지 않는 것을 권장(혼란 방지).\n\n### 3.3 Private 프로젝트 assignee 제한(“경고 후 거부”)\n- private 프로젝트는 **owner만 볼 수 있는 범위**이므로:\n  - add/edit 시 owner 이외의 assignee가 포함되면 **경고 메시지 출력 후 작업 거부(변경/생성 미적용)**\n\n경고/거부 응답 예시:\n- `⚠️ Private 프로젝트(Personal)는 owner만 볼 수 있어요. 다른 담당자(<@U…>)를 지정할 수 없습니다. (요청이 적용되지 않았습니다.)`\n\n### 3.4 `/todo project set-private` 추가 제약(요구사항)\n- 프로젝트를 private로 전환할 때,\n  - 해당 프로젝트 내 모든 task를 스캔하여\n  - **owner가 아닌 assignee가 하나라도 존재하면 에러**로 실패해야 한다.\n- 에러 메시지에는 최소한 아래 정보를 포함한다:\n  - 실패 사유\n  - 위반 task id 목록 일부(예: 최대 10개)\n  - 위반 assignee 목록 일부\n\n에러 예시:\n- `❌ Cannot set project \"Biz\" to private: found tasks assigned to non-owner users. e.g. #12 assignees:<@U2>, #18 assignees:<@U3>`\n\n---\n\n## 4) due 파서 정책\n\n허용 입력:\n- `due:YYYY-MM-DD`\n- `due:MM-DD` 또는 `due:M-D`\n\n보정:\n- 연도 생략 시: `YYYY = now().year` (서버 timezone은 Asia/Seoul 권장)\n\n검증:\n- 유효하지 않은 날짜(예: 02-30)는 에러\n- DB에는 항상 `YYYY-MM-DD`로 저장\n\n---\n\n## 5) 커맨드 스펙\n\n### 5.0 공통 토큰\n- 프로젝트: `/p <projectName>`\n- 섹션: `/s <section>`\n- 섹션 enum: `backlog | doing | waiting | done | drop`\n- due: `due:YYYY-MM-DD|MM-DD` 또는 `due:-`(클리어)\n\n---\n\n### 5.1 `/todo add`\n문법:\n```\n/todo add <title...> [<@USER> ...] [/p <project>] [/s <section>] [due:YYYY-MM-DD|MM-DD]\n```\n\n기본값:\n- project: `Inbox`\n- section: `backlog`\n- assignees:\n  - 멘션 없으면 sender\n  - 멘션 있으면 해당 유저들(다중)\n- due: 없으면 NULL\n\n검증:\n- private 프로젝트에 sender 외 assignee 포함 시: **경고 후 거부**\n- 프로젝트가 없으면:\n  - `Inbox`는 shared로 자동 생성 가능(권장)\n\n응답:\n- `✅ Added #123 (Inbox/backlog) due:- assignees:<@U1> — 장보기`\n\n---\n\n### 5.2 `/todo list`\n문법:\n```\n/todo list [mine|all|<@USER>] [/p <project>] [/s <section>] [open|done|drop] [limit:N]\n```\n\n기본값:\n- scope: `mine`\n- status: `open`\n- limit: 30\n\nscope 의미:\n- `mine`: assignees에 sender 포함\n- `<@USER>`: 해당 유저가 assignee인 task\n- `all`: shared 전체 + sender의 private 프로젝트(타인의 private는 제외)\n\n정렬:\n1) due 있는 것 우선\n2) due 오름차순\n3) id 내림차순\n\n---\n\n### 5.3 `/todo board`\n문법:\n```\n/todo board [mine|all|<@USER>] [/p <project>] [open|done|drop] [limitPerSection:N]\n```\n\n기본값:\n- scope: mine\n- status: open\n- limitPerSection: 10\n\n출력:\n- BACKLOG → DOING → WAITING → DONE → DROP 순\n- 항목 포맷: `#id due:YYYY-MM-DD| - assignees:<@U..> <@U..> title`\n\n---\n\n### 5.4 `/todo move`\n문법:\n```\n/todo move <id> <section>\n```\n\n검증:\n- 섹션 enum validate\n- 권한:\n  - private: owner만\n  - shared: v1 권장 `assignee` 또는 `created_by`만 수정 가능\n\n---\n\n### 5.5 `/todo done`\n```\n/todo done <id>\n```\n- section=`done`, status=`done`, closed_at 기록\n\n### 5.6 `/todo drop`\n```\n/todo drop <id>\n```\n- section=`drop`, status=`dropped`, closed_at 기록\n\n---\n\n### 5.7 `/todo edit`\n문법(v1 replace 방식):\n```\n/todo edit <id> [<new title...>] [<@USER> ...] [/p <project>] [/s <section>] [due:YYYY-MM-DD|MM-DD|due:-]\n```\n\n규칙:\n- 멘션이 있으면 assignees **완전 교체**\n- `due:-` 는 due NULL\n- title은 옵션 토큰 이전 텍스트를 새 title로 간주(비어있으면 변경 없음)\n\n검증:\n- private 프로젝트로 변경되거나 private 프로젝트에서 assignee 변경 시:\n  - sender 외 assignee 포함이면 **경고 후 거부(변경 미적용)**\n\n---\n\n### 5.8 `/todo project list`\n- 반환:\n  - shared 프로젝트 목록\n  - sender(owner)의 private 프로젝트 목록\n\n---\n\n### 5.9 `/todo project set-private <name>`\n동작:\n1) 대상 프로젝트를 resolve:\n   - sender의 private `<name>` 존재 → already private (ok)\n   - 없고 shared `<name>` 존재 → shared를 private로 “전환 시도”\n   - 둘 다 없으면 → sender private `<name>` 생성 (owner=sender)\n\n2) shared→private 전환 시도 시 검증:\n   - 해당 프로젝트 내 tasks를 조회\n   - 각 task에 대해 `task_assignees`를 확인\n   - **owner(sender) 외 assignee가 하나라도 존재하면 실패(에러)**\n\n3) 성공 시:\n   - projects.visibility='private', owner_user_id=sender\n   - (선택) 기존 task의 assignees가 모두 owner인지 확인되므로 유지 가능\n\n---\n\n### 5.10 `/todo project set-shared <name>`\n동작:\n- shared `<name>`이 없으면 생성\n- 이미 있으면 noop\n- 단, shared는 전역 유니크이므로 충돌 시 에러/exists\n\n---\n\n## 6) 데이터 모델 (SQLite3)\n\n### 6.1 DB 파일 위치\n- 기본: `~/.openclaw/workspace/.todo/todo.sqlite3`\n\n### 6.2 동시성 설정\n- `PRAGMA journal_mode=WAL;`\n- `PRAGMA busy_timeout=3000;`\n\n### 6.3 스키마(v1)\n\n#### `projects`\n- `id` INTEGER PK AUTOINCREMENT\n- `name` TEXT NOT NULL\n- `visibility` TEXT NOT NULL CHECK (visibility IN ('shared','private'))\n- `owner_user_id` TEXT NULL\n- `created_at` TEXT NOT NULL DEFAULT (datetime('now'))\n- `updated_at` TEXT NOT NULL DEFAULT (datetime('now'))\n\nIndexes:\n- shared 전역 유니크:\n  - `CREATE UNIQUE INDEX ux_projects_shared_name ON projects(name) WHERE visibility='shared';`\n- private owner 내 유니크:\n  - `CREATE UNIQUE INDEX ux_projects_private_owner_name ON projects(owner_user_id, name) WHERE visibility='private';`\n\n#### `tasks`\n- `id` INTEGER PK AUTOINCREMENT\n- `title` TEXT NOT NULL\n- `project_id` INTEGER NOT NULL REFERENCES projects(id)\n- `section` TEXT NOT NULL CHECK (section IN ('backlog','doing','waiting','done','drop'))\n- `due` TEXT NULL  -- YYYY-MM-DD\n- `status` TEXT NOT NULL CHECK (status IN ('open','done','dropped'))\n- `created_by` TEXT NOT NULL  -- Slack user id\n- `created_at`, `updated_at`, `closed_at`\n\n#### `task_assignees`\n- `task_id` INTEGER NOT NULL REFERENCES tasks(id)\n- `assignee_user_id` TEXT NOT NULL\n- PRIMARY KEY(task_id, assignee_user_id)\n- INDEX: `(assignee_user_id, task_id)`\n\n#### `events` (audit, 권장)\n- `id` INTEGER PK\n- `ts` TEXT\n- `actor_user_id` TEXT\n- `action` TEXT\n- `task_id` INTEGER NULL\n- `payload` TEXT (JSON)\n\n---\n\n## 7) DB 초기 생성 / 마이그레이션(필수)\n\n### 7.1 생성 타이밍\n플러그인 로딩 후 첫 `/todo …` 실행 시 또는 gateway startup 시점에 아래를 수행:\n\n1) workspace path 결정\n2) `~/.openclaw/workspace/.todo/` 디렉토리 생성\n3) `todo.sqlite3` 파일 존재 여부 확인\n4) 없으면:\n   - 파일 생성\n   - schema migration 실행\n   - `schema_version` 테이블 생성 및 version=1 기록\n\n### 7.2 schema_version 테이블\n- `schema_version(version INTEGER NOT NULL)`\n- 초기: 1\n- 향후:\n  - 현재 버전 읽고, 필요한 migration 순차 실행\n\n### 7.3 기본 프로젝트 생성(권장)\n- DB 초기화 시 shared 프로젝트 `Inbox` 자동 생성 (중복이면 noop)\n\n---\n\n## 8) 권한/가시성\n\n### 8.1 읽기\n- private: owner만\n- shared: scope에 따라 mine/all/<@USER>\n\n### 8.2 쓰기\n- private: owner만\n- shared: v1 권장 `assignee` 또는 `created_by`만\n\n---\n\n## 9) 수용 기준(Acceptance Criteria)\n\n- [ ] shared 프로젝트 이름 충돌 시 생성/변경 거부\n- [ ] private 프로젝트는 owner 단위로 유니크 (owner A/B는 같은 name 허용)\n- [ ] `/todo project set-private <name>` 실행 시:\n  - 프로젝트 내 task 중 owner 외 assignee 존재하면 에러로 실패\n- [ ] private 프로젝트에 타 assignee 지정 시: 경고 + 작업 미생성/미수정\n- [ ] due `MM-DD` 입력 시 올해로 보정되어 저장\n- [ ] DB 최초 실행 시 파일 생성 + schema 적용 + Inbox 생성\n\n---\n\n## 10) 구현 작업 분해(WBS)\n\n- M0: plugin skeleton + `/todo` command 등록\n- M1: DB init + migrations + schema_version\n- M2: parser (Slack mention, /p, /s, due 보정)\n- M3: commands (add/list/board/move/done/drop/edit)\n- M4: project commands (list/set-private/set-shared + set-private 검증 로직)\n- M5: tests (parser/unit + sqlite E2E)\n- M6: packaging/배포(npm 권장)\n", "numLines": 353, "startLine": 1, "totalLines": 353}}, "tool_use_id": "toolu_01Bx2sNiw5pZALuvDKocYdUQ", "_ts": "2026-02-20T11:31:11+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "mkdir -p /Users/pillip/project/practice/openclaw_todo_plugin/docs", "description": "Create docs directory"}, "tool_use_id": "toolu_013q19d1Csp9cfJW5aqkMr9h", "_ts": "2026-02-20T11:31:12+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "mkdir -p /Users/pillip/project/practice/openclaw_todo_plugin/docs", "description": "Create docs directory"}, "tool_response": {"stdout": "", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": true}, "tool_use_id": "toolu_013q19d1Csp9cfJW5aqkMr9h", "_ts": "2026-02-20T11:31:18+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Task", "tool_input": {"description": "Analyze requirements from PRD", "prompt": "Read the PRD at /Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md and produce a requirements document.\n\nWrite the output to /Users/pillip/project/practice/openclaw_todo_plugin/docs/requirements.md\n\nThe PRD describes an OpenClaw TODO Plugin for Slack — a team/personal TODO system that works via DM with a Slack bot, using SQLite3 for storage, with commands like /todo add|list|board|move|done|drop|edit and project management commands. Key features include private/shared projects, due date parsing, assignee management via Slack mentions, and schema migration.\n\nProduce crisp requirements covering: functional requirements, non-functional requirements, scope, assumptions, constraints, and success metrics. Write in English.", "subagent_type": "requirement-analyst", "run_in_background": true}, "tool_use_id": "toolu_01M364bqdexvkDSJtcMGSLUW", "_ts": "2026-02-20T11:31:28+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "hook_event_name": "SubagentStart", "agent_id": "a8f503f", "agent_type": "requirement-analyst", "_ts": "2026-02-20T11:31:28+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Task", "tool_input": {"description": "Analyze requirements from PRD", "prompt": "Read the PRD at /Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md and produce a requirements document.\n\nWrite the output to /Users/pillip/project/practice/openclaw_todo_plugin/docs/requirements.md\n\nThe PRD describes an OpenClaw TODO Plugin for Slack — a team/personal TODO system that works via DM with a Slack bot, using SQLite3 for storage, with commands like /todo add|list|board|move|done|drop|edit and project management commands. Key features include private/shared projects, due date parsing, assignee management via Slack mentions, and schema migration.\n\nProduce crisp requirements covering: functional requirements, non-functional requirements, scope, assumptions, constraints, and success metrics. Write in English.", "subagent_type": "requirement-analyst", "run_in_background": true}, "tool_response": {"isAsync": true, "status": "async_launched", "agentId": "a8f503f", "description": "Analyze requirements from PRD", "prompt": "Read the PRD at /Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md and produce a requirements document.\n\nWrite the output to /Users/pillip/project/practice/openclaw_todo_plugin/docs/requirements.md\n\nThe PRD describes an OpenClaw TODO Plugin for Slack — a team/personal TODO system that works via DM with a Slack bot, using SQLite3 for storage, with commands like /todo add|list|board|move|done|drop|edit and project management commands. Key features include private/shared projects, due date parsing, assignee management via Slack mentions, and schema migration.\n\nProduce crisp requirements covering: functional requirements, non-functional requirements, scope, assumptions, constraints, and success metrics. Write in English.", "outputFile": "/private/tmp/claude-501/-Users-pillip-project-practice-openclaw-todo-plugin/tasks/a8f503f.output"}, "tool_use_id": "toolu_01M364bqdexvkDSJtcMGSLUW", "_ts": "2026-02-20T11:31:28+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md"}, "tool_use_id": "toolu_01E7EEt8oLYqQe2fFKVAQrFW", "_ts": "2026-02-20T11:31:31+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md", "content": "# OpenClaw TODO Plugin for Slack — PRD v1.1 (DM 기반)\n\n> 변경사항 반영:\n> 1) Slack **슬래시 커맨드 미사용** → **DM(또는 앱 멘션/일반 메시지)에서 `/todo …`**로 사용  \n> 2) private 프로젝트: **same owner 내 name 유니크**  \n> 3) `/todo project set-private` 실행 시: 해당 프로젝트 내 task 중 **owner가 아닌 assignee가 하나라도 있으면 에러**  \n> 4) 프로젝트 이름 충돌 해소: **옵션 A(private 우선)** 유지  \n> 5) DB **초기 생성/마이그레이션** 절차 추가\n\n---\n\n## 1) 개요\n\n### 1.1 목표\nOpenClaw 플러그인으로 Slack에서 다음을 **LLM 호출 없이(=비용 0)** 처리하는 팀/개인용 TODO 시스템을 제공한다.\n\n- `/todo add|list|board|move|done|drop|edit`\n- `/todo project list|set-private|set-shared`\n- 저장소: **공유 SQLite3** (동일 Gateway/동일 DB 파일)\n- 담당자(assignee): **Slack 멘션만 허용** (`<@U…>` 기반)\n- due: `YYYY-MM-DD` 또는 `MM-DD` 허용, 연도 생략 시 **현재 연도**로 보정\n- Private 프로젝트: **오직 owner만** 조회/수정 가능\n\n---\n\n## 2) Slack 사용 방식 (슬래시 커맨드 미사용)\n\n### 2.1 사용 채널\n슬래시 커맨드를 쓰지 않는다면, 일반적으로 다음 중 하나로 사용한다.\n\n- **DM 채널**: OpenClaw Slack 앱(봇)과 1:1 대화에서 `/todo …` 입력  \n- **채널/스레드**(옵션): 앱 멘션(`@openclaw /todo …`) 또는 특정 메시지 패턴을 OpenClaw가 수신하도록 설정된 경우\n\n> v1은 **DM 사용을 기본 경로**로 가정한다.  \n> 이유: 권한/노이즈/오작동 리스크가 낮고 운영이 단순함.\n\n### 2.2 커맨드 인식 규칙\n- 메시지의 첫 토큰이 `/todo`이면 플러그인이 처리한다.\n- 그 외 메시지는 v1에서 무시(자연어 자동 등록은 Phase 2).\n\n---\n\n## 3) 핵심 정책\n\n### 3.1 프로젝트 이름 유니크 정책\n- **Shared 프로젝트**: 전역 유니크 (겹치면 생성/변경 거부)\n- **Private 프로젝트**: **same owner 내에서만 유니크** (owner가 다르면 동일 name 허용)\n\n### 3.2 프로젝트 이름 충돌 해소(옵션 A)\n`/p <name>` 해석:\n1) sender(owner)의 private 프로젝트 `<name>`가 존재하면 **private 우선**\n2) 없으면 shared `<name>` 사용\n3) 둘 다 없으면 (v1 정책에 따라) shared 자동 생성 또는 에러\n\n> 운영 가이드: private와 shared에 같은 이름을 쓰지 않는 것을 권장(혼란 방지).\n\n### 3.3 Private 프로젝트 assignee 제한(“경고 후 거부”)\n- private 프로젝트는 **owner만 볼 수 있는 범위**이므로:\n  - add/edit 시 owner 이외의 assignee가 포함되면 **경고 메시지 출력 후 작업 거부(변경/생성 미적용)**\n\n경고/거부 응답 예시:\n- `⚠️ Private 프로젝트(Personal)는 owner만 볼 수 있어요. 다른 담당자(<@U…>)를 지정할 수 없습니다. (요청이 적용되지 않았습니다.)`\n\n### 3.4 `/todo project set-private` 추가 제약(요구사항)\n- 프로젝트를 private로 전환할 때,\n  - 해당 프로젝트 내 모든 task를 스캔하여\n  - **owner가 아닌 assignee가 하나라도 존재하면 에러**로 실패해야 한다.\n- 에러 메시지에는 최소한 아래 정보를 포함한다:\n  - 실패 사유\n  - 위반 task id 목록 일부(예: 최대 10개)\n  - 위반 assignee 목록 일부\n\n에러 예시:\n- `❌ Cannot set project \"Biz\" to private: found tasks assigned to non-owner users. e.g. #12 assignees:<@U2>, #18 assignees:<@U3>`\n\n---\n\n## 4) due 파서 정책\n\n허용 입력:\n- `due:YYYY-MM-DD`\n- `due:MM-DD` 또는 `due:M-D`\n\n보정:\n- 연도 생략 시: `YYYY = now().year` (서버 timezone은 Asia/Seoul 권장)\n\n검증:\n- 유효하지 않은 날짜(예: 02-30)는 에러\n- DB에는 항상 `YYYY-MM-DD`로 저장\n\n---\n\n## 5) 커맨드 스펙\n\n### 5.0 공통 토큰\n- 프로젝트: `/p <projectName>`\n- 섹션: `/s <section>`\n- 섹션 enum: `backlog | doing | waiting | done | drop`\n- due: `due:YYYY-MM-DD|MM-DD` 또는 `due:-`(클리어)\n\n---\n\n### 5.1 `/todo add`\n문법:\n```\n/todo add <title...> [<@USER> ...] [/p <project>] [/s <section>] [due:YYYY-MM-DD|MM-DD]\n```\n\n기본값:\n- project: `Inbox`\n- section: `backlog`\n- assignees:\n  - 멘션 없으면 sender\n  - 멘션 있으면 해당 유저들(다중)\n- due: 없으면 NULL\n\n검증:\n- private 프로젝트에 sender 외 assignee 포함 시: **경고 후 거부**\n- 프로젝트가 없으면:\n  - `Inbox`는 shared로 자동 생성 가능(권장)\n\n응답:\n- `✅ Added #123 (Inbox/backlog) due:- assignees:<@U1> — 장보기`\n\n---\n\n### 5.2 `/todo list`\n문법:\n```\n/todo list [mine|all|<@USER>] [/p <project>] [/s <section>] [open|done|drop] [limit:N]\n```\n\n기본값:\n- scope: `mine`\n- status: `open`\n- limit: 30\n\nscope 의미:\n- `mine`: assignees에 sender 포함\n- `<@USER>`: 해당 유저가 assignee인 task\n- `all`: shared 전체 + sender의 private 프로젝트(타인의 private는 제외)\n\n정렬:\n1) due 있는 것 우선\n2) due 오름차순\n3) id 내림차순\n\n---\n\n### 5.3 `/todo board`\n문법:\n```\n/todo board [mine|all|<@USER>] [/p <project>] [open|done|drop] [limitPerSection:N]\n```\n\n기본값:\n- scope: mine\n- status: open\n- limitPerSection: 10\n\n출력:\n- BACKLOG → DOING → WAITING → DONE → DROP 순\n- 항목 포맷: `#id due:YYYY-MM-DD| - assignees:<@U..> <@U..> title`\n\n---\n\n### 5.4 `/todo move`\n문법:\n```\n/todo move <id> <section>\n```\n\n검증:\n- 섹션 enum validate\n- 권한:\n  - private: owner만\n  - shared: v1 권장 `assignee` 또는 `created_by`만 수정 가능\n\n---\n\n### 5.5 `/todo done`\n```\n/todo done <id>\n```\n- section=`done`, status=`done`, closed_at 기록\n\n### 5.6 `/todo drop`\n```\n/todo drop <id>\n```\n- section=`drop`, status=`dropped`, closed_at 기록\n\n---\n\n### 5.7 `/todo edit`\n문법(v1 replace 방식):\n```\n/todo edit <id> [<new title...>] [<@USER> ...] [/p <project>] [/s <section>] [due:YYYY-MM-DD|MM-DD|due:-]\n```\n\n규칙:\n- 멘션이 있으면 assignees **완전 교체**\n- `due:-` 는 due NULL\n- title은 옵션 토큰 이전 텍스트를 새 title로 간주(비어있으면 변경 없음)\n\n검증:\n- private 프로젝트로 변경되거나 private 프로젝트에서 assignee 변경 시:\n  - sender 외 assignee 포함이면 **경고 후 거부(변경 미적용)**\n\n---\n\n### 5.8 `/todo project list`\n- 반환:\n  - shared 프로젝트 목록\n  - sender(owner)의 private 프로젝트 목록\n\n---\n\n### 5.9 `/todo project set-private <name>`\n동작:\n1) 대상 프로젝트를 resolve:\n   - sender의 private `<name>` 존재 → already private (ok)\n   - 없고 shared `<name>` 존재 → shared를 private로 “전환 시도”\n   - 둘 다 없으면 → sender private `<name>` 생성 (owner=sender)\n\n2) shared→private 전환 시도 시 검증:\n   - 해당 프로젝트 내 tasks를 조회\n   - 각 task에 대해 `task_assignees`를 확인\n   - **owner(sender) 외 assignee가 하나라도 존재하면 실패(에러)**\n\n3) 성공 시:\n   - projects.visibility='private', owner_user_id=sender\n   - (선택) 기존 task의 assignees가 모두 owner인지 확인되므로 유지 가능\n\n---\n\n### 5.10 `/todo project set-shared <name>`\n동작:\n- shared `<name>`이 없으면 생성\n- 이미 있으면 noop\n- 단, shared는 전역 유니크이므로 충돌 시 에러/exists\n\n---\n\n## 6) 데이터 모델 (SQLite3)\n\n### 6.1 DB 파일 위치\n- 기본: `~/.openclaw/workspace/.todo/todo.sqlite3`\n\n### 6.2 동시성 설정\n- `PRAGMA journal_mode=WAL;`\n- `PRAGMA busy_timeout=3000;`\n\n### 6.3 스키마(v1)\n\n#### `projects`\n- `id` INTEGER PK AUTOINCREMENT\n- `name` TEXT NOT NULL\n- `visibility` TEXT NOT NULL CHECK (visibility IN ('shared','private'))\n- `owner_user_id` TEXT NULL\n- `created_at` TEXT NOT NULL DEFAULT (datetime('now'))\n- `updated_at` TEXT NOT NULL DEFAULT (datetime('now'))\n\nIndexes:\n- shared 전역 유니크:\n  - `CREATE UNIQUE INDEX ux_projects_shared_name ON projects(name) WHERE visibility='shared';`\n- private owner 내 유니크:\n  - `CREATE UNIQUE INDEX ux_projects_private_owner_name ON projects(owner_user_id, name) WHERE visibility='private';`\n\n#### `tasks`\n- `id` INTEGER PK AUTOINCREMENT\n- `title` TEXT NOT NULL\n- `project_id` INTEGER NOT NULL REFERENCES projects(id)\n- `section` TEXT NOT NULL CHECK (section IN ('backlog','doing','waiting','done','drop'))\n- `due` TEXT NULL  -- YYYY-MM-DD\n- `status` TEXT NOT NULL CHECK (status IN ('open','done','dropped'))\n- `created_by` TEXT NOT NULL  -- Slack user id\n- `created_at`, `updated_at`, `closed_at`\n\n#### `task_assignees`\n- `task_id` INTEGER NOT NULL REFERENCES tasks(id)\n- `assignee_user_id` TEXT NOT NULL\n- PRIMARY KEY(task_id, assignee_user_id)\n- INDEX: `(assignee_user_id, task_id)`\n\n#### `events` (audit, 권장)\n- `id` INTEGER PK\n- `ts` TEXT\n- `actor_user_id` TEXT\n- `action` TEXT\n- `task_id` INTEGER NULL\n- `payload` TEXT (JSON)\n\n---\n\n## 7) DB 초기 생성 / 마이그레이션(필수)\n\n### 7.1 생성 타이밍\n플러그인 로딩 후 첫 `/todo …` 실행 시 또는 gateway startup 시점에 아래를 수행:\n\n1) workspace path 결정\n2) `~/.openclaw/workspace/.todo/` 디렉토리 생성\n3) `todo.sqlite3` 파일 존재 여부 확인\n4) 없으면:\n   - 파일 생성\n   - schema migration 실행\n   - `schema_version` 테이블 생성 및 version=1 기록\n\n### 7.2 schema_version 테이블\n- `schema_version(version INTEGER NOT NULL)`\n- 초기: 1\n- 향후:\n  - 현재 버전 읽고, 필요한 migration 순차 실행\n\n### 7.3 기본 프로젝트 생성(권장)\n- DB 초기화 시 shared 프로젝트 `Inbox` 자동 생성 (중복이면 noop)\n\n---\n\n## 8) 권한/가시성\n\n### 8.1 읽기\n- private: owner만\n- shared: scope에 따라 mine/all/<@USER>\n\n### 8.2 쓰기\n- private: owner만\n- shared: v1 권장 `assignee` 또는 `created_by`만\n\n---\n\n## 9) 수용 기준(Acceptance Criteria)\n\n- [ ] shared 프로젝트 이름 충돌 시 생성/변경 거부\n- [ ] private 프로젝트는 owner 단위로 유니크 (owner A/B는 같은 name 허용)\n- [ ] `/todo project set-private <name>` 실행 시:\n  - 프로젝트 내 task 중 owner 외 assignee 존재하면 에러로 실패\n- [ ] private 프로젝트에 타 assignee 지정 시: 경고 + 작업 미생성/미수정\n- [ ] due `MM-DD` 입력 시 올해로 보정되어 저장\n- [ ] DB 최초 실행 시 파일 생성 + schema 적용 + Inbox 생성\n\n---\n\n## 10) 구현 작업 분해(WBS)\n\n- M0: plugin skeleton + `/todo` command 등록\n- M1: DB init + migrations + schema_version\n- M2: parser (Slack mention, /p, /s, due 보정)\n- M3: commands (add/list/board/move/done/drop/edit)\n- M4: project commands (list/set-private/set-shared + set-private 검증 로직)\n- M5: tests (parser/unit + sqlite E2E)\n- M6: packaging/배포(npm 권장)\n", "numLines": 353, "startLine": 1, "totalLines": 353}}, "tool_use_id": "toolu_01E7EEt8oLYqQe2fFKVAQrFW", "_ts": "2026-02-20T11:31:31+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Glob", "tool_input": {"pattern": "**/*", "path": "/Users/pillip/project/practice/openclaw_todo_plugin"}, "tool_use_id": "toolu_01BAVkyGeE5KXxXQrEvUXDGQ", "_ts": "2026-02-20T11:31:31+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Glob", "tool_input": {"pattern": "**/*", "path": "/Users/pillip/project/practice/openclaw_todo_plugin"}, "tool_response": {"filenames": ["/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/info/exclude", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/description", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/commit-msg.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/pre-rebase.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/sendemail-validate.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/pre-commit.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/applypatch-msg.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/fsmonitor-watchman.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/pre-receive.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/prepare-commit-msg.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/post-update.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/pre-merge-commit.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/pre-applypatch.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/pre-push.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/update.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/push-to-checkout.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/objects/pack/pack-63ec6b0dc8c5da799a8300af63320c984b8a15fc.pack", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/objects/pack/pack-63ec6b0dc8c5da799a8300af63320c984b8a15fc.idx", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/objects/pack/pack-63ec6b0dc8c5da799a8300af63320c984b8a15fc.rev", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/packed-refs", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/logs/refs/remotes/origin/HEAD", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/refs/remotes/origin/HEAD", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/HEAD", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/refs/heads/main", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/logs/HEAD", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/logs/refs/heads/main", "/Users/pillip/project/practice/openclaw_todo_plugin/README.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/info/exclude", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/description", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/commit-msg.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/pre-rebase.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/sendemail-validate.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/pre-commit.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/applypatch-msg.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/fsmonitor-watchman.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/pre-receive.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/prepare-commit-msg.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/post-update.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/pre-merge-commit.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/pre-applypatch.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/pre-push.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/update.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/push-to-checkout.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/prd-writer.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/reviewer.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/architect.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/debugger.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/documenter.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/ux-designer.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/developer.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/migrator.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/refactorer.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/requirement-analyst.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/planner.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/qa-designer.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/devops.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/hooks/agent_state.py", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/skills/kickoff/SKILL.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/skills/devops/SKILL.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/skills/migrate/SKILL.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/skills/review/SKILL.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/skills/prd/SKILL.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/skills/implement/SKILL.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/skills/ship/SKILL.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/skills/refactor/SKILL.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/skills/debug/SKILL.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/objects/pack/pack-ba05b861ecd63a5ca4d1429f5692b5022f6b8c5e.pack", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/objects/pack/pack-ba05b861ecd63a5ca4d1429f5692b5022f6b8c5e.idx", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/objects/pack/pack-ba05b861ecd63a5ca4d1429f5692b5022f6b8c5e.rev", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/packed-refs", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/logs/refs/remotes/origin/HEAD", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/refs/remotes/origin/HEAD", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/HEAD", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/refs/heads/main", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/logs/HEAD", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/logs/refs/heads/main", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/.git", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/config", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/.gitignore", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/README.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/architect.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/debugger.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/developer.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/devops.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/documenter.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/migrator.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/planner.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/prd-writer.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/qa-designer.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/refactorer.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/requirement-analyst.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/reviewer.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/ux-designer.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/docs/PRD_agent_system_v0.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/docs/README.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/docs/example_prd.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/project/.claude/hooks/agent_state.py", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/project/.claude/settings.snippet.json", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/scripts/ensure_gh.sh"], "durationMs": 602, "numFiles": 100, "truncated": true}, "tool_use_id": "toolu_01BAVkyGeE5KXxXQrEvUXDGQ", "_ts": "2026-02-20T11:31:32+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Task", "tool_input": {"description": "Design UX spec from PRD", "prompt": "You are a UX designer. Read the PRD at /Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md and produce a UX specification document.\n\nThe PRD describes an OpenClaw TODO Plugin for Slack — a DM-based TODO system with commands like /todo add|list|board|move|done|drop|edit and project management. The interaction is text-based in Slack DM.\n\nWrite a UX spec covering:\n- User flows (primary flows for each command)\n- Input/output formats and examples\n- Error messages and edge cases\n- Response formatting (how bot replies look)\n- Interaction patterns\n\nWrite the output to /Users/pillip/project/practice/openclaw_todo_plugin/docs/ux_spec.md in English.", "subagent_type": "general-purpose", "run_in_background": true}, "tool_use_id": "toolu_01UntXoPGA1LnHbw2Jf8zv68", "_ts": "2026-02-20T11:31:32+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Task", "tool_input": {"description": "Design UX spec from PRD", "prompt": "You are a UX designer. Read the PRD at /Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md and produce a UX specification document.\n\nThe PRD describes an OpenClaw TODO Plugin for Slack — a DM-based TODO system with commands like /todo add|list|board|move|done|drop|edit and project management. The interaction is text-based in Slack DM.\n\nWrite a UX spec covering:\n- User flows (primary flows for each command)\n- Input/output formats and examples\n- Error messages and edge cases\n- Response formatting (how bot replies look)\n- Interaction patterns\n\nWrite the output to /Users/pillip/project/practice/openclaw_todo_plugin/docs/ux_spec.md in English.", "subagent_type": "general-purpose", "run_in_background": true}, "tool_response": {"isAsync": true, "status": "async_launched", "agentId": "a78d2f0", "description": "Design UX spec from PRD", "prompt": "You are a UX designer. Read the PRD at /Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md and produce a UX specification document.\n\nThe PRD describes an OpenClaw TODO Plugin for Slack — a DM-based TODO system with commands like /todo add|list|board|move|done|drop|edit and project management. The interaction is text-based in Slack DM.\n\nWrite a UX spec covering:\n- User flows (primary flows for each command)\n- Input/output formats and examples\n- Error messages and edge cases\n- Response formatting (how bot replies look)\n- Interaction patterns\n\nWrite the output to /Users/pillip/project/practice/openclaw_todo_plugin/docs/ux_spec.md in English.", "outputFile": "/private/tmp/claude-501/-Users-pillip-project-practice-openclaw-todo-plugin/tasks/a78d2f0.output"}, "tool_use_id": "toolu_01UntXoPGA1LnHbw2Jf8zv68", "_ts": "2026-02-20T11:31:32+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "hook_event_name": "SubagentStart", "agent_id": "a78d2f0", "agent_type": "general-purpose", "_ts": "2026-02-20T11:31:32+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md"}, "tool_use_id": "toolu_014fGPJYkxxTs1SDVuevMMmz", "_ts": "2026-02-20T11:31:35+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md", "content": "# OpenClaw TODO Plugin for Slack — PRD v1.1 (DM 기반)\n\n> 변경사항 반영:\n> 1) Slack **슬래시 커맨드 미사용** → **DM(또는 앱 멘션/일반 메시지)에서 `/todo …`**로 사용  \n> 2) private 프로젝트: **same owner 내 name 유니크**  \n> 3) `/todo project set-private` 실행 시: 해당 프로젝트 내 task 중 **owner가 아닌 assignee가 하나라도 있으면 에러**  \n> 4) 프로젝트 이름 충돌 해소: **옵션 A(private 우선)** 유지  \n> 5) DB **초기 생성/마이그레이션** 절차 추가\n\n---\n\n## 1) 개요\n\n### 1.1 목표\nOpenClaw 플러그인으로 Slack에서 다음을 **LLM 호출 없이(=비용 0)** 처리하는 팀/개인용 TODO 시스템을 제공한다.\n\n- `/todo add|list|board|move|done|drop|edit`\n- `/todo project list|set-private|set-shared`\n- 저장소: **공유 SQLite3** (동일 Gateway/동일 DB 파일)\n- 담당자(assignee): **Slack 멘션만 허용** (`<@U…>` 기반)\n- due: `YYYY-MM-DD` 또는 `MM-DD` 허용, 연도 생략 시 **현재 연도**로 보정\n- Private 프로젝트: **오직 owner만** 조회/수정 가능\n\n---\n\n## 2) Slack 사용 방식 (슬래시 커맨드 미사용)\n\n### 2.1 사용 채널\n슬래시 커맨드를 쓰지 않는다면, 일반적으로 다음 중 하나로 사용한다.\n\n- **DM 채널**: OpenClaw Slack 앱(봇)과 1:1 대화에서 `/todo …` 입력  \n- **채널/스레드**(옵션): 앱 멘션(`@openclaw /todo …`) 또는 특정 메시지 패턴을 OpenClaw가 수신하도록 설정된 경우\n\n> v1은 **DM 사용을 기본 경로**로 가정한다.  \n> 이유: 권한/노이즈/오작동 리스크가 낮고 운영이 단순함.\n\n### 2.2 커맨드 인식 규칙\n- 메시지의 첫 토큰이 `/todo`이면 플러그인이 처리한다.\n- 그 외 메시지는 v1에서 무시(자연어 자동 등록은 Phase 2).\n\n---\n\n## 3) 핵심 정책\n\n### 3.1 프로젝트 이름 유니크 정책\n- **Shared 프로젝트**: 전역 유니크 (겹치면 생성/변경 거부)\n- **Private 프로젝트**: **same owner 내에서만 유니크** (owner가 다르면 동일 name 허용)\n\n### 3.2 프로젝트 이름 충돌 해소(옵션 A)\n`/p <name>` 해석:\n1) sender(owner)의 private 프로젝트 `<name>`가 존재하면 **private 우선**\n2) 없으면 shared `<name>` 사용\n3) 둘 다 없으면 (v1 정책에 따라) shared 자동 생성 또는 에러\n\n> 운영 가이드: private와 shared에 같은 이름을 쓰지 않는 것을 권장(혼란 방지).\n\n### 3.3 Private 프로젝트 assignee 제한(“경고 후 거부”)\n- private 프로젝트는 **owner만 볼 수 있는 범위**이므로:\n  - add/edit 시 owner 이외의 assignee가 포함되면 **경고 메시지 출력 후 작업 거부(변경/생성 미적용)**\n\n경고/거부 응답 예시:\n- `⚠️ Private 프로젝트(Personal)는 owner만 볼 수 있어요. 다른 담당자(<@U…>)를 지정할 수 없습니다. (요청이 적용되지 않았습니다.)`\n\n### 3.4 `/todo project set-private` 추가 제약(요구사항)\n- 프로젝트를 private로 전환할 때,\n  - 해당 프로젝트 내 모든 task를 스캔하여\n  - **owner가 아닌 assignee가 하나라도 존재하면 에러**로 실패해야 한다.\n- 에러 메시지에는 최소한 아래 정보를 포함한다:\n  - 실패 사유\n  - 위반 task id 목록 일부(예: 최대 10개)\n  - 위반 assignee 목록 일부\n\n에러 예시:\n- `❌ Cannot set project \"Biz\" to private: found tasks assigned to non-owner users. e.g. #12 assignees:<@U2>, #18 assignees:<@U3>`\n\n---\n\n## 4) due 파서 정책\n\n허용 입력:\n- `due:YYYY-MM-DD`\n- `due:MM-DD` 또는 `due:M-D`\n\n보정:\n- 연도 생략 시: `YYYY = now().year` (서버 timezone은 Asia/Seoul 권장)\n\n검증:\n- 유효하지 않은 날짜(예: 02-30)는 에러\n- DB에는 항상 `YYYY-MM-DD`로 저장\n\n---\n\n## 5) 커맨드 스펙\n\n### 5.0 공통 토큰\n- 프로젝트: `/p <projectName>`\n- 섹션: `/s <section>`\n- 섹션 enum: `backlog | doing | waiting | done | drop`\n- due: `due:YYYY-MM-DD|MM-DD` 또는 `due:-`(클리어)\n\n---\n\n### 5.1 `/todo add`\n문법:\n```\n/todo add <title...> [<@USER> ...] [/p <project>] [/s <section>] [due:YYYY-MM-DD|MM-DD]\n```\n\n기본값:\n- project: `Inbox`\n- section: `backlog`\n- assignees:\n  - 멘션 없으면 sender\n  - 멘션 있으면 해당 유저들(다중)\n- due: 없으면 NULL\n\n검증:\n- private 프로젝트에 sender 외 assignee 포함 시: **경고 후 거부**\n- 프로젝트가 없으면:\n  - `Inbox`는 shared로 자동 생성 가능(권장)\n\n응답:\n- `✅ Added #123 (Inbox/backlog) due:- assignees:<@U1> — 장보기`\n\n---\n\n### 5.2 `/todo list`\n문법:\n```\n/todo list [mine|all|<@USER>] [/p <project>] [/s <section>] [open|done|drop] [limit:N]\n```\n\n기본값:\n- scope: `mine`\n- status: `open`\n- limit: 30\n\nscope 의미:\n- `mine`: assignees에 sender 포함\n- `<@USER>`: 해당 유저가 assignee인 task\n- `all`: shared 전체 + sender의 private 프로젝트(타인의 private는 제외)\n\n정렬:\n1) due 있는 것 우선\n2) due 오름차순\n3) id 내림차순\n\n---\n\n### 5.3 `/todo board`\n문법:\n```\n/todo board [mine|all|<@USER>] [/p <project>] [open|done|drop] [limitPerSection:N]\n```\n\n기본값:\n- scope: mine\n- status: open\n- limitPerSection: 10\n\n출력:\n- BACKLOG → DOING → WAITING → DONE → DROP 순\n- 항목 포맷: `#id due:YYYY-MM-DD| - assignees:<@U..> <@U..> title`\n\n---\n\n### 5.4 `/todo move`\n문법:\n```\n/todo move <id> <section>\n```\n\n검증:\n- 섹션 enum validate\n- 권한:\n  - private: owner만\n  - shared: v1 권장 `assignee` 또는 `created_by`만 수정 가능\n\n---\n\n### 5.5 `/todo done`\n```\n/todo done <id>\n```\n- section=`done`, status=`done`, closed_at 기록\n\n### 5.6 `/todo drop`\n```\n/todo drop <id>\n```\n- section=`drop`, status=`dropped`, closed_at 기록\n\n---\n\n### 5.7 `/todo edit`\n문법(v1 replace 방식):\n```\n/todo edit <id> [<new title...>] [<@USER> ...] [/p <project>] [/s <section>] [due:YYYY-MM-DD|MM-DD|due:-]\n```\n\n규칙:\n- 멘션이 있으면 assignees **완전 교체**\n- `due:-` 는 due NULL\n- title은 옵션 토큰 이전 텍스트를 새 title로 간주(비어있으면 변경 없음)\n\n검증:\n- private 프로젝트로 변경되거나 private 프로젝트에서 assignee 변경 시:\n  - sender 외 assignee 포함이면 **경고 후 거부(변경 미적용)**\n\n---\n\n### 5.8 `/todo project list`\n- 반환:\n  - shared 프로젝트 목록\n  - sender(owner)의 private 프로젝트 목록\n\n---\n\n### 5.9 `/todo project set-private <name>`\n동작:\n1) 대상 프로젝트를 resolve:\n   - sender의 private `<name>` 존재 → already private (ok)\n   - 없고 shared `<name>` 존재 → shared를 private로 “전환 시도”\n   - 둘 다 없으면 → sender private `<name>` 생성 (owner=sender)\n\n2) shared→private 전환 시도 시 검증:\n   - 해당 프로젝트 내 tasks를 조회\n   - 각 task에 대해 `task_assignees`를 확인\n   - **owner(sender) 외 assignee가 하나라도 존재하면 실패(에러)**\n\n3) 성공 시:\n   - projects.visibility='private', owner_user_id=sender\n   - (선택) 기존 task의 assignees가 모두 owner인지 확인되므로 유지 가능\n\n---\n\n### 5.10 `/todo project set-shared <name>`\n동작:\n- shared `<name>`이 없으면 생성\n- 이미 있으면 noop\n- 단, shared는 전역 유니크이므로 충돌 시 에러/exists\n\n---\n\n## 6) 데이터 모델 (SQLite3)\n\n### 6.1 DB 파일 위치\n- 기본: `~/.openclaw/workspace/.todo/todo.sqlite3`\n\n### 6.2 동시성 설정\n- `PRAGMA journal_mode=WAL;`\n- `PRAGMA busy_timeout=3000;`\n\n### 6.3 스키마(v1)\n\n#### `projects`\n- `id` INTEGER PK AUTOINCREMENT\n- `name` TEXT NOT NULL\n- `visibility` TEXT NOT NULL CHECK (visibility IN ('shared','private'))\n- `owner_user_id` TEXT NULL\n- `created_at` TEXT NOT NULL DEFAULT (datetime('now'))\n- `updated_at` TEXT NOT NULL DEFAULT (datetime('now'))\n\nIndexes:\n- shared 전역 유니크:\n  - `CREATE UNIQUE INDEX ux_projects_shared_name ON projects(name) WHERE visibility='shared';`\n- private owner 내 유니크:\n  - `CREATE UNIQUE INDEX ux_projects_private_owner_name ON projects(owner_user_id, name) WHERE visibility='private';`\n\n#### `tasks`\n- `id` INTEGER PK AUTOINCREMENT\n- `title` TEXT NOT NULL\n- `project_id` INTEGER NOT NULL REFERENCES projects(id)\n- `section` TEXT NOT NULL CHECK (section IN ('backlog','doing','waiting','done','drop'))\n- `due` TEXT NULL  -- YYYY-MM-DD\n- `status` TEXT NOT NULL CHECK (status IN ('open','done','dropped'))\n- `created_by` TEXT NOT NULL  -- Slack user id\n- `created_at`, `updated_at`, `closed_at`\n\n#### `task_assignees`\n- `task_id` INTEGER NOT NULL REFERENCES tasks(id)\n- `assignee_user_id` TEXT NOT NULL\n- PRIMARY KEY(task_id, assignee_user_id)\n- INDEX: `(assignee_user_id, task_id)`\n\n#### `events` (audit, 권장)\n- `id` INTEGER PK\n- `ts` TEXT\n- `actor_user_id` TEXT\n- `action` TEXT\n- `task_id` INTEGER NULL\n- `payload` TEXT (JSON)\n\n---\n\n## 7) DB 초기 생성 / 마이그레이션(필수)\n\n### 7.1 생성 타이밍\n플러그인 로딩 후 첫 `/todo …` 실행 시 또는 gateway startup 시점에 아래를 수행:\n\n1) workspace path 결정\n2) `~/.openclaw/workspace/.todo/` 디렉토리 생성\n3) `todo.sqlite3` 파일 존재 여부 확인\n4) 없으면:\n   - 파일 생성\n   - schema migration 실행\n   - `schema_version` 테이블 생성 및 version=1 기록\n\n### 7.2 schema_version 테이블\n- `schema_version(version INTEGER NOT NULL)`\n- 초기: 1\n- 향후:\n  - 현재 버전 읽고, 필요한 migration 순차 실행\n\n### 7.3 기본 프로젝트 생성(권장)\n- DB 초기화 시 shared 프로젝트 `Inbox` 자동 생성 (중복이면 noop)\n\n---\n\n## 8) 권한/가시성\n\n### 8.1 읽기\n- private: owner만\n- shared: scope에 따라 mine/all/<@USER>\n\n### 8.2 쓰기\n- private: owner만\n- shared: v1 권장 `assignee` 또는 `created_by`만\n\n---\n\n## 9) 수용 기준(Acceptance Criteria)\n\n- [ ] shared 프로젝트 이름 충돌 시 생성/변경 거부\n- [ ] private 프로젝트는 owner 단위로 유니크 (owner A/B는 같은 name 허용)\n- [ ] `/todo project set-private <name>` 실행 시:\n  - 프로젝트 내 task 중 owner 외 assignee 존재하면 에러로 실패\n- [ ] private 프로젝트에 타 assignee 지정 시: 경고 + 작업 미생성/미수정\n- [ ] due `MM-DD` 입력 시 올해로 보정되어 저장\n- [ ] DB 최초 실행 시 파일 생성 + schema 적용 + Inbox 생성\n\n---\n\n## 10) 구현 작업 분해(WBS)\n\n- M0: plugin skeleton + `/todo` command 등록\n- M1: DB init + migrations + schema_version\n- M2: parser (Slack mention, /p, /s, due 보정)\n- M3: commands (add/list/board/move/done/drop/edit)\n- M4: project commands (list/set-private/set-shared + set-private 검증 로직)\n- M5: tests (parser/unit + sqlite E2E)\n- M6: packaging/배포(npm 권장)\n", "numLines": 353, "startLine": 1, "totalLines": 353}}, "tool_use_id": "toolu_014fGPJYkxxTs1SDVuevMMmz", "_ts": "2026-02-20T11:31:35+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Task", "tool_input": {"description": "Design architecture from PRD", "prompt": "Read the PRD at /Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md and design the software architecture.\n\nThis is a Python-based OpenClaw plugin for Slack TODO management. Key tech decisions from PRD:\n- SQLite3 database with WAL mode\n- OpenClaw plugin system (not a standalone app)\n- Slack DM-based interaction\n- Commands: /todo add|list|board|move|done|drop|edit + project commands\n- Private/shared project system\n- Schema migration support\n\nThe project uses uv for package management and pytest for testing (per project conventions).\n\nDesign a pragmatic architecture. Since this is a plugin (not a web app), do NOT use Django. Focus on:\n- Module/package structure\n- Key classes and their responsibilities\n- Data access layer design\n- Command parsing and routing\n- Error handling strategy\n- Database schema and migration approach\n\nWrite the output to /Users/pillip/project/practice/openclaw_todo_plugin/docs/architecture.md", "subagent_type": "architect", "run_in_background": true}, "tool_use_id": "toolu_01CSn8shV8UXaXvNo1xTPfYr", "_ts": "2026-02-20T11:31:38+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Task", "tool_input": {"description": "Design architecture from PRD", "prompt": "Read the PRD at /Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md and design the software architecture.\n\nThis is a Python-based OpenClaw plugin for Slack TODO management. Key tech decisions from PRD:\n- SQLite3 database with WAL mode\n- OpenClaw plugin system (not a standalone app)\n- Slack DM-based interaction\n- Commands: /todo add|list|board|move|done|drop|edit + project commands\n- Private/shared project system\n- Schema migration support\n\nThe project uses uv for package management and pytest for testing (per project conventions).\n\nDesign a pragmatic architecture. Since this is a plugin (not a web app), do NOT use Django. Focus on:\n- Module/package structure\n- Key classes and their responsibilities\n- Data access layer design\n- Command parsing and routing\n- Error handling strategy\n- Database schema and migration approach\n\nWrite the output to /Users/pillip/project/practice/openclaw_todo_plugin/docs/architecture.md", "subagent_type": "architect", "run_in_background": true}, "tool_response": {"isAsync": true, "status": "async_launched", "agentId": "a57985d", "description": "Design architecture from PRD", "prompt": "Read the PRD at /Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md and design the software architecture.\n\nThis is a Python-based OpenClaw plugin for Slack TODO management. Key tech decisions from PRD:\n- SQLite3 database with WAL mode\n- OpenClaw plugin system (not a standalone app)\n- Slack DM-based interaction\n- Commands: /todo add|list|board|move|done|drop|edit + project commands\n- Private/shared project system\n- Schema migration support\n\nThe project uses uv for package management and pytest for testing (per project conventions).\n\nDesign a pragmatic architecture. Since this is a plugin (not a web app), do NOT use Django. Focus on:\n- Module/package structure\n- Key classes and their responsibilities\n- Data access layer design\n- Command parsing and routing\n- Error handling strategy\n- Database schema and migration approach\n\nWrite the output to /Users/pillip/project/practice/openclaw_todo_plugin/docs/architecture.md", "outputFile": "/private/tmp/claude-501/-Users-pillip-project-practice-openclaw-todo-plugin/tasks/a57985d.output"}, "tool_use_id": "toolu_01CSn8shV8UXaXvNo1xTPfYr", "_ts": "2026-02-20T11:31:38+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "mkdir -p /Users/pillip/project/practice/openclaw_todo_plugin/docs", "description": "Create docs directory"}, "tool_use_id": "toolu_0171S6fYGhVRxRUbaeT42oSF", "_ts": "2026-02-20T11:31:39+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "mkdir -p /Users/pillip/project/practice/openclaw_todo_plugin/docs", "description": "Create docs directory"}, "tool_response": {"stdout": "", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": true}, "tool_use_id": "toolu_0171S6fYGhVRxRUbaeT42oSF", "_ts": "2026-02-20T11:31:39+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md"}, "tool_use_id": "toolu_012nFoNsJeDrxgGzSaJM11eb", "_ts": "2026-02-20T11:31:41+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md", "content": "# OpenClaw TODO Plugin for Slack — PRD v1.1 (DM 기반)\n\n> 변경사항 반영:\n> 1) Slack **슬래시 커맨드 미사용** → **DM(또는 앱 멘션/일반 메시지)에서 `/todo …`**로 사용  \n> 2) private 프로젝트: **same owner 내 name 유니크**  \n> 3) `/todo project set-private` 실행 시: 해당 프로젝트 내 task 중 **owner가 아닌 assignee가 하나라도 있으면 에러**  \n> 4) 프로젝트 이름 충돌 해소: **옵션 A(private 우선)** 유지  \n> 5) DB **초기 생성/마이그레이션** 절차 추가\n\n---\n\n## 1) 개요\n\n### 1.1 목표\nOpenClaw 플러그인으로 Slack에서 다음을 **LLM 호출 없이(=비용 0)** 처리하는 팀/개인용 TODO 시스템을 제공한다.\n\n- `/todo add|list|board|move|done|drop|edit`\n- `/todo project list|set-private|set-shared`\n- 저장소: **공유 SQLite3** (동일 Gateway/동일 DB 파일)\n- 담당자(assignee): **Slack 멘션만 허용** (`<@U…>` 기반)\n- due: `YYYY-MM-DD` 또는 `MM-DD` 허용, 연도 생략 시 **현재 연도**로 보정\n- Private 프로젝트: **오직 owner만** 조회/수정 가능\n\n---\n\n## 2) Slack 사용 방식 (슬래시 커맨드 미사용)\n\n### 2.1 사용 채널\n슬래시 커맨드를 쓰지 않는다면, 일반적으로 다음 중 하나로 사용한다.\n\n- **DM 채널**: OpenClaw Slack 앱(봇)과 1:1 대화에서 `/todo …` 입력  \n- **채널/스레드**(옵션): 앱 멘션(`@openclaw /todo …`) 또는 특정 메시지 패턴을 OpenClaw가 수신하도록 설정된 경우\n\n> v1은 **DM 사용을 기본 경로**로 가정한다.  \n> 이유: 권한/노이즈/오작동 리스크가 낮고 운영이 단순함.\n\n### 2.2 커맨드 인식 규칙\n- 메시지의 첫 토큰이 `/todo`이면 플러그인이 처리한다.\n- 그 외 메시지는 v1에서 무시(자연어 자동 등록은 Phase 2).\n\n---\n\n## 3) 핵심 정책\n\n### 3.1 프로젝트 이름 유니크 정책\n- **Shared 프로젝트**: 전역 유니크 (겹치면 생성/변경 거부)\n- **Private 프로젝트**: **same owner 내에서만 유니크** (owner가 다르면 동일 name 허용)\n\n### 3.2 프로젝트 이름 충돌 해소(옵션 A)\n`/p <name>` 해석:\n1) sender(owner)의 private 프로젝트 `<name>`가 존재하면 **private 우선**\n2) 없으면 shared `<name>` 사용\n3) 둘 다 없으면 (v1 정책에 따라) shared 자동 생성 또는 에러\n\n> 운영 가이드: private와 shared에 같은 이름을 쓰지 않는 것을 권장(혼란 방지).\n\n### 3.3 Private 프로젝트 assignee 제한(“경고 후 거부”)\n- private 프로젝트는 **owner만 볼 수 있는 범위**이므로:\n  - add/edit 시 owner 이외의 assignee가 포함되면 **경고 메시지 출력 후 작업 거부(변경/생성 미적용)**\n\n경고/거부 응답 예시:\n- `⚠️ Private 프로젝트(Personal)는 owner만 볼 수 있어요. 다른 담당자(<@U…>)를 지정할 수 없습니다. (요청이 적용되지 않았습니다.)`\n\n### 3.4 `/todo project set-private` 추가 제약(요구사항)\n- 프로젝트를 private로 전환할 때,\n  - 해당 프로젝트 내 모든 task를 스캔하여\n  - **owner가 아닌 assignee가 하나라도 존재하면 에러**로 실패해야 한다.\n- 에러 메시지에는 최소한 아래 정보를 포함한다:\n  - 실패 사유\n  - 위반 task id 목록 일부(예: 최대 10개)\n  - 위반 assignee 목록 일부\n\n에러 예시:\n- `❌ Cannot set project \"Biz\" to private: found tasks assigned to non-owner users. e.g. #12 assignees:<@U2>, #18 assignees:<@U3>`\n\n---\n\n## 4) due 파서 정책\n\n허용 입력:\n- `due:YYYY-MM-DD`\n- `due:MM-DD` 또는 `due:M-D`\n\n보정:\n- 연도 생략 시: `YYYY = now().year` (서버 timezone은 Asia/Seoul 권장)\n\n검증:\n- 유효하지 않은 날짜(예: 02-30)는 에러\n- DB에는 항상 `YYYY-MM-DD`로 저장\n\n---\n\n## 5) 커맨드 스펙\n\n### 5.0 공통 토큰\n- 프로젝트: `/p <projectName>`\n- 섹션: `/s <section>`\n- 섹션 enum: `backlog | doing | waiting | done | drop`\n- due: `due:YYYY-MM-DD|MM-DD` 또는 `due:-`(클리어)\n\n---\n\n### 5.1 `/todo add`\n문법:\n```\n/todo add <title...> [<@USER> ...] [/p <project>] [/s <section>] [due:YYYY-MM-DD|MM-DD]\n```\n\n기본값:\n- project: `Inbox`\n- section: `backlog`\n- assignees:\n  - 멘션 없으면 sender\n  - 멘션 있으면 해당 유저들(다중)\n- due: 없으면 NULL\n\n검증:\n- private 프로젝트에 sender 외 assignee 포함 시: **경고 후 거부**\n- 프로젝트가 없으면:\n  - `Inbox`는 shared로 자동 생성 가능(권장)\n\n응답:\n- `✅ Added #123 (Inbox/backlog) due:- assignees:<@U1> — 장보기`\n\n---\n\n### 5.2 `/todo list`\n문법:\n```\n/todo list [mine|all|<@USER>] [/p <project>] [/s <section>] [open|done|drop] [limit:N]\n```\n\n기본값:\n- scope: `mine`\n- status: `open`\n- limit: 30\n\nscope 의미:\n- `mine`: assignees에 sender 포함\n- `<@USER>`: 해당 유저가 assignee인 task\n- `all`: shared 전체 + sender의 private 프로젝트(타인의 private는 제외)\n\n정렬:\n1) due 있는 것 우선\n2) due 오름차순\n3) id 내림차순\n\n---\n\n### 5.3 `/todo board`\n문법:\n```\n/todo board [mine|all|<@USER>] [/p <project>] [open|done|drop] [limitPerSection:N]\n```\n\n기본값:\n- scope: mine\n- status: open\n- limitPerSection: 10\n\n출력:\n- BACKLOG → DOING → WAITING → DONE → DROP 순\n- 항목 포맷: `#id due:YYYY-MM-DD| - assignees:<@U..> <@U..> title`\n\n---\n\n### 5.4 `/todo move`\n문법:\n```\n/todo move <id> <section>\n```\n\n검증:\n- 섹션 enum validate\n- 권한:\n  - private: owner만\n  - shared: v1 권장 `assignee` 또는 `created_by`만 수정 가능\n\n---\n\n### 5.5 `/todo done`\n```\n/todo done <id>\n```\n- section=`done`, status=`done`, closed_at 기록\n\n### 5.6 `/todo drop`\n```\n/todo drop <id>\n```\n- section=`drop`, status=`dropped`, closed_at 기록\n\n---\n\n### 5.7 `/todo edit`\n문법(v1 replace 방식):\n```\n/todo edit <id> [<new title...>] [<@USER> ...] [/p <project>] [/s <section>] [due:YYYY-MM-DD|MM-DD|due:-]\n```\n\n규칙:\n- 멘션이 있으면 assignees **완전 교체**\n- `due:-` 는 due NULL\n- title은 옵션 토큰 이전 텍스트를 새 title로 간주(비어있으면 변경 없음)\n\n검증:\n- private 프로젝트로 변경되거나 private 프로젝트에서 assignee 변경 시:\n  - sender 외 assignee 포함이면 **경고 후 거부(변경 미적용)**\n\n---\n\n### 5.8 `/todo project list`\n- 반환:\n  - shared 프로젝트 목록\n  - sender(owner)의 private 프로젝트 목록\n\n---\n\n### 5.9 `/todo project set-private <name>`\n동작:\n1) 대상 프로젝트를 resolve:\n   - sender의 private `<name>` 존재 → already private (ok)\n   - 없고 shared `<name>` 존재 → shared를 private로 “전환 시도”\n   - 둘 다 없으면 → sender private `<name>` 생성 (owner=sender)\n\n2) shared→private 전환 시도 시 검증:\n   - 해당 프로젝트 내 tasks를 조회\n   - 각 task에 대해 `task_assignees`를 확인\n   - **owner(sender) 외 assignee가 하나라도 존재하면 실패(에러)**\n\n3) 성공 시:\n   - projects.visibility='private', owner_user_id=sender\n   - (선택) 기존 task의 assignees가 모두 owner인지 확인되므로 유지 가능\n\n---\n\n### 5.10 `/todo project set-shared <name>`\n동작:\n- shared `<name>`이 없으면 생성\n- 이미 있으면 noop\n- 단, shared는 전역 유니크이므로 충돌 시 에러/exists\n\n---\n\n## 6) 데이터 모델 (SQLite3)\n\n### 6.1 DB 파일 위치\n- 기본: `~/.openclaw/workspace/.todo/todo.sqlite3`\n\n### 6.2 동시성 설정\n- `PRAGMA journal_mode=WAL;`\n- `PRAGMA busy_timeout=3000;`\n\n### 6.3 스키마(v1)\n\n#### `projects`\n- `id` INTEGER PK AUTOINCREMENT\n- `name` TEXT NOT NULL\n- `visibility` TEXT NOT NULL CHECK (visibility IN ('shared','private'))\n- `owner_user_id` TEXT NULL\n- `created_at` TEXT NOT NULL DEFAULT (datetime('now'))\n- `updated_at` TEXT NOT NULL DEFAULT (datetime('now'))\n\nIndexes:\n- shared 전역 유니크:\n  - `CREATE UNIQUE INDEX ux_projects_shared_name ON projects(name) WHERE visibility='shared';`\n- private owner 내 유니크:\n  - `CREATE UNIQUE INDEX ux_projects_private_owner_name ON projects(owner_user_id, name) WHERE visibility='private';`\n\n#### `tasks`\n- `id` INTEGER PK AUTOINCREMENT\n- `title` TEXT NOT NULL\n- `project_id` INTEGER NOT NULL REFERENCES projects(id)\n- `section` TEXT NOT NULL CHECK (section IN ('backlog','doing','waiting','done','drop'))\n- `due` TEXT NULL  -- YYYY-MM-DD\n- `status` TEXT NOT NULL CHECK (status IN ('open','done','dropped'))\n- `created_by` TEXT NOT NULL  -- Slack user id\n- `created_at`, `updated_at`, `closed_at`\n\n#### `task_assignees`\n- `task_id` INTEGER NOT NULL REFERENCES tasks(id)\n- `assignee_user_id` TEXT NOT NULL\n- PRIMARY KEY(task_id, assignee_user_id)\n- INDEX: `(assignee_user_id, task_id)`\n\n#### `events` (audit, 권장)\n- `id` INTEGER PK\n- `ts` TEXT\n- `actor_user_id` TEXT\n- `action` TEXT\n- `task_id` INTEGER NULL\n- `payload` TEXT (JSON)\n\n---\n\n## 7) DB 초기 생성 / 마이그레이션(필수)\n\n### 7.1 생성 타이밍\n플러그인 로딩 후 첫 `/todo …` 실행 시 또는 gateway startup 시점에 아래를 수행:\n\n1) workspace path 결정\n2) `~/.openclaw/workspace/.todo/` 디렉토리 생성\n3) `todo.sqlite3` 파일 존재 여부 확인\n4) 없으면:\n   - 파일 생성\n   - schema migration 실행\n   - `schema_version` 테이블 생성 및 version=1 기록\n\n### 7.2 schema_version 테이블\n- `schema_version(version INTEGER NOT NULL)`\n- 초기: 1\n- 향후:\n  - 현재 버전 읽고, 필요한 migration 순차 실행\n\n### 7.3 기본 프로젝트 생성(권장)\n- DB 초기화 시 shared 프로젝트 `Inbox` 자동 생성 (중복이면 noop)\n\n---\n\n## 8) 권한/가시성\n\n### 8.1 읽기\n- private: owner만\n- shared: scope에 따라 mine/all/<@USER>\n\n### 8.2 쓰기\n- private: owner만\n- shared: v1 권장 `assignee` 또는 `created_by`만\n\n---\n\n## 9) 수용 기준(Acceptance Criteria)\n\n- [ ] shared 프로젝트 이름 충돌 시 생성/변경 거부\n- [ ] private 프로젝트는 owner 단위로 유니크 (owner A/B는 같은 name 허용)\n- [ ] `/todo project set-private <name>` 실행 시:\n  - 프로젝트 내 task 중 owner 외 assignee 존재하면 에러로 실패\n- [ ] private 프로젝트에 타 assignee 지정 시: 경고 + 작업 미생성/미수정\n- [ ] due `MM-DD` 입력 시 올해로 보정되어 저장\n- [ ] DB 최초 실행 시 파일 생성 + schema 적용 + Inbox 생성\n\n---\n\n## 10) 구현 작업 분해(WBS)\n\n- M0: plugin skeleton + `/todo` command 등록\n- M1: DB init + migrations + schema_version\n- M2: parser (Slack mention, /p, /s, due 보정)\n- M3: commands (add/list/board/move/done/drop/edit)\n- M4: project commands (list/set-private/set-shared + set-private 검증 로직)\n- M5: tests (parser/unit + sqlite E2E)\n- M6: packaging/배포(npm 권장)\n", "numLines": 353, "startLine": 1, "totalLines": 353}}, "tool_use_id": "toolu_012nFoNsJeDrxgGzSaJM11eb", "_ts": "2026-02-20T11:31:41+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Glob", "tool_input": {"pattern": "**/*", "path": "/Users/pillip/project/practice/openclaw_todo_plugin"}, "tool_use_id": "toolu_01Y7xdVifdnHwkCukk62j9xJ", "_ts": "2026-02-20T11:31:41+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Glob", "tool_input": {"pattern": "**/*", "path": "/Users/pillip/project/practice/openclaw_todo_plugin"}, "tool_response": {"filenames": ["/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/info/exclude", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/description", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/commit-msg.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/pre-rebase.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/sendemail-validate.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/pre-commit.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/applypatch-msg.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/fsmonitor-watchman.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/pre-receive.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/prepare-commit-msg.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/post-update.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/pre-merge-commit.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/pre-applypatch.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/pre-push.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/update.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/hooks/push-to-checkout.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/objects/pack/pack-63ec6b0dc8c5da799a8300af63320c984b8a15fc.pack", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/objects/pack/pack-63ec6b0dc8c5da799a8300af63320c984b8a15fc.idx", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/objects/pack/pack-63ec6b0dc8c5da799a8300af63320c984b8a15fc.rev", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/packed-refs", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/logs/refs/remotes/origin/HEAD", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/refs/remotes/origin/HEAD", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/HEAD", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/refs/heads/main", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/logs/HEAD", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/logs/refs/heads/main", "/Users/pillip/project/practice/openclaw_todo_plugin/README.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/info/exclude", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/description", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/commit-msg.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/pre-rebase.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/sendemail-validate.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/pre-commit.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/applypatch-msg.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/fsmonitor-watchman.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/pre-receive.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/prepare-commit-msg.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/post-update.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/pre-merge-commit.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/pre-applypatch.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/pre-push.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/update.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/hooks/push-to-checkout.sample", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/prd-writer.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/reviewer.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/architect.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/debugger.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/documenter.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/ux-designer.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/developer.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/migrator.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/refactorer.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/requirement-analyst.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/planner.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/qa-designer.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/devops.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/hooks/agent_state.py", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/skills/kickoff/SKILL.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/skills/devops/SKILL.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/skills/migrate/SKILL.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/skills/review/SKILL.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/skills/prd/SKILL.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/skills/implement/SKILL.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/skills/ship/SKILL.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/skills/refactor/SKILL.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/skills/debug/SKILL.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/objects/pack/pack-ba05b861ecd63a5ca4d1429f5692b5022f6b8c5e.pack", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/objects/pack/pack-ba05b861ecd63a5ca4d1429f5692b5022f6b8c5e.idx", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/objects/pack/pack-ba05b861ecd63a5ca4d1429f5692b5022f6b8c5e.rev", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/packed-refs", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/logs/refs/remotes/origin/HEAD", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/refs/remotes/origin/HEAD", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/HEAD", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/refs/heads/main", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/logs/HEAD", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/logs/refs/heads/main", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/.git", "/Users/pillip/project/practice/openclaw_todo_plugin/.git/modules/.claude-kit/config", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/.gitignore", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/README.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/architect.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/debugger.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/developer.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/devops.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/documenter.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/migrator.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/planner.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/prd-writer.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/qa-designer.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/refactorer.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/requirement-analyst.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/reviewer.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/agents/ux-designer.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/docs/PRD_agent_system_v0.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/docs/README.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/docs/example_prd.md", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/project/.claude/hooks/agent_state.py", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/project/.claude/settings.snippet.json", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/scripts/ensure_gh.sh"], "durationMs": 415, "numFiles": 100, "truncated": true}, "tool_use_id": "toolu_01Y7xdVifdnHwkCukk62j9xJ", "_ts": "2026-02-20T11:31:42+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Task", "tool_input": {"description": "Create issue plan from PRD", "prompt": "Read the PRD at /Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md and break the requirements into small, implementable issues.\n\nThe PRD describes an OpenClaw TODO Plugin for Slack with these milestones (from PRD section 10):\n- M0: plugin skeleton + /todo command registration\n- M1: DB init + migrations + schema_version\n- M2: parser (Slack mention, /p, /s, due correction)\n- M3: commands (add/list/board/move/done/drop/edit)\n- M4: project commands (list/set-private/set-shared + set-private validation)\n- M5: tests (parser/unit + sqlite E2E)\n- M6: packaging/deployment\n\nBreak these into small issues with clear acceptance criteria. Each issue should be independently implementable. Use the milestone structure from the PRD.\n\nWrite the output to /Users/pillip/project/practice/openclaw_todo_plugin/issues.md\n\nFormat each issue with: issue number, title, milestone, description, acceptance criteria, dependencies (if any).", "subagent_type": "planner", "run_in_background": true}, "tool_use_id": "toolu_01FiJGBPCeEm1AQXtD8NHYDC", "_ts": "2026-02-20T11:31:42+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Task", "tool_input": {"description": "Create issue plan from PRD", "prompt": "Read the PRD at /Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md and break the requirements into small, implementable issues.\n\nThe PRD describes an OpenClaw TODO Plugin for Slack with these milestones (from PRD section 10):\n- M0: plugin skeleton + /todo command registration\n- M1: DB init + migrations + schema_version\n- M2: parser (Slack mention, /p, /s, due correction)\n- M3: commands (add/list/board/move/done/drop/edit)\n- M4: project commands (list/set-private/set-shared + set-private validation)\n- M5: tests (parser/unit + sqlite E2E)\n- M6: packaging/deployment\n\nBreak these into small issues with clear acceptance criteria. Each issue should be independently implementable. Use the milestone structure from the PRD.\n\nWrite the output to /Users/pillip/project/practice/openclaw_todo_plugin/issues.md\n\nFormat each issue with: issue number, title, milestone, description, acceptance criteria, dependencies (if any).", "subagent_type": "planner", "run_in_background": true}, "tool_response": {"isAsync": true, "status": "async_launched", "agentId": "a5b42a7", "description": "Create issue plan from PRD", "prompt": "Read the PRD at /Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md and break the requirements into small, implementable issues.\n\nThe PRD describes an OpenClaw TODO Plugin for Slack with these milestones (from PRD section 10):\n- M0: plugin skeleton + /todo command registration\n- M1: DB init + migrations + schema_version\n- M2: parser (Slack mention, /p, /s, due correction)\n- M3: commands (add/list/board/move/done/drop/edit)\n- M4: project commands (list/set-private/set-shared + set-private validation)\n- M5: tests (parser/unit + sqlite E2E)\n- M6: packaging/deployment\n\nBreak these into small issues with clear acceptance criteria. Each issue should be independently implementable. Use the milestone structure from the PRD.\n\nWrite the output to /Users/pillip/project/practice/openclaw_todo_plugin/issues.md\n\nFormat each issue with: issue number, title, milestone, description, acceptance criteria, dependencies (if any).", "outputFile": "/private/tmp/claude-501/-Users-pillip-project-practice-openclaw-todo-plugin/tasks/a5b42a7.output"}, "tool_use_id": "toolu_01FiJGBPCeEm1AQXtD8NHYDC", "_ts": "2026-02-20T11:31:42+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md"}, "tool_use_id": "toolu_01SLvcw8E4kYrHk29G4v2DTA", "_ts": "2026-02-20T11:31:45+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md", "content": "# OpenClaw TODO Plugin for Slack — PRD v1.1 (DM 기반)\n\n> 변경사항 반영:\n> 1) Slack **슬래시 커맨드 미사용** → **DM(또는 앱 멘션/일반 메시지)에서 `/todo …`**로 사용  \n> 2) private 프로젝트: **same owner 내 name 유니크**  \n> 3) `/todo project set-private` 실행 시: 해당 프로젝트 내 task 중 **owner가 아닌 assignee가 하나라도 있으면 에러**  \n> 4) 프로젝트 이름 충돌 해소: **옵션 A(private 우선)** 유지  \n> 5) DB **초기 생성/마이그레이션** 절차 추가\n\n---\n\n## 1) 개요\n\n### 1.1 목표\nOpenClaw 플러그인으로 Slack에서 다음을 **LLM 호출 없이(=비용 0)** 처리하는 팀/개인용 TODO 시스템을 제공한다.\n\n- `/todo add|list|board|move|done|drop|edit`\n- `/todo project list|set-private|set-shared`\n- 저장소: **공유 SQLite3** (동일 Gateway/동일 DB 파일)\n- 담당자(assignee): **Slack 멘션만 허용** (`<@U…>` 기반)\n- due: `YYYY-MM-DD` 또는 `MM-DD` 허용, 연도 생략 시 **현재 연도**로 보정\n- Private 프로젝트: **오직 owner만** 조회/수정 가능\n\n---\n\n## 2) Slack 사용 방식 (슬래시 커맨드 미사용)\n\n### 2.1 사용 채널\n슬래시 커맨드를 쓰지 않는다면, 일반적으로 다음 중 하나로 사용한다.\n\n- **DM 채널**: OpenClaw Slack 앱(봇)과 1:1 대화에서 `/todo …` 입력  \n- **채널/스레드**(옵션): 앱 멘션(`@openclaw /todo …`) 또는 특정 메시지 패턴을 OpenClaw가 수신하도록 설정된 경우\n\n> v1은 **DM 사용을 기본 경로**로 가정한다.  \n> 이유: 권한/노이즈/오작동 리스크가 낮고 운영이 단순함.\n\n### 2.2 커맨드 인식 규칙\n- 메시지의 첫 토큰이 `/todo`이면 플러그인이 처리한다.\n- 그 외 메시지는 v1에서 무시(자연어 자동 등록은 Phase 2).\n\n---\n\n## 3) 핵심 정책\n\n### 3.1 프로젝트 이름 유니크 정책\n- **Shared 프로젝트**: 전역 유니크 (겹치면 생성/변경 거부)\n- **Private 프로젝트**: **same owner 내에서만 유니크** (owner가 다르면 동일 name 허용)\n\n### 3.2 프로젝트 이름 충돌 해소(옵션 A)\n`/p <name>` 해석:\n1) sender(owner)의 private 프로젝트 `<name>`가 존재하면 **private 우선**\n2) 없으면 shared `<name>` 사용\n3) 둘 다 없으면 (v1 정책에 따라) shared 자동 생성 또는 에러\n\n> 운영 가이드: private와 shared에 같은 이름을 쓰지 않는 것을 권장(혼란 방지).\n\n### 3.3 Private 프로젝트 assignee 제한(“경고 후 거부”)\n- private 프로젝트는 **owner만 볼 수 있는 범위**이므로:\n  - add/edit 시 owner 이외의 assignee가 포함되면 **경고 메시지 출력 후 작업 거부(변경/생성 미적용)**\n\n경고/거부 응답 예시:\n- `⚠️ Private 프로젝트(Personal)는 owner만 볼 수 있어요. 다른 담당자(<@U…>)를 지정할 수 없습니다. (요청이 적용되지 않았습니다.)`\n\n### 3.4 `/todo project set-private` 추가 제약(요구사항)\n- 프로젝트를 private로 전환할 때,\n  - 해당 프로젝트 내 모든 task를 스캔하여\n  - **owner가 아닌 assignee가 하나라도 존재하면 에러**로 실패해야 한다.\n- 에러 메시지에는 최소한 아래 정보를 포함한다:\n  - 실패 사유\n  - 위반 task id 목록 일부(예: 최대 10개)\n  - 위반 assignee 목록 일부\n\n에러 예시:\n- `❌ Cannot set project \"Biz\" to private: found tasks assigned to non-owner users. e.g. #12 assignees:<@U2>, #18 assignees:<@U3>`\n\n---\n\n## 4) due 파서 정책\n\n허용 입력:\n- `due:YYYY-MM-DD`\n- `due:MM-DD` 또는 `due:M-D`\n\n보정:\n- 연도 생략 시: `YYYY = now().year` (서버 timezone은 Asia/Seoul 권장)\n\n검증:\n- 유효하지 않은 날짜(예: 02-30)는 에러\n- DB에는 항상 `YYYY-MM-DD`로 저장\n\n---\n\n## 5) 커맨드 스펙\n\n### 5.0 공통 토큰\n- 프로젝트: `/p <projectName>`\n- 섹션: `/s <section>`\n- 섹션 enum: `backlog | doing | waiting | done | drop`\n- due: `due:YYYY-MM-DD|MM-DD` 또는 `due:-`(클리어)\n\n---\n\n### 5.1 `/todo add`\n문법:\n```\n/todo add <title...> [<@USER> ...] [/p <project>] [/s <section>] [due:YYYY-MM-DD|MM-DD]\n```\n\n기본값:\n- project: `Inbox`\n- section: `backlog`\n- assignees:\n  - 멘션 없으면 sender\n  - 멘션 있으면 해당 유저들(다중)\n- due: 없으면 NULL\n\n검증:\n- private 프로젝트에 sender 외 assignee 포함 시: **경고 후 거부**\n- 프로젝트가 없으면:\n  - `Inbox`는 shared로 자동 생성 가능(권장)\n\n응답:\n- `✅ Added #123 (Inbox/backlog) due:- assignees:<@U1> — 장보기`\n\n---\n\n### 5.2 `/todo list`\n문법:\n```\n/todo list [mine|all|<@USER>] [/p <project>] [/s <section>] [open|done|drop] [limit:N]\n```\n\n기본값:\n- scope: `mine`\n- status: `open`\n- limit: 30\n\nscope 의미:\n- `mine`: assignees에 sender 포함\n- `<@USER>`: 해당 유저가 assignee인 task\n- `all`: shared 전체 + sender의 private 프로젝트(타인의 private는 제외)\n\n정렬:\n1) due 있는 것 우선\n2) due 오름차순\n3) id 내림차순\n\n---\n\n### 5.3 `/todo board`\n문법:\n```\n/todo board [mine|all|<@USER>] [/p <project>] [open|done|drop] [limitPerSection:N]\n```\n\n기본값:\n- scope: mine\n- status: open\n- limitPerSection: 10\n\n출력:\n- BACKLOG → DOING → WAITING → DONE → DROP 순\n- 항목 포맷: `#id due:YYYY-MM-DD| - assignees:<@U..> <@U..> title`\n\n---\n\n### 5.4 `/todo move`\n문법:\n```\n/todo move <id> <section>\n```\n\n검증:\n- 섹션 enum validate\n- 권한:\n  - private: owner만\n  - shared: v1 권장 `assignee` 또는 `created_by`만 수정 가능\n\n---\n\n### 5.5 `/todo done`\n```\n/todo done <id>\n```\n- section=`done`, status=`done`, closed_at 기록\n\n### 5.6 `/todo drop`\n```\n/todo drop <id>\n```\n- section=`drop`, status=`dropped`, closed_at 기록\n\n---\n\n### 5.7 `/todo edit`\n문법(v1 replace 방식):\n```\n/todo edit <id> [<new title...>] [<@USER> ...] [/p <project>] [/s <section>] [due:YYYY-MM-DD|MM-DD|due:-]\n```\n\n규칙:\n- 멘션이 있으면 assignees **완전 교체**\n- `due:-` 는 due NULL\n- title은 옵션 토큰 이전 텍스트를 새 title로 간주(비어있으면 변경 없음)\n\n검증:\n- private 프로젝트로 변경되거나 private 프로젝트에서 assignee 변경 시:\n  - sender 외 assignee 포함이면 **경고 후 거부(변경 미적용)**\n\n---\n\n### 5.8 `/todo project list`\n- 반환:\n  - shared 프로젝트 목록\n  - sender(owner)의 private 프로젝트 목록\n\n---\n\n### 5.9 `/todo project set-private <name>`\n동작:\n1) 대상 프로젝트를 resolve:\n   - sender의 private `<name>` 존재 → already private (ok)\n   - 없고 shared `<name>` 존재 → shared를 private로 “전환 시도”\n   - 둘 다 없으면 → sender private `<name>` 생성 (owner=sender)\n\n2) shared→private 전환 시도 시 검증:\n   - 해당 프로젝트 내 tasks를 조회\n   - 각 task에 대해 `task_assignees`를 확인\n   - **owner(sender) 외 assignee가 하나라도 존재하면 실패(에러)**\n\n3) 성공 시:\n   - projects.visibility='private', owner_user_id=sender\n   - (선택) 기존 task의 assignees가 모두 owner인지 확인되므로 유지 가능\n\n---\n\n### 5.10 `/todo project set-shared <name>`\n동작:\n- shared `<name>`이 없으면 생성\n- 이미 있으면 noop\n- 단, shared는 전역 유니크이므로 충돌 시 에러/exists\n\n---\n\n## 6) 데이터 모델 (SQLite3)\n\n### 6.1 DB 파일 위치\n- 기본: `~/.openclaw/workspace/.todo/todo.sqlite3`\n\n### 6.2 동시성 설정\n- `PRAGMA journal_mode=WAL;`\n- `PRAGMA busy_timeout=3000;`\n\n### 6.3 스키마(v1)\n\n#### `projects`\n- `id` INTEGER PK AUTOINCREMENT\n- `name` TEXT NOT NULL\n- `visibility` TEXT NOT NULL CHECK (visibility IN ('shared','private'))\n- `owner_user_id` TEXT NULL\n- `created_at` TEXT NOT NULL DEFAULT (datetime('now'))\n- `updated_at` TEXT NOT NULL DEFAULT (datetime('now'))\n\nIndexes:\n- shared 전역 유니크:\n  - `CREATE UNIQUE INDEX ux_projects_shared_name ON projects(name) WHERE visibility='shared';`\n- private owner 내 유니크:\n  - `CREATE UNIQUE INDEX ux_projects_private_owner_name ON projects(owner_user_id, name) WHERE visibility='private';`\n\n#### `tasks`\n- `id` INTEGER PK AUTOINCREMENT\n- `title` TEXT NOT NULL\n- `project_id` INTEGER NOT NULL REFERENCES projects(id)\n- `section` TEXT NOT NULL CHECK (section IN ('backlog','doing','waiting','done','drop'))\n- `due` TEXT NULL  -- YYYY-MM-DD\n- `status` TEXT NOT NULL CHECK (status IN ('open','done','dropped'))\n- `created_by` TEXT NOT NULL  -- Slack user id\n- `created_at`, `updated_at`, `closed_at`\n\n#### `task_assignees`\n- `task_id` INTEGER NOT NULL REFERENCES tasks(id)\n- `assignee_user_id` TEXT NOT NULL\n- PRIMARY KEY(task_id, assignee_user_id)\n- INDEX: `(assignee_user_id, task_id)`\n\n#### `events` (audit, 권장)\n- `id` INTEGER PK\n- `ts` TEXT\n- `actor_user_id` TEXT\n- `action` TEXT\n- `task_id` INTEGER NULL\n- `payload` TEXT (JSON)\n\n---\n\n## 7) DB 초기 생성 / 마이그레이션(필수)\n\n### 7.1 생성 타이밍\n플러그인 로딩 후 첫 `/todo …` 실행 시 또는 gateway startup 시점에 아래를 수행:\n\n1) workspace path 결정\n2) `~/.openclaw/workspace/.todo/` 디렉토리 생성\n3) `todo.sqlite3` 파일 존재 여부 확인\n4) 없으면:\n   - 파일 생성\n   - schema migration 실행\n   - `schema_version` 테이블 생성 및 version=1 기록\n\n### 7.2 schema_version 테이블\n- `schema_version(version INTEGER NOT NULL)`\n- 초기: 1\n- 향후:\n  - 현재 버전 읽고, 필요한 migration 순차 실행\n\n### 7.3 기본 프로젝트 생성(권장)\n- DB 초기화 시 shared 프로젝트 `Inbox` 자동 생성 (중복이면 noop)\n\n---\n\n## 8) 권한/가시성\n\n### 8.1 읽기\n- private: owner만\n- shared: scope에 따라 mine/all/<@USER>\n\n### 8.2 쓰기\n- private: owner만\n- shared: v1 권장 `assignee` 또는 `created_by`만\n\n---\n\n## 9) 수용 기준(Acceptance Criteria)\n\n- [ ] shared 프로젝트 이름 충돌 시 생성/변경 거부\n- [ ] private 프로젝트는 owner 단위로 유니크 (owner A/B는 같은 name 허용)\n- [ ] `/todo project set-private <name>` 실행 시:\n  - 프로젝트 내 task 중 owner 외 assignee 존재하면 에러로 실패\n- [ ] private 프로젝트에 타 assignee 지정 시: 경고 + 작업 미생성/미수정\n- [ ] due `MM-DD` 입력 시 올해로 보정되어 저장\n- [ ] DB 최초 실행 시 파일 생성 + schema 적용 + Inbox 생성\n\n---\n\n## 10) 구현 작업 분해(WBS)\n\n- M0: plugin skeleton + `/todo` command 등록\n- M1: DB init + migrations + schema_version\n- M2: parser (Slack mention, /p, /s, due 보정)\n- M3: commands (add/list/board/move/done/drop/edit)\n- M4: project commands (list/set-private/set-shared + set-private 검증 로직)\n- M5: tests (parser/unit + sqlite E2E)\n- M6: packaging/배포(npm 권장)\n", "numLines": 353, "startLine": 1, "totalLines": 353}}, "tool_use_id": "toolu_01SLvcw8E4kYrHk29G4v2DTA", "_ts": "2026-02-20T11:31:45+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/architect.md"}, "tool_use_id": "toolu_01VUbG7K4Z6PfDavPmuKPkC3", "_ts": "2026-02-20T11:31:45+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/architect.md"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.claude/agents/architect.md", "content": "---\nname: architect\ndescription: Design pragmatic software architecture for the PRD. Prefer Django monolith + Postgres.\ntools: Read, Glob, Grep, Write, Edit\nmodel: opus\n---\nOutput: docs/architecture.md only.\nInclude modules, data model, APIs, jobs, observability, security, deploy/rollback, tradeoffs.\n", "numLines": 9, "startLine": 1, "totalLines": 9}}, "tool_use_id": "toolu_01VUbG7K4Z6PfDavPmuKPkC3", "_ts": "2026-02-20T11:31:45+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit"}, "tool_use_id": "toolu_01DuDusEmrihFfb9zbu3tFjk", "_ts": "2026-02-20T11:31:46+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUseFailure", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit"}, "tool_use_id": "toolu_01DuDusEmrihFfb9zbu3tFjk", "error": "EISDIR: illegal operation on a directory, read '/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit'", "is_interrupt": false, "_ts": "2026-02-20T11:31:46+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/README.md"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/README.md", "content": "# openclaw_todo_plugin", "numLines": 1, "startLine": 1, "totalLines": 1}}, "tool_use_id": "toolu_01DWia2zuPNUU6cqo2fEkT8F", "_ts": "2026-02-20T11:31:46+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Task", "tool_input": {"description": "Design test plan from PRD", "prompt": "Read the PRD at /Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md and create a test strategy and test cases document.\n\nThe project is a Python-based OpenClaw TODO Plugin for Slack with:\n- Command parsing (mentions, /p, /s, due dates)\n- SQLite3 database operations\n- Private/shared project access control\n- Multiple commands: add, list, board, move, done, drop, edit\n- Project management: list, set-private, set-shared\n- Schema migration\n\nTesting framework: pytest (per project conventions)\n\nCreate test cases (not test code) covering:\n- Unit tests for parser, commands, DB operations\n- Integration/E2E tests for full command flows\n- Edge cases from the PRD (private project restrictions, due date parsing, name conflicts)\n- Acceptance criteria validation\n\nWrite the output to /Users/pillip/project/practice/openclaw_todo_plugin/docs/test_plan.md", "subagent_type": "qa-designer", "run_in_background": true}, "tool_use_id": "toolu_01SHYMDvWFrwqXywambUaRPh", "_ts": "2026-02-20T11:31:47+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Task", "tool_input": {"description": "Design test plan from PRD", "prompt": "Read the PRD at /Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md and create a test strategy and test cases document.\n\nThe project is a Python-based OpenClaw TODO Plugin for Slack with:\n- Command parsing (mentions, /p, /s, due dates)\n- SQLite3 database operations\n- Private/shared project access control\n- Multiple commands: add, list, board, move, done, drop, edit\n- Project management: list, set-private, set-shared\n- Schema migration\n\nTesting framework: pytest (per project conventions)\n\nCreate test cases (not test code) covering:\n- Unit tests for parser, commands, DB operations\n- Integration/E2E tests for full command flows\n- Edge cases from the PRD (private project restrictions, due date parsing, name conflicts)\n- Acceptance criteria validation\n\nWrite the output to /Users/pillip/project/practice/openclaw_todo_plugin/docs/test_plan.md", "subagent_type": "qa-designer", "run_in_background": true}, "tool_response": {"isAsync": true, "status": "async_launched", "agentId": "a03d4ab", "description": "Design test plan from PRD", "prompt": "Read the PRD at /Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md and create a test strategy and test cases document.\n\nThe project is a Python-based OpenClaw TODO Plugin for Slack with:\n- Command parsing (mentions, /p, /s, due dates)\n- SQLite3 database operations\n- Private/shared project access control\n- Multiple commands: add, list, board, move, done, drop, edit\n- Project management: list, set-private, set-shared\n- Schema migration\n\nTesting framework: pytest (per project conventions)\n\nCreate test cases (not test code) covering:\n- Unit tests for parser, commands, DB operations\n- Integration/E2E tests for full command flows\n- Edge cases from the PRD (private project restrictions, due date parsing, name conflicts)\n- Acceptance criteria validation\n\nWrite the output to /Users/pillip/project/practice/openclaw_todo_plugin/docs/test_plan.md", "outputFile": "/private/tmp/claude-501/-Users-pillip-project-practice-openclaw-todo-plugin/tasks/a03d4ab.output"}, "tool_use_id": "toolu_01SHYMDvWFrwqXywambUaRPh", "_ts": "2026-02-20T11:31:47+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Glob", "tool_input": {"pattern": "**/*.py", "path": "/Users/pillip/project/practice/openclaw_todo_plugin"}, "tool_use_id": "toolu_019WNn2guU9H18MJKRqpWq8Q", "_ts": "2026-02-20T11:31:49+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Glob", "tool_input": {"pattern": "**/*.py", "path": "/Users/pillip/project/practice/openclaw_todo_plugin"}, "tool_response": {"filenames": ["/Users/pillip/project/practice/openclaw_todo_plugin/.claude/hooks/agent_state.py", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/project/.claude/hooks/agent_state.py", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/scripts/merge_settings.py", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/tests/test_agent_state.py", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/tests/test_integration.py", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/tests/test_merge_settings.py", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/user/kit/bin/cc-statusline.py"], "durationMs": 421, "numFiles": 7, "truncated": false}, "tool_use_id": "toolu_019WNn2guU9H18MJKRqpWq8Q", "_ts": "2026-02-20T11:31:50+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md"}, "tool_use_id": "toolu_01Y1qFzcwj92pZt9QvK9Eu4e", "_ts": "2026-02-20T11:31:50+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Glob", "tool_input": {"pattern": "**/pyproject.toml", "path": "/Users/pillip/project/practice/openclaw_todo_plugin"}, "tool_use_id": "toolu_014GAEkJXy3hYJfXa7fq1UD7", "_ts": "2026-02-20T11:31:50+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md", "content": "# OpenClaw TODO Plugin for Slack — PRD v1.1 (DM 기반)\n\n> 변경사항 반영:\n> 1) Slack **슬래시 커맨드 미사용** → **DM(또는 앱 멘션/일반 메시지)에서 `/todo …`**로 사용  \n> 2) private 프로젝트: **same owner 내 name 유니크**  \n> 3) `/todo project set-private` 실행 시: 해당 프로젝트 내 task 중 **owner가 아닌 assignee가 하나라도 있으면 에러**  \n> 4) 프로젝트 이름 충돌 해소: **옵션 A(private 우선)** 유지  \n> 5) DB **초기 생성/마이그레이션** 절차 추가\n\n---\n\n## 1) 개요\n\n### 1.1 목표\nOpenClaw 플러그인으로 Slack에서 다음을 **LLM 호출 없이(=비용 0)** 처리하는 팀/개인용 TODO 시스템을 제공한다.\n\n- `/todo add|list|board|move|done|drop|edit`\n- `/todo project list|set-private|set-shared`\n- 저장소: **공유 SQLite3** (동일 Gateway/동일 DB 파일)\n- 담당자(assignee): **Slack 멘션만 허용** (`<@U…>` 기반)\n- due: `YYYY-MM-DD` 또는 `MM-DD` 허용, 연도 생략 시 **현재 연도**로 보정\n- Private 프로젝트: **오직 owner만** 조회/수정 가능\n\n---\n\n## 2) Slack 사용 방식 (슬래시 커맨드 미사용)\n\n### 2.1 사용 채널\n슬래시 커맨드를 쓰지 않는다면, 일반적으로 다음 중 하나로 사용한다.\n\n- **DM 채널**: OpenClaw Slack 앱(봇)과 1:1 대화에서 `/todo …` 입력  \n- **채널/스레드**(옵션): 앱 멘션(`@openclaw /todo …`) 또는 특정 메시지 패턴을 OpenClaw가 수신하도록 설정된 경우\n\n> v1은 **DM 사용을 기본 경로**로 가정한다.  \n> 이유: 권한/노이즈/오작동 리스크가 낮고 운영이 단순함.\n\n### 2.2 커맨드 인식 규칙\n- 메시지의 첫 토큰이 `/todo`이면 플러그인이 처리한다.\n- 그 외 메시지는 v1에서 무시(자연어 자동 등록은 Phase 2).\n\n---\n\n## 3) 핵심 정책\n\n### 3.1 프로젝트 이름 유니크 정책\n- **Shared 프로젝트**: 전역 유니크 (겹치면 생성/변경 거부)\n- **Private 프로젝트**: **same owner 내에서만 유니크** (owner가 다르면 동일 name 허용)\n\n### 3.2 프로젝트 이름 충돌 해소(옵션 A)\n`/p <name>` 해석:\n1) sender(owner)의 private 프로젝트 `<name>`가 존재하면 **private 우선**\n2) 없으면 shared `<name>` 사용\n3) 둘 다 없으면 (v1 정책에 따라) shared 자동 생성 또는 에러\n\n> 운영 가이드: private와 shared에 같은 이름을 쓰지 않는 것을 권장(혼란 방지).\n\n### 3.3 Private 프로젝트 assignee 제한(“경고 후 거부”)\n- private 프로젝트는 **owner만 볼 수 있는 범위**이므로:\n  - add/edit 시 owner 이외의 assignee가 포함되면 **경고 메시지 출력 후 작업 거부(변경/생성 미적용)**\n\n경고/거부 응답 예시:\n- `⚠️ Private 프로젝트(Personal)는 owner만 볼 수 있어요. 다른 담당자(<@U…>)를 지정할 수 없습니다. (요청이 적용되지 않았습니다.)`\n\n### 3.4 `/todo project set-private` 추가 제약(요구사항)\n- 프로젝트를 private로 전환할 때,\n  - 해당 프로젝트 내 모든 task를 스캔하여\n  - **owner가 아닌 assignee가 하나라도 존재하면 에러**로 실패해야 한다.\n- 에러 메시지에는 최소한 아래 정보를 포함한다:\n  - 실패 사유\n  - 위반 task id 목록 일부(예: 최대 10개)\n  - 위반 assignee 목록 일부\n\n에러 예시:\n- `❌ Cannot set project \"Biz\" to private: found tasks assigned to non-owner users. e.g. #12 assignees:<@U2>, #18 assignees:<@U3>`\n\n---\n\n## 4) due 파서 정책\n\n허용 입력:\n- `due:YYYY-MM-DD`\n- `due:MM-DD` 또는 `due:M-D`\n\n보정:\n- 연도 생략 시: `YYYY = now().year` (서버 timezone은 Asia/Seoul 권장)\n\n검증:\n- 유효하지 않은 날짜(예: 02-30)는 에러\n- DB에는 항상 `YYYY-MM-DD`로 저장\n\n---\n\n## 5) 커맨드 스펙\n\n### 5.0 공통 토큰\n- 프로젝트: `/p <projectName>`\n- 섹션: `/s <section>`\n- 섹션 enum: `backlog | doing | waiting | done | drop`\n- due: `due:YYYY-MM-DD|MM-DD` 또는 `due:-`(클리어)\n\n---\n\n### 5.1 `/todo add`\n문법:\n```\n/todo add <title...> [<@USER> ...] [/p <project>] [/s <section>] [due:YYYY-MM-DD|MM-DD]\n```\n\n기본값:\n- project: `Inbox`\n- section: `backlog`\n- assignees:\n  - 멘션 없으면 sender\n  - 멘션 있으면 해당 유저들(다중)\n- due: 없으면 NULL\n\n검증:\n- private 프로젝트에 sender 외 assignee 포함 시: **경고 후 거부**\n- 프로젝트가 없으면:\n  - `Inbox`는 shared로 자동 생성 가능(권장)\n\n응답:\n- `✅ Added #123 (Inbox/backlog) due:- assignees:<@U1> — 장보기`\n\n---\n\n### 5.2 `/todo list`\n문법:\n```\n/todo list [mine|all|<@USER>] [/p <project>] [/s <section>] [open|done|drop] [limit:N]\n```\n\n기본값:\n- scope: `mine`\n- status: `open`\n- limit: 30\n\nscope 의미:\n- `mine`: assignees에 sender 포함\n- `<@USER>`: 해당 유저가 assignee인 task\n- `all`: shared 전체 + sender의 private 프로젝트(타인의 private는 제외)\n\n정렬:\n1) due 있는 것 우선\n2) due 오름차순\n3) id 내림차순\n\n---\n\n### 5.3 `/todo board`\n문법:\n```\n/todo board [mine|all|<@USER>] [/p <project>] [open|done|drop] [limitPerSection:N]\n```\n\n기본값:\n- scope: mine\n- status: open\n- limitPerSection: 10\n\n출력:\n- BACKLOG → DOING → WAITING → DONE → DROP 순\n- 항목 포맷: `#id due:YYYY-MM-DD| - assignees:<@U..> <@U..> title`\n\n---\n\n### 5.4 `/todo move`\n문법:\n```\n/todo move <id> <section>\n```\n\n검증:\n- 섹션 enum validate\n- 권한:\n  - private: owner만\n  - shared: v1 권장 `assignee` 또는 `created_by`만 수정 가능\n\n---\n\n### 5.5 `/todo done`\n```\n/todo done <id>\n```\n- section=`done`, status=`done`, closed_at 기록\n\n### 5.6 `/todo drop`\n```\n/todo drop <id>\n```\n- section=`drop`, status=`dropped`, closed_at 기록\n\n---\n\n### 5.7 `/todo edit`\n문법(v1 replace 방식):\n```\n/todo edit <id> [<new title...>] [<@USER> ...] [/p <project>] [/s <section>] [due:YYYY-MM-DD|MM-DD|due:-]\n```\n\n규칙:\n- 멘션이 있으면 assignees **완전 교체**\n- `due:-` 는 due NULL\n- title은 옵션 토큰 이전 텍스트를 새 title로 간주(비어있으면 변경 없음)\n\n검증:\n- private 프로젝트로 변경되거나 private 프로젝트에서 assignee 변경 시:\n  - sender 외 assignee 포함이면 **경고 후 거부(변경 미적용)**\n\n---\n\n### 5.8 `/todo project list`\n- 반환:\n  - shared 프로젝트 목록\n  - sender(owner)의 private 프로젝트 목록\n\n---\n\n### 5.9 `/todo project set-private <name>`\n동작:\n1) 대상 프로젝트를 resolve:\n   - sender의 private `<name>` 존재 → already private (ok)\n   - 없고 shared `<name>` 존재 → shared를 private로 “전환 시도”\n   - 둘 다 없으면 → sender private `<name>` 생성 (owner=sender)\n\n2) shared→private 전환 시도 시 검증:\n   - 해당 프로젝트 내 tasks를 조회\n   - 각 task에 대해 `task_assignees`를 확인\n   - **owner(sender) 외 assignee가 하나라도 존재하면 실패(에러)**\n\n3) 성공 시:\n   - projects.visibility='private', owner_user_id=sender\n   - (선택) 기존 task의 assignees가 모두 owner인지 확인되므로 유지 가능\n\n---\n\n### 5.10 `/todo project set-shared <name>`\n동작:\n- shared `<name>`이 없으면 생성\n- 이미 있으면 noop\n- 단, shared는 전역 유니크이므로 충돌 시 에러/exists\n\n---\n\n## 6) 데이터 모델 (SQLite3)\n\n### 6.1 DB 파일 위치\n- 기본: `~/.openclaw/workspace/.todo/todo.sqlite3`\n\n### 6.2 동시성 설정\n- `PRAGMA journal_mode=WAL;`\n- `PRAGMA busy_timeout=3000;`\n\n### 6.3 스키마(v1)\n\n#### `projects`\n- `id` INTEGER PK AUTOINCREMENT\n- `name` TEXT NOT NULL\n- `visibility` TEXT NOT NULL CHECK (visibility IN ('shared','private'))\n- `owner_user_id` TEXT NULL\n- `created_at` TEXT NOT NULL DEFAULT (datetime('now'))\n- `updated_at` TEXT NOT NULL DEFAULT (datetime('now'))\n\nIndexes:\n- shared 전역 유니크:\n  - `CREATE UNIQUE INDEX ux_projects_shared_name ON projects(name) WHERE visibility='shared';`\n- private owner 내 유니크:\n  - `CREATE UNIQUE INDEX ux_projects_private_owner_name ON projects(owner_user_id, name) WHERE visibility='private';`\n\n#### `tasks`\n- `id` INTEGER PK AUTOINCREMENT\n- `title` TEXT NOT NULL\n- `project_id` INTEGER NOT NULL REFERENCES projects(id)\n- `section` TEXT NOT NULL CHECK (section IN ('backlog','doing','waiting','done','drop'))\n- `due` TEXT NULL  -- YYYY-MM-DD\n- `status` TEXT NOT NULL CHECK (status IN ('open','done','dropped'))\n- `created_by` TEXT NOT NULL  -- Slack user id\n- `created_at`, `updated_at`, `closed_at`\n\n#### `task_assignees`\n- `task_id` INTEGER NOT NULL REFERENCES tasks(id)\n- `assignee_user_id` TEXT NOT NULL\n- PRIMARY KEY(task_id, assignee_user_id)\n- INDEX: `(assignee_user_id, task_id)`\n\n#### `events` (audit, 권장)\n- `id` INTEGER PK\n- `ts` TEXT\n- `actor_user_id` TEXT\n- `action` TEXT\n- `task_id` INTEGER NULL\n- `payload` TEXT (JSON)\n\n---\n\n## 7) DB 초기 생성 / 마이그레이션(필수)\n\n### 7.1 생성 타이밍\n플러그인 로딩 후 첫 `/todo …` 실행 시 또는 gateway startup 시점에 아래를 수행:\n\n1) workspace path 결정\n2) `~/.openclaw/workspace/.todo/` 디렉토리 생성\n3) `todo.sqlite3` 파일 존재 여부 확인\n4) 없으면:\n   - 파일 생성\n   - schema migration 실행\n   - `schema_version` 테이블 생성 및 version=1 기록\n\n### 7.2 schema_version 테이블\n- `schema_version(version INTEGER NOT NULL)`\n- 초기: 1\n- 향후:\n  - 현재 버전 읽고, 필요한 migration 순차 실행\n\n### 7.3 기본 프로젝트 생성(권장)\n- DB 초기화 시 shared 프로젝트 `Inbox` 자동 생성 (중복이면 noop)\n\n---\n\n## 8) 권한/가시성\n\n### 8.1 읽기\n- private: owner만\n- shared: scope에 따라 mine/all/<@USER>\n\n### 8.2 쓰기\n- private: owner만\n- shared: v1 권장 `assignee` 또는 `created_by`만\n\n---\n\n## 9) 수용 기준(Acceptance Criteria)\n\n- [ ] shared 프로젝트 이름 충돌 시 생성/변경 거부\n- [ ] private 프로젝트는 owner 단위로 유니크 (owner A/B는 같은 name 허용)\n- [ ] `/todo project set-private <name>` 실행 시:\n  - 프로젝트 내 task 중 owner 외 assignee 존재하면 에러로 실패\n- [ ] private 프로젝트에 타 assignee 지정 시: 경고 + 작업 미생성/미수정\n- [ ] due `MM-DD` 입력 시 올해로 보정되어 저장\n- [ ] DB 최초 실행 시 파일 생성 + schema 적용 + Inbox 생성\n\n---\n\n## 10) 구현 작업 분해(WBS)\n\n- M0: plugin skeleton + `/todo` command 등록\n- M1: DB init + migrations + schema_version\n- M2: parser (Slack mention, /p, /s, due 보정)\n- M3: commands (add/list/board/move/done/drop/edit)\n- M4: project commands (list/set-private/set-shared + set-private 검증 로직)\n- M5: tests (parser/unit + sqlite E2E)\n- M6: packaging/배포(npm 권장)\n", "numLines": 353, "startLine": 1, "totalLines": 353}}, "tool_use_id": "toolu_01Y1qFzcwj92pZt9QvK9Eu4e", "_ts": "2026-02-20T11:31:50+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Glob", "tool_input": {"pattern": "**/*.py", "path": "/Users/pillip/project/practice/openclaw_todo_plugin"}, "tool_use_id": "toolu_01TWxxfs4bJfN6HHhaE2TRxx", "_ts": "2026-02-20T11:31:50+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Glob", "tool_input": {"pattern": "**/pyproject.toml", "path": "/Users/pillip/project/practice/openclaw_todo_plugin"}, "tool_response": {"filenames": [], "durationMs": 392, "numFiles": 0, "truncated": false}, "tool_use_id": "toolu_014GAEkJXy3hYJfXa7fq1UD7", "_ts": "2026-02-20T11:31:50+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Glob", "tool_input": {"pattern": "**/*.py", "path": "/Users/pillip/project/practice/openclaw_todo_plugin"}, "tool_response": {"filenames": ["/Users/pillip/project/practice/openclaw_todo_plugin/.claude/hooks/agent_state.py", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/project/.claude/hooks/agent_state.py", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/scripts/merge_settings.py", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/tests/test_agent_state.py", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/tests/test_integration.py", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/tests/test_merge_settings.py", "/Users/pillip/project/practice/openclaw_todo_plugin/.claude-kit/user/kit/bin/cc-statusline.py"], "durationMs": 324, "numFiles": 7, "truncated": false}, "tool_use_id": "toolu_01TWxxfs4bJfN6HHhaE2TRxx", "_ts": "2026-02-20T11:31:51+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "SubagentStop", "stop_hook_active": false, "agent_id": "ac18102", "agent_transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4/subagents/agent-ac18102.jsonl", "agent_type": "", "_ts": "2026-02-20T11:31:53+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Glob", "tool_input": {"pattern": "**/tasklist*.md", "path": "/Users/pillip/project/practice/openclaw_todo_plugin"}, "tool_use_id": "toolu_01Rep1yksspY6475BXnMGaZJ", "_ts": "2026-02-20T11:31:54+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Glob", "tool_input": {"pattern": "**/tasklist*.md", "path": "/Users/pillip/project/practice/openclaw_todo_plugin"}, "tool_response": {"filenames": [], "durationMs": 413, "numFiles": 0, "truncated": false}, "tool_use_id": "toolu_01Rep1yksspY6475BXnMGaZJ", "_ts": "2026-02-20T11:31:54+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Glob", "tool_input": {"pattern": "**/pyproject.toml", "path": "/Users/pillip/project/practice/openclaw_todo_plugin"}, "tool_use_id": "toolu_01M4pn3Le3PngsfQKzMcYLQm", "_ts": "2026-02-20T11:31:54+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Glob", "tool_input": {"pattern": "**/pyproject.toml", "path": "/Users/pillip/project/practice/openclaw_todo_plugin"}, "tool_response": {"filenames": [], "durationMs": 525, "numFiles": 0, "truncated": false}, "tool_use_id": "toolu_01M4pn3Le3PngsfQKzMcYLQm", "_ts": "2026-02-20T11:31:55+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/docs/requirements.md", "content": "# OpenClaw TODO Plugin -- Requirements Document\n\n> **Version**: 1.0\n> **Date**: 2026-02-20\n> **Source PRD**: `openclaw_todo_plugin_prd.md` v1.1\n> **Status**: Draft\n\n---\n\n## 1. Purpose\n\nDefine the functional and non-functional requirements for a Slack-based TODO management plugin (OpenClaw TODO Plugin). The plugin operates via DM with a Slack bot, stores data in SQLite3, and supports private/shared project workflows with zero LLM cost.\n\n---\n\n## 2. Scope\n\n### 2.1 In Scope (MVP / v1)\n\n| Area | Details |\n|------|---------|\n| **Command interface** | `/todo add`, `list`, `board`, `move`, `done`, `drop`, `edit` |\n| **Project management** | `/todo project list`, `set-private`, `set-shared` |\n| **Storage** | Single shared SQLite3 file with WAL mode |\n| **Input channel** | DM with the OpenClaw Slack bot (primary path) |\n| **Due date parsing** | `YYYY-MM-DD` and `MM-DD` with year inference |\n| **Assignee resolution** | Slack `<@U...>` mentions; multi-assignee support |\n| **Visibility model** | Private (owner-only) and shared projects |\n| **Schema migration** | `schema_version` table; auto-create DB and default `Inbox` project on first run |\n| **Audit log** | `events` table recording actor, action, task, and payload |\n\n### 2.2 Out of Scope\n\n- Natural language / LLM-based task creation (Phase 2).\n- Channel or thread-based usage (app mention `@openclaw /todo ...`).\n- Recurring / repeating tasks.\n- Reminders, notifications, or scheduled digests.\n- Multi-workspace federation or cross-workspace sharing.\n- Web UI or dashboard.\n- Task attachments or file uploads.\n- Real-time sync with external project management tools.\n\n---\n\n## 3. Assumptions\n\n| # | Assumption |\n|---|-----------|\n| A1 | The OpenClaw Gateway is already deployed and can route DM messages to plugins. |\n| A2 | Each Slack user has a unique, stable `user_id` (`U...` format). |\n| A3 | A single SQLite3 file is sufficient for the expected concurrency (small-to-medium teams). |\n| A4 | Server timezone is `Asia/Seoul` for date inference. |\n| A5 | The bot has DM read/write permissions via Slack OAuth scopes. |\n| A6 | Plugin packaging and distribution follows existing OpenClaw conventions (npm). |\n\n---\n\n## 4. Constraints\n\n| # | Constraint |\n|---|-----------|\n| C1 | Zero LLM calls -- all parsing is deterministic. |\n| C2 | SQLite3 only; no external database dependency. |\n| C3 | DB file location fixed at `~/.openclaw/workspace/.todo/todo.sqlite3`. |\n| C4 | Section values are a closed enum: `backlog`, `doing`, `waiting`, `done`, `drop`. |\n| C5 | Status values are a closed enum: `open`, `done`, `dropped`. |\n\n---\n\n## 5. Risks\n\n| # | Risk | Likelihood | Impact | Mitigation |\n|---|------|-----------|--------|-----------|\n| R1 | SQLite write contention under high concurrency | Medium | Medium | WAL mode + `busy_timeout=3000`; monitor lock wait times. |\n| R2 | Project name collision confusion (private vs shared same name) | Medium | Low | Private-first resolution + operational guidance to avoid same names. |\n| R3 | Schema migration failure corrupts DB | Low | High | Wrap migrations in transactions; back up DB file before migration. |\n| R4 | Slack API rate limits on bot DM responses | Low | Medium | Queue responses; respect Slack rate limit headers. |\n| R5 | Date parsing edge cases (leap years, locale) | Low | Low | Strict `datetime` validation; reject invalid dates with clear error. |\n\n---\n\n## 6. Functional Requirements\n\n### FR-1: Command Parser\n\n| ID | Requirement |\n|----|------------|\n| FR-1.1 | The plugin MUST recognize messages starting with `/todo` as commands and ignore all other messages. |\n| FR-1.2 | The parser MUST extract tokens: title text, `<@U...>` mentions, `/p <project>`, `/s <section>`, and `due:` value. |\n| FR-1.3 | `due:MM-DD` or `due:M-D` MUST be expanded to `due:YYYY-MM-DD` using the current server year. |\n| FR-1.4 | Invalid dates (e.g., `02-30`) MUST return a user-facing error. |\n| FR-1.5 | `due:-` MUST clear (set to NULL) the due date. |\n\n### FR-2: Task Commands\n\n#### FR-2.1 `/todo add`\n\n| ID | Requirement |\n|----|------------|\n| FR-2.1.1 | Create a task with provided title, assignees, project, section, and due date. |\n| FR-2.1.2 | Defaults: project=`Inbox`, section=`backlog`, assignees=sender, due=NULL. |\n| FR-2.1.3 | If the target project does not exist and is `Inbox`, auto-create it as shared. |\n| FR-2.1.4 | If the target is a private project and any assignee is not the owner, reject with a warning message and do not create the task. |\n| FR-2.1.5 | Return a confirmation message including: task ID, project, section, due, assignees, and title. |\n\n**Acceptance Criteria (add)**:\n- AC-2.1.A: Running `/todo add Buy milk` creates task #N in Inbox/backlog with sender as assignee; response contains `Added #N`.\n- AC-2.1.B: Running `/todo add Deploy <@U2> /p Ops /s doing due:03-15` creates a task in project Ops, section doing, due set to current-year-03-15, assignee U2.\n- AC-2.1.C: Running `/todo add Secret <@U2> /p MyPrivate` where MyPrivate is a private project owned by sender returns a warning and does NOT create the task.\n- AC-2.1.D: Running `/todo add First task` when no DB file exists triggers DB creation, schema application, Inbox project creation, then creates the task.\n\n#### FR-2.2 `/todo list`\n\n| ID | Requirement |\n|----|------------|\n| FR-2.2.1 | List tasks filtered by scope (`mine`/`all`/`<@USER>`), project, section, and status. |\n| FR-2.2.2 | Defaults: scope=`mine`, status=`open`, limit=30. |\n| FR-2.2.3 | Sort order: due (non-null first, ascending), then id descending. |\n| FR-2.2.4 | `all` scope returns shared tasks plus sender's private project tasks; never shows other users' private tasks. |\n\n**Acceptance Criteria (list)**:\n- AC-2.2.A: `/todo list` returns only open tasks where sender is an assignee, limited to 30, sorted by due then id.\n- AC-2.2.B: `/todo list all` includes tasks from shared projects and the sender's private projects, but excludes other users' private project tasks.\n- AC-2.2.C: `/todo list /p Ops /s doing` returns only tasks in project Ops, section doing.\n\n#### FR-2.3 `/todo board`\n\n| ID | Requirement |\n|----|------------|\n| FR-2.3.1 | Display tasks grouped by section in order: BACKLOG, DOING, WAITING, DONE, DROP. |\n| FR-2.3.2 | Defaults: scope=`mine`, status=`open`, limitPerSection=10. |\n| FR-2.3.3 | Each item shows: `#id due assignees title`. |\n\n**Acceptance Criteria (board)**:\n- AC-2.3.A: `/todo board /p Ops` displays tasks grouped under section headers in the correct order.\n- AC-2.3.B: Each section contains at most 10 items by default.\n\n#### FR-2.4 `/todo move`\n\n| ID | Requirement |\n|----|------------|\n| FR-2.4.1 | Move a task to a specified section. |\n| FR-2.4.2 | Validate section against the enum. |\n| FR-2.4.3 | Authorization: private project -- owner only; shared project -- assignee or created_by. |\n\n**Acceptance Criteria (move)**:\n- AC-2.4.A: `/todo move 42 doing` updates task #42 section to doing and returns confirmation.\n- AC-2.4.B: A user who is neither assignee nor creator of a shared task receives an authorization error.\n\n#### FR-2.5 `/todo done` and `/todo drop`\n\n| ID | Requirement |\n|----|------------|\n| FR-2.5.1 | `/todo done <id>`: set section=`done`, status=`done`, record `closed_at`. |\n| FR-2.5.2 | `/todo drop <id>`: set section=`drop`, status=`dropped`, record `closed_at`. |\n| FR-2.5.3 | Authorization rules match FR-2.4.3. |\n\n**Acceptance Criteria (done/drop)**:\n- AC-2.5.A: `/todo done 42` sets task #42 to done status with a non-null `closed_at` timestamp.\n- AC-2.5.B: `/todo drop 42` sets task #42 to dropped status with a non-null `closed_at` timestamp.\n\n#### FR-2.6 `/todo edit`\n\n| ID | Requirement |\n|----|------------|\n| FR-2.6.1 | Update a task's title, assignees, project, section, and/or due date. |\n| FR-2.6.2 | If mentions are provided, assignees are fully replaced (not appended). |\n| FR-2.6.3 | `due:-` clears the due date. |\n| FR-2.6.4 | If editing moves a task into or within a private project and any assignee is not the owner, reject with a warning. |\n| FR-2.6.5 | Title is inferred from text preceding option tokens; if empty, title is unchanged. |\n\n**Acceptance Criteria (edit)**:\n- AC-2.6.A: `/todo edit 42 New title due:04-01` updates both title and due date; response confirms changes.\n- AC-2.6.B: `/todo edit 42 <@U3>` replaces all assignees with U3 only.\n- AC-2.6.C: `/todo edit 42 due:-` sets due to NULL.\n\n### FR-3: Project Commands\n\n#### FR-3.1 `/todo project list`\n\n| ID | Requirement |\n|----|------------|\n| FR-3.1.1 | Return all shared projects and the sender's private projects. |\n| FR-3.1.2 | Never expose other users' private projects. |\n\n#### FR-3.2 `/todo project set-private <name>`\n\n| ID | Requirement |\n|----|------------|\n| FR-3.2.1 | If the sender already owns a private project with `<name>`, return success (idempotent). |\n| FR-3.2.2 | If a shared project `<name>` exists, attempt to convert it to private (owner=sender). |\n| FR-3.2.3 | Before conversion, scan all tasks in the project. If ANY task has an assignee who is not the sender, reject with an error listing up to 10 violating task IDs and assignees. |\n| FR-3.2.4 | If neither exists, create a new private project with owner=sender. |\n\n**Acceptance Criteria (set-private)**:\n- AC-3.2.A: Converting a shared project with only owner-assigned tasks succeeds; project visibility becomes `private`.\n- AC-3.2.B: Converting a shared project where task #12 is assigned to `<@U2>` fails with an error message containing `#12` and `<@U2>`.\n- AC-3.2.C: Running `set-private NewProj` when no project exists creates a private project owned by sender.\n\n#### FR-3.3 `/todo project set-shared <name>`\n\n| ID | Requirement |\n|----|------------|\n| FR-3.3.1 | If a shared project `<name>` exists, no-op. |\n| FR-3.3.2 | If it does not exist, create it. |\n| FR-3.3.3 | If a shared project with `<name>` already exists (global uniqueness conflict), return an error. |\n\n### FR-4: Project Name Resolution\n\n| ID | Requirement |\n|----|------------|\n| FR-4.1 | When `/p <name>` is specified, resolve by: (1) sender's private project with that name, (2) shared project with that name, (3) error or auto-create per context. |\n| FR-4.2 | Shared project names MUST be globally unique. |\n| FR-4.3 | Private project names MUST be unique per owner. |\n\n### FR-5: Database Initialization\n\n| ID | Requirement |\n|----|------------|\n| FR-5.1 | On first command or gateway startup, create the directory `~/.openclaw/workspace/.todo/` if absent. |\n| FR-5.2 | Create `todo.sqlite3` with the full v1 schema if the file does not exist. |\n| FR-5.3 | Create `schema_version` table and set version=1. |\n| FR-5.4 | Auto-create shared project `Inbox` (idempotent). |\n| FR-5.5 | Set `PRAGMA journal_mode=WAL` and `PRAGMA busy_timeout=3000` on every connection. |\n\n**Acceptance Criteria (DB init)**:\n- AC-5.A: Deleting the DB file and running any `/todo` command recreates the DB with all tables and the `Inbox` project.\n- AC-5.B: `schema_version` table contains exactly one row with `version=1`.\n\n### FR-6: Audit Events\n\n| ID | Requirement |\n|----|------------|\n| FR-6.1 | Every state-changing command (add, move, done, drop, edit, set-private, set-shared) MUST insert a row into the `events` table. |\n| FR-6.2 | Each event records: timestamp, actor user ID, action name, task ID (if applicable), and a JSON payload with before/after state. |\n\n---\n\n## 7. Non-Functional Requirements\n\n| ID | Requirement | Metric |\n|----|------------|--------|\n| NFR-1 | **Latency**: Command response time | p95 < 500ms for any single command (excluding Slack network round-trip). |\n| NFR-2 | **Reliability**: No data loss on concurrent writes | Zero data corruption over 1000 concurrent write operations using WAL mode. |\n| NFR-3 | **Availability**: Plugin uptime | Matches OpenClaw Gateway uptime; no independent failure modes. |\n| NFR-4 | **Correctness**: Date parsing | 100% of valid `YYYY-MM-DD` and `MM-DD` inputs produce correct stored dates; 100% of invalid dates return errors. |\n| NFR-5 | **Security**: Private project isolation | Zero information leakage: private project tasks MUST never appear in another user's list/board output. |\n| NFR-6 | **Testability**: Unit + integration test coverage | >= 80% line coverage on parser and command handler modules. |\n| NFR-7 | **Maintainability**: Schema migration | Forward-only migrations; each migration is idempotent and wrapped in a transaction. |\n| NFR-8 | **Capacity**: Task volume | Support up to 100,000 tasks per DB file without degradation beyond NFR-1. |\n\n---\n\n## 8. Success Metrics\n\n| Metric | Target | Measurement |\n|--------|--------|------------|\n| Command success rate | >= 99% of well-formed commands execute without error | `events` table: count(success) / count(total) |\n| Adoption | >= 5 active users within 2 weeks of deployment | Distinct `actor_user_id` in events table |\n| Task throughput | >= 50 tasks created per week across team | Weekly count of `add` events |\n| Mean response time | < 300ms (p50) | Instrumented timer in command handler |\n| Test pass rate | 100% on CI before merge | pytest exit code |\n\n---\n\n## 9. Data Model Summary\n\nFour core tables plus one metadata table:\n\n- **projects** (id, name, visibility, owner_user_id, created_at, updated_at)\n  - Unique index on `name` where `visibility='shared'`\n  - Unique index on `(owner_user_id, name)` where `visibility='private'`\n- **tasks** (id, title, project_id, section, due, status, created_by, created_at, updated_at, closed_at)\n- **task_assignees** (task_id, assignee_user_id) -- composite PK\n- **events** (id, ts, actor_user_id, action, task_id, payload)\n- **schema_version** (version)\n\n---\n\n## 10. Traceability Matrix\n\n| PRD Section | Requirement IDs |\n|-------------|----------------|\n| 2 (Slack usage) | FR-1.1, FR-1.2 |\n| 3 (Core policies) | FR-4.1--4.3, FR-2.1.4, FR-2.6.4, FR-3.2.3 |\n| 4 (Due parser) | FR-1.3--1.5 |\n| 5 (Command spec) | FR-2.1--2.6, FR-3.1--3.3 |\n| 6 (Data model) | Section 9 |\n| 7 (DB init/migration) | FR-5.1--5.5 |\n| 8 (Permissions) | FR-2.4.3, FR-2.5.3, NFR-5 |\n| 9 (Acceptance) | All AC-* entries |\n"}, "tool_use_id": "toolu_013tcQRoeubDPL1tUNaGBM8e", "_ts": "2026-02-20T11:33:01+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/docs/requirements.md", "content": "# OpenClaw TODO Plugin -- Requirements Document\n\n> **Version**: 1.0\n> **Date**: 2026-02-20\n> **Source PRD**: `openclaw_todo_plugin_prd.md` v1.1\n> **Status**: Draft\n\n---\n\n## 1. Purpose\n\nDefine the functional and non-functional requirements for a Slack-based TODO management plugin (OpenClaw TODO Plugin). The plugin operates via DM with a Slack bot, stores data in SQLite3, and supports private/shared project workflows with zero LLM cost.\n\n---\n\n## 2. Scope\n\n### 2.1 In Scope (MVP / v1)\n\n| Area | Details |\n|------|---------|\n| **Command interface** | `/todo add`, `list`, `board`, `move`, `done`, `drop`, `edit` |\n| **Project management** | `/todo project list`, `set-private`, `set-shared` |\n| **Storage** | Single shared SQLite3 file with WAL mode |\n| **Input channel** | DM with the OpenClaw Slack bot (primary path) |\n| **Due date parsing** | `YYYY-MM-DD` and `MM-DD` with year inference |\n| **Assignee resolution** | Slack `<@U...>` mentions; multi-assignee support |\n| **Visibility model** | Private (owner-only) and shared projects |\n| **Schema migration** | `schema_version` table; auto-create DB and default `Inbox` project on first run |\n| **Audit log** | `events` table recording actor, action, task, and payload |\n\n### 2.2 Out of Scope\n\n- Natural language / LLM-based task creation (Phase 2).\n- Channel or thread-based usage (app mention `@openclaw /todo ...`).\n- Recurring / repeating tasks.\n- Reminders, notifications, or scheduled digests.\n- Multi-workspace federation or cross-workspace sharing.\n- Web UI or dashboard.\n- Task attachments or file uploads.\n- Real-time sync with external project management tools.\n\n---\n\n## 3. Assumptions\n\n| # | Assumption |\n|---|-----------|\n| A1 | The OpenClaw Gateway is already deployed and can route DM messages to plugins. |\n| A2 | Each Slack user has a unique, stable `user_id` (`U...` format). |\n| A3 | A single SQLite3 file is sufficient for the expected concurrency (small-to-medium teams). |\n| A4 | Server timezone is `Asia/Seoul` for date inference. |\n| A5 | The bot has DM read/write permissions via Slack OAuth scopes. |\n| A6 | Plugin packaging and distribution follows existing OpenClaw conventions (npm). |\n\n---\n\n## 4. Constraints\n\n| # | Constraint |\n|---|-----------|\n| C1 | Zero LLM calls -- all parsing is deterministic. |\n| C2 | SQLite3 only; no external database dependency. |\n| C3 | DB file location fixed at `~/.openclaw/workspace/.todo/todo.sqlite3`. |\n| C4 | Section values are a closed enum: `backlog`, `doing`, `waiting`, `done`, `drop`. |\n| C5 | Status values are a closed enum: `open`, `done`, `dropped`. |\n\n---\n\n## 5. Risks\n\n| # | Risk | Likelihood | Impact | Mitigation |\n|---|------|-----------|--------|-----------|\n| R1 | SQLite write contention under high concurrency | Medium | Medium | WAL mode + `busy_timeout=3000`; monitor lock wait times. |\n| R2 | Project name collision confusion (private vs shared same name) | Medium | Low | Private-first resolution + operational guidance to avoid same names. |\n| R3 | Schema migration failure corrupts DB | Low | High | Wrap migrations in transactions; back up DB file before migration. |\n| R4 | Slack API rate limits on bot DM responses | Low | Medium | Queue responses; respect Slack rate limit headers. |\n| R5 | Date parsing edge cases (leap years, locale) | Low | Low | Strict `datetime` validation; reject invalid dates with clear error. |\n\n---\n\n## 6. Functional Requirements\n\n### FR-1: Command Parser\n\n| ID | Requirement |\n|----|------------|\n| FR-1.1 | The plugin MUST recognize messages starting with `/todo` as commands and ignore all other messages. |\n| FR-1.2 | The parser MUST extract tokens: title text, `<@U...>` mentions, `/p <project>`, `/s <section>`, and `due:` value. |\n| FR-1.3 | `due:MM-DD` or `due:M-D` MUST be expanded to `due:YYYY-MM-DD` using the current server year. |\n| FR-1.4 | Invalid dates (e.g., `02-30`) MUST return a user-facing error. |\n| FR-1.5 | `due:-` MUST clear (set to NULL) the due date. |\n\n### FR-2: Task Commands\n\n#### FR-2.1 `/todo add`\n\n| ID | Requirement |\n|----|------------|\n| FR-2.1.1 | Create a task with provided title, assignees, project, section, and due date. |\n| FR-2.1.2 | Defaults: project=`Inbox`, section=`backlog`, assignees=sender, due=NULL. |\n| FR-2.1.3 | If the target project does not exist and is `Inbox`, auto-create it as shared. |\n| FR-2.1.4 | If the target is a private project and any assignee is not the owner, reject with a warning message and do not create the task. |\n| FR-2.1.5 | Return a confirmation message including: task ID, project, section, due, assignees, and title. |\n\n**Acceptance Criteria (add)**:\n- AC-2.1.A: Running `/todo add Buy milk` creates task #N in Inbox/backlog with sender as assignee; response contains `Added #N`.\n- AC-2.1.B: Running `/todo add Deploy <@U2> /p Ops /s doing due:03-15` creates a task in project Ops, section doing, due set to current-year-03-15, assignee U2.\n- AC-2.1.C: Running `/todo add Secret <@U2> /p MyPrivate` where MyPrivate is a private project owned by sender returns a warning and does NOT create the task.\n- AC-2.1.D: Running `/todo add First task` when no DB file exists triggers DB creation, schema application, Inbox project creation, then creates the task.\n\n#### FR-2.2 `/todo list`\n\n| ID | Requirement |\n|----|------------|\n| FR-2.2.1 | List tasks filtered by scope (`mine`/`all`/`<@USER>`), project, section, and status. |\n| FR-2.2.2 | Defaults: scope=`mine`, status=`open`, limit=30. |\n| FR-2.2.3 | Sort order: due (non-null first, ascending), then id descending. |\n| FR-2.2.4 | `all` scope returns shared tasks plus sender's private project tasks; never shows other users' private tasks. |\n\n**Acceptance Criteria (list)**:\n- AC-2.2.A: `/todo list` returns only open tasks where sender is an assignee, limited to 30, sorted by due then id.\n- AC-2.2.B: `/todo list all` includes tasks from shared projects and the sender's private projects, but excludes other users' private project tasks.\n- AC-2.2.C: `/todo list /p Ops /s doing` returns only tasks in project Ops, section doing.\n\n#### FR-2.3 `/todo board`\n\n| ID | Requirement |\n|----|------------|\n| FR-2.3.1 | Display tasks grouped by section in order: BACKLOG, DOING, WAITING, DONE, DROP. |\n| FR-2.3.2 | Defaults: scope=`mine`, status=`open`, limitPerSection=10. |\n| FR-2.3.3 | Each item shows: `#id due assignees title`. |\n\n**Acceptance Criteria (board)**:\n- AC-2.3.A: `/todo board /p Ops` displays tasks grouped under section headers in the correct order.\n- AC-2.3.B: Each section contains at most 10 items by default.\n\n#### FR-2.4 `/todo move`\n\n| ID | Requirement |\n|----|------------|\n| FR-2.4.1 | Move a task to a specified section. |\n| FR-2.4.2 | Validate section against the enum. |\n| FR-2.4.3 | Authorization: private project -- owner only; shared project -- assignee or created_by. |\n\n**Acceptance Criteria (move)**:\n- AC-2.4.A: `/todo move 42 doing` updates task #42 section to doing and returns confirmation.\n- AC-2.4.B: A user who is neither assignee nor creator of a shared task receives an authorization error.\n\n#### FR-2.5 `/todo done` and `/todo drop`\n\n| ID | Requirement |\n|----|------------|\n| FR-2.5.1 | `/todo done <id>`: set section=`done`, status=`done`, record `closed_at`. |\n| FR-2.5.2 | `/todo drop <id>`: set section=`drop`, status=`dropped`, record `closed_at`. |\n| FR-2.5.3 | Authorization rules match FR-2.4.3. |\n\n**Acceptance Criteria (done/drop)**:\n- AC-2.5.A: `/todo done 42` sets task #42 to done status with a non-null `closed_at` timestamp.\n- AC-2.5.B: `/todo drop 42` sets task #42 to dropped status with a non-null `closed_at` timestamp.\n\n#### FR-2.6 `/todo edit`\n\n| ID | Requirement |\n|----|------------|\n| FR-2.6.1 | Update a task's title, assignees, project, section, and/or due date. |\n| FR-2.6.2 | If mentions are provided, assignees are fully replaced (not appended). |\n| FR-2.6.3 | `due:-` clears the due date. |\n| FR-2.6.4 | If editing moves a task into or within a private project and any assignee is not the owner, reject with a warning. |\n| FR-2.6.5 | Title is inferred from text preceding option tokens; if empty, title is unchanged. |\n\n**Acceptance Criteria (edit)**:\n- AC-2.6.A: `/todo edit 42 New title due:04-01` updates both title and due date; response confirms changes.\n- AC-2.6.B: `/todo edit 42 <@U3>` replaces all assignees with U3 only.\n- AC-2.6.C: `/todo edit 42 due:-` sets due to NULL.\n\n### FR-3: Project Commands\n\n#### FR-3.1 `/todo project list`\n\n| ID | Requirement |\n|----|------------|\n| FR-3.1.1 | Return all shared projects and the sender's private projects. |\n| FR-3.1.2 | Never expose other users' private projects. |\n\n#### FR-3.2 `/todo project set-private <name>`\n\n| ID | Requirement |\n|----|------------|\n| FR-3.2.1 | If the sender already owns a private project with `<name>`, return success (idempotent). |\n| FR-3.2.2 | If a shared project `<name>` exists, attempt to convert it to private (owner=sender). |\n| FR-3.2.3 | Before conversion, scan all tasks in the project. If ANY task has an assignee who is not the sender, reject with an error listing up to 10 violating task IDs and assignees. |\n| FR-3.2.4 | If neither exists, create a new private project with owner=sender. |\n\n**Acceptance Criteria (set-private)**:\n- AC-3.2.A: Converting a shared project with only owner-assigned tasks succeeds; project visibility becomes `private`.\n- AC-3.2.B: Converting a shared project where task #12 is assigned to `<@U2>` fails with an error message containing `#12` and `<@U2>`.\n- AC-3.2.C: Running `set-private NewProj` when no project exists creates a private project owned by sender.\n\n#### FR-3.3 `/todo project set-shared <name>`\n\n| ID | Requirement |\n|----|------------|\n| FR-3.3.1 | If a shared project `<name>` exists, no-op. |\n| FR-3.3.2 | If it does not exist, create it. |\n| FR-3.3.3 | If a shared project with `<name>` already exists (global uniqueness conflict), return an error. |\n\n### FR-4: Project Name Resolution\n\n| ID | Requirement |\n|----|------------|\n| FR-4.1 | When `/p <name>` is specified, resolve by: (1) sender's private project with that name, (2) shared project with that name, (3) error or auto-create per context. |\n| FR-4.2 | Shared project names MUST be globally unique. |\n| FR-4.3 | Private project names MUST be unique per owner. |\n\n### FR-5: Database Initialization\n\n| ID | Requirement |\n|----|------------|\n| FR-5.1 | On first command or gateway startup, create the directory `~/.openclaw/workspace/.todo/` if absent. |\n| FR-5.2 | Create `todo.sqlite3` with the full v1 schema if the file does not exist. |\n| FR-5.3 | Create `schema_version` table and set version=1. |\n| FR-5.4 | Auto-create shared project `Inbox` (idempotent). |\n| FR-5.5 | Set `PRAGMA journal_mode=WAL` and `PRAGMA busy_timeout=3000` on every connection. |\n\n**Acceptance Criteria (DB init)**:\n- AC-5.A: Deleting the DB file and running any `/todo` command recreates the DB with all tables and the `Inbox` project.\n- AC-5.B: `schema_version` table contains exactly one row with `version=1`.\n\n### FR-6: Audit Events\n\n| ID | Requirement |\n|----|------------|\n| FR-6.1 | Every state-changing command (add, move, done, drop, edit, set-private, set-shared) MUST insert a row into the `events` table. |\n| FR-6.2 | Each event records: timestamp, actor user ID, action name, task ID (if applicable), and a JSON payload with before/after state. |\n\n---\n\n## 7. Non-Functional Requirements\n\n| ID | Requirement | Metric |\n|----|------------|--------|\n| NFR-1 | **Latency**: Command response time | p95 < 500ms for any single command (excluding Slack network round-trip). |\n| NFR-2 | **Reliability**: No data loss on concurrent writes | Zero data corruption over 1000 concurrent write operations using WAL mode. |\n| NFR-3 | **Availability**: Plugin uptime | Matches OpenClaw Gateway uptime; no independent failure modes. |\n| NFR-4 | **Correctness**: Date parsing | 100% of valid `YYYY-MM-DD` and `MM-DD` inputs produce correct stored dates; 100% of invalid dates return errors. |\n| NFR-5 | **Security**: Private project isolation | Zero information leakage: private project tasks MUST never appear in another user's list/board output. |\n| NFR-6 | **Testability**: Unit + integration test coverage | >= 80% line coverage on parser and command handler modules. |\n| NFR-7 | **Maintainability**: Schema migration | Forward-only migrations; each migration is idempotent and wrapped in a transaction. |\n| NFR-8 | **Capacity**: Task volume | Support up to 100,000 tasks per DB file without degradation beyond NFR-1. |\n\n---\n\n## 8. Success Metrics\n\n| Metric | Target | Measurement |\n|--------|--------|------------|\n| Command success rate | >= 99% of well-formed commands execute without error | `events` table: count(success) / count(total) |\n| Adoption | >= 5 active users within 2 weeks of deployment | Distinct `actor_user_id` in events table |\n| Task throughput | >= 50 tasks created per week across team | Weekly count of `add` events |\n| Mean response time | < 300ms (p50) | Instrumented timer in command handler |\n| Test pass rate | 100% on CI before merge | pytest exit code |\n\n---\n\n## 9. Data Model Summary\n\nFour core tables plus one metadata table:\n\n- **projects** (id, name, visibility, owner_user_id, created_at, updated_at)\n  - Unique index on `name` where `visibility='shared'`\n  - Unique index on `(owner_user_id, name)` where `visibility='private'`\n- **tasks** (id, title, project_id, section, due, status, created_by, created_at, updated_at, closed_at)\n- **task_assignees** (task_id, assignee_user_id) -- composite PK\n- **events** (id, ts, actor_user_id, action, task_id, payload)\n- **schema_version** (version)\n\n---\n\n## 10. Traceability Matrix\n\n| PRD Section | Requirement IDs |\n|-------------|----------------|\n| 2 (Slack usage) | FR-1.1, FR-1.2 |\n| 3 (Core policies) | FR-4.1--4.3, FR-2.1.4, FR-2.6.4, FR-3.2.3 |\n| 4 (Due parser) | FR-1.3--1.5 |\n| 5 (Command spec) | FR-2.1--2.6, FR-3.1--3.3 |\n| 6 (Data model) | Section 9 |\n| 7 (DB init/migration) | FR-5.1--5.5 |\n| 8 (Permissions) | FR-2.4.3, FR-2.5.3, NFR-5 |\n| 9 (Acceptance) | All AC-* entries |\n"}, "tool_response": {"type": "create", "filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/docs/requirements.md", "content": "# OpenClaw TODO Plugin -- Requirements Document\n\n> **Version**: 1.0\n> **Date**: 2026-02-20\n> **Source PRD**: `openclaw_todo_plugin_prd.md` v1.1\n> **Status**: Draft\n\n---\n\n## 1. Purpose\n\nDefine the functional and non-functional requirements for a Slack-based TODO management plugin (OpenClaw TODO Plugin). The plugin operates via DM with a Slack bot, stores data in SQLite3, and supports private/shared project workflows with zero LLM cost.\n\n---\n\n## 2. Scope\n\n### 2.1 In Scope (MVP / v1)\n\n| Area | Details |\n|------|---------|\n| **Command interface** | `/todo add`, `list`, `board`, `move`, `done`, `drop`, `edit` |\n| **Project management** | `/todo project list`, `set-private`, `set-shared` |\n| **Storage** | Single shared SQLite3 file with WAL mode |\n| **Input channel** | DM with the OpenClaw Slack bot (primary path) |\n| **Due date parsing** | `YYYY-MM-DD` and `MM-DD` with year inference |\n| **Assignee resolution** | Slack `<@U...>` mentions; multi-assignee support |\n| **Visibility model** | Private (owner-only) and shared projects |\n| **Schema migration** | `schema_version` table; auto-create DB and default `Inbox` project on first run |\n| **Audit log** | `events` table recording actor, action, task, and payload |\n\n### 2.2 Out of Scope\n\n- Natural language / LLM-based task creation (Phase 2).\n- Channel or thread-based usage (app mention `@openclaw /todo ...`).\n- Recurring / repeating tasks.\n- Reminders, notifications, or scheduled digests.\n- Multi-workspace federation or cross-workspace sharing.\n- Web UI or dashboard.\n- Task attachments or file uploads.\n- Real-time sync with external project management tools.\n\n---\n\n## 3. Assumptions\n\n| # | Assumption |\n|---|-----------|\n| A1 | The OpenClaw Gateway is already deployed and can route DM messages to plugins. |\n| A2 | Each Slack user has a unique, stable `user_id` (`U...` format). |\n| A3 | A single SQLite3 file is sufficient for the expected concurrency (small-to-medium teams). |\n| A4 | Server timezone is `Asia/Seoul` for date inference. |\n| A5 | The bot has DM read/write permissions via Slack OAuth scopes. |\n| A6 | Plugin packaging and distribution follows existing OpenClaw conventions (npm). |\n\n---\n\n## 4. Constraints\n\n| # | Constraint |\n|---|-----------|\n| C1 | Zero LLM calls -- all parsing is deterministic. |\n| C2 | SQLite3 only; no external database dependency. |\n| C3 | DB file location fixed at `~/.openclaw/workspace/.todo/todo.sqlite3`. |\n| C4 | Section values are a closed enum: `backlog`, `doing`, `waiting`, `done`, `drop`. |\n| C5 | Status values are a closed enum: `open`, `done`, `dropped`. |\n\n---\n\n## 5. Risks\n\n| # | Risk | Likelihood | Impact | Mitigation |\n|---|------|-----------|--------|-----------|\n| R1 | SQLite write contention under high concurrency | Medium | Medium | WAL mode + `busy_timeout=3000`; monitor lock wait times. |\n| R2 | Project name collision confusion (private vs shared same name) | Medium | Low | Private-first resolution + operational guidance to avoid same names. |\n| R3 | Schema migration failure corrupts DB | Low | High | Wrap migrations in transactions; back up DB file before migration. |\n| R4 | Slack API rate limits on bot DM responses | Low | Medium | Queue responses; respect Slack rate limit headers. |\n| R5 | Date parsing edge cases (leap years, locale) | Low | Low | Strict `datetime` validation; reject invalid dates with clear error. |\n\n---\n\n## 6. Functional Requirements\n\n### FR-1: Command Parser\n\n| ID | Requirement |\n|----|------------|\n| FR-1.1 | The plugin MUST recognize messages starting with `/todo` as commands and ignore all other messages. |\n| FR-1.2 | The parser MUST extract tokens: title text, `<@U...>` mentions, `/p <project>`, `/s <section>`, and `due:` value. |\n| FR-1.3 | `due:MM-DD` or `due:M-D` MUST be expanded to `due:YYYY-MM-DD` using the current server year. |\n| FR-1.4 | Invalid dates (e.g., `02-30`) MUST return a user-facing error. |\n| FR-1.5 | `due:-` MUST clear (set to NULL) the due date. |\n\n### FR-2: Task Commands\n\n#### FR-2.1 `/todo add`\n\n| ID | Requirement |\n|----|------------|\n| FR-2.1.1 | Create a task with provided title, assignees, project, section, and due date. |\n| FR-2.1.2 | Defaults: project=`Inbox`, section=`backlog`, assignees=sender, due=NULL. |\n| FR-2.1.3 | If the target project does not exist and is `Inbox`, auto-create it as shared. |\n| FR-2.1.4 | If the target is a private project and any assignee is not the owner, reject with a warning message and do not create the task. |\n| FR-2.1.5 | Return a confirmation message including: task ID, project, section, due, assignees, and title. |\n\n**Acceptance Criteria (add)**:\n- AC-2.1.A: Running `/todo add Buy milk` creates task #N in Inbox/backlog with sender as assignee; response contains `Added #N`.\n- AC-2.1.B: Running `/todo add Deploy <@U2> /p Ops /s doing due:03-15` creates a task in project Ops, section doing, due set to current-year-03-15, assignee U2.\n- AC-2.1.C: Running `/todo add Secret <@U2> /p MyPrivate` where MyPrivate is a private project owned by sender returns a warning and does NOT create the task.\n- AC-2.1.D: Running `/todo add First task` when no DB file exists triggers DB creation, schema application, Inbox project creation, then creates the task.\n\n#### FR-2.2 `/todo list`\n\n| ID | Requirement |\n|----|------------|\n| FR-2.2.1 | List tasks filtered by scope (`mine`/`all`/`<@USER>`), project, section, and status. |\n| FR-2.2.2 | Defaults: scope=`mine`, status=`open`, limit=30. |\n| FR-2.2.3 | Sort order: due (non-null first, ascending), then id descending. |\n| FR-2.2.4 | `all` scope returns shared tasks plus sender's private project tasks; never shows other users' private tasks. |\n\n**Acceptance Criteria (list)**:\n- AC-2.2.A: `/todo list` returns only open tasks where sender is an assignee, limited to 30, sorted by due then id.\n- AC-2.2.B: `/todo list all` includes tasks from shared projects and the sender's private projects, but excludes other users' private project tasks.\n- AC-2.2.C: `/todo list /p Ops /s doing` returns only tasks in project Ops, section doing.\n\n#### FR-2.3 `/todo board`\n\n| ID | Requirement |\n|----|------------|\n| FR-2.3.1 | Display tasks grouped by section in order: BACKLOG, DOING, WAITING, DONE, DROP. |\n| FR-2.3.2 | Defaults: scope=`mine`, status=`open`, limitPerSection=10. |\n| FR-2.3.3 | Each item shows: `#id due assignees title`. |\n\n**Acceptance Criteria (board)**:\n- AC-2.3.A: `/todo board /p Ops` displays tasks grouped under section headers in the correct order.\n- AC-2.3.B: Each section contains at most 10 items by default.\n\n#### FR-2.4 `/todo move`\n\n| ID | Requirement |\n|----|------------|\n| FR-2.4.1 | Move a task to a specified section. |\n| FR-2.4.2 | Validate section against the enum. |\n| FR-2.4.3 | Authorization: private project -- owner only; shared project -- assignee or created_by. |\n\n**Acceptance Criteria (move)**:\n- AC-2.4.A: `/todo move 42 doing` updates task #42 section to doing and returns confirmation.\n- AC-2.4.B: A user who is neither assignee nor creator of a shared task receives an authorization error.\n\n#### FR-2.5 `/todo done` and `/todo drop`\n\n| ID | Requirement |\n|----|------------|\n| FR-2.5.1 | `/todo done <id>`: set section=`done`, status=`done`, record `closed_at`. |\n| FR-2.5.2 | `/todo drop <id>`: set section=`drop`, status=`dropped`, record `closed_at`. |\n| FR-2.5.3 | Authorization rules match FR-2.4.3. |\n\n**Acceptance Criteria (done/drop)**:\n- AC-2.5.A: `/todo done 42` sets task #42 to done status with a non-null `closed_at` timestamp.\n- AC-2.5.B: `/todo drop 42` sets task #42 to dropped status with a non-null `closed_at` timestamp.\n\n#### FR-2.6 `/todo edit`\n\n| ID | Requirement |\n|----|------------|\n| FR-2.6.1 | Update a task's title, assignees, project, section, and/or due date. |\n| FR-2.6.2 | If mentions are provided, assignees are fully replaced (not appended). |\n| FR-2.6.3 | `due:-` clears the due date. |\n| FR-2.6.4 | If editing moves a task into or within a private project and any assignee is not the owner, reject with a warning. |\n| FR-2.6.5 | Title is inferred from text preceding option tokens; if empty, title is unchanged. |\n\n**Acceptance Criteria (edit)**:\n- AC-2.6.A: `/todo edit 42 New title due:04-01` updates both title and due date; response confirms changes.\n- AC-2.6.B: `/todo edit 42 <@U3>` replaces all assignees with U3 only.\n- AC-2.6.C: `/todo edit 42 due:-` sets due to NULL.\n\n### FR-3: Project Commands\n\n#### FR-3.1 `/todo project list`\n\n| ID | Requirement |\n|----|------------|\n| FR-3.1.1 | Return all shared projects and the sender's private projects. |\n| FR-3.1.2 | Never expose other users' private projects. |\n\n#### FR-3.2 `/todo project set-private <name>`\n\n| ID | Requirement |\n|----|------------|\n| FR-3.2.1 | If the sender already owns a private project with `<name>`, return success (idempotent). |\n| FR-3.2.2 | If a shared project `<name>` exists, attempt to convert it to private (owner=sender). |\n| FR-3.2.3 | Before conversion, scan all tasks in the project. If ANY task has an assignee who is not the sender, reject with an error listing up to 10 violating task IDs and assignees. |\n| FR-3.2.4 | If neither exists, create a new private project with owner=sender. |\n\n**Acceptance Criteria (set-private)**:\n- AC-3.2.A: Converting a shared project with only owner-assigned tasks succeeds; project visibility becomes `private`.\n- AC-3.2.B: Converting a shared project where task #12 is assigned to `<@U2>` fails with an error message containing `#12` and `<@U2>`.\n- AC-3.2.C: Running `set-private NewProj` when no project exists creates a private project owned by sender.\n\n#### FR-3.3 `/todo project set-shared <name>`\n\n| ID | Requirement |\n|----|------------|\n| FR-3.3.1 | If a shared project `<name>` exists, no-op. |\n| FR-3.3.2 | If it does not exist, create it. |\n| FR-3.3.3 | If a shared project with `<name>` already exists (global uniqueness conflict), return an error. |\n\n### FR-4: Project Name Resolution\n\n| ID | Requirement |\n|----|------------|\n| FR-4.1 | When `/p <name>` is specified, resolve by: (1) sender's private project with that name, (2) shared project with that name, (3) error or auto-create per context. |\n| FR-4.2 | Shared project names MUST be globally unique. |\n| FR-4.3 | Private project names MUST be unique per owner. |\n\n### FR-5: Database Initialization\n\n| ID | Requirement |\n|----|------------|\n| FR-5.1 | On first command or gateway startup, create the directory `~/.openclaw/workspace/.todo/` if absent. |\n| FR-5.2 | Create `todo.sqlite3` with the full v1 schema if the file does not exist. |\n| FR-5.3 | Create `schema_version` table and set version=1. |\n| FR-5.4 | Auto-create shared project `Inbox` (idempotent). |\n| FR-5.5 | Set `PRAGMA journal_mode=WAL` and `PRAGMA busy_timeout=3000` on every connection. |\n\n**Acceptance Criteria (DB init)**:\n- AC-5.A: Deleting the DB file and running any `/todo` command recreates the DB with all tables and the `Inbox` project.\n- AC-5.B: `schema_version` table contains exactly one row with `version=1`.\n\n### FR-6: Audit Events\n\n| ID | Requirement |\n|----|------------|\n| FR-6.1 | Every state-changing command (add, move, done, drop, edit, set-private, set-shared) MUST insert a row into the `events` table. |\n| FR-6.2 | Each event records: timestamp, actor user ID, action name, task ID (if applicable), and a JSON payload with before/after state. |\n\n---\n\n## 7. Non-Functional Requirements\n\n| ID | Requirement | Metric |\n|----|------------|--------|\n| NFR-1 | **Latency**: Command response time | p95 < 500ms for any single command (excluding Slack network round-trip). |\n| NFR-2 | **Reliability**: No data loss on concurrent writes | Zero data corruption over 1000 concurrent write operations using WAL mode. |\n| NFR-3 | **Availability**: Plugin uptime | Matches OpenClaw Gateway uptime; no independent failure modes. |\n| NFR-4 | **Correctness**: Date parsing | 100% of valid `YYYY-MM-DD` and `MM-DD` inputs produce correct stored dates; 100% of invalid dates return errors. |\n| NFR-5 | **Security**: Private project isolation | Zero information leakage: private project tasks MUST never appear in another user's list/board output. |\n| NFR-6 | **Testability**: Unit + integration test coverage | >= 80% line coverage on parser and command handler modules. |\n| NFR-7 | **Maintainability**: Schema migration | Forward-only migrations; each migration is idempotent and wrapped in a transaction. |\n| NFR-8 | **Capacity**: Task volume | Support up to 100,000 tasks per DB file without degradation beyond NFR-1. |\n\n---\n\n## 8. Success Metrics\n\n| Metric | Target | Measurement |\n|--------|--------|------------|\n| Command success rate | >= 99% of well-formed commands execute without error | `events` table: count(success) / count(total) |\n| Adoption | >= 5 active users within 2 weeks of deployment | Distinct `actor_user_id` in events table |\n| Task throughput | >= 50 tasks created per week across team | Weekly count of `add` events |\n| Mean response time | < 300ms (p50) | Instrumented timer in command handler |\n| Test pass rate | 100% on CI before merge | pytest exit code |\n\n---\n\n## 9. Data Model Summary\n\nFour core tables plus one metadata table:\n\n- **projects** (id, name, visibility, owner_user_id, created_at, updated_at)\n  - Unique index on `name` where `visibility='shared'`\n  - Unique index on `(owner_user_id, name)` where `visibility='private'`\n- **tasks** (id, title, project_id, section, due, status, created_by, created_at, updated_at, closed_at)\n- **task_assignees** (task_id, assignee_user_id) -- composite PK\n- **events** (id, ts, actor_user_id, action, task_id, payload)\n- **schema_version** (version)\n\n---\n\n## 10. Traceability Matrix\n\n| PRD Section | Requirement IDs |\n|-------------|----------------|\n| 2 (Slack usage) | FR-1.1, FR-1.2 |\n| 3 (Core policies) | FR-4.1--4.3, FR-2.1.4, FR-2.6.4, FR-3.2.3 |\n| 4 (Due parser) | FR-1.3--1.5 |\n| 5 (Command spec) | FR-2.1--2.6, FR-3.1--3.3 |\n| 6 (Data model) | Section 9 |\n| 7 (DB init/migration) | FR-5.1--5.5 |\n| 8 (Permissions) | FR-2.4.3, FR-2.5.3, NFR-5 |\n| 9 (Acceptance) | All AC-* entries |\n", "structuredPatch": [], "originalFile": null}, "tool_use_id": "toolu_013tcQRoeubDPL1tUNaGBM8e", "_ts": "2026-02-20T11:33:02+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "SubagentStop", "stop_hook_active": false, "agent_id": "a8f503f", "agent_transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4/subagents/agent-a8f503f.jsonl", "agent_type": "requirement-analyst", "_ts": "2026-02-20T11:33:13+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "SubagentStop", "stop_hook_active": false, "agent_id": "a306c9f", "agent_transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4/subagents/agent-a306c9f.jsonl", "agent_type": "", "_ts": "2026-02-20T11:33:18+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/docs/ux_spec.md", "content": "# OpenClaw TODO Plugin -- UX Specification\n\n> Version 1.0 | 2026-02-20\n> Based on PRD v1.1 (DM-based)\n\n---\n\n## Table of Contents\n\n1. [Overview](#1-overview)\n2. [Interaction Model](#2-interaction-model)\n3. [Command Reference and User Flows](#3-command-reference-and-user-flows)\n4. [Response Formatting](#4-response-formatting)\n5. [Error Messages](#5-error-messages)\n6. [Edge Cases](#6-edge-cases)\n7. [Input Parsing Rules](#7-input-parsing-rules)\n\n---\n\n## 1. Overview\n\nThe OpenClaw TODO Plugin is a text-based task management system that lives inside Slack DMs. Users interact with the bot by sending messages that start with `/todo`. The bot parses the command and replies in the same DM thread with structured, plain-text responses.\n\n### Design Principles\n\n- **Zero ambiguity**: Every command produces exactly one response. The user always knows whether the action succeeded or failed.\n- **Minimal typing**: Sensible defaults (project = `Inbox`, section = `backlog`, assignee = sender) mean most commands need only a title.\n- **Scannable output**: Responses use fixed-width IDs, consistent emoji prefixes, and aligned columns so users can scan quickly.\n- **Fail loudly**: Invalid input is rejected with a clear reason and the original request is not applied. No partial writes.\n\n---\n\n## 2. Interaction Model\n\n### 2.1 Entry Point\n\nThe user opens a DM conversation with the OpenClaw Slack bot and types messages beginning with `/todo`.\n\n### 2.2 Message Recognition\n\n| Message pattern | Bot behavior |\n|---|---|\n| Starts with `/todo` | Parsed as a command |\n| Anything else | Ignored silently (no reply) |\n\n### 2.3 Response Timing\n\nThe bot replies in the same DM channel. All responses are ephemeral-style (visible only to the sender) when technically possible; otherwise they appear as normal bot messages in the DM.\n\n### 2.4 No Confirmation Dialogs\n\nv1 has no interactive buttons, modals, or confirmation prompts. Every command is executed (or rejected) immediately upon receipt.\n\n---\n\n## 3. Command Reference and User Flows\n\n### 3.1 `/todo add` -- Create a Task\n\n**Purpose**: Create a new task with optional project, section, assignees, and due date.\n\n**Syntax**:\n```\n/todo add <title> [@user ...] [/p <project>] [/s <section>] [due:<date>]\n```\n\n**Defaults**:\n| Parameter | Default |\n|---|---|\n| project | `Inbox` |\n| section | `backlog` |\n| assignees | sender |\n| due | none |\n\n**Flow**:\n1. User sends `/todo add Buy groceries`\n2. Bot creates task in Inbox/backlog, assigns to sender\n3. Bot replies with confirmation\n\n**Examples**:\n\n```\nInput:  /todo add Buy groceries\nOutput: :white_check_mark: Added #42 (Inbox/backlog) due:- assignees:@phil -- Buy groceries\n```\n\n```\nInput:  /todo add Fix login bug @alice /p Backend /s doing due:2026-03-15\nOutput: :white_check_mark: Added #43 (Backend/doing) due:2026-03-15 assignees:@alice -- Fix login bug\n```\n\n```\nInput:  /todo add Review PR @bob @carol /p Frontend\nOutput: :white_check_mark: Added #44 (Frontend/backlog) due:- assignees:@bob, @carol -- Review PR\n```\n\n**Success response format**:\n```\n:white_check_mark: Added #<id> (<project>/<section>) due:<date|-> assignees:<@user>[, <@user>...] -- <title>\n```\n\n---\n\n### 3.2 `/todo list` -- List Tasks\n\n**Purpose**: Display a filtered, sorted list of tasks.\n\n**Syntax**:\n```\n/todo list [mine|all|@user] [/p <project>] [/s <section>] [open|done|drop] [limit:N]\n```\n\n**Defaults**:\n| Parameter | Default |\n|---|---|\n| scope | `mine` |\n| status filter | `open` |\n| limit | 30 |\n\n**Flow**:\n1. User sends `/todo list`\n2. Bot queries tasks where sender is an assignee, status is open\n3. Bot returns a numbered list sorted by due date (ascending, nulls last), then by ID (descending)\n\n**Example output**:\n```\n:clipboard: TODO List (mine / open) -- 3 tasks\n\n#50  due:2026-02-21  (Backend/doing)    @phil        Deploy hotfix\n#48  due:2026-03-01  (Inbox/backlog)    @phil        Buy groceries\n#45  due:-           (Frontend/waiting) @phil, @bob  Review PR\n\nShowing 3 of 3. Use limit:N to see more.\n```\n\n**Empty state**:\n```\n:clipboard: TODO List (mine / open) -- 0 tasks\n\nNo tasks found.\n```\n\n**Scope behavior**:\n| Scope | What it shows |\n|---|---|\n| `mine` | Tasks where sender is in the assignee list |\n| `all` | All shared tasks + sender's private tasks (never other users' private tasks) |\n| `@user` | Tasks where the mentioned user is an assignee (shared projects only, plus sender's private if sender = mentioned user) |\n\n---\n\n### 3.3 `/todo board` -- Kanban Board View\n\n**Purpose**: Display tasks grouped by section in a kanban-style text layout.\n\n**Syntax**:\n```\n/todo board [mine|all|@user] [/p <project>] [open|done|drop] [limitPerSection:N]\n```\n\n**Defaults**:\n| Parameter | Default |\n|---|---|\n| scope | `mine` |\n| status filter | `open` |\n| limitPerSection | 10 |\n\n**Flow**:\n1. User sends `/todo board /p Backend`\n2. Bot queries matching tasks and groups them by section\n3. Bot returns sections in fixed order: BACKLOG, DOING, WAITING, DONE, DROP\n\n**Example output**:\n```\n:bar_chart: Board (mine / open) /p Backend\n\n-- BACKLOG (2) --\n#50  due:2026-03-10  @phil        Set up CI pipeline\n#47  due:-           @phil        Write migration script\n\n-- DOING (1) --\n#51  due:2026-02-22  @phil        Deploy hotfix\n\n-- WAITING (0) --\n(empty)\n\n-- DONE (0) --\n(empty)\n\n-- DROP (0) --\n(empty)\n```\n\n**Notes**:\n- Sections with zero items still appear with `(empty)` to maintain the full board structure.\n- Each section header shows the count of items.\n- When `limitPerSection` is reached, append `... and N more` below the last item in that section.\n\n---\n\n### 3.4 `/todo move` -- Move a Task to a Different Section\n\n**Purpose**: Change the section (kanban column) of a task.\n\n**Syntax**:\n```\n/todo move <id> <section>\n```\n\n**Valid sections**: `backlog`, `doing`, `waiting`, `done`, `drop`\n\n**Flow**:\n1. User sends `/todo move 50 doing`\n2. Bot validates permission and section name\n3. Bot updates the task and replies\n\n**Example**:\n```\nInput:  /todo move 50 doing\nOutput: :arrow_right: Moved #50 to doing (Backend) -- Deploy hotfix\n```\n\n---\n\n### 3.5 `/todo done` -- Mark a Task as Done\n\n**Purpose**: Shortcut to move a task to the `done` section and set its status to `done`.\n\n**Syntax**:\n```\n/todo done <id>\n```\n\n**Flow**:\n1. User sends `/todo done 50`\n2. Bot sets section=done, status=done, records closed_at\n3. Bot replies with confirmation\n\n**Example**:\n```\nInput:  /todo done 50\nOutput: :white_check_mark: Done #50 (Backend) -- Deploy hotfix\n```\n\n---\n\n### 3.6 `/todo drop` -- Drop a Task\n\n**Purpose**: Mark a task as dropped (cancelled/abandoned).\n\n**Syntax**:\n```\n/todo drop <id>\n```\n\n**Flow**:\n1. User sends `/todo drop 50`\n2. Bot sets section=drop, status=dropped, records closed_at\n3. Bot replies with confirmation\n\n**Example**:\n```\nInput:  /todo drop 50\nOutput: :wastebasket: Dropped #50 (Backend) -- Deploy hotfix\n```\n\n---\n\n### 3.7 `/todo edit` -- Edit a Task\n\n**Purpose**: Modify one or more fields of an existing task.\n\n**Syntax**:\n```\n/todo edit <id> [<new title>] [@user ...] [/p <project>] [/s <section>] [due:<date>|due:-]\n```\n\n**Rules**:\n- If `@user` mentions are present, the assignee list is **fully replaced** (not appended).\n- `due:-` clears the due date (sets it to null).\n- New title text is everything before the first option token (`/p`, `/s`, `due:`, or `@mention`). If empty, the title is unchanged.\n- Fields not specified in the command remain unchanged.\n\n**Flow**:\n1. User sends `/todo edit 50 Deploy hotfix v2 due:2026-03-01`\n2. Bot updates title and due date\n3. Bot replies with the updated state\n\n**Example**:\n```\nInput:  /todo edit 50 Deploy hotfix v2 due:2026-03-01\nOutput: :pencil2: Edited #50 (Backend/doing) due:2026-03-01 assignees:@phil -- Deploy hotfix v2\n```\n\n```\nInput:  /todo edit 50 @alice @bob\nOutput: :pencil2: Edited #50 (Backend/doing) due:2026-03-01 assignees:@alice, @bob -- Deploy hotfix v2\n```\n\n```\nInput:  /todo edit 50 due:-\nOutput: :pencil2: Edited #50 (Backend/doing) due:- assignees:@alice, @bob -- Deploy hotfix v2\n```\n\n**Success response format** (same structure as add):\n```\n:pencil2: Edited #<id> (<project>/<section>) due:<date|-> assignees:<@user>[, ...] -- <title>\n```\n\n---\n\n### 3.8 `/todo project list` -- List Projects\n\n**Purpose**: Show all projects visible to the sender.\n\n**Syntax**:\n```\n/todo project list\n```\n\n**Flow**:\n1. User sends `/todo project list`\n2. Bot returns shared projects and the sender's private projects\n\n**Example output**:\n```\n:file_folder: Projects\n\nShared:\n  - Inbox (12 tasks)\n  - Backend (5 tasks)\n  - Frontend (8 tasks)\n\nPrivate (yours):\n  - Personal (3 tasks)\n  - Side Project (1 task)\n```\n\n**Empty state**:\n```\n:file_folder: Projects\n\nShared:\n  - Inbox (0 tasks)\n\nPrivate (yours):\n  (none)\n```\n\n---\n\n### 3.9 `/todo project set-private <name>` -- Make a Project Private\n\n**Purpose**: Convert a shared project to private or create a new private project.\n\n**Syntax**:\n```\n/todo project set-private <name>\n```\n\n**Flow**:\n\nCase A -- Project does not exist:\n1. Bot creates a new private project owned by the sender.\n2. Reply: `:lock: Created private project \"<name>\".`\n\nCase B -- Sender already has a private project with this name:\n1. Reply: `:lock: Project \"<name>\" is already private.`\n\nCase C -- Shared project exists, conversion attempt:\n1. Bot scans all tasks in the project for non-owner assignees.\n2. If none found: convert to private, reply `:lock: Project \"<name>\" is now private.`\n3. If found: reject with error (see [Section 5.3](#53-set-private-validation-error)).\n\n---\n\n### 3.10 `/todo project set-shared <name>` -- Make a Project Shared\n\n**Purpose**: Convert a private project to shared or create a new shared project.\n\n**Syntax**:\n```\n/todo project set-shared <name>\n```\n\n**Flow**:\n\nCase A -- Shared project with this name already exists:\n1. Reply: `:globe_with_meridians: Project \"<name>\" is already shared.`\n\nCase B -- No shared project with this name:\n1. Bot creates (or converts) the project to shared visibility.\n2. Reply: `:globe_with_meridians: Project \"<name>\" is now shared.`\n\nCase C -- Name conflict with an existing shared project:\n1. Reply: `:x: A shared project named \"<name>\" already exists.`\n\n---\n\n## 4. Response Formatting\n\n### 4.1 General Structure\n\nAll bot responses follow this pattern:\n\n```\n<emoji> <Action verb> <details>\n```\n\n| Action | Emoji | Verb |\n|---|---|---|\n| Add | :white_check_mark: | Added |\n| List | :clipboard: | TODO List |\n| Board | :bar_chart: | Board |\n| Move | :arrow_right: | Moved |\n| Done | :white_check_mark: | Done |\n| Drop | :wastebasket: | Dropped |\n| Edit | :pencil2: | Edited |\n| Project list | :file_folder: | Projects |\n| Set private | :lock: | (varies by case) |\n| Set shared | :globe_with_meridians: | (varies by case) |\n| Error | :x: | (error message) |\n| Warning/reject | :warning: | (warning message) |\n\n### 4.2 Task Line Format\n\nWhenever a single task is displayed inline (in list, board, or as a command result), it uses:\n\n```\n#<id>  due:<YYYY-MM-DD|->  (<project>/<section>)  <assignees>  <title>\n```\n\n- `id`: Left-padded for alignment in lists (e.g., `#42`, `# 7` -- optional, simple left-align is acceptable in v1).\n- `due`: Always shown. `-` when no due date.\n- `assignees`: Comma-separated Slack mentions. Displayed as `@username` in Slack's rendered view.\n- `title`: The full task title, untruncated.\n\n### 4.3 List/Board Headers\n\nLists and boards begin with a header line summarizing the query:\n\n```\n:clipboard: TODO List (<scope> / <status>) -- <count> tasks\n```\n```\n:bar_chart: Board (<scope> / <status>) [/p <project>]\n```\n\n### 4.4 Pagination Footer\n\nWhen the result set exceeds the limit:\n```\nShowing <displayed> of <total>. Use limit:N to see more.\n```\n\nFor board view:\n```\n... and <N> more\n```\n(appears below the last item in a section that hit `limitPerSection`)\n\n### 4.5 Text Encoding\n\n- All responses are plain Slack mrkdwn (Slack's markdown variant).\n- No block kit or attachments in v1.\n- User mentions are rendered as `<@UXXXXXXXX>` which Slack auto-formats.\n\n---\n\n## 5. Error Messages\n\n### 5.1 Input Validation Errors\n\n| Condition | Error message |\n|---|---|\n| Unknown command | `:x: Unknown command. Available: add, list, board, move, done, drop, edit, project` |\n| Missing title on add | `:x: Title is required. Usage: /todo add <title> [options]` |\n| Missing task ID | `:x: Task ID is required. Usage: /todo <command> <id>` |\n| Invalid task ID (not a number) | `:x: Invalid task ID \"<input>\". Must be a number.` |\n| Task not found | `:x: Task #<id> not found.` |\n| Invalid section name | `:x: Invalid section \"<input>\". Must be one of: backlog, doing, waiting, done, drop` |\n| Invalid date format | `:x: Invalid date \"<input>\". Use YYYY-MM-DD or MM-DD.` |\n| Invalid date value (e.g. 02-30) | `:x: Invalid date \"02-30\". This date does not exist.` |\n| Empty project name | `:x: Project name is required after /p.` |\n\n### 5.2 Permission Errors\n\n| Condition | Error message |\n|---|---|\n| Accessing another user's private project | `:x: Project \"<name>\" not found.` (deliberately vague to avoid leaking existence) |\n| Editing a task without permission | `:x: You don't have permission to modify task #<id>.` |\n\n### 5.3 Set-Private Validation Error\n\nWhen `/todo project set-private` fails due to non-owner assignees:\n\n```\n:x: Cannot set project \"<name>\" to private: found tasks assigned to non-owner users.\ne.g. #12 assignees:@alice, #18 assignees:@carol, #21 assignees:@bob\nPlease reassign or remove these assignees first.\n```\n\n- Show up to 10 violating tasks.\n- If more than 10, append: `... and <N> more tasks with external assignees.`\n\n### 5.4 Private Project Assignee Rejection\n\nWhen trying to assign a non-owner user to a task in a private project (on add or edit):\n\n```\n:warning: Private project \"<name>\" is owner-only. Cannot assign <@user> (not the owner).\nRequest was not applied.\n```\n\n### 5.5 Project Name Conflicts\n\n| Condition | Error message |\n|---|---|\n| Creating/renaming to an existing shared name | `:x: A shared project named \"<name>\" already exists.` |\n| Private name conflict for same owner | `:x: You already have a private project named \"<name>\".` |\n\n---\n\n## 6. Edge Cases\n\n### 6.1 Empty Inputs\n\n| Scenario | Behavior |\n|---|---|\n| `/todo` (no subcommand) | Reply with help text listing available commands |\n| `/todo add` (no title) | Error: title required |\n| `/todo edit 50` (no changes) | Reply: `:information_source: No changes specified for #50.` |\n| `/todo list /p NonExistent` | Error: project not found |\n\n### 6.2 Duplicate Operations\n\n| Scenario | Behavior |\n|---|---|\n| `/todo done 50` when already done | Reply: `:information_source: Task #50 is already done.` |\n| `/todo drop 50` when already dropped | Reply: `:information_source: Task #50 is already dropped.` |\n| `/todo move 50 doing` when already in doing | Reply: `:information_source: Task #50 is already in doing.` |\n\n### 6.3 Project Auto-Creation\n\n- When `/todo add ... /p NewProject` references a project that does not exist, the bot creates it as a **shared** project automatically and includes a note in the response:\n  ```\n  :white_check_mark: Added #55 (NewProject/backlog) due:- assignees:@phil -- Task title\n  :information_source: Project \"NewProject\" was created (shared).\n  ```\n- Exception: `Inbox` is always auto-created as shared if it does not exist.\n\n### 6.4 Case Sensitivity\n\n- **Section names**: Case-insensitive input, stored lowercase. `DOING`, `Doing`, `doing` all resolve to `doing`.\n- **Project names**: Case-sensitive. `Backend` and `backend` are different projects.\n- **Commands**: Case-insensitive. `/todo ADD`, `/TODO add`, `/todo Add` all work.\n\n### 6.5 Whitespace and Formatting\n\n- Leading/trailing whitespace in titles is trimmed.\n- Multiple spaces between words in a title are collapsed to a single space.\n- Empty title after trimming triggers the \"title required\" error.\n\n### 6.6 Special Characters in Titles\n\n- Titles may contain any UTF-8 characters except newlines.\n- Slack mrkdwn special characters (`*`, `_`, `~`, `` ` ``) in titles are escaped in the response to prevent formatting artifacts.\n\n### 6.7 Due Date Edge Cases\n\n| Input | Resolved date (assuming current year 2026) |\n|---|---|\n| `due:2026-03-15` | `2026-03-15` |\n| `due:03-15` | `2026-03-15` |\n| `due:3-5` | `2026-03-05` |\n| `due:02-29` | Error (2026 is not a leap year) |\n| `due:00-01` | Error (invalid month) |\n| `due:12-32` | Error (invalid day) |\n| `due:-` | Clears due date (null) |\n| `due:yesterday` | Error (invalid format) |\n\n---\n\n## 7. Input Parsing Rules\n\n### 7.1 Token Order\n\nThe parser processes the message left to right. Recognized option tokens are:\n\n| Token | Pattern | Notes |\n|---|---|---|\n| `/p` | `/p <word>` | Next whitespace-delimited word is the project name |\n| `/s` | `/s <word>` | Next word is the section name |\n| `due:` | `due:<value>` | No space between `due:` and the value |\n| `@mention` | `<@UXXXXXXXX>` | Slack user mention (may appear multiple times) |\n| `limit:` | `limit:<N>` | Positive integer |\n| `limitPerSection:` | `limitPerSection:<N>` | Positive integer |\n\n### 7.2 Title Extraction (for add/edit)\n\nEverything that is **not** a recognized option token or mention is treated as the title. The title words are concatenated in their original order.\n\nExample parse:\n```\n/todo add Fix the login bug @alice /p Backend due:03-15\n\nParsed:\n  command   = add\n  title     = \"Fix the login bug\"\n  assignees = [@alice]\n  project   = \"Backend\"\n  due       = \"2026-03-15\"\n  section   = (default: backlog)\n```\n\n### 7.3 Mention Handling\n\n- Slack internally sends mentions as `<@U04ABCD1234>`.\n- The bot resolves these to display names in responses when possible.\n- If a mentioned user cannot be resolved, the raw `<@U...>` format is preserved.\n\n### 7.4 Scope Keywords (for list/board)\n\nThe first non-option argument after the subcommand determines scope:\n\n| Keyword | Meaning |\n|---|---|\n| `mine` (or omitted) | Tasks assigned to sender |\n| `all` | Shared tasks + sender's private tasks |\n| `@user` | Tasks assigned to the mentioned user |\n\n### 7.5 Status Keywords (for list/board)\n\n| Keyword | Meaning |\n|---|---|\n| `open` (or omitted) | Tasks with status = open |\n| `done` | Tasks with status = done |\n| `drop` | Tasks with status = dropped |\n\n---\n\n## Appendix: Help Text\n\nWhen the user sends `/todo` with no subcommand (or `/todo help`), the bot replies:\n\n```\n:book: OpenClaw TODO -- Commands\n\n/todo add <title> [@user] [/p project] [/s section] [due:date]\n    Create a new task.\n\n/todo list [mine|all|@user] [/p project] [/s section] [open|done|drop] [limit:N]\n    List tasks.\n\n/todo board [mine|all|@user] [/p project] [open|done|drop] [limitPerSection:N]\n    Show kanban board view.\n\n/todo move <id> <section>\n    Move a task to a section (backlog, doing, waiting, done, drop).\n\n/todo done <id>\n    Mark a task as done.\n\n/todo drop <id>\n    Drop (cancel) a task.\n\n/todo edit <id> [title] [@user] [/p project] [/s section] [due:date|due:-]\n    Edit a task. Mentions replace all assignees. due:- clears the date.\n\n/todo project list\n    Show all visible projects.\n\n/todo project set-private <name>\n    Make a project private (owner-only).\n\n/todo project set-shared <name>\n    Make a project shared.\n```\n"}, "tool_use_id": "toolu_01JnW9Ux66hZDCcpcZz79c2o", "_ts": "2026-02-20T11:33:23+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/docs/ux_spec.md", "content": "# OpenClaw TODO Plugin -- UX Specification\n\n> Version 1.0 | 2026-02-20\n> Based on PRD v1.1 (DM-based)\n\n---\n\n## Table of Contents\n\n1. [Overview](#1-overview)\n2. [Interaction Model](#2-interaction-model)\n3. [Command Reference and User Flows](#3-command-reference-and-user-flows)\n4. [Response Formatting](#4-response-formatting)\n5. [Error Messages](#5-error-messages)\n6. [Edge Cases](#6-edge-cases)\n7. [Input Parsing Rules](#7-input-parsing-rules)\n\n---\n\n## 1. Overview\n\nThe OpenClaw TODO Plugin is a text-based task management system that lives inside Slack DMs. Users interact with the bot by sending messages that start with `/todo`. The bot parses the command and replies in the same DM thread with structured, plain-text responses.\n\n### Design Principles\n\n- **Zero ambiguity**: Every command produces exactly one response. The user always knows whether the action succeeded or failed.\n- **Minimal typing**: Sensible defaults (project = `Inbox`, section = `backlog`, assignee = sender) mean most commands need only a title.\n- **Scannable output**: Responses use fixed-width IDs, consistent emoji prefixes, and aligned columns so users can scan quickly.\n- **Fail loudly**: Invalid input is rejected with a clear reason and the original request is not applied. No partial writes.\n\n---\n\n## 2. Interaction Model\n\n### 2.1 Entry Point\n\nThe user opens a DM conversation with the OpenClaw Slack bot and types messages beginning with `/todo`.\n\n### 2.2 Message Recognition\n\n| Message pattern | Bot behavior |\n|---|---|\n| Starts with `/todo` | Parsed as a command |\n| Anything else | Ignored silently (no reply) |\n\n### 2.3 Response Timing\n\nThe bot replies in the same DM channel. All responses are ephemeral-style (visible only to the sender) when technically possible; otherwise they appear as normal bot messages in the DM.\n\n### 2.4 No Confirmation Dialogs\n\nv1 has no interactive buttons, modals, or confirmation prompts. Every command is executed (or rejected) immediately upon receipt.\n\n---\n\n## 3. Command Reference and User Flows\n\n### 3.1 `/todo add` -- Create a Task\n\n**Purpose**: Create a new task with optional project, section, assignees, and due date.\n\n**Syntax**:\n```\n/todo add <title> [@user ...] [/p <project>] [/s <section>] [due:<date>]\n```\n\n**Defaults**:\n| Parameter | Default |\n|---|---|\n| project | `Inbox` |\n| section | `backlog` |\n| assignees | sender |\n| due | none |\n\n**Flow**:\n1. User sends `/todo add Buy groceries`\n2. Bot creates task in Inbox/backlog, assigns to sender\n3. Bot replies with confirmation\n\n**Examples**:\n\n```\nInput:  /todo add Buy groceries\nOutput: :white_check_mark: Added #42 (Inbox/backlog) due:- assignees:@phil -- Buy groceries\n```\n\n```\nInput:  /todo add Fix login bug @alice /p Backend /s doing due:2026-03-15\nOutput: :white_check_mark: Added #43 (Backend/doing) due:2026-03-15 assignees:@alice -- Fix login bug\n```\n\n```\nInput:  /todo add Review PR @bob @carol /p Frontend\nOutput: :white_check_mark: Added #44 (Frontend/backlog) due:- assignees:@bob, @carol -- Review PR\n```\n\n**Success response format**:\n```\n:white_check_mark: Added #<id> (<project>/<section>) due:<date|-> assignees:<@user>[, <@user>...] -- <title>\n```\n\n---\n\n### 3.2 `/todo list` -- List Tasks\n\n**Purpose**: Display a filtered, sorted list of tasks.\n\n**Syntax**:\n```\n/todo list [mine|all|@user] [/p <project>] [/s <section>] [open|done|drop] [limit:N]\n```\n\n**Defaults**:\n| Parameter | Default |\n|---|---|\n| scope | `mine` |\n| status filter | `open` |\n| limit | 30 |\n\n**Flow**:\n1. User sends `/todo list`\n2. Bot queries tasks where sender is an assignee, status is open\n3. Bot returns a numbered list sorted by due date (ascending, nulls last), then by ID (descending)\n\n**Example output**:\n```\n:clipboard: TODO List (mine / open) -- 3 tasks\n\n#50  due:2026-02-21  (Backend/doing)    @phil        Deploy hotfix\n#48  due:2026-03-01  (Inbox/backlog)    @phil        Buy groceries\n#45  due:-           (Frontend/waiting) @phil, @bob  Review PR\n\nShowing 3 of 3. Use limit:N to see more.\n```\n\n**Empty state**:\n```\n:clipboard: TODO List (mine / open) -- 0 tasks\n\nNo tasks found.\n```\n\n**Scope behavior**:\n| Scope | What it shows |\n|---|---|\n| `mine` | Tasks where sender is in the assignee list |\n| `all` | All shared tasks + sender's private tasks (never other users' private tasks) |\n| `@user` | Tasks where the mentioned user is an assignee (shared projects only, plus sender's private if sender = mentioned user) |\n\n---\n\n### 3.3 `/todo board` -- Kanban Board View\n\n**Purpose**: Display tasks grouped by section in a kanban-style text layout.\n\n**Syntax**:\n```\n/todo board [mine|all|@user] [/p <project>] [open|done|drop] [limitPerSection:N]\n```\n\n**Defaults**:\n| Parameter | Default |\n|---|---|\n| scope | `mine` |\n| status filter | `open` |\n| limitPerSection | 10 |\n\n**Flow**:\n1. User sends `/todo board /p Backend`\n2. Bot queries matching tasks and groups them by section\n3. Bot returns sections in fixed order: BACKLOG, DOING, WAITING, DONE, DROP\n\n**Example output**:\n```\n:bar_chart: Board (mine / open) /p Backend\n\n-- BACKLOG (2) --\n#50  due:2026-03-10  @phil        Set up CI pipeline\n#47  due:-           @phil        Write migration script\n\n-- DOING (1) --\n#51  due:2026-02-22  @phil        Deploy hotfix\n\n-- WAITING (0) --\n(empty)\n\n-- DONE (0) --\n(empty)\n\n-- DROP (0) --\n(empty)\n```\n\n**Notes**:\n- Sections with zero items still appear with `(empty)` to maintain the full board structure.\n- Each section header shows the count of items.\n- When `limitPerSection` is reached, append `... and N more` below the last item in that section.\n\n---\n\n### 3.4 `/todo move` -- Move a Task to a Different Section\n\n**Purpose**: Change the section (kanban column) of a task.\n\n**Syntax**:\n```\n/todo move <id> <section>\n```\n\n**Valid sections**: `backlog`, `doing`, `waiting`, `done`, `drop`\n\n**Flow**:\n1. User sends `/todo move 50 doing`\n2. Bot validates permission and section name\n3. Bot updates the task and replies\n\n**Example**:\n```\nInput:  /todo move 50 doing\nOutput: :arrow_right: Moved #50 to doing (Backend) -- Deploy hotfix\n```\n\n---\n\n### 3.5 `/todo done` -- Mark a Task as Done\n\n**Purpose**: Shortcut to move a task to the `done` section and set its status to `done`.\n\n**Syntax**:\n```\n/todo done <id>\n```\n\n**Flow**:\n1. User sends `/todo done 50`\n2. Bot sets section=done, status=done, records closed_at\n3. Bot replies with confirmation\n\n**Example**:\n```\nInput:  /todo done 50\nOutput: :white_check_mark: Done #50 (Backend) -- Deploy hotfix\n```\n\n---\n\n### 3.6 `/todo drop` -- Drop a Task\n\n**Purpose**: Mark a task as dropped (cancelled/abandoned).\n\n**Syntax**:\n```\n/todo drop <id>\n```\n\n**Flow**:\n1. User sends `/todo drop 50`\n2. Bot sets section=drop, status=dropped, records closed_at\n3. Bot replies with confirmation\n\n**Example**:\n```\nInput:  /todo drop 50\nOutput: :wastebasket: Dropped #50 (Backend) -- Deploy hotfix\n```\n\n---\n\n### 3.7 `/todo edit` -- Edit a Task\n\n**Purpose**: Modify one or more fields of an existing task.\n\n**Syntax**:\n```\n/todo edit <id> [<new title>] [@user ...] [/p <project>] [/s <section>] [due:<date>|due:-]\n```\n\n**Rules**:\n- If `@user` mentions are present, the assignee list is **fully replaced** (not appended).\n- `due:-` clears the due date (sets it to null).\n- New title text is everything before the first option token (`/p`, `/s`, `due:`, or `@mention`). If empty, the title is unchanged.\n- Fields not specified in the command remain unchanged.\n\n**Flow**:\n1. User sends `/todo edit 50 Deploy hotfix v2 due:2026-03-01`\n2. Bot updates title and due date\n3. Bot replies with the updated state\n\n**Example**:\n```\nInput:  /todo edit 50 Deploy hotfix v2 due:2026-03-01\nOutput: :pencil2: Edited #50 (Backend/doing) due:2026-03-01 assignees:@phil -- Deploy hotfix v2\n```\n\n```\nInput:  /todo edit 50 @alice @bob\nOutput: :pencil2: Edited #50 (Backend/doing) due:2026-03-01 assignees:@alice, @bob -- Deploy hotfix v2\n```\n\n```\nInput:  /todo edit 50 due:-\nOutput: :pencil2: Edited #50 (Backend/doing) due:- assignees:@alice, @bob -- Deploy hotfix v2\n```\n\n**Success response format** (same structure as add):\n```\n:pencil2: Edited #<id> (<project>/<section>) due:<date|-> assignees:<@user>[, ...] -- <title>\n```\n\n---\n\n### 3.8 `/todo project list` -- List Projects\n\n**Purpose**: Show all projects visible to the sender.\n\n**Syntax**:\n```\n/todo project list\n```\n\n**Flow**:\n1. User sends `/todo project list`\n2. Bot returns shared projects and the sender's private projects\n\n**Example output**:\n```\n:file_folder: Projects\n\nShared:\n  - Inbox (12 tasks)\n  - Backend (5 tasks)\n  - Frontend (8 tasks)\n\nPrivate (yours):\n  - Personal (3 tasks)\n  - Side Project (1 task)\n```\n\n**Empty state**:\n```\n:file_folder: Projects\n\nShared:\n  - Inbox (0 tasks)\n\nPrivate (yours):\n  (none)\n```\n\n---\n\n### 3.9 `/todo project set-private <name>` -- Make a Project Private\n\n**Purpose**: Convert a shared project to private or create a new private project.\n\n**Syntax**:\n```\n/todo project set-private <name>\n```\n\n**Flow**:\n\nCase A -- Project does not exist:\n1. Bot creates a new private project owned by the sender.\n2. Reply: `:lock: Created private project \"<name>\".`\n\nCase B -- Sender already has a private project with this name:\n1. Reply: `:lock: Project \"<name>\" is already private.`\n\nCase C -- Shared project exists, conversion attempt:\n1. Bot scans all tasks in the project for non-owner assignees.\n2. If none found: convert to private, reply `:lock: Project \"<name>\" is now private.`\n3. If found: reject with error (see [Section 5.3](#53-set-private-validation-error)).\n\n---\n\n### 3.10 `/todo project set-shared <name>` -- Make a Project Shared\n\n**Purpose**: Convert a private project to shared or create a new shared project.\n\n**Syntax**:\n```\n/todo project set-shared <name>\n```\n\n**Flow**:\n\nCase A -- Shared project with this name already exists:\n1. Reply: `:globe_with_meridians: Project \"<name>\" is already shared.`\n\nCase B -- No shared project with this name:\n1. Bot creates (or converts) the project to shared visibility.\n2. Reply: `:globe_with_meridians: Project \"<name>\" is now shared.`\n\nCase C -- Name conflict with an existing shared project:\n1. Reply: `:x: A shared project named \"<name>\" already exists.`\n\n---\n\n## 4. Response Formatting\n\n### 4.1 General Structure\n\nAll bot responses follow this pattern:\n\n```\n<emoji> <Action verb> <details>\n```\n\n| Action | Emoji | Verb |\n|---|---|---|\n| Add | :white_check_mark: | Added |\n| List | :clipboard: | TODO List |\n| Board | :bar_chart: | Board |\n| Move | :arrow_right: | Moved |\n| Done | :white_check_mark: | Done |\n| Drop | :wastebasket: | Dropped |\n| Edit | :pencil2: | Edited |\n| Project list | :file_folder: | Projects |\n| Set private | :lock: | (varies by case) |\n| Set shared | :globe_with_meridians: | (varies by case) |\n| Error | :x: | (error message) |\n| Warning/reject | :warning: | (warning message) |\n\n### 4.2 Task Line Format\n\nWhenever a single task is displayed inline (in list, board, or as a command result), it uses:\n\n```\n#<id>  due:<YYYY-MM-DD|->  (<project>/<section>)  <assignees>  <title>\n```\n\n- `id`: Left-padded for alignment in lists (e.g., `#42`, `# 7` -- optional, simple left-align is acceptable in v1).\n- `due`: Always shown. `-` when no due date.\n- `assignees`: Comma-separated Slack mentions. Displayed as `@username` in Slack's rendered view.\n- `title`: The full task title, untruncated.\n\n### 4.3 List/Board Headers\n\nLists and boards begin with a header line summarizing the query:\n\n```\n:clipboard: TODO List (<scope> / <status>) -- <count> tasks\n```\n```\n:bar_chart: Board (<scope> / <status>) [/p <project>]\n```\n\n### 4.4 Pagination Footer\n\nWhen the result set exceeds the limit:\n```\nShowing <displayed> of <total>. Use limit:N to see more.\n```\n\nFor board view:\n```\n... and <N> more\n```\n(appears below the last item in a section that hit `limitPerSection`)\n\n### 4.5 Text Encoding\n\n- All responses are plain Slack mrkdwn (Slack's markdown variant).\n- No block kit or attachments in v1.\n- User mentions are rendered as `<@UXXXXXXXX>` which Slack auto-formats.\n\n---\n\n## 5. Error Messages\n\n### 5.1 Input Validation Errors\n\n| Condition | Error message |\n|---|---|\n| Unknown command | `:x: Unknown command. Available: add, list, board, move, done, drop, edit, project` |\n| Missing title on add | `:x: Title is required. Usage: /todo add <title> [options]` |\n| Missing task ID | `:x: Task ID is required. Usage: /todo <command> <id>` |\n| Invalid task ID (not a number) | `:x: Invalid task ID \"<input>\". Must be a number.` |\n| Task not found | `:x: Task #<id> not found.` |\n| Invalid section name | `:x: Invalid section \"<input>\". Must be one of: backlog, doing, waiting, done, drop` |\n| Invalid date format | `:x: Invalid date \"<input>\". Use YYYY-MM-DD or MM-DD.` |\n| Invalid date value (e.g. 02-30) | `:x: Invalid date \"02-30\". This date does not exist.` |\n| Empty project name | `:x: Project name is required after /p.` |\n\n### 5.2 Permission Errors\n\n| Condition | Error message |\n|---|---|\n| Accessing another user's private project | `:x: Project \"<name>\" not found.` (deliberately vague to avoid leaking existence) |\n| Editing a task without permission | `:x: You don't have permission to modify task #<id>.` |\n\n### 5.3 Set-Private Validation Error\n\nWhen `/todo project set-private` fails due to non-owner assignees:\n\n```\n:x: Cannot set project \"<name>\" to private: found tasks assigned to non-owner users.\ne.g. #12 assignees:@alice, #18 assignees:@carol, #21 assignees:@bob\nPlease reassign or remove these assignees first.\n```\n\n- Show up to 10 violating tasks.\n- If more than 10, append: `... and <N> more tasks with external assignees.`\n\n### 5.4 Private Project Assignee Rejection\n\nWhen trying to assign a non-owner user to a task in a private project (on add or edit):\n\n```\n:warning: Private project \"<name>\" is owner-only. Cannot assign <@user> (not the owner).\nRequest was not applied.\n```\n\n### 5.5 Project Name Conflicts\n\n| Condition | Error message |\n|---|---|\n| Creating/renaming to an existing shared name | `:x: A shared project named \"<name>\" already exists.` |\n| Private name conflict for same owner | `:x: You already have a private project named \"<name>\".` |\n\n---\n\n## 6. Edge Cases\n\n### 6.1 Empty Inputs\n\n| Scenario | Behavior |\n|---|---|\n| `/todo` (no subcommand) | Reply with help text listing available commands |\n| `/todo add` (no title) | Error: title required |\n| `/todo edit 50` (no changes) | Reply: `:information_source: No changes specified for #50.` |\n| `/todo list /p NonExistent` | Error: project not found |\n\n### 6.2 Duplicate Operations\n\n| Scenario | Behavior |\n|---|---|\n| `/todo done 50` when already done | Reply: `:information_source: Task #50 is already done.` |\n| `/todo drop 50` when already dropped | Reply: `:information_source: Task #50 is already dropped.` |\n| `/todo move 50 doing` when already in doing | Reply: `:information_source: Task #50 is already in doing.` |\n\n### 6.3 Project Auto-Creation\n\n- When `/todo add ... /p NewProject` references a project that does not exist, the bot creates it as a **shared** project automatically and includes a note in the response:\n  ```\n  :white_check_mark: Added #55 (NewProject/backlog) due:- assignees:@phil -- Task title\n  :information_source: Project \"NewProject\" was created (shared).\n  ```\n- Exception: `Inbox` is always auto-created as shared if it does not exist.\n\n### 6.4 Case Sensitivity\n\n- **Section names**: Case-insensitive input, stored lowercase. `DOING`, `Doing`, `doing` all resolve to `doing`.\n- **Project names**: Case-sensitive. `Backend` and `backend` are different projects.\n- **Commands**: Case-insensitive. `/todo ADD`, `/TODO add`, `/todo Add` all work.\n\n### 6.5 Whitespace and Formatting\n\n- Leading/trailing whitespace in titles is trimmed.\n- Multiple spaces between words in a title are collapsed to a single space.\n- Empty title after trimming triggers the \"title required\" error.\n\n### 6.6 Special Characters in Titles\n\n- Titles may contain any UTF-8 characters except newlines.\n- Slack mrkdwn special characters (`*`, `_`, `~`, `` ` ``) in titles are escaped in the response to prevent formatting artifacts.\n\n### 6.7 Due Date Edge Cases\n\n| Input | Resolved date (assuming current year 2026) |\n|---|---|\n| `due:2026-03-15` | `2026-03-15` |\n| `due:03-15` | `2026-03-15` |\n| `due:3-5` | `2026-03-05` |\n| `due:02-29` | Error (2026 is not a leap year) |\n| `due:00-01` | Error (invalid month) |\n| `due:12-32` | Error (invalid day) |\n| `due:-` | Clears due date (null) |\n| `due:yesterday` | Error (invalid format) |\n\n---\n\n## 7. Input Parsing Rules\n\n### 7.1 Token Order\n\nThe parser processes the message left to right. Recognized option tokens are:\n\n| Token | Pattern | Notes |\n|---|---|---|\n| `/p` | `/p <word>` | Next whitespace-delimited word is the project name |\n| `/s` | `/s <word>` | Next word is the section name |\n| `due:` | `due:<value>` | No space between `due:` and the value |\n| `@mention` | `<@UXXXXXXXX>` | Slack user mention (may appear multiple times) |\n| `limit:` | `limit:<N>` | Positive integer |\n| `limitPerSection:` | `limitPerSection:<N>` | Positive integer |\n\n### 7.2 Title Extraction (for add/edit)\n\nEverything that is **not** a recognized option token or mention is treated as the title. The title words are concatenated in their original order.\n\nExample parse:\n```\n/todo add Fix the login bug @alice /p Backend due:03-15\n\nParsed:\n  command   = add\n  title     = \"Fix the login bug\"\n  assignees = [@alice]\n  project   = \"Backend\"\n  due       = \"2026-03-15\"\n  section   = (default: backlog)\n```\n\n### 7.3 Mention Handling\n\n- Slack internally sends mentions as `<@U04ABCD1234>`.\n- The bot resolves these to display names in responses when possible.\n- If a mentioned user cannot be resolved, the raw `<@U...>` format is preserved.\n\n### 7.4 Scope Keywords (for list/board)\n\nThe first non-option argument after the subcommand determines scope:\n\n| Keyword | Meaning |\n|---|---|\n| `mine` (or omitted) | Tasks assigned to sender |\n| `all` | Shared tasks + sender's private tasks |\n| `@user` | Tasks assigned to the mentioned user |\n\n### 7.5 Status Keywords (for list/board)\n\n| Keyword | Meaning |\n|---|---|\n| `open` (or omitted) | Tasks with status = open |\n| `done` | Tasks with status = done |\n| `drop` | Tasks with status = dropped |\n\n---\n\n## Appendix: Help Text\n\nWhen the user sends `/todo` with no subcommand (or `/todo help`), the bot replies:\n\n```\n:book: OpenClaw TODO -- Commands\n\n/todo add <title> [@user] [/p project] [/s section] [due:date]\n    Create a new task.\n\n/todo list [mine|all|@user] [/p project] [/s section] [open|done|drop] [limit:N]\n    List tasks.\n\n/todo board [mine|all|@user] [/p project] [open|done|drop] [limitPerSection:N]\n    Show kanban board view.\n\n/todo move <id> <section>\n    Move a task to a section (backlog, doing, waiting, done, drop).\n\n/todo done <id>\n    Mark a task as done.\n\n/todo drop <id>\n    Drop (cancel) a task.\n\n/todo edit <id> [title] [@user] [/p project] [/s section] [due:date|due:-]\n    Edit a task. Mentions replace all assignees. due:- clears the date.\n\n/todo project list\n    Show all visible projects.\n\n/todo project set-private <name>\n    Make a project private (owner-only).\n\n/todo project set-shared <name>\n    Make a project shared.\n```\n"}, "tool_response": {"type": "create", "filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/docs/ux_spec.md", "content": "# OpenClaw TODO Plugin -- UX Specification\n\n> Version 1.0 | 2026-02-20\n> Based on PRD v1.1 (DM-based)\n\n---\n\n## Table of Contents\n\n1. [Overview](#1-overview)\n2. [Interaction Model](#2-interaction-model)\n3. [Command Reference and User Flows](#3-command-reference-and-user-flows)\n4. [Response Formatting](#4-response-formatting)\n5. [Error Messages](#5-error-messages)\n6. [Edge Cases](#6-edge-cases)\n7. [Input Parsing Rules](#7-input-parsing-rules)\n\n---\n\n## 1. Overview\n\nThe OpenClaw TODO Plugin is a text-based task management system that lives inside Slack DMs. Users interact with the bot by sending messages that start with `/todo`. The bot parses the command and replies in the same DM thread with structured, plain-text responses.\n\n### Design Principles\n\n- **Zero ambiguity**: Every command produces exactly one response. The user always knows whether the action succeeded or failed.\n- **Minimal typing**: Sensible defaults (project = `Inbox`, section = `backlog`, assignee = sender) mean most commands need only a title.\n- **Scannable output**: Responses use fixed-width IDs, consistent emoji prefixes, and aligned columns so users can scan quickly.\n- **Fail loudly**: Invalid input is rejected with a clear reason and the original request is not applied. No partial writes.\n\n---\n\n## 2. Interaction Model\n\n### 2.1 Entry Point\n\nThe user opens a DM conversation with the OpenClaw Slack bot and types messages beginning with `/todo`.\n\n### 2.2 Message Recognition\n\n| Message pattern | Bot behavior |\n|---|---|\n| Starts with `/todo` | Parsed as a command |\n| Anything else | Ignored silently (no reply) |\n\n### 2.3 Response Timing\n\nThe bot replies in the same DM channel. All responses are ephemeral-style (visible only to the sender) when technically possible; otherwise they appear as normal bot messages in the DM.\n\n### 2.4 No Confirmation Dialogs\n\nv1 has no interactive buttons, modals, or confirmation prompts. Every command is executed (or rejected) immediately upon receipt.\n\n---\n\n## 3. Command Reference and User Flows\n\n### 3.1 `/todo add` -- Create a Task\n\n**Purpose**: Create a new task with optional project, section, assignees, and due date.\n\n**Syntax**:\n```\n/todo add <title> [@user ...] [/p <project>] [/s <section>] [due:<date>]\n```\n\n**Defaults**:\n| Parameter | Default |\n|---|---|\n| project | `Inbox` |\n| section | `backlog` |\n| assignees | sender |\n| due | none |\n\n**Flow**:\n1. User sends `/todo add Buy groceries`\n2. Bot creates task in Inbox/backlog, assigns to sender\n3. Bot replies with confirmation\n\n**Examples**:\n\n```\nInput:  /todo add Buy groceries\nOutput: :white_check_mark: Added #42 (Inbox/backlog) due:- assignees:@phil -- Buy groceries\n```\n\n```\nInput:  /todo add Fix login bug @alice /p Backend /s doing due:2026-03-15\nOutput: :white_check_mark: Added #43 (Backend/doing) due:2026-03-15 assignees:@alice -- Fix login bug\n```\n\n```\nInput:  /todo add Review PR @bob @carol /p Frontend\nOutput: :white_check_mark: Added #44 (Frontend/backlog) due:- assignees:@bob, @carol -- Review PR\n```\n\n**Success response format**:\n```\n:white_check_mark: Added #<id> (<project>/<section>) due:<date|-> assignees:<@user>[, <@user>...] -- <title>\n```\n\n---\n\n### 3.2 `/todo list` -- List Tasks\n\n**Purpose**: Display a filtered, sorted list of tasks.\n\n**Syntax**:\n```\n/todo list [mine|all|@user] [/p <project>] [/s <section>] [open|done|drop] [limit:N]\n```\n\n**Defaults**:\n| Parameter | Default |\n|---|---|\n| scope | `mine` |\n| status filter | `open` |\n| limit | 30 |\n\n**Flow**:\n1. User sends `/todo list`\n2. Bot queries tasks where sender is an assignee, status is open\n3. Bot returns a numbered list sorted by due date (ascending, nulls last), then by ID (descending)\n\n**Example output**:\n```\n:clipboard: TODO List (mine / open) -- 3 tasks\n\n#50  due:2026-02-21  (Backend/doing)    @phil        Deploy hotfix\n#48  due:2026-03-01  (Inbox/backlog)    @phil        Buy groceries\n#45  due:-           (Frontend/waiting) @phil, @bob  Review PR\n\nShowing 3 of 3. Use limit:N to see more.\n```\n\n**Empty state**:\n```\n:clipboard: TODO List (mine / open) -- 0 tasks\n\nNo tasks found.\n```\n\n**Scope behavior**:\n| Scope | What it shows |\n|---|---|\n| `mine` | Tasks where sender is in the assignee list |\n| `all` | All shared tasks + sender's private tasks (never other users' private tasks) |\n| `@user` | Tasks where the mentioned user is an assignee (shared projects only, plus sender's private if sender = mentioned user) |\n\n---\n\n### 3.3 `/todo board` -- Kanban Board View\n\n**Purpose**: Display tasks grouped by section in a kanban-style text layout.\n\n**Syntax**:\n```\n/todo board [mine|all|@user] [/p <project>] [open|done|drop] [limitPerSection:N]\n```\n\n**Defaults**:\n| Parameter | Default |\n|---|---|\n| scope | `mine` |\n| status filter | `open` |\n| limitPerSection | 10 |\n\n**Flow**:\n1. User sends `/todo board /p Backend`\n2. Bot queries matching tasks and groups them by section\n3. Bot returns sections in fixed order: BACKLOG, DOING, WAITING, DONE, DROP\n\n**Example output**:\n```\n:bar_chart: Board (mine / open) /p Backend\n\n-- BACKLOG (2) --\n#50  due:2026-03-10  @phil        Set up CI pipeline\n#47  due:-           @phil        Write migration script\n\n-- DOING (1) --\n#51  due:2026-02-22  @phil        Deploy hotfix\n\n-- WAITING (0) --\n(empty)\n\n-- DONE (0) --\n(empty)\n\n-- DROP (0) --\n(empty)\n```\n\n**Notes**:\n- Sections with zero items still appear with `(empty)` to maintain the full board structure.\n- Each section header shows the count of items.\n- When `limitPerSection` is reached, append `... and N more` below the last item in that section.\n\n---\n\n### 3.4 `/todo move` -- Move a Task to a Different Section\n\n**Purpose**: Change the section (kanban column) of a task.\n\n**Syntax**:\n```\n/todo move <id> <section>\n```\n\n**Valid sections**: `backlog`, `doing`, `waiting`, `done`, `drop`\n\n**Flow**:\n1. User sends `/todo move 50 doing`\n2. Bot validates permission and section name\n3. Bot updates the task and replies\n\n**Example**:\n```\nInput:  /todo move 50 doing\nOutput: :arrow_right: Moved #50 to doing (Backend) -- Deploy hotfix\n```\n\n---\n\n### 3.5 `/todo done` -- Mark a Task as Done\n\n**Purpose**: Shortcut to move a task to the `done` section and set its status to `done`.\n\n**Syntax**:\n```\n/todo done <id>\n```\n\n**Flow**:\n1. User sends `/todo done 50`\n2. Bot sets section=done, status=done, records closed_at\n3. Bot replies with confirmation\n\n**Example**:\n```\nInput:  /todo done 50\nOutput: :white_check_mark: Done #50 (Backend) -- Deploy hotfix\n```\n\n---\n\n### 3.6 `/todo drop` -- Drop a Task\n\n**Purpose**: Mark a task as dropped (cancelled/abandoned).\n\n**Syntax**:\n```\n/todo drop <id>\n```\n\n**Flow**:\n1. User sends `/todo drop 50`\n2. Bot sets section=drop, status=dropped, records closed_at\n3. Bot replies with confirmation\n\n**Example**:\n```\nInput:  /todo drop 50\nOutput: :wastebasket: Dropped #50 (Backend) -- Deploy hotfix\n```\n\n---\n\n### 3.7 `/todo edit` -- Edit a Task\n\n**Purpose**: Modify one or more fields of an existing task.\n\n**Syntax**:\n```\n/todo edit <id> [<new title>] [@user ...] [/p <project>] [/s <section>] [due:<date>|due:-]\n```\n\n**Rules**:\n- If `@user` mentions are present, the assignee list is **fully replaced** (not appended).\n- `due:-` clears the due date (sets it to null).\n- New title text is everything before the first option token (`/p`, `/s`, `due:`, or `@mention`). If empty, the title is unchanged.\n- Fields not specified in the command remain unchanged.\n\n**Flow**:\n1. User sends `/todo edit 50 Deploy hotfix v2 due:2026-03-01`\n2. Bot updates title and due date\n3. Bot replies with the updated state\n\n**Example**:\n```\nInput:  /todo edit 50 Deploy hotfix v2 due:2026-03-01\nOutput: :pencil2: Edited #50 (Backend/doing) due:2026-03-01 assignees:@phil -- Deploy hotfix v2\n```\n\n```\nInput:  /todo edit 50 @alice @bob\nOutput: :pencil2: Edited #50 (Backend/doing) due:2026-03-01 assignees:@alice, @bob -- Deploy hotfix v2\n```\n\n```\nInput:  /todo edit 50 due:-\nOutput: :pencil2: Edited #50 (Backend/doing) due:- assignees:@alice, @bob -- Deploy hotfix v2\n```\n\n**Success response format** (same structure as add):\n```\n:pencil2: Edited #<id> (<project>/<section>) due:<date|-> assignees:<@user>[, ...] -- <title>\n```\n\n---\n\n### 3.8 `/todo project list` -- List Projects\n\n**Purpose**: Show all projects visible to the sender.\n\n**Syntax**:\n```\n/todo project list\n```\n\n**Flow**:\n1. User sends `/todo project list`\n2. Bot returns shared projects and the sender's private projects\n\n**Example output**:\n```\n:file_folder: Projects\n\nShared:\n  - Inbox (12 tasks)\n  - Backend (5 tasks)\n  - Frontend (8 tasks)\n\nPrivate (yours):\n  - Personal (3 tasks)\n  - Side Project (1 task)\n```\n\n**Empty state**:\n```\n:file_folder: Projects\n\nShared:\n  - Inbox (0 tasks)\n\nPrivate (yours):\n  (none)\n```\n\n---\n\n### 3.9 `/todo project set-private <name>` -- Make a Project Private\n\n**Purpose**: Convert a shared project to private or create a new private project.\n\n**Syntax**:\n```\n/todo project set-private <name>\n```\n\n**Flow**:\n\nCase A -- Project does not exist:\n1. Bot creates a new private project owned by the sender.\n2. Reply: `:lock: Created private project \"<name>\".`\n\nCase B -- Sender already has a private project with this name:\n1. Reply: `:lock: Project \"<name>\" is already private.`\n\nCase C -- Shared project exists, conversion attempt:\n1. Bot scans all tasks in the project for non-owner assignees.\n2. If none found: convert to private, reply `:lock: Project \"<name>\" is now private.`\n3. If found: reject with error (see [Section 5.3](#53-set-private-validation-error)).\n\n---\n\n### 3.10 `/todo project set-shared <name>` -- Make a Project Shared\n\n**Purpose**: Convert a private project to shared or create a new shared project.\n\n**Syntax**:\n```\n/todo project set-shared <name>\n```\n\n**Flow**:\n\nCase A -- Shared project with this name already exists:\n1. Reply: `:globe_with_meridians: Project \"<name>\" is already shared.`\n\nCase B -- No shared project with this name:\n1. Bot creates (or converts) the project to shared visibility.\n2. Reply: `:globe_with_meridians: Project \"<name>\" is now shared.`\n\nCase C -- Name conflict with an existing shared project:\n1. Reply: `:x: A shared project named \"<name>\" already exists.`\n\n---\n\n## 4. Response Formatting\n\n### 4.1 General Structure\n\nAll bot responses follow this pattern:\n\n```\n<emoji> <Action verb> <details>\n```\n\n| Action | Emoji | Verb |\n|---|---|---|\n| Add | :white_check_mark: | Added |\n| List | :clipboard: | TODO List |\n| Board | :bar_chart: | Board |\n| Move | :arrow_right: | Moved |\n| Done | :white_check_mark: | Done |\n| Drop | :wastebasket: | Dropped |\n| Edit | :pencil2: | Edited |\n| Project list | :file_folder: | Projects |\n| Set private | :lock: | (varies by case) |\n| Set shared | :globe_with_meridians: | (varies by case) |\n| Error | :x: | (error message) |\n| Warning/reject | :warning: | (warning message) |\n\n### 4.2 Task Line Format\n\nWhenever a single task is displayed inline (in list, board, or as a command result), it uses:\n\n```\n#<id>  due:<YYYY-MM-DD|->  (<project>/<section>)  <assignees>  <title>\n```\n\n- `id`: Left-padded for alignment in lists (e.g., `#42`, `# 7` -- optional, simple left-align is acceptable in v1).\n- `due`: Always shown. `-` when no due date.\n- `assignees`: Comma-separated Slack mentions. Displayed as `@username` in Slack's rendered view.\n- `title`: The full task title, untruncated.\n\n### 4.3 List/Board Headers\n\nLists and boards begin with a header line summarizing the query:\n\n```\n:clipboard: TODO List (<scope> / <status>) -- <count> tasks\n```\n```\n:bar_chart: Board (<scope> / <status>) [/p <project>]\n```\n\n### 4.4 Pagination Footer\n\nWhen the result set exceeds the limit:\n```\nShowing <displayed> of <total>. Use limit:N to see more.\n```\n\nFor board view:\n```\n... and <N> more\n```\n(appears below the last item in a section that hit `limitPerSection`)\n\n### 4.5 Text Encoding\n\n- All responses are plain Slack mrkdwn (Slack's markdown variant).\n- No block kit or attachments in v1.\n- User mentions are rendered as `<@UXXXXXXXX>` which Slack auto-formats.\n\n---\n\n## 5. Error Messages\n\n### 5.1 Input Validation Errors\n\n| Condition | Error message |\n|---|---|\n| Unknown command | `:x: Unknown command. Available: add, list, board, move, done, drop, edit, project` |\n| Missing title on add | `:x: Title is required. Usage: /todo add <title> [options]` |\n| Missing task ID | `:x: Task ID is required. Usage: /todo <command> <id>` |\n| Invalid task ID (not a number) | `:x: Invalid task ID \"<input>\". Must be a number.` |\n| Task not found | `:x: Task #<id> not found.` |\n| Invalid section name | `:x: Invalid section \"<input>\". Must be one of: backlog, doing, waiting, done, drop` |\n| Invalid date format | `:x: Invalid date \"<input>\". Use YYYY-MM-DD or MM-DD.` |\n| Invalid date value (e.g. 02-30) | `:x: Invalid date \"02-30\". This date does not exist.` |\n| Empty project name | `:x: Project name is required after /p.` |\n\n### 5.2 Permission Errors\n\n| Condition | Error message |\n|---|---|\n| Accessing another user's private project | `:x: Project \"<name>\" not found.` (deliberately vague to avoid leaking existence) |\n| Editing a task without permission | `:x: You don't have permission to modify task #<id>.` |\n\n### 5.3 Set-Private Validation Error\n\nWhen `/todo project set-private` fails due to non-owner assignees:\n\n```\n:x: Cannot set project \"<name>\" to private: found tasks assigned to non-owner users.\ne.g. #12 assignees:@alice, #18 assignees:@carol, #21 assignees:@bob\nPlease reassign or remove these assignees first.\n```\n\n- Show up to 10 violating tasks.\n- If more than 10, append: `... and <N> more tasks with external assignees.`\n\n### 5.4 Private Project Assignee Rejection\n\nWhen trying to assign a non-owner user to a task in a private project (on add or edit):\n\n```\n:warning: Private project \"<name>\" is owner-only. Cannot assign <@user> (not the owner).\nRequest was not applied.\n```\n\n### 5.5 Project Name Conflicts\n\n| Condition | Error message |\n|---|---|\n| Creating/renaming to an existing shared name | `:x: A shared project named \"<name>\" already exists.` |\n| Private name conflict for same owner | `:x: You already have a private project named \"<name>\".` |\n\n---\n\n## 6. Edge Cases\n\n### 6.1 Empty Inputs\n\n| Scenario | Behavior |\n|---|---|\n| `/todo` (no subcommand) | Reply with help text listing available commands |\n| `/todo add` (no title) | Error: title required |\n| `/todo edit 50` (no changes) | Reply: `:information_source: No changes specified for #50.` |\n| `/todo list /p NonExistent` | Error: project not found |\n\n### 6.2 Duplicate Operations\n\n| Scenario | Behavior |\n|---|---|\n| `/todo done 50` when already done | Reply: `:information_source: Task #50 is already done.` |\n| `/todo drop 50` when already dropped | Reply: `:information_source: Task #50 is already dropped.` |\n| `/todo move 50 doing` when already in doing | Reply: `:information_source: Task #50 is already in doing.` |\n\n### 6.3 Project Auto-Creation\n\n- When `/todo add ... /p NewProject` references a project that does not exist, the bot creates it as a **shared** project automatically and includes a note in the response:\n  ```\n  :white_check_mark: Added #55 (NewProject/backlog) due:- assignees:@phil -- Task title\n  :information_source: Project \"NewProject\" was created (shared).\n  ```\n- Exception: `Inbox` is always auto-created as shared if it does not exist.\n\n### 6.4 Case Sensitivity\n\n- **Section names**: Case-insensitive input, stored lowercase. `DOING`, `Doing`, `doing` all resolve to `doing`.\n- **Project names**: Case-sensitive. `Backend` and `backend` are different projects.\n- **Commands**: Case-insensitive. `/todo ADD`, `/TODO add`, `/todo Add` all work.\n\n### 6.5 Whitespace and Formatting\n\n- Leading/trailing whitespace in titles is trimmed.\n- Multiple spaces between words in a title are collapsed to a single space.\n- Empty title after trimming triggers the \"title required\" error.\n\n### 6.6 Special Characters in Titles\n\n- Titles may contain any UTF-8 characters except newlines.\n- Slack mrkdwn special characters (`*`, `_`, `~`, `` ` ``) in titles are escaped in the response to prevent formatting artifacts.\n\n### 6.7 Due Date Edge Cases\n\n| Input | Resolved date (assuming current year 2026) |\n|---|---|\n| `due:2026-03-15` | `2026-03-15` |\n| `due:03-15` | `2026-03-15` |\n| `due:3-5` | `2026-03-05` |\n| `due:02-29` | Error (2026 is not a leap year) |\n| `due:00-01` | Error (invalid month) |\n| `due:12-32` | Error (invalid day) |\n| `due:-` | Clears due date (null) |\n| `due:yesterday` | Error (invalid format) |\n\n---\n\n## 7. Input Parsing Rules\n\n### 7.1 Token Order\n\nThe parser processes the message left to right. Recognized option tokens are:\n\n| Token | Pattern | Notes |\n|---|---|---|\n| `/p` | `/p <word>` | Next whitespace-delimited word is the project name |\n| `/s` | `/s <word>` | Next word is the section name |\n| `due:` | `due:<value>` | No space between `due:` and the value |\n| `@mention` | `<@UXXXXXXXX>` | Slack user mention (may appear multiple times) |\n| `limit:` | `limit:<N>` | Positive integer |\n| `limitPerSection:` | `limitPerSection:<N>` | Positive integer |\n\n### 7.2 Title Extraction (for add/edit)\n\nEverything that is **not** a recognized option token or mention is treated as the title. The title words are concatenated in their original order.\n\nExample parse:\n```\n/todo add Fix the login bug @alice /p Backend due:03-15\n\nParsed:\n  command   = add\n  title     = \"Fix the login bug\"\n  assignees = [@alice]\n  project   = \"Backend\"\n  due       = \"2026-03-15\"\n  section   = (default: backlog)\n```\n\n### 7.3 Mention Handling\n\n- Slack internally sends mentions as `<@U04ABCD1234>`.\n- The bot resolves these to display names in responses when possible.\n- If a mentioned user cannot be resolved, the raw `<@U...>` format is preserved.\n\n### 7.4 Scope Keywords (for list/board)\n\nThe first non-option argument after the subcommand determines scope:\n\n| Keyword | Meaning |\n|---|---|\n| `mine` (or omitted) | Tasks assigned to sender |\n| `all` | Shared tasks + sender's private tasks |\n| `@user` | Tasks assigned to the mentioned user |\n\n### 7.5 Status Keywords (for list/board)\n\n| Keyword | Meaning |\n|---|---|\n| `open` (or omitted) | Tasks with status = open |\n| `done` | Tasks with status = done |\n| `drop` | Tasks with status = dropped |\n\n---\n\n## Appendix: Help Text\n\nWhen the user sends `/todo` with no subcommand (or `/todo help`), the bot replies:\n\n```\n:book: OpenClaw TODO -- Commands\n\n/todo add <title> [@user] [/p project] [/s section] [due:date]\n    Create a new task.\n\n/todo list [mine|all|@user] [/p project] [/s section] [open|done|drop] [limit:N]\n    List tasks.\n\n/todo board [mine|all|@user] [/p project] [open|done|drop] [limitPerSection:N]\n    Show kanban board view.\n\n/todo move <id> <section>\n    Move a task to a section (backlog, doing, waiting, done, drop).\n\n/todo done <id>\n    Mark a task as done.\n\n/todo drop <id>\n    Drop (cancel) a task.\n\n/todo edit <id> [title] [@user] [/p project] [/s section] [due:date|due:-]\n    Edit a task. Mentions replace all assignees. due:- clears the date.\n\n/todo project list\n    Show all visible projects.\n\n/todo project set-private <name>\n    Make a project private (owner-only).\n\n/todo project set-shared <name>\n    Make a project shared.\n```\n", "structuredPatch": [], "originalFile": null}, "tool_use_id": "toolu_01JnW9Ux66hZDCcpcZz79c2o", "_ts": "2026-02-20T11:33:23+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/docs/architecture.md", "content": "# Architecture -- OpenClaw TODO Plugin for Slack\n\n> Version: 1.0\n> Date: 2026-02-20\n> Status: Proposed\n> Derived from: `openclaw_todo_plugin_prd.md` v1.1\n\n---\n\n## 1. System Context\n\nThis is an **OpenClaw plugin**, not a standalone application. It runs inside the OpenClaw Gateway process and communicates with users through Slack DMs. There is no HTTP server, no REST API, and no web framework. The entire system is a single Python package that the Gateway loads at startup.\n\n```\nSlack User  --(DM)--> Slack API --> OpenClaw Gateway --> TODO Plugin --> SQLite3\n```\n\n### Constraints\n\n- No LLM calls (zero cost per invocation).\n- Single SQLite3 file shared across all users within one Gateway instance.\n- No external dependencies beyond the Python stdlib and the OpenClaw plugin SDK.\n\n---\n\n## 2. Module / Package Structure\n\n```\nopenclaw_todo_plugin/\n    __init__.py              # Plugin entry point; exports register()\n    plugin.py                # OpenClaw plugin registration and message dispatch\n    router.py                # Command routing: text -> handler\n    parser.py                # Tokenizer and argument extractor\n    commands/\n        __init__.py\n        add.py               # /todo add\n        list_cmd.py          # /todo list   (avoids shadowing builtins)\n        board.py             # /todo board\n        move.py              # /todo move\n        done.py              # /todo done\n        drop.py              # /todo drop\n        edit.py              # /todo edit\n        project.py           # /todo project list|set-private|set-shared\n    db/\n        __init__.py\n        connection.py        # Connection factory, WAL/busy_timeout pragmas\n        migrate.py           # Schema versioning and migration runner\n        migrations/\n            __init__.py\n            v001_initial.py  # Initial schema (projects, tasks, task_assignees, events, schema_version)\n    models.py                # Dataclasses: Task, Project, Assignee, Event\n    repositories/\n        __init__.py\n        project_repo.py      # CRUD + resolve logic for projects\n        task_repo.py          # CRUD + query builders for tasks\n        event_repo.py         # Append-only audit log writes\n    services/\n        __init__.py\n        project_service.py   # Business rules for project visibility transitions\n        task_service.py       # Business rules for task lifecycle\n        permission.py         # Authorization checks (private/shared, owner/assignee)\n    formatters.py             # Slack message formatting (board, list, confirmations)\n    date_utils.py             # due parser: YYYY-MM-DD / MM-DD normalization\n    errors.py                 # Domain exception hierarchy\n    config.py                 # DB path resolution, timezone, defaults\ntests/\n    conftest.py               # Shared fixtures (in-memory SQLite, fake sender context)\n    test_parser.py\n    test_date_utils.py\n    test_commands/\n        test_add.py\n        test_list.py\n        test_board.py\n        test_move.py\n        test_done_drop.py\n        test_edit.py\n        test_project.py\n    test_repositories/\n        test_project_repo.py\n        test_task_repo.py\n    test_services/\n        test_permission.py\n        test_project_service.py\n        test_task_service.py\n    test_db/\n        test_migrate.py\n```\n\n### Rationale\n\n- **Flat `commands/` package**: one module per command keeps each handler under 150 lines and independently testable.\n- **Repository pattern** over raw SQL in handlers: SQL stays in one place; business logic in `services/` never imports `sqlite3`.\n- **No ORM**: SQLite3 stdlib driver is sufficient. An ORM would add a dependency for no gain at this scale.\n\n---\n\n## 3. Data Model\n\n### 3.1 Entity-Relationship Diagram (logical)\n\n```\nprojects 1---* tasks *---* task_assignees\n                |\n                +---* events\n```\n\n### 3.2 Tables\n\nAll timestamps are stored as ISO-8601 TEXT in UTC.\n\n#### `schema_version`\n\n| Column  | Type    | Notes        |\n|---------|---------|--------------|\n| version | INTEGER | NOT NULL     |\n\nSingle-row table. Current value determines which migrations to run.\n\n#### `projects`\n\n| Column         | Type    | Constraints / Default                     |\n|----------------|---------|-------------------------------------------|\n| id             | INTEGER | PK AUTOINCREMENT                          |\n| name           | TEXT    | NOT NULL                                  |\n| visibility     | TEXT    | NOT NULL CHECK IN ('shared','private')    |\n| owner_user_id  | TEXT    | NULL (NULL when shared)                   |\n| created_at     | TEXT    | NOT NULL DEFAULT datetime('now')          |\n| updated_at     | TEXT    | NOT NULL DEFAULT datetime('now')          |\n\n**Indexes:**\n\n```sql\nCREATE UNIQUE INDEX ux_projects_shared_name\n    ON projects(name) WHERE visibility='shared';\n\nCREATE UNIQUE INDEX ux_projects_private_owner_name\n    ON projects(owner_user_id, name) WHERE visibility='private';\n```\n\n#### `tasks`\n\n| Column      | Type    | Constraints / Default                                   |\n|-------------|---------|----------------------------------------------------------|\n| id          | INTEGER | PK AUTOINCREMENT                                         |\n| title       | TEXT    | NOT NULL                                                 |\n| project_id  | INTEGER | NOT NULL FK -> projects(id)                              |\n| section     | TEXT    | NOT NULL CHECK IN ('backlog','doing','waiting','done','drop') |\n| due         | TEXT    | NULL, format YYYY-MM-DD                                  |\n| status      | TEXT    | NOT NULL CHECK IN ('open','done','dropped')              |\n| created_by  | TEXT    | NOT NULL (Slack user id)                                 |\n| created_at  | TEXT    | NOT NULL DEFAULT datetime('now')                         |\n| updated_at  | TEXT    | NOT NULL DEFAULT datetime('now')                         |\n| closed_at   | TEXT    | NULL                                                     |\n\n**Indexes:**\n\n```sql\nCREATE INDEX ix_tasks_project_section ON tasks(project_id, section);\nCREATE INDEX ix_tasks_status ON tasks(status);\n```\n\n#### `task_assignees`\n\n| Column           | Type    | Constraints                  |\n|------------------|---------|------------------------------|\n| task_id          | INTEGER | NOT NULL FK -> tasks(id)     |\n| assignee_user_id | TEXT    | NOT NULL                     |\n\n```sql\nPRIMARY KEY (task_id, assignee_user_id)\nCREATE INDEX ix_task_assignees_user ON task_assignees(assignee_user_id, task_id);\n```\n\n#### `events` (audit log)\n\n| Column         | Type    | Notes                        |\n|----------------|---------|------------------------------|\n| id             | INTEGER | PK AUTOINCREMENT             |\n| ts             | TEXT    | NOT NULL DEFAULT datetime('now') |\n| actor_user_id  | TEXT    | NOT NULL                     |\n| action         | TEXT    | NOT NULL (e.g. 'task.add')   |\n| task_id        | INTEGER | NULL                         |\n| payload        | TEXT    | JSON blob                    |\n\n### 3.3 Concurrency Pragmas\n\nApplied once per connection in `db/connection.py`:\n\n```python\nconn.execute(\"PRAGMA journal_mode=WAL\")\nconn.execute(\"PRAGMA busy_timeout=3000\")\nconn.execute(\"PRAGMA foreign_keys=ON\")\n```\n\n---\n\n## 4. APIs (Plugin Interface)\n\nThis plugin does not expose HTTP endpoints. Its \"API\" is the contract between OpenClaw Gateway and the plugin.\n\n### 4.1 Plugin Registration\n\n```python\n# openclaw_todo_plugin/__init__.py\n\ndef register(gateway):\n    \"\"\"Called by OpenClaw Gateway at startup.\n\n    Args:\n        gateway: OpenClaw gateway instance providing hooks for\n                 message handling and configuration access.\n    \"\"\"\n    from .plugin import TodoPlugin\n    plugin = TodoPlugin(gateway)\n    gateway.on_dm_message(plugin.handle)\n```\n\n### 4.2 Message Handler Contract\n\n```python\nclass TodoPlugin:\n    def handle(self, message: IncomingMessage) -> str | None:\n        \"\"\"Process a Slack DM. Return reply text or None to ignore.\"\"\"\n```\n\n`IncomingMessage` is an OpenClaw SDK type expected to carry at minimum:\n\n| Field        | Type | Description                     |\n|--------------|------|---------------------------------|\n| text         | str  | Raw message text                |\n| sender_id    | str  | Slack user ID of the sender     |\n| channel_id   | str  | DM channel ID                   |\n| timestamp    | str  | Slack message ts                |\n\n### 4.3 Command Routing\n\n`router.py` maps the second token of the message to a handler function:\n\n```python\nCOMMANDS = {\n    \"add\":     commands.add.handle,\n    \"list\":    commands.list_cmd.handle,\n    \"board\":   commands.board.handle,\n    \"move\":    commands.move.handle,\n    \"done\":    commands.done.handle,\n    \"drop\":    commands.drop.handle,\n    \"edit\":    commands.edit.handle,\n    \"project\": commands.project.handle,   # sub-routes internally\n}\n\ndef route(text: str, sender_id: str) -> str:\n    tokens = text.strip().split()\n    if not tokens or tokens[0] != \"/todo\":\n        return None\n    verb = tokens[1] if len(tokens) > 1 else \"help\"\n    handler = COMMANDS.get(verb)\n    if handler is None:\n        return f\"Unknown command: {verb}. Try /todo help\"\n    return handler(tokens[2:], sender_id)\n```\n\n### 4.4 Command Handler Signature\n\nEvery handler in `commands/` follows the same signature:\n\n```python\ndef handle(args: list[str], sender_id: str) -> str:\n    \"\"\"Execute the command and return a Slack-formatted reply string.\"\"\"\n```\n\n---\n\n## 5. Key Flows\n\n### 5.1 `/todo add` Flow\n\n```\nUser -> Gateway -> TodoPlugin.handle()\n  -> router.route() -> commands.add.handle()\n    -> parser.parse_add_args(tokens)        # extract title, mentions, /p, /s, due\n    -> date_utils.normalize_due(raw_due)    # MM-DD -> YYYY-MM-DD, validate\n    -> project_repo.resolve(name, sender)   # private-first resolution\n    -> permission.check_assignees(project, assignees, sender)  # private project guard\n    -> task_repo.create(task)               # INSERT task + task_assignees\n    -> event_repo.log(\"task.add\", ...)      # audit\n    -> formatters.format_add_confirm(task)  # reply string\n```\n\n### 5.2 `/todo project set-private` Flow\n\n```\ncommands.project.handle([\"set-private\", name], sender)\n  -> project_repo.resolve(name, sender)\n  -> IF already private: return \"already private\"\n  -> task_repo.find_non_owner_assignees(project_id, sender)\n  -> IF any found: return error with violating task IDs\n  -> project_repo.update_visibility(project_id, \"private\", sender)\n  -> event_repo.log(\"project.set_private\", ...)\n```\n\n---\n\n## 6. Jobs / Background Work\n\nThere are **no background jobs** in v1. All operations are synchronous request-response within the Gateway's message handler. Potential future jobs:\n\n| Job (future)           | Trigger         | Purpose                              |\n|------------------------|-----------------|--------------------------------------|\n| Due date reminders     | Cron / schedule | DM users about upcoming/overdue tasks|\n| Stale task cleanup     | Weekly          | Auto-drop tasks untouched > N days   |\n| DB vacuum              | Weekly          | Reclaim WAL space                    |\n\nThese would be registered via `gateway.schedule()` if the OpenClaw SDK supports it.\n\n---\n\n## 7. Observability\n\n### 7.1 Structured Logging\n\nAll modules use Python's `logging` module with a shared logger name `openclaw_todo`:\n\n```python\nimport logging\nlogger = logging.getLogger(\"openclaw_todo\")\n```\n\nLog levels:\n- **INFO**: command received (verb, sender_id, project), command completed.\n- **WARNING**: permission denied, invalid input, constraint violation.\n- **ERROR**: unexpected exceptions, DB errors.\n\n### 7.2 Audit Trail\n\nThe `events` table provides a queryable audit log. Every state-changing operation (add, edit, move, done, drop, project visibility change) writes an event row with the actor, action, affected task ID, and a JSON payload of the change delta.\n\n### 7.3 Metrics (future)\n\nIf the OpenClaw Gateway exposes a metrics interface, instrument:\n- `todo_commands_total` (counter, labels: verb, status)\n- `todo_command_duration_seconds` (histogram, labels: verb)\n- `todo_db_errors_total` (counter)\n\n### 7.4 Health Check\n\nThe plugin can expose a `health()` method that verifies the DB file exists and a simple `SELECT 1` succeeds.\n\n---\n\n## 8. Security\n\n### 8.1 Authentication\n\nAuthentication is delegated to Slack and the OpenClaw Gateway. The plugin trusts `sender_id` from the Gateway as the authenticated identity. No additional auth layer is needed.\n\n### 8.2 Authorization Model\n\n| Resource        | Read                                | Write                                      |\n|-----------------|-------------------------------------|--------------------------------------------|\n| Shared project  | Any user (scope-filtered)           | Assignee or created_by of the task         |\n| Private project | Owner only                          | Owner only                                 |\n\nAuthorization is enforced in `services/permission.py` and called by every command handler before any mutation.\n\n### 8.3 Input Validation\n\n- **SQL injection**: All queries use parameterized statements (`?` placeholders). No string interpolation in SQL.\n- **Slack mention validation**: Assignees must match the `<@U[A-Z0-9]+>` pattern. Arbitrary text is rejected.\n- **Due date validation**: Parsed through `datetime.date` -- invalid dates raise `ValueError` caught and returned as user-facing errors.\n- **Section/status enum**: Checked against a frozen set before reaching the DB. The DB CHECK constraint is a secondary guard.\n\n### 8.4 Data Isolation\n\nPrivate project data is filtered at the repository layer. Queries for private projects always include `WHERE owner_user_id = ?` to prevent data leakage even if a higher layer has a bug.\n\n### 8.5 Secrets\n\nNo API keys or secrets are stored by this plugin. The OpenClaw Gateway manages Slack API tokens.\n\n---\n\n## 9. Database Migration Strategy\n\n### 9.1 Version Table\n\n```sql\nCREATE TABLE IF NOT EXISTS schema_version (\n    version INTEGER NOT NULL\n);\nINSERT INTO schema_version (version) VALUES (0);\n```\n\n### 9.2 Migration Runner (`db/migrate.py`)\n\n```python\nMIGRATIONS = [\n    (1, \"v001_initial\", v001_initial.up),\n    # (2, \"v002_add_priority\", v002_add_priority.up),\n]\n\ndef run_migrations(conn: sqlite3.Connection) -> None:\n    current = _get_current_version(conn)\n    for version, name, up_fn in MIGRATIONS:\n        if version > current:\n            logger.info(\"Applying migration %s (%s)\", version, name)\n            up_fn(conn)\n            conn.execute(\"UPDATE schema_version SET version = ?\", (version,))\n            conn.commit()\n```\n\n### 9.3 Migration File Contract\n\nEach migration module in `db/migrations/` exports:\n\n```python\ndef up(conn: sqlite3.Connection) -> None:\n    \"\"\"Apply this migration forward.\"\"\"\n    conn.executescript(SQL)\n```\n\nDown migrations are not implemented in v1. Rollback is handled by restoring a DB backup (see section 10).\n\n### 9.4 Initialization Sequence\n\nOn first invocation or Gateway startup:\n\n1. Resolve DB path: `~/.openclaw/workspace/.todo/todo.sqlite3`\n2. Create directory if missing (`os.makedirs(..., exist_ok=True)`)\n3. Open connection with WAL pragmas\n4. Create `schema_version` table if not exists\n5. Run pending migrations\n6. Seed default `Inbox` shared project (idempotent `INSERT OR IGNORE`)\n\n---\n\n## 10. Deploy / Rollback\n\n### 10.1 Packaging\n\nThe plugin is distributed as a standard Python package installable via `uv add` or `pip install` (in the OpenClaw Gateway environment):\n\n```\npyproject.toml          # Package metadata, dependencies, entry points\nopenclaw_todo_plugin/   # Source\ntests/                  # Not included in distribution\n```\n\nEntry point for OpenClaw plugin discovery:\n\n```toml\n[project.entry-points.\"openclaw.plugins\"]\ntodo = \"openclaw_todo_plugin:register\"\n```\n\n### 10.2 Deployment Steps\n\n1. **Backup DB**: `cp todo.sqlite3 todo.sqlite3.bak.$(date +%s)`\n2. **Install new version**: `uv add openclaw-todo-plugin@<version>`\n3. **Restart Gateway**: migrations run automatically on startup\n4. **Verify**: send `/todo list` in DM, check logs for migration success\n\n### 10.3 Rollback Steps\n\n1. **Stop Gateway**\n2. **Restore DB** (if schema changed): `cp todo.sqlite3.bak.<ts> todo.sqlite3`\n3. **Install previous version**: `uv add openclaw-todo-plugin@<prev-version>`\n4. **Restart Gateway**\n\n### 10.4 Zero-Downtime Considerations\n\nSQLite does not support concurrent schema changes from multiple writers. Since there is a single Gateway process, migrations are safe without locking beyond SQLite's built-in WAL locking. If multi-process deployment is ever needed, migration must run as a separate step before starting workers.\n\n---\n\n## 11. Tradeoffs and Design Decisions\n\n### 11.1 SQLite vs. PostgreSQL\n\n**Chosen: SQLite.**\n\n| Factor          | SQLite                              | PostgreSQL                         |\n|-----------------|-------------------------------------|------------------------------------|\n| Ops complexity  | Zero (file on disk)                 | Requires running server            |\n| Concurrency     | Single-writer, good enough for DMs  | Full MVCC                          |\n| Scale ceiling   | ~100 concurrent users               | Thousands                          |\n| Backup          | File copy                           | pg_dump / replication              |\n| Migration       | Manual scripts                      | Alembic / django-migrations        |\n\nSQLite is the right choice for a plugin that handles single-digit QPS through Slack DMs. If the team outgrows it, the repository layer abstracts SQL enough that a PostgreSQL migration is localized to `db/` and `repositories/`.\n\n### 11.2 No ORM\n\nUsing raw `sqlite3` with parameterized queries. This avoids adding SQLAlchemy as a dependency for a plugin that has four tables. The repository layer provides the same abstraction boundary that an ORM session would.\n\n### 11.3 Synchronous Execution\n\nAll command handlers are synchronous. The OpenClaw Gateway may be async (asyncio), but SQLite operations are fast enough (sub-millisecond for typical queries) that blocking is acceptable. If the Gateway requires async handlers, a thin `asyncio.to_thread()` wrapper in `plugin.py` is sufficient.\n\n### 11.4 No Down Migrations\n\nForward-only migrations simplify the code and avoid the risk of data loss from buggy down scripts. Rollback relies on DB file backup, which is more reliable for SQLite.\n\n### 11.5 Private-First Name Resolution\n\nWhen a user references `/p MyProject`, the system checks for a private project owned by the sender before checking shared projects. This is the simplest model but can surprise users who have both a private and shared project with the same name. The PRD recommends against this pattern, and the plugin logs a warning when it detects the ambiguity.\n\n### 11.6 Repository Pattern vs. Direct SQL in Handlers\n\nAdds a small amount of indirection but pays for itself in testability. Tests can mock repositories instead of setting up SQLite fixtures for every command test. Integration tests still exercise the full stack.\n\n### 11.7 Formatter as a Separate Module\n\nSlack message formatting (mrkdwn, block kit) is isolated from business logic. If the plugin ever needs to support a second chat platform, only `formatters.py` changes.\n\n### 11.8 Event Sourcing vs. Audit Log\n\nThe `events` table is an append-only audit log, not a full event-sourcing system. State is stored directly in `tasks` and `projects`. This is simpler to query and reason about. Full event sourcing would be over-engineering for a TODO plugin.\n\n---\n\n## 12. Dependency Summary\n\n| Dependency        | Purpose                      | Required |\n|-------------------|------------------------------|----------|\n| Python 3.11+      | Runtime                      | Yes      |\n| sqlite3 (stdlib)  | Database                     | Yes      |\n| OpenClaw SDK      | Plugin registration, message hooks | Yes |\n| pytest             | Testing                      | Dev only |\n| pytest-cov         | Coverage reporting           | Dev only |\n| ruff               | Linting                      | Dev only |\n| black              | Formatting                   | Dev only |\n\nNo third-party runtime dependencies beyond the OpenClaw SDK itself.\n"}, "tool_use_id": "toolu_01QK1c7j4yi1FaPoxTHo9rPD", "_ts": "2026-02-20T11:33:34+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/docs/architecture.md", "content": "# Architecture -- OpenClaw TODO Plugin for Slack\n\n> Version: 1.0\n> Date: 2026-02-20\n> Status: Proposed\n> Derived from: `openclaw_todo_plugin_prd.md` v1.1\n\n---\n\n## 1. System Context\n\nThis is an **OpenClaw plugin**, not a standalone application. It runs inside the OpenClaw Gateway process and communicates with users through Slack DMs. There is no HTTP server, no REST API, and no web framework. The entire system is a single Python package that the Gateway loads at startup.\n\n```\nSlack User  --(DM)--> Slack API --> OpenClaw Gateway --> TODO Plugin --> SQLite3\n```\n\n### Constraints\n\n- No LLM calls (zero cost per invocation).\n- Single SQLite3 file shared across all users within one Gateway instance.\n- No external dependencies beyond the Python stdlib and the OpenClaw plugin SDK.\n\n---\n\n## 2. Module / Package Structure\n\n```\nopenclaw_todo_plugin/\n    __init__.py              # Plugin entry point; exports register()\n    plugin.py                # OpenClaw plugin registration and message dispatch\n    router.py                # Command routing: text -> handler\n    parser.py                # Tokenizer and argument extractor\n    commands/\n        __init__.py\n        add.py               # /todo add\n        list_cmd.py          # /todo list   (avoids shadowing builtins)\n        board.py             # /todo board\n        move.py              # /todo move\n        done.py              # /todo done\n        drop.py              # /todo drop\n        edit.py              # /todo edit\n        project.py           # /todo project list|set-private|set-shared\n    db/\n        __init__.py\n        connection.py        # Connection factory, WAL/busy_timeout pragmas\n        migrate.py           # Schema versioning and migration runner\n        migrations/\n            __init__.py\n            v001_initial.py  # Initial schema (projects, tasks, task_assignees, events, schema_version)\n    models.py                # Dataclasses: Task, Project, Assignee, Event\n    repositories/\n        __init__.py\n        project_repo.py      # CRUD + resolve logic for projects\n        task_repo.py          # CRUD + query builders for tasks\n        event_repo.py         # Append-only audit log writes\n    services/\n        __init__.py\n        project_service.py   # Business rules for project visibility transitions\n        task_service.py       # Business rules for task lifecycle\n        permission.py         # Authorization checks (private/shared, owner/assignee)\n    formatters.py             # Slack message formatting (board, list, confirmations)\n    date_utils.py             # due parser: YYYY-MM-DD / MM-DD normalization\n    errors.py                 # Domain exception hierarchy\n    config.py                 # DB path resolution, timezone, defaults\ntests/\n    conftest.py               # Shared fixtures (in-memory SQLite, fake sender context)\n    test_parser.py\n    test_date_utils.py\n    test_commands/\n        test_add.py\n        test_list.py\n        test_board.py\n        test_move.py\n        test_done_drop.py\n        test_edit.py\n        test_project.py\n    test_repositories/\n        test_project_repo.py\n        test_task_repo.py\n    test_services/\n        test_permission.py\n        test_project_service.py\n        test_task_service.py\n    test_db/\n        test_migrate.py\n```\n\n### Rationale\n\n- **Flat `commands/` package**: one module per command keeps each handler under 150 lines and independently testable.\n- **Repository pattern** over raw SQL in handlers: SQL stays in one place; business logic in `services/` never imports `sqlite3`.\n- **No ORM**: SQLite3 stdlib driver is sufficient. An ORM would add a dependency for no gain at this scale.\n\n---\n\n## 3. Data Model\n\n### 3.1 Entity-Relationship Diagram (logical)\n\n```\nprojects 1---* tasks *---* task_assignees\n                |\n                +---* events\n```\n\n### 3.2 Tables\n\nAll timestamps are stored as ISO-8601 TEXT in UTC.\n\n#### `schema_version`\n\n| Column  | Type    | Notes        |\n|---------|---------|--------------|\n| version | INTEGER | NOT NULL     |\n\nSingle-row table. Current value determines which migrations to run.\n\n#### `projects`\n\n| Column         | Type    | Constraints / Default                     |\n|----------------|---------|-------------------------------------------|\n| id             | INTEGER | PK AUTOINCREMENT                          |\n| name           | TEXT    | NOT NULL                                  |\n| visibility     | TEXT    | NOT NULL CHECK IN ('shared','private')    |\n| owner_user_id  | TEXT    | NULL (NULL when shared)                   |\n| created_at     | TEXT    | NOT NULL DEFAULT datetime('now')          |\n| updated_at     | TEXT    | NOT NULL DEFAULT datetime('now')          |\n\n**Indexes:**\n\n```sql\nCREATE UNIQUE INDEX ux_projects_shared_name\n    ON projects(name) WHERE visibility='shared';\n\nCREATE UNIQUE INDEX ux_projects_private_owner_name\n    ON projects(owner_user_id, name) WHERE visibility='private';\n```\n\n#### `tasks`\n\n| Column      | Type    | Constraints / Default                                   |\n|-------------|---------|----------------------------------------------------------|\n| id          | INTEGER | PK AUTOINCREMENT                                         |\n| title       | TEXT    | NOT NULL                                                 |\n| project_id  | INTEGER | NOT NULL FK -> projects(id)                              |\n| section     | TEXT    | NOT NULL CHECK IN ('backlog','doing','waiting','done','drop') |\n| due         | TEXT    | NULL, format YYYY-MM-DD                                  |\n| status      | TEXT    | NOT NULL CHECK IN ('open','done','dropped')              |\n| created_by  | TEXT    | NOT NULL (Slack user id)                                 |\n| created_at  | TEXT    | NOT NULL DEFAULT datetime('now')                         |\n| updated_at  | TEXT    | NOT NULL DEFAULT datetime('now')                         |\n| closed_at   | TEXT    | NULL                                                     |\n\n**Indexes:**\n\n```sql\nCREATE INDEX ix_tasks_project_section ON tasks(project_id, section);\nCREATE INDEX ix_tasks_status ON tasks(status);\n```\n\n#### `task_assignees`\n\n| Column           | Type    | Constraints                  |\n|------------------|---------|------------------------------|\n| task_id          | INTEGER | NOT NULL FK -> tasks(id)     |\n| assignee_user_id | TEXT    | NOT NULL                     |\n\n```sql\nPRIMARY KEY (task_id, assignee_user_id)\nCREATE INDEX ix_task_assignees_user ON task_assignees(assignee_user_id, task_id);\n```\n\n#### `events` (audit log)\n\n| Column         | Type    | Notes                        |\n|----------------|---------|------------------------------|\n| id             | INTEGER | PK AUTOINCREMENT             |\n| ts             | TEXT    | NOT NULL DEFAULT datetime('now') |\n| actor_user_id  | TEXT    | NOT NULL                     |\n| action         | TEXT    | NOT NULL (e.g. 'task.add')   |\n| task_id        | INTEGER | NULL                         |\n| payload        | TEXT    | JSON blob                    |\n\n### 3.3 Concurrency Pragmas\n\nApplied once per connection in `db/connection.py`:\n\n```python\nconn.execute(\"PRAGMA journal_mode=WAL\")\nconn.execute(\"PRAGMA busy_timeout=3000\")\nconn.execute(\"PRAGMA foreign_keys=ON\")\n```\n\n---\n\n## 4. APIs (Plugin Interface)\n\nThis plugin does not expose HTTP endpoints. Its \"API\" is the contract between OpenClaw Gateway and the plugin.\n\n### 4.1 Plugin Registration\n\n```python\n# openclaw_todo_plugin/__init__.py\n\ndef register(gateway):\n    \"\"\"Called by OpenClaw Gateway at startup.\n\n    Args:\n        gateway: OpenClaw gateway instance providing hooks for\n                 message handling and configuration access.\n    \"\"\"\n    from .plugin import TodoPlugin\n    plugin = TodoPlugin(gateway)\n    gateway.on_dm_message(plugin.handle)\n```\n\n### 4.2 Message Handler Contract\n\n```python\nclass TodoPlugin:\n    def handle(self, message: IncomingMessage) -> str | None:\n        \"\"\"Process a Slack DM. Return reply text or None to ignore.\"\"\"\n```\n\n`IncomingMessage` is an OpenClaw SDK type expected to carry at minimum:\n\n| Field        | Type | Description                     |\n|--------------|------|---------------------------------|\n| text         | str  | Raw message text                |\n| sender_id    | str  | Slack user ID of the sender     |\n| channel_id   | str  | DM channel ID                   |\n| timestamp    | str  | Slack message ts                |\n\n### 4.3 Command Routing\n\n`router.py` maps the second token of the message to a handler function:\n\n```python\nCOMMANDS = {\n    \"add\":     commands.add.handle,\n    \"list\":    commands.list_cmd.handle,\n    \"board\":   commands.board.handle,\n    \"move\":    commands.move.handle,\n    \"done\":    commands.done.handle,\n    \"drop\":    commands.drop.handle,\n    \"edit\":    commands.edit.handle,\n    \"project\": commands.project.handle,   # sub-routes internally\n}\n\ndef route(text: str, sender_id: str) -> str:\n    tokens = text.strip().split()\n    if not tokens or tokens[0] != \"/todo\":\n        return None\n    verb = tokens[1] if len(tokens) > 1 else \"help\"\n    handler = COMMANDS.get(verb)\n    if handler is None:\n        return f\"Unknown command: {verb}. Try /todo help\"\n    return handler(tokens[2:], sender_id)\n```\n\n### 4.4 Command Handler Signature\n\nEvery handler in `commands/` follows the same signature:\n\n```python\ndef handle(args: list[str], sender_id: str) -> str:\n    \"\"\"Execute the command and return a Slack-formatted reply string.\"\"\"\n```\n\n---\n\n## 5. Key Flows\n\n### 5.1 `/todo add` Flow\n\n```\nUser -> Gateway -> TodoPlugin.handle()\n  -> router.route() -> commands.add.handle()\n    -> parser.parse_add_args(tokens)        # extract title, mentions, /p, /s, due\n    -> date_utils.normalize_due(raw_due)    # MM-DD -> YYYY-MM-DD, validate\n    -> project_repo.resolve(name, sender)   # private-first resolution\n    -> permission.check_assignees(project, assignees, sender)  # private project guard\n    -> task_repo.create(task)               # INSERT task + task_assignees\n    -> event_repo.log(\"task.add\", ...)      # audit\n    -> formatters.format_add_confirm(task)  # reply string\n```\n\n### 5.2 `/todo project set-private` Flow\n\n```\ncommands.project.handle([\"set-private\", name], sender)\n  -> project_repo.resolve(name, sender)\n  -> IF already private: return \"already private\"\n  -> task_repo.find_non_owner_assignees(project_id, sender)\n  -> IF any found: return error with violating task IDs\n  -> project_repo.update_visibility(project_id, \"private\", sender)\n  -> event_repo.log(\"project.set_private\", ...)\n```\n\n---\n\n## 6. Jobs / Background Work\n\nThere are **no background jobs** in v1. All operations are synchronous request-response within the Gateway's message handler. Potential future jobs:\n\n| Job (future)           | Trigger         | Purpose                              |\n|------------------------|-----------------|--------------------------------------|\n| Due date reminders     | Cron / schedule | DM users about upcoming/overdue tasks|\n| Stale task cleanup     | Weekly          | Auto-drop tasks untouched > N days   |\n| DB vacuum              | Weekly          | Reclaim WAL space                    |\n\nThese would be registered via `gateway.schedule()` if the OpenClaw SDK supports it.\n\n---\n\n## 7. Observability\n\n### 7.1 Structured Logging\n\nAll modules use Python's `logging` module with a shared logger name `openclaw_todo`:\n\n```python\nimport logging\nlogger = logging.getLogger(\"openclaw_todo\")\n```\n\nLog levels:\n- **INFO**: command received (verb, sender_id, project), command completed.\n- **WARNING**: permission denied, invalid input, constraint violation.\n- **ERROR**: unexpected exceptions, DB errors.\n\n### 7.2 Audit Trail\n\nThe `events` table provides a queryable audit log. Every state-changing operation (add, edit, move, done, drop, project visibility change) writes an event row with the actor, action, affected task ID, and a JSON payload of the change delta.\n\n### 7.3 Metrics (future)\n\nIf the OpenClaw Gateway exposes a metrics interface, instrument:\n- `todo_commands_total` (counter, labels: verb, status)\n- `todo_command_duration_seconds` (histogram, labels: verb)\n- `todo_db_errors_total` (counter)\n\n### 7.4 Health Check\n\nThe plugin can expose a `health()` method that verifies the DB file exists and a simple `SELECT 1` succeeds.\n\n---\n\n## 8. Security\n\n### 8.1 Authentication\n\nAuthentication is delegated to Slack and the OpenClaw Gateway. The plugin trusts `sender_id` from the Gateway as the authenticated identity. No additional auth layer is needed.\n\n### 8.2 Authorization Model\n\n| Resource        | Read                                | Write                                      |\n|-----------------|-------------------------------------|--------------------------------------------|\n| Shared project  | Any user (scope-filtered)           | Assignee or created_by of the task         |\n| Private project | Owner only                          | Owner only                                 |\n\nAuthorization is enforced in `services/permission.py` and called by every command handler before any mutation.\n\n### 8.3 Input Validation\n\n- **SQL injection**: All queries use parameterized statements (`?` placeholders). No string interpolation in SQL.\n- **Slack mention validation**: Assignees must match the `<@U[A-Z0-9]+>` pattern. Arbitrary text is rejected.\n- **Due date validation**: Parsed through `datetime.date` -- invalid dates raise `ValueError` caught and returned as user-facing errors.\n- **Section/status enum**: Checked against a frozen set before reaching the DB. The DB CHECK constraint is a secondary guard.\n\n### 8.4 Data Isolation\n\nPrivate project data is filtered at the repository layer. Queries for private projects always include `WHERE owner_user_id = ?` to prevent data leakage even if a higher layer has a bug.\n\n### 8.5 Secrets\n\nNo API keys or secrets are stored by this plugin. The OpenClaw Gateway manages Slack API tokens.\n\n---\n\n## 9. Database Migration Strategy\n\n### 9.1 Version Table\n\n```sql\nCREATE TABLE IF NOT EXISTS schema_version (\n    version INTEGER NOT NULL\n);\nINSERT INTO schema_version (version) VALUES (0);\n```\n\n### 9.2 Migration Runner (`db/migrate.py`)\n\n```python\nMIGRATIONS = [\n    (1, \"v001_initial\", v001_initial.up),\n    # (2, \"v002_add_priority\", v002_add_priority.up),\n]\n\ndef run_migrations(conn: sqlite3.Connection) -> None:\n    current = _get_current_version(conn)\n    for version, name, up_fn in MIGRATIONS:\n        if version > current:\n            logger.info(\"Applying migration %s (%s)\", version, name)\n            up_fn(conn)\n            conn.execute(\"UPDATE schema_version SET version = ?\", (version,))\n            conn.commit()\n```\n\n### 9.3 Migration File Contract\n\nEach migration module in `db/migrations/` exports:\n\n```python\ndef up(conn: sqlite3.Connection) -> None:\n    \"\"\"Apply this migration forward.\"\"\"\n    conn.executescript(SQL)\n```\n\nDown migrations are not implemented in v1. Rollback is handled by restoring a DB backup (see section 10).\n\n### 9.4 Initialization Sequence\n\nOn first invocation or Gateway startup:\n\n1. Resolve DB path: `~/.openclaw/workspace/.todo/todo.sqlite3`\n2. Create directory if missing (`os.makedirs(..., exist_ok=True)`)\n3. Open connection with WAL pragmas\n4. Create `schema_version` table if not exists\n5. Run pending migrations\n6. Seed default `Inbox` shared project (idempotent `INSERT OR IGNORE`)\n\n---\n\n## 10. Deploy / Rollback\n\n### 10.1 Packaging\n\nThe plugin is distributed as a standard Python package installable via `uv add` or `pip install` (in the OpenClaw Gateway environment):\n\n```\npyproject.toml          # Package metadata, dependencies, entry points\nopenclaw_todo_plugin/   # Source\ntests/                  # Not included in distribution\n```\n\nEntry point for OpenClaw plugin discovery:\n\n```toml\n[project.entry-points.\"openclaw.plugins\"]\ntodo = \"openclaw_todo_plugin:register\"\n```\n\n### 10.2 Deployment Steps\n\n1. **Backup DB**: `cp todo.sqlite3 todo.sqlite3.bak.$(date +%s)`\n2. **Install new version**: `uv add openclaw-todo-plugin@<version>`\n3. **Restart Gateway**: migrations run automatically on startup\n4. **Verify**: send `/todo list` in DM, check logs for migration success\n\n### 10.3 Rollback Steps\n\n1. **Stop Gateway**\n2. **Restore DB** (if schema changed): `cp todo.sqlite3.bak.<ts> todo.sqlite3`\n3. **Install previous version**: `uv add openclaw-todo-plugin@<prev-version>`\n4. **Restart Gateway**\n\n### 10.4 Zero-Downtime Considerations\n\nSQLite does not support concurrent schema changes from multiple writers. Since there is a single Gateway process, migrations are safe without locking beyond SQLite's built-in WAL locking. If multi-process deployment is ever needed, migration must run as a separate step before starting workers.\n\n---\n\n## 11. Tradeoffs and Design Decisions\n\n### 11.1 SQLite vs. PostgreSQL\n\n**Chosen: SQLite.**\n\n| Factor          | SQLite                              | PostgreSQL                         |\n|-----------------|-------------------------------------|------------------------------------|\n| Ops complexity  | Zero (file on disk)                 | Requires running server            |\n| Concurrency     | Single-writer, good enough for DMs  | Full MVCC                          |\n| Scale ceiling   | ~100 concurrent users               | Thousands                          |\n| Backup          | File copy                           | pg_dump / replication              |\n| Migration       | Manual scripts                      | Alembic / django-migrations        |\n\nSQLite is the right choice for a plugin that handles single-digit QPS through Slack DMs. If the team outgrows it, the repository layer abstracts SQL enough that a PostgreSQL migration is localized to `db/` and `repositories/`.\n\n### 11.2 No ORM\n\nUsing raw `sqlite3` with parameterized queries. This avoids adding SQLAlchemy as a dependency for a plugin that has four tables. The repository layer provides the same abstraction boundary that an ORM session would.\n\n### 11.3 Synchronous Execution\n\nAll command handlers are synchronous. The OpenClaw Gateway may be async (asyncio), but SQLite operations are fast enough (sub-millisecond for typical queries) that blocking is acceptable. If the Gateway requires async handlers, a thin `asyncio.to_thread()` wrapper in `plugin.py` is sufficient.\n\n### 11.4 No Down Migrations\n\nForward-only migrations simplify the code and avoid the risk of data loss from buggy down scripts. Rollback relies on DB file backup, which is more reliable for SQLite.\n\n### 11.5 Private-First Name Resolution\n\nWhen a user references `/p MyProject`, the system checks for a private project owned by the sender before checking shared projects. This is the simplest model but can surprise users who have both a private and shared project with the same name. The PRD recommends against this pattern, and the plugin logs a warning when it detects the ambiguity.\n\n### 11.6 Repository Pattern vs. Direct SQL in Handlers\n\nAdds a small amount of indirection but pays for itself in testability. Tests can mock repositories instead of setting up SQLite fixtures for every command test. Integration tests still exercise the full stack.\n\n### 11.7 Formatter as a Separate Module\n\nSlack message formatting (mrkdwn, block kit) is isolated from business logic. If the plugin ever needs to support a second chat platform, only `formatters.py` changes.\n\n### 11.8 Event Sourcing vs. Audit Log\n\nThe `events` table is an append-only audit log, not a full event-sourcing system. State is stored directly in `tasks` and `projects`. This is simpler to query and reason about. Full event sourcing would be over-engineering for a TODO plugin.\n\n---\n\n## 12. Dependency Summary\n\n| Dependency        | Purpose                      | Required |\n|-------------------|------------------------------|----------|\n| Python 3.11+      | Runtime                      | Yes      |\n| sqlite3 (stdlib)  | Database                     | Yes      |\n| OpenClaw SDK      | Plugin registration, message hooks | Yes |\n| pytest             | Testing                      | Dev only |\n| pytest-cov         | Coverage reporting           | Dev only |\n| ruff               | Linting                      | Dev only |\n| black              | Formatting                   | Dev only |\n\nNo third-party runtime dependencies beyond the OpenClaw SDK itself.\n"}, "tool_response": {"type": "create", "filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/docs/architecture.md", "content": "# Architecture -- OpenClaw TODO Plugin for Slack\n\n> Version: 1.0\n> Date: 2026-02-20\n> Status: Proposed\n> Derived from: `openclaw_todo_plugin_prd.md` v1.1\n\n---\n\n## 1. System Context\n\nThis is an **OpenClaw plugin**, not a standalone application. It runs inside the OpenClaw Gateway process and communicates with users through Slack DMs. There is no HTTP server, no REST API, and no web framework. The entire system is a single Python package that the Gateway loads at startup.\n\n```\nSlack User  --(DM)--> Slack API --> OpenClaw Gateway --> TODO Plugin --> SQLite3\n```\n\n### Constraints\n\n- No LLM calls (zero cost per invocation).\n- Single SQLite3 file shared across all users within one Gateway instance.\n- No external dependencies beyond the Python stdlib and the OpenClaw plugin SDK.\n\n---\n\n## 2. Module / Package Structure\n\n```\nopenclaw_todo_plugin/\n    __init__.py              # Plugin entry point; exports register()\n    plugin.py                # OpenClaw plugin registration and message dispatch\n    router.py                # Command routing: text -> handler\n    parser.py                # Tokenizer and argument extractor\n    commands/\n        __init__.py\n        add.py               # /todo add\n        list_cmd.py          # /todo list   (avoids shadowing builtins)\n        board.py             # /todo board\n        move.py              # /todo move\n        done.py              # /todo done\n        drop.py              # /todo drop\n        edit.py              # /todo edit\n        project.py           # /todo project list|set-private|set-shared\n    db/\n        __init__.py\n        connection.py        # Connection factory, WAL/busy_timeout pragmas\n        migrate.py           # Schema versioning and migration runner\n        migrations/\n            __init__.py\n            v001_initial.py  # Initial schema (projects, tasks, task_assignees, events, schema_version)\n    models.py                # Dataclasses: Task, Project, Assignee, Event\n    repositories/\n        __init__.py\n        project_repo.py      # CRUD + resolve logic for projects\n        task_repo.py          # CRUD + query builders for tasks\n        event_repo.py         # Append-only audit log writes\n    services/\n        __init__.py\n        project_service.py   # Business rules for project visibility transitions\n        task_service.py       # Business rules for task lifecycle\n        permission.py         # Authorization checks (private/shared, owner/assignee)\n    formatters.py             # Slack message formatting (board, list, confirmations)\n    date_utils.py             # due parser: YYYY-MM-DD / MM-DD normalization\n    errors.py                 # Domain exception hierarchy\n    config.py                 # DB path resolution, timezone, defaults\ntests/\n    conftest.py               # Shared fixtures (in-memory SQLite, fake sender context)\n    test_parser.py\n    test_date_utils.py\n    test_commands/\n        test_add.py\n        test_list.py\n        test_board.py\n        test_move.py\n        test_done_drop.py\n        test_edit.py\n        test_project.py\n    test_repositories/\n        test_project_repo.py\n        test_task_repo.py\n    test_services/\n        test_permission.py\n        test_project_service.py\n        test_task_service.py\n    test_db/\n        test_migrate.py\n```\n\n### Rationale\n\n- **Flat `commands/` package**: one module per command keeps each handler under 150 lines and independently testable.\n- **Repository pattern** over raw SQL in handlers: SQL stays in one place; business logic in `services/` never imports `sqlite3`.\n- **No ORM**: SQLite3 stdlib driver is sufficient. An ORM would add a dependency for no gain at this scale.\n\n---\n\n## 3. Data Model\n\n### 3.1 Entity-Relationship Diagram (logical)\n\n```\nprojects 1---* tasks *---* task_assignees\n                |\n                +---* events\n```\n\n### 3.2 Tables\n\nAll timestamps are stored as ISO-8601 TEXT in UTC.\n\n#### `schema_version`\n\n| Column  | Type    | Notes        |\n|---------|---------|--------------|\n| version | INTEGER | NOT NULL     |\n\nSingle-row table. Current value determines which migrations to run.\n\n#### `projects`\n\n| Column         | Type    | Constraints / Default                     |\n|----------------|---------|-------------------------------------------|\n| id             | INTEGER | PK AUTOINCREMENT                          |\n| name           | TEXT    | NOT NULL                                  |\n| visibility     | TEXT    | NOT NULL CHECK IN ('shared','private')    |\n| owner_user_id  | TEXT    | NULL (NULL when shared)                   |\n| created_at     | TEXT    | NOT NULL DEFAULT datetime('now')          |\n| updated_at     | TEXT    | NOT NULL DEFAULT datetime('now')          |\n\n**Indexes:**\n\n```sql\nCREATE UNIQUE INDEX ux_projects_shared_name\n    ON projects(name) WHERE visibility='shared';\n\nCREATE UNIQUE INDEX ux_projects_private_owner_name\n    ON projects(owner_user_id, name) WHERE visibility='private';\n```\n\n#### `tasks`\n\n| Column      | Type    | Constraints / Default                                   |\n|-------------|---------|----------------------------------------------------------|\n| id          | INTEGER | PK AUTOINCREMENT                                         |\n| title       | TEXT    | NOT NULL                                                 |\n| project_id  | INTEGER | NOT NULL FK -> projects(id)                              |\n| section     | TEXT    | NOT NULL CHECK IN ('backlog','doing','waiting','done','drop') |\n| due         | TEXT    | NULL, format YYYY-MM-DD                                  |\n| status      | TEXT    | NOT NULL CHECK IN ('open','done','dropped')              |\n| created_by  | TEXT    | NOT NULL (Slack user id)                                 |\n| created_at  | TEXT    | NOT NULL DEFAULT datetime('now')                         |\n| updated_at  | TEXT    | NOT NULL DEFAULT datetime('now')                         |\n| closed_at   | TEXT    | NULL                                                     |\n\n**Indexes:**\n\n```sql\nCREATE INDEX ix_tasks_project_section ON tasks(project_id, section);\nCREATE INDEX ix_tasks_status ON tasks(status);\n```\n\n#### `task_assignees`\n\n| Column           | Type    | Constraints                  |\n|------------------|---------|------------------------------|\n| task_id          | INTEGER | NOT NULL FK -> tasks(id)     |\n| assignee_user_id | TEXT    | NOT NULL                     |\n\n```sql\nPRIMARY KEY (task_id, assignee_user_id)\nCREATE INDEX ix_task_assignees_user ON task_assignees(assignee_user_id, task_id);\n```\n\n#### `events` (audit log)\n\n| Column         | Type    | Notes                        |\n|----------------|---------|------------------------------|\n| id             | INTEGER | PK AUTOINCREMENT             |\n| ts             | TEXT    | NOT NULL DEFAULT datetime('now') |\n| actor_user_id  | TEXT    | NOT NULL                     |\n| action         | TEXT    | NOT NULL (e.g. 'task.add')   |\n| task_id        | INTEGER | NULL                         |\n| payload        | TEXT    | JSON blob                    |\n\n### 3.3 Concurrency Pragmas\n\nApplied once per connection in `db/connection.py`:\n\n```python\nconn.execute(\"PRAGMA journal_mode=WAL\")\nconn.execute(\"PRAGMA busy_timeout=3000\")\nconn.execute(\"PRAGMA foreign_keys=ON\")\n```\n\n---\n\n## 4. APIs (Plugin Interface)\n\nThis plugin does not expose HTTP endpoints. Its \"API\" is the contract between OpenClaw Gateway and the plugin.\n\n### 4.1 Plugin Registration\n\n```python\n# openclaw_todo_plugin/__init__.py\n\ndef register(gateway):\n    \"\"\"Called by OpenClaw Gateway at startup.\n\n    Args:\n        gateway: OpenClaw gateway instance providing hooks for\n                 message handling and configuration access.\n    \"\"\"\n    from .plugin import TodoPlugin\n    plugin = TodoPlugin(gateway)\n    gateway.on_dm_message(plugin.handle)\n```\n\n### 4.2 Message Handler Contract\n\n```python\nclass TodoPlugin:\n    def handle(self, message: IncomingMessage) -> str | None:\n        \"\"\"Process a Slack DM. Return reply text or None to ignore.\"\"\"\n```\n\n`IncomingMessage` is an OpenClaw SDK type expected to carry at minimum:\n\n| Field        | Type | Description                     |\n|--------------|------|---------------------------------|\n| text         | str  | Raw message text                |\n| sender_id    | str  | Slack user ID of the sender     |\n| channel_id   | str  | DM channel ID                   |\n| timestamp    | str  | Slack message ts                |\n\n### 4.3 Command Routing\n\n`router.py` maps the second token of the message to a handler function:\n\n```python\nCOMMANDS = {\n    \"add\":     commands.add.handle,\n    \"list\":    commands.list_cmd.handle,\n    \"board\":   commands.board.handle,\n    \"move\":    commands.move.handle,\n    \"done\":    commands.done.handle,\n    \"drop\":    commands.drop.handle,\n    \"edit\":    commands.edit.handle,\n    \"project\": commands.project.handle,   # sub-routes internally\n}\n\ndef route(text: str, sender_id: str) -> str:\n    tokens = text.strip().split()\n    if not tokens or tokens[0] != \"/todo\":\n        return None\n    verb = tokens[1] if len(tokens) > 1 else \"help\"\n    handler = COMMANDS.get(verb)\n    if handler is None:\n        return f\"Unknown command: {verb}. Try /todo help\"\n    return handler(tokens[2:], sender_id)\n```\n\n### 4.4 Command Handler Signature\n\nEvery handler in `commands/` follows the same signature:\n\n```python\ndef handle(args: list[str], sender_id: str) -> str:\n    \"\"\"Execute the command and return a Slack-formatted reply string.\"\"\"\n```\n\n---\n\n## 5. Key Flows\n\n### 5.1 `/todo add` Flow\n\n```\nUser -> Gateway -> TodoPlugin.handle()\n  -> router.route() -> commands.add.handle()\n    -> parser.parse_add_args(tokens)        # extract title, mentions, /p, /s, due\n    -> date_utils.normalize_due(raw_due)    # MM-DD -> YYYY-MM-DD, validate\n    -> project_repo.resolve(name, sender)   # private-first resolution\n    -> permission.check_assignees(project, assignees, sender)  # private project guard\n    -> task_repo.create(task)               # INSERT task + task_assignees\n    -> event_repo.log(\"task.add\", ...)      # audit\n    -> formatters.format_add_confirm(task)  # reply string\n```\n\n### 5.2 `/todo project set-private` Flow\n\n```\ncommands.project.handle([\"set-private\", name], sender)\n  -> project_repo.resolve(name, sender)\n  -> IF already private: return \"already private\"\n  -> task_repo.find_non_owner_assignees(project_id, sender)\n  -> IF any found: return error with violating task IDs\n  -> project_repo.update_visibility(project_id, \"private\", sender)\n  -> event_repo.log(\"project.set_private\", ...)\n```\n\n---\n\n## 6. Jobs / Background Work\n\nThere are **no background jobs** in v1. All operations are synchronous request-response within the Gateway's message handler. Potential future jobs:\n\n| Job (future)           | Trigger         | Purpose                              |\n|------------------------|-----------------|--------------------------------------|\n| Due date reminders     | Cron / schedule | DM users about upcoming/overdue tasks|\n| Stale task cleanup     | Weekly          | Auto-drop tasks untouched > N days   |\n| DB vacuum              | Weekly          | Reclaim WAL space                    |\n\nThese would be registered via `gateway.schedule()` if the OpenClaw SDK supports it.\n\n---\n\n## 7. Observability\n\n### 7.1 Structured Logging\n\nAll modules use Python's `logging` module with a shared logger name `openclaw_todo`:\n\n```python\nimport logging\nlogger = logging.getLogger(\"openclaw_todo\")\n```\n\nLog levels:\n- **INFO**: command received (verb, sender_id, project), command completed.\n- **WARNING**: permission denied, invalid input, constraint violation.\n- **ERROR**: unexpected exceptions, DB errors.\n\n### 7.2 Audit Trail\n\nThe `events` table provides a queryable audit log. Every state-changing operation (add, edit, move, done, drop, project visibility change) writes an event row with the actor, action, affected task ID, and a JSON payload of the change delta.\n\n### 7.3 Metrics (future)\n\nIf the OpenClaw Gateway exposes a metrics interface, instrument:\n- `todo_commands_total` (counter, labels: verb, status)\n- `todo_command_duration_seconds` (histogram, labels: verb)\n- `todo_db_errors_total` (counter)\n\n### 7.4 Health Check\n\nThe plugin can expose a `health()` method that verifies the DB file exists and a simple `SELECT 1` succeeds.\n\n---\n\n## 8. Security\n\n### 8.1 Authentication\n\nAuthentication is delegated to Slack and the OpenClaw Gateway. The plugin trusts `sender_id` from the Gateway as the authenticated identity. No additional auth layer is needed.\n\n### 8.2 Authorization Model\n\n| Resource        | Read                                | Write                                      |\n|-----------------|-------------------------------------|--------------------------------------------|\n| Shared project  | Any user (scope-filtered)           | Assignee or created_by of the task         |\n| Private project | Owner only                          | Owner only                                 |\n\nAuthorization is enforced in `services/permission.py` and called by every command handler before any mutation.\n\n### 8.3 Input Validation\n\n- **SQL injection**: All queries use parameterized statements (`?` placeholders). No string interpolation in SQL.\n- **Slack mention validation**: Assignees must match the `<@U[A-Z0-9]+>` pattern. Arbitrary text is rejected.\n- **Due date validation**: Parsed through `datetime.date` -- invalid dates raise `ValueError` caught and returned as user-facing errors.\n- **Section/status enum**: Checked against a frozen set before reaching the DB. The DB CHECK constraint is a secondary guard.\n\n### 8.4 Data Isolation\n\nPrivate project data is filtered at the repository layer. Queries for private projects always include `WHERE owner_user_id = ?` to prevent data leakage even if a higher layer has a bug.\n\n### 8.5 Secrets\n\nNo API keys or secrets are stored by this plugin. The OpenClaw Gateway manages Slack API tokens.\n\n---\n\n## 9. Database Migration Strategy\n\n### 9.1 Version Table\n\n```sql\nCREATE TABLE IF NOT EXISTS schema_version (\n    version INTEGER NOT NULL\n);\nINSERT INTO schema_version (version) VALUES (0);\n```\n\n### 9.2 Migration Runner (`db/migrate.py`)\n\n```python\nMIGRATIONS = [\n    (1, \"v001_initial\", v001_initial.up),\n    # (2, \"v002_add_priority\", v002_add_priority.up),\n]\n\ndef run_migrations(conn: sqlite3.Connection) -> None:\n    current = _get_current_version(conn)\n    for version, name, up_fn in MIGRATIONS:\n        if version > current:\n            logger.info(\"Applying migration %s (%s)\", version, name)\n            up_fn(conn)\n            conn.execute(\"UPDATE schema_version SET version = ?\", (version,))\n            conn.commit()\n```\n\n### 9.3 Migration File Contract\n\nEach migration module in `db/migrations/` exports:\n\n```python\ndef up(conn: sqlite3.Connection) -> None:\n    \"\"\"Apply this migration forward.\"\"\"\n    conn.executescript(SQL)\n```\n\nDown migrations are not implemented in v1. Rollback is handled by restoring a DB backup (see section 10).\n\n### 9.4 Initialization Sequence\n\nOn first invocation or Gateway startup:\n\n1. Resolve DB path: `~/.openclaw/workspace/.todo/todo.sqlite3`\n2. Create directory if missing (`os.makedirs(..., exist_ok=True)`)\n3. Open connection with WAL pragmas\n4. Create `schema_version` table if not exists\n5. Run pending migrations\n6. Seed default `Inbox` shared project (idempotent `INSERT OR IGNORE`)\n\n---\n\n## 10. Deploy / Rollback\n\n### 10.1 Packaging\n\nThe plugin is distributed as a standard Python package installable via `uv add` or `pip install` (in the OpenClaw Gateway environment):\n\n```\npyproject.toml          # Package metadata, dependencies, entry points\nopenclaw_todo_plugin/   # Source\ntests/                  # Not included in distribution\n```\n\nEntry point for OpenClaw plugin discovery:\n\n```toml\n[project.entry-points.\"openclaw.plugins\"]\ntodo = \"openclaw_todo_plugin:register\"\n```\n\n### 10.2 Deployment Steps\n\n1. **Backup DB**: `cp todo.sqlite3 todo.sqlite3.bak.$(date +%s)`\n2. **Install new version**: `uv add openclaw-todo-plugin@<version>`\n3. **Restart Gateway**: migrations run automatically on startup\n4. **Verify**: send `/todo list` in DM, check logs for migration success\n\n### 10.3 Rollback Steps\n\n1. **Stop Gateway**\n2. **Restore DB** (if schema changed): `cp todo.sqlite3.bak.<ts> todo.sqlite3`\n3. **Install previous version**: `uv add openclaw-todo-plugin@<prev-version>`\n4. **Restart Gateway**\n\n### 10.4 Zero-Downtime Considerations\n\nSQLite does not support concurrent schema changes from multiple writers. Since there is a single Gateway process, migrations are safe without locking beyond SQLite's built-in WAL locking. If multi-process deployment is ever needed, migration must run as a separate step before starting workers.\n\n---\n\n## 11. Tradeoffs and Design Decisions\n\n### 11.1 SQLite vs. PostgreSQL\n\n**Chosen: SQLite.**\n\n| Factor          | SQLite                              | PostgreSQL                         |\n|-----------------|-------------------------------------|------------------------------------|\n| Ops complexity  | Zero (file on disk)                 | Requires running server            |\n| Concurrency     | Single-writer, good enough for DMs  | Full MVCC                          |\n| Scale ceiling   | ~100 concurrent users               | Thousands                          |\n| Backup          | File copy                           | pg_dump / replication              |\n| Migration       | Manual scripts                      | Alembic / django-migrations        |\n\nSQLite is the right choice for a plugin that handles single-digit QPS through Slack DMs. If the team outgrows it, the repository layer abstracts SQL enough that a PostgreSQL migration is localized to `db/` and `repositories/`.\n\n### 11.2 No ORM\n\nUsing raw `sqlite3` with parameterized queries. This avoids adding SQLAlchemy as a dependency for a plugin that has four tables. The repository layer provides the same abstraction boundary that an ORM session would.\n\n### 11.3 Synchronous Execution\n\nAll command handlers are synchronous. The OpenClaw Gateway may be async (asyncio), but SQLite operations are fast enough (sub-millisecond for typical queries) that blocking is acceptable. If the Gateway requires async handlers, a thin `asyncio.to_thread()` wrapper in `plugin.py` is sufficient.\n\n### 11.4 No Down Migrations\n\nForward-only migrations simplify the code and avoid the risk of data loss from buggy down scripts. Rollback relies on DB file backup, which is more reliable for SQLite.\n\n### 11.5 Private-First Name Resolution\n\nWhen a user references `/p MyProject`, the system checks for a private project owned by the sender before checking shared projects. This is the simplest model but can surprise users who have both a private and shared project with the same name. The PRD recommends against this pattern, and the plugin logs a warning when it detects the ambiguity.\n\n### 11.6 Repository Pattern vs. Direct SQL in Handlers\n\nAdds a small amount of indirection but pays for itself in testability. Tests can mock repositories instead of setting up SQLite fixtures for every command test. Integration tests still exercise the full stack.\n\n### 11.7 Formatter as a Separate Module\n\nSlack message formatting (mrkdwn, block kit) is isolated from business logic. If the plugin ever needs to support a second chat platform, only `formatters.py` changes.\n\n### 11.8 Event Sourcing vs. Audit Log\n\nThe `events` table is an append-only audit log, not a full event-sourcing system. State is stored directly in `tasks` and `projects`. This is simpler to query and reason about. Full event sourcing would be over-engineering for a TODO plugin.\n\n---\n\n## 12. Dependency Summary\n\n| Dependency        | Purpose                      | Required |\n|-------------------|------------------------------|----------|\n| Python 3.11+      | Runtime                      | Yes      |\n| sqlite3 (stdlib)  | Database                     | Yes      |\n| OpenClaw SDK      | Plugin registration, message hooks | Yes |\n| pytest             | Testing                      | Dev only |\n| pytest-cov         | Coverage reporting           | Dev only |\n| ruff               | Linting                      | Dev only |\n| black              | Formatting                   | Dev only |\n\nNo third-party runtime dependencies beyond the OpenClaw SDK itself.\n", "structuredPatch": [], "originalFile": null}, "tool_use_id": "toolu_01QK1c7j4yi1FaPoxTHo9rPD", "_ts": "2026-02-20T11:33:34+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "SubagentStop", "stop_hook_active": false, "agent_id": "a78d2f0", "agent_transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4/subagents/agent-a78d2f0.jsonl", "agent_type": "general-purpose", "_ts": "2026-02-20T11:33:34+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "SubagentStop", "stop_hook_active": false, "agent_id": "a85660f", "agent_transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4/subagents/agent-a85660f.jsonl", "agent_type": "", "_ts": "2026-02-20T11:33:40+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "SubagentStop", "stop_hook_active": false, "agent_id": "a57985d", "agent_transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4/subagents/agent-a57985d.jsonl", "agent_type": "architect", "_ts": "2026-02-20T11:33:47+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "SubagentStop", "stop_hook_active": false, "agent_id": "ac7594f", "agent_transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4/subagents/agent-ac7594f.jsonl", "agent_type": "", "_ts": "2026-02-20T11:33:52+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/docs/test_plan.md", "content": "# OpenClaw TODO Plugin -- Test Plan\n\n> Based on PRD v1.1 at `/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md`\n> Framework: **pytest** | DB: **SQLite3 (in-memory for tests)** | Date: 2026-02-20\n\n---\n\n## 1. Test Strategy\n\n### 1.1 Objectives\n\n- Validate all PRD acceptance criteria (Section 9).\n- Ensure parser correctness for mentions, `/p`, `/s`, `due:` tokens.\n- Verify DB schema creation, migration, and CRUD integrity.\n- Confirm access-control rules for private/shared projects.\n- Catch regressions early through an automatable smoke suite.\n\n### 1.2 Test Levels\n\n| Level | Scope | DB | Mocking |\n|---|---|---|---|\n| **Unit** | Parser functions, date normalization, individual command handlers | None or in-memory SQLite | Slack context mocked |\n| **Integration** | Full command flow: parse -> handler -> DB -> response | In-memory SQLite | Slack API mocked |\n| **E2E (lite)** | Multi-step scenarios (add then list, set-private with tasks) | Temp file SQLite | Slack API mocked |\n\n### 1.3 Principles\n\n- Every test must be **deterministic**. No real network calls; use `unittest.mock` or `pytest-mock`.\n- Date-sensitive tests must **freeze time** (e.g., `freezegun` or manual patching of `datetime.now`).\n- Tests touching SQLite use **in-memory** databases (`:memory:`) unless file-path behavior is explicitly under test.\n- Mark slow or file-I/O tests with `@pytest.mark.integration`.\n\n---\n\n## 2. Fixtures Guidance\n\n### 2.1 Core Fixtures (`conftest.py`)\n\n| Fixture | Scope | Purpose |\n|---|---|---|\n| `db_conn` | function | Returns a fresh in-memory SQLite connection with schema applied and `PRAGMA journal_mode=WAL; PRAGMA busy_timeout=3000;` set. Tears down after each test. |\n| `db_with_inbox` | function | Extends `db_conn`; also inserts the default shared `Inbox` project. |\n| `sender_ctx` | function | Returns a mock Slack sender context: `{\"user_id\": \"U_OWNER\", \"team_id\": \"T001\"}`. |\n| `other_user_ctx` | function | Returns a second mock user: `{\"user_id\": \"U_OTHER\", ...}`. |\n| `frozen_now` | function | Patches `datetime.now()` to `2026-02-20T09:00:00` (Asia/Seoul). |\n| `private_project` | function | Inserts a private project owned by `U_OWNER`. |\n| `shared_project` | function | Inserts a shared project (e.g., \"TeamWork\"). |\n| `sample_tasks` | function | Inserts a set of tasks across projects/sections for list/board tests. |\n\n### 2.2 Fixture Composition\n\nTests that need both a private project and sample tasks should compose fixtures:\n\n```\ndef test_example(db_with_inbox, private_project, sample_tasks, sender_ctx):\n    ...\n```\n\n---\n\n## 3. Test Cases -- Unit Tests\n\n### 3.1 Parser Module\n\n#### 3.1.1 Mention Extraction\n\n| ID | Description | Input | Expected |\n|---|---|---|---|\n| P-MEN-01 | Single mention extracted | `\"buy milk <@U123>\"` | assignees=`[\"U123\"]`, title=`\"buy milk\"` |\n| P-MEN-02 | Multiple mentions | `\"task <@U1> <@U2>\"` | assignees=`[\"U1\",\"U2\"]` |\n| P-MEN-03 | No mention defaults to sender | `\"buy milk\"` | assignees=`[sender_user_id]` |\n| P-MEN-04 | Mention-like text without `<@` ignored | `\"email @someone\"` | assignees=`[sender_user_id]`, title includes `\"@someone\"` |\n\n#### 3.1.2 Project Token (`/p`)\n\n| ID | Description | Input | Expected |\n|---|---|---|---|\n| P-PRJ-01 | Project parsed | `\"task /p MyProj\"` | project=`\"MyProj\"`, title=`\"task\"` |\n| P-PRJ-02 | No `/p` defaults to Inbox | `\"task\"` | project=`\"Inbox\"` |\n| P-PRJ-03 | `/p` at end of string | `\"task /p Work\"` | project=`\"Work\"` |\n| P-PRJ-04 | `/p` with no value is error | `\"task /p\"` | ParseError |\n\n#### 3.1.3 Section Token (`/s`)\n\n| ID | Description | Input | Expected |\n|---|---|---|---|\n| P-SEC-01 | Valid section parsed | `\"task /s doing\"` | section=`\"doing\"` |\n| P-SEC-02 | Default section is backlog | `\"task\"` | section=`\"backlog\"` |\n| P-SEC-03 | Invalid section rejected | `\"task /s invalid\"` | ParseError with message about valid sections |\n| P-SEC-04 | All 5 enum values accepted | `\"/s backlog\"`, `\"/s doing\"`, `\"/s waiting\"`, `\"/s done\"`, `\"/s drop\"` | Each parsed correctly |\n\n#### 3.1.4 Due Date Parsing\n\n| ID | Description | Input | Expected |\n|---|---|---|---|\n| P-DUE-01 | Full date `YYYY-MM-DD` | `\"due:2026-03-15\"` | `\"2026-03-15\"` |\n| P-DUE-02 | Short date `MM-DD` fills current year | `\"due:03-15\"` | `\"2026-03-15\"` (frozen year=2026) |\n| P-DUE-03 | Single-digit `M-D` | `\"due:3-5\"` | `\"2026-03-05\"` |\n| P-DUE-04 | Invalid date `02-30` | `\"due:02-30\"` | ParseError: invalid date |\n| P-DUE-05 | Due clear `due:-` | `\"due:-\"` | due=`None` (clear) |\n| P-DUE-06 | No due token | `\"task\"` | due=`None` |\n| P-DUE-07 | Leap year valid `02-29` | `\"due:2028-02-29\"` | `\"2028-02-29\"` |\n| P-DUE-08 | Non-leap year `02-29` | `\"due:2026-02-29\"` | ParseError |\n\n#### 3.1.5 Combined Parsing\n\n| ID | Description | Input | Expected |\n|---|---|---|---|\n| P-CMB-01 | All tokens present | `\"buy milk <@U1> /p Home /s doing due:03-20\"` | title=`\"buy milk\"`, assignees=`[\"U1\"]`, project=`\"Home\"`, section=`\"doing\"`, due=`\"2026-03-20\"` |\n| P-CMB-02 | Tokens in any order | `\"/p Home due:03-20 buy milk /s doing <@U1>\"` | Same as above |\n| P-CMB-03 | Title is empty when only tokens | `\"/p Home /s doing\"` | title=`\"\"` or ParseError (depends on command context) |\n\n---\n\n### 3.2 Due Date Normalization (standalone unit)\n\n| ID | Description | Input | Expected |\n|---|---|---|---|\n| D-NORM-01 | Year auto-fill uses server year | `\"06-15\"` with frozen year 2026 | `\"2026-06-15\"` |\n| D-NORM-02 | Full date passes through | `\"2025-12-01\"` | `\"2025-12-01\"` |\n| D-NORM-03 | Garbage input rejected | `\"abc\"` | ValueError |\n| D-NORM-04 | Empty string rejected | `\"\"` | ValueError |\n\n---\n\n### 3.3 DB Operations (schema and CRUD)\n\n#### 3.3.1 Schema Initialization\n\n| ID | Description | Steps | Expected |\n|---|---|---|---|\n| DB-INIT-01 | Fresh DB creates all tables | Initialize on `:memory:` | Tables `projects`, `tasks`, `task_assignees`, `events`, `schema_version` exist |\n| DB-INIT-02 | `schema_version` set to 1 | After init | `SELECT version FROM schema_version` returns `1` |\n| DB-INIT-03 | Default `Inbox` project created | After init | Shared project named `Inbox` exists |\n| DB-INIT-04 | WAL journal mode set | After init | `PRAGMA journal_mode` returns `wal` |\n| DB-INIT-05 | Idempotent init (run twice) | Init -> Init again | No error, schema unchanged |\n\n#### 3.3.2 Project CRUD\n\n| ID | Description | Steps | Expected |\n|---|---|---|---|\n| DB-PRJ-01 | Create shared project | Insert `(name=\"Work\", visibility=\"shared\")` | Row inserted, id returned |\n| DB-PRJ-02 | Duplicate shared name rejected | Insert `Inbox` again | UNIQUE constraint error |\n| DB-PRJ-03 | Create private project | Insert `(name=\"Personal\", visibility=\"private\", owner=\"U1\")` | Success |\n| DB-PRJ-04 | Same-name private for different owners | owner=U1 \"X\", owner=U2 \"X\" | Both succeed |\n| DB-PRJ-05 | Same-name private for same owner rejected | owner=U1 \"X\" twice | UNIQUE constraint error |\n| DB-PRJ-06 | Shared and private can share name | shared \"Work\" + private(U1) \"Work\" | Both exist |\n\n#### 3.3.3 Task CRUD\n\n| ID | Description | Steps | Expected |\n|---|---|---|---|\n| DB-TSK-01 | Insert task with all fields | Full insert | Row with auto-increment id |\n| DB-TSK-02 | Section enum enforced | Insert section=\"invalid\" | CHECK constraint error |\n| DB-TSK-03 | Status enum enforced | Insert status=\"pending\" | CHECK constraint error |\n| DB-TSK-04 | Assignees linked correctly | Insert task -> insert 2 assignees | `task_assignees` has 2 rows |\n| DB-TSK-05 | Update section | Change backlog -> doing | section updated, updated_at changed |\n| DB-TSK-06 | Mark done sets closed_at | `done` command | status=`done`, section=`done`, closed_at not null |\n\n---\n\n## 4. Test Cases -- Command Handlers\n\n### 4.1 `/todo add`\n\n| ID | Description | Input | Preconditions | Expected |\n|---|---|---|---|---|\n| CMD-ADD-01 | Basic add to Inbox | `add buy milk` | Inbox exists | Task in Inbox/backlog, assignee=sender |\n| CMD-ADD-02 | Add with project and section | `add task /p Work /s doing` | \"Work\" shared exists | Task in Work/doing |\n| CMD-ADD-03 | Add with assignees | `add task <@U2> <@U3>` | -- | assignees=[U2, U3] |\n| CMD-ADD-04 | Add with due date | `add task due:03-15` | -- | due=\"2026-03-15\" |\n| CMD-ADD-05 | Add to nonexistent project (Inbox auto-create) | `add task` | No Inbox | Inbox auto-created, task added |\n| CMD-ADD-06 | **REJECT**: Add to private project with non-owner assignee | `add task <@U_OTHER> /p MyPrivate` | MyPrivate is private, owner=sender | Warning message, task NOT created |\n| CMD-ADD-07 | Add to private project with owner assignee | `add task /p MyPrivate` | owner=sender | Task created successfully |\n| CMD-ADD-08 | Response format matches spec | `add buy milk` | -- | Response contains `#id`, project/section, due, assignees, title |\n\n### 4.2 `/todo list`\n\n| ID | Description | Input | Preconditions | Expected |\n|---|---|---|---|---|\n| CMD-LST-01 | Default list (mine, open) | `list` | Tasks exist | Only sender's open tasks |\n| CMD-LST-02 | List all | `list all` | Shared + private tasks | Shared all + sender's private only |\n| CMD-LST-03 | List by user | `list <@U2>` | U2 has tasks | Only U2's tasks |\n| CMD-LST-04 | Filter by project | `list /p Work` | -- | Only Work project tasks |\n| CMD-LST-05 | Filter by section | `list /s doing` | -- | Only doing section |\n| CMD-LST-06 | Limit applied | `list limit:5` | 10+ tasks | Exactly 5 returned |\n| CMD-LST-07 | Default limit is 30 | `list` | 50 tasks | 30 returned |\n| CMD-LST-08 | Sort order: due first, due asc, id desc | `list` | Mixed due/no-due tasks | Correct ordering |\n| CMD-LST-09 | **HIDDEN**: Other user's private project tasks not visible | `list all` | U_OTHER has private project with tasks | Those tasks excluded |\n| CMD-LST-10 | Status filters: done, drop | `list done` | -- | Only done/dropped tasks respectively |\n\n### 4.3 `/todo board`\n\n| ID | Description | Input | Preconditions | Expected |\n|---|---|---|---|---|\n| CMD-BRD-01 | Board shows all 5 sections in order | `board` | Tasks in various sections | BACKLOG -> DOING -> WAITING -> DONE -> DROP |\n| CMD-BRD-02 | Default scope is mine | `board` | -- | Only sender's tasks |\n| CMD-BRD-03 | limitPerSection applied | `board limitPerSection:2` | 5 tasks per section | 2 per section max |\n| CMD-BRD-04 | Private project tasks only for owner | `board all` | Private project tasks exist | Sender sees own private, not others' |\n\n### 4.4 `/todo move`\n\n| ID | Description | Input | Preconditions | Expected |\n|---|---|---|---|---|\n| CMD-MOV-01 | Move to valid section | `move 1 doing` | Task #1 in backlog | section=doing |\n| CMD-MOV-02 | Invalid section rejected | `move 1 invalid` | -- | Error: invalid section |\n| CMD-MOV-03 | **REJECT**: Non-owner moves private task | `move 1 doing` (sender=U_OTHER) | Task #1 in private project, owner=U_OWNER | Permission denied |\n| CMD-MOV-04 | Shared task: assignee can move | `move 1 doing` (sender=assignee) | -- | Success |\n| CMD-MOV-05 | Shared task: creator can move | `move 1 doing` (sender=created_by) | -- | Success |\n| CMD-MOV-06 | Nonexistent task id | `move 999 doing` | -- | Error: task not found |\n\n### 4.5 `/todo done`\n\n| ID | Description | Input | Preconditions | Expected |\n|---|---|---|---|---|\n| CMD-DON-01 | Mark task done | `done 1` | Task #1 open | section=done, status=done, closed_at set |\n| CMD-DON-02 | Already done task | `done 1` | Task #1 already done | Idempotent or informational message |\n| CMD-DON-03 | Permission check on private task | `done 1` (non-owner) | Private project | Denied |\n\n### 4.6 `/todo drop`\n\n| ID | Description | Input | Preconditions | Expected |\n|---|---|---|---|---|\n| CMD-DRP-01 | Drop task | `drop 1` | Task #1 open | section=drop, status=dropped, closed_at set |\n| CMD-DRP-02 | Permission check | `drop 1` (non-owner) | Private project | Denied |\n\n### 4.7 `/todo edit`\n\n| ID | Description | Input | Preconditions | Expected |\n|---|---|---|---|---|\n| CMD-EDT-01 | Edit title only | `edit 1 new title` | Task #1 exists | title updated |\n| CMD-EDT-02 | Edit assignees (replace) | `edit 1 <@U2> <@U3>` | -- | assignees fully replaced |\n| CMD-EDT-03 | Clear due | `edit 1 due:-` | Task has due | due=NULL |\n| CMD-EDT-04 | Change project | `edit 1 /p NewProj` | -- | project_id updated |\n| CMD-EDT-05 | Change section | `edit 1 /s waiting` | -- | section updated |\n| CMD-EDT-06 | **REJECT**: Edit in private project with non-owner assignee | `edit 1 <@U_OTHER>` | Task in private project, owner=sender | Warning, no change applied |\n| CMD-EDT-07 | **REJECT**: Move task to private project with non-owner assignee | `edit 1 /p PrivateProj` | Task has assignee U_OTHER | Warning, no change applied |\n| CMD-EDT-08 | No title change when only option tokens given | `edit 1 /s doing` | title=\"original\" | title remains \"original\" |\n| CMD-EDT-09 | Nonexistent task | `edit 999 new title` | -- | Error: task not found |\n\n---\n\n## 5. Test Cases -- Project Commands\n\n### 5.1 `/todo project list`\n\n| ID | Description | Sender | Expected |\n|---|---|---|---|\n| PRJ-LST-01 | Returns shared projects | U1 | All shared projects |\n| PRJ-LST-02 | Returns sender's private projects | U1 | Only U1's private projects |\n| PRJ-LST-03 | Does not return other user's private | U1 | U2's private excluded |\n\n### 5.2 `/todo project set-private`\n\n| ID | Description | Preconditions | Expected |\n|---|---|---|---|\n| PRJ-SPR-01 | Already private -- noop | Private \"X\" owned by sender | Success/noop message |\n| PRJ-SPR-02 | Shared to private -- no tasks | Shared \"X\" with 0 tasks | Converted: visibility=private, owner=sender |\n| PRJ-SPR-03 | Shared to private -- all tasks owner-assigned | Shared \"X\", all assignees=sender | Converted successfully |\n| PRJ-SPR-04 | **REJECT**: Shared to private -- non-owner assignees exist | Shared \"X\", task #12 has assignee U_OTHER | Error with task ids and assignee list |\n| PRJ-SPR-05 | Error message includes violating task ids | Same as PRJ-SPR-04 | Message contains `#12` and `<@U_OTHER>` |\n| PRJ-SPR-06 | Error caps listed violations at 10 | 15+ violating tasks | Max 10 task ids shown |\n| PRJ-SPR-07 | Neither exists -- create new private | No project \"X\" | New private project created, owner=sender |\n\n### 5.3 `/todo project set-shared`\n\n| ID | Description | Preconditions | Expected |\n|---|---|---|---|\n| PRJ-SSH-01 | Create new shared project | Name does not exist | Created |\n| PRJ-SSH-02 | Already shared -- noop | Shared \"X\" exists | No error, noop |\n| PRJ-SSH-03 | Name conflict with existing shared | Shared \"X\" exists, try set-shared \"X\" | Noop or \"already exists\" |\n\n---\n\n## 6. Test Cases -- Edge Cases and PRD-Specific Scenarios\n\n### 6.1 Project Name Collision Resolution (Option A: Private First)\n\n| ID | Description | Setup | Command | Expected |\n|---|---|---|---|---|\n| EDGE-COL-01 | Private and shared same name -- `/p` resolves to private | Private(U1) \"Work\" + Shared \"Work\" | `add task /p Work` (sender=U1) | Task added to **private** \"Work\" |\n| EDGE-COL-02 | No private -- falls to shared | Only shared \"Work\" | `add task /p Work` (sender=U1) | Task added to **shared** \"Work\" |\n| EDGE-COL-03 | Neither exists -- auto-create behavior | No \"NewProj\" | `add task /p NewProj` | Shared auto-create or error (per v1 policy) |\n\n### 6.2 Access Control Boundaries\n\n| ID | Description | Expected |\n|---|---|---|\n| EDGE-ACL-01 | Non-owner cannot list private project tasks | Empty result or error |\n| EDGE-ACL-02 | Non-owner cannot add to private project | Permission denied |\n| EDGE-ACL-03 | Non-owner cannot move/done/drop private task | Permission denied |\n| EDGE-ACL-04 | Non-owner cannot edit private task | Permission denied |\n\n### 6.3 Concurrency and DB Integrity\n\n| ID | Description | Expected |\n|---|---|---|\n| EDGE-DB-01 | Unique index prevents duplicate shared project names | UNIQUE constraint violation |\n| EDGE-DB-02 | Unique index allows same private name for different owners | Both inserted |\n| EDGE-DB-03 | WAL mode enabled on connection | `PRAGMA journal_mode` returns `wal` |\n\n### 6.4 Schema Migration\n\n| ID | Description | Expected |\n|---|---|---|\n| EDGE-MIG-01 | Fresh DB gets version 1 | schema_version=1 |\n| EDGE-MIG-02 | Re-init on existing DB is safe | No duplicate tables, version unchanged |\n| EDGE-MIG-03 | DB directory auto-created | `~/.openclaw/workspace/.todo/` created if missing |\n\n---\n\n## 7. Acceptance Criteria Traceability\n\nMapping each PRD acceptance criterion (Section 9) to test cases.\n\n| PRD Criterion | Test Case IDs |\n|---|---|\n| Shared project name collision rejected | DB-PRJ-02, PRJ-SSH-03, EDGE-COL-03 |\n| Private project owner-unique (cross-owner OK) | DB-PRJ-04, DB-PRJ-05, EDGE-DB-02 |\n| `set-private` rejects when non-owner assignees exist | PRJ-SPR-04, PRJ-SPR-05, PRJ-SPR-06 |\n| Private project + non-owner assignee = warning + reject | CMD-ADD-06, CMD-EDT-06, CMD-EDT-07 |\n| `due:MM-DD` fills current year | P-DUE-02, P-DUE-03, D-NORM-01 |\n| DB first-run: file + schema + Inbox | DB-INIT-01 through DB-INIT-05, EDGE-MIG-01, EDGE-MIG-03 |\n\n---\n\n## 8. Automation Candidates\n\n### 8.1 High Priority (automate first)\n\n| Area | Rationale |\n|---|---|\n| **Parser unit tests** (Section 3.1) | Pure functions, fast, high regression value. Run on every commit. |\n| **Due date normalization** (Section 3.2) | Date logic is error-prone; requires time-freezing. |\n| **DB schema init** (Section 3.3.1) | Catches migration regressions early. |\n| **Private project access control** (Sections 4, 5, 6.2) | Security-critical; must never regress. |\n\n### 8.2 Medium Priority\n\n| Area | Rationale |\n|---|---|\n| **Command handler integration** (Section 4) | Parse-to-DB flow; requires fixture setup but high coverage value. |\n| **Project name collision resolution** (Section 6.1) | Logic is subtle (Option A). |\n\n### 8.3 Lower Priority / Manual\n\n| Area | Rationale |\n|---|---|\n| **Response message formatting** | Cosmetic; snapshot testing if desired. |\n| **Concurrency under load** | Harder to automate reliably in CI; manual or stress-test script. |\n\n### 8.4 Suggested pytest Marks\n\n```python\n# conftest.py or pyproject.toml\nmarkers = [\n    \"unit: Pure unit tests (no DB, no I/O)\",\n    \"integration: Tests requiring DB or multi-component interaction\",\n    \"slow: Tests with file I/O or significant setup\",\n]\n```\n\n---\n\n## 9. Smoke Checklist\n\nA minimal set of tests to run before any release or deployment. If any fail, the build is not shippable.\n\n- [ ] **SMOKE-01**: DB initializes without error on empty state (DB-INIT-01)\n- [ ] **SMOKE-02**: Default `Inbox` project exists after init (DB-INIT-03)\n- [ ] **SMOKE-03**: `/todo add buy milk` creates a task in Inbox/backlog (CMD-ADD-01)\n- [ ] **SMOKE-04**: `/todo list` returns the just-added task (CMD-LST-01)\n- [ ] **SMOKE-05**: `/todo done <id>` marks task done with closed_at (CMD-DON-01)\n- [ ] **SMOKE-06**: `/todo add task <@U_OTHER> /p PrivateProj` is rejected (CMD-ADD-06)\n- [ ] **SMOKE-07**: `/todo project set-private` with non-owner assignees fails (PRJ-SPR-04)\n- [ ] **SMOKE-08**: `due:03-15` parses to `2026-03-15` (P-DUE-02)\n- [ ] **SMOKE-09**: Invalid due `due:02-30` returns error (P-DUE-04)\n- [ ] **SMOKE-10**: `/todo board` renders sections in correct order (CMD-BRD-01)\n\nRun with:\n```bash\nuv run pytest -m smoke -q --tb=short\n```\n\n---\n\n## 10. Test Directory Structure (Recommended)\n\n```\ntests/\n  conftest.py              # Shared fixtures (db_conn, sender_ctx, etc.)\n  test_parser.py           # 3.1 Parser tests (P-MEN, P-PRJ, P-SEC, P-DUE, P-CMB)\n  test_due_normalization.py # 3.2 Date normalization\n  test_db_schema.py        # 3.3.1 Schema init and migration\n  test_db_projects.py      # 3.3.2 Project CRUD\n  test_db_tasks.py         # 3.3.3 Task CRUD\n  test_cmd_add.py          # 4.1 /todo add\n  test_cmd_list.py         # 4.2 /todo list\n  test_cmd_board.py        # 4.3 /todo board\n  test_cmd_move.py         # 4.4 /todo move\n  test_cmd_done_drop.py    # 4.5-4.6 /todo done, drop\n  test_cmd_edit.py         # 4.7 /todo edit\n  test_project_cmds.py     # 5.1-5.3 project list/set-private/set-shared\n  test_edge_cases.py       # 6.x Edge cases and collision resolution\n```\n"}, "tool_use_id": "toolu_01ND4HFHoF4wNNjctmU6rd4T", "_ts": "2026-02-20T11:33:55+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/docs/test_plan.md", "content": "# OpenClaw TODO Plugin -- Test Plan\n\n> Based on PRD v1.1 at `/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md`\n> Framework: **pytest** | DB: **SQLite3 (in-memory for tests)** | Date: 2026-02-20\n\n---\n\n## 1. Test Strategy\n\n### 1.1 Objectives\n\n- Validate all PRD acceptance criteria (Section 9).\n- Ensure parser correctness for mentions, `/p`, `/s`, `due:` tokens.\n- Verify DB schema creation, migration, and CRUD integrity.\n- Confirm access-control rules for private/shared projects.\n- Catch regressions early through an automatable smoke suite.\n\n### 1.2 Test Levels\n\n| Level | Scope | DB | Mocking |\n|---|---|---|---|\n| **Unit** | Parser functions, date normalization, individual command handlers | None or in-memory SQLite | Slack context mocked |\n| **Integration** | Full command flow: parse -> handler -> DB -> response | In-memory SQLite | Slack API mocked |\n| **E2E (lite)** | Multi-step scenarios (add then list, set-private with tasks) | Temp file SQLite | Slack API mocked |\n\n### 1.3 Principles\n\n- Every test must be **deterministic**. No real network calls; use `unittest.mock` or `pytest-mock`.\n- Date-sensitive tests must **freeze time** (e.g., `freezegun` or manual patching of `datetime.now`).\n- Tests touching SQLite use **in-memory** databases (`:memory:`) unless file-path behavior is explicitly under test.\n- Mark slow or file-I/O tests with `@pytest.mark.integration`.\n\n---\n\n## 2. Fixtures Guidance\n\n### 2.1 Core Fixtures (`conftest.py`)\n\n| Fixture | Scope | Purpose |\n|---|---|---|\n| `db_conn` | function | Returns a fresh in-memory SQLite connection with schema applied and `PRAGMA journal_mode=WAL; PRAGMA busy_timeout=3000;` set. Tears down after each test. |\n| `db_with_inbox` | function | Extends `db_conn`; also inserts the default shared `Inbox` project. |\n| `sender_ctx` | function | Returns a mock Slack sender context: `{\"user_id\": \"U_OWNER\", \"team_id\": \"T001\"}`. |\n| `other_user_ctx` | function | Returns a second mock user: `{\"user_id\": \"U_OTHER\", ...}`. |\n| `frozen_now` | function | Patches `datetime.now()` to `2026-02-20T09:00:00` (Asia/Seoul). |\n| `private_project` | function | Inserts a private project owned by `U_OWNER`. |\n| `shared_project` | function | Inserts a shared project (e.g., \"TeamWork\"). |\n| `sample_tasks` | function | Inserts a set of tasks across projects/sections for list/board tests. |\n\n### 2.2 Fixture Composition\n\nTests that need both a private project and sample tasks should compose fixtures:\n\n```\ndef test_example(db_with_inbox, private_project, sample_tasks, sender_ctx):\n    ...\n```\n\n---\n\n## 3. Test Cases -- Unit Tests\n\n### 3.1 Parser Module\n\n#### 3.1.1 Mention Extraction\n\n| ID | Description | Input | Expected |\n|---|---|---|---|\n| P-MEN-01 | Single mention extracted | `\"buy milk <@U123>\"` | assignees=`[\"U123\"]`, title=`\"buy milk\"` |\n| P-MEN-02 | Multiple mentions | `\"task <@U1> <@U2>\"` | assignees=`[\"U1\",\"U2\"]` |\n| P-MEN-03 | No mention defaults to sender | `\"buy milk\"` | assignees=`[sender_user_id]` |\n| P-MEN-04 | Mention-like text without `<@` ignored | `\"email @someone\"` | assignees=`[sender_user_id]`, title includes `\"@someone\"` |\n\n#### 3.1.2 Project Token (`/p`)\n\n| ID | Description | Input | Expected |\n|---|---|---|---|\n| P-PRJ-01 | Project parsed | `\"task /p MyProj\"` | project=`\"MyProj\"`, title=`\"task\"` |\n| P-PRJ-02 | No `/p` defaults to Inbox | `\"task\"` | project=`\"Inbox\"` |\n| P-PRJ-03 | `/p` at end of string | `\"task /p Work\"` | project=`\"Work\"` |\n| P-PRJ-04 | `/p` with no value is error | `\"task /p\"` | ParseError |\n\n#### 3.1.3 Section Token (`/s`)\n\n| ID | Description | Input | Expected |\n|---|---|---|---|\n| P-SEC-01 | Valid section parsed | `\"task /s doing\"` | section=`\"doing\"` |\n| P-SEC-02 | Default section is backlog | `\"task\"` | section=`\"backlog\"` |\n| P-SEC-03 | Invalid section rejected | `\"task /s invalid\"` | ParseError with message about valid sections |\n| P-SEC-04 | All 5 enum values accepted | `\"/s backlog\"`, `\"/s doing\"`, `\"/s waiting\"`, `\"/s done\"`, `\"/s drop\"` | Each parsed correctly |\n\n#### 3.1.4 Due Date Parsing\n\n| ID | Description | Input | Expected |\n|---|---|---|---|\n| P-DUE-01 | Full date `YYYY-MM-DD` | `\"due:2026-03-15\"` | `\"2026-03-15\"` |\n| P-DUE-02 | Short date `MM-DD` fills current year | `\"due:03-15\"` | `\"2026-03-15\"` (frozen year=2026) |\n| P-DUE-03 | Single-digit `M-D` | `\"due:3-5\"` | `\"2026-03-05\"` |\n| P-DUE-04 | Invalid date `02-30` | `\"due:02-30\"` | ParseError: invalid date |\n| P-DUE-05 | Due clear `due:-` | `\"due:-\"` | due=`None` (clear) |\n| P-DUE-06 | No due token | `\"task\"` | due=`None` |\n| P-DUE-07 | Leap year valid `02-29` | `\"due:2028-02-29\"` | `\"2028-02-29\"` |\n| P-DUE-08 | Non-leap year `02-29` | `\"due:2026-02-29\"` | ParseError |\n\n#### 3.1.5 Combined Parsing\n\n| ID | Description | Input | Expected |\n|---|---|---|---|\n| P-CMB-01 | All tokens present | `\"buy milk <@U1> /p Home /s doing due:03-20\"` | title=`\"buy milk\"`, assignees=`[\"U1\"]`, project=`\"Home\"`, section=`\"doing\"`, due=`\"2026-03-20\"` |\n| P-CMB-02 | Tokens in any order | `\"/p Home due:03-20 buy milk /s doing <@U1>\"` | Same as above |\n| P-CMB-03 | Title is empty when only tokens | `\"/p Home /s doing\"` | title=`\"\"` or ParseError (depends on command context) |\n\n---\n\n### 3.2 Due Date Normalization (standalone unit)\n\n| ID | Description | Input | Expected |\n|---|---|---|---|\n| D-NORM-01 | Year auto-fill uses server year | `\"06-15\"` with frozen year 2026 | `\"2026-06-15\"` |\n| D-NORM-02 | Full date passes through | `\"2025-12-01\"` | `\"2025-12-01\"` |\n| D-NORM-03 | Garbage input rejected | `\"abc\"` | ValueError |\n| D-NORM-04 | Empty string rejected | `\"\"` | ValueError |\n\n---\n\n### 3.3 DB Operations (schema and CRUD)\n\n#### 3.3.1 Schema Initialization\n\n| ID | Description | Steps | Expected |\n|---|---|---|---|\n| DB-INIT-01 | Fresh DB creates all tables | Initialize on `:memory:` | Tables `projects`, `tasks`, `task_assignees`, `events`, `schema_version` exist |\n| DB-INIT-02 | `schema_version` set to 1 | After init | `SELECT version FROM schema_version` returns `1` |\n| DB-INIT-03 | Default `Inbox` project created | After init | Shared project named `Inbox` exists |\n| DB-INIT-04 | WAL journal mode set | After init | `PRAGMA journal_mode` returns `wal` |\n| DB-INIT-05 | Idempotent init (run twice) | Init -> Init again | No error, schema unchanged |\n\n#### 3.3.2 Project CRUD\n\n| ID | Description | Steps | Expected |\n|---|---|---|---|\n| DB-PRJ-01 | Create shared project | Insert `(name=\"Work\", visibility=\"shared\")` | Row inserted, id returned |\n| DB-PRJ-02 | Duplicate shared name rejected | Insert `Inbox` again | UNIQUE constraint error |\n| DB-PRJ-03 | Create private project | Insert `(name=\"Personal\", visibility=\"private\", owner=\"U1\")` | Success |\n| DB-PRJ-04 | Same-name private for different owners | owner=U1 \"X\", owner=U2 \"X\" | Both succeed |\n| DB-PRJ-05 | Same-name private for same owner rejected | owner=U1 \"X\" twice | UNIQUE constraint error |\n| DB-PRJ-06 | Shared and private can share name | shared \"Work\" + private(U1) \"Work\" | Both exist |\n\n#### 3.3.3 Task CRUD\n\n| ID | Description | Steps | Expected |\n|---|---|---|---|\n| DB-TSK-01 | Insert task with all fields | Full insert | Row with auto-increment id |\n| DB-TSK-02 | Section enum enforced | Insert section=\"invalid\" | CHECK constraint error |\n| DB-TSK-03 | Status enum enforced | Insert status=\"pending\" | CHECK constraint error |\n| DB-TSK-04 | Assignees linked correctly | Insert task -> insert 2 assignees | `task_assignees` has 2 rows |\n| DB-TSK-05 | Update section | Change backlog -> doing | section updated, updated_at changed |\n| DB-TSK-06 | Mark done sets closed_at | `done` command | status=`done`, section=`done`, closed_at not null |\n\n---\n\n## 4. Test Cases -- Command Handlers\n\n### 4.1 `/todo add`\n\n| ID | Description | Input | Preconditions | Expected |\n|---|---|---|---|---|\n| CMD-ADD-01 | Basic add to Inbox | `add buy milk` | Inbox exists | Task in Inbox/backlog, assignee=sender |\n| CMD-ADD-02 | Add with project and section | `add task /p Work /s doing` | \"Work\" shared exists | Task in Work/doing |\n| CMD-ADD-03 | Add with assignees | `add task <@U2> <@U3>` | -- | assignees=[U2, U3] |\n| CMD-ADD-04 | Add with due date | `add task due:03-15` | -- | due=\"2026-03-15\" |\n| CMD-ADD-05 | Add to nonexistent project (Inbox auto-create) | `add task` | No Inbox | Inbox auto-created, task added |\n| CMD-ADD-06 | **REJECT**: Add to private project with non-owner assignee | `add task <@U_OTHER> /p MyPrivate` | MyPrivate is private, owner=sender | Warning message, task NOT created |\n| CMD-ADD-07 | Add to private project with owner assignee | `add task /p MyPrivate` | owner=sender | Task created successfully |\n| CMD-ADD-08 | Response format matches spec | `add buy milk` | -- | Response contains `#id`, project/section, due, assignees, title |\n\n### 4.2 `/todo list`\n\n| ID | Description | Input | Preconditions | Expected |\n|---|---|---|---|---|\n| CMD-LST-01 | Default list (mine, open) | `list` | Tasks exist | Only sender's open tasks |\n| CMD-LST-02 | List all | `list all` | Shared + private tasks | Shared all + sender's private only |\n| CMD-LST-03 | List by user | `list <@U2>` | U2 has tasks | Only U2's tasks |\n| CMD-LST-04 | Filter by project | `list /p Work` | -- | Only Work project tasks |\n| CMD-LST-05 | Filter by section | `list /s doing` | -- | Only doing section |\n| CMD-LST-06 | Limit applied | `list limit:5` | 10+ tasks | Exactly 5 returned |\n| CMD-LST-07 | Default limit is 30 | `list` | 50 tasks | 30 returned |\n| CMD-LST-08 | Sort order: due first, due asc, id desc | `list` | Mixed due/no-due tasks | Correct ordering |\n| CMD-LST-09 | **HIDDEN**: Other user's private project tasks not visible | `list all` | U_OTHER has private project with tasks | Those tasks excluded |\n| CMD-LST-10 | Status filters: done, drop | `list done` | -- | Only done/dropped tasks respectively |\n\n### 4.3 `/todo board`\n\n| ID | Description | Input | Preconditions | Expected |\n|---|---|---|---|---|\n| CMD-BRD-01 | Board shows all 5 sections in order | `board` | Tasks in various sections | BACKLOG -> DOING -> WAITING -> DONE -> DROP |\n| CMD-BRD-02 | Default scope is mine | `board` | -- | Only sender's tasks |\n| CMD-BRD-03 | limitPerSection applied | `board limitPerSection:2` | 5 tasks per section | 2 per section max |\n| CMD-BRD-04 | Private project tasks only for owner | `board all` | Private project tasks exist | Sender sees own private, not others' |\n\n### 4.4 `/todo move`\n\n| ID | Description | Input | Preconditions | Expected |\n|---|---|---|---|---|\n| CMD-MOV-01 | Move to valid section | `move 1 doing` | Task #1 in backlog | section=doing |\n| CMD-MOV-02 | Invalid section rejected | `move 1 invalid` | -- | Error: invalid section |\n| CMD-MOV-03 | **REJECT**: Non-owner moves private task | `move 1 doing` (sender=U_OTHER) | Task #1 in private project, owner=U_OWNER | Permission denied |\n| CMD-MOV-04 | Shared task: assignee can move | `move 1 doing` (sender=assignee) | -- | Success |\n| CMD-MOV-05 | Shared task: creator can move | `move 1 doing` (sender=created_by) | -- | Success |\n| CMD-MOV-06 | Nonexistent task id | `move 999 doing` | -- | Error: task not found |\n\n### 4.5 `/todo done`\n\n| ID | Description | Input | Preconditions | Expected |\n|---|---|---|---|---|\n| CMD-DON-01 | Mark task done | `done 1` | Task #1 open | section=done, status=done, closed_at set |\n| CMD-DON-02 | Already done task | `done 1` | Task #1 already done | Idempotent or informational message |\n| CMD-DON-03 | Permission check on private task | `done 1` (non-owner) | Private project | Denied |\n\n### 4.6 `/todo drop`\n\n| ID | Description | Input | Preconditions | Expected |\n|---|---|---|---|---|\n| CMD-DRP-01 | Drop task | `drop 1` | Task #1 open | section=drop, status=dropped, closed_at set |\n| CMD-DRP-02 | Permission check | `drop 1` (non-owner) | Private project | Denied |\n\n### 4.7 `/todo edit`\n\n| ID | Description | Input | Preconditions | Expected |\n|---|---|---|---|---|\n| CMD-EDT-01 | Edit title only | `edit 1 new title` | Task #1 exists | title updated |\n| CMD-EDT-02 | Edit assignees (replace) | `edit 1 <@U2> <@U3>` | -- | assignees fully replaced |\n| CMD-EDT-03 | Clear due | `edit 1 due:-` | Task has due | due=NULL |\n| CMD-EDT-04 | Change project | `edit 1 /p NewProj` | -- | project_id updated |\n| CMD-EDT-05 | Change section | `edit 1 /s waiting` | -- | section updated |\n| CMD-EDT-06 | **REJECT**: Edit in private project with non-owner assignee | `edit 1 <@U_OTHER>` | Task in private project, owner=sender | Warning, no change applied |\n| CMD-EDT-07 | **REJECT**: Move task to private project with non-owner assignee | `edit 1 /p PrivateProj` | Task has assignee U_OTHER | Warning, no change applied |\n| CMD-EDT-08 | No title change when only option tokens given | `edit 1 /s doing` | title=\"original\" | title remains \"original\" |\n| CMD-EDT-09 | Nonexistent task | `edit 999 new title` | -- | Error: task not found |\n\n---\n\n## 5. Test Cases -- Project Commands\n\n### 5.1 `/todo project list`\n\n| ID | Description | Sender | Expected |\n|---|---|---|---|\n| PRJ-LST-01 | Returns shared projects | U1 | All shared projects |\n| PRJ-LST-02 | Returns sender's private projects | U1 | Only U1's private projects |\n| PRJ-LST-03 | Does not return other user's private | U1 | U2's private excluded |\n\n### 5.2 `/todo project set-private`\n\n| ID | Description | Preconditions | Expected |\n|---|---|---|---|\n| PRJ-SPR-01 | Already private -- noop | Private \"X\" owned by sender | Success/noop message |\n| PRJ-SPR-02 | Shared to private -- no tasks | Shared \"X\" with 0 tasks | Converted: visibility=private, owner=sender |\n| PRJ-SPR-03 | Shared to private -- all tasks owner-assigned | Shared \"X\", all assignees=sender | Converted successfully |\n| PRJ-SPR-04 | **REJECT**: Shared to private -- non-owner assignees exist | Shared \"X\", task #12 has assignee U_OTHER | Error with task ids and assignee list |\n| PRJ-SPR-05 | Error message includes violating task ids | Same as PRJ-SPR-04 | Message contains `#12` and `<@U_OTHER>` |\n| PRJ-SPR-06 | Error caps listed violations at 10 | 15+ violating tasks | Max 10 task ids shown |\n| PRJ-SPR-07 | Neither exists -- create new private | No project \"X\" | New private project created, owner=sender |\n\n### 5.3 `/todo project set-shared`\n\n| ID | Description | Preconditions | Expected |\n|---|---|---|---|\n| PRJ-SSH-01 | Create new shared project | Name does not exist | Created |\n| PRJ-SSH-02 | Already shared -- noop | Shared \"X\" exists | No error, noop |\n| PRJ-SSH-03 | Name conflict with existing shared | Shared \"X\" exists, try set-shared \"X\" | Noop or \"already exists\" |\n\n---\n\n## 6. Test Cases -- Edge Cases and PRD-Specific Scenarios\n\n### 6.1 Project Name Collision Resolution (Option A: Private First)\n\n| ID | Description | Setup | Command | Expected |\n|---|---|---|---|---|\n| EDGE-COL-01 | Private and shared same name -- `/p` resolves to private | Private(U1) \"Work\" + Shared \"Work\" | `add task /p Work` (sender=U1) | Task added to **private** \"Work\" |\n| EDGE-COL-02 | No private -- falls to shared | Only shared \"Work\" | `add task /p Work` (sender=U1) | Task added to **shared** \"Work\" |\n| EDGE-COL-03 | Neither exists -- auto-create behavior | No \"NewProj\" | `add task /p NewProj` | Shared auto-create or error (per v1 policy) |\n\n### 6.2 Access Control Boundaries\n\n| ID | Description | Expected |\n|---|---|---|\n| EDGE-ACL-01 | Non-owner cannot list private project tasks | Empty result or error |\n| EDGE-ACL-02 | Non-owner cannot add to private project | Permission denied |\n| EDGE-ACL-03 | Non-owner cannot move/done/drop private task | Permission denied |\n| EDGE-ACL-04 | Non-owner cannot edit private task | Permission denied |\n\n### 6.3 Concurrency and DB Integrity\n\n| ID | Description | Expected |\n|---|---|---|\n| EDGE-DB-01 | Unique index prevents duplicate shared project names | UNIQUE constraint violation |\n| EDGE-DB-02 | Unique index allows same private name for different owners | Both inserted |\n| EDGE-DB-03 | WAL mode enabled on connection | `PRAGMA journal_mode` returns `wal` |\n\n### 6.4 Schema Migration\n\n| ID | Description | Expected |\n|---|---|---|\n| EDGE-MIG-01 | Fresh DB gets version 1 | schema_version=1 |\n| EDGE-MIG-02 | Re-init on existing DB is safe | No duplicate tables, version unchanged |\n| EDGE-MIG-03 | DB directory auto-created | `~/.openclaw/workspace/.todo/` created if missing |\n\n---\n\n## 7. Acceptance Criteria Traceability\n\nMapping each PRD acceptance criterion (Section 9) to test cases.\n\n| PRD Criterion | Test Case IDs |\n|---|---|\n| Shared project name collision rejected | DB-PRJ-02, PRJ-SSH-03, EDGE-COL-03 |\n| Private project owner-unique (cross-owner OK) | DB-PRJ-04, DB-PRJ-05, EDGE-DB-02 |\n| `set-private` rejects when non-owner assignees exist | PRJ-SPR-04, PRJ-SPR-05, PRJ-SPR-06 |\n| Private project + non-owner assignee = warning + reject | CMD-ADD-06, CMD-EDT-06, CMD-EDT-07 |\n| `due:MM-DD` fills current year | P-DUE-02, P-DUE-03, D-NORM-01 |\n| DB first-run: file + schema + Inbox | DB-INIT-01 through DB-INIT-05, EDGE-MIG-01, EDGE-MIG-03 |\n\n---\n\n## 8. Automation Candidates\n\n### 8.1 High Priority (automate first)\n\n| Area | Rationale |\n|---|---|\n| **Parser unit tests** (Section 3.1) | Pure functions, fast, high regression value. Run on every commit. |\n| **Due date normalization** (Section 3.2) | Date logic is error-prone; requires time-freezing. |\n| **DB schema init** (Section 3.3.1) | Catches migration regressions early. |\n| **Private project access control** (Sections 4, 5, 6.2) | Security-critical; must never regress. |\n\n### 8.2 Medium Priority\n\n| Area | Rationale |\n|---|---|\n| **Command handler integration** (Section 4) | Parse-to-DB flow; requires fixture setup but high coverage value. |\n| **Project name collision resolution** (Section 6.1) | Logic is subtle (Option A). |\n\n### 8.3 Lower Priority / Manual\n\n| Area | Rationale |\n|---|---|\n| **Response message formatting** | Cosmetic; snapshot testing if desired. |\n| **Concurrency under load** | Harder to automate reliably in CI; manual or stress-test script. |\n\n### 8.4 Suggested pytest Marks\n\n```python\n# conftest.py or pyproject.toml\nmarkers = [\n    \"unit: Pure unit tests (no DB, no I/O)\",\n    \"integration: Tests requiring DB or multi-component interaction\",\n    \"slow: Tests with file I/O or significant setup\",\n]\n```\n\n---\n\n## 9. Smoke Checklist\n\nA minimal set of tests to run before any release or deployment. If any fail, the build is not shippable.\n\n- [ ] **SMOKE-01**: DB initializes without error on empty state (DB-INIT-01)\n- [ ] **SMOKE-02**: Default `Inbox` project exists after init (DB-INIT-03)\n- [ ] **SMOKE-03**: `/todo add buy milk` creates a task in Inbox/backlog (CMD-ADD-01)\n- [ ] **SMOKE-04**: `/todo list` returns the just-added task (CMD-LST-01)\n- [ ] **SMOKE-05**: `/todo done <id>` marks task done with closed_at (CMD-DON-01)\n- [ ] **SMOKE-06**: `/todo add task <@U_OTHER> /p PrivateProj` is rejected (CMD-ADD-06)\n- [ ] **SMOKE-07**: `/todo project set-private` with non-owner assignees fails (PRJ-SPR-04)\n- [ ] **SMOKE-08**: `due:03-15` parses to `2026-03-15` (P-DUE-02)\n- [ ] **SMOKE-09**: Invalid due `due:02-30` returns error (P-DUE-04)\n- [ ] **SMOKE-10**: `/todo board` renders sections in correct order (CMD-BRD-01)\n\nRun with:\n```bash\nuv run pytest -m smoke -q --tb=short\n```\n\n---\n\n## 10. Test Directory Structure (Recommended)\n\n```\ntests/\n  conftest.py              # Shared fixtures (db_conn, sender_ctx, etc.)\n  test_parser.py           # 3.1 Parser tests (P-MEN, P-PRJ, P-SEC, P-DUE, P-CMB)\n  test_due_normalization.py # 3.2 Date normalization\n  test_db_schema.py        # 3.3.1 Schema init and migration\n  test_db_projects.py      # 3.3.2 Project CRUD\n  test_db_tasks.py         # 3.3.3 Task CRUD\n  test_cmd_add.py          # 4.1 /todo add\n  test_cmd_list.py         # 4.2 /todo list\n  test_cmd_board.py        # 4.3 /todo board\n  test_cmd_move.py         # 4.4 /todo move\n  test_cmd_done_drop.py    # 4.5-4.6 /todo done, drop\n  test_cmd_edit.py         # 4.7 /todo edit\n  test_project_cmds.py     # 5.1-5.3 project list/set-private/set-shared\n  test_edge_cases.py       # 6.x Edge cases and collision resolution\n```\n"}, "tool_response": {"type": "create", "filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/docs/test_plan.md", "content": "# OpenClaw TODO Plugin -- Test Plan\n\n> Based on PRD v1.1 at `/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md`\n> Framework: **pytest** | DB: **SQLite3 (in-memory for tests)** | Date: 2026-02-20\n\n---\n\n## 1. Test Strategy\n\n### 1.1 Objectives\n\n- Validate all PRD acceptance criteria (Section 9).\n- Ensure parser correctness for mentions, `/p`, `/s`, `due:` tokens.\n- Verify DB schema creation, migration, and CRUD integrity.\n- Confirm access-control rules for private/shared projects.\n- Catch regressions early through an automatable smoke suite.\n\n### 1.2 Test Levels\n\n| Level | Scope | DB | Mocking |\n|---|---|---|---|\n| **Unit** | Parser functions, date normalization, individual command handlers | None or in-memory SQLite | Slack context mocked |\n| **Integration** | Full command flow: parse -> handler -> DB -> response | In-memory SQLite | Slack API mocked |\n| **E2E (lite)** | Multi-step scenarios (add then list, set-private with tasks) | Temp file SQLite | Slack API mocked |\n\n### 1.3 Principles\n\n- Every test must be **deterministic**. No real network calls; use `unittest.mock` or `pytest-mock`.\n- Date-sensitive tests must **freeze time** (e.g., `freezegun` or manual patching of `datetime.now`).\n- Tests touching SQLite use **in-memory** databases (`:memory:`) unless file-path behavior is explicitly under test.\n- Mark slow or file-I/O tests with `@pytest.mark.integration`.\n\n---\n\n## 2. Fixtures Guidance\n\n### 2.1 Core Fixtures (`conftest.py`)\n\n| Fixture | Scope | Purpose |\n|---|---|---|\n| `db_conn` | function | Returns a fresh in-memory SQLite connection with schema applied and `PRAGMA journal_mode=WAL; PRAGMA busy_timeout=3000;` set. Tears down after each test. |\n| `db_with_inbox` | function | Extends `db_conn`; also inserts the default shared `Inbox` project. |\n| `sender_ctx` | function | Returns a mock Slack sender context: `{\"user_id\": \"U_OWNER\", \"team_id\": \"T001\"}`. |\n| `other_user_ctx` | function | Returns a second mock user: `{\"user_id\": \"U_OTHER\", ...}`. |\n| `frozen_now` | function | Patches `datetime.now()` to `2026-02-20T09:00:00` (Asia/Seoul). |\n| `private_project` | function | Inserts a private project owned by `U_OWNER`. |\n| `shared_project` | function | Inserts a shared project (e.g., \"TeamWork\"). |\n| `sample_tasks` | function | Inserts a set of tasks across projects/sections for list/board tests. |\n\n### 2.2 Fixture Composition\n\nTests that need both a private project and sample tasks should compose fixtures:\n\n```\ndef test_example(db_with_inbox, private_project, sample_tasks, sender_ctx):\n    ...\n```\n\n---\n\n## 3. Test Cases -- Unit Tests\n\n### 3.1 Parser Module\n\n#### 3.1.1 Mention Extraction\n\n| ID | Description | Input | Expected |\n|---|---|---|---|\n| P-MEN-01 | Single mention extracted | `\"buy milk <@U123>\"` | assignees=`[\"U123\"]`, title=`\"buy milk\"` |\n| P-MEN-02 | Multiple mentions | `\"task <@U1> <@U2>\"` | assignees=`[\"U1\",\"U2\"]` |\n| P-MEN-03 | No mention defaults to sender | `\"buy milk\"` | assignees=`[sender_user_id]` |\n| P-MEN-04 | Mention-like text without `<@` ignored | `\"email @someone\"` | assignees=`[sender_user_id]`, title includes `\"@someone\"` |\n\n#### 3.1.2 Project Token (`/p`)\n\n| ID | Description | Input | Expected |\n|---|---|---|---|\n| P-PRJ-01 | Project parsed | `\"task /p MyProj\"` | project=`\"MyProj\"`, title=`\"task\"` |\n| P-PRJ-02 | No `/p` defaults to Inbox | `\"task\"` | project=`\"Inbox\"` |\n| P-PRJ-03 | `/p` at end of string | `\"task /p Work\"` | project=`\"Work\"` |\n| P-PRJ-04 | `/p` with no value is error | `\"task /p\"` | ParseError |\n\n#### 3.1.3 Section Token (`/s`)\n\n| ID | Description | Input | Expected |\n|---|---|---|---|\n| P-SEC-01 | Valid section parsed | `\"task /s doing\"` | section=`\"doing\"` |\n| P-SEC-02 | Default section is backlog | `\"task\"` | section=`\"backlog\"` |\n| P-SEC-03 | Invalid section rejected | `\"task /s invalid\"` | ParseError with message about valid sections |\n| P-SEC-04 | All 5 enum values accepted | `\"/s backlog\"`, `\"/s doing\"`, `\"/s waiting\"`, `\"/s done\"`, `\"/s drop\"` | Each parsed correctly |\n\n#### 3.1.4 Due Date Parsing\n\n| ID | Description | Input | Expected |\n|---|---|---|---|\n| P-DUE-01 | Full date `YYYY-MM-DD` | `\"due:2026-03-15\"` | `\"2026-03-15\"` |\n| P-DUE-02 | Short date `MM-DD` fills current year | `\"due:03-15\"` | `\"2026-03-15\"` (frozen year=2026) |\n| P-DUE-03 | Single-digit `M-D` | `\"due:3-5\"` | `\"2026-03-05\"` |\n| P-DUE-04 | Invalid date `02-30` | `\"due:02-30\"` | ParseError: invalid date |\n| P-DUE-05 | Due clear `due:-` | `\"due:-\"` | due=`None` (clear) |\n| P-DUE-06 | No due token | `\"task\"` | due=`None` |\n| P-DUE-07 | Leap year valid `02-29` | `\"due:2028-02-29\"` | `\"2028-02-29\"` |\n| P-DUE-08 | Non-leap year `02-29` | `\"due:2026-02-29\"` | ParseError |\n\n#### 3.1.5 Combined Parsing\n\n| ID | Description | Input | Expected |\n|---|---|---|---|\n| P-CMB-01 | All tokens present | `\"buy milk <@U1> /p Home /s doing due:03-20\"` | title=`\"buy milk\"`, assignees=`[\"U1\"]`, project=`\"Home\"`, section=`\"doing\"`, due=`\"2026-03-20\"` |\n| P-CMB-02 | Tokens in any order | `\"/p Home due:03-20 buy milk /s doing <@U1>\"` | Same as above |\n| P-CMB-03 | Title is empty when only tokens | `\"/p Home /s doing\"` | title=`\"\"` or ParseError (depends on command context) |\n\n---\n\n### 3.2 Due Date Normalization (standalone unit)\n\n| ID | Description | Input | Expected |\n|---|---|---|---|\n| D-NORM-01 | Year auto-fill uses server year | `\"06-15\"` with frozen year 2026 | `\"2026-06-15\"` |\n| D-NORM-02 | Full date passes through | `\"2025-12-01\"` | `\"2025-12-01\"` |\n| D-NORM-03 | Garbage input rejected | `\"abc\"` | ValueError |\n| D-NORM-04 | Empty string rejected | `\"\"` | ValueError |\n\n---\n\n### 3.3 DB Operations (schema and CRUD)\n\n#### 3.3.1 Schema Initialization\n\n| ID | Description | Steps | Expected |\n|---|---|---|---|\n| DB-INIT-01 | Fresh DB creates all tables | Initialize on `:memory:` | Tables `projects`, `tasks`, `task_assignees`, `events`, `schema_version` exist |\n| DB-INIT-02 | `schema_version` set to 1 | After init | `SELECT version FROM schema_version` returns `1` |\n| DB-INIT-03 | Default `Inbox` project created | After init | Shared project named `Inbox` exists |\n| DB-INIT-04 | WAL journal mode set | After init | `PRAGMA journal_mode` returns `wal` |\n| DB-INIT-05 | Idempotent init (run twice) | Init -> Init again | No error, schema unchanged |\n\n#### 3.3.2 Project CRUD\n\n| ID | Description | Steps | Expected |\n|---|---|---|---|\n| DB-PRJ-01 | Create shared project | Insert `(name=\"Work\", visibility=\"shared\")` | Row inserted, id returned |\n| DB-PRJ-02 | Duplicate shared name rejected | Insert `Inbox` again | UNIQUE constraint error |\n| DB-PRJ-03 | Create private project | Insert `(name=\"Personal\", visibility=\"private\", owner=\"U1\")` | Success |\n| DB-PRJ-04 | Same-name private for different owners | owner=U1 \"X\", owner=U2 \"X\" | Both succeed |\n| DB-PRJ-05 | Same-name private for same owner rejected | owner=U1 \"X\" twice | UNIQUE constraint error |\n| DB-PRJ-06 | Shared and private can share name | shared \"Work\" + private(U1) \"Work\" | Both exist |\n\n#### 3.3.3 Task CRUD\n\n| ID | Description | Steps | Expected |\n|---|---|---|---|\n| DB-TSK-01 | Insert task with all fields | Full insert | Row with auto-increment id |\n| DB-TSK-02 | Section enum enforced | Insert section=\"invalid\" | CHECK constraint error |\n| DB-TSK-03 | Status enum enforced | Insert status=\"pending\" | CHECK constraint error |\n| DB-TSK-04 | Assignees linked correctly | Insert task -> insert 2 assignees | `task_assignees` has 2 rows |\n| DB-TSK-05 | Update section | Change backlog -> doing | section updated, updated_at changed |\n| DB-TSK-06 | Mark done sets closed_at | `done` command | status=`done`, section=`done`, closed_at not null |\n\n---\n\n## 4. Test Cases -- Command Handlers\n\n### 4.1 `/todo add`\n\n| ID | Description | Input | Preconditions | Expected |\n|---|---|---|---|---|\n| CMD-ADD-01 | Basic add to Inbox | `add buy milk` | Inbox exists | Task in Inbox/backlog, assignee=sender |\n| CMD-ADD-02 | Add with project and section | `add task /p Work /s doing` | \"Work\" shared exists | Task in Work/doing |\n| CMD-ADD-03 | Add with assignees | `add task <@U2> <@U3>` | -- | assignees=[U2, U3] |\n| CMD-ADD-04 | Add with due date | `add task due:03-15` | -- | due=\"2026-03-15\" |\n| CMD-ADD-05 | Add to nonexistent project (Inbox auto-create) | `add task` | No Inbox | Inbox auto-created, task added |\n| CMD-ADD-06 | **REJECT**: Add to private project with non-owner assignee | `add task <@U_OTHER> /p MyPrivate` | MyPrivate is private, owner=sender | Warning message, task NOT created |\n| CMD-ADD-07 | Add to private project with owner assignee | `add task /p MyPrivate` | owner=sender | Task created successfully |\n| CMD-ADD-08 | Response format matches spec | `add buy milk` | -- | Response contains `#id`, project/section, due, assignees, title |\n\n### 4.2 `/todo list`\n\n| ID | Description | Input | Preconditions | Expected |\n|---|---|---|---|---|\n| CMD-LST-01 | Default list (mine, open) | `list` | Tasks exist | Only sender's open tasks |\n| CMD-LST-02 | List all | `list all` | Shared + private tasks | Shared all + sender's private only |\n| CMD-LST-03 | List by user | `list <@U2>` | U2 has tasks | Only U2's tasks |\n| CMD-LST-04 | Filter by project | `list /p Work` | -- | Only Work project tasks |\n| CMD-LST-05 | Filter by section | `list /s doing` | -- | Only doing section |\n| CMD-LST-06 | Limit applied | `list limit:5` | 10+ tasks | Exactly 5 returned |\n| CMD-LST-07 | Default limit is 30 | `list` | 50 tasks | 30 returned |\n| CMD-LST-08 | Sort order: due first, due asc, id desc | `list` | Mixed due/no-due tasks | Correct ordering |\n| CMD-LST-09 | **HIDDEN**: Other user's private project tasks not visible | `list all` | U_OTHER has private project with tasks | Those tasks excluded |\n| CMD-LST-10 | Status filters: done, drop | `list done` | -- | Only done/dropped tasks respectively |\n\n### 4.3 `/todo board`\n\n| ID | Description | Input | Preconditions | Expected |\n|---|---|---|---|---|\n| CMD-BRD-01 | Board shows all 5 sections in order | `board` | Tasks in various sections | BACKLOG -> DOING -> WAITING -> DONE -> DROP |\n| CMD-BRD-02 | Default scope is mine | `board` | -- | Only sender's tasks |\n| CMD-BRD-03 | limitPerSection applied | `board limitPerSection:2` | 5 tasks per section | 2 per section max |\n| CMD-BRD-04 | Private project tasks only for owner | `board all` | Private project tasks exist | Sender sees own private, not others' |\n\n### 4.4 `/todo move`\n\n| ID | Description | Input | Preconditions | Expected |\n|---|---|---|---|---|\n| CMD-MOV-01 | Move to valid section | `move 1 doing` | Task #1 in backlog | section=doing |\n| CMD-MOV-02 | Invalid section rejected | `move 1 invalid` | -- | Error: invalid section |\n| CMD-MOV-03 | **REJECT**: Non-owner moves private task | `move 1 doing` (sender=U_OTHER) | Task #1 in private project, owner=U_OWNER | Permission denied |\n| CMD-MOV-04 | Shared task: assignee can move | `move 1 doing` (sender=assignee) | -- | Success |\n| CMD-MOV-05 | Shared task: creator can move | `move 1 doing` (sender=created_by) | -- | Success |\n| CMD-MOV-06 | Nonexistent task id | `move 999 doing` | -- | Error: task not found |\n\n### 4.5 `/todo done`\n\n| ID | Description | Input | Preconditions | Expected |\n|---|---|---|---|---|\n| CMD-DON-01 | Mark task done | `done 1` | Task #1 open | section=done, status=done, closed_at set |\n| CMD-DON-02 | Already done task | `done 1` | Task #1 already done | Idempotent or informational message |\n| CMD-DON-03 | Permission check on private task | `done 1` (non-owner) | Private project | Denied |\n\n### 4.6 `/todo drop`\n\n| ID | Description | Input | Preconditions | Expected |\n|---|---|---|---|---|\n| CMD-DRP-01 | Drop task | `drop 1` | Task #1 open | section=drop, status=dropped, closed_at set |\n| CMD-DRP-02 | Permission check | `drop 1` (non-owner) | Private project | Denied |\n\n### 4.7 `/todo edit`\n\n| ID | Description | Input | Preconditions | Expected |\n|---|---|---|---|---|\n| CMD-EDT-01 | Edit title only | `edit 1 new title` | Task #1 exists | title updated |\n| CMD-EDT-02 | Edit assignees (replace) | `edit 1 <@U2> <@U3>` | -- | assignees fully replaced |\n| CMD-EDT-03 | Clear due | `edit 1 due:-` | Task has due | due=NULL |\n| CMD-EDT-04 | Change project | `edit 1 /p NewProj` | -- | project_id updated |\n| CMD-EDT-05 | Change section | `edit 1 /s waiting` | -- | section updated |\n| CMD-EDT-06 | **REJECT**: Edit in private project with non-owner assignee | `edit 1 <@U_OTHER>` | Task in private project, owner=sender | Warning, no change applied |\n| CMD-EDT-07 | **REJECT**: Move task to private project with non-owner assignee | `edit 1 /p PrivateProj` | Task has assignee U_OTHER | Warning, no change applied |\n| CMD-EDT-08 | No title change when only option tokens given | `edit 1 /s doing` | title=\"original\" | title remains \"original\" |\n| CMD-EDT-09 | Nonexistent task | `edit 999 new title` | -- | Error: task not found |\n\n---\n\n## 5. Test Cases -- Project Commands\n\n### 5.1 `/todo project list`\n\n| ID | Description | Sender | Expected |\n|---|---|---|---|\n| PRJ-LST-01 | Returns shared projects | U1 | All shared projects |\n| PRJ-LST-02 | Returns sender's private projects | U1 | Only U1's private projects |\n| PRJ-LST-03 | Does not return other user's private | U1 | U2's private excluded |\n\n### 5.2 `/todo project set-private`\n\n| ID | Description | Preconditions | Expected |\n|---|---|---|---|\n| PRJ-SPR-01 | Already private -- noop | Private \"X\" owned by sender | Success/noop message |\n| PRJ-SPR-02 | Shared to private -- no tasks | Shared \"X\" with 0 tasks | Converted: visibility=private, owner=sender |\n| PRJ-SPR-03 | Shared to private -- all tasks owner-assigned | Shared \"X\", all assignees=sender | Converted successfully |\n| PRJ-SPR-04 | **REJECT**: Shared to private -- non-owner assignees exist | Shared \"X\", task #12 has assignee U_OTHER | Error with task ids and assignee list |\n| PRJ-SPR-05 | Error message includes violating task ids | Same as PRJ-SPR-04 | Message contains `#12` and `<@U_OTHER>` |\n| PRJ-SPR-06 | Error caps listed violations at 10 | 15+ violating tasks | Max 10 task ids shown |\n| PRJ-SPR-07 | Neither exists -- create new private | No project \"X\" | New private project created, owner=sender |\n\n### 5.3 `/todo project set-shared`\n\n| ID | Description | Preconditions | Expected |\n|---|---|---|---|\n| PRJ-SSH-01 | Create new shared project | Name does not exist | Created |\n| PRJ-SSH-02 | Already shared -- noop | Shared \"X\" exists | No error, noop |\n| PRJ-SSH-03 | Name conflict with existing shared | Shared \"X\" exists, try set-shared \"X\" | Noop or \"already exists\" |\n\n---\n\n## 6. Test Cases -- Edge Cases and PRD-Specific Scenarios\n\n### 6.1 Project Name Collision Resolution (Option A: Private First)\n\n| ID | Description | Setup | Command | Expected |\n|---|---|---|---|---|\n| EDGE-COL-01 | Private and shared same name -- `/p` resolves to private | Private(U1) \"Work\" + Shared \"Work\" | `add task /p Work` (sender=U1) | Task added to **private** \"Work\" |\n| EDGE-COL-02 | No private -- falls to shared | Only shared \"Work\" | `add task /p Work` (sender=U1) | Task added to **shared** \"Work\" |\n| EDGE-COL-03 | Neither exists -- auto-create behavior | No \"NewProj\" | `add task /p NewProj` | Shared auto-create or error (per v1 policy) |\n\n### 6.2 Access Control Boundaries\n\n| ID | Description | Expected |\n|---|---|---|\n| EDGE-ACL-01 | Non-owner cannot list private project tasks | Empty result or error |\n| EDGE-ACL-02 | Non-owner cannot add to private project | Permission denied |\n| EDGE-ACL-03 | Non-owner cannot move/done/drop private task | Permission denied |\n| EDGE-ACL-04 | Non-owner cannot edit private task | Permission denied |\n\n### 6.3 Concurrency and DB Integrity\n\n| ID | Description | Expected |\n|---|---|---|\n| EDGE-DB-01 | Unique index prevents duplicate shared project names | UNIQUE constraint violation |\n| EDGE-DB-02 | Unique index allows same private name for different owners | Both inserted |\n| EDGE-DB-03 | WAL mode enabled on connection | `PRAGMA journal_mode` returns `wal` |\n\n### 6.4 Schema Migration\n\n| ID | Description | Expected |\n|---|---|---|\n| EDGE-MIG-01 | Fresh DB gets version 1 | schema_version=1 |\n| EDGE-MIG-02 | Re-init on existing DB is safe | No duplicate tables, version unchanged |\n| EDGE-MIG-03 | DB directory auto-created | `~/.openclaw/workspace/.todo/` created if missing |\n\n---\n\n## 7. Acceptance Criteria Traceability\n\nMapping each PRD acceptance criterion (Section 9) to test cases.\n\n| PRD Criterion | Test Case IDs |\n|---|---|\n| Shared project name collision rejected | DB-PRJ-02, PRJ-SSH-03, EDGE-COL-03 |\n| Private project owner-unique (cross-owner OK) | DB-PRJ-04, DB-PRJ-05, EDGE-DB-02 |\n| `set-private` rejects when non-owner assignees exist | PRJ-SPR-04, PRJ-SPR-05, PRJ-SPR-06 |\n| Private project + non-owner assignee = warning + reject | CMD-ADD-06, CMD-EDT-06, CMD-EDT-07 |\n| `due:MM-DD` fills current year | P-DUE-02, P-DUE-03, D-NORM-01 |\n| DB first-run: file + schema + Inbox | DB-INIT-01 through DB-INIT-05, EDGE-MIG-01, EDGE-MIG-03 |\n\n---\n\n## 8. Automation Candidates\n\n### 8.1 High Priority (automate first)\n\n| Area | Rationale |\n|---|---|\n| **Parser unit tests** (Section 3.1) | Pure functions, fast, high regression value. Run on every commit. |\n| **Due date normalization** (Section 3.2) | Date logic is error-prone; requires time-freezing. |\n| **DB schema init** (Section 3.3.1) | Catches migration regressions early. |\n| **Private project access control** (Sections 4, 5, 6.2) | Security-critical; must never regress. |\n\n### 8.2 Medium Priority\n\n| Area | Rationale |\n|---|---|\n| **Command handler integration** (Section 4) | Parse-to-DB flow; requires fixture setup but high coverage value. |\n| **Project name collision resolution** (Section 6.1) | Logic is subtle (Option A). |\n\n### 8.3 Lower Priority / Manual\n\n| Area | Rationale |\n|---|---|\n| **Response message formatting** | Cosmetic; snapshot testing if desired. |\n| **Concurrency under load** | Harder to automate reliably in CI; manual or stress-test script. |\n\n### 8.4 Suggested pytest Marks\n\n```python\n# conftest.py or pyproject.toml\nmarkers = [\n    \"unit: Pure unit tests (no DB, no I/O)\",\n    \"integration: Tests requiring DB or multi-component interaction\",\n    \"slow: Tests with file I/O or significant setup\",\n]\n```\n\n---\n\n## 9. Smoke Checklist\n\nA minimal set of tests to run before any release or deployment. If any fail, the build is not shippable.\n\n- [ ] **SMOKE-01**: DB initializes without error on empty state (DB-INIT-01)\n- [ ] **SMOKE-02**: Default `Inbox` project exists after init (DB-INIT-03)\n- [ ] **SMOKE-03**: `/todo add buy milk` creates a task in Inbox/backlog (CMD-ADD-01)\n- [ ] **SMOKE-04**: `/todo list` returns the just-added task (CMD-LST-01)\n- [ ] **SMOKE-05**: `/todo done <id>` marks task done with closed_at (CMD-DON-01)\n- [ ] **SMOKE-06**: `/todo add task <@U_OTHER> /p PrivateProj` is rejected (CMD-ADD-06)\n- [ ] **SMOKE-07**: `/todo project set-private` with non-owner assignees fails (PRJ-SPR-04)\n- [ ] **SMOKE-08**: `due:03-15` parses to `2026-03-15` (P-DUE-02)\n- [ ] **SMOKE-09**: Invalid due `due:02-30` returns error (P-DUE-04)\n- [ ] **SMOKE-10**: `/todo board` renders sections in correct order (CMD-BRD-01)\n\nRun with:\n```bash\nuv run pytest -m smoke -q --tb=short\n```\n\n---\n\n## 10. Test Directory Structure (Recommended)\n\n```\ntests/\n  conftest.py              # Shared fixtures (db_conn, sender_ctx, etc.)\n  test_parser.py           # 3.1 Parser tests (P-MEN, P-PRJ, P-SEC, P-DUE, P-CMB)\n  test_due_normalization.py # 3.2 Date normalization\n  test_db_schema.py        # 3.3.1 Schema init and migration\n  test_db_projects.py      # 3.3.2 Project CRUD\n  test_db_tasks.py         # 3.3.3 Task CRUD\n  test_cmd_add.py          # 4.1 /todo add\n  test_cmd_list.py         # 4.2 /todo list\n  test_cmd_board.py        # 4.3 /todo board\n  test_cmd_move.py         # 4.4 /todo move\n  test_cmd_done_drop.py    # 4.5-4.6 /todo done, drop\n  test_cmd_edit.py         # 4.7 /todo edit\n  test_project_cmds.py     # 5.1-5.3 project list/set-private/set-shared\n  test_edge_cases.py       # 6.x Edge cases and collision resolution\n```\n", "structuredPatch": [], "originalFile": null}, "tool_use_id": "toolu_01ND4HFHoF4wNNjctmU6rd4T", "_ts": "2026-02-20T11:33:56+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "SubagentStop", "stop_hook_active": false, "agent_id": "a03d4ab", "agent_transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4/subagents/agent-a03d4ab.jsonl", "agent_type": "qa-designer", "_ts": "2026-02-20T11:34:09+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "SubagentStop", "stop_hook_active": false, "agent_id": "a90351a", "agent_transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4/subagents/agent-a90351a.jsonl", "agent_type": "", "_ts": "2026-02-20T11:34:13+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md", "content": "# OpenClaw TODO Plugin -- Issues\n\n> Auto-generated from `openclaw_todo_plugin_prd.md` (PRD v1.1)\n> Date: 2026-02-20\n\n---\n\n## Issue #1: Plugin skeleton and entry point\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M0                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/001-plugin-skeleton`          |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nCreate the Python project scaffold: `pyproject.toml` (uv), `src/openclaw_todo/` package layout, and the plugin entry-point that the OpenClaw gateway will load. The plugin must expose a callable that receives raw Slack DM text and a sender context dict.\n\n**Acceptance Criteria**\n- [ ] `pyproject.toml` exists with Python >=3.11, pytest, pytest-cov dev deps\n- [ ] `src/openclaw_todo/__init__.py` exposes `__version__`\n- [ ] `src/openclaw_todo/plugin.py` contains `handle_message(text: str, context: dict) -> str` entry point\n- [ ] Messages not starting with `/todo` are silently ignored (returns `None`)\n- [ ] `uv sync && uv run pytest -q` passes (trivial smoke test)\n\n**Tests**\n- `tests/test_plugin.py::test_ignores_non_todo_message`\n- `tests/test_plugin.py::test_dispatches_todo_prefix`\n\n**Rollback**\nDelete branch; no runtime dependency.\n\n**Observability**\n`logger.debug` on every inbound message; `logger.info` when `/todo` prefix matched.\n\n**Dependencies**\nNone.\n\n---\n\n## Issue #2: DB module -- connection helper and pragma setup\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend / Data                         |\n| Milestone   | M1                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/002-db-connection`            |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `src/openclaw_todo/db.py` with a `get_connection(db_path)` helper that creates the `~/.openclaw/workspace/.todo/` directory tree if missing, opens (or creates) `todo.sqlite3`, and applies `PRAGMA journal_mode=WAL` and `PRAGMA busy_timeout=3000`.\n\n**Acceptance Criteria**\n- [ ] Directory is created recursively when absent\n- [ ] SQLite connection returned with WAL mode enabled\n- [ ] `busy_timeout` is 3000\n- [ ] Calling `get_connection` twice returns usable connections (no lock conflict)\n\n**Tests**\n- `tests/test_db.py::test_creates_directory_and_file` (tmp_path)\n- `tests/test_db.py::test_wal_mode_enabled`\n- `tests/test_db.py::test_busy_timeout`\n\n**Rollback**\nRevert module; no schema changes yet.\n\n**Observability**\n`logger.info` on first DB creation; `logger.debug` on each connection open.\n\n**Dependencies**\n#1\n\n---\n\n## Issue #3: Schema migration framework and schema_version table\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend / Data                         |\n| Milestone   | M1                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/003-schema-migration`         |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement a simple sequential migration runner. On startup, read `schema_version` (create if missing), compare to available migrations list, and apply outstanding migrations in order inside a transaction.\n\n**Acceptance Criteria**\n- [ ] `schema_version` table created with single row `version=0` if absent\n- [ ] Migrations are Python callables registered in an ordered list\n- [ ] Each migration runs inside a transaction; version incremented on success\n- [ ] Re-running on an up-to-date DB is a no-op\n- [ ] Failing migration rolls back and raises with clear message\n\n**Tests**\n- `tests/test_migrations.py::test_fresh_db_gets_version_table`\n- `tests/test_migrations.py::test_applies_migrations_sequentially`\n- `tests/test_migrations.py::test_idempotent_on_rerun`\n- `tests/test_migrations.py::test_rollback_on_failure`\n\n**Rollback**\nDrop `schema_version` table; revert module.\n\n**Observability**\n`logger.info(\"Migrating from version %d to %d\", current, target)` per step.\n\n**Dependencies**\n#2\n\n---\n\n## Issue #4: V1 schema migration -- projects, tasks, task_assignees, events\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend / Data                         |\n| Milestone   | M1                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/004-v1-schema`                |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nRegister migration v1 that creates the four tables (`projects`, `tasks`, `task_assignees`, `events`) with all columns, CHECK constraints, and partial unique indexes as specified in PRD section 6.3. Also seed shared project `Inbox`.\n\n**Acceptance Criteria**\n- [ ] `projects` table with `ux_projects_shared_name` and `ux_projects_private_owner_name` partial unique indexes\n- [ ] `tasks` table with section and status CHECK constraints\n- [ ] `task_assignees` table with composite PK and secondary index\n- [ ] `events` audit table created\n- [ ] Shared `Inbox` project auto-created (INSERT OR IGNORE)\n- [ ] `schema_version` = 1 after migration\n\n**Tests**\n- `tests/test_migrations.py::test_v1_tables_exist`\n- `tests/test_migrations.py::test_v1_inbox_created`\n- `tests/test_migrations.py::test_v1_shared_unique_index_enforced`\n- `tests/test_migrations.py::test_v1_private_unique_index_enforced`\n\n**Rollback**\nDrop all four tables + reset schema_version to 0.\n\n**Observability**\nLog table creation counts.\n\n**Dependencies**\n#3\n\n---\n\n## Issue #5: Command parser -- tokenizer and option extraction\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M2                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/005-parser-tokenizer`         |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `src/openclaw_todo/parser.py` that takes raw message text (after `/todo` prefix) and returns a `ParsedCommand` dataclass containing: `command` (str), `args` (list), `project` (str|None), `section` (str|None), `due` (str|None, normalised to YYYY-MM-DD), `mentions` (list of Slack user IDs), and remaining `title_tokens`.\n\nParsing rules:\n- `/p <name>` extracts project\n- `/s <section>` extracts section (validate against enum)\n- `due:YYYY-MM-DD` or `due:MM-DD` extracts and normalises due date\n- `due:-` clears due (sentinel)\n- `<@U...>` patterns extracted as mentions\n- Everything else before first option token is title\n\n**Acceptance Criteria**\n- [ ] `/p MyProject` correctly extracted; token consumed\n- [ ] `/s doing` validated; invalid section raises `ParseError`\n- [ ] `due:03-15` normalised to `2026-03-15`\n- [ ] `due:2026-02-30` raises `ParseError` (invalid date)\n- [ ] `<@U12345>` extracted into mentions list\n- [ ] Multiple mentions supported\n- [ ] Title tokens are non-option, non-mention tokens before first option\n\n**Tests**\n- `tests/test_parser.py::test_extract_project`\n- `tests/test_parser.py::test_extract_section_valid`\n- `tests/test_parser.py::test_extract_section_invalid`\n- `tests/test_parser.py::test_due_mm_dd_normalisation`\n- `tests/test_parser.py::test_due_full_date`\n- `tests/test_parser.py::test_due_invalid_date`\n- `tests/test_parser.py::test_due_clear`\n- `tests/test_parser.py::test_mentions_extraction`\n- `tests/test_parser.py::test_title_extraction`\n\n**Rollback**\nRevert module; no side effects.\n\n**Observability**\n`logger.debug(\"Parsed: %s\", parsed_command)`\n\n**Dependencies**\n#1\n\n---\n\n## Issue #6: /todo add command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/006-cmd-add`                  |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `add` subcommand handler. Resolves project (default `Inbox`), applies defaults (section=`backlog`, assignees=sender if none mentioned), validates private-project assignee constraint (PRD 3.3), inserts task + task_assignees rows, logs event, and returns formatted confirmation.\n\n**Acceptance Criteria**\n- [ ] Task inserted with correct project_id, section, due, status='open', created_by\n- [ ] Assignees default to sender when no mentions\n- [ ] Multiple mentions create multiple task_assignee rows\n- [ ] Private project + non-owner assignee returns warning and does NOT insert\n- [ ] Non-existent project: `Inbox` auto-created as shared; others return error\n- [ ] Response format: `Added #<id> (<project>/<section>) due:<due|-> assignees:<mentions> -- <title>`\n- [ ] Event row written to `events` table\n\n**Tests**\n- `tests/test_cmd_add.py::test_add_default_inbox`\n- `tests/test_cmd_add.py::test_add_with_project_section_due`\n- `tests/test_cmd_add.py::test_add_private_rejects_other_assignee`\n- `tests/test_cmd_add.py::test_add_assignee_defaults_to_sender`\n- `tests/test_cmd_add.py::test_add_multiple_assignees`\n\n**Rollback**\nRevert handler; tasks table unchanged structurally.\n\n**Observability**\n`logger.info(\"Task #%d created in %s/%s by %s\", id, project, section, sender)`\n\n**Dependencies**\n#4, #5\n\n---\n\n## Issue #7: Project resolver helper\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/007-project-resolver`         |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `resolve_project(conn, name, sender_id) -> Project` following PRD 3.2 (Option A): sender's private project with that name takes priority, then shared, then error/auto-create for Inbox.\n\n**Acceptance Criteria**\n- [ ] Private project of sender matched first\n- [ ] Falls back to shared if no private match\n- [ ] Returns error when neither exists (except Inbox which is auto-created)\n- [ ] Returns project row with id, name, visibility, owner_user_id\n\n**Tests**\n- `tests/test_project_resolver.py::test_private_takes_priority`\n- `tests/test_project_resolver.py::test_falls_back_to_shared`\n- `tests/test_project_resolver.py::test_inbox_auto_created`\n- `tests/test_project_resolver.py::test_unknown_project_error`\n\n**Rollback**\nRevert module.\n\n**Observability**\n`logger.debug(\"Resolved project '%s' -> id=%d vis=%s\", name, id, visibility)`\n\n**Dependencies**\n#4\n\n---\n\n## Issue #8: /todo list command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/008-cmd-list`                 |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `list` subcommand. Supports scope (mine/all/<@USER>), project filter, section filter, status filter (open/done/drop), and limit. Sorting: due ASC (NULLs last), then id DESC. Excludes other users' private projects.\n\n**Acceptance Criteria**\n- [ ] Default scope=mine, status=open, limit=30\n- [ ] `mine` filters to tasks where sender is an assignee\n- [ ] `all` includes shared + sender's private (excludes others' private)\n- [ ] `/p` and `/s` filters applied correctly\n- [ ] Sorting: due NOT NULL first, due ASC, id DESC\n- [ ] limit:N respected\n- [ ] Output lists tasks in formatted lines\n\n**Tests**\n- `tests/test_cmd_list.py::test_list_mine_default`\n- `tests/test_cmd_list.py::test_list_all_excludes_others_private`\n- `tests/test_cmd_list.py::test_list_with_project_filter`\n- `tests/test_cmd_list.py::test_list_sorting_order`\n- `tests/test_cmd_list.py::test_list_limit`\n\n**Rollback**\nRevert handler; read-only operation.\n\n**Observability**\n`logger.info(\"list: scope=%s project=%s returned %d rows\", scope, project, count)`\n\n**Dependencies**\n#6, #7\n\n---\n\n## Issue #9: /todo board command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/009-cmd-board`                |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `board` subcommand. Groups tasks by section in fixed order (BACKLOG, DOING, WAITING, DONE, DROP), applies scope/project/status filters, and limits per section. Format: section headers with task lines underneath.\n\n**Acceptance Criteria**\n- [ ] Sections displayed in order: BACKLOG -> DOING -> WAITING -> DONE -> DROP\n- [ ] Empty sections shown with \"(empty)\" or omitted (decide and document)\n- [ ] `limitPerSection:N` caps items per section (default 10)\n- [ ] Scope/project filters identical to `list`\n- [ ] Each task line: `#id due:<date|-> assignees:<@U..> title`\n\n**Tests**\n- `tests/test_cmd_board.py::test_board_section_order`\n- `tests/test_cmd_board.py::test_board_limit_per_section`\n- `tests/test_cmd_board.py::test_board_scope_filter`\n\n**Rollback**\nRevert handler; read-only operation.\n\n**Observability**\n`logger.info(\"board: scope=%s project=%s sections=%s\", ...)`\n\n**Dependencies**\n#8\n\n---\n\n## Issue #10: /todo move command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/010-cmd-move`                 |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `move` subcommand. Validates section enum, checks permissions (private: owner only; shared: assignee or created_by), updates task section and updated_at, logs event.\n\n**Acceptance Criteria**\n- [ ] Section validated against enum; invalid returns error\n- [ ] Private project: only owner can move\n- [ ] Shared project: only assignee or created_by can move\n- [ ] `updated_at` set on change\n- [ ] Event logged\n- [ ] Response confirms new section\n\n**Tests**\n- `tests/test_cmd_move.py::test_move_valid_section`\n- `tests/test_cmd_move.py::test_move_invalid_section`\n- `tests/test_cmd_move.py::test_move_private_owner_only`\n- `tests/test_cmd_move.py::test_move_shared_permission`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"Task #%d moved to %s by %s\", id, section, sender)`\n\n**Dependencies**\n#6, #7\n\n---\n\n## Issue #11: /todo done and /todo drop commands\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/011-cmd-done-drop`            |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `done` and `drop` subcommands. Both set section and status accordingly, record `closed_at`, validate permissions same as `move`, and log event.\n\n**Acceptance Criteria**\n- [ ] `done`: section='done', status='done', closed_at=now\n- [ ] `drop`: section='drop', status='dropped', closed_at=now\n- [ ] Permissions enforced (same as move)\n- [ ] Already-closed task returns informational message (idempotent or error -- decide)\n- [ ] Event logged for each\n\n**Tests**\n- `tests/test_cmd_done_drop.py::test_done_sets_fields`\n- `tests/test_cmd_done_drop.py::test_drop_sets_fields`\n- `tests/test_cmd_done_drop.py::test_permission_check`\n- `tests/test_cmd_done_drop.py::test_already_done`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"Task #%d %s by %s\", id, action, sender)`\n\n**Dependencies**\n#10\n\n---\n\n## Issue #12: /todo edit command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/012-cmd-edit`                 |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `edit` subcommand (v1 replace semantics). Supports changing title, assignees (full replace), project, section, and due. Validates private-project assignee constraint on both source and target project. Logs event with old/new diff in payload.\n\n**Acceptance Criteria**\n- [ ] Title updated only if non-option tokens present\n- [ ] Mentions present -> assignees fully replaced (DELETE + INSERT)\n- [ ] `due:-` clears due to NULL\n- [ ] `/p <newProject>` moves task to new project (project_id updated)\n- [ ] Private project assignee validation applied to target project\n- [ ] If moving to private project with non-owner assignees -> warning, no change\n- [ ] Event payload contains changed fields\n- [ ] Permissions: private owner only; shared assignee/created_by\n\n**Tests**\n- `tests/test_cmd_edit.py::test_edit_title`\n- `tests/test_cmd_edit.py::test_edit_assignees_replace`\n- `tests/test_cmd_edit.py::test_edit_due_clear`\n- `tests/test_cmd_edit.py::test_edit_move_project`\n- `tests/test_cmd_edit.py::test_edit_private_assignee_rejected`\n- `tests/test_cmd_edit.py::test_edit_no_change_fields`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"Task #%d edited by %s: fields=%s\", id, sender, changed_fields)`\n\n**Dependencies**\n#6, #7, #10\n\n---\n\n## Issue #13: /todo project list command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M4                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/013-cmd-project-list`         |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `/todo project list`. Returns all shared projects and the sender's private projects. Format: grouped by visibility with name and task count.\n\n**Acceptance Criteria**\n- [ ] Shared projects listed regardless of sender\n- [ ] Sender's private projects listed\n- [ ] Other users' private projects NOT shown\n- [ ] Each project shows name, visibility, task count\n\n**Tests**\n- `tests/test_cmd_project.py::test_project_list_shows_shared`\n- `tests/test_cmd_project.py::test_project_list_shows_own_private`\n- `tests/test_cmd_project.py::test_project_list_hides_others_private`\n\n**Rollback**\nRevert handler; read-only.\n\n**Observability**\n`logger.info(\"project list: %d shared, %d private for %s\", ...)`\n\n**Dependencies**\n#7\n\n---\n\n## Issue #14: /todo project set-private command with assignee validation\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M4                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/014-cmd-project-set-private`  |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `/todo project set-private <name>` with the assignee validation described in PRD 3.4. Resolution flow: if sender already has private with that name -> noop; if shared exists -> attempt conversion; if neither -> create new private. Conversion scans all tasks in the project and rejects if any task has a non-owner assignee.\n\n**Acceptance Criteria**\n- [ ] Already-private for sender: returns \"already private\" message\n- [ ] Shared -> private: scans tasks; all assignees are owner -> success (visibility='private', owner_user_id=sender)\n- [ ] Shared -> private: at least one non-owner assignee -> error with task IDs and violating assignee list (max 10)\n- [ ] Neither exists: creates new private project with owner=sender\n- [ ] Error message format matches PRD example\n- [ ] Event logged\n\n**Tests**\n- `tests/test_cmd_project.py::test_set_private_already_private`\n- `tests/test_cmd_project.py::test_set_private_shared_success`\n- `tests/test_cmd_project.py::test_set_private_shared_rejected_non_owner_assignee`\n- `tests/test_cmd_project.py::test_set_private_creates_new`\n- `tests/test_cmd_project.py::test_set_private_error_message_format`\n\n**Rollback**\nRevert handler; no schema change.\n\n**Observability**\n`logger.info(\"project set-private: %s result=%s by %s\", name, result, sender)`\n\n**Dependencies**\n#7, #13\n\n---\n\n## Issue #15: /todo project set-shared command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M4                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/015-cmd-project-set-shared`   |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `/todo project set-shared <name>`. Creates a shared project if none exists. If a shared project with that name already exists, noop. Global uniqueness enforced by DB index.\n\n**Acceptance Criteria**\n- [ ] New shared project created when name is free\n- [ ] Existing shared project: returns \"already shared\" / noop\n- [ ] Name conflict with existing shared: returns exists message (index enforces)\n- [ ] Event logged\n\n**Tests**\n- `tests/test_cmd_project.py::test_set_shared_creates_new`\n- `tests/test_cmd_project.py::test_set_shared_already_exists_noop`\n- `tests/test_cmd_project.py::test_set_shared_name_conflict`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"project set-shared: %s result=%s\", name, result)`\n\n**Dependencies**\n#7, #13\n\n---\n\n## Issue #16: Command dispatcher and routing\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/016-dispatcher`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the dispatcher in `plugin.py` that maps the parsed command name to handler functions: `add`, `list`, `board`, `move`, `done`, `drop`, `edit`, `project`. The `project` command further dispatches to `list`, `set-private`, `set-shared`. Unknown commands return a help/error message.\n\n**Acceptance Criteria**\n- [ ] All valid command names routed to correct handler\n- [ ] `project` subcommands routed correctly\n- [ ] Unknown command returns usage hint\n- [ ] DB connection initialised (migration check) before first command execution\n\n**Tests**\n- `tests/test_dispatcher.py::test_routes_known_commands`\n- `tests/test_dispatcher.py::test_project_sub_routing`\n- `tests/test_dispatcher.py::test_unknown_command_help`\n\n**Rollback**\nRevert module.\n\n**Observability**\n`logger.info(\"Dispatching command=%s sub=%s\", command, sub)`\n\n**Dependencies**\n#5\n\n---\n\n## Issue #17: Permission helper module\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/017-permissions`              |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nExtract shared permission-checking logic into `src/openclaw_todo/permissions.py`. Provides `can_write_task(conn, task_id, sender_id) -> bool` and `validate_private_assignees(project, assignees, owner_id) -> Optional[str]` (returns warning message or None).\n\n**Acceptance Criteria**\n- [ ] Private project: only owner can write\n- [ ] Shared project: only assignee or created_by can write\n- [ ] `validate_private_assignees` returns warning string when non-owner assignees present for private project\n- [ ] Returns None for shared projects or when all assignees are owner\n\n**Tests**\n- `tests/test_permissions.py::test_private_owner_can_write`\n- `tests/test_permissions.py::test_private_non_owner_rejected`\n- `tests/test_permissions.py::test_shared_assignee_can_write`\n- `tests/test_permissions.py::test_shared_creator_can_write`\n- `tests/test_permissions.py::test_validate_private_assignees_warning`\n\n**Rollback**\nRevert module.\n\n**Observability**\n`logger.debug(\"Permission check: task=%d sender=%s result=%s\", ...)`\n\n**Dependencies**\n#4\n\n---\n\n## Issue #18: Parser unit tests (comprehensive)\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | QA                                     |\n| Milestone   | M5                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/018-parser-tests`             |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nExpand parser test coverage to include edge cases: multiple options in varied order, due at year boundary, empty title, mentions mixed with options, unicode in titles, extra whitespace handling.\n\n**Acceptance Criteria**\n- [ ] >=95% line coverage on `parser.py`\n- [ ] Edge cases documented in test docstrings\n- [ ] All tests pass with `uv run pytest tests/test_parser.py -v`\n\n**Tests**\n- `tests/test_parser.py::test_options_in_any_order`\n- `tests/test_parser.py::test_due_year_boundary`\n- `tests/test_parser.py::test_empty_title_no_crash`\n- `tests/test_parser.py::test_unicode_title`\n- `tests/test_parser.py::test_extra_whitespace`\n- `tests/test_parser.py::test_mixed_mentions_and_options`\n\n**Rollback**\nRevert test file; no production code change.\n\n**Observability**\nCI coverage report.\n\n**Dependencies**\n#5\n\n---\n\n## Issue #19: SQLite end-to-end integration tests\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | QA                                     |\n| Milestone   | M5                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/019-e2e-tests`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nWrite integration tests that exercise the full flow through `handle_message` with a real (tmp_path) SQLite database. Cover the main user stories: add a task, list it, move it, mark done, edit it, manage projects, and validate private project constraints.\n\n**Acceptance Criteria**\n- [ ] Each test uses a fresh DB via `tmp_path` fixture\n- [ ] Scenarios: add->list, add->move->board, add->done, add->edit, project set-private rejection\n- [ ] Private project visibility enforced end-to-end\n- [ ] Due normalisation verified in DB\n- [ ] All tests pass with `uv run pytest tests/test_e2e.py -v`\n\n**Tests**\n- `tests/test_e2e.py::test_add_and_list_roundtrip`\n- `tests/test_e2e.py::test_add_move_board`\n- `tests/test_e2e.py::test_done_and_drop`\n- `tests/test_e2e.py::test_edit_title_and_assignees`\n- `tests/test_e2e.py::test_private_project_isolation`\n- `tests/test_e2e.py::test_set_private_rejects_foreign_assignees`\n- `tests/test_e2e.py::test_due_normalisation_stored_correctly`\n\n**Rollback**\nRevert test file.\n\n**Observability**\nCI test results and coverage delta.\n\n**Dependencies**\n#6, #8, #9, #10, #11, #12, #14, #15\n\n---\n\n## Issue #20: Packaging and distribution setup\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | DevOps                                 |\n| Milestone   | M6                                     |\n| Status      | TODO                                   |\n| Priority    | P2                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/020-packaging`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nFinalise `pyproject.toml` metadata (name, version, description, license, entry-points), add a `Makefile` with targets for lint/test/build, and document installation instructions in README. Ensure the plugin can be installed as a package and discovered by the OpenClaw gateway.\n\n**Acceptance Criteria**\n- [ ] `pyproject.toml` has complete metadata and entry-point for OpenClaw plugin discovery\n- [ ] `make lint` runs ruff + black --check\n- [ ] `make test` runs pytest with coverage\n- [ ] `make build` produces a wheel via `uv build`\n- [ ] `pip install <wheel>` in a clean venv makes the plugin importable\n- [ ] README documents installation and configuration (DB path env var)\n\n**Tests**\n- Manual: install wheel in fresh venv, import module, call `handle_message`\n- `make test` passes in CI\n\n**Rollback**\nRevert packaging changes.\n\n**Observability**\nBuild artifact size logged; CI publishes wheel as artifact.\n\n**Dependencies**\n#19\n\n---\n\n## Dependency Graph (summary)\n\n```\n#1  Plugin skeleton\n |\n +--#2  DB connection\n |   |\n |   +--#3  Migration framework\n |       |\n |       +--#4  V1 schema\n |           |\n |           +--#7  Project resolver\n |           |   |\n |           |   +--#13 project list\n |           |   +--#14 project set-private\n |           |   +--#15 project set-shared\n |           |\n |           +--#17 Permissions helper\n |\n +--#5  Parser\n |   |\n |   +--#18 Parser tests (M5)\n |\n +--#16 Dispatcher\n     |\n     +--#6  cmd add       (#4,#5,#7,#17)\n     +--#8  cmd list      (#6,#7)\n     +--#9  cmd board     (#8)\n     +--#10 cmd move      (#6,#7,#17)\n     +--#11 cmd done/drop (#10)\n     +--#12 cmd edit      (#6,#7,#10,#17)\n\n#19 E2E tests    (all commands)\n#20 Packaging    (#19)\n```\n"}, "tool_use_id": "toolu_01GX5wGMA8Kjz7rK3knMWd4V", "_ts": "2026-02-20T11:34:16+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md", "content": "# OpenClaw TODO Plugin -- Issues\n\n> Auto-generated from `openclaw_todo_plugin_prd.md` (PRD v1.1)\n> Date: 2026-02-20\n\n---\n\n## Issue #1: Plugin skeleton and entry point\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M0                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/001-plugin-skeleton`          |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nCreate the Python project scaffold: `pyproject.toml` (uv), `src/openclaw_todo/` package layout, and the plugin entry-point that the OpenClaw gateway will load. The plugin must expose a callable that receives raw Slack DM text and a sender context dict.\n\n**Acceptance Criteria**\n- [ ] `pyproject.toml` exists with Python >=3.11, pytest, pytest-cov dev deps\n- [ ] `src/openclaw_todo/__init__.py` exposes `__version__`\n- [ ] `src/openclaw_todo/plugin.py` contains `handle_message(text: str, context: dict) -> str` entry point\n- [ ] Messages not starting with `/todo` are silently ignored (returns `None`)\n- [ ] `uv sync && uv run pytest -q` passes (trivial smoke test)\n\n**Tests**\n- `tests/test_plugin.py::test_ignores_non_todo_message`\n- `tests/test_plugin.py::test_dispatches_todo_prefix`\n\n**Rollback**\nDelete branch; no runtime dependency.\n\n**Observability**\n`logger.debug` on every inbound message; `logger.info` when `/todo` prefix matched.\n\n**Dependencies**\nNone.\n\n---\n\n## Issue #2: DB module -- connection helper and pragma setup\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend / Data                         |\n| Milestone   | M1                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/002-db-connection`            |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `src/openclaw_todo/db.py` with a `get_connection(db_path)` helper that creates the `~/.openclaw/workspace/.todo/` directory tree if missing, opens (or creates) `todo.sqlite3`, and applies `PRAGMA journal_mode=WAL` and `PRAGMA busy_timeout=3000`.\n\n**Acceptance Criteria**\n- [ ] Directory is created recursively when absent\n- [ ] SQLite connection returned with WAL mode enabled\n- [ ] `busy_timeout` is 3000\n- [ ] Calling `get_connection` twice returns usable connections (no lock conflict)\n\n**Tests**\n- `tests/test_db.py::test_creates_directory_and_file` (tmp_path)\n- `tests/test_db.py::test_wal_mode_enabled`\n- `tests/test_db.py::test_busy_timeout`\n\n**Rollback**\nRevert module; no schema changes yet.\n\n**Observability**\n`logger.info` on first DB creation; `logger.debug` on each connection open.\n\n**Dependencies**\n#1\n\n---\n\n## Issue #3: Schema migration framework and schema_version table\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend / Data                         |\n| Milestone   | M1                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/003-schema-migration`         |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement a simple sequential migration runner. On startup, read `schema_version` (create if missing), compare to available migrations list, and apply outstanding migrations in order inside a transaction.\n\n**Acceptance Criteria**\n- [ ] `schema_version` table created with single row `version=0` if absent\n- [ ] Migrations are Python callables registered in an ordered list\n- [ ] Each migration runs inside a transaction; version incremented on success\n- [ ] Re-running on an up-to-date DB is a no-op\n- [ ] Failing migration rolls back and raises with clear message\n\n**Tests**\n- `tests/test_migrations.py::test_fresh_db_gets_version_table`\n- `tests/test_migrations.py::test_applies_migrations_sequentially`\n- `tests/test_migrations.py::test_idempotent_on_rerun`\n- `tests/test_migrations.py::test_rollback_on_failure`\n\n**Rollback**\nDrop `schema_version` table; revert module.\n\n**Observability**\n`logger.info(\"Migrating from version %d to %d\", current, target)` per step.\n\n**Dependencies**\n#2\n\n---\n\n## Issue #4: V1 schema migration -- projects, tasks, task_assignees, events\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend / Data                         |\n| Milestone   | M1                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/004-v1-schema`                |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nRegister migration v1 that creates the four tables (`projects`, `tasks`, `task_assignees`, `events`) with all columns, CHECK constraints, and partial unique indexes as specified in PRD section 6.3. Also seed shared project `Inbox`.\n\n**Acceptance Criteria**\n- [ ] `projects` table with `ux_projects_shared_name` and `ux_projects_private_owner_name` partial unique indexes\n- [ ] `tasks` table with section and status CHECK constraints\n- [ ] `task_assignees` table with composite PK and secondary index\n- [ ] `events` audit table created\n- [ ] Shared `Inbox` project auto-created (INSERT OR IGNORE)\n- [ ] `schema_version` = 1 after migration\n\n**Tests**\n- `tests/test_migrations.py::test_v1_tables_exist`\n- `tests/test_migrations.py::test_v1_inbox_created`\n- `tests/test_migrations.py::test_v1_shared_unique_index_enforced`\n- `tests/test_migrations.py::test_v1_private_unique_index_enforced`\n\n**Rollback**\nDrop all four tables + reset schema_version to 0.\n\n**Observability**\nLog table creation counts.\n\n**Dependencies**\n#3\n\n---\n\n## Issue #5: Command parser -- tokenizer and option extraction\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M2                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/005-parser-tokenizer`         |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `src/openclaw_todo/parser.py` that takes raw message text (after `/todo` prefix) and returns a `ParsedCommand` dataclass containing: `command` (str), `args` (list), `project` (str|None), `section` (str|None), `due` (str|None, normalised to YYYY-MM-DD), `mentions` (list of Slack user IDs), and remaining `title_tokens`.\n\nParsing rules:\n- `/p <name>` extracts project\n- `/s <section>` extracts section (validate against enum)\n- `due:YYYY-MM-DD` or `due:MM-DD` extracts and normalises due date\n- `due:-` clears due (sentinel)\n- `<@U...>` patterns extracted as mentions\n- Everything else before first option token is title\n\n**Acceptance Criteria**\n- [ ] `/p MyProject` correctly extracted; token consumed\n- [ ] `/s doing` validated; invalid section raises `ParseError`\n- [ ] `due:03-15` normalised to `2026-03-15`\n- [ ] `due:2026-02-30` raises `ParseError` (invalid date)\n- [ ] `<@U12345>` extracted into mentions list\n- [ ] Multiple mentions supported\n- [ ] Title tokens are non-option, non-mention tokens before first option\n\n**Tests**\n- `tests/test_parser.py::test_extract_project`\n- `tests/test_parser.py::test_extract_section_valid`\n- `tests/test_parser.py::test_extract_section_invalid`\n- `tests/test_parser.py::test_due_mm_dd_normalisation`\n- `tests/test_parser.py::test_due_full_date`\n- `tests/test_parser.py::test_due_invalid_date`\n- `tests/test_parser.py::test_due_clear`\n- `tests/test_parser.py::test_mentions_extraction`\n- `tests/test_parser.py::test_title_extraction`\n\n**Rollback**\nRevert module; no side effects.\n\n**Observability**\n`logger.debug(\"Parsed: %s\", parsed_command)`\n\n**Dependencies**\n#1\n\n---\n\n## Issue #6: /todo add command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/006-cmd-add`                  |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `add` subcommand handler. Resolves project (default `Inbox`), applies defaults (section=`backlog`, assignees=sender if none mentioned), validates private-project assignee constraint (PRD 3.3), inserts task + task_assignees rows, logs event, and returns formatted confirmation.\n\n**Acceptance Criteria**\n- [ ] Task inserted with correct project_id, section, due, status='open', created_by\n- [ ] Assignees default to sender when no mentions\n- [ ] Multiple mentions create multiple task_assignee rows\n- [ ] Private project + non-owner assignee returns warning and does NOT insert\n- [ ] Non-existent project: `Inbox` auto-created as shared; others return error\n- [ ] Response format: `Added #<id> (<project>/<section>) due:<due|-> assignees:<mentions> -- <title>`\n- [ ] Event row written to `events` table\n\n**Tests**\n- `tests/test_cmd_add.py::test_add_default_inbox`\n- `tests/test_cmd_add.py::test_add_with_project_section_due`\n- `tests/test_cmd_add.py::test_add_private_rejects_other_assignee`\n- `tests/test_cmd_add.py::test_add_assignee_defaults_to_sender`\n- `tests/test_cmd_add.py::test_add_multiple_assignees`\n\n**Rollback**\nRevert handler; tasks table unchanged structurally.\n\n**Observability**\n`logger.info(\"Task #%d created in %s/%s by %s\", id, project, section, sender)`\n\n**Dependencies**\n#4, #5\n\n---\n\n## Issue #7: Project resolver helper\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/007-project-resolver`         |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `resolve_project(conn, name, sender_id) -> Project` following PRD 3.2 (Option A): sender's private project with that name takes priority, then shared, then error/auto-create for Inbox.\n\n**Acceptance Criteria**\n- [ ] Private project of sender matched first\n- [ ] Falls back to shared if no private match\n- [ ] Returns error when neither exists (except Inbox which is auto-created)\n- [ ] Returns project row with id, name, visibility, owner_user_id\n\n**Tests**\n- `tests/test_project_resolver.py::test_private_takes_priority`\n- `tests/test_project_resolver.py::test_falls_back_to_shared`\n- `tests/test_project_resolver.py::test_inbox_auto_created`\n- `tests/test_project_resolver.py::test_unknown_project_error`\n\n**Rollback**\nRevert module.\n\n**Observability**\n`logger.debug(\"Resolved project '%s' -> id=%d vis=%s\", name, id, visibility)`\n\n**Dependencies**\n#4\n\n---\n\n## Issue #8: /todo list command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/008-cmd-list`                 |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `list` subcommand. Supports scope (mine/all/<@USER>), project filter, section filter, status filter (open/done/drop), and limit. Sorting: due ASC (NULLs last), then id DESC. Excludes other users' private projects.\n\n**Acceptance Criteria**\n- [ ] Default scope=mine, status=open, limit=30\n- [ ] `mine` filters to tasks where sender is an assignee\n- [ ] `all` includes shared + sender's private (excludes others' private)\n- [ ] `/p` and `/s` filters applied correctly\n- [ ] Sorting: due NOT NULL first, due ASC, id DESC\n- [ ] limit:N respected\n- [ ] Output lists tasks in formatted lines\n\n**Tests**\n- `tests/test_cmd_list.py::test_list_mine_default`\n- `tests/test_cmd_list.py::test_list_all_excludes_others_private`\n- `tests/test_cmd_list.py::test_list_with_project_filter`\n- `tests/test_cmd_list.py::test_list_sorting_order`\n- `tests/test_cmd_list.py::test_list_limit`\n\n**Rollback**\nRevert handler; read-only operation.\n\n**Observability**\n`logger.info(\"list: scope=%s project=%s returned %d rows\", scope, project, count)`\n\n**Dependencies**\n#6, #7\n\n---\n\n## Issue #9: /todo board command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/009-cmd-board`                |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `board` subcommand. Groups tasks by section in fixed order (BACKLOG, DOING, WAITING, DONE, DROP), applies scope/project/status filters, and limits per section. Format: section headers with task lines underneath.\n\n**Acceptance Criteria**\n- [ ] Sections displayed in order: BACKLOG -> DOING -> WAITING -> DONE -> DROP\n- [ ] Empty sections shown with \"(empty)\" or omitted (decide and document)\n- [ ] `limitPerSection:N` caps items per section (default 10)\n- [ ] Scope/project filters identical to `list`\n- [ ] Each task line: `#id due:<date|-> assignees:<@U..> title`\n\n**Tests**\n- `tests/test_cmd_board.py::test_board_section_order`\n- `tests/test_cmd_board.py::test_board_limit_per_section`\n- `tests/test_cmd_board.py::test_board_scope_filter`\n\n**Rollback**\nRevert handler; read-only operation.\n\n**Observability**\n`logger.info(\"board: scope=%s project=%s sections=%s\", ...)`\n\n**Dependencies**\n#8\n\n---\n\n## Issue #10: /todo move command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/010-cmd-move`                 |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `move` subcommand. Validates section enum, checks permissions (private: owner only; shared: assignee or created_by), updates task section and updated_at, logs event.\n\n**Acceptance Criteria**\n- [ ] Section validated against enum; invalid returns error\n- [ ] Private project: only owner can move\n- [ ] Shared project: only assignee or created_by can move\n- [ ] `updated_at` set on change\n- [ ] Event logged\n- [ ] Response confirms new section\n\n**Tests**\n- `tests/test_cmd_move.py::test_move_valid_section`\n- `tests/test_cmd_move.py::test_move_invalid_section`\n- `tests/test_cmd_move.py::test_move_private_owner_only`\n- `tests/test_cmd_move.py::test_move_shared_permission`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"Task #%d moved to %s by %s\", id, section, sender)`\n\n**Dependencies**\n#6, #7\n\n---\n\n## Issue #11: /todo done and /todo drop commands\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/011-cmd-done-drop`            |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `done` and `drop` subcommands. Both set section and status accordingly, record `closed_at`, validate permissions same as `move`, and log event.\n\n**Acceptance Criteria**\n- [ ] `done`: section='done', status='done', closed_at=now\n- [ ] `drop`: section='drop', status='dropped', closed_at=now\n- [ ] Permissions enforced (same as move)\n- [ ] Already-closed task returns informational message (idempotent or error -- decide)\n- [ ] Event logged for each\n\n**Tests**\n- `tests/test_cmd_done_drop.py::test_done_sets_fields`\n- `tests/test_cmd_done_drop.py::test_drop_sets_fields`\n- `tests/test_cmd_done_drop.py::test_permission_check`\n- `tests/test_cmd_done_drop.py::test_already_done`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"Task #%d %s by %s\", id, action, sender)`\n\n**Dependencies**\n#10\n\n---\n\n## Issue #12: /todo edit command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/012-cmd-edit`                 |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `edit` subcommand (v1 replace semantics). Supports changing title, assignees (full replace), project, section, and due. Validates private-project assignee constraint on both source and target project. Logs event with old/new diff in payload.\n\n**Acceptance Criteria**\n- [ ] Title updated only if non-option tokens present\n- [ ] Mentions present -> assignees fully replaced (DELETE + INSERT)\n- [ ] `due:-` clears due to NULL\n- [ ] `/p <newProject>` moves task to new project (project_id updated)\n- [ ] Private project assignee validation applied to target project\n- [ ] If moving to private project with non-owner assignees -> warning, no change\n- [ ] Event payload contains changed fields\n- [ ] Permissions: private owner only; shared assignee/created_by\n\n**Tests**\n- `tests/test_cmd_edit.py::test_edit_title`\n- `tests/test_cmd_edit.py::test_edit_assignees_replace`\n- `tests/test_cmd_edit.py::test_edit_due_clear`\n- `tests/test_cmd_edit.py::test_edit_move_project`\n- `tests/test_cmd_edit.py::test_edit_private_assignee_rejected`\n- `tests/test_cmd_edit.py::test_edit_no_change_fields`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"Task #%d edited by %s: fields=%s\", id, sender, changed_fields)`\n\n**Dependencies**\n#6, #7, #10\n\n---\n\n## Issue #13: /todo project list command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M4                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/013-cmd-project-list`         |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `/todo project list`. Returns all shared projects and the sender's private projects. Format: grouped by visibility with name and task count.\n\n**Acceptance Criteria**\n- [ ] Shared projects listed regardless of sender\n- [ ] Sender's private projects listed\n- [ ] Other users' private projects NOT shown\n- [ ] Each project shows name, visibility, task count\n\n**Tests**\n- `tests/test_cmd_project.py::test_project_list_shows_shared`\n- `tests/test_cmd_project.py::test_project_list_shows_own_private`\n- `tests/test_cmd_project.py::test_project_list_hides_others_private`\n\n**Rollback**\nRevert handler; read-only.\n\n**Observability**\n`logger.info(\"project list: %d shared, %d private for %s\", ...)`\n\n**Dependencies**\n#7\n\n---\n\n## Issue #14: /todo project set-private command with assignee validation\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M4                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/014-cmd-project-set-private`  |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `/todo project set-private <name>` with the assignee validation described in PRD 3.4. Resolution flow: if sender already has private with that name -> noop; if shared exists -> attempt conversion; if neither -> create new private. Conversion scans all tasks in the project and rejects if any task has a non-owner assignee.\n\n**Acceptance Criteria**\n- [ ] Already-private for sender: returns \"already private\" message\n- [ ] Shared -> private: scans tasks; all assignees are owner -> success (visibility='private', owner_user_id=sender)\n- [ ] Shared -> private: at least one non-owner assignee -> error with task IDs and violating assignee list (max 10)\n- [ ] Neither exists: creates new private project with owner=sender\n- [ ] Error message format matches PRD example\n- [ ] Event logged\n\n**Tests**\n- `tests/test_cmd_project.py::test_set_private_already_private`\n- `tests/test_cmd_project.py::test_set_private_shared_success`\n- `tests/test_cmd_project.py::test_set_private_shared_rejected_non_owner_assignee`\n- `tests/test_cmd_project.py::test_set_private_creates_new`\n- `tests/test_cmd_project.py::test_set_private_error_message_format`\n\n**Rollback**\nRevert handler; no schema change.\n\n**Observability**\n`logger.info(\"project set-private: %s result=%s by %s\", name, result, sender)`\n\n**Dependencies**\n#7, #13\n\n---\n\n## Issue #15: /todo project set-shared command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M4                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/015-cmd-project-set-shared`   |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `/todo project set-shared <name>`. Creates a shared project if none exists. If a shared project with that name already exists, noop. Global uniqueness enforced by DB index.\n\n**Acceptance Criteria**\n- [ ] New shared project created when name is free\n- [ ] Existing shared project: returns \"already shared\" / noop\n- [ ] Name conflict with existing shared: returns exists message (index enforces)\n- [ ] Event logged\n\n**Tests**\n- `tests/test_cmd_project.py::test_set_shared_creates_new`\n- `tests/test_cmd_project.py::test_set_shared_already_exists_noop`\n- `tests/test_cmd_project.py::test_set_shared_name_conflict`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"project set-shared: %s result=%s\", name, result)`\n\n**Dependencies**\n#7, #13\n\n---\n\n## Issue #16: Command dispatcher and routing\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/016-dispatcher`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the dispatcher in `plugin.py` that maps the parsed command name to handler functions: `add`, `list`, `board`, `move`, `done`, `drop`, `edit`, `project`. The `project` command further dispatches to `list`, `set-private`, `set-shared`. Unknown commands return a help/error message.\n\n**Acceptance Criteria**\n- [ ] All valid command names routed to correct handler\n- [ ] `project` subcommands routed correctly\n- [ ] Unknown command returns usage hint\n- [ ] DB connection initialised (migration check) before first command execution\n\n**Tests**\n- `tests/test_dispatcher.py::test_routes_known_commands`\n- `tests/test_dispatcher.py::test_project_sub_routing`\n- `tests/test_dispatcher.py::test_unknown_command_help`\n\n**Rollback**\nRevert module.\n\n**Observability**\n`logger.info(\"Dispatching command=%s sub=%s\", command, sub)`\n\n**Dependencies**\n#5\n\n---\n\n## Issue #17: Permission helper module\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/017-permissions`              |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nExtract shared permission-checking logic into `src/openclaw_todo/permissions.py`. Provides `can_write_task(conn, task_id, sender_id) -> bool` and `validate_private_assignees(project, assignees, owner_id) -> Optional[str]` (returns warning message or None).\n\n**Acceptance Criteria**\n- [ ] Private project: only owner can write\n- [ ] Shared project: only assignee or created_by can write\n- [ ] `validate_private_assignees` returns warning string when non-owner assignees present for private project\n- [ ] Returns None for shared projects or when all assignees are owner\n\n**Tests**\n- `tests/test_permissions.py::test_private_owner_can_write`\n- `tests/test_permissions.py::test_private_non_owner_rejected`\n- `tests/test_permissions.py::test_shared_assignee_can_write`\n- `tests/test_permissions.py::test_shared_creator_can_write`\n- `tests/test_permissions.py::test_validate_private_assignees_warning`\n\n**Rollback**\nRevert module.\n\n**Observability**\n`logger.debug(\"Permission check: task=%d sender=%s result=%s\", ...)`\n\n**Dependencies**\n#4\n\n---\n\n## Issue #18: Parser unit tests (comprehensive)\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | QA                                     |\n| Milestone   | M5                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/018-parser-tests`             |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nExpand parser test coverage to include edge cases: multiple options in varied order, due at year boundary, empty title, mentions mixed with options, unicode in titles, extra whitespace handling.\n\n**Acceptance Criteria**\n- [ ] >=95% line coverage on `parser.py`\n- [ ] Edge cases documented in test docstrings\n- [ ] All tests pass with `uv run pytest tests/test_parser.py -v`\n\n**Tests**\n- `tests/test_parser.py::test_options_in_any_order`\n- `tests/test_parser.py::test_due_year_boundary`\n- `tests/test_parser.py::test_empty_title_no_crash`\n- `tests/test_parser.py::test_unicode_title`\n- `tests/test_parser.py::test_extra_whitespace`\n- `tests/test_parser.py::test_mixed_mentions_and_options`\n\n**Rollback**\nRevert test file; no production code change.\n\n**Observability**\nCI coverage report.\n\n**Dependencies**\n#5\n\n---\n\n## Issue #19: SQLite end-to-end integration tests\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | QA                                     |\n| Milestone   | M5                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/019-e2e-tests`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nWrite integration tests that exercise the full flow through `handle_message` with a real (tmp_path) SQLite database. Cover the main user stories: add a task, list it, move it, mark done, edit it, manage projects, and validate private project constraints.\n\n**Acceptance Criteria**\n- [ ] Each test uses a fresh DB via `tmp_path` fixture\n- [ ] Scenarios: add->list, add->move->board, add->done, add->edit, project set-private rejection\n- [ ] Private project visibility enforced end-to-end\n- [ ] Due normalisation verified in DB\n- [ ] All tests pass with `uv run pytest tests/test_e2e.py -v`\n\n**Tests**\n- `tests/test_e2e.py::test_add_and_list_roundtrip`\n- `tests/test_e2e.py::test_add_move_board`\n- `tests/test_e2e.py::test_done_and_drop`\n- `tests/test_e2e.py::test_edit_title_and_assignees`\n- `tests/test_e2e.py::test_private_project_isolation`\n- `tests/test_e2e.py::test_set_private_rejects_foreign_assignees`\n- `tests/test_e2e.py::test_due_normalisation_stored_correctly`\n\n**Rollback**\nRevert test file.\n\n**Observability**\nCI test results and coverage delta.\n\n**Dependencies**\n#6, #8, #9, #10, #11, #12, #14, #15\n\n---\n\n## Issue #20: Packaging and distribution setup\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | DevOps                                 |\n| Milestone   | M6                                     |\n| Status      | TODO                                   |\n| Priority    | P2                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/020-packaging`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nFinalise `pyproject.toml` metadata (name, version, description, license, entry-points), add a `Makefile` with targets for lint/test/build, and document installation instructions in README. Ensure the plugin can be installed as a package and discovered by the OpenClaw gateway.\n\n**Acceptance Criteria**\n- [ ] `pyproject.toml` has complete metadata and entry-point for OpenClaw plugin discovery\n- [ ] `make lint` runs ruff + black --check\n- [ ] `make test` runs pytest with coverage\n- [ ] `make build` produces a wheel via `uv build`\n- [ ] `pip install <wheel>` in a clean venv makes the plugin importable\n- [ ] README documents installation and configuration (DB path env var)\n\n**Tests**\n- Manual: install wheel in fresh venv, import module, call `handle_message`\n- `make test` passes in CI\n\n**Rollback**\nRevert packaging changes.\n\n**Observability**\nBuild artifact size logged; CI publishes wheel as artifact.\n\n**Dependencies**\n#19\n\n---\n\n## Dependency Graph (summary)\n\n```\n#1  Plugin skeleton\n |\n +--#2  DB connection\n |   |\n |   +--#3  Migration framework\n |       |\n |       +--#4  V1 schema\n |           |\n |           +--#7  Project resolver\n |           |   |\n |           |   +--#13 project list\n |           |   +--#14 project set-private\n |           |   +--#15 project set-shared\n |           |\n |           +--#17 Permissions helper\n |\n +--#5  Parser\n |   |\n |   +--#18 Parser tests (M5)\n |\n +--#16 Dispatcher\n     |\n     +--#6  cmd add       (#4,#5,#7,#17)\n     +--#8  cmd list      (#6,#7)\n     +--#9  cmd board     (#8)\n     +--#10 cmd move      (#6,#7,#17)\n     +--#11 cmd done/drop (#10)\n     +--#12 cmd edit      (#6,#7,#10,#17)\n\n#19 E2E tests    (all commands)\n#20 Packaging    (#19)\n```\n"}, "tool_response": {"type": "create", "filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md", "content": "# OpenClaw TODO Plugin -- Issues\n\n> Auto-generated from `openclaw_todo_plugin_prd.md` (PRD v1.1)\n> Date: 2026-02-20\n\n---\n\n## Issue #1: Plugin skeleton and entry point\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M0                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/001-plugin-skeleton`          |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nCreate the Python project scaffold: `pyproject.toml` (uv), `src/openclaw_todo/` package layout, and the plugin entry-point that the OpenClaw gateway will load. The plugin must expose a callable that receives raw Slack DM text and a sender context dict.\n\n**Acceptance Criteria**\n- [ ] `pyproject.toml` exists with Python >=3.11, pytest, pytest-cov dev deps\n- [ ] `src/openclaw_todo/__init__.py` exposes `__version__`\n- [ ] `src/openclaw_todo/plugin.py` contains `handle_message(text: str, context: dict) -> str` entry point\n- [ ] Messages not starting with `/todo` are silently ignored (returns `None`)\n- [ ] `uv sync && uv run pytest -q` passes (trivial smoke test)\n\n**Tests**\n- `tests/test_plugin.py::test_ignores_non_todo_message`\n- `tests/test_plugin.py::test_dispatches_todo_prefix`\n\n**Rollback**\nDelete branch; no runtime dependency.\n\n**Observability**\n`logger.debug` on every inbound message; `logger.info` when `/todo` prefix matched.\n\n**Dependencies**\nNone.\n\n---\n\n## Issue #2: DB module -- connection helper and pragma setup\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend / Data                         |\n| Milestone   | M1                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/002-db-connection`            |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `src/openclaw_todo/db.py` with a `get_connection(db_path)` helper that creates the `~/.openclaw/workspace/.todo/` directory tree if missing, opens (or creates) `todo.sqlite3`, and applies `PRAGMA journal_mode=WAL` and `PRAGMA busy_timeout=3000`.\n\n**Acceptance Criteria**\n- [ ] Directory is created recursively when absent\n- [ ] SQLite connection returned with WAL mode enabled\n- [ ] `busy_timeout` is 3000\n- [ ] Calling `get_connection` twice returns usable connections (no lock conflict)\n\n**Tests**\n- `tests/test_db.py::test_creates_directory_and_file` (tmp_path)\n- `tests/test_db.py::test_wal_mode_enabled`\n- `tests/test_db.py::test_busy_timeout`\n\n**Rollback**\nRevert module; no schema changes yet.\n\n**Observability**\n`logger.info` on first DB creation; `logger.debug` on each connection open.\n\n**Dependencies**\n#1\n\n---\n\n## Issue #3: Schema migration framework and schema_version table\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend / Data                         |\n| Milestone   | M1                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/003-schema-migration`         |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement a simple sequential migration runner. On startup, read `schema_version` (create if missing), compare to available migrations list, and apply outstanding migrations in order inside a transaction.\n\n**Acceptance Criteria**\n- [ ] `schema_version` table created with single row `version=0` if absent\n- [ ] Migrations are Python callables registered in an ordered list\n- [ ] Each migration runs inside a transaction; version incremented on success\n- [ ] Re-running on an up-to-date DB is a no-op\n- [ ] Failing migration rolls back and raises with clear message\n\n**Tests**\n- `tests/test_migrations.py::test_fresh_db_gets_version_table`\n- `tests/test_migrations.py::test_applies_migrations_sequentially`\n- `tests/test_migrations.py::test_idempotent_on_rerun`\n- `tests/test_migrations.py::test_rollback_on_failure`\n\n**Rollback**\nDrop `schema_version` table; revert module.\n\n**Observability**\n`logger.info(\"Migrating from version %d to %d\", current, target)` per step.\n\n**Dependencies**\n#2\n\n---\n\n## Issue #4: V1 schema migration -- projects, tasks, task_assignees, events\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend / Data                         |\n| Milestone   | M1                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/004-v1-schema`                |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nRegister migration v1 that creates the four tables (`projects`, `tasks`, `task_assignees`, `events`) with all columns, CHECK constraints, and partial unique indexes as specified in PRD section 6.3. Also seed shared project `Inbox`.\n\n**Acceptance Criteria**\n- [ ] `projects` table with `ux_projects_shared_name` and `ux_projects_private_owner_name` partial unique indexes\n- [ ] `tasks` table with section and status CHECK constraints\n- [ ] `task_assignees` table with composite PK and secondary index\n- [ ] `events` audit table created\n- [ ] Shared `Inbox` project auto-created (INSERT OR IGNORE)\n- [ ] `schema_version` = 1 after migration\n\n**Tests**\n- `tests/test_migrations.py::test_v1_tables_exist`\n- `tests/test_migrations.py::test_v1_inbox_created`\n- `tests/test_migrations.py::test_v1_shared_unique_index_enforced`\n- `tests/test_migrations.py::test_v1_private_unique_index_enforced`\n\n**Rollback**\nDrop all four tables + reset schema_version to 0.\n\n**Observability**\nLog table creation counts.\n\n**Dependencies**\n#3\n\n---\n\n## Issue #5: Command parser -- tokenizer and option extraction\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M2                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/005-parser-tokenizer`         |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `src/openclaw_todo/parser.py` that takes raw message text (after `/todo` prefix) and returns a `ParsedCommand` dataclass containing: `command` (str), `args` (list), `project` (str|None), `section` (str|None), `due` (str|None, normalised to YYYY-MM-DD), `mentions` (list of Slack user IDs), and remaining `title_tokens`.\n\nParsing rules:\n- `/p <name>` extracts project\n- `/s <section>` extracts section (validate against enum)\n- `due:YYYY-MM-DD` or `due:MM-DD` extracts and normalises due date\n- `due:-` clears due (sentinel)\n- `<@U...>` patterns extracted as mentions\n- Everything else before first option token is title\n\n**Acceptance Criteria**\n- [ ] `/p MyProject` correctly extracted; token consumed\n- [ ] `/s doing` validated; invalid section raises `ParseError`\n- [ ] `due:03-15` normalised to `2026-03-15`\n- [ ] `due:2026-02-30` raises `ParseError` (invalid date)\n- [ ] `<@U12345>` extracted into mentions list\n- [ ] Multiple mentions supported\n- [ ] Title tokens are non-option, non-mention tokens before first option\n\n**Tests**\n- `tests/test_parser.py::test_extract_project`\n- `tests/test_parser.py::test_extract_section_valid`\n- `tests/test_parser.py::test_extract_section_invalid`\n- `tests/test_parser.py::test_due_mm_dd_normalisation`\n- `tests/test_parser.py::test_due_full_date`\n- `tests/test_parser.py::test_due_invalid_date`\n- `tests/test_parser.py::test_due_clear`\n- `tests/test_parser.py::test_mentions_extraction`\n- `tests/test_parser.py::test_title_extraction`\n\n**Rollback**\nRevert module; no side effects.\n\n**Observability**\n`logger.debug(\"Parsed: %s\", parsed_command)`\n\n**Dependencies**\n#1\n\n---\n\n## Issue #6: /todo add command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/006-cmd-add`                  |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `add` subcommand handler. Resolves project (default `Inbox`), applies defaults (section=`backlog`, assignees=sender if none mentioned), validates private-project assignee constraint (PRD 3.3), inserts task + task_assignees rows, logs event, and returns formatted confirmation.\n\n**Acceptance Criteria**\n- [ ] Task inserted with correct project_id, section, due, status='open', created_by\n- [ ] Assignees default to sender when no mentions\n- [ ] Multiple mentions create multiple task_assignee rows\n- [ ] Private project + non-owner assignee returns warning and does NOT insert\n- [ ] Non-existent project: `Inbox` auto-created as shared; others return error\n- [ ] Response format: `Added #<id> (<project>/<section>) due:<due|-> assignees:<mentions> -- <title>`\n- [ ] Event row written to `events` table\n\n**Tests**\n- `tests/test_cmd_add.py::test_add_default_inbox`\n- `tests/test_cmd_add.py::test_add_with_project_section_due`\n- `tests/test_cmd_add.py::test_add_private_rejects_other_assignee`\n- `tests/test_cmd_add.py::test_add_assignee_defaults_to_sender`\n- `tests/test_cmd_add.py::test_add_multiple_assignees`\n\n**Rollback**\nRevert handler; tasks table unchanged structurally.\n\n**Observability**\n`logger.info(\"Task #%d created in %s/%s by %s\", id, project, section, sender)`\n\n**Dependencies**\n#4, #5\n\n---\n\n## Issue #7: Project resolver helper\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/007-project-resolver`         |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `resolve_project(conn, name, sender_id) -> Project` following PRD 3.2 (Option A): sender's private project with that name takes priority, then shared, then error/auto-create for Inbox.\n\n**Acceptance Criteria**\n- [ ] Private project of sender matched first\n- [ ] Falls back to shared if no private match\n- [ ] Returns error when neither exists (except Inbox which is auto-created)\n- [ ] Returns project row with id, name, visibility, owner_user_id\n\n**Tests**\n- `tests/test_project_resolver.py::test_private_takes_priority`\n- `tests/test_project_resolver.py::test_falls_back_to_shared`\n- `tests/test_project_resolver.py::test_inbox_auto_created`\n- `tests/test_project_resolver.py::test_unknown_project_error`\n\n**Rollback**\nRevert module.\n\n**Observability**\n`logger.debug(\"Resolved project '%s' -> id=%d vis=%s\", name, id, visibility)`\n\n**Dependencies**\n#4\n\n---\n\n## Issue #8: /todo list command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/008-cmd-list`                 |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `list` subcommand. Supports scope (mine/all/<@USER>), project filter, section filter, status filter (open/done/drop), and limit. Sorting: due ASC (NULLs last), then id DESC. Excludes other users' private projects.\n\n**Acceptance Criteria**\n- [ ] Default scope=mine, status=open, limit=30\n- [ ] `mine` filters to tasks where sender is an assignee\n- [ ] `all` includes shared + sender's private (excludes others' private)\n- [ ] `/p` and `/s` filters applied correctly\n- [ ] Sorting: due NOT NULL first, due ASC, id DESC\n- [ ] limit:N respected\n- [ ] Output lists tasks in formatted lines\n\n**Tests**\n- `tests/test_cmd_list.py::test_list_mine_default`\n- `tests/test_cmd_list.py::test_list_all_excludes_others_private`\n- `tests/test_cmd_list.py::test_list_with_project_filter`\n- `tests/test_cmd_list.py::test_list_sorting_order`\n- `tests/test_cmd_list.py::test_list_limit`\n\n**Rollback**\nRevert handler; read-only operation.\n\n**Observability**\n`logger.info(\"list: scope=%s project=%s returned %d rows\", scope, project, count)`\n\n**Dependencies**\n#6, #7\n\n---\n\n## Issue #9: /todo board command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/009-cmd-board`                |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `board` subcommand. Groups tasks by section in fixed order (BACKLOG, DOING, WAITING, DONE, DROP), applies scope/project/status filters, and limits per section. Format: section headers with task lines underneath.\n\n**Acceptance Criteria**\n- [ ] Sections displayed in order: BACKLOG -> DOING -> WAITING -> DONE -> DROP\n- [ ] Empty sections shown with \"(empty)\" or omitted (decide and document)\n- [ ] `limitPerSection:N` caps items per section (default 10)\n- [ ] Scope/project filters identical to `list`\n- [ ] Each task line: `#id due:<date|-> assignees:<@U..> title`\n\n**Tests**\n- `tests/test_cmd_board.py::test_board_section_order`\n- `tests/test_cmd_board.py::test_board_limit_per_section`\n- `tests/test_cmd_board.py::test_board_scope_filter`\n\n**Rollback**\nRevert handler; read-only operation.\n\n**Observability**\n`logger.info(\"board: scope=%s project=%s sections=%s\", ...)`\n\n**Dependencies**\n#8\n\n---\n\n## Issue #10: /todo move command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/010-cmd-move`                 |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `move` subcommand. Validates section enum, checks permissions (private: owner only; shared: assignee or created_by), updates task section and updated_at, logs event.\n\n**Acceptance Criteria**\n- [ ] Section validated against enum; invalid returns error\n- [ ] Private project: only owner can move\n- [ ] Shared project: only assignee or created_by can move\n- [ ] `updated_at` set on change\n- [ ] Event logged\n- [ ] Response confirms new section\n\n**Tests**\n- `tests/test_cmd_move.py::test_move_valid_section`\n- `tests/test_cmd_move.py::test_move_invalid_section`\n- `tests/test_cmd_move.py::test_move_private_owner_only`\n- `tests/test_cmd_move.py::test_move_shared_permission`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"Task #%d moved to %s by %s\", id, section, sender)`\n\n**Dependencies**\n#6, #7\n\n---\n\n## Issue #11: /todo done and /todo drop commands\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/011-cmd-done-drop`            |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `done` and `drop` subcommands. Both set section and status accordingly, record `closed_at`, validate permissions same as `move`, and log event.\n\n**Acceptance Criteria**\n- [ ] `done`: section='done', status='done', closed_at=now\n- [ ] `drop`: section='drop', status='dropped', closed_at=now\n- [ ] Permissions enforced (same as move)\n- [ ] Already-closed task returns informational message (idempotent or error -- decide)\n- [ ] Event logged for each\n\n**Tests**\n- `tests/test_cmd_done_drop.py::test_done_sets_fields`\n- `tests/test_cmd_done_drop.py::test_drop_sets_fields`\n- `tests/test_cmd_done_drop.py::test_permission_check`\n- `tests/test_cmd_done_drop.py::test_already_done`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"Task #%d %s by %s\", id, action, sender)`\n\n**Dependencies**\n#10\n\n---\n\n## Issue #12: /todo edit command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/012-cmd-edit`                 |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `edit` subcommand (v1 replace semantics). Supports changing title, assignees (full replace), project, section, and due. Validates private-project assignee constraint on both source and target project. Logs event with old/new diff in payload.\n\n**Acceptance Criteria**\n- [ ] Title updated only if non-option tokens present\n- [ ] Mentions present -> assignees fully replaced (DELETE + INSERT)\n- [ ] `due:-` clears due to NULL\n- [ ] `/p <newProject>` moves task to new project (project_id updated)\n- [ ] Private project assignee validation applied to target project\n- [ ] If moving to private project with non-owner assignees -> warning, no change\n- [ ] Event payload contains changed fields\n- [ ] Permissions: private owner only; shared assignee/created_by\n\n**Tests**\n- `tests/test_cmd_edit.py::test_edit_title`\n- `tests/test_cmd_edit.py::test_edit_assignees_replace`\n- `tests/test_cmd_edit.py::test_edit_due_clear`\n- `tests/test_cmd_edit.py::test_edit_move_project`\n- `tests/test_cmd_edit.py::test_edit_private_assignee_rejected`\n- `tests/test_cmd_edit.py::test_edit_no_change_fields`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"Task #%d edited by %s: fields=%s\", id, sender, changed_fields)`\n\n**Dependencies**\n#6, #7, #10\n\n---\n\n## Issue #13: /todo project list command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M4                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/013-cmd-project-list`         |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `/todo project list`. Returns all shared projects and the sender's private projects. Format: grouped by visibility with name and task count.\n\n**Acceptance Criteria**\n- [ ] Shared projects listed regardless of sender\n- [ ] Sender's private projects listed\n- [ ] Other users' private projects NOT shown\n- [ ] Each project shows name, visibility, task count\n\n**Tests**\n- `tests/test_cmd_project.py::test_project_list_shows_shared`\n- `tests/test_cmd_project.py::test_project_list_shows_own_private`\n- `tests/test_cmd_project.py::test_project_list_hides_others_private`\n\n**Rollback**\nRevert handler; read-only.\n\n**Observability**\n`logger.info(\"project list: %d shared, %d private for %s\", ...)`\n\n**Dependencies**\n#7\n\n---\n\n## Issue #14: /todo project set-private command with assignee validation\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M4                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/014-cmd-project-set-private`  |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `/todo project set-private <name>` with the assignee validation described in PRD 3.4. Resolution flow: if sender already has private with that name -> noop; if shared exists -> attempt conversion; if neither -> create new private. Conversion scans all tasks in the project and rejects if any task has a non-owner assignee.\n\n**Acceptance Criteria**\n- [ ] Already-private for sender: returns \"already private\" message\n- [ ] Shared -> private: scans tasks; all assignees are owner -> success (visibility='private', owner_user_id=sender)\n- [ ] Shared -> private: at least one non-owner assignee -> error with task IDs and violating assignee list (max 10)\n- [ ] Neither exists: creates new private project with owner=sender\n- [ ] Error message format matches PRD example\n- [ ] Event logged\n\n**Tests**\n- `tests/test_cmd_project.py::test_set_private_already_private`\n- `tests/test_cmd_project.py::test_set_private_shared_success`\n- `tests/test_cmd_project.py::test_set_private_shared_rejected_non_owner_assignee`\n- `tests/test_cmd_project.py::test_set_private_creates_new`\n- `tests/test_cmd_project.py::test_set_private_error_message_format`\n\n**Rollback**\nRevert handler; no schema change.\n\n**Observability**\n`logger.info(\"project set-private: %s result=%s by %s\", name, result, sender)`\n\n**Dependencies**\n#7, #13\n\n---\n\n## Issue #15: /todo project set-shared command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M4                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/015-cmd-project-set-shared`   |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `/todo project set-shared <name>`. Creates a shared project if none exists. If a shared project with that name already exists, noop. Global uniqueness enforced by DB index.\n\n**Acceptance Criteria**\n- [ ] New shared project created when name is free\n- [ ] Existing shared project: returns \"already shared\" / noop\n- [ ] Name conflict with existing shared: returns exists message (index enforces)\n- [ ] Event logged\n\n**Tests**\n- `tests/test_cmd_project.py::test_set_shared_creates_new`\n- `tests/test_cmd_project.py::test_set_shared_already_exists_noop`\n- `tests/test_cmd_project.py::test_set_shared_name_conflict`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"project set-shared: %s result=%s\", name, result)`\n\n**Dependencies**\n#7, #13\n\n---\n\n## Issue #16: Command dispatcher and routing\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/016-dispatcher`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the dispatcher in `plugin.py` that maps the parsed command name to handler functions: `add`, `list`, `board`, `move`, `done`, `drop`, `edit`, `project`. The `project` command further dispatches to `list`, `set-private`, `set-shared`. Unknown commands return a help/error message.\n\n**Acceptance Criteria**\n- [ ] All valid command names routed to correct handler\n- [ ] `project` subcommands routed correctly\n- [ ] Unknown command returns usage hint\n- [ ] DB connection initialised (migration check) before first command execution\n\n**Tests**\n- `tests/test_dispatcher.py::test_routes_known_commands`\n- `tests/test_dispatcher.py::test_project_sub_routing`\n- `tests/test_dispatcher.py::test_unknown_command_help`\n\n**Rollback**\nRevert module.\n\n**Observability**\n`logger.info(\"Dispatching command=%s sub=%s\", command, sub)`\n\n**Dependencies**\n#5\n\n---\n\n## Issue #17: Permission helper module\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/017-permissions`              |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nExtract shared permission-checking logic into `src/openclaw_todo/permissions.py`. Provides `can_write_task(conn, task_id, sender_id) -> bool` and `validate_private_assignees(project, assignees, owner_id) -> Optional[str]` (returns warning message or None).\n\n**Acceptance Criteria**\n- [ ] Private project: only owner can write\n- [ ] Shared project: only assignee or created_by can write\n- [ ] `validate_private_assignees` returns warning string when non-owner assignees present for private project\n- [ ] Returns None for shared projects or when all assignees are owner\n\n**Tests**\n- `tests/test_permissions.py::test_private_owner_can_write`\n- `tests/test_permissions.py::test_private_non_owner_rejected`\n- `tests/test_permissions.py::test_shared_assignee_can_write`\n- `tests/test_permissions.py::test_shared_creator_can_write`\n- `tests/test_permissions.py::test_validate_private_assignees_warning`\n\n**Rollback**\nRevert module.\n\n**Observability**\n`logger.debug(\"Permission check: task=%d sender=%s result=%s\", ...)`\n\n**Dependencies**\n#4\n\n---\n\n## Issue #18: Parser unit tests (comprehensive)\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | QA                                     |\n| Milestone   | M5                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/018-parser-tests`             |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nExpand parser test coverage to include edge cases: multiple options in varied order, due at year boundary, empty title, mentions mixed with options, unicode in titles, extra whitespace handling.\n\n**Acceptance Criteria**\n- [ ] >=95% line coverage on `parser.py`\n- [ ] Edge cases documented in test docstrings\n- [ ] All tests pass with `uv run pytest tests/test_parser.py -v`\n\n**Tests**\n- `tests/test_parser.py::test_options_in_any_order`\n- `tests/test_parser.py::test_due_year_boundary`\n- `tests/test_parser.py::test_empty_title_no_crash`\n- `tests/test_parser.py::test_unicode_title`\n- `tests/test_parser.py::test_extra_whitespace`\n- `tests/test_parser.py::test_mixed_mentions_and_options`\n\n**Rollback**\nRevert test file; no production code change.\n\n**Observability**\nCI coverage report.\n\n**Dependencies**\n#5\n\n---\n\n## Issue #19: SQLite end-to-end integration tests\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | QA                                     |\n| Milestone   | M5                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/019-e2e-tests`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nWrite integration tests that exercise the full flow through `handle_message` with a real (tmp_path) SQLite database. Cover the main user stories: add a task, list it, move it, mark done, edit it, manage projects, and validate private project constraints.\n\n**Acceptance Criteria**\n- [ ] Each test uses a fresh DB via `tmp_path` fixture\n- [ ] Scenarios: add->list, add->move->board, add->done, add->edit, project set-private rejection\n- [ ] Private project visibility enforced end-to-end\n- [ ] Due normalisation verified in DB\n- [ ] All tests pass with `uv run pytest tests/test_e2e.py -v`\n\n**Tests**\n- `tests/test_e2e.py::test_add_and_list_roundtrip`\n- `tests/test_e2e.py::test_add_move_board`\n- `tests/test_e2e.py::test_done_and_drop`\n- `tests/test_e2e.py::test_edit_title_and_assignees`\n- `tests/test_e2e.py::test_private_project_isolation`\n- `tests/test_e2e.py::test_set_private_rejects_foreign_assignees`\n- `tests/test_e2e.py::test_due_normalisation_stored_correctly`\n\n**Rollback**\nRevert test file.\n\n**Observability**\nCI test results and coverage delta.\n\n**Dependencies**\n#6, #8, #9, #10, #11, #12, #14, #15\n\n---\n\n## Issue #20: Packaging and distribution setup\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | DevOps                                 |\n| Milestone   | M6                                     |\n| Status      | TODO                                   |\n| Priority    | P2                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/020-packaging`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nFinalise `pyproject.toml` metadata (name, version, description, license, entry-points), add a `Makefile` with targets for lint/test/build, and document installation instructions in README. Ensure the plugin can be installed as a package and discovered by the OpenClaw gateway.\n\n**Acceptance Criteria**\n- [ ] `pyproject.toml` has complete metadata and entry-point for OpenClaw plugin discovery\n- [ ] `make lint` runs ruff + black --check\n- [ ] `make test` runs pytest with coverage\n- [ ] `make build` produces a wheel via `uv build`\n- [ ] `pip install <wheel>` in a clean venv makes the plugin importable\n- [ ] README documents installation and configuration (DB path env var)\n\n**Tests**\n- Manual: install wheel in fresh venv, import module, call `handle_message`\n- `make test` passes in CI\n\n**Rollback**\nRevert packaging changes.\n\n**Observability**\nBuild artifact size logged; CI publishes wheel as artifact.\n\n**Dependencies**\n#19\n\n---\n\n## Dependency Graph (summary)\n\n```\n#1  Plugin skeleton\n |\n +--#2  DB connection\n |   |\n |   +--#3  Migration framework\n |       |\n |       +--#4  V1 schema\n |           |\n |           +--#7  Project resolver\n |           |   |\n |           |   +--#13 project list\n |           |   +--#14 project set-private\n |           |   +--#15 project set-shared\n |           |\n |           +--#17 Permissions helper\n |\n +--#5  Parser\n |   |\n |   +--#18 Parser tests (M5)\n |\n +--#16 Dispatcher\n     |\n     +--#6  cmd add       (#4,#5,#7,#17)\n     +--#8  cmd list      (#6,#7)\n     +--#9  cmd board     (#8)\n     +--#10 cmd move      (#6,#7,#17)\n     +--#11 cmd done/drop (#10)\n     +--#12 cmd edit      (#6,#7,#10,#17)\n\n#19 E2E tests    (all commands)\n#20 Packaging    (#19)\n```\n", "structuredPatch": [], "originalFile": null}, "tool_use_id": "toolu_01GX5wGMA8Kjz7rK3knMWd4V", "_ts": "2026-02-20T11:34:16+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "SubagentStop", "stop_hook_active": false, "agent_id": "a5b42a7", "agent_transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4/subagents/agent-a5b42a7.jsonl", "agent_type": "planner", "_ts": "2026-02-20T11:34:30+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/docs/README.md", "content": "# OpenClaw TODO Plugin\n\nSlack DM-based team/personal TODO system — an OpenClaw plugin.\n\n## Prerequisites\n\n- Python 3.11+\n- [uv](https://docs.astral.sh/uv/) package manager\n\n## Setup\n\n```bash\n# Clone and initialize\ngit clone <repo-url>\ncd openclaw_todo_plugin\n\n# Install dependencies\nuv sync\n```\n\n## Run\n\nThe plugin runs within the OpenClaw Gateway. It registers a `/todo` command handler that processes messages in Slack DMs.\n\n```bash\n# Start via OpenClaw Gateway (details TBD based on Gateway docs)\nuv run openclaw-gateway\n```\n\n### DB Location\n\nThe SQLite database is automatically created at:\n```\n~/.openclaw/workspace/.todo/todo.sqlite3\n```\n\n## Test\n\n```bash\n# Run all tests\nuv run pytest -q\n\n# Run with coverage\nuv run pytest --cov=src --cov-report=term-missing\n\n# Run smoke tests only\nuv run pytest -m smoke -q\n```\n\n## Commands\n\n| Command | Description |\n|---------|-------------|\n| `/todo add <title> [@user] [/p project] [/s section] [due:date]` | Create a task |\n| `/todo list [mine\\|all\\|@user] [/p project] [/s section]` | List tasks |\n| `/todo board [mine\\|all\\|@user] [/p project]` | Kanban board view |\n| `/todo move <id> <section>` | Move task to section |\n| `/todo done <id>` | Mark task done |\n| `/todo drop <id>` | Drop a task |\n| `/todo edit <id> [new title] [@user] [/p project] [/s section] [due:date]` | Edit a task |\n| `/todo project list` | List projects |\n| `/todo project set-private <name>` | Make project private |\n| `/todo project set-shared <name>` | Make project shared |\n\n## Project Structure\n\n```\nopenclaw_todo_plugin/\n├── src/\n│   └── openclaw_todo_plugin/\n│       ├── __init__.py          # Plugin entry point\n│       ├── commands/            # Command handlers\n│       ├── db/                  # Connection + migrations\n│       ├── repositories/        # SQL data access\n│       ├── services/            # Business logic + permissions\n│       ├── parser.py            # Input tokenizer/parser\n│       ├── formatter.py         # Response formatting\n│       └── errors.py            # Custom exceptions\n├── tests/\n├── docs/\n├── issues.md\n├── pyproject.toml\n└── STATUS.md\n```\n\n## Documentation\n\n- [Requirements](requirements.md)\n- [UX Specification](ux_spec.md)\n- [Architecture](architecture.md)\n- [Test Plan](test_plan.md)\n- [Issues / Task Breakdown](../issues.md)\n"}, "tool_use_id": "toolu_01LPyjLbF81jSKrQHCrxP5xJ", "_ts": "2026-02-20T11:34:47+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/docs/README.md", "content": "# OpenClaw TODO Plugin\n\nSlack DM-based team/personal TODO system — an OpenClaw plugin.\n\n## Prerequisites\n\n- Python 3.11+\n- [uv](https://docs.astral.sh/uv/) package manager\n\n## Setup\n\n```bash\n# Clone and initialize\ngit clone <repo-url>\ncd openclaw_todo_plugin\n\n# Install dependencies\nuv sync\n```\n\n## Run\n\nThe plugin runs within the OpenClaw Gateway. It registers a `/todo` command handler that processes messages in Slack DMs.\n\n```bash\n# Start via OpenClaw Gateway (details TBD based on Gateway docs)\nuv run openclaw-gateway\n```\n\n### DB Location\n\nThe SQLite database is automatically created at:\n```\n~/.openclaw/workspace/.todo/todo.sqlite3\n```\n\n## Test\n\n```bash\n# Run all tests\nuv run pytest -q\n\n# Run with coverage\nuv run pytest --cov=src --cov-report=term-missing\n\n# Run smoke tests only\nuv run pytest -m smoke -q\n```\n\n## Commands\n\n| Command | Description |\n|---------|-------------|\n| `/todo add <title> [@user] [/p project] [/s section] [due:date]` | Create a task |\n| `/todo list [mine\\|all\\|@user] [/p project] [/s section]` | List tasks |\n| `/todo board [mine\\|all\\|@user] [/p project]` | Kanban board view |\n| `/todo move <id> <section>` | Move task to section |\n| `/todo done <id>` | Mark task done |\n| `/todo drop <id>` | Drop a task |\n| `/todo edit <id> [new title] [@user] [/p project] [/s section] [due:date]` | Edit a task |\n| `/todo project list` | List projects |\n| `/todo project set-private <name>` | Make project private |\n| `/todo project set-shared <name>` | Make project shared |\n\n## Project Structure\n\n```\nopenclaw_todo_plugin/\n├── src/\n│   └── openclaw_todo_plugin/\n│       ├── __init__.py          # Plugin entry point\n│       ├── commands/            # Command handlers\n│       ├── db/                  # Connection + migrations\n│       ├── repositories/        # SQL data access\n│       ├── services/            # Business logic + permissions\n│       ├── parser.py            # Input tokenizer/parser\n│       ├── formatter.py         # Response formatting\n│       └── errors.py            # Custom exceptions\n├── tests/\n├── docs/\n├── issues.md\n├── pyproject.toml\n└── STATUS.md\n```\n\n## Documentation\n\n- [Requirements](requirements.md)\n- [UX Specification](ux_spec.md)\n- [Architecture](architecture.md)\n- [Test Plan](test_plan.md)\n- [Issues / Task Breakdown](../issues.md)\n"}, "tool_response": {"type": "create", "filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/docs/README.md", "content": "# OpenClaw TODO Plugin\n\nSlack DM-based team/personal TODO system — an OpenClaw plugin.\n\n## Prerequisites\n\n- Python 3.11+\n- [uv](https://docs.astral.sh/uv/) package manager\n\n## Setup\n\n```bash\n# Clone and initialize\ngit clone <repo-url>\ncd openclaw_todo_plugin\n\n# Install dependencies\nuv sync\n```\n\n## Run\n\nThe plugin runs within the OpenClaw Gateway. It registers a `/todo` command handler that processes messages in Slack DMs.\n\n```bash\n# Start via OpenClaw Gateway (details TBD based on Gateway docs)\nuv run openclaw-gateway\n```\n\n### DB Location\n\nThe SQLite database is automatically created at:\n```\n~/.openclaw/workspace/.todo/todo.sqlite3\n```\n\n## Test\n\n```bash\n# Run all tests\nuv run pytest -q\n\n# Run with coverage\nuv run pytest --cov=src --cov-report=term-missing\n\n# Run smoke tests only\nuv run pytest -m smoke -q\n```\n\n## Commands\n\n| Command | Description |\n|---------|-------------|\n| `/todo add <title> [@user] [/p project] [/s section] [due:date]` | Create a task |\n| `/todo list [mine\\|all\\|@user] [/p project] [/s section]` | List tasks |\n| `/todo board [mine\\|all\\|@user] [/p project]` | Kanban board view |\n| `/todo move <id> <section>` | Move task to section |\n| `/todo done <id>` | Mark task done |\n| `/todo drop <id>` | Drop a task |\n| `/todo edit <id> [new title] [@user] [/p project] [/s section] [due:date]` | Edit a task |\n| `/todo project list` | List projects |\n| `/todo project set-private <name>` | Make project private |\n| `/todo project set-shared <name>` | Make project shared |\n\n## Project Structure\n\n```\nopenclaw_todo_plugin/\n├── src/\n│   └── openclaw_todo_plugin/\n│       ├── __init__.py          # Plugin entry point\n│       ├── commands/            # Command handlers\n│       ├── db/                  # Connection + migrations\n│       ├── repositories/        # SQL data access\n│       ├── services/            # Business logic + permissions\n│       ├── parser.py            # Input tokenizer/parser\n│       ├── formatter.py         # Response formatting\n│       └── errors.py            # Custom exceptions\n├── tests/\n├── docs/\n├── issues.md\n├── pyproject.toml\n└── STATUS.md\n```\n\n## Documentation\n\n- [Requirements](requirements.md)\n- [UX Specification](ux_spec.md)\n- [Architecture](architecture.md)\n- [Test Plan](test_plan.md)\n- [Issues / Task Breakdown](../issues.md)\n", "structuredPatch": [], "originalFile": null}, "tool_use_id": "toolu_01LPyjLbF81jSKrQHCrxP5xJ", "_ts": "2026-02-20T11:34:47+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "content": "# Project Status — OpenClaw TODO Plugin\n\n**Last updated:** 2026-02-20\n\n## Current Phase\n\n**Kickoff complete** — All planning documents generated. Ready to begin implementation.\n\n## Milestones\n\n| Milestone | Description | Status | Issues |\n|-----------|-------------|--------|--------|\n| M0 | Plugin skeleton + `/todo` command registration | Not started | #1 |\n| M1 | DB init + migrations + schema_version | Not started | #2, #3, #4 |\n| M2 | Parser (Slack mention, /p, /s, due correction) | Not started | #5 |\n| M3 | Commands (add/list/board/move/done/drop/edit) | Not started | #6–#12, #16, #17 |\n| M4 | Project commands (list/set-private/set-shared) | Not started | #13, #14, #15 |\n| M5 | Tests (parser/unit + sqlite E2E) | Not started | #18, #19 |\n| M6 | Packaging / deployment | Not started | #20 |\n\n## Critical Path\n\n```\n#1 (skeleton) → #2 (DB conn) → #3 (migration framework) → #4 (V1 schema) → #7 (project resolver) → commands\n#5 (parser) can be developed in parallel with DB track\n```\n\n## Next Issues to Work On\n\n1. **#1** — Plugin skeleton and project scaffold (M0)\n2. **#2** — DB connection manager with WAL + busy_timeout (M1)\n3. **#5** — Command parser / tokenizer (M2, parallelizable)\n\n## Risks\n\n| Risk | Likelihood | Impact | Mitigation |\n|------|-----------|--------|------------|\n| SQLite write contention under concurrent access | Low | Medium | WAL mode + busy_timeout=3000 |\n| Private/shared name collision user confusion | Medium | Low | Option A (private-first) + guidance |\n| Schema migration failures on upgrade | Low | High | schema_version table + sequential migrations |\n| Slack rate limits on heavy usage | Low | Low | Responses are single messages per command |\n\n## Generated Documents\n\n- [x] `docs/requirements.md` — Functional & non-functional requirements\n- [x] `docs/ux_spec.md` — UX specification with all command flows\n- [x] `docs/architecture.md` — Software architecture design\n- [x] `docs/test_plan.md` — Test strategy with 80+ test cases\n- [x] `issues.md` — 20 issues across 7 milestones\n"}, "tool_use_id": "toolu_01An3HYvNqqDh27rGGbfUGuc", "_ts": "2026-02-20T11:34:58+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "content": "# Project Status — OpenClaw TODO Plugin\n\n**Last updated:** 2026-02-20\n\n## Current Phase\n\n**Kickoff complete** — All planning documents generated. Ready to begin implementation.\n\n## Milestones\n\n| Milestone | Description | Status | Issues |\n|-----------|-------------|--------|--------|\n| M0 | Plugin skeleton + `/todo` command registration | Not started | #1 |\n| M1 | DB init + migrations + schema_version | Not started | #2, #3, #4 |\n| M2 | Parser (Slack mention, /p, /s, due correction) | Not started | #5 |\n| M3 | Commands (add/list/board/move/done/drop/edit) | Not started | #6–#12, #16, #17 |\n| M4 | Project commands (list/set-private/set-shared) | Not started | #13, #14, #15 |\n| M5 | Tests (parser/unit + sqlite E2E) | Not started | #18, #19 |\n| M6 | Packaging / deployment | Not started | #20 |\n\n## Critical Path\n\n```\n#1 (skeleton) → #2 (DB conn) → #3 (migration framework) → #4 (V1 schema) → #7 (project resolver) → commands\n#5 (parser) can be developed in parallel with DB track\n```\n\n## Next Issues to Work On\n\n1. **#1** — Plugin skeleton and project scaffold (M0)\n2. **#2** — DB connection manager with WAL + busy_timeout (M1)\n3. **#5** — Command parser / tokenizer (M2, parallelizable)\n\n## Risks\n\n| Risk | Likelihood | Impact | Mitigation |\n|------|-----------|--------|------------|\n| SQLite write contention under concurrent access | Low | Medium | WAL mode + busy_timeout=3000 |\n| Private/shared name collision user confusion | Medium | Low | Option A (private-first) + guidance |\n| Schema migration failures on upgrade | Low | High | schema_version table + sequential migrations |\n| Slack rate limits on heavy usage | Low | Low | Responses are single messages per command |\n\n## Generated Documents\n\n- [x] `docs/requirements.md` — Functional & non-functional requirements\n- [x] `docs/ux_spec.md` — UX specification with all command flows\n- [x] `docs/architecture.md` — Software architecture design\n- [x] `docs/test_plan.md` — Test strategy with 80+ test cases\n- [x] `issues.md` — 20 issues across 7 milestones\n"}, "tool_response": {"type": "create", "filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "content": "# Project Status — OpenClaw TODO Plugin\n\n**Last updated:** 2026-02-20\n\n## Current Phase\n\n**Kickoff complete** — All planning documents generated. Ready to begin implementation.\n\n## Milestones\n\n| Milestone | Description | Status | Issues |\n|-----------|-------------|--------|--------|\n| M0 | Plugin skeleton + `/todo` command registration | Not started | #1 |\n| M1 | DB init + migrations + schema_version | Not started | #2, #3, #4 |\n| M2 | Parser (Slack mention, /p, /s, due correction) | Not started | #5 |\n| M3 | Commands (add/list/board/move/done/drop/edit) | Not started | #6–#12, #16, #17 |\n| M4 | Project commands (list/set-private/set-shared) | Not started | #13, #14, #15 |\n| M5 | Tests (parser/unit + sqlite E2E) | Not started | #18, #19 |\n| M6 | Packaging / deployment | Not started | #20 |\n\n## Critical Path\n\n```\n#1 (skeleton) → #2 (DB conn) → #3 (migration framework) → #4 (V1 schema) → #7 (project resolver) → commands\n#5 (parser) can be developed in parallel with DB track\n```\n\n## Next Issues to Work On\n\n1. **#1** — Plugin skeleton and project scaffold (M0)\n2. **#2** — DB connection manager with WAL + busy_timeout (M1)\n3. **#5** — Command parser / tokenizer (M2, parallelizable)\n\n## Risks\n\n| Risk | Likelihood | Impact | Mitigation |\n|------|-----------|--------|------------|\n| SQLite write contention under concurrent access | Low | Medium | WAL mode + busy_timeout=3000 |\n| Private/shared name collision user confusion | Medium | Low | Option A (private-first) + guidance |\n| Schema migration failures on upgrade | Low | High | schema_version table + sequential migrations |\n| Slack rate limits on heavy usage | Low | Low | Responses are single messages per command |\n\n## Generated Documents\n\n- [x] `docs/requirements.md` — Functional & non-functional requirements\n- [x] `docs/ux_spec.md` — UX specification with all command flows\n- [x] `docs/architecture.md` — Software architecture design\n- [x] `docs/test_plan.md` — Test strategy with 80+ test cases\n- [x] `issues.md` — 20 issues across 7 milestones\n", "structuredPatch": [], "originalFile": null}, "tool_use_id": "toolu_01An3HYvNqqDh27rGGbfUGuc", "_ts": "2026-02-20T11:34:58+0900"}
{"session_id": "2bafd63c-35dc-4008-a792-8a4e0d4b08b4", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "SubagentStop", "stop_hook_active": false, "agent_id": "a7a5fbf", "agent_transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/2bafd63c-35dc-4008-a792-8a4e0d4b08b4/subagents/agent-a7a5fbf.jsonl", "agent_type": "", "_ts": "2026-02-20T11:35:07+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md"}, "tool_use_id": "toolu_015HznGKsc2w7N3dtaDxuu9C", "_ts": "2026-02-20T11:57:58+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md", "content": "# OpenClaw TODO Plugin -- Issues\n\n> Auto-generated from `openclaw_todo_plugin_prd.md` (PRD v1.1)\n> Date: 2026-02-20\n\n---\n\n## Issue #1: Plugin skeleton and entry point\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M0                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/001-plugin-skeleton`          |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nCreate the Python project scaffold: `pyproject.toml` (uv), `src/openclaw_todo/` package layout, and the plugin entry-point that the OpenClaw gateway will load. The plugin must expose a callable that receives raw Slack DM text and a sender context dict.\n\n**Acceptance Criteria**\n- [ ] `pyproject.toml` exists with Python >=3.11, pytest, pytest-cov dev deps\n- [ ] `src/openclaw_todo/__init__.py` exposes `__version__`\n- [ ] `src/openclaw_todo/plugin.py` contains `handle_message(text: str, context: dict) -> str` entry point\n- [ ] Messages not starting with `/todo` are silently ignored (returns `None`)\n- [ ] `uv sync && uv run pytest -q` passes (trivial smoke test)\n\n**Tests**\n- `tests/test_plugin.py::test_ignores_non_todo_message`\n- `tests/test_plugin.py::test_dispatches_todo_prefix`\n\n**Rollback**\nDelete branch; no runtime dependency.\n\n**Observability**\n`logger.debug` on every inbound message; `logger.info` when `/todo` prefix matched.\n\n**Dependencies**\nNone.\n\n---\n\n## Issue #2: DB module -- connection helper and pragma setup\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend / Data                         |\n| Milestone   | M1                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/002-db-connection`            |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `src/openclaw_todo/db.py` with a `get_connection(db_path)` helper that creates the `~/.openclaw/workspace/.todo/` directory tree if missing, opens (or creates) `todo.sqlite3`, and applies `PRAGMA journal_mode=WAL` and `PRAGMA busy_timeout=3000`.\n\n**Acceptance Criteria**\n- [ ] Directory is created recursively when absent\n- [ ] SQLite connection returned with WAL mode enabled\n- [ ] `busy_timeout` is 3000\n- [ ] Calling `get_connection` twice returns usable connections (no lock conflict)\n\n**Tests**\n- `tests/test_db.py::test_creates_directory_and_file` (tmp_path)\n- `tests/test_db.py::test_wal_mode_enabled`\n- `tests/test_db.py::test_busy_timeout`\n\n**Rollback**\nRevert module; no schema changes yet.\n\n**Observability**\n`logger.info` on first DB creation; `logger.debug` on each connection open.\n\n**Dependencies**\n#1\n\n---\n\n## Issue #3: Schema migration framework and schema_version table\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend / Data                         |\n| Milestone   | M1                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/003-schema-migration`         |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement a simple sequential migration runner. On startup, read `schema_version` (create if missing), compare to available migrations list, and apply outstanding migrations in order inside a transaction.\n\n**Acceptance Criteria**\n- [ ] `schema_version` table created with single row `version=0` if absent\n- [ ] Migrations are Python callables registered in an ordered list\n- [ ] Each migration runs inside a transaction; version incremented on success\n- [ ] Re-running on an up-to-date DB is a no-op\n- [ ] Failing migration rolls back and raises with clear message\n\n**Tests**\n- `tests/test_migrations.py::test_fresh_db_gets_version_table`\n- `tests/test_migrations.py::test_applies_migrations_sequentially`\n- `tests/test_migrations.py::test_idempotent_on_rerun`\n- `tests/test_migrations.py::test_rollback_on_failure`\n\n**Rollback**\nDrop `schema_version` table; revert module.\n\n**Observability**\n`logger.info(\"Migrating from version %d to %d\", current, target)` per step.\n\n**Dependencies**\n#2\n\n---\n\n## Issue #4: V1 schema migration -- projects, tasks, task_assignees, events\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend / Data                         |\n| Milestone   | M1                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/004-v1-schema`                |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nRegister migration v1 that creates the four tables (`projects`, `tasks`, `task_assignees`, `events`) with all columns, CHECK constraints, and partial unique indexes as specified in PRD section 6.3. Also seed shared project `Inbox`.\n\n**Acceptance Criteria**\n- [ ] `projects` table with `ux_projects_shared_name` and `ux_projects_private_owner_name` partial unique indexes\n- [ ] `tasks` table with section and status CHECK constraints\n- [ ] `task_assignees` table with composite PK and secondary index\n- [ ] `events` audit table created\n- [ ] Shared `Inbox` project auto-created (INSERT OR IGNORE)\n- [ ] `schema_version` = 1 after migration\n\n**Tests**\n- `tests/test_migrations.py::test_v1_tables_exist`\n- `tests/test_migrations.py::test_v1_inbox_created`\n- `tests/test_migrations.py::test_v1_shared_unique_index_enforced`\n- `tests/test_migrations.py::test_v1_private_unique_index_enforced`\n\n**Rollback**\nDrop all four tables + reset schema_version to 0.\n\n**Observability**\nLog table creation counts.\n\n**Dependencies**\n#3\n\n---\n\n## Issue #5: Command parser -- tokenizer and option extraction\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M2                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/005-parser-tokenizer`         |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `src/openclaw_todo/parser.py` that takes raw message text (after `/todo` prefix) and returns a `ParsedCommand` dataclass containing: `command` (str), `args` (list), `project` (str|None), `section` (str|None), `due` (str|None, normalised to YYYY-MM-DD), `mentions` (list of Slack user IDs), and remaining `title_tokens`.\n\nParsing rules:\n- `/p <name>` extracts project\n- `/s <section>` extracts section (validate against enum)\n- `due:YYYY-MM-DD` or `due:MM-DD` extracts and normalises due date\n- `due:-` clears due (sentinel)\n- `<@U...>` patterns extracted as mentions\n- Everything else before first option token is title\n\n**Acceptance Criteria**\n- [ ] `/p MyProject` correctly extracted; token consumed\n- [ ] `/s doing` validated; invalid section raises `ParseError`\n- [ ] `due:03-15` normalised to `2026-03-15`\n- [ ] `due:2026-02-30` raises `ParseError` (invalid date)\n- [ ] `<@U12345>` extracted into mentions list\n- [ ] Multiple mentions supported\n- [ ] Title tokens are non-option, non-mention tokens before first option\n\n**Tests**\n- `tests/test_parser.py::test_extract_project`\n- `tests/test_parser.py::test_extract_section_valid`\n- `tests/test_parser.py::test_extract_section_invalid`\n- `tests/test_parser.py::test_due_mm_dd_normalisation`\n- `tests/test_parser.py::test_due_full_date`\n- `tests/test_parser.py::test_due_invalid_date`\n- `tests/test_parser.py::test_due_clear`\n- `tests/test_parser.py::test_mentions_extraction`\n- `tests/test_parser.py::test_title_extraction`\n\n**Rollback**\nRevert module; no side effects.\n\n**Observability**\n`logger.debug(\"Parsed: %s\", parsed_command)`\n\n**Dependencies**\n#1\n\n---\n\n## Issue #6: /todo add command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/006-cmd-add`                  |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `add` subcommand handler. Resolves project (default `Inbox`), applies defaults (section=`backlog`, assignees=sender if none mentioned), validates private-project assignee constraint (PRD 3.3), inserts task + task_assignees rows, logs event, and returns formatted confirmation.\n\n**Acceptance Criteria**\n- [ ] Task inserted with correct project_id, section, due, status='open', created_by\n- [ ] Assignees default to sender when no mentions\n- [ ] Multiple mentions create multiple task_assignee rows\n- [ ] Private project + non-owner assignee returns warning and does NOT insert\n- [ ] Non-existent project: `Inbox` auto-created as shared; others return error\n- [ ] Response format: `Added #<id> (<project>/<section>) due:<due|-> assignees:<mentions> -- <title>`\n- [ ] Event row written to `events` table\n\n**Tests**\n- `tests/test_cmd_add.py::test_add_default_inbox`\n- `tests/test_cmd_add.py::test_add_with_project_section_due`\n- `tests/test_cmd_add.py::test_add_private_rejects_other_assignee`\n- `tests/test_cmd_add.py::test_add_assignee_defaults_to_sender`\n- `tests/test_cmd_add.py::test_add_multiple_assignees`\n\n**Rollback**\nRevert handler; tasks table unchanged structurally.\n\n**Observability**\n`logger.info(\"Task #%d created in %s/%s by %s\", id, project, section, sender)`\n\n**Dependencies**\n#4, #5\n\n---\n\n## Issue #7: Project resolver helper\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/007-project-resolver`         |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `resolve_project(conn, name, sender_id) -> Project` following PRD 3.2 (Option A): sender's private project with that name takes priority, then shared, then error/auto-create for Inbox.\n\n**Acceptance Criteria**\n- [ ] Private project of sender matched first\n- [ ] Falls back to shared if no private match\n- [ ] Returns error when neither exists (except Inbox which is auto-created)\n- [ ] Returns project row with id, name, visibility, owner_user_id\n\n**Tests**\n- `tests/test_project_resolver.py::test_private_takes_priority`\n- `tests/test_project_resolver.py::test_falls_back_to_shared`\n- `tests/test_project_resolver.py::test_inbox_auto_created`\n- `tests/test_project_resolver.py::test_unknown_project_error`\n\n**Rollback**\nRevert module.\n\n**Observability**\n`logger.debug(\"Resolved project '%s' -> id=%d vis=%s\", name, id, visibility)`\n\n**Dependencies**\n#4\n\n---\n\n## Issue #8: /todo list command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/008-cmd-list`                 |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `list` subcommand. Supports scope (mine/all/<@USER>), project filter, section filter, status filter (open/done/drop), and limit. Sorting: due ASC (NULLs last), then id DESC. Excludes other users' private projects.\n\n**Acceptance Criteria**\n- [ ] Default scope=mine, status=open, limit=30\n- [ ] `mine` filters to tasks where sender is an assignee\n- [ ] `all` includes shared + sender's private (excludes others' private)\n- [ ] `/p` and `/s` filters applied correctly\n- [ ] Sorting: due NOT NULL first, due ASC, id DESC\n- [ ] limit:N respected\n- [ ] Output lists tasks in formatted lines\n\n**Tests**\n- `tests/test_cmd_list.py::test_list_mine_default`\n- `tests/test_cmd_list.py::test_list_all_excludes_others_private`\n- `tests/test_cmd_list.py::test_list_with_project_filter`\n- `tests/test_cmd_list.py::test_list_sorting_order`\n- `tests/test_cmd_list.py::test_list_limit`\n\n**Rollback**\nRevert handler; read-only operation.\n\n**Observability**\n`logger.info(\"list: scope=%s project=%s returned %d rows\", scope, project, count)`\n\n**Dependencies**\n#6, #7\n\n---\n\n## Issue #9: /todo board command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/009-cmd-board`                |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `board` subcommand. Groups tasks by section in fixed order (BACKLOG, DOING, WAITING, DONE, DROP), applies scope/project/status filters, and limits per section. Format: section headers with task lines underneath.\n\n**Acceptance Criteria**\n- [ ] Sections displayed in order: BACKLOG -> DOING -> WAITING -> DONE -> DROP\n- [ ] Empty sections shown with \"(empty)\" or omitted (decide and document)\n- [ ] `limitPerSection:N` caps items per section (default 10)\n- [ ] Scope/project filters identical to `list`\n- [ ] Each task line: `#id due:<date|-> assignees:<@U..> title`\n\n**Tests**\n- `tests/test_cmd_board.py::test_board_section_order`\n- `tests/test_cmd_board.py::test_board_limit_per_section`\n- `tests/test_cmd_board.py::test_board_scope_filter`\n\n**Rollback**\nRevert handler; read-only operation.\n\n**Observability**\n`logger.info(\"board: scope=%s project=%s sections=%s\", ...)`\n\n**Dependencies**\n#8\n\n---\n\n## Issue #10: /todo move command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/010-cmd-move`                 |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `move` subcommand. Validates section enum, checks permissions (private: owner only; shared: assignee or created_by), updates task section and updated_at, logs event.\n\n**Acceptance Criteria**\n- [ ] Section validated against enum; invalid returns error\n- [ ] Private project: only owner can move\n- [ ] Shared project: only assignee or created_by can move\n- [ ] `updated_at` set on change\n- [ ] Event logged\n- [ ] Response confirms new section\n\n**Tests**\n- `tests/test_cmd_move.py::test_move_valid_section`\n- `tests/test_cmd_move.py::test_move_invalid_section`\n- `tests/test_cmd_move.py::test_move_private_owner_only`\n- `tests/test_cmd_move.py::test_move_shared_permission`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"Task #%d moved to %s by %s\", id, section, sender)`\n\n**Dependencies**\n#6, #7\n\n---\n\n## Issue #11: /todo done and /todo drop commands\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/011-cmd-done-drop`            |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `done` and `drop` subcommands. Both set section and status accordingly, record `closed_at`, validate permissions same as `move`, and log event.\n\n**Acceptance Criteria**\n- [ ] `done`: section='done', status='done', closed_at=now\n- [ ] `drop`: section='drop', status='dropped', closed_at=now\n- [ ] Permissions enforced (same as move)\n- [ ] Already-closed task returns informational message (idempotent or error -- decide)\n- [ ] Event logged for each\n\n**Tests**\n- `tests/test_cmd_done_drop.py::test_done_sets_fields`\n- `tests/test_cmd_done_drop.py::test_drop_sets_fields`\n- `tests/test_cmd_done_drop.py::test_permission_check`\n- `tests/test_cmd_done_drop.py::test_already_done`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"Task #%d %s by %s\", id, action, sender)`\n\n**Dependencies**\n#10\n\n---\n\n## Issue #12: /todo edit command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/012-cmd-edit`                 |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `edit` subcommand (v1 replace semantics). Supports changing title, assignees (full replace), project, section, and due. Validates private-project assignee constraint on both source and target project. Logs event with old/new diff in payload.\n\n**Acceptance Criteria**\n- [ ] Title updated only if non-option tokens present\n- [ ] Mentions present -> assignees fully replaced (DELETE + INSERT)\n- [ ] `due:-` clears due to NULL\n- [ ] `/p <newProject>` moves task to new project (project_id updated)\n- [ ] Private project assignee validation applied to target project\n- [ ] If moving to private project with non-owner assignees -> warning, no change\n- [ ] Event payload contains changed fields\n- [ ] Permissions: private owner only; shared assignee/created_by\n\n**Tests**\n- `tests/test_cmd_edit.py::test_edit_title`\n- `tests/test_cmd_edit.py::test_edit_assignees_replace`\n- `tests/test_cmd_edit.py::test_edit_due_clear`\n- `tests/test_cmd_edit.py::test_edit_move_project`\n- `tests/test_cmd_edit.py::test_edit_private_assignee_rejected`\n- `tests/test_cmd_edit.py::test_edit_no_change_fields`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"Task #%d edited by %s: fields=%s\", id, sender, changed_fields)`\n\n**Dependencies**\n#6, #7, #10\n\n---\n\n## Issue #13: /todo project list command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M4                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/013-cmd-project-list`         |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `/todo project list`. Returns all shared projects and the sender's private projects. Format: grouped by visibility with name and task count.\n\n**Acceptance Criteria**\n- [ ] Shared projects listed regardless of sender\n- [ ] Sender's private projects listed\n- [ ] Other users' private projects NOT shown\n- [ ] Each project shows name, visibility, task count\n\n**Tests**\n- `tests/test_cmd_project.py::test_project_list_shows_shared`\n- `tests/test_cmd_project.py::test_project_list_shows_own_private`\n- `tests/test_cmd_project.py::test_project_list_hides_others_private`\n\n**Rollback**\nRevert handler; read-only.\n\n**Observability**\n`logger.info(\"project list: %d shared, %d private for %s\", ...)`\n\n**Dependencies**\n#7\n\n---\n\n## Issue #14: /todo project set-private command with assignee validation\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M4                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/014-cmd-project-set-private`  |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `/todo project set-private <name>` with the assignee validation described in PRD 3.4. Resolution flow: if sender already has private with that name -> noop; if shared exists -> attempt conversion; if neither -> create new private. Conversion scans all tasks in the project and rejects if any task has a non-owner assignee.\n\n**Acceptance Criteria**\n- [ ] Already-private for sender: returns \"already private\" message\n- [ ] Shared -> private: scans tasks; all assignees are owner -> success (visibility='private', owner_user_id=sender)\n- [ ] Shared -> private: at least one non-owner assignee -> error with task IDs and violating assignee list (max 10)\n- [ ] Neither exists: creates new private project with owner=sender\n- [ ] Error message format matches PRD example\n- [ ] Event logged\n\n**Tests**\n- `tests/test_cmd_project.py::test_set_private_already_private`\n- `tests/test_cmd_project.py::test_set_private_shared_success`\n- `tests/test_cmd_project.py::test_set_private_shared_rejected_non_owner_assignee`\n- `tests/test_cmd_project.py::test_set_private_creates_new`\n- `tests/test_cmd_project.py::test_set_private_error_message_format`\n\n**Rollback**\nRevert handler; no schema change.\n\n**Observability**\n`logger.info(\"project set-private: %s result=%s by %s\", name, result, sender)`\n\n**Dependencies**\n#7, #13\n\n---\n\n## Issue #15: /todo project set-shared command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M4                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/015-cmd-project-set-shared`   |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `/todo project set-shared <name>`. Creates a shared project if none exists. If a shared project with that name already exists, noop. Global uniqueness enforced by DB index.\n\n**Acceptance Criteria**\n- [ ] New shared project created when name is free\n- [ ] Existing shared project: returns \"already shared\" / noop\n- [ ] Name conflict with existing shared: returns exists message (index enforces)\n- [ ] Event logged\n\n**Tests**\n- `tests/test_cmd_project.py::test_set_shared_creates_new`\n- `tests/test_cmd_project.py::test_set_shared_already_exists_noop`\n- `tests/test_cmd_project.py::test_set_shared_name_conflict`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"project set-shared: %s result=%s\", name, result)`\n\n**Dependencies**\n#7, #13\n\n---\n\n## Issue #16: Command dispatcher and routing\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/016-dispatcher`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the dispatcher in `plugin.py` that maps the parsed command name to handler functions: `add`, `list`, `board`, `move`, `done`, `drop`, `edit`, `project`. The `project` command further dispatches to `list`, `set-private`, `set-shared`. Unknown commands return a help/error message.\n\n**Acceptance Criteria**\n- [ ] All valid command names routed to correct handler\n- [ ] `project` subcommands routed correctly\n- [ ] Unknown command returns usage hint\n- [ ] DB connection initialised (migration check) before first command execution\n\n**Tests**\n- `tests/test_dispatcher.py::test_routes_known_commands`\n- `tests/test_dispatcher.py::test_project_sub_routing`\n- `tests/test_dispatcher.py::test_unknown_command_help`\n\n**Rollback**\nRevert module.\n\n**Observability**\n`logger.info(\"Dispatching command=%s sub=%s\", command, sub)`\n\n**Dependencies**\n#5\n\n---\n\n## Issue #17: Permission helper module\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/017-permissions`              |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nExtract shared permission-checking logic into `src/openclaw_todo/permissions.py`. Provides `can_write_task(conn, task_id, sender_id) -> bool` and `validate_private_assignees(project, assignees, owner_id) -> Optional[str]` (returns warning message or None).\n\n**Acceptance Criteria**\n- [ ] Private project: only owner can write\n- [ ] Shared project: only assignee or created_by can write\n- [ ] `validate_private_assignees` returns warning string when non-owner assignees present for private project\n- [ ] Returns None for shared projects or when all assignees are owner\n\n**Tests**\n- `tests/test_permissions.py::test_private_owner_can_write`\n- `tests/test_permissions.py::test_private_non_owner_rejected`\n- `tests/test_permissions.py::test_shared_assignee_can_write`\n- `tests/test_permissions.py::test_shared_creator_can_write`\n- `tests/test_permissions.py::test_validate_private_assignees_warning`\n\n**Rollback**\nRevert module.\n\n**Observability**\n`logger.debug(\"Permission check: task=%d sender=%s result=%s\", ...)`\n\n**Dependencies**\n#4\n\n---\n\n## Issue #18: Parser unit tests (comprehensive)\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | QA                                     |\n| Milestone   | M5                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/018-parser-tests`             |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nExpand parser test coverage to include edge cases: multiple options in varied order, due at year boundary, empty title, mentions mixed with options, unicode in titles, extra whitespace handling.\n\n**Acceptance Criteria**\n- [ ] >=95% line coverage on `parser.py`\n- [ ] Edge cases documented in test docstrings\n- [ ] All tests pass with `uv run pytest tests/test_parser.py -v`\n\n**Tests**\n- `tests/test_parser.py::test_options_in_any_order`\n- `tests/test_parser.py::test_due_year_boundary`\n- `tests/test_parser.py::test_empty_title_no_crash`\n- `tests/test_parser.py::test_unicode_title`\n- `tests/test_parser.py::test_extra_whitespace`\n- `tests/test_parser.py::test_mixed_mentions_and_options`\n\n**Rollback**\nRevert test file; no production code change.\n\n**Observability**\nCI coverage report.\n\n**Dependencies**\n#5\n\n---\n\n## Issue #19: SQLite end-to-end integration tests\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | QA                                     |\n| Milestone   | M5                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/019-e2e-tests`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nWrite integration tests that exercise the full flow through `handle_message` with a real (tmp_path) SQLite database. Cover the main user stories: add a task, list it, move it, mark done, edit it, manage projects, and validate private project constraints.\n\n**Acceptance Criteria**\n- [ ] Each test uses a fresh DB via `tmp_path` fixture\n- [ ] Scenarios: add->list, add->move->board, add->done, add->edit, project set-private rejection\n- [ ] Private project visibility enforced end-to-end\n- [ ] Due normalisation verified in DB\n- [ ] All tests pass with `uv run pytest tests/test_e2e.py -v`\n\n**Tests**\n- `tests/test_e2e.py::test_add_and_list_roundtrip`\n- `tests/test_e2e.py::test_add_move_board`\n- `tests/test_e2e.py::test_done_and_drop`\n- `tests/test_e2e.py::test_edit_title_and_assignees`\n- `tests/test_e2e.py::test_private_project_isolation`\n- `tests/test_e2e.py::test_set_private_rejects_foreign_assignees`\n- `tests/test_e2e.py::test_due_normalisation_stored_correctly`\n\n**Rollback**\nRevert test file.\n\n**Observability**\nCI test results and coverage delta.\n\n**Dependencies**\n#6, #8, #9, #10, #11, #12, #14, #15\n\n---\n\n## Issue #20: Packaging and distribution setup\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | DevOps                                 |\n| Milestone   | M6                                     |\n| Status      | TODO                                   |\n| Priority    | P2                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/020-packaging`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nFinalise `pyproject.toml` metadata (name, version, description, license, entry-points), add a `Makefile` with targets for lint/test/build, and document installation instructions in README. Ensure the plugin can be installed as a package and discovered by the OpenClaw gateway.\n\n**Acceptance Criteria**\n- [ ] `pyproject.toml` has complete metadata and entry-point for OpenClaw plugin discovery\n- [ ] `make lint` runs ruff + black --check\n- [ ] `make test` runs pytest with coverage\n- [ ] `make build` produces a wheel via `uv build`\n- [ ] `pip install <wheel>` in a clean venv makes the plugin importable\n- [ ] README documents installation and configuration (DB path env var)\n\n**Tests**\n- Manual: install wheel in fresh venv, import module, call `handle_message`\n- `make test` passes in CI\n\n**Rollback**\nRevert packaging changes.\n\n**Observability**\nBuild artifact size logged; CI publishes wheel as artifact.\n\n**Dependencies**\n#19\n\n---\n\n## Dependency Graph (summary)\n\n```\n#1  Plugin skeleton\n |\n +--#2  DB connection\n |   |\n |   +--#3  Migration framework\n |       |\n |       +--#4  V1 schema\n |           |\n |           +--#7  Project resolver\n |           |   |\n |           |   +--#13 project list\n |           |   +--#14 project set-private\n |           |   +--#15 project set-shared\n |           |\n |           +--#17 Permissions helper\n |\n +--#5  Parser\n |   |\n |   +--#18 Parser tests (M5)\n |\n +--#16 Dispatcher\n     |\n     +--#6  cmd add       (#4,#5,#7,#17)\n     +--#8  cmd list      (#6,#7)\n     +--#9  cmd board     (#8)\n     +--#10 cmd move      (#6,#7,#17)\n     +--#11 cmd done/drop (#10)\n     +--#12 cmd edit      (#6,#7,#10,#17)\n\n#19 E2E tests    (all commands)\n#20 Packaging    (#19)\n```\n", "numLines": 863, "startLine": 1, "totalLines": 863}}, "tool_use_id": "toolu_015HznGKsc2w7N3dtaDxuu9C", "_ts": "2026-02-20T11:57:59+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "gh auth status 2>&1", "description": "Check gh authentication status"}, "tool_use_id": "toolu_01V4MqNtac1X9asLf3qHdT7v", "_ts": "2026-02-20T11:57:59+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "gh auth status 2>&1", "description": "Check gh authentication status"}, "tool_response": {"stdout": "github.com\n  ✓ Logged in to github.com account pillip (keyring)\n  - Active account: true\n  - Git operations protocol: https\n  - Token: gho_************************************\n  - Token scopes: 'gist', 'read:org', 'repo', 'workflow'", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_01V4MqNtac1X9asLf3qHdT7v", "_ts": "2026-02-20T11:58:02+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md"}, "tool_use_id": "toolu_01U1p81ZQdHWRrEuqG7jKGdz", "_ts": "2026-02-20T11:58:08+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/openclaw_todo_plugin_prd.md", "content": "# OpenClaw TODO Plugin for Slack — PRD v1.1 (DM 기반)\n\n> 변경사항 반영:\n> 1) Slack **슬래시 커맨드 미사용** → **DM(또는 앱 멘션/일반 메시지)에서 `/todo …`**로 사용  \n> 2) private 프로젝트: **same owner 내 name 유니크**  \n> 3) `/todo project set-private` 실행 시: 해당 프로젝트 내 task 중 **owner가 아닌 assignee가 하나라도 있으면 에러**  \n> 4) 프로젝트 이름 충돌 해소: **옵션 A(private 우선)** 유지  \n> 5) DB **초기 생성/마이그레이션** 절차 추가\n\n---\n\n## 1) 개요\n\n### 1.1 목표\nOpenClaw 플러그인으로 Slack에서 다음을 **LLM 호출 없이(=비용 0)** 처리하는 팀/개인용 TODO 시스템을 제공한다.\n\n- `/todo add|list|board|move|done|drop|edit`\n- `/todo project list|set-private|set-shared`\n- 저장소: **공유 SQLite3** (동일 Gateway/동일 DB 파일)\n- 담당자(assignee): **Slack 멘션만 허용** (`<@U…>` 기반)\n- due: `YYYY-MM-DD` 또는 `MM-DD` 허용, 연도 생략 시 **현재 연도**로 보정\n- Private 프로젝트: **오직 owner만** 조회/수정 가능\n\n---\n\n## 2) Slack 사용 방식 (슬래시 커맨드 미사용)\n\n### 2.1 사용 채널\n슬래시 커맨드를 쓰지 않는다면, 일반적으로 다음 중 하나로 사용한다.\n\n- **DM 채널**: OpenClaw Slack 앱(봇)과 1:1 대화에서 `/todo …` 입력  \n- **채널/스레드**(옵션): 앱 멘션(`@openclaw /todo …`) 또는 특정 메시지 패턴을 OpenClaw가 수신하도록 설정된 경우\n\n> v1은 **DM 사용을 기본 경로**로 가정한다.  \n> 이유: 권한/노이즈/오작동 리스크가 낮고 운영이 단순함.\n\n### 2.2 커맨드 인식 규칙\n- 메시지의 첫 토큰이 `/todo`이면 플러그인이 처리한다.\n- 그 외 메시지는 v1에서 무시(자연어 자동 등록은 Phase 2).\n\n---\n\n## 3) 핵심 정책\n\n### 3.1 프로젝트 이름 유니크 정책\n- **Shared 프로젝트**: 전역 유니크 (겹치면 생성/변경 거부)\n- **Private 프로젝트**: **same owner 내에서만 유니크** (owner가 다르면 동일 name 허용)\n\n### 3.2 프로젝트 이름 충돌 해소(옵션 A)\n`/p <name>` 해석:\n1) sender(owner)의 private 프로젝트 `<name>`가 존재하면 **private 우선**\n2) 없으면 shared `<name>` 사용\n3) 둘 다 없으면 (v1 정책에 따라) shared 자동 생성 또는 에러\n\n> 운영 가이드: private와 shared에 같은 이름을 쓰지 않는 것을 권장(혼란 방지).\n\n### 3.3 Private 프로젝트 assignee 제한(“경고 후 거부”)\n- private 프로젝트는 **owner만 볼 수 있는 범위**이므로:\n  - add/edit 시 owner 이외의 assignee가 포함되면 **경고 메시지 출력 후 작업 거부(변경/생성 미적용)**\n\n경고/거부 응답 예시:\n- `⚠️ Private 프로젝트(Personal)는 owner만 볼 수 있어요. 다른 담당자(<@U…>)를 지정할 수 없습니다. (요청이 적용되지 않았습니다.)`\n\n### 3.4 `/todo project set-private` 추가 제약(요구사항)\n- 프로젝트를 private로 전환할 때,\n  - 해당 프로젝트 내 모든 task를 스캔하여\n  - **owner가 아닌 assignee가 하나라도 존재하면 에러**로 실패해야 한다.\n- 에러 메시지에는 최소한 아래 정보를 포함한다:\n  - 실패 사유\n  - 위반 task id 목록 일부(예: 최대 10개)\n  - 위반 assignee 목록 일부\n\n에러 예시:\n- `❌ Cannot set project \"Biz\" to private: found tasks assigned to non-owner users. e.g. #12 assignees:<@U2>, #18 assignees:<@U3>`\n\n---\n\n## 4) due 파서 정책\n\n허용 입력:\n- `due:YYYY-MM-DD`\n- `due:MM-DD` 또는 `due:M-D`\n\n보정:\n- 연도 생략 시: `YYYY = now().year` (서버 timezone은 Asia/Seoul 권장)\n\n검증:\n- 유효하지 않은 날짜(예: 02-30)는 에러\n- DB에는 항상 `YYYY-MM-DD`로 저장\n\n---\n\n## 5) 커맨드 스펙\n\n### 5.0 공통 토큰\n- 프로젝트: `/p <projectName>`\n- 섹션: `/s <section>`\n- 섹션 enum: `backlog | doing | waiting | done | drop`\n- due: `due:YYYY-MM-DD|MM-DD` 또는 `due:-`(클리어)\n\n---\n\n### 5.1 `/todo add`\n문법:\n```\n/todo add <title...> [<@USER> ...] [/p <project>] [/s <section>] [due:YYYY-MM-DD|MM-DD]\n```\n\n기본값:\n- project: `Inbox`\n- section: `backlog`\n- assignees:\n  - 멘션 없으면 sender\n  - 멘션 있으면 해당 유저들(다중)\n- due: 없으면 NULL\n\n검증:\n- private 프로젝트에 sender 외 assignee 포함 시: **경고 후 거부**\n- 프로젝트가 없으면:\n  - `Inbox`는 shared로 자동 생성 가능(권장)\n\n응답:\n- `✅ Added #123 (Inbox/backlog) due:- assignees:<@U1> — 장보기`\n\n---\n\n### 5.2 `/todo list`\n문법:\n```\n/todo list [mine|all|<@USER>] [/p <project>] [/s <section>] [open|done|drop] [limit:N]\n```\n\n기본값:\n- scope: `mine`\n- status: `open`\n- limit: 30\n\nscope 의미:\n- `mine`: assignees에 sender 포함\n- `<@USER>`: 해당 유저가 assignee인 task\n- `all`: shared 전체 + sender의 private 프로젝트(타인의 private는 제외)\n\n정렬:\n1) due 있는 것 우선\n2) due 오름차순\n3) id 내림차순\n\n---\n\n### 5.3 `/todo board`\n문법:\n```\n/todo board [mine|all|<@USER>] [/p <project>] [open|done|drop] [limitPerSection:N]\n```\n\n기본값:\n- scope: mine\n- status: open\n- limitPerSection: 10\n\n출력:\n- BACKLOG → DOING → WAITING → DONE → DROP 순\n- 항목 포맷: `#id due:YYYY-MM-DD| - assignees:<@U..> <@U..> title`\n\n---\n\n### 5.4 `/todo move`\n문법:\n```\n/todo move <id> <section>\n```\n\n검증:\n- 섹션 enum validate\n- 권한:\n  - private: owner만\n  - shared: v1 권장 `assignee` 또는 `created_by`만 수정 가능\n\n---\n\n### 5.5 `/todo done`\n```\n/todo done <id>\n```\n- section=`done`, status=`done`, closed_at 기록\n\n### 5.6 `/todo drop`\n```\n/todo drop <id>\n```\n- section=`drop`, status=`dropped`, closed_at 기록\n\n---\n\n### 5.7 `/todo edit`\n문법(v1 replace 방식):\n```\n/todo edit <id> [<new title...>] [<@USER> ...] [/p <project>] [/s <section>] [due:YYYY-MM-DD|MM-DD|due:-]\n```\n\n규칙:\n- 멘션이 있으면 assignees **완전 교체**\n- `due:-` 는 due NULL\n- title은 옵션 토큰 이전 텍스트를 새 title로 간주(비어있으면 변경 없음)\n\n검증:\n- private 프로젝트로 변경되거나 private 프로젝트에서 assignee 변경 시:\n  - sender 외 assignee 포함이면 **경고 후 거부(변경 미적용)**\n\n---\n\n### 5.8 `/todo project list`\n- 반환:\n  - shared 프로젝트 목록\n  - sender(owner)의 private 프로젝트 목록\n\n---\n\n### 5.9 `/todo project set-private <name>`\n동작:\n1) 대상 프로젝트를 resolve:\n   - sender의 private `<name>` 존재 → already private (ok)\n   - 없고 shared `<name>` 존재 → shared를 private로 “전환 시도”\n   - 둘 다 없으면 → sender private `<name>` 생성 (owner=sender)\n\n2) shared→private 전환 시도 시 검증:\n   - 해당 프로젝트 내 tasks를 조회\n   - 각 task에 대해 `task_assignees`를 확인\n   - **owner(sender) 외 assignee가 하나라도 존재하면 실패(에러)**\n\n3) 성공 시:\n   - projects.visibility='private', owner_user_id=sender\n   - (선택) 기존 task의 assignees가 모두 owner인지 확인되므로 유지 가능\n\n---\n\n### 5.10 `/todo project set-shared <name>`\n동작:\n- shared `<name>`이 없으면 생성\n- 이미 있으면 noop\n- 단, shared는 전역 유니크이므로 충돌 시 에러/exists\n\n---\n\n## 6) 데이터 모델 (SQLite3)\n\n### 6.1 DB 파일 위치\n- 기본: `~/.openclaw/workspace/.todo/todo.sqlite3`\n\n### 6.2 동시성 설정\n- `PRAGMA journal_mode=WAL;`\n- `PRAGMA busy_timeout=3000;`\n\n### 6.3 스키마(v1)\n\n#### `projects`\n- `id` INTEGER PK AUTOINCREMENT\n- `name` TEXT NOT NULL\n- `visibility` TEXT NOT NULL CHECK (visibility IN ('shared','private'))\n- `owner_user_id` TEXT NULL\n- `created_at` TEXT NOT NULL DEFAULT (datetime('now'))\n- `updated_at` TEXT NOT NULL DEFAULT (datetime('now'))\n\nIndexes:\n- shared 전역 유니크:\n  - `CREATE UNIQUE INDEX ux_projects_shared_name ON projects(name) WHERE visibility='shared';`\n- private owner 내 유니크:\n  - `CREATE UNIQUE INDEX ux_projects_private_owner_name ON projects(owner_user_id, name) WHERE visibility='private';`\n\n#### `tasks`\n- `id` INTEGER PK AUTOINCREMENT\n- `title` TEXT NOT NULL\n- `project_id` INTEGER NOT NULL REFERENCES projects(id)\n- `section` TEXT NOT NULL CHECK (section IN ('backlog','doing','waiting','done','drop'))\n- `due` TEXT NULL  -- YYYY-MM-DD\n- `status` TEXT NOT NULL CHECK (status IN ('open','done','dropped'))\n- `created_by` TEXT NOT NULL  -- Slack user id\n- `created_at`, `updated_at`, `closed_at`\n\n#### `task_assignees`\n- `task_id` INTEGER NOT NULL REFERENCES tasks(id)\n- `assignee_user_id` TEXT NOT NULL\n- PRIMARY KEY(task_id, assignee_user_id)\n- INDEX: `(assignee_user_id, task_id)`\n\n#### `events` (audit, 권장)\n- `id` INTEGER PK\n- `ts` TEXT\n- `actor_user_id` TEXT\n- `action` TEXT\n- `task_id` INTEGER NULL\n- `payload` TEXT (JSON)\n\n---\n\n## 7) DB 초기 생성 / 마이그레이션(필수)\n\n### 7.1 생성 타이밍\n플러그인 로딩 후 첫 `/todo …` 실행 시 또는 gateway startup 시점에 아래를 수행:\n\n1) workspace path 결정\n2) `~/.openclaw/workspace/.todo/` 디렉토리 생성\n3) `todo.sqlite3` 파일 존재 여부 확인\n4) 없으면:\n   - 파일 생성\n   - schema migration 실행\n   - `schema_version` 테이블 생성 및 version=1 기록\n\n### 7.2 schema_version 테이블\n- `schema_version(version INTEGER NOT NULL)`\n- 초기: 1\n- 향후:\n  - 현재 버전 읽고, 필요한 migration 순차 실행\n\n### 7.3 기본 프로젝트 생성(권장)\n- DB 초기화 시 shared 프로젝트 `Inbox` 자동 생성 (중복이면 noop)\n\n---\n\n## 8) 권한/가시성\n\n### 8.1 읽기\n- private: owner만\n- shared: scope에 따라 mine/all/<@USER>\n\n### 8.2 쓰기\n- private: owner만\n- shared: v1 권장 `assignee` 또는 `created_by`만\n\n---\n\n## 9) 수용 기준(Acceptance Criteria)\n\n- [ ] shared 프로젝트 이름 충돌 시 생성/변경 거부\n- [ ] private 프로젝트는 owner 단위로 유니크 (owner A/B는 같은 name 허용)\n- [ ] `/todo project set-private <name>` 실행 시:\n  - 프로젝트 내 task 중 owner 외 assignee 존재하면 에러로 실패\n- [ ] private 프로젝트에 타 assignee 지정 시: 경고 + 작업 미생성/미수정\n- [ ] due `MM-DD` 입력 시 올해로 보정되어 저장\n- [ ] DB 최초 실행 시 파일 생성 + schema 적용 + Inbox 생성\n\n---\n\n## 10) 구현 작업 분해(WBS)\n\n- M0: plugin skeleton + `/todo` command 등록\n- M1: DB init + migrations + schema_version\n- M2: parser (Slack mention, /p, /s, due 보정)\n- M3: commands (add/list/board/move/done/drop/edit)\n- M4: project commands (list/set-private/set-shared + set-private 검증 로직)\n- M5: tests (parser/unit + sqlite E2E)\n- M6: packaging/배포(npm 권장)\n", "numLines": 353, "startLine": 1, "totalLines": 353}}, "tool_use_id": "toolu_01U1p81ZQdHWRrEuqG7jKGdz", "_ts": "2026-02-20T11:58:08+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md"}, "tool_use_id": "toolu_01PUj7KFTo4YTeeovJCgwF2k", "_ts": "2026-02-20T11:58:08+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "content": "# Project Status — OpenClaw TODO Plugin\n\n**Last updated:** 2026-02-20\n\n## Current Phase\n\n**Kickoff complete** — All planning documents generated. Ready to begin implementation.\n\n## Milestones\n\n| Milestone | Description | Status | Issues |\n|-----------|-------------|--------|--------|\n| M0 | Plugin skeleton + `/todo` command registration | Not started | #1 |\n| M1 | DB init + migrations + schema_version | Not started | #2, #3, #4 |\n| M2 | Parser (Slack mention, /p, /s, due correction) | Not started | #5 |\n| M3 | Commands (add/list/board/move/done/drop/edit) | Not started | #6–#12, #16, #17 |\n| M4 | Project commands (list/set-private/set-shared) | Not started | #13, #14, #15 |\n| M5 | Tests (parser/unit + sqlite E2E) | Not started | #18, #19 |\n| M6 | Packaging / deployment | Not started | #20 |\n\n## Critical Path\n\n```\n#1 (skeleton) → #2 (DB conn) → #3 (migration framework) → #4 (V1 schema) → #7 (project resolver) → commands\n#5 (parser) can be developed in parallel with DB track\n```\n\n## Next Issues to Work On\n\n1. **#1** — Plugin skeleton and project scaffold (M0)\n2. **#2** — DB connection manager with WAL + busy_timeout (M1)\n3. **#5** — Command parser / tokenizer (M2, parallelizable)\n\n## Risks\n\n| Risk | Likelihood | Impact | Mitigation |\n|------|-----------|--------|------------|\n| SQLite write contention under concurrent access | Low | Medium | WAL mode + busy_timeout=3000 |\n| Private/shared name collision user confusion | Medium | Low | Option A (private-first) + guidance |\n| Schema migration failures on upgrade | Low | High | schema_version table + sequential migrations |\n| Slack rate limits on heavy usage | Low | Low | Responses are single messages per command |\n\n## Generated Documents\n\n- [x] `docs/requirements.md` — Functional & non-functional requirements\n- [x] `docs/ux_spec.md` — UX specification with all command flows\n- [x] `docs/architecture.md` — Software architecture design\n- [x] `docs/test_plan.md` — Test strategy with 80+ test cases\n- [x] `issues.md` — 20 issues across 7 milestones\n", "numLines": 50, "startLine": 1, "totalLines": 50}}, "tool_use_id": "toolu_01PUj7KFTo4YTeeovJCgwF2k", "_ts": "2026-02-20T11:58:08+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "ls -la /Users/pillip/project/practice/openclaw_todo_plugin/", "description": "List repo contents"}, "tool_use_id": "toolu_01LaJofbSsaAZjmxyiMmGiW2", "_ts": "2026-02-20T11:58:09+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "ls -la /Users/pillip/project/practice/openclaw_todo_plugin/", "description": "List repo contents"}, "tool_response": {"stdout": "total 120\ndrwxr-xr-x  11 pillip  staff    352  2월 20 11:34 .\ndrwxr-xr-x@ 27 pillip  staff    864  2월 20 11:28 ..\ndrwxr-xr-x   7 pillip  staff    224  2월 20 11:31 .claude\ndrwxr-xr-x  13 pillip  staff    416  2월 20 11:29 .claude-kit\ndrwxr-xr-x  13 pillip  staff    416  2월 20 11:57 .git\n-rw-r--r--   1 pillip  staff     94  2월 20 11:29 .gitmodules\ndrwxr-xr-x   7 pillip  staff    224  2월 20 11:34 docs\n-rw-r--r--   1 pillip  staff  33697  2월 20 11:34 issues.md\n-rw-r--r--@  1 pillip  staff  10661  2월 20 11:26 openclaw_todo_plugin_prd.md\n-rw-r--r--   1 pillip  staff     22  2월 20 11:28 README.md\n-rw-r--r--   1 pillip  staff   2056  2월 20 11:34 STATUS.md", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_01LaJofbSsaAZjmxyiMmGiW2", "_ts": "2026-02-20T11:58:09+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "TaskCreate", "tool_input": {"subject": "Create GH Issue for Issue #1", "description": "Create GitHub issue with title, body from issues.md acceptance criteria", "activeForm": "Creating GitHub issue"}, "tool_use_id": "toolu_01Q4biJgLnkj2wVmKcPN9E2S", "_ts": "2026-02-20T11:58:18+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "TaskCreate", "tool_input": {"subject": "Create GH Issue for Issue #1", "description": "Create GitHub issue with title, body from issues.md acceptance criteria", "activeForm": "Creating GitHub issue"}, "tool_response": {"task": {"id": "1", "subject": "Create GH Issue for Issue #1"}}, "tool_use_id": "toolu_01Q4biJgLnkj2wVmKcPN9E2S", "_ts": "2026-02-20T11:58:18+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "TaskCreate", "tool_input": {"subject": "Implement plugin skeleton code", "description": "Create pyproject.toml, src/openclaw_todo/__init__.py, src/openclaw_todo/plugin.py, and tests/test_plugin.py", "activeForm": "Implementing plugin skeleton"}, "tool_use_id": "toolu_01VV41sUN5tpJ6fiNZhkxUx7", "_ts": "2026-02-20T11:58:21+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "TaskCreate", "tool_input": {"subject": "Implement plugin skeleton code", "description": "Create pyproject.toml, src/openclaw_todo/__init__.py, src/openclaw_todo/plugin.py, and tests/test_plugin.py", "activeForm": "Implementing plugin skeleton"}, "tool_response": {"task": {"id": "2", "subject": "Implement plugin skeleton code"}}, "tool_use_id": "toolu_01VV41sUN5tpJ6fiNZhkxUx7", "_ts": "2026-02-20T11:58:21+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "TaskCreate", "tool_input": {"subject": "Run tests and create PR", "description": "Run uv sync, pytest, commit, push, create PR with Closes #N", "activeForm": "Running tests and creating PR"}, "tool_use_id": "toolu_01L6RvxYFNjZdBUcxb8BKEaV", "_ts": "2026-02-20T11:58:25+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "TaskCreate", "tool_input": {"subject": "Run tests and create PR", "description": "Run uv sync, pytest, commit, push, create PR with Closes #N", "activeForm": "Running tests and creating PR"}, "tool_response": {"task": {"id": "3", "subject": "Run tests and create PR"}}, "tool_use_id": "toolu_01L6RvxYFNjZdBUcxb8BKEaV", "_ts": "2026-02-20T11:58:25+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "TaskUpdate", "tool_input": {"taskId": "1", "status": "in_progress"}, "tool_use_id": "toolu_01LzRWocp8wBvLdYxtuBMHYX", "_ts": "2026-02-20T11:58:28+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "TaskUpdate", "tool_input": {"taskId": "1", "status": "in_progress"}, "tool_response": {"success": true, "taskId": "1", "updatedFields": ["status"], "statusChange": {"from": "pending", "to": "in_progress"}}, "tool_use_id": "toolu_01LzRWocp8wBvLdYxtuBMHYX", "_ts": "2026-02-20T11:58:28+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "gh issue create --title \"[Issue#1] Plugin skeleton and entry point\" --body \"$(cat <<'EOF'\n## Goal\nCreate the Python project scaffold for the OpenClaw TODO Plugin.\n\n## Scope\n\n### In Scope\n- `pyproject.toml` (uv) with Python >=3.11, pytest, pytest-cov dev deps\n- `src/openclaw_todo/` package layout\n- Plugin entry-point `handle_message(text: str, context: dict) -> str`\n- Messages not starting with `/todo` are silently ignored (returns `None`)\n\n### Out of Scope\n- Actual command parsing/dispatch (Issue #5, #16)\n- DB setup (Issue #2)\n\n## Acceptance Criteria\n- [ ] `pyproject.toml` exists with Python >=3.11, pytest, pytest-cov dev deps\n- [ ] `src/openclaw_todo/__init__.py` exposes `__version__`\n- [ ] `src/openclaw_todo/plugin.py` contains `handle_message(text: str, context: dict) -> str` entry point\n- [ ] Messages not starting with `/todo` are silently ignored (returns `None`)\n- [ ] `uv sync && uv run pytest -q` passes (trivial smoke test)\n\n## Tests\n- `tests/test_plugin.py::test_ignores_non_todo_message`\n- `tests/test_plugin.py::test_dispatches_todo_prefix`\n\n## Implementation Notes\n- Observability: `logger.debug` on every inbound message; `logger.info` when `/todo` prefix matched\n- No runtime dependencies; M0 milestone\nEOF\n)\"", "description": "Create GH issue for Issue #1"}, "tool_use_id": "toolu_017iTS1BApfDKtBdRnot9JsZ", "_ts": "2026-02-20T11:58:37+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "gh issue create --title \"[Issue#1] Plugin skeleton and entry point\" --body \"$(cat <<'EOF'\n## Goal\nCreate the Python project scaffold for the OpenClaw TODO Plugin.\n\n## Scope\n\n### In Scope\n- `pyproject.toml` (uv) with Python >=3.11, pytest, pytest-cov dev deps\n- `src/openclaw_todo/` package layout\n- Plugin entry-point `handle_message(text: str, context: dict) -> str`\n- Messages not starting with `/todo` are silently ignored (returns `None`)\n\n### Out of Scope\n- Actual command parsing/dispatch (Issue #5, #16)\n- DB setup (Issue #2)\n\n## Acceptance Criteria\n- [ ] `pyproject.toml` exists with Python >=3.11, pytest, pytest-cov dev deps\n- [ ] `src/openclaw_todo/__init__.py` exposes `__version__`\n- [ ] `src/openclaw_todo/plugin.py` contains `handle_message(text: str, context: dict) -> str` entry point\n- [ ] Messages not starting with `/todo` are silently ignored (returns `None`)\n- [ ] `uv sync && uv run pytest -q` passes (trivial smoke test)\n\n## Tests\n- `tests/test_plugin.py::test_ignores_non_todo_message`\n- `tests/test_plugin.py::test_dispatches_todo_prefix`\n\n## Implementation Notes\n- Observability: `logger.debug` on every inbound message; `logger.info` when `/todo` prefix matched\n- No runtime dependencies; M0 milestone\nEOF\n)\"", "description": "Create GH issue for Issue #1"}, "tool_response": {"stdout": "https://github.com/pillip/openclaw_todo_plugin/issues/1", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_017iTS1BApfDKtBdRnot9JsZ", "_ts": "2026-02-20T11:58:40+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "TaskUpdate", "tool_input": {"taskId": "1", "status": "completed"}, "tool_use_id": "toolu_01QjBr7hPi59MKeFBPfwY6Kv", "_ts": "2026-02-20T11:58:43+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "TaskUpdate", "tool_input": {"taskId": "1", "status": "completed"}, "tool_response": {"success": true, "taskId": "1", "updatedFields": ["status"], "statusChange": {"from": "in_progress", "to": "completed"}}, "tool_use_id": "toolu_01QjBr7hPi59MKeFBPfwY6Kv", "_ts": "2026-02-20T11:58:43+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md", "old_string": "| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nCreate the Python project scaffold: `pyproject.toml` (uv), `src/openclaw_todo/` package layout, and the plugin entry-point that the OpenClaw gateway will load.", "new_string": "| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/1 |\n| PR          | --                                     |\n\n**Description**\nCreate the Python project scaffold: `pyproject.toml` (uv), `src/openclaw_todo/` package layout, and the plugin entry-point that the OpenClaw gateway will load.", "replace_all": false}, "tool_use_id": "toolu_017d3m5CJ3pa8HzdntYWiTcd", "_ts": "2026-02-20T11:58:49+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md", "old_string": "| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nCreate the Python project scaffold: `pyproject.toml` (uv), `src/openclaw_todo/` package layout, and the plugin entry-point that the OpenClaw gateway will load.", "new_string": "| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/1 |\n| PR          | --                                     |\n\n**Description**\nCreate the Python project scaffold: `pyproject.toml` (uv), `src/openclaw_todo/` package layout, and the plugin entry-point that the OpenClaw gateway will load.", "replace_all": false}, "tool_response": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md", "oldString": "| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nCreate the Python project scaffold: `pyproject.toml` (uv), `src/openclaw_todo/` package layout, and the plugin entry-point that the OpenClaw gateway will load.", "newString": "| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/1 |\n| PR          | --                                     |\n\n**Description**\nCreate the Python project scaffold: `pyproject.toml` (uv), `src/openclaw_todo/` package layout, and the plugin entry-point that the OpenClaw gateway will load.", "originalFile": "# OpenClaw TODO Plugin -- Issues\n\n> Auto-generated from `openclaw_todo_plugin_prd.md` (PRD v1.1)\n> Date: 2026-02-20\n\n---\n\n## Issue #1: Plugin skeleton and entry point\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M0                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/001-plugin-skeleton`          |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nCreate the Python project scaffold: `pyproject.toml` (uv), `src/openclaw_todo/` package layout, and the plugin entry-point that the OpenClaw gateway will load. The plugin must expose a callable that receives raw Slack DM text and a sender context dict.\n\n**Acceptance Criteria**\n- [ ] `pyproject.toml` exists with Python >=3.11, pytest, pytest-cov dev deps\n- [ ] `src/openclaw_todo/__init__.py` exposes `__version__`\n- [ ] `src/openclaw_todo/plugin.py` contains `handle_message(text: str, context: dict) -> str` entry point\n- [ ] Messages not starting with `/todo` are silently ignored (returns `None`)\n- [ ] `uv sync && uv run pytest -q` passes (trivial smoke test)\n\n**Tests**\n- `tests/test_plugin.py::test_ignores_non_todo_message`\n- `tests/test_plugin.py::test_dispatches_todo_prefix`\n\n**Rollback**\nDelete branch; no runtime dependency.\n\n**Observability**\n`logger.debug` on every inbound message; `logger.info` when `/todo` prefix matched.\n\n**Dependencies**\nNone.\n\n---\n\n## Issue #2: DB module -- connection helper and pragma setup\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend / Data                         |\n| Milestone   | M1                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/002-db-connection`            |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `src/openclaw_todo/db.py` with a `get_connection(db_path)` helper that creates the `~/.openclaw/workspace/.todo/` directory tree if missing, opens (or creates) `todo.sqlite3`, and applies `PRAGMA journal_mode=WAL` and `PRAGMA busy_timeout=3000`.\n\n**Acceptance Criteria**\n- [ ] Directory is created recursively when absent\n- [ ] SQLite connection returned with WAL mode enabled\n- [ ] `busy_timeout` is 3000\n- [ ] Calling `get_connection` twice returns usable connections (no lock conflict)\n\n**Tests**\n- `tests/test_db.py::test_creates_directory_and_file` (tmp_path)\n- `tests/test_db.py::test_wal_mode_enabled`\n- `tests/test_db.py::test_busy_timeout`\n\n**Rollback**\nRevert module; no schema changes yet.\n\n**Observability**\n`logger.info` on first DB creation; `logger.debug` on each connection open.\n\n**Dependencies**\n#1\n\n---\n\n## Issue #3: Schema migration framework and schema_version table\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend / Data                         |\n| Milestone   | M1                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/003-schema-migration`         |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement a simple sequential migration runner. On startup, read `schema_version` (create if missing), compare to available migrations list, and apply outstanding migrations in order inside a transaction.\n\n**Acceptance Criteria**\n- [ ] `schema_version` table created with single row `version=0` if absent\n- [ ] Migrations are Python callables registered in an ordered list\n- [ ] Each migration runs inside a transaction; version incremented on success\n- [ ] Re-running on an up-to-date DB is a no-op\n- [ ] Failing migration rolls back and raises with clear message\n\n**Tests**\n- `tests/test_migrations.py::test_fresh_db_gets_version_table`\n- `tests/test_migrations.py::test_applies_migrations_sequentially`\n- `tests/test_migrations.py::test_idempotent_on_rerun`\n- `tests/test_migrations.py::test_rollback_on_failure`\n\n**Rollback**\nDrop `schema_version` table; revert module.\n\n**Observability**\n`logger.info(\"Migrating from version %d to %d\", current, target)` per step.\n\n**Dependencies**\n#2\n\n---\n\n## Issue #4: V1 schema migration -- projects, tasks, task_assignees, events\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend / Data                         |\n| Milestone   | M1                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/004-v1-schema`                |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nRegister migration v1 that creates the four tables (`projects`, `tasks`, `task_assignees`, `events`) with all columns, CHECK constraints, and partial unique indexes as specified in PRD section 6.3. Also seed shared project `Inbox`.\n\n**Acceptance Criteria**\n- [ ] `projects` table with `ux_projects_shared_name` and `ux_projects_private_owner_name` partial unique indexes\n- [ ] `tasks` table with section and status CHECK constraints\n- [ ] `task_assignees` table with composite PK and secondary index\n- [ ] `events` audit table created\n- [ ] Shared `Inbox` project auto-created (INSERT OR IGNORE)\n- [ ] `schema_version` = 1 after migration\n\n**Tests**\n- `tests/test_migrations.py::test_v1_tables_exist`\n- `tests/test_migrations.py::test_v1_inbox_created`\n- `tests/test_migrations.py::test_v1_shared_unique_index_enforced`\n- `tests/test_migrations.py::test_v1_private_unique_index_enforced`\n\n**Rollback**\nDrop all four tables + reset schema_version to 0.\n\n**Observability**\nLog table creation counts.\n\n**Dependencies**\n#3\n\n---\n\n## Issue #5: Command parser -- tokenizer and option extraction\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M2                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/005-parser-tokenizer`         |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `src/openclaw_todo/parser.py` that takes raw message text (after `/todo` prefix) and returns a `ParsedCommand` dataclass containing: `command` (str), `args` (list), `project` (str|None), `section` (str|None), `due` (str|None, normalised to YYYY-MM-DD), `mentions` (list of Slack user IDs), and remaining `title_tokens`.\n\nParsing rules:\n- `/p <name>` extracts project\n- `/s <section>` extracts section (validate against enum)\n- `due:YYYY-MM-DD` or `due:MM-DD` extracts and normalises due date\n- `due:-` clears due (sentinel)\n- `<@U...>` patterns extracted as mentions\n- Everything else before first option token is title\n\n**Acceptance Criteria**\n- [ ] `/p MyProject` correctly extracted; token consumed\n- [ ] `/s doing` validated; invalid section raises `ParseError`\n- [ ] `due:03-15` normalised to `2026-03-15`\n- [ ] `due:2026-02-30` raises `ParseError` (invalid date)\n- [ ] `<@U12345>` extracted into mentions list\n- [ ] Multiple mentions supported\n- [ ] Title tokens are non-option, non-mention tokens before first option\n\n**Tests**\n- `tests/test_parser.py::test_extract_project`\n- `tests/test_parser.py::test_extract_section_valid`\n- `tests/test_parser.py::test_extract_section_invalid`\n- `tests/test_parser.py::test_due_mm_dd_normalisation`\n- `tests/test_parser.py::test_due_full_date`\n- `tests/test_parser.py::test_due_invalid_date`\n- `tests/test_parser.py::test_due_clear`\n- `tests/test_parser.py::test_mentions_extraction`\n- `tests/test_parser.py::test_title_extraction`\n\n**Rollback**\nRevert module; no side effects.\n\n**Observability**\n`logger.debug(\"Parsed: %s\", parsed_command)`\n\n**Dependencies**\n#1\n\n---\n\n## Issue #6: /todo add command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/006-cmd-add`                  |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `add` subcommand handler. Resolves project (default `Inbox`), applies defaults (section=`backlog`, assignees=sender if none mentioned), validates private-project assignee constraint (PRD 3.3), inserts task + task_assignees rows, logs event, and returns formatted confirmation.\n\n**Acceptance Criteria**\n- [ ] Task inserted with correct project_id, section, due, status='open', created_by\n- [ ] Assignees default to sender when no mentions\n- [ ] Multiple mentions create multiple task_assignee rows\n- [ ] Private project + non-owner assignee returns warning and does NOT insert\n- [ ] Non-existent project: `Inbox` auto-created as shared; others return error\n- [ ] Response format: `Added #<id> (<project>/<section>) due:<due|-> assignees:<mentions> -- <title>`\n- [ ] Event row written to `events` table\n\n**Tests**\n- `tests/test_cmd_add.py::test_add_default_inbox`\n- `tests/test_cmd_add.py::test_add_with_project_section_due`\n- `tests/test_cmd_add.py::test_add_private_rejects_other_assignee`\n- `tests/test_cmd_add.py::test_add_assignee_defaults_to_sender`\n- `tests/test_cmd_add.py::test_add_multiple_assignees`\n\n**Rollback**\nRevert handler; tasks table unchanged structurally.\n\n**Observability**\n`logger.info(\"Task #%d created in %s/%s by %s\", id, project, section, sender)`\n\n**Dependencies**\n#4, #5\n\n---\n\n## Issue #7: Project resolver helper\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/007-project-resolver`         |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `resolve_project(conn, name, sender_id) -> Project` following PRD 3.2 (Option A): sender's private project with that name takes priority, then shared, then error/auto-create for Inbox.\n\n**Acceptance Criteria**\n- [ ] Private project of sender matched first\n- [ ] Falls back to shared if no private match\n- [ ] Returns error when neither exists (except Inbox which is auto-created)\n- [ ] Returns project row with id, name, visibility, owner_user_id\n\n**Tests**\n- `tests/test_project_resolver.py::test_private_takes_priority`\n- `tests/test_project_resolver.py::test_falls_back_to_shared`\n- `tests/test_project_resolver.py::test_inbox_auto_created`\n- `tests/test_project_resolver.py::test_unknown_project_error`\n\n**Rollback**\nRevert module.\n\n**Observability**\n`logger.debug(\"Resolved project '%s' -> id=%d vis=%s\", name, id, visibility)`\n\n**Dependencies**\n#4\n\n---\n\n## Issue #8: /todo list command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/008-cmd-list`                 |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `list` subcommand. Supports scope (mine/all/<@USER>), project filter, section filter, status filter (open/done/drop), and limit. Sorting: due ASC (NULLs last), then id DESC. Excludes other users' private projects.\n\n**Acceptance Criteria**\n- [ ] Default scope=mine, status=open, limit=30\n- [ ] `mine` filters to tasks where sender is an assignee\n- [ ] `all` includes shared + sender's private (excludes others' private)\n- [ ] `/p` and `/s` filters applied correctly\n- [ ] Sorting: due NOT NULL first, due ASC, id DESC\n- [ ] limit:N respected\n- [ ] Output lists tasks in formatted lines\n\n**Tests**\n- `tests/test_cmd_list.py::test_list_mine_default`\n- `tests/test_cmd_list.py::test_list_all_excludes_others_private`\n- `tests/test_cmd_list.py::test_list_with_project_filter`\n- `tests/test_cmd_list.py::test_list_sorting_order`\n- `tests/test_cmd_list.py::test_list_limit`\n\n**Rollback**\nRevert handler; read-only operation.\n\n**Observability**\n`logger.info(\"list: scope=%s project=%s returned %d rows\", scope, project, count)`\n\n**Dependencies**\n#6, #7\n\n---\n\n## Issue #9: /todo board command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/009-cmd-board`                |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `board` subcommand. Groups tasks by section in fixed order (BACKLOG, DOING, WAITING, DONE, DROP), applies scope/project/status filters, and limits per section. Format: section headers with task lines underneath.\n\n**Acceptance Criteria**\n- [ ] Sections displayed in order: BACKLOG -> DOING -> WAITING -> DONE -> DROP\n- [ ] Empty sections shown with \"(empty)\" or omitted (decide and document)\n- [ ] `limitPerSection:N` caps items per section (default 10)\n- [ ] Scope/project filters identical to `list`\n- [ ] Each task line: `#id due:<date|-> assignees:<@U..> title`\n\n**Tests**\n- `tests/test_cmd_board.py::test_board_section_order`\n- `tests/test_cmd_board.py::test_board_limit_per_section`\n- `tests/test_cmd_board.py::test_board_scope_filter`\n\n**Rollback**\nRevert handler; read-only operation.\n\n**Observability**\n`logger.info(\"board: scope=%s project=%s sections=%s\", ...)`\n\n**Dependencies**\n#8\n\n---\n\n## Issue #10: /todo move command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/010-cmd-move`                 |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `move` subcommand. Validates section enum, checks permissions (private: owner only; shared: assignee or created_by), updates task section and updated_at, logs event.\n\n**Acceptance Criteria**\n- [ ] Section validated against enum; invalid returns error\n- [ ] Private project: only owner can move\n- [ ] Shared project: only assignee or created_by can move\n- [ ] `updated_at` set on change\n- [ ] Event logged\n- [ ] Response confirms new section\n\n**Tests**\n- `tests/test_cmd_move.py::test_move_valid_section`\n- `tests/test_cmd_move.py::test_move_invalid_section`\n- `tests/test_cmd_move.py::test_move_private_owner_only`\n- `tests/test_cmd_move.py::test_move_shared_permission`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"Task #%d moved to %s by %s\", id, section, sender)`\n\n**Dependencies**\n#6, #7\n\n---\n\n## Issue #11: /todo done and /todo drop commands\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/011-cmd-done-drop`            |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `done` and `drop` subcommands. Both set section and status accordingly, record `closed_at`, validate permissions same as `move`, and log event.\n\n**Acceptance Criteria**\n- [ ] `done`: section='done', status='done', closed_at=now\n- [ ] `drop`: section='drop', status='dropped', closed_at=now\n- [ ] Permissions enforced (same as move)\n- [ ] Already-closed task returns informational message (idempotent or error -- decide)\n- [ ] Event logged for each\n\n**Tests**\n- `tests/test_cmd_done_drop.py::test_done_sets_fields`\n- `tests/test_cmd_done_drop.py::test_drop_sets_fields`\n- `tests/test_cmd_done_drop.py::test_permission_check`\n- `tests/test_cmd_done_drop.py::test_already_done`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"Task #%d %s by %s\", id, action, sender)`\n\n**Dependencies**\n#10\n\n---\n\n## Issue #12: /todo edit command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/012-cmd-edit`                 |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `edit` subcommand (v1 replace semantics). Supports changing title, assignees (full replace), project, section, and due. Validates private-project assignee constraint on both source and target project. Logs event with old/new diff in payload.\n\n**Acceptance Criteria**\n- [ ] Title updated only if non-option tokens present\n- [ ] Mentions present -> assignees fully replaced (DELETE + INSERT)\n- [ ] `due:-` clears due to NULL\n- [ ] `/p <newProject>` moves task to new project (project_id updated)\n- [ ] Private project assignee validation applied to target project\n- [ ] If moving to private project with non-owner assignees -> warning, no change\n- [ ] Event payload contains changed fields\n- [ ] Permissions: private owner only; shared assignee/created_by\n\n**Tests**\n- `tests/test_cmd_edit.py::test_edit_title`\n- `tests/test_cmd_edit.py::test_edit_assignees_replace`\n- `tests/test_cmd_edit.py::test_edit_due_clear`\n- `tests/test_cmd_edit.py::test_edit_move_project`\n- `tests/test_cmd_edit.py::test_edit_private_assignee_rejected`\n- `tests/test_cmd_edit.py::test_edit_no_change_fields`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"Task #%d edited by %s: fields=%s\", id, sender, changed_fields)`\n\n**Dependencies**\n#6, #7, #10\n\n---\n\n## Issue #13: /todo project list command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M4                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/013-cmd-project-list`         |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `/todo project list`. Returns all shared projects and the sender's private projects. Format: grouped by visibility with name and task count.\n\n**Acceptance Criteria**\n- [ ] Shared projects listed regardless of sender\n- [ ] Sender's private projects listed\n- [ ] Other users' private projects NOT shown\n- [ ] Each project shows name, visibility, task count\n\n**Tests**\n- `tests/test_cmd_project.py::test_project_list_shows_shared`\n- `tests/test_cmd_project.py::test_project_list_shows_own_private`\n- `tests/test_cmd_project.py::test_project_list_hides_others_private`\n\n**Rollback**\nRevert handler; read-only.\n\n**Observability**\n`logger.info(\"project list: %d shared, %d private for %s\", ...)`\n\n**Dependencies**\n#7\n\n---\n\n## Issue #14: /todo project set-private command with assignee validation\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M4                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/014-cmd-project-set-private`  |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `/todo project set-private <name>` with the assignee validation described in PRD 3.4. Resolution flow: if sender already has private with that name -> noop; if shared exists -> attempt conversion; if neither -> create new private. Conversion scans all tasks in the project and rejects if any task has a non-owner assignee.\n\n**Acceptance Criteria**\n- [ ] Already-private for sender: returns \"already private\" message\n- [ ] Shared -> private: scans tasks; all assignees are owner -> success (visibility='private', owner_user_id=sender)\n- [ ] Shared -> private: at least one non-owner assignee -> error with task IDs and violating assignee list (max 10)\n- [ ] Neither exists: creates new private project with owner=sender\n- [ ] Error message format matches PRD example\n- [ ] Event logged\n\n**Tests**\n- `tests/test_cmd_project.py::test_set_private_already_private`\n- `tests/test_cmd_project.py::test_set_private_shared_success`\n- `tests/test_cmd_project.py::test_set_private_shared_rejected_non_owner_assignee`\n- `tests/test_cmd_project.py::test_set_private_creates_new`\n- `tests/test_cmd_project.py::test_set_private_error_message_format`\n\n**Rollback**\nRevert handler; no schema change.\n\n**Observability**\n`logger.info(\"project set-private: %s result=%s by %s\", name, result, sender)`\n\n**Dependencies**\n#7, #13\n\n---\n\n## Issue #15: /todo project set-shared command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M4                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/015-cmd-project-set-shared`   |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `/todo project set-shared <name>`. Creates a shared project if none exists. If a shared project with that name already exists, noop. Global uniqueness enforced by DB index.\n\n**Acceptance Criteria**\n- [ ] New shared project created when name is free\n- [ ] Existing shared project: returns \"already shared\" / noop\n- [ ] Name conflict with existing shared: returns exists message (index enforces)\n- [ ] Event logged\n\n**Tests**\n- `tests/test_cmd_project.py::test_set_shared_creates_new`\n- `tests/test_cmd_project.py::test_set_shared_already_exists_noop`\n- `tests/test_cmd_project.py::test_set_shared_name_conflict`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"project set-shared: %s result=%s\", name, result)`\n\n**Dependencies**\n#7, #13\n\n---\n\n## Issue #16: Command dispatcher and routing\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/016-dispatcher`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the dispatcher in `plugin.py` that maps the parsed command name to handler functions: `add`, `list`, `board`, `move`, `done`, `drop`, `edit`, `project`. The `project` command further dispatches to `list`, `set-private`, `set-shared`. Unknown commands return a help/error message.\n\n**Acceptance Criteria**\n- [ ] All valid command names routed to correct handler\n- [ ] `project` subcommands routed correctly\n- [ ] Unknown command returns usage hint\n- [ ] DB connection initialised (migration check) before first command execution\n\n**Tests**\n- `tests/test_dispatcher.py::test_routes_known_commands`\n- `tests/test_dispatcher.py::test_project_sub_routing`\n- `tests/test_dispatcher.py::test_unknown_command_help`\n\n**Rollback**\nRevert module.\n\n**Observability**\n`logger.info(\"Dispatching command=%s sub=%s\", command, sub)`\n\n**Dependencies**\n#5\n\n---\n\n## Issue #17: Permission helper module\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/017-permissions`              |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nExtract shared permission-checking logic into `src/openclaw_todo/permissions.py`. Provides `can_write_task(conn, task_id, sender_id) -> bool` and `validate_private_assignees(project, assignees, owner_id) -> Optional[str]` (returns warning message or None).\n\n**Acceptance Criteria**\n- [ ] Private project: only owner can write\n- [ ] Shared project: only assignee or created_by can write\n- [ ] `validate_private_assignees` returns warning string when non-owner assignees present for private project\n- [ ] Returns None for shared projects or when all assignees are owner\n\n**Tests**\n- `tests/test_permissions.py::test_private_owner_can_write`\n- `tests/test_permissions.py::test_private_non_owner_rejected`\n- `tests/test_permissions.py::test_shared_assignee_can_write`\n- `tests/test_permissions.py::test_shared_creator_can_write`\n- `tests/test_permissions.py::test_validate_private_assignees_warning`\n\n**Rollback**\nRevert module.\n\n**Observability**\n`logger.debug(\"Permission check: task=%d sender=%s result=%s\", ...)`\n\n**Dependencies**\n#4\n\n---\n\n## Issue #18: Parser unit tests (comprehensive)\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | QA                                     |\n| Milestone   | M5                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/018-parser-tests`             |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nExpand parser test coverage to include edge cases: multiple options in varied order, due at year boundary, empty title, mentions mixed with options, unicode in titles, extra whitespace handling.\n\n**Acceptance Criteria**\n- [ ] >=95% line coverage on `parser.py`\n- [ ] Edge cases documented in test docstrings\n- [ ] All tests pass with `uv run pytest tests/test_parser.py -v`\n\n**Tests**\n- `tests/test_parser.py::test_options_in_any_order`\n- `tests/test_parser.py::test_due_year_boundary`\n- `tests/test_parser.py::test_empty_title_no_crash`\n- `tests/test_parser.py::test_unicode_title`\n- `tests/test_parser.py::test_extra_whitespace`\n- `tests/test_parser.py::test_mixed_mentions_and_options`\n\n**Rollback**\nRevert test file; no production code change.\n\n**Observability**\nCI coverage report.\n\n**Dependencies**\n#5\n\n---\n\n## Issue #19: SQLite end-to-end integration tests\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | QA                                     |\n| Milestone   | M5                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/019-e2e-tests`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nWrite integration tests that exercise the full flow through `handle_message` with a real (tmp_path) SQLite database. Cover the main user stories: add a task, list it, move it, mark done, edit it, manage projects, and validate private project constraints.\n\n**Acceptance Criteria**\n- [ ] Each test uses a fresh DB via `tmp_path` fixture\n- [ ] Scenarios: add->list, add->move->board, add->done, add->edit, project set-private rejection\n- [ ] Private project visibility enforced end-to-end\n- [ ] Due normalisation verified in DB\n- [ ] All tests pass with `uv run pytest tests/test_e2e.py -v`\n\n**Tests**\n- `tests/test_e2e.py::test_add_and_list_roundtrip`\n- `tests/test_e2e.py::test_add_move_board`\n- `tests/test_e2e.py::test_done_and_drop`\n- `tests/test_e2e.py::test_edit_title_and_assignees`\n- `tests/test_e2e.py::test_private_project_isolation`\n- `tests/test_e2e.py::test_set_private_rejects_foreign_assignees`\n- `tests/test_e2e.py::test_due_normalisation_stored_correctly`\n\n**Rollback**\nRevert test file.\n\n**Observability**\nCI test results and coverage delta.\n\n**Dependencies**\n#6, #8, #9, #10, #11, #12, #14, #15\n\n---\n\n## Issue #20: Packaging and distribution setup\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | DevOps                                 |\n| Milestone   | M6                                     |\n| Status      | TODO                                   |\n| Priority    | P2                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/020-packaging`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nFinalise `pyproject.toml` metadata (name, version, description, license, entry-points), add a `Makefile` with targets for lint/test/build, and document installation instructions in README. Ensure the plugin can be installed as a package and discovered by the OpenClaw gateway.\n\n**Acceptance Criteria**\n- [ ] `pyproject.toml` has complete metadata and entry-point for OpenClaw plugin discovery\n- [ ] `make lint` runs ruff + black --check\n- [ ] `make test` runs pytest with coverage\n- [ ] `make build` produces a wheel via `uv build`\n- [ ] `pip install <wheel>` in a clean venv makes the plugin importable\n- [ ] README documents installation and configuration (DB path env var)\n\n**Tests**\n- Manual: install wheel in fresh venv, import module, call `handle_message`\n- `make test` passes in CI\n\n**Rollback**\nRevert packaging changes.\n\n**Observability**\nBuild artifact size logged; CI publishes wheel as artifact.\n\n**Dependencies**\n#19\n\n---\n\n## Dependency Graph (summary)\n\n```\n#1  Plugin skeleton\n |\n +--#2  DB connection\n |   |\n |   +--#3  Migration framework\n |       |\n |       +--#4  V1 schema\n |           |\n |           +--#7  Project resolver\n |           |   |\n |           |   +--#13 project list\n |           |   +--#14 project set-private\n |           |   +--#15 project set-shared\n |           |\n |           +--#17 Permissions helper\n |\n +--#5  Parser\n |   |\n |   +--#18 Parser tests (M5)\n |\n +--#16 Dispatcher\n     |\n     +--#6  cmd add       (#4,#5,#7,#17)\n     +--#8  cmd list      (#6,#7)\n     +--#9  cmd board     (#8)\n     +--#10 cmd move      (#6,#7,#17)\n     +--#11 cmd done/drop (#10)\n     +--#12 cmd edit      (#6,#7,#10,#17)\n\n#19 E2E tests    (all commands)\n#20 Packaging    (#19)\n```\n", "structuredPatch": [{"oldStart": 15, "oldLines": 7, "newStart": 15, "newLines": 7, "lines": [" | Priority    | P0                                     |", " | Estimate    | 1d                                     |", " | Branch      | `feature/001-plugin-skeleton`          |", "-| GH-Issue    | --                                     |", "+| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/1 |", " | PR          | --                                     |", " ", " **Description**"]}], "userModified": false, "replaceAll": false}, "tool_use_id": "toolu_017d3m5CJ3pa8HzdntYWiTcd", "_ts": "2026-02-20T11:58:49+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "TaskUpdate", "tool_input": {"taskId": "2", "status": "in_progress"}, "tool_use_id": "toolu_01YXGrSbeWE5jfe7bqAv5s7S", "_ts": "2026-02-20T11:58:52+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "TaskUpdate", "tool_input": {"taskId": "2", "status": "in_progress"}, "tool_response": {"success": true, "taskId": "2", "updatedFields": ["status"], "statusChange": {"from": "pending", "to": "in_progress"}}, "tool_use_id": "toolu_01YXGrSbeWE5jfe7bqAv5s7S", "_ts": "2026-02-20T11:58:52+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "git checkout -b feature/001-plugin-skeleton", "description": "Create feature branch"}, "tool_use_id": "toolu_015BVii5f9T2AGR93PYSmXXX", "_ts": "2026-02-20T11:58:55+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "git checkout -b feature/001-plugin-skeleton", "description": "Create feature branch"}, "tool_response": {"stdout": "새로 만든 'feature/001-plugin-skeleton' 브랜치로 전환합니다", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_015BVii5f9T2AGR93PYSmXXX", "_ts": "2026-02-20T11:58:57+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "mkdir -p /Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo && mkdir -p /Users/pillip/project/practice/openclaw_todo_plugin/tests", "description": "Create source and test directories"}, "tool_use_id": "toolu_01NNUxD89zStfsLspcN2hUdW", "_ts": "2026-02-20T11:59:01+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "mkdir -p /Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo && mkdir -p /Users/pillip/project/practice/openclaw_todo_plugin/tests", "description": "Create source and test directories"}, "tool_response": {"stdout": "", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": true}, "tool_use_id": "toolu_01NNUxD89zStfsLspcN2hUdW", "_ts": "2026-02-20T11:59:01+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/pyproject.toml", "content": "[project]\nname = \"openclaw-todo-plugin\"\nversion = \"0.1.0\"\ndescription = \"OpenClaw TODO plugin for Slack — team/personal task management via DM\"\nreadme = \"README.md\"\nrequires-python = \">=3.11\"\ndependencies = []\n\n[dependency-groups]\ndev = [\n    \"pytest>=7.0\",\n    \"pytest-cov>=4.0\",\n]\n\n[tool.pytest.ini_options]\nminversion = \"7.0\"\naddopts = \"-ra\"\ntestpaths = [\"tests\"]\n\n[build-system]\nrequires = [\"hatchling\"]\nbuild-backend = \"hatchling.backends\"\n"}, "tool_use_id": "toolu_01PhkKFpCFCrE81b6Kr4DeB3", "_ts": "2026-02-20T11:59:06+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/pyproject.toml", "content": "[project]\nname = \"openclaw-todo-plugin\"\nversion = \"0.1.0\"\ndescription = \"OpenClaw TODO plugin for Slack — team/personal task management via DM\"\nreadme = \"README.md\"\nrequires-python = \">=3.11\"\ndependencies = []\n\n[dependency-groups]\ndev = [\n    \"pytest>=7.0\",\n    \"pytest-cov>=4.0\",\n]\n\n[tool.pytest.ini_options]\nminversion = \"7.0\"\naddopts = \"-ra\"\ntestpaths = [\"tests\"]\n\n[build-system]\nrequires = [\"hatchling\"]\nbuild-backend = \"hatchling.backends\"\n"}, "tool_response": {"type": "create", "filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/pyproject.toml", "content": "[project]\nname = \"openclaw-todo-plugin\"\nversion = \"0.1.0\"\ndescription = \"OpenClaw TODO plugin for Slack — team/personal task management via DM\"\nreadme = \"README.md\"\nrequires-python = \">=3.11\"\ndependencies = []\n\n[dependency-groups]\ndev = [\n    \"pytest>=7.0\",\n    \"pytest-cov>=4.0\",\n]\n\n[tool.pytest.ini_options]\nminversion = \"7.0\"\naddopts = \"-ra\"\ntestpaths = [\"tests\"]\n\n[build-system]\nrequires = [\"hatchling\"]\nbuild-backend = \"hatchling.backends\"\n", "structuredPatch": [], "originalFile": null}, "tool_use_id": "toolu_01PhkKFpCFCrE81b6Kr4DeB3", "_ts": "2026-02-20T11:59:07+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/__init__.py", "content": "\"\"\"OpenClaw TODO Plugin — team/personal task management for Slack.\"\"\"\n\n__version__ = \"0.1.0\"\n"}, "tool_use_id": "toolu_01AD34uGmyCtVcFDtEwZkAeZ", "_ts": "2026-02-20T11:59:07+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/__init__.py", "content": "\"\"\"OpenClaw TODO Plugin — team/personal task management for Slack.\"\"\"\n\n__version__ = \"0.1.0\"\n"}, "tool_response": {"type": "create", "filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/__init__.py", "content": "\"\"\"OpenClaw TODO Plugin — team/personal task management for Slack.\"\"\"\n\n__version__ = \"0.1.0\"\n", "structuredPatch": [], "originalFile": null}, "tool_use_id": "toolu_01AD34uGmyCtVcFDtEwZkAeZ", "_ts": "2026-02-20T11:59:07+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py", "content": "\"\"\"Plugin entry-point for the OpenClaw gateway.\"\"\"\n\nfrom __future__ import annotations\n\nimport logging\n\nlogger = logging.getLogger(__name__)\n\n_TODO_PREFIX = \"/todo\"\n\n\ndef handle_message(text: str, context: dict) -> str | None:\n    \"\"\"Process an incoming Slack DM message.\n\n    Returns a response string for ``/todo`` commands, or ``None`` if the\n    message is not a TODO command.\n    \"\"\"\n    logger.debug(\"Inbound message: %s\", text)\n\n    stripped = text.strip()\n    if not stripped.startswith(_TODO_PREFIX):\n        return None\n\n    logger.info(\"/todo prefix matched\")\n\n    # Extract the part after \"/todo\"\n    remainder = stripped[len(_TODO_PREFIX) :].strip()\n\n    if not remainder:\n        return \"Usage: /todo <command> [options]\\nCommands: add, list, board, move, done, drop, edit, project\"\n\n    # Placeholder: will be replaced by dispatcher in Issue #16\n    return f\"TODO command received: {remainder}\"\n"}, "tool_use_id": "toolu_01K1wZ7nopPuLXWjvx8wtcJZ", "_ts": "2026-02-20T11:59:12+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py", "content": "\"\"\"Plugin entry-point for the OpenClaw gateway.\"\"\"\n\nfrom __future__ import annotations\n\nimport logging\n\nlogger = logging.getLogger(__name__)\n\n_TODO_PREFIX = \"/todo\"\n\n\ndef handle_message(text: str, context: dict) -> str | None:\n    \"\"\"Process an incoming Slack DM message.\n\n    Returns a response string for ``/todo`` commands, or ``None`` if the\n    message is not a TODO command.\n    \"\"\"\n    logger.debug(\"Inbound message: %s\", text)\n\n    stripped = text.strip()\n    if not stripped.startswith(_TODO_PREFIX):\n        return None\n\n    logger.info(\"/todo prefix matched\")\n\n    # Extract the part after \"/todo\"\n    remainder = stripped[len(_TODO_PREFIX) :].strip()\n\n    if not remainder:\n        return \"Usage: /todo <command> [options]\\nCommands: add, list, board, move, done, drop, edit, project\"\n\n    # Placeholder: will be replaced by dispatcher in Issue #16\n    return f\"TODO command received: {remainder}\"\n"}, "tool_response": {"type": "create", "filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py", "content": "\"\"\"Plugin entry-point for the OpenClaw gateway.\"\"\"\n\nfrom __future__ import annotations\n\nimport logging\n\nlogger = logging.getLogger(__name__)\n\n_TODO_PREFIX = \"/todo\"\n\n\ndef handle_message(text: str, context: dict) -> str | None:\n    \"\"\"Process an incoming Slack DM message.\n\n    Returns a response string for ``/todo`` commands, or ``None`` if the\n    message is not a TODO command.\n    \"\"\"\n    logger.debug(\"Inbound message: %s\", text)\n\n    stripped = text.strip()\n    if not stripped.startswith(_TODO_PREFIX):\n        return None\n\n    logger.info(\"/todo prefix matched\")\n\n    # Extract the part after \"/todo\"\n    remainder = stripped[len(_TODO_PREFIX) :].strip()\n\n    if not remainder:\n        return \"Usage: /todo <command> [options]\\nCommands: add, list, board, move, done, drop, edit, project\"\n\n    # Placeholder: will be replaced by dispatcher in Issue #16\n    return f\"TODO command received: {remainder}\"\n", "structuredPatch": [], "originalFile": null}, "tool_use_id": "toolu_01K1wZ7nopPuLXWjvx8wtcJZ", "_ts": "2026-02-20T11:59:12+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/tests/__init__.py", "content": ""}, "tool_use_id": "toolu_01YUBLvJC1VQtsrYLPGsuCfC", "_ts": "2026-02-20T11:59:12+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/tests/__init__.py", "content": ""}, "tool_response": {"type": "create", "filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/tests/__init__.py", "content": "", "structuredPatch": [], "originalFile": null}, "tool_use_id": "toolu_01YUBLvJC1VQtsrYLPGsuCfC", "_ts": "2026-02-20T11:59:12+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_plugin.py", "content": "\"\"\"Tests for the plugin entry-point.\"\"\"\n\nfrom openclaw_todo.plugin import handle_message\n\n\ndef test_ignores_non_todo_message():\n    \"\"\"Messages not starting with /todo should be silently ignored.\"\"\"\n    assert handle_message(\"hello world\", {\"sender_id\": \"U1\"}) is None\n    assert handle_message(\"\", {\"sender_id\": \"U1\"}) is None\n    assert handle_message(\"some random text\", {\"sender_id\": \"U1\"}) is None\n    assert handle_message(\"/todox something\", {\"sender_id\": \"U1\"}) is None\n\n\ndef test_dispatches_todo_prefix():\n    \"\"\"Messages starting with /todo should return a response.\"\"\"\n    result = handle_message(\"/todo add buy milk\", {\"sender_id\": \"U1\"})\n    assert result is not None\n    assert \"add buy milk\" in result\n\n\ndef test_todo_prefix_with_whitespace():\n    \"\"\"Leading/trailing whitespace should not prevent matching.\"\"\"\n    result = handle_message(\"  /todo add task  \", {\"sender_id\": \"U1\"})\n    assert result is not None\n\n\ndef test_todo_without_subcommand():\n    \"\"\"/todo alone should return usage information.\"\"\"\n    result = handle_message(\"/todo\", {\"sender_id\": \"U1\"})\n    assert result is not None\n    assert \"Usage\" in result\n"}, "tool_use_id": "toolu_01LaNvip6jEMHWueCB9iht5q", "_ts": "2026-02-20T11:59:16+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_plugin.py", "content": "\"\"\"Tests for the plugin entry-point.\"\"\"\n\nfrom openclaw_todo.plugin import handle_message\n\n\ndef test_ignores_non_todo_message():\n    \"\"\"Messages not starting with /todo should be silently ignored.\"\"\"\n    assert handle_message(\"hello world\", {\"sender_id\": \"U1\"}) is None\n    assert handle_message(\"\", {\"sender_id\": \"U1\"}) is None\n    assert handle_message(\"some random text\", {\"sender_id\": \"U1\"}) is None\n    assert handle_message(\"/todox something\", {\"sender_id\": \"U1\"}) is None\n\n\ndef test_dispatches_todo_prefix():\n    \"\"\"Messages starting with /todo should return a response.\"\"\"\n    result = handle_message(\"/todo add buy milk\", {\"sender_id\": \"U1\"})\n    assert result is not None\n    assert \"add buy milk\" in result\n\n\ndef test_todo_prefix_with_whitespace():\n    \"\"\"Leading/trailing whitespace should not prevent matching.\"\"\"\n    result = handle_message(\"  /todo add task  \", {\"sender_id\": \"U1\"})\n    assert result is not None\n\n\ndef test_todo_without_subcommand():\n    \"\"\"/todo alone should return usage information.\"\"\"\n    result = handle_message(\"/todo\", {\"sender_id\": \"U1\"})\n    assert result is not None\n    assert \"Usage\" in result\n"}, "tool_response": {"type": "create", "filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_plugin.py", "content": "\"\"\"Tests for the plugin entry-point.\"\"\"\n\nfrom openclaw_todo.plugin import handle_message\n\n\ndef test_ignores_non_todo_message():\n    \"\"\"Messages not starting with /todo should be silently ignored.\"\"\"\n    assert handle_message(\"hello world\", {\"sender_id\": \"U1\"}) is None\n    assert handle_message(\"\", {\"sender_id\": \"U1\"}) is None\n    assert handle_message(\"some random text\", {\"sender_id\": \"U1\"}) is None\n    assert handle_message(\"/todox something\", {\"sender_id\": \"U1\"}) is None\n\n\ndef test_dispatches_todo_prefix():\n    \"\"\"Messages starting with /todo should return a response.\"\"\"\n    result = handle_message(\"/todo add buy milk\", {\"sender_id\": \"U1\"})\n    assert result is not None\n    assert \"add buy milk\" in result\n\n\ndef test_todo_prefix_with_whitespace():\n    \"\"\"Leading/trailing whitespace should not prevent matching.\"\"\"\n    result = handle_message(\"  /todo add task  \", {\"sender_id\": \"U1\"})\n    assert result is not None\n\n\ndef test_todo_without_subcommand():\n    \"\"\"/todo alone should return usage information.\"\"\"\n    result = handle_message(\"/todo\", {\"sender_id\": \"U1\"})\n    assert result is not None\n    assert \"Usage\" in result\n", "structuredPatch": [], "originalFile": null}, "tool_use_id": "toolu_01LaNvip6jEMHWueCB9iht5q", "_ts": "2026-02-20T11:59:16+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "TaskUpdate", "tool_input": {"taskId": "2", "status": "completed"}, "tool_use_id": "toolu_01F8ffjTo4fR8BoghxukJs87", "_ts": "2026-02-20T11:59:19+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "TaskUpdate", "tool_input": {"taskId": "2", "status": "completed"}, "tool_response": {"success": true, "taskId": "2", "updatedFields": ["status"], "statusChange": {"from": "in_progress", "to": "completed"}}, "tool_use_id": "toolu_01F8ffjTo4fR8BoghxukJs87", "_ts": "2026-02-20T11:59:19+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "TaskUpdate", "tool_input": {"taskId": "3", "status": "in_progress"}, "tool_use_id": "toolu_013A32c8Us77TJMLVPXWMqL1", "_ts": "2026-02-20T11:59:20+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "TaskUpdate", "tool_input": {"taskId": "3", "status": "in_progress"}, "tool_response": {"success": true, "taskId": "3", "updatedFields": ["status"], "statusChange": {"from": "pending", "to": "in_progress"}}, "tool_use_id": "toolu_013A32c8Us77TJMLVPXWMqL1", "_ts": "2026-02-20T11:59:20+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "uv sync 2>&1", "description": "Install dependencies with uv"}, "tool_use_id": "toolu_012fUw2pHg8nXpVYupzLoV1q", "_ts": "2026-02-20T11:59:23+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUseFailure", "tool_name": "Bash", "tool_input": {"command": "uv sync 2>&1", "description": "Install dependencies with uv"}, "tool_use_id": "toolu_012fUw2pHg8nXpVYupzLoV1q", "error": "Exit code 1\nUsing CPython 3.11.13\nCreating virtual environment at: .venv\nResolved 10 packages in 1.13s\n   Building openclaw-todo-plugin @ file:///Users/pillip/project/practice/openclaw_todo_plugin\nDownloading pygments (1.2MiB)\n Downloading pygments\n  × Failed to build `openclaw-todo-plugin @\n  │ file:///Users/pillip/project/practice/openclaw_todo_plugin`\n  ├─▶ The build backend returned an error\n  ╰─▶ Call to `hatchling.backends.build_editable` failed (exit status: 1)\n\n      [stderr]\n      Traceback (most recent call last):\n        File \"<string>\", line 8, in <module>\n      ModuleNotFoundError: No module named 'hatchling.backends'\n\n      hint: This error likely indicates that `openclaw-todo-plugin@0.1.0`\n      depends on `hatchling.backends`, but doesn't declare it as a build\n      dependency. If `openclaw-todo-plugin` is a first-party package, consider\n      adding `hatchling.backends` to its `build-system.requires`. Otherwise,\n      either add it to your `pyproject.toml` under:\n\n      [tool.uv.extra-build-dependencies]\n      openclaw-todo-plugin = [\"hatchling.backends\"]\n\n      or `uv pip install hatchling.backends` into the environment and re-run\n      with `--no-build-isolation`.", "is_interrupt": false, "_ts": "2026-02-20T11:59:26+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/pyproject.toml", "old_string": "[build-system]\nrequires = [\"hatchling\"]\nbuild-backend = \"hatchling.backends\"", "new_string": "[build-system]\nrequires = [\"hatchling\"]\nbuild-backend = \"hatchling.build\"", "replace_all": false}, "tool_use_id": "toolu_01FCzZ5KVEFAPxrZpkUP5TvX", "_ts": "2026-02-20T11:59:29+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/pyproject.toml", "old_string": "[build-system]\nrequires = [\"hatchling\"]\nbuild-backend = \"hatchling.backends\"", "new_string": "[build-system]\nrequires = [\"hatchling\"]\nbuild-backend = \"hatchling.build\"", "replace_all": false}, "tool_response": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/pyproject.toml", "oldString": "[build-system]\nrequires = [\"hatchling\"]\nbuild-backend = \"hatchling.backends\"", "newString": "[build-system]\nrequires = [\"hatchling\"]\nbuild-backend = \"hatchling.build\"", "originalFile": "[project]\nname = \"openclaw-todo-plugin\"\nversion = \"0.1.0\"\ndescription = \"OpenClaw TODO plugin for Slack — team/personal task management via DM\"\nreadme = \"README.md\"\nrequires-python = \">=3.11\"\ndependencies = []\n\n[dependency-groups]\ndev = [\n    \"pytest>=7.0\",\n    \"pytest-cov>=4.0\",\n]\n\n[tool.pytest.ini_options]\nminversion = \"7.0\"\naddopts = \"-ra\"\ntestpaths = [\"tests\"]\n\n[build-system]\nrequires = [\"hatchling\"]\nbuild-backend = \"hatchling.backends\"\n", "structuredPatch": [{"oldStart": 19, "oldLines": 4, "newStart": 19, "newLines": 4, "lines": [" ", " [build-system]", " requires = [\"hatchling\"]", "-build-backend = \"hatchling.backends\"", "+build-backend = \"hatchling.build\""]}], "userModified": false, "replaceAll": false}, "tool_use_id": "toolu_01FCzZ5KVEFAPxrZpkUP5TvX", "_ts": "2026-02-20T11:59:29+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "uv sync 2>&1", "description": "Install dependencies with uv"}, "tool_use_id": "toolu_01HBPJ8vKQz1Re5rgLDhitJZ", "_ts": "2026-02-20T11:59:33+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUseFailure", "tool_name": "Bash", "tool_input": {"command": "uv sync 2>&1", "description": "Install dependencies with uv"}, "tool_use_id": "toolu_01HBPJ8vKQz1Re5rgLDhitJZ", "error": "Exit code 1\nResolved 10 packages in 2ms\n   Building openclaw-todo-plugin @ file:///Users/pillip/project/practice/openclaw_todo_plugin\n  × Failed to build `openclaw-todo-plugin @\n  │ file:///Users/pillip/project/practice/openclaw_todo_plugin`\n  ├─▶ The build backend returned an error\n  ╰─▶ Call to `hatchling.build.build_editable` failed (exit status: 1)\n\n      [stderr]\n      Traceback (most recent call last):\n        File \"<string>\", line 11, in <module>\n        File\n      \"/Users/pillip/.cache/uv/builds-v0/.tmp5L8rd3/lib/python3.11/site-packages/hatchling/build.py\",\n      line 83, in build_editable\n          return os.path.basename(next(builder.build(directory=wheel_directory,\n      versions=[\"editable\"])))\n      \n      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        File\n      \"/Users/pillip/.cache/uv/builds-v0/.tmp5L8rd3/lib/python3.11/site-packages/hatchling/builders/plugin/interface.py\",\n      line 157, in build\n          artifact = version_api[version](directory, **build_data)\n                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        File\n      \"/Users/pillip/.cache/uv/builds-v0/.tmp5L8rd3/lib/python3.11/site-packages/hatchling/builders/wheel.py\",\n      line 522, in build_editable\n          return self.build_editable_detection(directory, **build_data)\n                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        File\n      \"/Users/pillip/.cache/uv/builds-v0/.tmp5L8rd3/lib/python3.11/site-packages/hatchling/builders/wheel.py\",\n      line 534, in build_editable_detection\n          for included_file in self.recurse_selected_project_files():\n        File\n      \"/Users/pillip/.cache/uv/builds-v0/.tmp5L8rd3/lib/python3.11/site-packages/hatchling/builders/plugin/interface.py\",\n      line 182, in recurse_selected_project_files\n          if self.config.only_include:\n             ^^^^^^^^^^^^^^^^^^^^^^^^\n        File\n      \"/Users/pillip/.local/share/uv/python/cpython-3.11.13-macos-aarch64-none/lib/python3.11/functools.py\",\n      line 1001, in __get__\n          val = self.func(instance)\n                ^^^^^^^^^^^^^^^^^^^\n        File\n      \"/Users/pillip/.cache/uv/builds-v0/.tmp5L8rd3/lib/python3.11/site-packages/hatchling/builders/config.py\",\n      line 715, in only_include\n          only_include = only_include_config.get(\"only-include\",\n      self.default_only_include()) or self.packages\n      \n      ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        File\n      \"/Users/pillip/.cache/uv/builds-v0/.tmp5L8rd3/lib/python3.11/site-packages/hatchling/builders/wheel.py\",\n      line 268, in default_only_include\n          return self.default_file_selection_options.only_include\n                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        File\n      \"/Users/pillip/.local/share/uv/python/cpython-3.11.13-macos-aarch64-none/lib/python3.11/functools.py\",\n      line 1001, in __get__\n          val = self.func(instance)\n                ^^^^^^^^^^^^^^^^^^^\n        File\n      \"/Users/pillip/.cache/uv/builds-v0/.tmp5L8rd3/lib/python3.11/site-packages/hatchling/builders/wheel.py\",\n      line 256, in default_file_selection_options\n          raise ValueError(message)\n      ValueError: Unable to determine which files to ship\n      inside the wheel using the following heuristics:\n      https://hatch.pypa.io/latest/plugins/builder/wheel/#default-file-selection\n\n      The most likely cause of this is that there is no directory that matches\n      the name of your project (openclaw_todo_plugin).\n\n      At least one file selection option must be defined\n      in the `tool.hatch.build.targets.wheel` table, see:\n      https://hatch.pypa.io/latest/config/build/\n\n      As an example, if you intend to ship a directory named `foo` that\n      resides within a `src` directory located at the root of your project,\n      you can define the following:\n\n      [tool.hatch.build.targets.wheel]\n      packages = [\"src/foo\"]\n\n      hint: This usually indicates a problem with the package or the build\n      environment.", "is_interrupt": false, "_ts": "2026-02-20T11:59:34+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/pyproject.toml"}, "tool_use_id": "toolu_01S35Cvs2E2CAywPgctFLYuv", "_ts": "2026-02-20T11:59:37+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/pyproject.toml"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/pyproject.toml", "content": "[project]\nname = \"openclaw-todo-plugin\"\nversion = \"0.1.0\"\ndescription = \"OpenClaw TODO plugin for Slack — team/personal task management via DM\"\nreadme = \"README.md\"\nrequires-python = \">=3.11\"\ndependencies = []\n\n[dependency-groups]\ndev = [\n    \"pytest>=7.0\",\n    \"pytest-cov>=4.0\",\n]\n\n[tool.pytest.ini_options]\nminversion = \"7.0\"\naddopts = \"-ra\"\ntestpaths = [\"tests\"]\n\n[build-system]\nrequires = [\"hatchling\"]\nbuild-backend = \"hatchling.build\"\n", "numLines": 23, "startLine": 1, "totalLines": 23}}, "tool_use_id": "toolu_01S35Cvs2E2CAywPgctFLYuv", "_ts": "2026-02-20T11:59:37+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/pyproject.toml", "old_string": "[build-system]\nrequires = [\"hatchling\"]\nbuild-backend = \"hatchling.build\"", "new_string": "[tool.hatch.build.targets.wheel]\npackages = [\"src/openclaw_todo\"]\n\n[build-system]\nrequires = [\"hatchling\"]\nbuild-backend = \"hatchling.build\"", "replace_all": false}, "tool_use_id": "toolu_01HkYFTfNUUEBZaP5HTf1wds", "_ts": "2026-02-20T11:59:40+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/pyproject.toml", "old_string": "[build-system]\nrequires = [\"hatchling\"]\nbuild-backend = \"hatchling.build\"", "new_string": "[tool.hatch.build.targets.wheel]\npackages = [\"src/openclaw_todo\"]\n\n[build-system]\nrequires = [\"hatchling\"]\nbuild-backend = \"hatchling.build\"", "replace_all": false}, "tool_response": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/pyproject.toml", "oldString": "[build-system]\nrequires = [\"hatchling\"]\nbuild-backend = \"hatchling.build\"", "newString": "[tool.hatch.build.targets.wheel]\npackages = [\"src/openclaw_todo\"]\n\n[build-system]\nrequires = [\"hatchling\"]\nbuild-backend = \"hatchling.build\"", "originalFile": "[project]\nname = \"openclaw-todo-plugin\"\nversion = \"0.1.0\"\ndescription = \"OpenClaw TODO plugin for Slack — team/personal task management via DM\"\nreadme = \"README.md\"\nrequires-python = \">=3.11\"\ndependencies = []\n\n[dependency-groups]\ndev = [\n    \"pytest>=7.0\",\n    \"pytest-cov>=4.0\",\n]\n\n[tool.pytest.ini_options]\nminversion = \"7.0\"\naddopts = \"-ra\"\ntestpaths = [\"tests\"]\n\n[build-system]\nrequires = [\"hatchling\"]\nbuild-backend = \"hatchling.build\"\n", "structuredPatch": [{"oldStart": 17, "oldLines": 6, "newStart": 17, "newLines": 9, "lines": [" addopts = \"-ra\"", " testpaths = [\"tests\"]", " ", "+[tool.hatch.build.targets.wheel]", "+packages = [\"src/openclaw_todo\"]", "+", " [build-system]", " requires = [\"hatchling\"]", " build-backend = \"hatchling.build\""]}], "userModified": false, "replaceAll": false}, "tool_use_id": "toolu_01HkYFTfNUUEBZaP5HTf1wds", "_ts": "2026-02-20T11:59:40+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "uv sync 2>&1", "description": "Install dependencies with uv"}, "tool_use_id": "toolu_01ScygNV534jMe7n8nGpbiA9", "_ts": "2026-02-20T11:59:43+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "uv sync 2>&1", "description": "Install dependencies with uv"}, "tool_response": {"stdout": "Resolved 10 packages in 2ms\n   Building openclaw-todo-plugin @ file:///Users/pillip/project/practice/openclaw_todo_plugin\n      Built openclaw-todo-plugin @ file:///Users/pillip/project/practice/openclaw_todo_plugin\nPrepared 1 package in 168ms\nInstalled 8 packages in 7ms\n + coverage==7.13.4\n + iniconfig==2.3.0\n + openclaw-todo-plugin==0.1.0 (from file:///Users/pillip/project/practice/openclaw_todo_plugin)\n + packaging==26.0\n + pluggy==1.6.0\n + pygments==2.19.2\n + pytest==9.0.2\n + pytest-cov==7.0.0", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_01ScygNV534jMe7n8nGpbiA9", "_ts": "2026-02-20T11:59:44+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "uv run pytest -q 2>&1", "description": "Run tests"}, "tool_use_id": "toolu_01KzdWPMRPsKyzJZSn7wkPWr", "_ts": "2026-02-20T11:59:47+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUseFailure", "tool_name": "Bash", "tool_input": {"command": "uv run pytest -q 2>&1", "description": "Run tests"}, "tool_use_id": "toolu_01KzdWPMRPsKyzJZSn7wkPWr", "error": "Exit code 1\nF...                                                                     [100%]\n=================================== FAILURES ===================================\n________________________ test_ignores_non_todo_message _________________________\n\n    def test_ignores_non_todo_message():\n        \"\"\"Messages not starting with /todo should be silently ignored.\"\"\"\n        assert handle_message(\"hello world\", {\"sender_id\": \"U1\"}) is None\n        assert handle_message(\"\", {\"sender_id\": \"U1\"}) is None\n        assert handle_message(\"some random text\", {\"sender_id\": \"U1\"}) is None\n>       assert handle_message(\"/todox something\", {\"sender_id\": \"U1\"}) is None\nE       AssertionError: assert 'TODO command received: x something' is None\nE        +  where 'TODO command received: x something' = handle_message('/todox something', {'sender_id': 'U1'})\n\ntests/test_plugin.py:11: AssertionError\n=========================== short test summary info ============================\nFAILED tests/test_plugin.py::test_ignores_non_todo_message - AssertionError: ...\n1 failed, 3 passed in 0.01s", "is_interrupt": false, "_ts": "2026-02-20T11:59:49+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py", "old_string": "    stripped = text.strip()\n    if not stripped.startswith(_TODO_PREFIX):\n        return None\n\n    logger.info(\"/todo prefix matched\")\n\n    # Extract the part after \"/todo\"\n    remainder = stripped[len(_TODO_PREFIX) :].strip()", "new_string": "    stripped = text.strip()\n    if not (stripped == _TODO_PREFIX or stripped.startswith(_TODO_PREFIX + \" \")):\n        return None\n\n    logger.info(\"/todo prefix matched\")\n\n    remainder = stripped[len(_TODO_PREFIX) :].strip()", "replace_all": false}, "tool_use_id": "toolu_017HaDYaHZZUiCWea2oLyC6V", "_ts": "2026-02-20T11:59:55+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py", "old_string": "    stripped = text.strip()\n    if not stripped.startswith(_TODO_PREFIX):\n        return None\n\n    logger.info(\"/todo prefix matched\")\n\n    # Extract the part after \"/todo\"\n    remainder = stripped[len(_TODO_PREFIX) :].strip()", "new_string": "    stripped = text.strip()\n    if not (stripped == _TODO_PREFIX or stripped.startswith(_TODO_PREFIX + \" \")):\n        return None\n\n    logger.info(\"/todo prefix matched\")\n\n    remainder = stripped[len(_TODO_PREFIX) :].strip()", "replace_all": false}, "tool_response": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py", "oldString": "    stripped = text.strip()\n    if not stripped.startswith(_TODO_PREFIX):\n        return None\n\n    logger.info(\"/todo prefix matched\")\n\n    # Extract the part after \"/todo\"\n    remainder = stripped[len(_TODO_PREFIX) :].strip()", "newString": "    stripped = text.strip()\n    if not (stripped == _TODO_PREFIX or stripped.startswith(_TODO_PREFIX + \" \")):\n        return None\n\n    logger.info(\"/todo prefix matched\")\n\n    remainder = stripped[len(_TODO_PREFIX) :].strip()", "originalFile": "\"\"\"Plugin entry-point for the OpenClaw gateway.\"\"\"\n\nfrom __future__ import annotations\n\nimport logging\n\nlogger = logging.getLogger(__name__)\n\n_TODO_PREFIX = \"/todo\"\n\n\ndef handle_message(text: str, context: dict) -> str | None:\n    \"\"\"Process an incoming Slack DM message.\n\n    Returns a response string for ``/todo`` commands, or ``None`` if the\n    message is not a TODO command.\n    \"\"\"\n    logger.debug(\"Inbound message: %s\", text)\n\n    stripped = text.strip()\n    if not stripped.startswith(_TODO_PREFIX):\n        return None\n\n    logger.info(\"/todo prefix matched\")\n\n    # Extract the part after \"/todo\"\n    remainder = stripped[len(_TODO_PREFIX) :].strip()\n\n    if not remainder:\n        return \"Usage: /todo <command> [options]\\nCommands: add, list, board, move, done, drop, edit, project\"\n\n    # Placeholder: will be replaced by dispatcher in Issue #16\n    return f\"TODO command received: {remainder}\"\n", "structuredPatch": [{"oldStart": 18, "oldLines": 12, "newStart": 18, "newLines": 11, "lines": ["     logger.debug(\"Inbound message: %s\", text)", " ", "     stripped = text.strip()", "-    if not stripped.startswith(_TODO_PREFIX):", "+    if not (stripped == _TODO_PREFIX or stripped.startswith(_TODO_PREFIX + \" \")):", "         return None", " ", "     logger.info(\"/todo prefix matched\")", " ", "-    # Extract the part after \"/todo\"", "     remainder = stripped[len(_TODO_PREFIX) :].strip()", " ", "     if not remainder:"]}], "userModified": false, "replaceAll": false}, "tool_use_id": "toolu_017HaDYaHZZUiCWea2oLyC6V", "_ts": "2026-02-20T11:59:55+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "uv run pytest -q 2>&1", "description": "Run tests"}, "tool_use_id": "toolu_01FsWXr8S21xTZpMoUy2j3DZ", "_ts": "2026-02-20T11:59:58+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "uv run pytest -q 2>&1", "description": "Run tests"}, "tool_response": {"stdout": "....                                                                     [100%]\n4 passed in 0.00s", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_01FsWXr8S21xTZpMoUy2j3DZ", "_ts": "2026-02-20T11:59:58+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "git status", "description": "Show working tree status"}, "tool_use_id": "toolu_01PfD4RffoeCygbyUJ3iG5Gj", "_ts": "2026-02-20T12:00:01+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "git status", "description": "Show working tree status"}, "tool_response": {"stdout": "현재 브랜치 feature/001-plugin-skeleton\n커밋할 변경 사항:\n  (use \"git restore --staged <file>...\" to unstage)\n\t새 파일:       .claude-kit\n\t새 파일:       .gitmodules\n\n추적하지 않는 파일:\n  (커밋할 사항에 포함하려면 \"git add <파일>...\"을 사용하십시오)\n\t.claude/\n\tSTATUS.md\n\tdocs/\n\tissues.md\n\topenclaw_todo_plugin_prd.md\n\tpyproject.toml\n\tsrc/\n\ttests/\n\tuv.lock", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_01PfD4RffoeCygbyUJ3iG5Gj", "_ts": "2026-02-20T12:00:01+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "git log --oneline -5 2>&1", "description": "Check recent commits"}, "tool_use_id": "toolu_017S69dUxgZDHYs3GE4jQnpv", "_ts": "2026-02-20T12:00:05+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "git log --oneline -5 2>&1", "description": "Check recent commits"}, "tool_response": {"stdout": "fb1a126 Initial commit", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_017S69dUxgZDHYs3GE4jQnpv", "_ts": "2026-02-20T12:00:05+0900"}
{"session_id": "fed9c7ac-2183-4d64-a248-ba295d4fda46", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/fed9c7ac-2183-4d64-a248-ba295d4fda46.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "git add pyproject.toml uv.lock src/openclaw_todo/__init__.py src/openclaw_todo/plugin.py tests/__init__.py tests/test_plugin.py issues.md STATUS.md .claude/ docs/ openclaw_todo_plugin_prd.md", "description": "Stage files for commit"}, "tool_use_id": "toolu_01Sjhz52vG5kPwE5FjmPDScT", "_ts": "2026-02-20T12:00:08+0900"}
{"session_id": "ea23599c-057d-4544-ac7d-1239e762eed0", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/ea23599c-057d-4544-ac7d-1239e762eed0.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher", "permission_mode": "default", "hook_event_name": "PostToolUseFailure", "tool_name": "Bash", "tool_input": {"command": "git stash && git rebase origin/main 2>&1", "description": "Stash changes and rebase"}, "tool_use_id": "toolu_013qayrSwPRjeqstfqiNgKdh", "error": "Exit code 1\nSaved working directory and index state WIP on feature/016-dispatcher: c795009 docs(review): add review notes and fix test assertion for Issue #16\nRebasing (1/2)\rRebasing (2/2)\r자동 병합: docs/review_notes.md\n충돌 (내용): docs/review_notes.md에 병합 충돌\nerror: 다음을 적용할(apply) 수 없습니다: c795009... docs(review): add review notes and fix test assertion for Issue #16\n힌트: Resolve all conflicts manually, mark them as resolved with\n힌트: \"git add/rm <conflicted_files>\", then run \"git rebase --continue\".\n힌트: You can instead skip this commit: run \"git rebase --skip\".\n힌트: To abort and get back to the state before \"git rebase\", run \"git rebase --abort\".\nCould not apply c795009... docs(review): add review notes and fix test assertion for Issue #16", "is_interrupt": false, "_ts": "2026-02-20T19:02:01+0900"}
{"session_id": "ea23599c-057d-4544-ac7d-1239e762eed0", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/ea23599c-057d-4544-ac7d-1239e762eed0.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/docs/review_notes.md", "offset": 650}, "tool_use_id": "toolu_0167sjsSq6hvrmdUX55DVUM7", "_ts": "2026-02-20T19:02:04+0900"}
{"session_id": "ea23599c-057d-4544-ac7d-1239e762eed0", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/ea23599c-057d-4544-ac7d-1239e762eed0.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/docs/review_notes.md", "offset": 650}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/docs/review_notes.md", "content": "3. **Optional**: Tighten `_DUE_RE` from `.+` to `[\\d-]+` for earlier rejection of obviously invalid due values.\n4. **AC clarification**: Update Issue #5 AC to reflect that title tokens are collected from all positions (not just \"before first option\"), matching the implemented behavior.\n\n---\n\n<<<<<<< HEAD\n# PR #12 Review Notes -- Issue #7: Project resolver helper\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/007-project-resolver`\n=======\n# PR #14 Review Notes -- Issue #16: Command dispatcher and routing\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature-016-dispatcher`\n>>>>>>> c795009 (docs(review): add review notes and fix test assertion for Issue #16)\n\n---\n\n## Code Review\n\n<<<<<<< HEAD\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| Private project of sender matched first | PASS | Query on line 38-42 filters by `visibility = 'private' AND owner_user_id = ?`. Test `test_private_takes_priority` verifies. |\n| Falls back to shared if no private match | PASS | Second query on line 52-56 filters by `visibility = 'shared'`. Test `test_falls_back_to_shared` verifies. |\n| Returns error when neither exists (except Inbox auto-created) | PASS | `ProjectNotFoundError` raised on line 84. Inbox auto-created on lines 66-81. Tests `test_unknown_project_error` and `test_inbox_auto_created` verify. |\n| Returns project row with id, name, visibility, owner_user_id | PASS | `Project` dataclass on lines 17-23 with all four fields. All tests assert on these fields. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_private_takes_priority` | PASS -- creates both shared and private \"Work\", verifies private is returned for owner U1 |\n| `test_falls_back_to_shared` | PASS -- creates shared \"Team\" only, verifies shared returned for U1 |\n| `test_inbox_auto_created` | PASS -- deletes seeded Inbox, verifies auto-creation as shared with null owner |\n| `test_unknown_project_error` | PASS -- verifies `ProjectNotFoundError` raised with descriptive message |\n\nAll 4 required tests present and passing. 2 additional bonus tests (`test_inbox_already_exists`, `test_private_different_owner_not_matched`). 6 tests total.\n\n### Findings\n\n#### [Low] F1: Project name matching is case-sensitive\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 39-42\n- **Description**: The SQL queries use `WHERE name = ?` which is case-sensitive in SQLite by default (for ASCII). If a user types `/p work` but the project is named `Work`, it will not match. The PRD does not specify case-sensitivity behavior, so this is not a bug per se, but it could cause user confusion.\n- **Action**: Document the case-sensitive behavior. Consider adding `COLLATE NOCASE` in a future iteration if case-insensitive matching is desired.\n\n#### [Low] F2: Repeated `Project(id=row[0], ...)` construction pattern\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 44, 58, 76\n- **Description**: The same `Project(id=row[0], name=row[1], visibility=row[2], owner_user_id=row[3])` pattern appears three times. This could be extracted to a helper (e.g., `Project._from_row(row)` classmethod or a module-level `_row_to_project` function) to reduce duplication and ensure consistency if columns change.\n- **Action**: Optional refactor. Not blocking for M1.\n\n#### [Low] F3: `conn.commit()` called inside resolver for Inbox auto-creation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, line 71\n- **Description**: The resolver calls `conn.commit()` directly after the `INSERT OR IGNORE` for Inbox auto-creation. This commits any pending transaction state on the connection, which could be surprising if the caller has uncommitted changes. In the current codebase this is not an issue (resolver is called early in command handling), but it couples the resolver to transaction management.\n- **Action**: Consider whether the caller should be responsible for committing. For M1 this is acceptable since the auto-creation is a one-time idempotent operation.\n\n#### [Low] F4: No test for Inbox auto-creation when a private Inbox exists\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/tests/test_project_resolver.py`\n- **Description**: If a user has a private project named \"Inbox\", `resolve_project(conn, \"Inbox\", user_id)` will return the private project (step 1 matches). The auto-creation path (step 3) is only reached if neither private nor shared \"Inbox\" exists. This behavior is correct per the resolution order, but there is no test covering the scenario where a user has a private \"Inbox\" and the shared \"Inbox\" also exists -- the test should verify that the private one is returned.\n- **Action**: Add a test for this edge case in a follow-up.\n\n#### [Info] F5: `INSERT OR IGNORE` is the correct pattern for Inbox auto-creation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 67-70\n- `INSERT OR IGNORE` handles the race condition where two concurrent requests try to auto-create Inbox simultaneously. The `ux_projects_shared_name` unique index on `(name) WHERE visibility = 'shared'` ensures only one shared Inbox can exist. The subsequent `SELECT` on lines 72-75 guarantees we return the correct row regardless of whether this request or another one performed the insert. This is well-designed.\n\n#### [Info] F6: Bonus tests add good defensive coverage\n\n- `test_inbox_already_exists` verifies that the seeded Inbox (from V1 migration) resolves without triggering auto-creation.\n- `test_private_different_owner_not_matched` verifies that a private project owned by U2 is not visible to U1, correctly raising `ProjectNotFoundError`.\n\n#### [Info] F7: Coverage at 100%\n\n- All 31 statements in `project_resolver.py` are covered by the 6 tests. No untested branches.\n\n#### [Info] F8: Test fixture pattern is consistent with prior PRs\n\n- The `_load_v1` autouse fixture and `conn` fixture follow the same save-clear-restore pattern established in prior PRs. Good consistency.\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and follows the PRD resolution order exactly:\n\n- Three-step resolution (private -> shared -> Inbox auto-create) with clear fallthrough logic.\n- All SQL queries use parameterized placeholders (`?`), preventing SQL injection.\n- `Project` dataclass provides a typed result with the four required fields.\n- `ProjectNotFoundError` is a well-named custom exception with descriptive message.\n- Logging at debug level for each resolution path aids troubleshooting.\n- `INSERT OR IGNORE` handles concurrent Inbox auto-creation safely.\n- 100% test coverage with all 4 required tests and 2 valuable bonus tests.\n- The code is 85 lines total -- minimal and readable.\n\n**Verdict: APPROVE** -- no Critical or High findings. All Low findings are noted for follow-up.\n=======\n### Changed Files\n\n| File | Change | Lines |\n|------|--------|-------|\n| `src/openclaw_todo/dispatcher.py` | NEW | 116 |\n| `src/openclaw_todo/plugin.py` | MODIFIED | 33 |\n| `tests/test_dispatcher.py` | NEW | 152 |\n| `tests/test_plugin.py` | MODIFIED | 39 |\n\n### Architecture Overview\n\nThe dispatcher implements a two-level routing architecture:\n\n1. **Plugin layer** (`plugin.py`): Strips `/todo` prefix, returns USAGE for bare `/todo`, delegates remainder to `dispatch()`.\n2. **Dispatcher layer** (`dispatcher.py`): Parses the remainder via the parser, validates command name against `_VALID_COMMANDS`, opens a DB connection with migration, routes to the appropriate handler (or stub), and closes the connection in a `finally` block.\n3. **Project sub-routing**: `project` command delegates to `_dispatch_project()` which extracts the subcommand from `parsed.title_tokens` and routes to `project_<subcommand>` handlers in the registry.\n\n### Findings\n\n#### [Low] F1: Weak test assertion on stub handler (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/tests/test_dispatcher.py`, line 48\n- **Description**: The original assertion was:\n  ```python\n  assert \"not yet implemented\" in result.lower() or isinstance(result, str)\n  ```\n  The `isinstance(result, str)` clause makes this trivially true since `dispatch()` always returns `str`. The test does not actually verify that the stub handler was invoked -- any string return would pass.\n- **Fix applied**: Removed the `or isinstance(result, str)` fallback. The assertion now strictly verifies that the stub handler message is present:\n  ```python\n  assert \"not yet implemented\" in result.lower()\n  ```\n- **Impact**: Test now correctly fails if the stub handler message format changes or if a different code path is taken.\n\n#### [Low] F2: `_stub_handler` signature differs from `HandlerFn` type alias\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 17, 47\n- **Description**: The `HandlerFn` type alias is `Callable[[ParsedCommand, Connection, dict], str]` (3 args), but `_stub_handler` takes 4 args: `(command, parsed, conn, context)`. This works because `_stub_handler` is never registered directly in `_handlers` -- it is always called via a lambda wrapper in `_get_handler` (line 59) and `_dispatch_project` (line 115) that captures `command` via closure. However, the mismatch makes the code harder to follow at a glance.\n- **Action**: Consider refactoring `_stub_handler` to accept `(parsed, conn, context)` and derive the command name from `parsed.command`. Not blocking since the current approach is correct.\n\n#### [Low] F3: Long line in `_dispatch_project`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 115\n- **Description**: Line 115 is 116 characters, exceeding typical line length limits (88 for black, 100 for many projects). The lambda + `_handlers.get` + `_stub_handler` call is dense.\n- **Action**: Consider breaking into multiple lines for readability. Not blocking.\n\n#### [Low] F4: Global mutable `_handlers` dict shared across tests\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 54\n- **Description**: The `_handlers` dict is module-level mutable state. The test fixture `_clean_handlers` (test file line 22-28) correctly saves and restores it between tests. However, if the test suite were run in parallel (e.g., `pytest-xdist`), the shared state could cause flaky tests.\n- **Action**: For a single-process Slack plugin this is fine. Document the limitation if parallel test execution is ever introduced.\n\n#### [Info] F5: DB connection lifecycle is correct\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 86-94\n- The `dispatch()` function opens the DB connection *after* validating the command name (line 80-82 returns early for unknown commands without touching the DB). The connection is always closed in a `finally` block (line 94), ensuring no leaks even if handlers raise exceptions. This is good resource management.\n\n#### [Info] F6: Unknown commands do not open a DB connection\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 80-82\n- The `if command not in _VALID_COMMANDS` check returns before `_init_db()` is called. This avoids unnecessary DB initialization for typos and invalid commands. Good design.\n\n#### [Info] F7: Parse errors are caught and returned as user-facing messages\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 73-76\n- `ParseError` is caught and formatted as `f\"Parse error: {exc}\"`. The parser's error messages are descriptive (e.g., \"Invalid section: 'xyz'\") and do not leak internal details. This is appropriate for a Slack DM context.\n\n#### [Info] F8: Plugin entry-point correctly wired to dispatcher\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/plugin.py`\n- The `handle_message()` function now delegates to `dispatch()` instead of the previous placeholder response. The prefix matching logic is unchanged and still correct. The `db_path` parameter flows through to `dispatch()` for testability.\n\n#### [Info] F9: Schema import triggers migration registration\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 14\n- `import openclaw_todo.schema_v1 as _schema_v1` with `# noqa: F401` ensures the `@register` decorator in `schema_v1.py` runs at import time, populating the migration registry before any `migrate()` call. This is the correct pattern for the decorator-based migration system.\n\n#### [Info] F10: Test coverage is comprehensive\n\n- 20 dispatcher + plugin tests covering:\n  - All 7 non-project commands routed to stubs (parametrized)\n  - Custom handler registration and invocation\n  - All 3 project subcommands routed correctly\n  - Project with no subcommand returns usage\n  - Unknown project subcommand returns error\n  - Unknown top-level command returns error with usage\n  - Parse error propagation\n  - DB initialization with schema migration\n  - Plugin prefix matching (non-todo, todo, whitespace, bare /todo)\n\n### Code Quality Summary\n\nThe dispatcher implementation is clean, well-structured, and follows good design principles:\n\n- **Separation of concerns**: Plugin handles prefix matching; dispatcher handles parsing, validation, DB init, and routing. Each has a single responsibility.\n- **Resource safety**: DB connection opened late (only for valid commands) and closed in `finally`.\n- **Extensibility**: The `register_handler()` function provides a clean API for future command implementations to plug in without modifying the dispatcher.\n- **Defensive routing**: Unknown commands and parse errors return helpful user-facing messages without touching the DB or raising unhandled exceptions.\n- **Project sub-routing**: The `project_<subcommand>` naming convention with `replace('-', '_')` is a clean pattern for hyphenated subcommands.\n- **Test isolation**: The `_clean_handlers` autouse fixture properly saves and restores the handler registry between tests.\n\n**Verdict: APPROVE with one fix applied** -- the weak test assertion (Low, F1) has been strengthened. No Critical or High code quality issues found.\n>>>>>>> c795009 (docs(review): add review notes and fix test assertion for Issue #16)\n\n---\n\n## Security Findings\n\n<<<<<<< HEAD\n### [Low] S1: No SQL injection risk -- parameterized queries used throughout\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 38-42, 52-56\n- **Description**: All SQL queries use `?` parameter placeholders for user-supplied values (`name` and `sender_id`). The Inbox auto-creation on lines 67-75 uses hardcoded string literals only. No string interpolation or f-strings are used in any SQL statement.\n- **Severity**: Low (no risk found, noting for completeness)\n\n### [Low] S2: `name` parameter is not length-validated\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, line 27\n- **Description**: `resolve_project(conn, name, sender_id)` accepts arbitrarily long `name` strings. While SQLite handles this safely (TEXT has no inherent length limit), an extremely long name would result in unnecessary query execution against the database. The parser upstream (Issue #5) extracts project names from `/p <name>` tokens, and Slack limits message length to ~40,000 characters, providing transport-layer mitigation.\n- **Severity**: Low (mitigated by upstream constraints)\n- **Recommendation**: Consider adding a max-length check for project names in the parser or a future validation layer.\n\n### [Low] S3: Inbox auto-creation commits transaction implicitly\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, line 71\n- **Description**: `conn.commit()` inside the resolver commits all pending changes on the connection, not just the Inbox insert. If a future caller has uncommitted writes before calling `resolve_project`, those writes would be committed as a side effect. This is not exploitable but could lead to partial commits in error scenarios.\n- **Severity**: Low (no current exploit path; architectural concern)\n- **Recommendation**: Consider using a savepoint pattern (`SAVEPOINT` / `RELEASE`) for the Inbox auto-creation to isolate its transaction from any outer transaction.\n\n### [Info] S4: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `project_resolver.py` or `test_project_resolver.py`.\n\n### [Info] S5: No new dependencies introduced\n\n- The module uses only Python standard library (`sqlite3`, `dataclasses`, `logging`). No new entries in `pyproject.toml`.\n\n### [Info] S6: Authorization model is correctly scoped\n\n- The `sender_id` parameter is used correctly in the private-project query to scope visibility. User U1 cannot resolve another user's private projects. Test `test_private_different_owner_not_matched` explicitly verifies this isolation. The shared-project query correctly omits owner filtering, as shared projects are visible to all users.\n\n### Security Summary\n\nNo Critical, High, or Medium severity findings. The implementation has a minimal attack surface -- three read queries and one idempotent insert, all using parameterized queries. The authorization model (private scoped to sender, shared visible to all) is correctly implemented and tested. Three Low findings are noted for awareness but require no immediate action.\n=======\n### [Low] S1: User input reflected in error messages\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 76, 82, 110\n- **Description**: Three error paths echo user-supplied values back in responses:\n  - `f\"Parse error: {exc}\"` (line 76) -- parser error messages may contain raw user input\n  - `f\"Unknown command: '{command}'\\n{USAGE}\"` (line 82) -- the command name is user input\n  - `f\"Unknown project subcommand: '{sub}'\\n{PROJECT_USAGE}\"` (line 110) -- the subcommand is user input\n- **Severity**: Low. In the Slack DM context, Slack handles message escaping. The reflected values are single tokens (no spaces, limited characters after `split()` tokenization). No HTML/JS injection is possible in this context.\n- **Recommendation**: If the plugin ever serves responses in a web context (e.g., dashboard, webhook response viewer), sanitize reflected values. No fix needed for current Slack-only usage.\n\n### [Low] S2: No input length validation at dispatcher level\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 67\n- **Description**: `dispatch(text, ...)` accepts arbitrarily long strings, which flow to `parse()` for tokenization. Slack limits messages to approximately 40,000 characters, providing transport-layer mitigation.\n- **Severity**: Low (mitigated by Slack transport layer)\n- **Recommendation**: Consider adding a max-length guard in `handle_message()` if the plugin is ever exposed outside Slack.\n\n### [Low] S3: Handler exception propagation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 91-92\n- **Description**: If a registered handler raises an unhandled exception, it propagates up through `dispatch()`. The `finally` block ensures the DB connection is closed, but the exception itself is not caught. In the current architecture, the caller (`handle_message` in `plugin.py`) does not catch exceptions either, so an unhandled handler error would propagate to the gateway framework.\n- **Severity**: Low. The stub handlers cannot raise exceptions (they return strings). Future handler implementations should handle their own errors. A catch-all `except Exception` in `dispatch()` could provide defense-in-depth but would also mask bugs during development.\n- **Recommendation**: Consider adding a top-level exception handler in `dispatch()` that logs the error and returns a generic \"Internal error\" message, once real handlers are implemented. During development, letting exceptions propagate is acceptable.\n\n### [Info] S4: No SQL injection risk\n\n- The dispatcher does not execute any SQL directly. DB interaction is limited to `_init_db()` which calls `get_connection()` and `migrate()` -- both use hardcoded SQL or parameterized queries. User input flows through `ParsedCommand` fields to handlers, which are responsible for using parameterized queries.\n\n### [Info] S5: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `dispatcher.py`, `plugin.py`, or their test files.\n\n### [Info] S6: `db_path` parameter is configuration-controlled\n\n- The `db_path` parameter in `dispatch()` and `handle_message()` flows from the caller (gateway framework), not from user input. In tests, it comes from `tmp_path`. There is no code path where a user's message text influences the DB path.\n\n### [Info] S7: No new dependencies introduced\n\n- The dispatcher uses only Python standard library (`sqlite3`, `logging`, `typing`) plus internal modules (`db`, `migrations`, `parser`, `schema_v1`). No new entries in `pyproject.toml`.\n\n### Security Summary\n\nNo Critical or High severity findings. Three Low findings related to input reflection, length validation, and exception propagation are noted. The dispatcher has a minimal attack surface -- it validates commands against a whitelist, delegates parsing to the parser, and routes to registered handlers. The main security consideration for future work is ensuring that handler implementations use parameterized queries and handle their own exceptions gracefully.\n>>>>>>> c795009 (docs(review): add review notes and fix test assertion for Issue #16)\n\n---\n\n## Follow-up Issues (proposed)\n\n<<<<<<< HEAD\n1. **Refactor**: Extract `Project(id=row[0], ...)` into a `_row_to_project(row)` helper or `Project.from_row(row)` classmethod to reduce the triple duplication.\n2. **Test coverage**: Add a test for the edge case where a user has a private \"Inbox\" project and the shared \"Inbox\" also exists, verifying the private one is returned.\n3. **Transaction safety**: Consider using `SAVEPOINT` / `RELEASE` for Inbox auto-creation instead of bare `conn.commit()` to avoid committing unrelated pending changes.\n4. **Case sensitivity**: Document that project name matching is case-sensitive. Consider `COLLATE NOCASE` if case-insensitive matching is desired in a future iteration.\n5. **Input validation**: Add a max-length check for project names in the parser or validation layer to prevent unnecessarily large queries.\n=======\n1. **Exception handling**: Add a top-level `try/except` in `dispatch()` that catches unexpected handler exceptions, logs them at error level, and returns a generic user-facing error message. Defer until real handlers are implemented.\n2. **Refactor `_stub_handler`**: Align `_stub_handler` signature with `HandlerFn` type alias by deriving the command name from `parsed.command` instead of passing it as a separate argument. This also eliminates the lambda wrappers in `_get_handler` and `_dispatch_project`.\n3. **Line length**: Break the long line 115 in `_dispatch_project` for readability.\n4. **Context typing**: Introduce a `TypedDict` or dataclass for the `context` parameter (e.g., `class DispatchContext(TypedDict): sender_id: str`) to enable static type checking.\n5. **Input length guard**: Add a max-length check (e.g., 5000 chars) in `handle_message()` as defense-in-depth against oversized inputs.\n>>>>>>> c795009 (docs(review): add review notes and fix test assertion for Issue #16)\n", "numLines": 310, "startLine": 650, "totalLines": 959}}, "tool_use_id": "toolu_0167sjsSq6hvrmdUX55DVUM7", "_ts": "2026-02-20T19:02:04+0900"}
{"session_id": "ea23599c-057d-4544-ac7d-1239e762eed0", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/ea23599c-057d-4544-ac7d-1239e762eed0.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/docs/review_notes.md", "limit": 655}, "tool_use_id": "toolu_012mKt5Jop17tuAEJu74gfkG", "_ts": "2026-02-20T19:02:08+0900"}
{"session_id": "ea23599c-057d-4544-ac7d-1239e762eed0", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/ea23599c-057d-4544-ac7d-1239e762eed0.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/docs/review_notes.md", "limit": 655}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/docs/review_notes.md", "content": "# PR #2 Review Notes -- Issue #1: Plugin skeleton and entry point\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/001-plugin-skeleton`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `pyproject.toml` with Python >=3.11, pytest, pytest-cov dev deps | PASS | Correct. Uses `dependency-groups` (PEP 735) with hatchling backend. |\n| `src/openclaw_todo/__init__.py` exposes `__version__` | PASS | `__version__ = \"0.1.0\"` |\n| `handle_message(text: str, context: dict) -> str` entry point | PASS (minor note) | Return type is `str | None`, not `str`. The AC literally says `-> str` but `None` for ignored messages is the intended behavior per the next AC. Acceptable. |\n| Non-`/todo` messages silently ignored (returns `None`) | PASS | |\n| `uv sync && uv run pytest -q` passes | PASS | 4 tests, 100% coverage |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_ignores_non_todo_message` | PASS -- covers empty string, random text, `/todox` prefix-collision |\n| `test_dispatches_todo_prefix` | PASS -- verifies non-None response with subcommand text |\n\n### Findings\n\n#### [Info] Return type annotation mismatch with AC\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 12\n- The AC states `-> str` but the implementation is `-> str | None`. This is correct behavior (returning `None` for non-todo messages is explicitly required). The AC text is slightly imprecise; the code is right.\n- **Action**: None needed. Consider updating the AC wording if desired.\n\n#### [Info] `context` parameter unused\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 12\n- `context: dict` is accepted but never read in this skeleton. This is expected for M0 -- it will be used once the dispatcher (Issue #16) and DB commands are wired in.\n- **Action**: None. This is intentional scaffolding.\n\n#### [Info] Placeholder response includes raw user input\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 32\n- `f\"TODO command received: {remainder}\"` echoes back unescaped user input. This is a temporary placeholder (comment says \"will be replaced by dispatcher in Issue #16\"). In the current context (no HTML/web rendering, Slack DM only), this is not exploitable, but see Security Findings below.\n- **Action**: Track as part of Issue #16.\n\n#### [Info] Extra tests beyond AC requirements -- good\n\n- `test_todo_prefix_with_whitespace` and `test_todo_without_subcommand` are bonus tests covering whitespace handling and bare `/todo` usage message. Good coverage instinct.\n\n#### [Info] Version duplication\n\n- Version `0.1.0` appears in both `pyproject.toml` and `__init__.py`. Consider using `importlib.metadata` or dynamic versioning in a future issue to keep a single source of truth. Not a concern for M0.\n\n#### [Low] No type hints for `context` dict\n\n- `context: dict` is untyped (could be `dict[str, Any]` or a TypedDict). For M0 this is fine, but a `TypedDict` or dataclass should be introduced when the context shape solidifies.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and well-structured for a skeleton:\n\n- Prefix matching logic (`stripped == _TODO_PREFIX or stripped.startswith(_TODO_PREFIX + \" \")`) correctly avoids false positives on `/todox`.\n- Logging at appropriate levels (debug for all messages, info for matches).\n- Usage help returned for bare `/todo` is a nice touch.\n- Test coverage is 100%.\n\n**Verdict: APPROVE** -- no blocking issues.\n\n---\n\n## Security Findings\n\n### [Low] S1: User input echoed in placeholder response\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 32\n- **Description**: The placeholder `f\"TODO command received: {remainder}\"` reflects user-supplied text without sanitization. In the current Slack DM context, Slack handles rendering and this is not exploitable for XSS. However, once a web dashboard or logging UI is introduced, unsanitized echo could become a reflected XSS vector.\n- **Severity**: Low (Slack auto-escapes; placeholder will be replaced in Issue #16)\n- **Recommendation**: When building the real dispatcher, ensure any user text echoed in responses is sanitized if it ever reaches a web context. No fix needed now.\n\n### [Low] S2: No input length validation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 12\n- **Description**: `handle_message` accepts arbitrarily long strings. A malicious or buggy client could send extremely large messages. Slack itself limits messages to ~40,000 characters, so this is mitigated at the transport layer.\n- **Severity**: Low\n- **Recommendation**: Consider adding a max-length guard in the dispatcher (Issue #16) if the plugin is ever exposed outside Slack.\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in any reviewed files. Environment variable approach is correctly deferred to future DB/config work.\n\n### [Info] S4: Dependencies are minimal and current\n\n- Only dev dependencies: `pytest>=7.0` and `pytest-cov>=4.0`. No known CVEs for these versions. No runtime dependencies beyond the standard library.\n- Build backend `hatchling` is a well-maintained, standard tool.\n\n### [Info] S5: No SQL, no deserialization, no file I/O\n\n- The M0 skeleton has no database, no file operations, and no deserialization. The attack surface is effectively zero at this stage.\n\n### Security Summary\n\nNo Critical or High severity findings. The codebase has a minimal attack surface appropriate for a plugin skeleton. Security considerations will become relevant starting with Issue #2 (DB connection) and Issue #5 (parser with user-controlled input).\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Issue #16 (Dispatcher)**: When replacing the placeholder response, ensure user input is not echoed raw if the output context changes (e.g., web UI).\n2. **Future**: Introduce a `TypedDict` or dataclass for the `context` parameter to enforce shape and enable static analysis.\n3. **Future**: Consolidate version to a single source (e.g., `importlib.metadata.version(\"openclaw-todo-plugin\")`).\n\n---\n\n# PR #4 Review Notes -- Issue #2: DB module -- connection helper and pragma setup\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/002-db-connection`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| Directory is created recursively when absent | PASS | `db_dir.mkdir(parents=True, exist_ok=True)` on line 32. Test `test_creates_directory_and_file` verifies nested `nested/dir/` creation. |\n| SQLite connection returned with WAL mode enabled | PASS | `PRAGMA journal_mode=WAL` on line 36. Test verifies `fetchone()[0] == \"wal\"`. |\n| `busy_timeout` is 3000 | PASS | `PRAGMA busy_timeout=3000` on line 37. Test verifies `fetchone()[0] == 3000`. |\n| Calling `get_connection` twice returns usable connections (no lock conflict) | PASS | `test_two_connections_no_conflict` creates a table via conn1, reads via conn2. WAL mode enables this concurrency. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `tests/test_db.py::test_creates_directory_and_file` | PASS -- verifies both `db_path.exists()` and `db_path.parent.exists()` with nested `tmp_path` |\n| `tests/test_db.py::test_wal_mode_enabled` | PASS -- queries `PRAGMA journal_mode` and asserts `\"wal\"` |\n| `tests/test_db.py::test_busy_timeout` | PASS -- queries `PRAGMA busy_timeout` and asserts `3000` |\n\n### Findings\n\n#### [Info] TOCTOU in `is_new` logging check\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 29\n- `is_new = not db_path.exists()` is checked before `sqlite3.connect()`, which itself creates the file. In a concurrent scenario, the file could appear between the check and the connect. This only affects which log message is emitted (info vs. debug) and has no functional impact.\n- **Action**: None required. Purely cosmetic race condition.\n\n#### [Info] PRAGMA return values not checked\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, lines 36-37\n- `conn.execute(\"PRAGMA journal_mode=WAL;\")` returns a result set with the actual journal mode applied. On some edge cases (e.g., read-only filesystem, in-memory DB), WAL activation can silently fall back to another mode. The code does not verify the return.\n- **Action**: Low priority. Consider adding a debug-level assertion or log warning in a future hardening pass. The test suite already validates WAL is active in the happy path.\n\n#### [Info] Default path uses `Path.home()`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 11\n- `DEFAULT_DB_DIR = Path.home() / \".openclaw\" / \"workspace\" / \".todo\"` is evaluated at module import time. If `HOME` is unset (e.g., certain containerized environments), `Path.home()` raises `RuntimeError`. This is acceptable since: (a) the default is only used when `db_path is None`, and (b) the plugin is designed for environments where `HOME` is set. Callers in containers should pass an explicit path.\n- **Action**: None for M1. Document the `db_path` parameter as the recommended override for non-standard environments.\n\n#### [Info] Extra test beyond AC requirements -- good\n\n- `test_two_connections_no_conflict` is a bonus test that exercises concurrent WAL access. This directly validates the 4th acceptance criterion and is well-structured with proper cleanup in a `finally` block.\n\n#### [Low] Test cleanup uses `try/finally` instead of a fixture\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_db.py`, all tests\n- Each test manually opens a connection and closes it in `try/finally`. A pytest fixture (e.g., `@pytest.fixture` yielding the connection) would reduce boilerplate and guarantee cleanup even if assertion lines are added later. This is a minor style observation for 4 tests.\n- **Action**: Optional refactor. Not blocking.\n\n#### [Info] Coverage at 96%\n\n- Line 24 (`db_path = DEFAULT_DB_DIR / DEFAULT_DB_NAME`) is uncovered because all tests pass explicit `tmp_path` paths. This is correct -- testing the default path would write to the user's actual home directory. The uncovered line is trivial assignment logic.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and correct:\n\n- Function signature `get_connection(db_path: str | Path | None = None)` is flexible, accepting string, Path, or None.\n- `Path(db_path)` normalization on line 26 handles string inputs.\n- `exist_ok=True` on `mkdir` prevents race conditions with concurrent directory creation.\n- Logging at appropriate levels: `info` for creation, `debug` for opens.\n- No unnecessary dependencies -- uses only stdlib `sqlite3`, `pathlib`, and `logging`.\n- 96% test coverage with all acceptance criteria verified.\n\n**Verdict: APPROVE** -- no blocking issues.\n\n---\n\n## Security Findings\n\n### [Low] S1: `db_path` parameter accepts arbitrary filesystem paths\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 15\n- **Description**: `get_connection(db_path)` will create directories and an SQLite database at any filesystem path the process has write access to. If a future caller passes unsanitized user input as `db_path`, this could be used for arbitrary file creation (e.g., path traversal via `../../etc/cron.d/evil`).\n- **Severity**: Low (currently an internal API; no user-facing code path passes user input to `db_path`)\n- **Recommendation**: When wiring `db_path` into the dispatcher (Issue #16), ensure the path comes only from configuration (env var or config file), never from user-controlled message text. Consider adding a validation that `db_path` is within an expected base directory.\n\n### [Info] S2: No SQL injection risk\n\n- PRAGMA statements on lines 36-37 use hardcoded string literals with no interpolation. The `db_path` is passed to `sqlite3.connect()` as a filesystem path, not as a SQL query. No injection surface exists.\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `db.py` or `test_db.py`. The module uses only stdlib.\n\n### [Info] S4: No new dependencies introduced\n\n- This module uses only Python standard library (`sqlite3`, `pathlib`, `logging`). No new entries in `pyproject.toml` dependencies. Zero additional attack surface from third-party code.\n\n### [Info] S5: SQLite WAL mode is a security-positive choice\n\n- WAL mode improves concurrent access safety and reduces the risk of database corruption from concurrent writes. The `busy_timeout=3000` prevents immediate lock failures, which could otherwise cause data loss if a caller does not handle `sqlite3.OperationalError` properly.\n\n### Security Summary\n\nNo Critical or High severity findings. The attack surface is minimal -- a single function that creates a local SQLite database with hardcoded pragmas. The only surface to monitor is ensuring `db_path` remains configuration-controlled as the codebase grows.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Issue #3 (Migration framework)**: When implementing migrations, ensure SQL statements use parameterized queries (not string formatting) for any dynamic values. The migration runner should validate migration callables are from a trusted registry.\n2. **Future**: Add a pytest fixture for `get_connection` that yields and auto-closes, reducing `try/finally` boilerplate across DB-related test files.\n3. **Future**: Consider adding a `validate_db_path(path)` helper that constrains paths to an allowed base directory, for defense-in-depth when the dispatcher wires in configuration.\n\n---\n\n# PR #6 Review Notes -- Issue #3: Schema migration framework and schema_version table\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/003-schema-migration`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `schema_version` table created with single row `version=0` if absent | PASS | `_ensure_version_table` uses `CREATE TABLE IF NOT EXISTS` and inserts `version=0` only when no row exists (line 30-31). |\n| Migrations are Python callables registered in an ordered list | PASS | `_migrations: list[MigrationFn]` with `@register` decorator appending to the list. Index maps directly to migration version. |\n| Each migration runs inside a transaction; version incremented on success | PASS | `conn.commit()` after each successful migration (line 65). SQLite's implicit transaction wraps the migration + version update. |\n| Re-running on an up-to-date DB is a no-op | PASS | `current >= target` guard on line 52 returns immediately. Test `test_idempotent_on_rerun` verifies. |\n| Failing migration rolls back and raises with clear message | PASS | `conn.rollback()` in `except` block (line 67). `RuntimeError` with formatted message including version number and original exception (line 68-70). |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_fresh_db_gets_version_table` | PASS -- verifies `get_version` returns 0 and `schema_version` table exists in `sqlite_master` |\n| `test_applies_migrations_sequentially` | PASS -- registers two migrations, asserts final version is 2, verifies both tables created |\n| `test_idempotent_on_rerun` | PASS -- calls `migrate` twice, both return 1, no errors |\n| `test_rollback_on_failure` | PASS -- first migration commits (version 1, `t_ok` exists), second raises `ValueError`, caught as `RuntimeError`, version stays at 1 |\n\n### Findings\n\n#### [Medium] No constraint preventing multiple rows in `schema_version`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- The `schema_version` table is created with `(version INTEGER NOT NULL)` but has no PRIMARY KEY, UNIQUE constraint, or CHECK constraint limiting it to a single row. If a bug or manual intervention inserts a second row, `get_version` would return whichever row SQLite returns first from `SELECT version FROM schema_version` (non-deterministic without ORDER BY).\n- **Action**: Consider adding a single-row constraint in a future migration (e.g., `CHECK (rowid = 1)` or a dummy `id INTEGER PRIMARY KEY CHECK (id = 1)` column). Not blocking for M1 since all writes go through `_ensure_version_table` which correctly checks before inserting.\n\n#### [Low] Redundant `_ensure_version_table` calls\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, lines 48-49\n- `migrate()` calls `_ensure_version_table(conn)` on line 48, then calls `get_version(conn)` on line 49, which internally calls `_ensure_version_table` again. This results in two `CREATE TABLE IF NOT EXISTS` and two `SELECT version` queries on every `migrate` call.\n- **Action**: Minor performance concern. Could be refactored so `migrate` calls `_ensure_version_table` once and reads the version directly. Not blocking.\n\n#### [Info] Global mutable state for migrations registry\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 15\n- `_migrations` is a module-level mutable list. This is a common pattern for migration registries and works well for single-process applications. The test suite correctly saves/restores it via the `_clean_migrations` autouse fixture (lines 16-23 in test file).\n- **Action**: None. This is an appropriate pattern for this use case. If multi-process or plugin-based architectures are introduced later, consider a class-based registry.\n\n#### [Info] Test fixture properly isolates migration state\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_migrations.py`, lines 16-23\n- The `_clean_migrations` fixture saves the original list, clears it before each test, and restores it after. This prevents test pollution and is correctly marked `autouse=True`. The save-clear-yield-clear-extend pattern is the correct idiom.\n\n#### [Info] `conn` fixture uses `get_connection` from `db` module\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_migrations.py`, lines 27-31\n- The test fixture uses `get_connection` (from Issue #2) rather than raw `sqlite3.connect`. This ensures WAL mode and `busy_timeout` pragmas are applied, matching production behavior. This is a good integration practice.\n\n#### [Info] Coverage at 100%\n\n- All 41 statements in `migrations.py` are covered by the 4 tests. No untested branches.\n\n#### [Info] Error message includes original exception\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, lines 68-70\n- `raise RuntimeError(...) from exc` preserves the exception chain, making debugging easier. The message format `\"Migration to version {N} failed: {exc}\"` clearly identifies which migration failed. This follows the acceptance criterion for \"clear message.\"\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and minimal:\n\n- The `@register` decorator pattern is intuitive for defining migrations in order.\n- Transaction semantics are correctly handled: commit on success, rollback on failure.\n- The version update uses a parameterized query (`?` placeholder on line 63), avoiding SQL injection.\n- Logging at appropriate levels: `info` for migration steps and completion, `debug` for up-to-date status.\n- The code correctly handles the edge case where `current > target` (e.g., if migrations are removed), treating it the same as up-to-date.\n- 100% test coverage with all four required tests present and passing.\n\n**Verdict: APPROVE** -- no blocking issues. One medium finding (missing single-row constraint) noted for follow-up.\n\n---\n\n## Security Findings\n\n### [Medium] S1: `schema_version` table lacks row-count constraint\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- **Description**: The `schema_version` table has no mechanism to enforce that exactly one row exists. While the application code only writes through `_ensure_version_table` (which checks before inserting) and `migrate` (which uses `UPDATE`), a direct SQL injection in a future module or manual DB editing could insert additional rows, causing `get_version` to return an unpredictable value. This could lead to migrations being skipped or re-applied.\n- **Severity**: Medium (requires either a separate SQL injection vulnerability or direct DB access to exploit; impact is schema corruption)\n- **Recommendation**: In the V1 schema migration (Issue #4), alter or recreate the table with a single-row constraint, e.g., `CREATE TABLE schema_version (id INTEGER PRIMARY KEY CHECK (id = 1), version INTEGER NOT NULL)`.\n\n### [Info] S2: No SQL injection risk in migration runner\n\n- All SQL in `migrations.py` uses either hardcoded string literals or parameterized queries (`?` on line 63 for the version update). The `MigrationFn` type receives a `Connection` object, and it is the responsibility of each registered migration to use parameterized queries. This is correctly documented in the PR #4 review follow-up.\n\n### [Info] S3: Migration functions are trusted code\n\n- The `@register` decorator appends arbitrary callables to the migration list. Since migrations are defined at module import time by the application developer (not by user input), there is no injection risk. The registry is not exposed to any user-facing API.\n\n### [Info] S4: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `migrations.py` or `test_migrations.py`.\n\n### [Info] S5: No new dependencies introduced\n\n- This module uses only Python standard library (`sqlite3`, `logging`, `typing`). No new entries in `pyproject.toml` dependencies.\n\n### [Info] S6: Exception message does not leak sensitive data\n\n- The `RuntimeError` message on line 69 includes the migration version number and the string representation of the original exception. In this context (local SQLite, no user-supplied data in migration functions), this does not leak sensitive information. If migrations ever process user data, the exception wrapping should be reviewed to avoid leaking PII in logs.\n\n### Security Summary\n\nNo Critical or High severity findings. One Medium finding regarding the missing single-row constraint on `schema_version`, which could lead to schema version confusion if combined with a separate vulnerability that allows arbitrary SQL execution. The recommendation is to address this in the Issue #4 V1 schema migration.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Issue #4 (V1 schema)**: Add a single-row constraint to `schema_version` (e.g., `CHECK (id = 1)` on a primary key column) as part of the V1 migration to prevent version-table corruption.\n2. **Future**: Refactor `migrate()` to avoid redundant `_ensure_version_table` calls for minor performance improvement.\n3. **Future**: Consider adding a `--dry-run` mode to the migration runner that reports which migrations would be applied without executing them, useful for deployment verification.\n\n---\n\n# PR #8 Review Notes -- Issue #4: V1 schema migration -- projects, tasks, task_assignees, events\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/004-v1-schema`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `projects` table with `ux_projects_shared_name` and `ux_projects_private_owner_name` partial unique indexes | PASS | Table created on lines 18-26, indexes on lines 28-36 of `schema_v1.py`. Partial `WHERE` clauses match PRD exactly. |\n| `tasks` table with section and status CHECK constraints | PASS | Section CHECK on line 43 (`backlog, doing, waiting, done, drop`), status CHECK on line 45 (`open, done, dropped`). Both match PRD spec. |\n| `task_assignees` table with composite PK and secondary index | PASS | Composite `PRIMARY KEY (task_id, assignee_user_id)` on line 57, secondary index `ix_task_assignees_user` on lines 61-64. |\n| `events` audit table created | PASS | Table on lines 66-75. Columns match PRD. |\n| Shared `Inbox` project auto-created (INSERT OR IGNORE) | PASS | Line 78-81 uses `INSERT OR IGNORE` with `('Inbox', 'shared', NULL)`. |\n| `schema_version` = 1 after migration | PASS | Test `test_v1_schema_version` verifies `get_version(conn) == 1`. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_v1_tables_exist` | PASS -- verifies all four tables exist in `sqlite_master` |\n| `test_v1_inbox_created` | PASS -- verifies name='Inbox', visibility='shared', owner_user_id=None |\n| `test_v1_shared_unique_index_enforced` | PASS -- duplicate shared name raises `IntegrityError` |\n| `test_v1_private_unique_index_enforced` | PASS -- duplicate (owner, name) raises `IntegrityError`; different owner succeeds |\n\n### Findings\n\n#### [High] F1: Foreign keys not enforced -- `PRAGMA foreign_keys=ON` missing\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 35-37\n- **Description**: SQLite does not enforce `REFERENCES` (foreign key) clauses by default. The `PRAGMA foreign_keys=ON` must be executed on every new connection for FK constraints to be active. Without this, the `REFERENCES projects(id)` on `tasks.project_id` and `REFERENCES tasks(id)` on `task_assignees.task_id` are purely decorative -- you can insert tasks pointing to non-existent projects and assignees pointing to non-existent tasks.\n- **Impact**: Referential integrity is silently not enforced, leading to orphaned rows and data corruption.\n- **Fix applied**: Added `conn.execute(\"PRAGMA foreign_keys=ON;\")` to `get_connection()` in `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 38. All 19 tests pass after the fix.\n\n#### [Medium] F2: `schema_version` single-row constraint not added in V1\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- **Description**: The PR #6 review (Medium finding S1) recommended adding a single-row constraint to `schema_version` as part of the V1 migration. This was not addressed. The table still has no PK or CHECK constraint to prevent multiple rows.\n- **Action**: Should be addressed in a follow-up issue. Adding it retroactively in a later migration (e.g., V2) would require recreating the table since SQLite does not support `ALTER TABLE ADD CONSTRAINT`.\n\n#### [Low] F3: Minor PRD deviation on `events.ts` -- NOT NULL DEFAULT added\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/schema_v1.py`, line 69\n- **Description**: The PRD spec for `events.ts` says `ts TEXT` with no nullability or default constraint. The implementation adds `NOT NULL DEFAULT (datetime('now'))`. This is a sensible enhancement (audit timestamps should always be present), but it is a deviation from the spec.\n- **Action**: None needed. The implementation is better than the spec. Consider updating the PRD to match.\n\n#### [Low] F4: `events.id` uses AUTOINCREMENT, PRD says PK only\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/schema_v1.py`, line 68\n- **Description**: PRD says `id INTEGER PK` for the events table. The implementation uses `INTEGER PRIMARY KEY AUTOINCREMENT`. AUTOINCREMENT prevents rowid reuse after deletion, which is actually preferable for an audit log (guarantees monotonically increasing IDs). This is a minor deviation but a positive one.\n- **Action**: None needed. Consider updating the PRD.\n\n#### [Low] F5: No test for `task_assignees` composite PK enforcement\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_schema_v1.py`\n- **Description**: The acceptance criteria mention `task_assignees` table with composite PK, but there is no test verifying that inserting a duplicate `(task_id, assignee_user_id)` pair raises `IntegrityError`. The composite PK is created, but its enforcement is untested.\n- **Action**: Add a test in a follow-up to insert a duplicate pair and assert `IntegrityError`.\n\n#### [Low] F6: No test for foreign key enforcement\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_schema_v1.py`\n- **Description**: No test verifies that inserting a task with a non-existent `project_id` raises an error, or that inserting a `task_assignee` with a non-existent `task_id` raises an error. With the FK pragma fix (F1), these would now fail correctly, but there is no test coverage for this behavior.\n- **Action**: Add FK enforcement tests in a follow-up.\n\n#### [Info] F7: Test fixture pattern is well-structured\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_schema_v1.py`, lines 11-25\n- The `_load_v1_migration` autouse fixture correctly saves, clears, imports, and restores the migration registry. The `conn` fixture properly creates a temp DB, migrates, yields, and closes. This is clean test isolation.\n\n#### [Info] F8: CHECK constraint tests are thorough\n\n- Tests `test_v1_section_check_constraint` and `test_v1_status_check_constraint` go beyond the required tests to verify that invalid enum values are rejected. Good defensive testing.\n\n#### [Info] F9: 8 tests total for V1 schema, all passing\n\n- `test_v1_tables_exist`, `test_v1_schema_version`, `test_v1_inbox_created`, `test_v1_shared_unique_index_enforced`, `test_v1_private_unique_index_enforced`, `test_v1_section_check_constraint`, `test_v1_status_check_constraint` (7 tests in `test_schema_v1.py`). Plus the rollback test verifies `conn.rollback()` is correctly called after each constraint violation test.\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and closely follows the PRD spec:\n\n- All four tables are created with the correct columns, types, and constraints.\n- Partial unique indexes use the correct `WHERE` clause syntax.\n- CHECK constraints enumerate exactly the values specified in the PRD.\n- `INSERT OR IGNORE` for the Inbox seed is idempotent.\n- Parameterized queries are not needed here (all DDL uses string literals with no interpolation).\n- The `@register` decorator integrates seamlessly with the migration framework from Issue #3.\n- Test coverage is good, with 7 tests covering table existence, version, seed data, unique indexes, and CHECK constraints.\n\n**Verdict: APPROVE with one fix applied** -- the `PRAGMA foreign_keys=ON` fix (High, F1) has been applied directly. Medium/Low findings are noted for follow-up.\n\n---\n\n## Security Findings\n\n### [High] S1: Foreign key constraints not enforced (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 35-37\n- **Description**: Without `PRAGMA foreign_keys=ON`, all `REFERENCES` clauses in the V1 schema are ignored. This means a future command handler could insert tasks referencing non-existent projects or assignees referencing non-existent tasks, leading to data integrity violations that are silent and hard to debug. In a multi-user Slack plugin, this could allow one user's actions to create orphaned records that cause errors for other users.\n- **Severity**: High (data integrity violation in a multi-user context; silent failure mode)\n- **Fix**: Added `conn.execute(\"PRAGMA foreign_keys=ON;\")` to `get_connection()`. All 19 tests pass.\n\n### [Medium] S2: `schema_version` table remains unprotected against multi-row corruption\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- **Description**: Carried forward from PR #6 review. The `schema_version` table has no constraint preventing insertion of additional rows. If a separate vulnerability allows arbitrary SQL execution, an attacker could manipulate the schema version to skip or re-run migrations.\n- **Severity**: Medium (requires a chained vulnerability to exploit)\n- **Recommendation**: Address in a future migration that recreates the table with a single-row constraint.\n\n### [Info] S3: No SQL injection risk in V1 migration\n\n- All SQL in `schema_v1.py` uses hardcoded string literals. No user input, no string interpolation, no parameterized queries needed. The `INSERT OR IGNORE` for the Inbox seed uses literal values only.\n\n### [Info] S4: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `schema_v1.py` or `test_schema_v1.py`.\n\n### [Info] S5: No new dependencies introduced\n\n- The V1 migration uses only Python standard library (`sqlite3`, `logging`). No new entries in `pyproject.toml`.\n\n### [Info] S6: CHECK constraints provide defense-in-depth\n\n- The `section` and `status` CHECK constraints on the `tasks` table prevent invalid enum values at the database level, not just the application level. This is a security-positive pattern that prevents data corruption even if the application layer has a bug.\n\n### Security Summary\n\nOne High severity finding (S1: missing `PRAGMA foreign_keys=ON`) was identified and fixed directly in `db.py`. One Medium finding (S2: `schema_version` single-row constraint) is carried forward from the previous review. No Critical findings.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Test coverage**: Add tests for `task_assignees` composite PK enforcement (duplicate pair should raise `IntegrityError`).\n2. **Test coverage**: Add tests for foreign key enforcement (task with non-existent `project_id`, assignee with non-existent `task_id` should raise `IntegrityError` now that FK pragma is enabled).\n3. **Schema version constraint**: Address the `schema_version` single-row constraint in a future migration (V2 or later) by recreating the table with `CHECK (id = 1)`.\n4. **PRD sync**: Update PRD section 6.3 to add `NOT NULL DEFAULT (datetime('now'))` to `events.ts` and `AUTOINCREMENT` to `events.id` to match the implementation.\n5. **DB module**: Add a test for `PRAGMA foreign_keys` returning `1` in `test_db.py` to prevent regression.\n\n---\n\n# PR #10 Review Notes -- Issue #5: Command parser -- tokenizer and option extraction\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/005-parser-tokenizer`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `/p MyProject` correctly extracted; token consumed | PASS | `test_extract_project` verifies project name extracted, `/p` and value removed from `title_tokens`. |\n| `/s doing` validated; invalid section raises `ParseError` | PASS | `test_extract_section_valid` and `test_extract_section_invalid` cover both paths. Case-insensitive via `.lower()`. |\n| `due:03-15` normalised to `2026-03-15` (current year) | PASS | `test_due_mm_dd_normalisation` verifies with `date.today().year`. |\n| `due:2026-02-30` raises `ParseError` (invalid date) | PASS | `test_due_invalid_date` asserts `ParseError` with match on \"Invalid due date\". |\n| `<@U12345>` extracted into mentions list | PASS | `test_mentions_extraction` verifies two mentions extracted and not in `title_tokens`. |\n| Multiple mentions supported | PASS | Same test covers two mentions in order. |\n| Title tokens are non-option, non-mention tokens before first option | PASS | `test_title_extraction` verifies correct split with mixed options. Note: title tokens are collected from *all* positions, not just \"before first option\" -- this is arguably more flexible than the AC wording. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_extract_project` | PASS |\n| `test_extract_section_valid` | PASS |\n| `test_extract_section_invalid` | PASS |\n| `test_due_mm_dd_normalisation` | PASS |\n| `test_due_full_date` | PASS |\n| `test_due_invalid_date` | PASS |\n| `test_due_clear` | PASS |\n| `test_mentions_extraction` | PASS |\n| `test_title_extraction` | PASS |\n\nAll 9 required tests present and passing. 4 additional bonus tests (`test_command_extraction`, `test_move_extracts_id_as_arg`, `test_empty_command_raises`, `test_section_case_insensitive`). 13 parser tests total.\n\n### Findings\n\n#### [Medium] F1: Leap-year bug in `_normalise_due` for MM-DD format (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 53-62 (after fix)\n- **Description**: The original implementation used `datetime.strptime(raw, \"%m-%d\")` which defaults to year 1900 (not a leap year). This caused `due:02-29` to always be rejected, even when the current year is a leap year (e.g., 2028). The `replace(year=current_year)` call was never reached because `strptime` itself raised `ValueError`.\n- **Fix applied**: Replaced `strptime(\"%m-%d\")` with a regex match `(\\d{1,2})-(\\d{1,2})` followed by direct `date(current_year, month, day)` construction. This correctly validates Feb 29 against the actual current year.\n- **Impact**: Without fix, `due:02-29` would fail in leap years (2028, 2032, etc.) when it should succeed.\n\n#### [Low] F2: Duplicate options silently use \"last wins\" semantics\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 91-117\n- **Description**: If a user provides `/p First /p Second`, the parser silently uses `Second`. Same for `/s` and `due:`. This is not necessarily wrong, but it is undocumented. \"Last wins\" is a reasonable default, but \"first wins\" or \"raise error on duplicate\" are also valid choices.\n- **Action**: Document the \"last wins\" behavior in the docstring or PRD. No code change needed.\n\n#### [Low] F3: `/p` and `/s` error paths (missing argument) are untested\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_parser.py`\n- **Description**: Lines 93 and 101 (`raise ParseError(\"/p requires a project name\")` and `/s` equivalent) are uncovered. Manual testing confirmed they work correctly, but automated test coverage is missing for these edge cases.\n- **Action**: Add tests for `parse(\"add task /p\")` and `parse(\"add task /s\")` in a follow-up.\n\n#### [Low] F4: `_DUE_RE` uses `.+` which accepts any characters after `due:`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, line 15\n- **Description**: `_DUE_RE = re.compile(r\"^due:(.+)$\")` will match `due:anything` and pass the value to `_normalise_due`. This is not a bug since `_normalise_due` properly validates the value, but a tighter regex like `r\"^due:([\\d-]+)$\"` would reject obviously invalid inputs earlier and serve as documentation of expected format.\n- **Action**: Optional tightening. Not blocking since validation is correct.\n\n#### [Low] F5: Title tokens are collected from all positions, not just \"before first option\"\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 126-128\n- **Description**: The AC says \"Title tokens are non-option, non-mention tokens before first option.\" The implementation collects title tokens from all positions (e.g., `add Buy /p Home milk` would produce `title_tokens=[\"Buy\", \"milk\"]`). This is actually more flexible and user-friendly, but deviates from the literal AC wording.\n- **Action**: Consider updating the AC to match the implementation. The current behavior is better for UX.\n\n#### [Info] F6: `args` extraction for `move/done/drop/edit` is well-designed\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 130-133\n- The pattern of extracting the first title token as `args[0]` for ID-based commands is clean and tested by `test_move_extracts_id_as_arg`.\n\n#### [Info] F7: Coverage at 97%\n\n- Lines 93 and 101 (error paths for missing `/p` and `/s` arguments) are uncovered. All other branches are tested. This is acceptable for M1.\n\n#### [Info] F8: Bonus tests add good defensive coverage\n\n- `test_section_case_insensitive` ensures `/s DOING` normalizes to `doing`.\n- `test_command_extraction` verifies the first token becomes the command.\n- `test_empty_command_raises` covers the empty input guard.\n- `test_move_extracts_id_as_arg` covers the args extraction logic.\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and well-structured:\n\n- The tokenizer loop with explicit index management (`while i < len(remaining)`) is readable and handles two-token options (`/p`, `/s`) cleanly by advancing `i` by 2.\n- `ParsedCommand` dataclass provides a clear, typed result structure.\n- `VALID_SECTIONS` as a `frozenset` is the right choice for O(1) membership testing.\n- `_MENTION_RE` uses `fullmatch` (not `match` or `search`), preventing partial matches on tokens like `<@U123>extra`.\n- Error messages are descriptive and include the invalid value with `repr()` formatting.\n- Logging at debug level for parsed results is appropriate.\n- 97% test coverage with all 9 required tests present and 4 bonus tests.\n\n**Verdict: APPROVE with one fix applied** -- the leap-year bug in `_normalise_due` (Medium, F1) has been fixed directly. Low findings are noted for follow-up.\n\n---\n\n## Security Findings\n\n### [Medium] S1: Leap-year date validation bypass (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, `_normalise_due`\n- **Description**: The original `strptime(\"%m-%d\")` approach silently rejected valid dates (`02-29` in leap years) due to the 1900 default year. While this is a correctness issue rather than a security vulnerability, incorrect date validation can lead to denial of service (users unable to set valid due dates) and data integrity issues (dates that should be accepted are rejected).\n- **Severity**: Medium (correctness bug with functional impact)\n- **Fix**: Replaced with regex-based month/day extraction and direct `date()` construction with the current year.\n\n### [Low] S2: No ReDoS risk in compiled regexes\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 14-15\n- **Description**: Both `_MENTION_RE = re.compile(r\"<@(U[A-Z0-9]+)>\")` and `_DUE_RE = re.compile(r\"^due:(.+)$\")` were tested with 100,000-character inputs and completed in under 0.1ms. Neither pattern contains nested quantifiers or alternation that could cause catastrophic backtracking.\n- **Severity**: Low (no risk found, noting for completeness)\n\n### [Low] S3: No input length validation on parser input\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, line 72\n- **Description**: `parse(text)` accepts arbitrarily long strings. `text.strip().split()` will allocate a token list proportional to input size. Slack limits messages to ~40,000 characters, mitigating this at the transport layer, but if the parser is used outside Slack, extremely long inputs could cause memory pressure.\n- **Severity**: Low (mitigated by Slack transport layer limits)\n- **Recommendation**: Consider adding a max-length guard in the plugin entry point (`handle_message`) rather than the parser itself.\n\n### [Info] S4: No injection risks\n\n- The parser only tokenizes and validates strings. No SQL, no shell commands, no template rendering. User input flows into `ParsedCommand` fields which are plain strings. Security depends on how these values are consumed downstream (e.g., parameterized queries when writing to SQLite).\n\n### [Info] S5: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `parser.py` or `test_parser.py`.\n\n### [Info] S6: No new dependencies introduced\n\n- The parser uses only Python standard library (`re`, `datetime`, `dataclasses`, `logging`). No new entries in `pyproject.toml`.\n\n### Security Summary\n\nNo Critical or High severity findings. One Medium finding (S1: leap-year date validation) was identified and fixed. The parser has a minimal attack surface -- it tokenizes strings and validates against known patterns. The main security consideration going forward is ensuring that `ParsedCommand` field values are used safely downstream (parameterized SQL queries, no raw echo in web contexts).\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Test coverage**: Add tests for `/p` and `/s` without arguments (lines 93, 101) to cover the missing-argument error paths.\n2. **Documentation**: Document \"last wins\" semantics for duplicate `/p`, `/s`, and `due:` options in the PRD or parser docstring.\n3. **Optional**: Tighten `_DUE_RE` from `.+` to `[\\d-]+` for earlier rejection of obviously invalid due values.\n4. **AC clarification**: Update Issue #5 AC to reflect that title tokens are collected from all positions (not just \"before first option\"), matching the implemented behavior.\n\n---\n\n<<<<<<< HEAD", "numLines": 655, "startLine": 1, "totalLines": 959}}, "tool_use_id": "toolu_012mKt5Jop17tuAEJu74gfkG", "_ts": "2026-02-20T19:02:08+0900"}
{"session_id": "ea23599c-057d-4544-ac7d-1239e762eed0", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/ea23599c-057d-4544-ac7d-1239e762eed0.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "python3 -c \"\nimport re\n\nwith open('docs/review_notes.md', 'r') as f:\n    content = f.read()\n\n# Strategy: keep HEAD (Issue #7) content first, then theirs (Issue #16) content\n# Remove all conflict markers and keep both sections\n\n# Pattern: <<<<<<< HEAD ... ======= ... >>>>>>> ...\n# We want to keep both sides (HEAD first, then theirs)\ndef resolve_keep_both(match):\n    head = match.group(1)\n    theirs = match.group(2)\n    return head + theirs\n\nresolved = re.sub(\n    r'<<<<<<< HEAD\\n(.*?)=======\\n(.*?)>>>>>>> [^\\n]+\\n',\n    resolve_keep_both,\n    content,\n    flags=re.DOTALL\n)\n\nwith open('docs/review_notes.md', 'w') as f:\n    f.write(resolved)\n\nprint('Resolved successfully')\nprint(f'Conflict markers remaining: {resolved.count(\\\"<<<<<<<\\\")}')\n\"\n", "description": "Resolve merge conflict keeping both review sections"}, "tool_use_id": "toolu_01XdHo3LBhgwrqM4C7nvu3si", "_ts": "2026-02-20T19:02:19+0900"}
{"session_id": "ea23599c-057d-4544-ac7d-1239e762eed0", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/ea23599c-057d-4544-ac7d-1239e762eed0.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "python3 -c \"\nimport re\n\nwith open('docs/review_notes.md', 'r') as f:\n    content = f.read()\n\n# Strategy: keep HEAD (Issue #7) content first, then theirs (Issue #16) content\n# Remove all conflict markers and keep both sections\n\n# Pattern: <<<<<<< HEAD ... ======= ... >>>>>>> ...\n# We want to keep both sides (HEAD first, then theirs)\ndef resolve_keep_both(match):\n    head = match.group(1)\n    theirs = match.group(2)\n    return head + theirs\n\nresolved = re.sub(\n    r'<<<<<<< HEAD\\n(.*?)=======\\n(.*?)>>>>>>> [^\\n]+\\n',\n    resolve_keep_both,\n    content,\n    flags=re.DOTALL\n)\n\nwith open('docs/review_notes.md', 'w') as f:\n    f.write(resolved)\n\nprint('Resolved successfully')\nprint(f'Conflict markers remaining: {resolved.count(\\\"<<<<<<<\\\")}')\n\"\n", "description": "Resolve merge conflict keeping both review sections"}, "tool_response": {"stdout": "Resolved successfully\nConflict markers remaining: 0", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_01XdHo3LBhgwrqM4C7nvu3si", "_ts": "2026-02-20T19:02:20+0900"}
{"session_id": "ea23599c-057d-4544-ac7d-1239e762eed0", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/ea23599c-057d-4544-ac7d-1239e762eed0.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "git add docs/review_notes.md && git rebase --continue 2>&1", "description": "Stage resolved file and continue rebase"}, "tool_use_id": "toolu_01HSAE8XkxnPc2p2JWtJLVmB", "_ts": "2026-02-20T19:02:24+0900"}
{"session_id": "ea23599c-057d-4544-ac7d-1239e762eed0", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/ea23599c-057d-4544-ac7d-1239e762eed0.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher", "permission_mode": "default", "hook_event_name": "PostToolUseFailure", "tool_name": "Bash", "tool_input": {"command": "git add docs/review_notes.md && git rebase --continue 2>&1", "description": "Stage resolved file and continue rebase"}, "tool_use_id": "toolu_01HSAE8XkxnPc2p2JWtJLVmB", "error": "Exit code 1\n모든 병합 충돌을 편집하고 git add\n명령으로 해결되었다고 표시해야 합니다", "is_interrupt": false, "_ts": "2026-02-20T19:02:24+0900"}
{"session_id": "ea23599c-057d-4544-ac7d-1239e762eed0", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/ea23599c-057d-4544-ac7d-1239e762eed0.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "git add docs/review_notes.md && git rebase --continue 2>&1", "description": "Stage and continue rebase in worktree"}, "tool_use_id": "toolu_012iUPpAoDgY1LUsnFpHNdzx", "_ts": "2026-02-20T19:02:29+0900"}
{"session_id": "ea23599c-057d-4544-ac7d-1239e762eed0", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/ea23599c-057d-4544-ac7d-1239e762eed0.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher", "permission_mode": "default", "hook_event_name": "PostToolUseFailure", "tool_name": "Bash", "tool_input": {"command": "git add docs/review_notes.md && git rebase --continue 2>&1", "description": "Stage and continue rebase in worktree"}, "tool_use_id": "toolu_012iUPpAoDgY1LUsnFpHNdzx", "error": "Exit code 1\n모든 병합 충돌을 편집하고 git add\n명령으로 해결되었다고 표시해야 합니다", "is_interrupt": false, "_ts": "2026-02-20T19:02:29+0900"}
{"session_id": "ea23599c-057d-4544-ac7d-1239e762eed0", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/ea23599c-057d-4544-ac7d-1239e762eed0.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "pwd"}, "tool_use_id": "toolu_01VzQeP9KfWZbHX8fVWGS8P5", "_ts": "2026-02-20T19:02:31+0900"}
{"session_id": "ea23599c-057d-4544-ac7d-1239e762eed0", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/ea23599c-057d-4544-ac7d-1239e762eed0.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "pwd"}, "tool_response": {"stdout": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_01VzQeP9KfWZbHX8fVWGS8P5", "_ts": "2026-02-20T19:02:31+0900"}
{"session_id": "ea23599c-057d-4544-ac7d-1239e762eed0", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/ea23599c-057d-4544-ac7d-1239e762eed0.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "git status"}, "tool_use_id": "toolu_016kK6EcAWDXSTHev1bQ9E3j", "_ts": "2026-02-20T19:02:34+0900"}
{"session_id": "ea23599c-057d-4544-ac7d-1239e762eed0", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/ea23599c-057d-4544-ac7d-1239e762eed0.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "git status"}, "tool_response": {"stdout": "대화형 리베이스 진행 중. 갈 위치는 cc45051\nLast commands done (2 commands done):\n   pick 8ba931e feat(dispatcher): add command dispatcher and routing\n   pick c795009 docs(review): add review notes and fix test assertion for Issue #16\n명령이 남아있지 않음.\n현재 'feature/016-dispatcher' 브랜치를 'cc45051' 위로 리베이스하는 중입니다.\n  (모든 충돌을 바로잡았습니다: \"git rebase --continue\"를 실행하십시오)\n\n커밋할 변경 사항:\n  (use \"git restore --staged <file>...\" to unstage)\n\t수정함:        docs/review_notes.md\n\t수정함:        tests/test_dispatcher.py\n\n커밋하도록 정하지 않은 변경 사항:\n  (무엇을 커밋할지 바꾸려면 \"git add <파일>...\"을 사용하십시오)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\t수정함:        .claude/run/agent-state.json\n\t수정함:        .claude/run/events.jsonl\n\n추적하지 않는 파일:\n  (커밋할 사항에 포함하려면 \"git add <파일>...\"을 사용하십시오)\n\tsrc/openclaw_todo/__pycache__/\n\ttests/__pycache__/", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_016kK6EcAWDXSTHev1bQ9E3j", "_ts": "2026-02-20T19:02:34+0900"}
{"session_id": "ea23599c-057d-4544-ac7d-1239e762eed0", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/ea23599c-057d-4544-ac7d-1239e762eed0.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "GIT_EDITOR=true git rebase --continue 2>&1", "description": "Continue rebase with no editor"}, "tool_use_id": "toolu_019VvA5em9uVsZtGk2Tfoto5", "_ts": "2026-02-20T19:02:37+0900"}
{"session_id": "ea23599c-057d-4544-ac7d-1239e762eed0", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/ea23599c-057d-4544-ac7d-1239e762eed0.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher", "permission_mode": "default", "hook_event_name": "PostToolUseFailure", "tool_name": "Bash", "tool_input": {"command": "GIT_EDITOR=true git rebase --continue 2>&1", "description": "Continue rebase with no editor"}, "tool_use_id": "toolu_019VvA5em9uVsZtGk2Tfoto5", "error": "Exit code 1\n모든 병합 충돌을 편집하고 git add\n명령으로 해결되었다고 표시해야 합니다", "is_interrupt": false, "_ts": "2026-02-20T19:02:39+0900"}
{"session_id": "ea23599c-057d-4544-ac7d-1239e762eed0", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/ea23599c-057d-4544-ac7d-1239e762eed0.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "git diff --check 2>&1; echo \"---\"; grep -n \"<<<<<<\" docs/review_notes.md 2>&1 || echo \"no markers\"", "description": "Check for remaining conflict markers"}, "tool_use_id": "toolu_01AHNdh6g7DFXLWqdN9VuWnR", "_ts": "2026-02-20T19:02:42+0900"}
{"session_id": "ea23599c-057d-4544-ac7d-1239e762eed0", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/ea23599c-057d-4544-ac7d-1239e762eed0.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "git diff --check 2>&1; echo \"---\"; grep -n \"<<<<<<\" docs/review_notes.md 2>&1 || echo \"no markers\"", "description": "Check for remaining conflict markers"}, "tool_response": {"stdout": "---\nno markers", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_01AHNdh6g7DFXLWqdN9VuWnR", "_ts": "2026-02-20T19:02:42+0900"}
{"session_id": "ea23599c-057d-4544-ac7d-1239e762eed0", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/ea23599c-057d-4544-ac7d-1239e762eed0.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "git add -A && git rebase --continue 2>&1", "description": "Add all and continue rebase"}, "tool_use_id": "toolu_01XrV4R1Qwjoyhq7vTbrrjMw", "_ts": "2026-02-20T19:02:45+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "cd /Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add && uv run pytest tests/test_cmd_add.py -v 2>&1", "description": "Run add command tests"}, "tool_response": {"stdout": "Using CPython 3.11.13\nCreating virtual environment at: .venv\n   Building openclaw-todo-plugin @ file:///Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add\n      Built openclaw-todo-plugin @ file:///Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add\nInstalled 8 packages in 7ms\n============================= test session starts ==============================\nplatform darwin -- Python 3.11.13, pytest-9.0.2, pluggy-1.6.0 -- /Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/.venv/bin/python\ncachedir: .pytest_cache\nrootdir: /Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add\nconfigfile: pyproject.toml\nplugins: cov-7.0.0\ncollecting ... collected 10 items\n\ntests/test_cmd_add.py::TestAddDefaultInbox::test_add_default_inbox PASSED [ 10%]\ntests/test_cmd_add.py::TestAddWithProjectSectionDue::test_add_with_project_section_due PASSED [ 20%]\ntests/test_cmd_add.py::TestAddPrivateRejectsOtherAssignee::test_add_private_rejects_other_assignee PASSED [ 30%]\ntests/test_cmd_add.py::TestAddPrivateRejectsOtherAssignee::test_add_private_allows_owner_assignee PASSED [ 40%]\ntests/test_cmd_add.py::TestAddAssigneeDefaultsToSender::test_add_assignee_defaults_to_sender PASSED [ 50%]\ntests/test_cmd_add.py::TestAddMultipleAssignees::test_add_multiple_assignees PASSED [ 60%]\ntests/test_cmd_add.py::TestAddEventLogging::test_event_logged PASSED     [ 70%]\ntests/test_cmd_add.py::TestAddEdgeCases::test_add_empty_title_returns_error PASSED [ 80%]\ntests/test_cmd_add.py::TestAddEdgeCases::test_add_nonexistent_project_returns_error PASSED [ 90%]\ntests/test_cmd_add.py::TestAddEdgeCases::test_add_due_clear_sentinel_stored_as_null PASSED [100%]\n\n============================== 10 passed in 0.06s ==============================", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_01D3z9WftTH7fnLqhCwoviDu", "_ts": "2026-02-20T19:20:37+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "uv run pytest -q 2>&1", "description": "Run full test suite"}, "tool_use_id": "toolu_01VhnxumQ4T8oz83PvrxbMoo", "_ts": "2026-02-20T19:20:40+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUseFailure", "tool_name": "Bash", "tool_input": {"command": "uv run pytest -q 2>&1", "description": "Run full test suite"}, "tool_use_id": "toolu_01VhnxumQ4T8oz83PvrxbMoo", "error": "Exit code 1\n..............F.................................................         [100%]\n=================================== FAILURES ===================================\n___________ TestRoutesKnownCommands.test_routes_known_commands[add] ____________\n\nself = <tests.test_dispatcher.TestRoutesKnownCommands object at 0x109462650>\ncommand = 'add'\ndb_path = '/private/var/folders/hz/llvzvhk52k9f1g0vgdrnkmww0000gn/T/pytest-of-pillip/pytest-60/test_routes_known_commands_add0/test.sqlite3'\n\n    @pytest.mark.parametrize(\n        \"command\",\n        [\"add\", \"list\", \"board\", \"move\", \"done\", \"drop\", \"edit\"],\n    )\n    def test_routes_known_commands(self, command, db_path):\n        \"\"\"Each known command reaches its handler (stub by default).\"\"\"\n        # For move/done/drop/edit, provide an id-like arg\n        if command in (\"move\", \"done\", \"drop\", \"edit\"):\n            text = f\"{command} 1\"\n        else:\n            text = f\"{command} something\"\n    \n        result = dispatch(text, {\"sender_id\": \"U1\"}, db_path=db_path)\n        # Stub handlers return \"not yet implemented\"\n>       assert \"not yet implemented\" in result.lower()\nE       AssertionError: assert 'not yet implemented' in 'added #1 (inbox/backlog) due:- assignees:<@u1> -- something'\nE        +  where 'added #1 (inbox/backlog) due:- assignees:<@u1> -- something' = <built-in method lower of str object at 0x1094262c0>()\nE        +    where <built-in method lower of str object at 0x1094262c0> = 'Added #1 (Inbox/backlog) due:- assignees:<@U1> -- something'.lower\n\ntests/test_dispatcher.py:48: AssertionError\n=========================== short test summary info ============================\nFAILED tests/test_dispatcher.py::TestRoutesKnownCommands::test_routes_known_commands[add]\n1 failed, 63 passed in 0.22s", "is_interrupt": false, "_ts": "2026-02-20T19:20:42+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/tests/test_dispatcher.py", "offset": 31, "limit": 20}, "tool_use_id": "toolu_01T1mMijtvNxCXsJdCr53WJK", "_ts": "2026-02-20T19:20:46+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/tests/test_dispatcher.py", "offset": 31, "limit": 20}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/tests/test_dispatcher.py", "content": "class TestRoutesKnownCommands:\n    \"\"\"Verify that all valid command names are routed to their handler.\"\"\"\n\n    @pytest.mark.parametrize(\n        \"command\",\n        [\"add\", \"list\", \"board\", \"move\", \"done\", \"drop\", \"edit\"],\n    )\n    def test_routes_known_commands(self, command, db_path):\n        \"\"\"Each known command reaches its handler (stub by default).\"\"\"\n        # For move/done/drop/edit, provide an id-like arg\n        if command in (\"move\", \"done\", \"drop\", \"edit\"):\n            text = f\"{command} 1\"\n        else:\n            text = f\"{command} something\"\n\n        result = dispatch(text, {\"sender_id\": \"U1\"}, db_path=db_path)\n        # Stub handlers return \"not yet implemented\"\n        assert \"not yet implemented\" in result.lower()\n\n    def test_registered_handler_called(self, db_path):", "numLines": 20, "startLine": 31, "totalLines": 153}}, "tool_use_id": "toolu_01T1mMijtvNxCXsJdCr53WJK", "_ts": "2026-02-20T19:20:46+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/tests/test_dispatcher.py", "old_string": "    @pytest.mark.parametrize(\n        \"command\",\n        [\"add\", \"list\", \"board\", \"move\", \"done\", \"drop\", \"edit\"],\n    )\n    def test_routes_known_commands(self, command, db_path):\n        \"\"\"Each known command reaches its handler (stub by default).\"\"\"\n        # For move/done/drop/edit, provide an id-like arg\n        if command in (\"move\", \"done\", \"drop\", \"edit\"):\n            text = f\"{command} 1\"\n        else:\n            text = f\"{command} something\"\n\n        result = dispatch(text, {\"sender_id\": \"U1\"}, db_path=db_path)\n        # Stub handlers return \"not yet implemented\"\n        assert \"not yet implemented\" in result.lower()", "new_string": "    @pytest.mark.parametrize(\n        \"command\",\n        [\"list\", \"board\", \"move\", \"done\", \"drop\", \"edit\"],\n    )\n    def test_routes_known_commands(self, command, db_path):\n        \"\"\"Each known command reaches its handler (stub by default).\"\"\"\n        # For move/done/drop/edit, provide an id-like arg\n        if command in (\"move\", \"done\", \"drop\", \"edit\"):\n            text = f\"{command} 1\"\n        else:\n            text = f\"{command} something\"\n\n        result = dispatch(text, {\"sender_id\": \"U1\"}, db_path=db_path)\n        # Stub handlers return \"not yet implemented\"\n        assert \"not yet implemented\" in result.lower()\n\n    def test_add_routes_to_handler(self, db_path):\n        \"\"\"The add command routes to the real add handler.\"\"\"\n        result = dispatch(\"add something\", {\"sender_id\": \"U1\"}, db_path=db_path)\n        assert \"Added #\" in result", "replace_all": false}, "tool_use_id": "toolu_01UNqkeC2QM2MiFht1X6QHdP", "_ts": "2026-02-20T19:20:53+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/tests/test_dispatcher.py", "old_string": "    @pytest.mark.parametrize(\n        \"command\",\n        [\"add\", \"list\", \"board\", \"move\", \"done\", \"drop\", \"edit\"],\n    )\n    def test_routes_known_commands(self, command, db_path):\n        \"\"\"Each known command reaches its handler (stub by default).\"\"\"\n        # For move/done/drop/edit, provide an id-like arg\n        if command in (\"move\", \"done\", \"drop\", \"edit\"):\n            text = f\"{command} 1\"\n        else:\n            text = f\"{command} something\"\n\n        result = dispatch(text, {\"sender_id\": \"U1\"}, db_path=db_path)\n        # Stub handlers return \"not yet implemented\"\n        assert \"not yet implemented\" in result.lower()", "new_string": "    @pytest.mark.parametrize(\n        \"command\",\n        [\"list\", \"board\", \"move\", \"done\", \"drop\", \"edit\"],\n    )\n    def test_routes_known_commands(self, command, db_path):\n        \"\"\"Each known command reaches its handler (stub by default).\"\"\"\n        # For move/done/drop/edit, provide an id-like arg\n        if command in (\"move\", \"done\", \"drop\", \"edit\"):\n            text = f\"{command} 1\"\n        else:\n            text = f\"{command} something\"\n\n        result = dispatch(text, {\"sender_id\": \"U1\"}, db_path=db_path)\n        # Stub handlers return \"not yet implemented\"\n        assert \"not yet implemented\" in result.lower()\n\n    def test_add_routes_to_handler(self, db_path):\n        \"\"\"The add command routes to the real add handler.\"\"\"\n        result = dispatch(\"add something\", {\"sender_id\": \"U1\"}, db_path=db_path)\n        assert \"Added #\" in result", "replace_all": false}, "tool_response": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/tests/test_dispatcher.py", "oldString": "    @pytest.mark.parametrize(\n        \"command\",\n        [\"add\", \"list\", \"board\", \"move\", \"done\", \"drop\", \"edit\"],\n    )\n    def test_routes_known_commands(self, command, db_path):\n        \"\"\"Each known command reaches its handler (stub by default).\"\"\"\n        # For move/done/drop/edit, provide an id-like arg\n        if command in (\"move\", \"done\", \"drop\", \"edit\"):\n            text = f\"{command} 1\"\n        else:\n            text = f\"{command} something\"\n\n        result = dispatch(text, {\"sender_id\": \"U1\"}, db_path=db_path)\n        # Stub handlers return \"not yet implemented\"\n        assert \"not yet implemented\" in result.lower()", "newString": "    @pytest.mark.parametrize(\n        \"command\",\n        [\"list\", \"board\", \"move\", \"done\", \"drop\", \"edit\"],\n    )\n    def test_routes_known_commands(self, command, db_path):\n        \"\"\"Each known command reaches its handler (stub by default).\"\"\"\n        # For move/done/drop/edit, provide an id-like arg\n        if command in (\"move\", \"done\", \"drop\", \"edit\"):\n            text = f\"{command} 1\"\n        else:\n            text = f\"{command} something\"\n\n        result = dispatch(text, {\"sender_id\": \"U1\"}, db_path=db_path)\n        # Stub handlers return \"not yet implemented\"\n        assert \"not yet implemented\" in result.lower()\n\n    def test_add_routes_to_handler(self, db_path):\n        \"\"\"The add command routes to the real add handler.\"\"\"\n        result = dispatch(\"add something\", {\"sender_id\": \"U1\"}, db_path=db_path)\n        assert \"Added #\" in result", "originalFile": "\"\"\"Tests for the command dispatcher and routing.\"\"\"\n\nfrom __future__ import annotations\n\nimport sqlite3\n\nimport pytest\n\nfrom openclaw_todo.dispatcher import (\n    _handlers,\n    dispatch,\n    register_handler,\n)\n\n\n@pytest.fixture()\ndef db_path(tmp_path):\n    \"\"\"Provide a temporary DB path for each test.\"\"\"\n    return str(tmp_path / \"test.sqlite3\")\n\n\n@pytest.fixture(autouse=True)\ndef _clean_handlers():\n    \"\"\"Ensure handler registry is clean between tests.\"\"\"\n    saved = dict(_handlers)\n    yield\n    _handlers.clear()\n    _handlers.update(saved)\n\n\nclass TestRoutesKnownCommands:\n    \"\"\"Verify that all valid command names are routed to their handler.\"\"\"\n\n    @pytest.mark.parametrize(\n        \"command\",\n        [\"add\", \"list\", \"board\", \"move\", \"done\", \"drop\", \"edit\"],\n    )\n    def test_routes_known_commands(self, command, db_path):\n        \"\"\"Each known command reaches its handler (stub by default).\"\"\"\n        # For move/done/drop/edit, provide an id-like arg\n        if command in (\"move\", \"done\", \"drop\", \"edit\"):\n            text = f\"{command} 1\"\n        else:\n            text = f\"{command} something\"\n\n        result = dispatch(text, {\"sender_id\": \"U1\"}, db_path=db_path)\n        # Stub handlers return \"not yet implemented\"\n        assert \"not yet implemented\" in result.lower()\n\n    def test_registered_handler_called(self, db_path):\n        \"\"\"A registered handler is called instead of the stub.\"\"\"\n        called_with = {}\n\n        def fake_add(parsed, conn, ctx):\n            called_with[\"parsed\"] = parsed\n            called_with[\"ctx\"] = ctx\n            return \"added!\"\n\n        register_handler(\"add\", fake_add)\n\n        result = dispatch(\"add buy milk\", {\"sender_id\": \"U1\"}, db_path=db_path)\n        assert result == \"added!\"\n        assert called_with[\"parsed\"].command == \"add\"\n        assert \"buy\" in called_with[\"parsed\"].title_tokens\n\n\nclass TestProjectSubRouting:\n    \"\"\"Verify /todo project subcommand routing.\"\"\"\n\n    def test_project_list_routes(self, db_path):\n        \"\"\"``/todo project list`` routes to the project_list handler.\"\"\"\n        called = {\"hit\": False}\n\n        def fake_project_list(parsed, conn, ctx):\n            called[\"hit\"] = True\n            return \"project list!\"\n\n        register_handler(\"project_list\", fake_project_list)\n\n        result = dispatch(\"project list\", {\"sender_id\": \"U1\"}, db_path=db_path)\n        assert called[\"hit\"]\n        assert result == \"project list!\"\n\n    def test_project_set_private_routes(self, db_path):\n        \"\"\"``/todo project set-private`` routes correctly.\"\"\"\n        called = {\"hit\": False}\n\n        def fake_handler(parsed, conn, ctx):\n            called[\"hit\"] = True\n            return \"set private!\"\n\n        register_handler(\"project_set_private\", fake_handler)\n\n        result = dispatch(\"project set-private MyProj\", {\"sender_id\": \"U1\"}, db_path=db_path)\n        assert called[\"hit\"]\n        assert result == \"set private!\"\n\n    def test_project_set_shared_routes(self, db_path):\n        \"\"\"``/todo project set-shared`` routes correctly.\"\"\"\n        called = {\"hit\": False}\n\n        def fake_handler(parsed, conn, ctx):\n            called[\"hit\"] = True\n            return \"set shared!\"\n\n        register_handler(\"project_set_shared\", fake_handler)\n\n        result = dispatch(\"project set-shared MyProj\", {\"sender_id\": \"U1\"}, db_path=db_path)\n        assert called[\"hit\"]\n        assert result == \"set shared!\"\n\n    def test_project_no_subcommand(self, db_path):\n        \"\"\"``/todo project`` without subcommand returns usage.\"\"\"\n        result = dispatch(\"project\", {\"sender_id\": \"U1\"}, db_path=db_path)\n        assert \"Subcommands\" in result\n\n    def test_project_unknown_subcommand(self, db_path):\n        \"\"\"Unknown project subcommand returns error + usage.\"\"\"\n        result = dispatch(\"project foobar\", {\"sender_id\": \"U1\"}, db_path=db_path)\n        assert \"Unknown project subcommand\" in result\n        assert \"foobar\" in result\n\n\nclass TestUnknownCommandHelp:\n    \"\"\"Unknown commands return a helpful error message.\"\"\"\n\n    def test_unknown_command_help(self, db_path):\n        result = dispatch(\"foobar something\", {\"sender_id\": \"U1\"}, db_path=db_path)\n        assert \"Unknown command\" in result\n        assert \"foobar\" in result\n        assert \"Commands:\" in result\n\n    def test_parse_error_returned(self, db_path):\n        \"\"\"Parser errors are returned as user-facing messages.\"\"\"\n        # /s with invalid section should trigger ParseError\n        result = dispatch(\"add /s invalid_section title\", {\"sender_id\": \"U1\"}, db_path=db_path)\n        assert \"Parse error\" in result\n\n\nclass TestDbInitialization:\n    \"\"\"Verify DB is initialized before command execution.\"\"\"\n\n    def test_db_initialized_with_schema(self, db_path):\n        \"\"\"Dispatching a command initializes the DB with migrations.\"\"\"\n        dispatch(\"add something\", {\"sender_id\": \"U1\"}, db_path=db_path)\n\n        # Verify DB has schema_version table\n        conn = sqlite3.connect(db_path)\n        row = conn.execute(\"SELECT version FROM schema_version\").fetchone()\n        conn.close()\n        assert row is not None\n        assert row[0] >= 1\n", "structuredPatch": [{"oldStart": 33, "oldLines": 7, "newStart": 33, "newLines": 7, "lines": [" ", "     @pytest.mark.parametrize(", "         \"command\",", "-        [\"add\", \"list\", \"board\", \"move\", \"done\", \"drop\", \"edit\"],", "+        [\"list\", \"board\", \"move\", \"done\", \"drop\", \"edit\"],", "     )", "     def test_routes_known_commands(self, command, db_path):", "         \"\"\"Each known command reaches its handler (stub by default).\"\"\""]}, {"oldStart": 47, "oldLines": 6, "newStart": 47, "newLines": 11, "lines": ["         # Stub handlers return \"not yet implemented\"", "         assert \"not yet implemented\" in result.lower()", " ", "+    def test_add_routes_to_handler(self, db_path):", "+        \"\"\"The add command routes to the real add handler.\"\"\"", "+        result = dispatch(\"add something\", {\"sender_id\": \"U1\"}, db_path=db_path)", "+        assert \"Added #\" in result", "+", "     def test_registered_handler_called(self, db_path):", "         \"\"\"A registered handler is called instead of the stub.\"\"\"", "         called_with = {}"]}], "userModified": false, "replaceAll": false}, "tool_use_id": "toolu_01UNqkeC2QM2MiFht1X6QHdP", "_ts": "2026-02-20T19:20:53+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "uv run pytest -q 2>&1", "description": "Run full test suite"}, "tool_use_id": "toolu_01Sapxog4miQ3PdZi2hp62Hh", "_ts": "2026-02-20T19:20:56+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "uv run pytest -q 2>&1", "description": "Run full test suite"}, "tool_response": {"stdout": "................................................................         [100%]\n64 passed in 0.18s", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_01Sapxog4miQ3PdZi2hp62Hh", "_ts": "2026-02-20T19:20:56+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "git status", "description": "Check git status in worktree"}, "tool_use_id": "toolu_01QE32HC8ySuB3KbL8okD38y", "_ts": "2026-02-20T19:21:01+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "git status", "description": "Check git status in worktree"}, "tool_response": {"stdout": "현재 브랜치 feature/006-cmd-add\n커밋하도록 정하지 않은 변경 사항:\n  (무엇을 커밋할지 바꾸려면 \"git add <파일>...\"을 사용하십시오)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\t수정함:        .claude/run/agent-state.json\n\t수정함:        .claude/run/events.jsonl\n\t수정함:        src/openclaw_todo/__pycache__/__init__.cpython-311.pyc\n\t수정함:        src/openclaw_todo/__pycache__/db.cpython-311.pyc\n\t수정함:        src/openclaw_todo/__pycache__/dispatcher.cpython-311.pyc\n\t수정함:        src/openclaw_todo/__pycache__/migrations.cpython-311.pyc\n\t수정함:        src/openclaw_todo/__pycache__/parser.cpython-311.pyc\n\t수정함:        src/openclaw_todo/__pycache__/plugin.cpython-311.pyc\n\t수정함:        src/openclaw_todo/__pycache__/schema_v1.cpython-311.pyc\n\t수정함:        src/openclaw_todo/dispatcher.py\n\t수정함:        tests/__pycache__/__init__.cpython-311.pyc\n\t수정함:        tests/__pycache__/test_db.cpython-311-pytest-9.0.2.pyc\n\t수정함:        tests/__pycache__/test_dispatcher.cpython-311-pytest-9.0.2.pyc\n\t수정함:        tests/__pycache__/test_migrations.cpython-311-pytest-9.0.2.pyc\n\t수정함:        tests/__pycache__/test_parser.cpython-311-pytest-9.0.2.pyc\n\t수정함:        tests/__pycache__/test_plugin.cpython-311-pytest-9.0.2.pyc\n\t수정함:        tests/__pycache__/test_schema_v1.cpython-311-pytest-9.0.2.pyc\n\t수정함:        tests/test_dispatcher.py\n\n추적하지 않는 파일:\n  (커밋할 사항에 포함하려면 \"git add <파일>...\"을 사용하십시오)\n\tsrc/openclaw_todo/__pycache__/cmd_add.cpython-311.pyc\n\tsrc/openclaw_todo/__pycache__/project_resolver.cpython-311.pyc\n\tsrc/openclaw_todo/cmd_add.py\n\ttests/__pycache__/test_cmd_add.cpython-311-pytest-9.0.2.pyc\n\ttests/__pycache__/test_project_resolver.cpython-311-pytest-9.0.2.pyc\n\ttests/test_cmd_add.py\n\n커밋할 변경 사항을 추가하지 않았습니다 (\"git add\" 및/또는 \"git commit -a\"를\n사용하십시오)", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_01QE32HC8ySuB3KbL8okD38y", "_ts": "2026-02-20T19:21:01+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "git add src/openclaw_todo/cmd_add.py src/openclaw_todo/dispatcher.py tests/test_cmd_add.py tests/test_dispatcher.py && git commit -m \"$(cat <<'EOF'\nfeat(cmd): add /todo add command handler\n\nImplement the add subcommand that creates tasks with project resolution,\nassignee defaults, private-project validation, and event logging.\n\n- Add cmd_add.py with add_handler function\n- Register handler in dispatcher\n- Default project=Inbox, section=backlog, assignees=sender\n- Validate private project assignee constraint (PRD 3.3)\n- Log task.add event with payload\n- Response format: Added #<id> (<project>/<section>) due:<due|-> assignees:<mentions> -- <title>\n- 10 new tests covering all acceptance criteria\n\nCloses #17\n\nCo-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>\nEOF\n)\"", "description": "Commit changes"}, "tool_use_id": "toolu_01C3QxFjZNhWrhw7ieFZ2ewu", "_ts": "2026-02-20T19:21:09+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "git add src/openclaw_todo/cmd_add.py src/openclaw_todo/dispatcher.py tests/test_cmd_add.py tests/test_dispatcher.py && git commit -m \"$(cat <<'EOF'\nfeat(cmd): add /todo add command handler\n\nImplement the add subcommand that creates tasks with project resolution,\nassignee defaults, private-project validation, and event logging.\n\n- Add cmd_add.py with add_handler function\n- Register handler in dispatcher\n- Default project=Inbox, section=backlog, assignees=sender\n- Validate private project assignee constraint (PRD 3.3)\n- Log task.add event with payload\n- Response format: Added #<id> (<project>/<section>) due:<due|-> assignees:<mentions> -- <title>\n- 10 new tests covering all acceptance criteria\n\nCloses #17\n\nCo-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>\nEOF\n)\"", "description": "Commit changes"}, "tool_response": {"stdout": "[feature/006-cmd-add 5c48855] feat(cmd): add /todo add command handler\n 4 files changed, 357 insertions(+), 3 deletions(-)\n create mode 100644 src/openclaw_todo/cmd_add.py\n create mode 100644 tests/test_cmd_add.py", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_01C3QxFjZNhWrhw7ieFZ2ewu", "_ts": "2026-02-20T19:21:10+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "git push -u origin feature/006-cmd-add 2>&1", "description": "Push feature branch to remote"}, "tool_use_id": "toolu_016K2J15Pbydfc4ZeB67zrQZ", "_ts": "2026-02-20T19:21:14+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "git push -u origin feature/006-cmd-add 2>&1", "description": "Push feature branch to remote"}, "tool_response": {"stdout": "remote: \nremote: Create a pull request for 'feature/006-cmd-add' on GitHub by visiting:        \nremote:      https://github.com/pillip/openclaw_todo_plugin/pull/new/feature/006-cmd-add        \nremote: \nTo https://github.com/pillip/openclaw_todo_plugin.git\n * [new branch]      feature/006-cmd-add -> feature/006-cmd-add\nbranch 'feature/006-cmd-add' set up to track 'origin/feature/006-cmd-add'.", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_016K2J15Pbydfc4ZeB67zrQZ", "_ts": "2026-02-20T19:21:17+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "gh pr create --title \"[Issue#6] /todo add command\" --body \"$(cat <<'EOF'\nCloses #17\n\n## Summary\n- Implement the `/todo add` command handler (`cmd_add.py`) that creates tasks with project resolution, assignee defaults, private-project validation, and event logging\n- Register the `add` handler in the dispatcher, replacing the stub\n- Add 10 comprehensive tests covering all acceptance criteria\n\n## Changes\n- **`src/openclaw_todo/cmd_add.py`** — New handler with:\n  - Project resolution via `resolve_project()` (default: Inbox)\n  - Section default: `backlog`\n  - Assignee default: sender when no mentions\n  - Private project assignee constraint validation (PRD 3.3)\n  - Task + task_assignees insertion\n  - Event logging with JSON payload\n  - Formatted response: `Added #<id> (<project>/<section>) due:<due|-> assignees:<mentions> -- <title>`\n- **`src/openclaw_todo/dispatcher.py`** — Register `add_handler` in the handler registry\n- **`tests/test_cmd_add.py`** — 10 tests covering default inbox, explicit options, private project rejection, assignee defaults, multiple assignees, event logging, edge cases\n- **`tests/test_dispatcher.py`** — Update parametrized test to exclude `add` from stub check; add dedicated `add` routing test\n\n## Test plan\n- [x] `uv run pytest tests/test_cmd_add.py -v` — 10/10 pass\n- [x] `uv run pytest -q` — 64/64 pass (full suite)\n\n🤖 Generated with [Claude Code](https://claude.com/claude-code)\nEOF\n)\" 2>&1", "description": "Create pull request"}, "tool_use_id": "toolu_01NZn5BMgft4kEp5BrHg8iDN", "_ts": "2026-02-20T19:21:29+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "gh pr create --title \"[Issue#6] /todo add command\" --body \"$(cat <<'EOF'\nCloses #17\n\n## Summary\n- Implement the `/todo add` command handler (`cmd_add.py`) that creates tasks with project resolution, assignee defaults, private-project validation, and event logging\n- Register the `add` handler in the dispatcher, replacing the stub\n- Add 10 comprehensive tests covering all acceptance criteria\n\n## Changes\n- **`src/openclaw_todo/cmd_add.py`** — New handler with:\n  - Project resolution via `resolve_project()` (default: Inbox)\n  - Section default: `backlog`\n  - Assignee default: sender when no mentions\n  - Private project assignee constraint validation (PRD 3.3)\n  - Task + task_assignees insertion\n  - Event logging with JSON payload\n  - Formatted response: `Added #<id> (<project>/<section>) due:<due|-> assignees:<mentions> -- <title>`\n- **`src/openclaw_todo/dispatcher.py`** — Register `add_handler` in the handler registry\n- **`tests/test_cmd_add.py`** — 10 tests covering default inbox, explicit options, private project rejection, assignee defaults, multiple assignees, event logging, edge cases\n- **`tests/test_dispatcher.py`** — Update parametrized test to exclude `add` from stub check; add dedicated `add` routing test\n\n## Test plan\n- [x] `uv run pytest tests/test_cmd_add.py -v` — 10/10 pass\n- [x] `uv run pytest -q` — 64/64 pass (full suite)\n\n🤖 Generated with [Claude Code](https://claude.com/claude-code)\nEOF\n)\" 2>&1", "description": "Create pull request"}, "tool_response": {"stdout": "Warning: 20 uncommitted changes\nhttps://github.com/pillip/openclaw_todo_plugin/pull/18", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_01NZn5BMgft4kEp5BrHg8iDN", "_ts": "2026-02-20T19:21:33+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md", "offset": 220, "limit": 15}, "tool_use_id": "toolu_01Daw6Wj28gbcbBoFvuK3rjF", "_ts": "2026-02-20T19:21:38+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md", "offset": 220, "limit": 15}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md", "content": "## Issue #6: /todo add command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | doing                                  |\n| Priority    | P0                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/006-cmd-add`                  |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/17 |\n| PR          | --                                     |\n\n**Description**\nImplement the `add` subcommand handler. Resolves project (default `Inbox`), applies defaults (section=`backlog`, assignees=sender if none mentioned), validates private-project assignee constraint (PRD 3.3), inserts task + task_assignees rows, logs event, and returns formatted confirmation.", "numLines": 15, "startLine": 220, "totalLines": 863}}, "tool_use_id": "toolu_01Daw6Wj28gbcbBoFvuK3rjF", "_ts": "2026-02-20T19:21:38+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md", "old_string": "| Status      | doing                                  |\n| Priority    | P0                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/006-cmd-add`                  |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/17 |\n| PR          | --                                     |", "new_string": "| Status      | done                                   |\n| Priority    | P0                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/006-cmd-add`                  |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/17 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/18 |", "replace_all": false}, "tool_use_id": "toolu_01Gprq8SP6z21L3AoM7LMSLD", "_ts": "2026-02-20T19:21:42+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md", "old_string": "| Status      | doing                                  |\n| Priority    | P0                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/006-cmd-add`                  |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/17 |\n| PR          | --                                     |", "new_string": "| Status      | done                                   |\n| Priority    | P0                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/006-cmd-add`                  |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/17 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/18 |", "replace_all": false}, "tool_response": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md", "oldString": "| Status      | doing                                  |\n| Priority    | P0                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/006-cmd-add`                  |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/17 |\n| PR          | --                                     |", "newString": "| Status      | done                                   |\n| Priority    | P0                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/006-cmd-add`                  |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/17 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/18 |", "originalFile": "# OpenClaw TODO Plugin -- Issues\n\n> Auto-generated from `openclaw_todo_plugin_prd.md` (PRD v1.1)\n> Date: 2026-02-20\n\n---\n\n## Issue #1: Plugin skeleton and entry point\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M0                                     |\n| Status      | done                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/001-plugin-skeleton`          |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/1 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/2 |\n\n**Description**\nCreate the Python project scaffold: `pyproject.toml` (uv), `src/openclaw_todo/` package layout, and the plugin entry-point that the OpenClaw gateway will load. The plugin must expose a callable that receives raw Slack DM text and a sender context dict.\n\n**Acceptance Criteria**\n- [ ] `pyproject.toml` exists with Python >=3.11, pytest, pytest-cov dev deps\n- [ ] `src/openclaw_todo/__init__.py` exposes `__version__`\n- [ ] `src/openclaw_todo/plugin.py` contains `handle_message(text: str, context: dict) -> str` entry point\n- [ ] Messages not starting with `/todo` are silently ignored (returns `None`)\n- [ ] `uv sync && uv run pytest -q` passes (trivial smoke test)\n\n**Tests**\n- `tests/test_plugin.py::test_ignores_non_todo_message`\n- `tests/test_plugin.py::test_dispatches_todo_prefix`\n\n**Rollback**\nDelete branch; no runtime dependency.\n\n**Observability**\n`logger.debug` on every inbound message; `logger.info` when `/todo` prefix matched.\n\n**Dependencies**\nNone.\n\n---\n\n## Issue #2: DB module -- connection helper and pragma setup\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend / Data                         |\n| Milestone   | M1                                     |\n| Status      | done                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/002-db-connection`            |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/3 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/4 |\n\n**Description**\nImplement `src/openclaw_todo/db.py` with a `get_connection(db_path)` helper that creates the `~/.openclaw/workspace/.todo/` directory tree if missing, opens (or creates) `todo.sqlite3`, and applies `PRAGMA journal_mode=WAL` and `PRAGMA busy_timeout=3000`.\n\n**Acceptance Criteria**\n- [ ] Directory is created recursively when absent\n- [ ] SQLite connection returned with WAL mode enabled\n- [ ] `busy_timeout` is 3000\n- [ ] Calling `get_connection` twice returns usable connections (no lock conflict)\n\n**Tests**\n- `tests/test_db.py::test_creates_directory_and_file` (tmp_path)\n- `tests/test_db.py::test_wal_mode_enabled`\n- `tests/test_db.py::test_busy_timeout`\n\n**Rollback**\nRevert module; no schema changes yet.\n\n**Observability**\n`logger.info` on first DB creation; `logger.debug` on each connection open.\n\n**Dependencies**\n#1\n\n---\n\n## Issue #3: Schema migration framework and schema_version table\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend / Data                         |\n| Milestone   | M1                                     |\n| Status      | done                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/003-schema-migration`         |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/5 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/6 |\n\n**Description**\nImplement a simple sequential migration runner. On startup, read `schema_version` (create if missing), compare to available migrations list, and apply outstanding migrations in order inside a transaction.\n\n**Acceptance Criteria**\n- [ ] `schema_version` table created with single row `version=0` if absent\n- [ ] Migrations are Python callables registered in an ordered list\n- [ ] Each migration runs inside a transaction; version incremented on success\n- [ ] Re-running on an up-to-date DB is a no-op\n- [ ] Failing migration rolls back and raises with clear message\n\n**Tests**\n- `tests/test_migrations.py::test_fresh_db_gets_version_table`\n- `tests/test_migrations.py::test_applies_migrations_sequentially`\n- `tests/test_migrations.py::test_idempotent_on_rerun`\n- `tests/test_migrations.py::test_rollback_on_failure`\n\n**Rollback**\nDrop `schema_version` table; revert module.\n\n**Observability**\n`logger.info(\"Migrating from version %d to %d\", current, target)` per step.\n\n**Dependencies**\n#2\n\n---\n\n## Issue #4: V1 schema migration -- projects, tasks, task_assignees, events\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend / Data                         |\n| Milestone   | M1                                     |\n| Status      | done                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/004-v1-schema`                |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/7 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/8 |\n\n**Description**\nRegister migration v1 that creates the four tables (`projects`, `tasks`, `task_assignees`, `events`) with all columns, CHECK constraints, and partial unique indexes as specified in PRD section 6.3. Also seed shared project `Inbox`.\n\n**Acceptance Criteria**\n- [ ] `projects` table with `ux_projects_shared_name` and `ux_projects_private_owner_name` partial unique indexes\n- [ ] `tasks` table with section and status CHECK constraints\n- [ ] `task_assignees` table with composite PK and secondary index\n- [ ] `events` audit table created\n- [ ] Shared `Inbox` project auto-created (INSERT OR IGNORE)\n- [ ] `schema_version` = 1 after migration\n\n**Tests**\n- `tests/test_migrations.py::test_v1_tables_exist`\n- `tests/test_migrations.py::test_v1_inbox_created`\n- `tests/test_migrations.py::test_v1_shared_unique_index_enforced`\n- `tests/test_migrations.py::test_v1_private_unique_index_enforced`\n\n**Rollback**\nDrop all four tables + reset schema_version to 0.\n\n**Observability**\nLog table creation counts.\n\n**Dependencies**\n#3\n\n---\n\n## Issue #5: Command parser -- tokenizer and option extraction\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M2                                     |\n| Status      | doing                                  |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/005-parser-tokenizer`         |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/9 |\n| PR          | --                                     |\n\n**Description**\nImplement `src/openclaw_todo/parser.py` that takes raw message text (after `/todo` prefix) and returns a `ParsedCommand` dataclass containing: `command` (str), `args` (list), `project` (str|None), `section` (str|None), `due` (str|None, normalised to YYYY-MM-DD), `mentions` (list of Slack user IDs), and remaining `title_tokens`.\n\nParsing rules:\n- `/p <name>` extracts project\n- `/s <section>` extracts section (validate against enum)\n- `due:YYYY-MM-DD` or `due:MM-DD` extracts and normalises due date\n- `due:-` clears due (sentinel)\n- `<@U...>` patterns extracted as mentions\n- Everything else before first option token is title\n\n**Acceptance Criteria**\n- [ ] `/p MyProject` correctly extracted; token consumed\n- [ ] `/s doing` validated; invalid section raises `ParseError`\n- [ ] `due:03-15` normalised to `2026-03-15`\n- [ ] `due:2026-02-30` raises `ParseError` (invalid date)\n- [ ] `<@U12345>` extracted into mentions list\n- [ ] Multiple mentions supported\n- [ ] Title tokens are non-option, non-mention tokens before first option\n\n**Tests**\n- `tests/test_parser.py::test_extract_project`\n- `tests/test_parser.py::test_extract_section_valid`\n- `tests/test_parser.py::test_extract_section_invalid`\n- `tests/test_parser.py::test_due_mm_dd_normalisation`\n- `tests/test_parser.py::test_due_full_date`\n- `tests/test_parser.py::test_due_invalid_date`\n- `tests/test_parser.py::test_due_clear`\n- `tests/test_parser.py::test_mentions_extraction`\n- `tests/test_parser.py::test_title_extraction`\n\n**Rollback**\nRevert module; no side effects.\n\n**Observability**\n`logger.debug(\"Parsed: %s\", parsed_command)`\n\n**Dependencies**\n#1\n\n---\n\n## Issue #6: /todo add command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | doing                                  |\n| Priority    | P0                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/006-cmd-add`                  |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/17 |\n| PR          | --                                     |\n\n**Description**\nImplement the `add` subcommand handler. Resolves project (default `Inbox`), applies defaults (section=`backlog`, assignees=sender if none mentioned), validates private-project assignee constraint (PRD 3.3), inserts task + task_assignees rows, logs event, and returns formatted confirmation.\n\n**Acceptance Criteria**\n- [ ] Task inserted with correct project_id, section, due, status='open', created_by\n- [ ] Assignees default to sender when no mentions\n- [ ] Multiple mentions create multiple task_assignee rows\n- [ ] Private project + non-owner assignee returns warning and does NOT insert\n- [ ] Non-existent project: `Inbox` auto-created as shared; others return error\n- [ ] Response format: `Added #<id> (<project>/<section>) due:<due|-> assignees:<mentions> -- <title>`\n- [ ] Event row written to `events` table\n\n**Tests**\n- `tests/test_cmd_add.py::test_add_default_inbox`\n- `tests/test_cmd_add.py::test_add_with_project_section_due`\n- `tests/test_cmd_add.py::test_add_private_rejects_other_assignee`\n- `tests/test_cmd_add.py::test_add_assignee_defaults_to_sender`\n- `tests/test_cmd_add.py::test_add_multiple_assignees`\n\n**Rollback**\nRevert handler; tasks table unchanged structurally.\n\n**Observability**\n`logger.info(\"Task #%d created in %s/%s by %s\", id, project, section, sender)`\n\n**Dependencies**\n#4, #5\n\n---\n\n## Issue #7: Project resolver helper\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/007-project-resolver`         |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `resolve_project(conn, name, sender_id) -> Project` following PRD 3.2 (Option A): sender's private project with that name takes priority, then shared, then error/auto-create for Inbox.\n\n**Acceptance Criteria**\n- [ ] Private project of sender matched first\n- [ ] Falls back to shared if no private match\n- [ ] Returns error when neither exists (except Inbox which is auto-created)\n- [ ] Returns project row with id, name, visibility, owner_user_id\n\n**Tests**\n- `tests/test_project_resolver.py::test_private_takes_priority`\n- `tests/test_project_resolver.py::test_falls_back_to_shared`\n- `tests/test_project_resolver.py::test_inbox_auto_created`\n- `tests/test_project_resolver.py::test_unknown_project_error`\n\n**Rollback**\nRevert module.\n\n**Observability**\n`logger.debug(\"Resolved project '%s' -> id=%d vis=%s\", name, id, visibility)`\n\n**Dependencies**\n#4\n\n---\n\n## Issue #8: /todo list command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/008-cmd-list`                 |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `list` subcommand. Supports scope (mine/all/<@USER>), project filter, section filter, status filter (open/done/drop), and limit. Sorting: due ASC (NULLs last), then id DESC. Excludes other users' private projects.\n\n**Acceptance Criteria**\n- [ ] Default scope=mine, status=open, limit=30\n- [ ] `mine` filters to tasks where sender is an assignee\n- [ ] `all` includes shared + sender's private (excludes others' private)\n- [ ] `/p` and `/s` filters applied correctly\n- [ ] Sorting: due NOT NULL first, due ASC, id DESC\n- [ ] limit:N respected\n- [ ] Output lists tasks in formatted lines\n\n**Tests**\n- `tests/test_cmd_list.py::test_list_mine_default`\n- `tests/test_cmd_list.py::test_list_all_excludes_others_private`\n- `tests/test_cmd_list.py::test_list_with_project_filter`\n- `tests/test_cmd_list.py::test_list_sorting_order`\n- `tests/test_cmd_list.py::test_list_limit`\n\n**Rollback**\nRevert handler; read-only operation.\n\n**Observability**\n`logger.info(\"list: scope=%s project=%s returned %d rows\", scope, project, count)`\n\n**Dependencies**\n#6, #7\n\n---\n\n## Issue #9: /todo board command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/009-cmd-board`                |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `board` subcommand. Groups tasks by section in fixed order (BACKLOG, DOING, WAITING, DONE, DROP), applies scope/project/status filters, and limits per section. Format: section headers with task lines underneath.\n\n**Acceptance Criteria**\n- [ ] Sections displayed in order: BACKLOG -> DOING -> WAITING -> DONE -> DROP\n- [ ] Empty sections shown with \"(empty)\" or omitted (decide and document)\n- [ ] `limitPerSection:N` caps items per section (default 10)\n- [ ] Scope/project filters identical to `list`\n- [ ] Each task line: `#id due:<date|-> assignees:<@U..> title`\n\n**Tests**\n- `tests/test_cmd_board.py::test_board_section_order`\n- `tests/test_cmd_board.py::test_board_limit_per_section`\n- `tests/test_cmd_board.py::test_board_scope_filter`\n\n**Rollback**\nRevert handler; read-only operation.\n\n**Observability**\n`logger.info(\"board: scope=%s project=%s sections=%s\", ...)`\n\n**Dependencies**\n#8\n\n---\n\n## Issue #10: /todo move command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/010-cmd-move`                 |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `move` subcommand. Validates section enum, checks permissions (private: owner only; shared: assignee or created_by), updates task section and updated_at, logs event.\n\n**Acceptance Criteria**\n- [ ] Section validated against enum; invalid returns error\n- [ ] Private project: only owner can move\n- [ ] Shared project: only assignee or created_by can move\n- [ ] `updated_at` set on change\n- [ ] Event logged\n- [ ] Response confirms new section\n\n**Tests**\n- `tests/test_cmd_move.py::test_move_valid_section`\n- `tests/test_cmd_move.py::test_move_invalid_section`\n- `tests/test_cmd_move.py::test_move_private_owner_only`\n- `tests/test_cmd_move.py::test_move_shared_permission`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"Task #%d moved to %s by %s\", id, section, sender)`\n\n**Dependencies**\n#6, #7\n\n---\n\n## Issue #11: /todo done and /todo drop commands\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/011-cmd-done-drop`            |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `done` and `drop` subcommands. Both set section and status accordingly, record `closed_at`, validate permissions same as `move`, and log event.\n\n**Acceptance Criteria**\n- [ ] `done`: section='done', status='done', closed_at=now\n- [ ] `drop`: section='drop', status='dropped', closed_at=now\n- [ ] Permissions enforced (same as move)\n- [ ] Already-closed task returns informational message (idempotent or error -- decide)\n- [ ] Event logged for each\n\n**Tests**\n- `tests/test_cmd_done_drop.py::test_done_sets_fields`\n- `tests/test_cmd_done_drop.py::test_drop_sets_fields`\n- `tests/test_cmd_done_drop.py::test_permission_check`\n- `tests/test_cmd_done_drop.py::test_already_done`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"Task #%d %s by %s\", id, action, sender)`\n\n**Dependencies**\n#10\n\n---\n\n## Issue #12: /todo edit command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/012-cmd-edit`                 |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `edit` subcommand (v1 replace semantics). Supports changing title, assignees (full replace), project, section, and due. Validates private-project assignee constraint on both source and target project. Logs event with old/new diff in payload.\n\n**Acceptance Criteria**\n- [ ] Title updated only if non-option tokens present\n- [ ] Mentions present -> assignees fully replaced (DELETE + INSERT)\n- [ ] `due:-` clears due to NULL\n- [ ] `/p <newProject>` moves task to new project (project_id updated)\n- [ ] Private project assignee validation applied to target project\n- [ ] If moving to private project with non-owner assignees -> warning, no change\n- [ ] Event payload contains changed fields\n- [ ] Permissions: private owner only; shared assignee/created_by\n\n**Tests**\n- `tests/test_cmd_edit.py::test_edit_title`\n- `tests/test_cmd_edit.py::test_edit_assignees_replace`\n- `tests/test_cmd_edit.py::test_edit_due_clear`\n- `tests/test_cmd_edit.py::test_edit_move_project`\n- `tests/test_cmd_edit.py::test_edit_private_assignee_rejected`\n- `tests/test_cmd_edit.py::test_edit_no_change_fields`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"Task #%d edited by %s: fields=%s\", id, sender, changed_fields)`\n\n**Dependencies**\n#6, #7, #10\n\n---\n\n## Issue #13: /todo project list command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M4                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/013-cmd-project-list`         |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `/todo project list`. Returns all shared projects and the sender's private projects. Format: grouped by visibility with name and task count.\n\n**Acceptance Criteria**\n- [ ] Shared projects listed regardless of sender\n- [ ] Sender's private projects listed\n- [ ] Other users' private projects NOT shown\n- [ ] Each project shows name, visibility, task count\n\n**Tests**\n- `tests/test_cmd_project.py::test_project_list_shows_shared`\n- `tests/test_cmd_project.py::test_project_list_shows_own_private`\n- `tests/test_cmd_project.py::test_project_list_hides_others_private`\n\n**Rollback**\nRevert handler; read-only.\n\n**Observability**\n`logger.info(\"project list: %d shared, %d private for %s\", ...)`\n\n**Dependencies**\n#7\n\n---\n\n## Issue #14: /todo project set-private command with assignee validation\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M4                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/014-cmd-project-set-private`  |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `/todo project set-private <name>` with the assignee validation described in PRD 3.4. Resolution flow: if sender already has private with that name -> noop; if shared exists -> attempt conversion; if neither -> create new private. Conversion scans all tasks in the project and rejects if any task has a non-owner assignee.\n\n**Acceptance Criteria**\n- [ ] Already-private for sender: returns \"already private\" message\n- [ ] Shared -> private: scans tasks; all assignees are owner -> success (visibility='private', owner_user_id=sender)\n- [ ] Shared -> private: at least one non-owner assignee -> error with task IDs and violating assignee list (max 10)\n- [ ] Neither exists: creates new private project with owner=sender\n- [ ] Error message format matches PRD example\n- [ ] Event logged\n\n**Tests**\n- `tests/test_cmd_project.py::test_set_private_already_private`\n- `tests/test_cmd_project.py::test_set_private_shared_success`\n- `tests/test_cmd_project.py::test_set_private_shared_rejected_non_owner_assignee`\n- `tests/test_cmd_project.py::test_set_private_creates_new`\n- `tests/test_cmd_project.py::test_set_private_error_message_format`\n\n**Rollback**\nRevert handler; no schema change.\n\n**Observability**\n`logger.info(\"project set-private: %s result=%s by %s\", name, result, sender)`\n\n**Dependencies**\n#7, #13\n\n---\n\n## Issue #15: /todo project set-shared command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M4                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/015-cmd-project-set-shared`   |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `/todo project set-shared <name>`. Creates a shared project if none exists. If a shared project with that name already exists, noop. Global uniqueness enforced by DB index.\n\n**Acceptance Criteria**\n- [ ] New shared project created when name is free\n- [ ] Existing shared project: returns \"already shared\" / noop\n- [ ] Name conflict with existing shared: returns exists message (index enforces)\n- [ ] Event logged\n\n**Tests**\n- `tests/test_cmd_project.py::test_set_shared_creates_new`\n- `tests/test_cmd_project.py::test_set_shared_already_exists_noop`\n- `tests/test_cmd_project.py::test_set_shared_name_conflict`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"project set-shared: %s result=%s\", name, result)`\n\n**Dependencies**\n#7, #13\n\n---\n\n## Issue #16: Command dispatcher and routing\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/016-dispatcher`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the dispatcher in `plugin.py` that maps the parsed command name to handler functions: `add`, `list`, `board`, `move`, `done`, `drop`, `edit`, `project`. The `project` command further dispatches to `list`, `set-private`, `set-shared`. Unknown commands return a help/error message.\n\n**Acceptance Criteria**\n- [ ] All valid command names routed to correct handler\n- [ ] `project` subcommands routed correctly\n- [ ] Unknown command returns usage hint\n- [ ] DB connection initialised (migration check) before first command execution\n\n**Tests**\n- `tests/test_dispatcher.py::test_routes_known_commands`\n- `tests/test_dispatcher.py::test_project_sub_routing`\n- `tests/test_dispatcher.py::test_unknown_command_help`\n\n**Rollback**\nRevert module.\n\n**Observability**\n`logger.info(\"Dispatching command=%s sub=%s\", command, sub)`\n\n**Dependencies**\n#5\n\n---\n\n## Issue #17: Permission helper module\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/017-permissions`              |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nExtract shared permission-checking logic into `src/openclaw_todo/permissions.py`. Provides `can_write_task(conn, task_id, sender_id) -> bool` and `validate_private_assignees(project, assignees, owner_id) -> Optional[str]` (returns warning message or None).\n\n**Acceptance Criteria**\n- [ ] Private project: only owner can write\n- [ ] Shared project: only assignee or created_by can write\n- [ ] `validate_private_assignees` returns warning string when non-owner assignees present for private project\n- [ ] Returns None for shared projects or when all assignees are owner\n\n**Tests**\n- `tests/test_permissions.py::test_private_owner_can_write`\n- `tests/test_permissions.py::test_private_non_owner_rejected`\n- `tests/test_permissions.py::test_shared_assignee_can_write`\n- `tests/test_permissions.py::test_shared_creator_can_write`\n- `tests/test_permissions.py::test_validate_private_assignees_warning`\n\n**Rollback**\nRevert module.\n\n**Observability**\n`logger.debug(\"Permission check: task=%d sender=%s result=%s\", ...)`\n\n**Dependencies**\n#4\n\n---\n\n## Issue #18: Parser unit tests (comprehensive)\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | QA                                     |\n| Milestone   | M5                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/018-parser-tests`             |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nExpand parser test coverage to include edge cases: multiple options in varied order, due at year boundary, empty title, mentions mixed with options, unicode in titles, extra whitespace handling.\n\n**Acceptance Criteria**\n- [ ] >=95% line coverage on `parser.py`\n- [ ] Edge cases documented in test docstrings\n- [ ] All tests pass with `uv run pytest tests/test_parser.py -v`\n\n**Tests**\n- `tests/test_parser.py::test_options_in_any_order`\n- `tests/test_parser.py::test_due_year_boundary`\n- `tests/test_parser.py::test_empty_title_no_crash`\n- `tests/test_parser.py::test_unicode_title`\n- `tests/test_parser.py::test_extra_whitespace`\n- `tests/test_parser.py::test_mixed_mentions_and_options`\n\n**Rollback**\nRevert test file; no production code change.\n\n**Observability**\nCI coverage report.\n\n**Dependencies**\n#5\n\n---\n\n## Issue #19: SQLite end-to-end integration tests\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | QA                                     |\n| Milestone   | M5                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/019-e2e-tests`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nWrite integration tests that exercise the full flow through `handle_message` with a real (tmp_path) SQLite database. Cover the main user stories: add a task, list it, move it, mark done, edit it, manage projects, and validate private project constraints.\n\n**Acceptance Criteria**\n- [ ] Each test uses a fresh DB via `tmp_path` fixture\n- [ ] Scenarios: add->list, add->move->board, add->done, add->edit, project set-private rejection\n- [ ] Private project visibility enforced end-to-end\n- [ ] Due normalisation verified in DB\n- [ ] All tests pass with `uv run pytest tests/test_e2e.py -v`\n\n**Tests**\n- `tests/test_e2e.py::test_add_and_list_roundtrip`\n- `tests/test_e2e.py::test_add_move_board`\n- `tests/test_e2e.py::test_done_and_drop`\n- `tests/test_e2e.py::test_edit_title_and_assignees`\n- `tests/test_e2e.py::test_private_project_isolation`\n- `tests/test_e2e.py::test_set_private_rejects_foreign_assignees`\n- `tests/test_e2e.py::test_due_normalisation_stored_correctly`\n\n**Rollback**\nRevert test file.\n\n**Observability**\nCI test results and coverage delta.\n\n**Dependencies**\n#6, #8, #9, #10, #11, #12, #14, #15\n\n---\n\n## Issue #20: Packaging and distribution setup\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | DevOps                                 |\n| Milestone   | M6                                     |\n| Status      | TODO                                   |\n| Priority    | P2                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/020-packaging`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nFinalise `pyproject.toml` metadata (name, version, description, license, entry-points), add a `Makefile` with targets for lint/test/build, and document installation instructions in README. Ensure the plugin can be installed as a package and discovered by the OpenClaw gateway.\n\n**Acceptance Criteria**\n- [ ] `pyproject.toml` has complete metadata and entry-point for OpenClaw plugin discovery\n- [ ] `make lint` runs ruff + black --check\n- [ ] `make test` runs pytest with coverage\n- [ ] `make build` produces a wheel via `uv build`\n- [ ] `pip install <wheel>` in a clean venv makes the plugin importable\n- [ ] README documents installation and configuration (DB path env var)\n\n**Tests**\n- Manual: install wheel in fresh venv, import module, call `handle_message`\n- `make test` passes in CI\n\n**Rollback**\nRevert packaging changes.\n\n**Observability**\nBuild artifact size logged; CI publishes wheel as artifact.\n\n**Dependencies**\n#19\n\n---\n\n## Dependency Graph (summary)\n\n```\n#1  Plugin skeleton\n |\n +--#2  DB connection\n |   |\n |   +--#3  Migration framework\n |       |\n |       +--#4  V1 schema\n |           |\n |           +--#7  Project resolver\n |           |   |\n |           |   +--#13 project list\n |           |   +--#14 project set-private\n |           |   +--#15 project set-shared\n |           |\n |           +--#17 Permissions helper\n |\n +--#5  Parser\n |   |\n |   +--#18 Parser tests (M5)\n |\n +--#16 Dispatcher\n     |\n     +--#6  cmd add       (#4,#5,#7,#17)\n     +--#8  cmd list      (#6,#7)\n     +--#9  cmd board     (#8)\n     +--#10 cmd move      (#6,#7,#17)\n     +--#11 cmd done/drop (#10)\n     +--#12 cmd edit      (#6,#7,#10,#17)\n\n#19 E2E tests    (all commands)\n#20 Packaging    (#19)\n```\n", "structuredPatch": [{"oldStart": 223, "oldLines": 12, "newStart": 223, "newLines": 12, "lines": [" |-------------|----------------------------------------|", " | Track       | Backend                                |", " | Milestone   | M3                                     |", "-| Status      | doing                                  |", "+| Status      | done                                   |", " | Priority    | P0                                     |", " | Estimate    | 1.5d                                   |", " | Branch      | `feature/006-cmd-add`                  |", " | GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/17 |", "-| PR          | --                                     |", "+| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/18 |", " ", " **Description**", " Implement the `add` subcommand handler. Resolves project (default `Inbox`), applies defaults (section=`backlog`, assignees=sender if none mentioned), validates private-project assignee constraint (PRD 3.3), inserts task + task_assignees rows, logs event, and returns formatted confirmation."]}], "userModified": false, "replaceAll": false}, "tool_use_id": "toolu_01Gprq8SP6z21L3AoM7LMSLD", "_ts": "2026-02-20T19:21:42+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md"}, "tool_use_id": "toolu_01H6n8i5v71BE4JZikTwC3sZ", "_ts": "2026-02-20T19:21:45+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "content": "# Project Status — OpenClaw TODO Plugin\n\n**Last updated:** 2026-02-20\n\n## Current Phase\n\n**Kickoff complete** — All planning documents generated. Ready to begin implementation.\n\n## Milestones\n\n| Milestone | Description | Status | Issues |\n|-----------|-------------|--------|--------|\n| M0 | Plugin skeleton + `/todo` command registration | **Done** | #1 |\n| M1 | DB init + migrations + schema_version | **Done** | #2, #3, #4 |\n| M2 | Parser (Slack mention, /p, /s, due correction) | **Done** | #5 |\n| M3 | Commands (add/list/board/move/done/drop/edit) | Not started | #6–#12, #16, #17 |\n| M4 | Project commands (list/set-private/set-shared) | Not started | #13, #14, #15 |\n| M5 | Tests (parser/unit + sqlite E2E) | Not started | #18, #19 |\n| M6 | Packaging / deployment | Not started | #20 |\n\n## Critical Path\n\n```\n#1 (skeleton) → #2 (DB conn) → #3 (migration framework) → #4 (V1 schema) → #7 (project resolver) → commands\n#5 (parser) can be developed in parallel with DB track\n```\n\n## Next Issues to Work On\n\n1. **#7** — Project resolver helper (M3)\n2. **#17** — Permission helper module (M3)\n3. **#16** — Command dispatcher and routing (M3)\n\n## Risks\n\n| Risk | Likelihood | Impact | Mitigation |\n|------|-----------|--------|------------|\n| SQLite write contention under concurrent access | Low | Medium | WAL mode + busy_timeout=3000 |\n| Private/shared name collision user confusion | Medium | Low | Option A (private-first) + guidance |\n| Schema migration failures on upgrade | Low | High | schema_version table + sequential migrations |\n| Slack rate limits on heavy usage | Low | Low | Responses are single messages per command |\n\n## Generated Documents\n\n- [x] `docs/requirements.md` — Functional & non-functional requirements\n- [x] `docs/ux_spec.md` — UX specification with all command flows\n- [x] `docs/architecture.md` — Software architecture design\n- [x] `docs/test_plan.md` — Test strategy with 80+ test cases\n- [x] `issues.md` — 20 issues across 7 milestones\n", "numLines": 50, "startLine": 1, "totalLines": 50}}, "tool_use_id": "toolu_01H6n8i5v71BE4JZikTwC3sZ", "_ts": "2026-02-20T19:21:45+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "old_string": "| M3 | Commands (add/list/board/move/done/drop/edit) | Not started | #6–#12, #16, #17 |", "new_string": "| M3 | Commands (add/list/board/move/done/drop/edit) | **In progress** | #6 ✅, #16 ✅, #7–#12, #17 |", "replace_all": false}, "tool_use_id": "toolu_013vFS89zp6SHrP4NkXjMjTX", "_ts": "2026-02-20T19:21:50+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "old_string": "| M3 | Commands (add/list/board/move/done/drop/edit) | Not started | #6–#12, #16, #17 |", "new_string": "| M3 | Commands (add/list/board/move/done/drop/edit) | **In progress** | #6 ✅, #16 ✅, #7–#12, #17 |", "replace_all": false}, "tool_response": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "oldString": "| M3 | Commands (add/list/board/move/done/drop/edit) | Not started | #6–#12, #16, #17 |", "newString": "| M3 | Commands (add/list/board/move/done/drop/edit) | **In progress** | #6 ✅, #16 ✅, #7–#12, #17 |", "originalFile": "# Project Status — OpenClaw TODO Plugin\n\n**Last updated:** 2026-02-20\n\n## Current Phase\n\n**Kickoff complete** — All planning documents generated. Ready to begin implementation.\n\n## Milestones\n\n| Milestone | Description | Status | Issues |\n|-----------|-------------|--------|--------|\n| M0 | Plugin skeleton + `/todo` command registration | **Done** | #1 |\n| M1 | DB init + migrations + schema_version | **Done** | #2, #3, #4 |\n| M2 | Parser (Slack mention, /p, /s, due correction) | **Done** | #5 |\n| M3 | Commands (add/list/board/move/done/drop/edit) | Not started | #6–#12, #16, #17 |\n| M4 | Project commands (list/set-private/set-shared) | Not started | #13, #14, #15 |\n| M5 | Tests (parser/unit + sqlite E2E) | Not started | #18, #19 |\n| M6 | Packaging / deployment | Not started | #20 |\n\n## Critical Path\n\n```\n#1 (skeleton) → #2 (DB conn) → #3 (migration framework) → #4 (V1 schema) → #7 (project resolver) → commands\n#5 (parser) can be developed in parallel with DB track\n```\n\n## Next Issues to Work On\n\n1. **#7** — Project resolver helper (M3)\n2. **#17** — Permission helper module (M3)\n3. **#16** — Command dispatcher and routing (M3)\n\n## Risks\n\n| Risk | Likelihood | Impact | Mitigation |\n|------|-----------|--------|------------|\n| SQLite write contention under concurrent access | Low | Medium | WAL mode + busy_timeout=3000 |\n| Private/shared name collision user confusion | Medium | Low | Option A (private-first) + guidance |\n| Schema migration failures on upgrade | Low | High | schema_version table + sequential migrations |\n| Slack rate limits on heavy usage | Low | Low | Responses are single messages per command |\n\n## Generated Documents\n\n- [x] `docs/requirements.md` — Functional & non-functional requirements\n- [x] `docs/ux_spec.md` — UX specification with all command flows\n- [x] `docs/architecture.md` — Software architecture design\n- [x] `docs/test_plan.md` — Test strategy with 80+ test cases\n- [x] `issues.md` — 20 issues across 7 milestones\n", "structuredPatch": [{"oldStart": 13, "oldLines": 7, "newStart": 13, "newLines": 7, "lines": [" | M0 | Plugin skeleton + `/todo` command registration | **Done** | #1 |", " | M1 | DB init + migrations + schema_version | **Done** | #2, #3, #4 |", " | M2 | Parser (Slack mention, /p, /s, due correction) | **Done** | #5 |", "-| M3 | Commands (add/list/board/move/done/drop/edit) | Not started | #6–#12, #16, #17 |", "+| M3 | Commands (add/list/board/move/done/drop/edit) | **In progress** | #6 ✅, #16 ✅, #7–#12, #17 |", " | M4 | Project commands (list/set-private/set-shared) | Not started | #13, #14, #15 |", " | M5 | Tests (parser/unit + sqlite E2E) | Not started | #18, #19 |", " | M6 | Packaging / deployment | Not started | #20 |"]}], "userModified": false, "replaceAll": false}, "tool_use_id": "toolu_013vFS89zp6SHrP4NkXjMjTX", "_ts": "2026-02-20T19:21:50+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "old_string": "## Next Issues to Work On\n\n1. **#7** — Project resolver helper (M3)\n2. **#17** — Permission helper module (M3)\n3. **#16** — Command dispatcher and routing (M3)", "new_string": "## Next Issues to Work On\n\n1. **#17** — Permission helper module (M3)\n2. **#8** — /todo list command (M3)\n3. **#10** — /todo move command (M3)", "replace_all": false}, "tool_use_id": "toolu_01K7vwr48N57DaFdoim3d7AU", "_ts": "2026-02-20T19:21:54+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "old_string": "## Next Issues to Work On\n\n1. **#7** — Project resolver helper (M3)\n2. **#17** — Permission helper module (M3)\n3. **#16** — Command dispatcher and routing (M3)", "new_string": "## Next Issues to Work On\n\n1. **#17** — Permission helper module (M3)\n2. **#8** — /todo list command (M3)\n3. **#10** — /todo move command (M3)", "replace_all": false}, "tool_response": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "oldString": "## Next Issues to Work On\n\n1. **#7** — Project resolver helper (M3)\n2. **#17** — Permission helper module (M3)\n3. **#16** — Command dispatcher and routing (M3)", "newString": "## Next Issues to Work On\n\n1. **#17** — Permission helper module (M3)\n2. **#8** — /todo list command (M3)\n3. **#10** — /todo move command (M3)", "originalFile": "# Project Status — OpenClaw TODO Plugin\n\n**Last updated:** 2026-02-20\n\n## Current Phase\n\n**Kickoff complete** — All planning documents generated. Ready to begin implementation.\n\n## Milestones\n\n| Milestone | Description | Status | Issues |\n|-----------|-------------|--------|--------|\n| M0 | Plugin skeleton + `/todo` command registration | **Done** | #1 |\n| M1 | DB init + migrations + schema_version | **Done** | #2, #3, #4 |\n| M2 | Parser (Slack mention, /p, /s, due correction) | **Done** | #5 |\n| M3 | Commands (add/list/board/move/done/drop/edit) | **In progress** | #6 ✅, #16 ✅, #7–#12, #17 |\n| M4 | Project commands (list/set-private/set-shared) | Not started | #13, #14, #15 |\n| M5 | Tests (parser/unit + sqlite E2E) | Not started | #18, #19 |\n| M6 | Packaging / deployment | Not started | #20 |\n\n## Critical Path\n\n```\n#1 (skeleton) → #2 (DB conn) → #3 (migration framework) → #4 (V1 schema) → #7 (project resolver) → commands\n#5 (parser) can be developed in parallel with DB track\n```\n\n## Next Issues to Work On\n\n1. **#7** — Project resolver helper (M3)\n2. **#17** — Permission helper module (M3)\n3. **#16** — Command dispatcher and routing (M3)\n\n## Risks\n\n| Risk | Likelihood | Impact | Mitigation |\n|------|-----------|--------|------------|\n| SQLite write contention under concurrent access | Low | Medium | WAL mode + busy_timeout=3000 |\n| Private/shared name collision user confusion | Medium | Low | Option A (private-first) + guidance |\n| Schema migration failures on upgrade | Low | High | schema_version table + sequential migrations |\n| Slack rate limits on heavy usage | Low | Low | Responses are single messages per command |\n\n## Generated Documents\n\n- [x] `docs/requirements.md` — Functional & non-functional requirements\n- [x] `docs/ux_spec.md` — UX specification with all command flows\n- [x] `docs/architecture.md` — Software architecture design\n- [x] `docs/test_plan.md` — Test strategy with 80+ test cases\n- [x] `issues.md` — 20 issues across 7 milestones\n", "structuredPatch": [{"oldStart": 27, "oldLines": 9, "newStart": 27, "newLines": 9, "lines": [" ", " ## Next Issues to Work On", " ", "-1. **#7** — Project resolver helper (M3)", "-2. **#17** — Permission helper module (M3)", "-3. **#16** — Command dispatcher and routing (M3)", "+1. **#17** — Permission helper module (M3)", "+2. **#8** — /todo list command (M3)", "+3. **#10** — /todo move command (M3)", " ", " ## Risks", " "]}], "userModified": false, "replaceAll": false}, "tool_use_id": "toolu_01K7vwr48N57DaFdoim3d7AU", "_ts": "2026-02-20T19:21:54+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "TaskUpdate", "tool_input": {"taskId": "5", "status": "completed"}, "tool_use_id": "toolu_01FKoyyzGeq9Nh1Tc4EBTEdf", "_ts": "2026-02-20T19:21:57+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "TaskUpdate", "tool_input": {"taskId": "5", "status": "completed"}, "tool_response": {"success": true, "taskId": "5", "updatedFields": ["status"], "statusChange": {"from": "in_progress", "to": "completed"}}, "tool_use_id": "toolu_01FKoyyzGeq9Nh1Tc4EBTEdf", "_ts": "2026-02-20T19:21:57+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "SubagentStop", "stop_hook_active": false, "agent_id": "ae81897", "agent_transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6/subagents/agent-ae81897.jsonl", "agent_type": "", "_ts": "2026-02-20T19:22:11+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "gh pr view 18 --json number,title,headRefName,state,url,additions,deletions,changedFiles 2>&1", "description": "Get PR #18 details"}, "tool_use_id": "toolu_0161d3jUcZWc87ehC2EddP3K", "_ts": "2026-02-20T19:24:10+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "gh pr view 18 --json number,title,headRefName,state,url,additions,deletions,changedFiles 2>&1", "description": "Get PR #18 details"}, "tool_response": {"stdout": "{\"additions\":357,\"changedFiles\":4,\"deletions\":3,\"headRefName\":\"feature/006-cmd-add\",\"number\":18,\"state\":\"OPEN\",\"title\":\"[Issue#6] /todo add command\",\"url\":\"https://github.com/pillip/openclaw_todo_plugin/pull/18\"}", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_0161d3jUcZWc87ehC2EddP3K", "_ts": "2026-02-20T19:24:12+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "gh pr diff 18 2>&1", "description": "Get PR diff"}, "tool_use_id": "toolu_018h7QBCiak5oY67E7wRsttz", "_ts": "2026-02-20T19:24:12+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "gh pr diff 18 2>&1", "description": "Get PR diff"}, "tool_response": {"stdout": "diff --git a/src/openclaw_todo/cmd_add.py b/src/openclaw_todo/cmd_add.py\nnew file mode 100644\nindex 0000000..6f151a0\n--- /dev/null\n+++ b/src/openclaw_todo/cmd_add.py\n@@ -0,0 +1,92 @@\n+\"\"\"Handler for the ``/todo add`` command.\"\"\"\n+\n+from __future__ import annotations\n+\n+import json\n+import logging\n+import sqlite3\n+\n+from openclaw_todo.parser import DUE_CLEAR, ParsedCommand\n+from openclaw_todo.project_resolver import ProjectNotFoundError, resolve_project\n+\n+logger = logging.getLogger(__name__)\n+\n+\n+def add_handler(parsed: ParsedCommand, conn: sqlite3.Connection, context: dict) -> str:\n+    \"\"\"Create a new task.\n+\n+    Resolves the target project (default ``Inbox``), applies defaults for\n+    section and assignees, validates the private-project assignee constraint,\n+    inserts the task + assignee rows, and logs an event.\n+    \"\"\"\n+    sender_id: str = context[\"sender_id\"]\n+    title = \" \".join(parsed.title_tokens)\n+\n+    if not title:\n+        return \"Error: task title is required. Usage: /todo add <title> [options]\"\n+\n+    # --- Resolve project ---\n+    project_name = parsed.project or \"Inbox\"\n+    try:\n+        project = resolve_project(conn, project_name, sender_id)\n+    except ProjectNotFoundError:\n+        return f\"Error: project {project_name!r} not found.\"\n+\n+    # --- Defaults ---\n+    section = parsed.section or \"backlog\"\n+    due = parsed.due if parsed.due and parsed.due != DUE_CLEAR else None\n+    assignees = parsed.mentions if parsed.mentions else [sender_id]\n+\n+    # --- Private project assignee validation (PRD 3.3) ---\n+    if project.visibility == \"private\":\n+        non_owner = [a for a in assignees if a != project.owner_user_id]\n+        if non_owner:\n+            formatted = \", \".join(f\"<@{uid}>\" for uid in non_owner)\n+            return (\n+                f\"Warning: private project '{project.name}' belongs to \"\n+                f\"<@{project.owner_user_id}>. Cannot assign to {formatted}. \"\n+                f\"Task was NOT created.\"\n+            )\n+\n+    # --- Insert task ---\n+    cursor = conn.execute(\n+        \"INSERT INTO tasks (title, project_id, section, due, status, created_by) \"\n+        \"VALUES (?, ?, ?, ?, 'open', ?);\",\n+        (title, project.id, section, due, sender_id),\n+    )\n+    task_id = cursor.lastrowid\n+\n+    # --- Insert assignees ---\n+    for assignee in assignees:\n+        conn.execute(\n+            \"INSERT INTO task_assignees (task_id, assignee_user_id) VALUES (?, ?);\",\n+            (task_id, assignee),\n+        )\n+\n+    # --- Log event ---\n+    payload = json.dumps({\n+        \"title\": title,\n+        \"project\": project.name,\n+        \"section\": section,\n+        \"due\": due,\n+        \"assignees\": assignees,\n+    })\n+    conn.execute(\n+        \"INSERT INTO events (actor_user_id, action, task_id, payload) \"\n+        \"VALUES (?, 'task.add', ?, ?);\",\n+        (sender_id, task_id, payload),\n+    )\n+\n+    conn.commit()\n+\n+    logger.info(\n+        \"Task #%d created in %s/%s by %s\", task_id, project.name, section, sender_id\n+    )\n+\n+    # --- Format response ---\n+    due_str = due if due else \"-\"\n+    assignee_str = \", \".join(f\"<@{a}>\" for a in assignees)\n+    return (\n+        f\"Added #{task_id} ({project.name}/{section}) \"\n+        f\"due:{due_str} assignees:{assignee_str} -- {title}\"\n+    )\ndiff --git a/src/openclaw_todo/dispatcher.py b/src/openclaw_todo/dispatcher.py\nindex d00da42..b1895b8 100644\n--- a/src/openclaw_todo/dispatcher.py\n+++ b/src/openclaw_todo/dispatcher.py\n@@ -13,6 +13,8 @@\n \n import openclaw_todo.schema_v1 as _schema_v1  # noqa: F401 — registers migrations\n \n+from openclaw_todo.cmd_add import add_handler as _add_handler  # noqa: E402\n+\n # Type alias for command handler functions.\n HandlerFn = Callable[[ParsedCommand, sqlite3.Connection, dict], str]\n \n@@ -50,8 +52,9 @@ def _stub_handler(command: str, parsed: ParsedCommand, conn: sqlite3.Connection,\n \n \n # Handler registry: command name -> callable(parsed, conn, context) -> str\n-# Stubs will be replaced as handlers are implemented in later issues.\n-_handlers: dict[str, HandlerFn] = {}\n+_handlers: dict[str, HandlerFn] = {\n+    \"add\": _add_handler,\n+}\n \n \n def _get_handler(command: str) -> HandlerFn:\ndiff --git a/tests/test_cmd_add.py b/tests/test_cmd_add.py\nnew file mode 100644\nindex 0000000..37e27b8\n--- /dev/null\n+++ b/tests/test_cmd_add.py\n@@ -0,0 +1,254 @@\n+\"\"\"Tests for the /todo add command handler.\"\"\"\n+\n+from __future__ import annotations\n+\n+import json\n+\n+import pytest\n+\n+from openclaw_todo.cmd_add import add_handler\n+from openclaw_todo.db import get_connection\n+from openclaw_todo.migrations import _migrations, migrate\n+from openclaw_todo.parser import ParsedCommand\n+\n+\n+@pytest.fixture(autouse=True)\n+def _load_v1():\n+    \"\"\"Ensure V1 migration is registered.\"\"\"\n+    saved = _migrations.copy()\n+    _migrations.clear()\n+    from openclaw_todo.schema_v1 import migrate_v1\n+\n+    if migrate_v1 not in _migrations:\n+        _migrations.append(migrate_v1)\n+    yield\n+    _migrations.clear()\n+    _migrations.extend(saved)\n+\n+\n+@pytest.fixture()\n+def conn(tmp_path):\n+    \"\"\"Return a migrated V1 connection.\"\"\"\n+    c = get_connection(tmp_path / \"test.sqlite3\")\n+    migrate(c)\n+    yield c\n+    c.close()\n+\n+\n+def _make_parsed(\n+    *,\n+    title_tokens: list[str] | None = None,\n+    project: str | None = None,\n+    section: str | None = None,\n+    due: str | None = None,\n+    mentions: list[str] | None = None,\n+) -> ParsedCommand:\n+    \"\"\"Helper to build a ParsedCommand for the add command.\"\"\"\n+    return ParsedCommand(\n+        command=\"add\",\n+        args=[],\n+        project=project,\n+        section=section,\n+        due=due,\n+        mentions=mentions or [],\n+        title_tokens=title_tokens or [],\n+    )\n+\n+\n+class TestAddDefaultInbox:\n+    \"\"\"Task added to Inbox with defaults when no project/section specified.\"\"\"\n+\n+    def test_add_default_inbox(self, conn):\n+        parsed = _make_parsed(title_tokens=[\"Buy\", \"groceries\"])\n+        ctx = {\"sender_id\": \"U001\"}\n+\n+        result = add_handler(parsed, conn, ctx)\n+\n+        assert \"Added #\" in result\n+        assert \"(Inbox/backlog)\" in result\n+        assert \"due:-\" in result\n+        assert \"<@U001>\" in result\n+        assert \"Buy groceries\" in result\n+\n+        # Verify DB row\n+        row = conn.execute(\"SELECT title, section, status, due, created_by FROM tasks WHERE id = 1\").fetchone()\n+        assert row == (\"Buy groceries\", \"backlog\", \"open\", None, \"U001\")\n+\n+        # Verify assignee\n+        assignees = conn.execute(\"SELECT assignee_user_id FROM task_assignees WHERE task_id = 1\").fetchall()\n+        assert assignees == [(\"U001\",)]\n+\n+\n+class TestAddWithProjectSectionDue:\n+    \"\"\"Task created with explicit project, section, and due.\"\"\"\n+\n+    def test_add_with_project_section_due(self, conn):\n+        # Create a shared project\n+        conn.execute(\"INSERT INTO projects (name, visibility) VALUES ('Backend', 'shared');\")\n+        conn.commit()\n+\n+        parsed = _make_parsed(\n+            title_tokens=[\"Fix\", \"login\", \"bug\"],\n+            project=\"Backend\",\n+            section=\"doing\",\n+            due=\"2026-03-15\",\n+        )\n+        ctx = {\"sender_id\": \"U001\"}\n+\n+        result = add_handler(parsed, conn, ctx)\n+\n+        assert \"(Backend/doing)\" in result\n+        assert \"due:2026-03-15\" in result\n+        assert \"Fix login bug\" in result\n+\n+        row = conn.execute(\"SELECT section, due, project_id FROM tasks WHERE id = 1\").fetchone()\n+        assert row[0] == \"doing\"\n+        assert row[1] == \"2026-03-15\"\n+\n+        # project_id should be the Backend project (id=2, after Inbox=1)\n+        proj_row = conn.execute(\"SELECT id FROM projects WHERE name = 'Backend'\").fetchone()\n+        assert row[2] == proj_row[0]\n+\n+\n+class TestAddPrivateRejectsOtherAssignee:\n+    \"\"\"Private project + non-owner assignee is rejected.\"\"\"\n+\n+    def test_add_private_rejects_other_assignee(self, conn):\n+        conn.execute(\n+            \"INSERT INTO projects (name, visibility, owner_user_id) \"\n+            \"VALUES ('MyPrivate', 'private', 'U001');\"\n+        )\n+        conn.commit()\n+\n+        parsed = _make_parsed(\n+            title_tokens=[\"Secret\", \"task\"],\n+            project=\"MyPrivate\",\n+            mentions=[\"U002\"],\n+        )\n+        ctx = {\"sender_id\": \"U001\"}\n+\n+        result = add_handler(parsed, conn, ctx)\n+\n+        assert \"Warning\" in result\n+        assert \"NOT created\" in result\n+        assert \"<@U002>\" in result\n+\n+        # Verify no task was inserted\n+        count = conn.execute(\"SELECT COUNT(*) FROM tasks\").fetchone()[0]\n+        assert count == 0\n+\n+    def test_add_private_allows_owner_assignee(self, conn):\n+        conn.execute(\n+            \"INSERT INTO projects (name, visibility, owner_user_id) \"\n+            \"VALUES ('MyPrivate', 'private', 'U001');\"\n+        )\n+        conn.commit()\n+\n+        parsed = _make_parsed(\n+            title_tokens=[\"Owner\", \"task\"],\n+            project=\"MyPrivate\",\n+            mentions=[\"U001\"],\n+        )\n+        ctx = {\"sender_id\": \"U001\"}\n+\n+        result = add_handler(parsed, conn, ctx)\n+\n+        assert \"Added #\" in result\n+        assert \"(MyPrivate/backlog)\" in result\n+\n+\n+class TestAddAssigneeDefaultsToSender:\n+    \"\"\"When no mentions are provided, assignee defaults to sender.\"\"\"\n+\n+    def test_add_assignee_defaults_to_sender(self, conn):\n+        parsed = _make_parsed(title_tokens=[\"Some\", \"task\"])\n+        ctx = {\"sender_id\": \"USENDER\"}\n+\n+        result = add_handler(parsed, conn, ctx)\n+\n+        assert \"<@USENDER>\" in result\n+\n+        assignees = conn.execute(\n+            \"SELECT assignee_user_id FROM task_assignees WHERE task_id = 1\"\n+        ).fetchall()\n+        assert assignees == [(\"USENDER\",)]\n+\n+\n+class TestAddMultipleAssignees:\n+    \"\"\"Multiple mentions create multiple task_assignee rows.\"\"\"\n+\n+    def test_add_multiple_assignees(self, conn):\n+        parsed = _make_parsed(\n+            title_tokens=[\"Review\", \"PR\"],\n+            mentions=[\"UBOB\", \"UCAROL\"],\n+        )\n+        ctx = {\"sender_id\": \"U001\"}\n+\n+        result = add_handler(parsed, conn, ctx)\n+\n+        assert \"<@UBOB>\" in result\n+        assert \"<@UCAROL>\" in result\n+\n+        assignees = conn.execute(\n+            \"SELECT assignee_user_id FROM task_assignees WHERE task_id = 1 ORDER BY assignee_user_id\"\n+        ).fetchall()\n+        assert assignees == [(\"UBOB\",), (\"UCAROL\",)]\n+\n+\n+class TestAddEventLogging:\n+    \"\"\"Event is logged to the events table.\"\"\"\n+\n+    def test_event_logged(self, conn):\n+        parsed = _make_parsed(title_tokens=[\"Task\", \"one\"])\n+        ctx = {\"sender_id\": \"U001\"}\n+\n+        add_handler(parsed, conn, ctx)\n+\n+        event = conn.execute(\n+            \"SELECT actor_user_id, action, task_id, payload FROM events WHERE action = 'task.add'\"\n+        ).fetchone()\n+        assert event is not None\n+        assert event[0] == \"U001\"\n+        assert event[1] == \"task.add\"\n+        assert event[2] == 1\n+\n+        payload = json.loads(event[3])\n+        assert payload[\"title\"] == \"Task one\"\n+        assert payload[\"project\"] == \"Inbox\"\n+        assert payload[\"section\"] == \"backlog\"\n+\n+\n+class TestAddEdgeCases:\n+    \"\"\"Edge cases for the add handler.\"\"\"\n+\n+    def test_add_empty_title_returns_error(self, conn):\n+        parsed = _make_parsed(title_tokens=[])\n+        ctx = {\"sender_id\": \"U001\"}\n+\n+        result = add_handler(parsed, conn, ctx)\n+\n+        assert \"Error\" in result\n+        assert \"title\" in result.lower()\n+\n+    def test_add_nonexistent_project_returns_error(self, conn):\n+        parsed = _make_parsed(\n+            title_tokens=[\"Some\", \"task\"],\n+            project=\"NonExistent\",\n+        )\n+        ctx = {\"sender_id\": \"U001\"}\n+\n+        result = add_handler(parsed, conn, ctx)\n+\n+        assert \"Error\" in result\n+        assert \"NonExistent\" in result\n+\n+    def test_add_due_clear_sentinel_stored_as_null(self, conn):\n+        parsed = _make_parsed(title_tokens=[\"Task\"], due=\"-\")\n+        ctx = {\"sender_id\": \"U001\"}\n+\n+        result = add_handler(parsed, conn, ctx)\n+\n+        assert \"due:-\" in result\n+\n+        row = conn.execute(\"SELECT due FROM tasks WHERE id = 1\").fetchone()\n+        assert row[0] is None\ndiff --git a/tests/test_dispatcher.py b/tests/test_dispatcher.py\nindex aff2d41..953f87b 100644\n--- a/tests/test_dispatcher.py\n+++ b/tests/test_dispatcher.py\n@@ -33,7 +33,7 @@ class TestRoutesKnownCommands:\n \n     @pytest.mark.parametrize(\n         \"command\",\n-        [\"add\", \"list\", \"board\", \"move\", \"done\", \"drop\", \"edit\"],\n+        [\"list\", \"board\", \"move\", \"done\", \"drop\", \"edit\"],\n     )\n     def test_routes_known_commands(self, command, db_path):\n         \"\"\"Each known command reaches its handler (stub by default).\"\"\"\n@@ -47,6 +47,11 @@ def test_routes_known_commands(self, command, db_path):\n         # Stub handlers return \"not yet implemented\"\n         assert \"not yet implemented\" in result.lower()\n \n+    def test_add_routes_to_handler(self, db_path):\n+        \"\"\"The add command routes to the real add handler.\"\"\"\n+        result = dispatch(\"add something\", {\"sender_id\": \"U1\"}, db_path=db_path)\n+        assert \"Added #\" in result\n+\n     def test_registered_handler_called(self, db_path):\n         \"\"\"A registered handler is called instead of the stub.\"\"\"\n         called_with = {}", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_018h7QBCiak5oY67E7wRsttz", "_ts": "2026-02-20T19:24:14+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Task", "tool_input": {"description": "Review PR #18 Issue #6", "prompt": "Review PR #18 for Issue #6 (/todo add command) in the OpenClaw TODO Plugin project.\n\nThe PR branch is `feature/006-cmd-add` and the worktree is at `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/`.\n\nChanged files (all in the worktree):\n1. `src/openclaw_todo/cmd_add.py` — New add command handler (92 lines)\n2. `src/openclaw_todo/dispatcher.py` — Register add handler\n3. `tests/test_cmd_add.py` — 10 tests (254 lines)\n4. `tests/test_dispatcher.py` — Updated to handle add being a real handler\n\nContext:\n- This is a SQLite-based TODO plugin for Slack\n- Handler signature: `(ParsedCommand, sqlite3.Connection, dict) -> str`\n- Uses parameterized queries for SQL\n- The project resolver handles project lookup\n- Private project constraint: non-owner assignees must be rejected\n\nPerform a thorough code review with:\n\n**Code Quality**: correctness, edge cases, maintainability, complexity, test coverage\n**Security Audit**: SQL injection, input validation, auth bypass, hardcoded secrets\n\nRead the files in the worktree directory and write your review findings. DO NOT modify any files. Just provide me with:\n1. A list of findings (Critical/High/Medium/Low/Info) with file:line references\n2. Whether any fixes are needed\n3. Any follow-up items\n\nBe specific and reference exact lines. Focus on real issues, not style preferences.", "subagent_type": "reviewer"}, "tool_use_id": "toolu_01AN5UbMXybCCtNf2mqSoxk9", "_ts": "2026-02-20T19:24:32+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "hook_event_name": "SubagentStart", "agent_id": "a4ab747", "agent_type": "reviewer", "_ts": "2026-02-20T19:24:32+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/src/openclaw_todo/cmd_add.py"}, "tool_use_id": "toolu_012v2r8eD379yz8sBL8z5mQ8", "_ts": "2026-02-20T19:24:35+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/src/openclaw_todo/cmd_add.py"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/src/openclaw_todo/cmd_add.py", "content": "\"\"\"Handler for the ``/todo add`` command.\"\"\"\n\nfrom __future__ import annotations\n\nimport json\nimport logging\nimport sqlite3\n\nfrom openclaw_todo.parser import DUE_CLEAR, ParsedCommand\nfrom openclaw_todo.project_resolver import ProjectNotFoundError, resolve_project\n\nlogger = logging.getLogger(__name__)\n\n\ndef add_handler(parsed: ParsedCommand, conn: sqlite3.Connection, context: dict) -> str:\n    \"\"\"Create a new task.\n\n    Resolves the target project (default ``Inbox``), applies defaults for\n    section and assignees, validates the private-project assignee constraint,\n    inserts the task + assignee rows, and logs an event.\n    \"\"\"\n    sender_id: str = context[\"sender_id\"]\n    title = \" \".join(parsed.title_tokens)\n\n    if not title:\n        return \"Error: task title is required. Usage: /todo add <title> [options]\"\n\n    # --- Resolve project ---\n    project_name = parsed.project or \"Inbox\"\n    try:\n        project = resolve_project(conn, project_name, sender_id)\n    except ProjectNotFoundError:\n        return f\"Error: project {project_name!r} not found.\"\n\n    # --- Defaults ---\n    section = parsed.section or \"backlog\"\n    due = parsed.due if parsed.due and parsed.due != DUE_CLEAR else None\n    assignees = parsed.mentions if parsed.mentions else [sender_id]\n\n    # --- Private project assignee validation (PRD 3.3) ---\n    if project.visibility == \"private\":\n        non_owner = [a for a in assignees if a != project.owner_user_id]\n        if non_owner:\n            formatted = \", \".join(f\"<@{uid}>\" for uid in non_owner)\n            return (\n                f\"Warning: private project '{project.name}' belongs to \"\n                f\"<@{project.owner_user_id}>. Cannot assign to {formatted}. \"\n                f\"Task was NOT created.\"\n            )\n\n    # --- Insert task ---\n    cursor = conn.execute(\n        \"INSERT INTO tasks (title, project_id, section, due, status, created_by) \"\n        \"VALUES (?, ?, ?, ?, 'open', ?);\",\n        (title, project.id, section, due, sender_id),\n    )\n    task_id = cursor.lastrowid\n\n    # --- Insert assignees ---\n    for assignee in assignees:\n        conn.execute(\n            \"INSERT INTO task_assignees (task_id, assignee_user_id) VALUES (?, ?);\",\n            (task_id, assignee),\n        )\n\n    # --- Log event ---\n    payload = json.dumps({\n        \"title\": title,\n        \"project\": project.name,\n        \"section\": section,\n        \"due\": due,\n        \"assignees\": assignees,\n    })\n    conn.execute(\n        \"INSERT INTO events (actor_user_id, action, task_id, payload) \"\n        \"VALUES (?, 'task.add', ?, ?);\",\n        (sender_id, task_id, payload),\n    )\n\n    conn.commit()\n\n    logger.info(\n        \"Task #%d created in %s/%s by %s\", task_id, project.name, section, sender_id\n    )\n\n    # --- Format response ---\n    due_str = due if due else \"-\"\n    assignee_str = \", \".join(f\"<@{a}>\" for a in assignees)\n    return (\n        f\"Added #{task_id} ({project.name}/{section}) \"\n        f\"due:{due_str} assignees:{assignee_str} -- {title}\"\n    )\n", "numLines": 93, "startLine": 1, "totalLines": 93}}, "tool_use_id": "toolu_012v2r8eD379yz8sBL8z5mQ8", "_ts": "2026-02-20T19:24:35+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/src/openclaw_todo/dispatcher.py"}, "tool_use_id": "toolu_01YNaMVua8xdtaUkMaC9cYhs", "_ts": "2026-02-20T19:24:35+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/src/openclaw_todo/dispatcher.py"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/src/openclaw_todo/dispatcher.py", "content": "\"\"\"Command dispatcher: routes parsed commands to handler functions.\"\"\"\n\nfrom __future__ import annotations\n\nimport logging\nimport sqlite3\n\nfrom typing import Callable\n\nfrom openclaw_todo.db import get_connection\nfrom openclaw_todo.migrations import migrate\nfrom openclaw_todo.parser import ParsedCommand, ParseError, parse\n\nimport openclaw_todo.schema_v1 as _schema_v1  # noqa: F401 — registers migrations\n\nfrom openclaw_todo.cmd_add import add_handler as _add_handler  # noqa: E402\n\n# Type alias for command handler functions.\nHandlerFn = Callable[[ParsedCommand, sqlite3.Connection, dict], str]\n\nlogger = logging.getLogger(__name__)\n\nUSAGE = (\n    \"Usage: /todo <command> [options]\\n\"\n    \"Commands: add, list, board, move, done, drop, edit, project\"\n)\n\nPROJECT_USAGE = (\n    \"Usage: /todo project <subcommand>\\n\"\n    \"Subcommands: list, set-private, set-shared\"\n)\n\n# Valid top-level command names\n_VALID_COMMANDS = frozenset(\n    {\"add\", \"list\", \"board\", \"move\", \"done\", \"drop\", \"edit\", \"project\"}\n)\n\n# Valid project subcommands\n_VALID_PROJECT_SUBS = frozenset({\"list\", \"set-private\", \"set-shared\"})\n\n\ndef _init_db(db_path: str | None = None) -> sqlite3.Connection:\n    \"\"\"Open DB connection and ensure schema is up-to-date.\"\"\"\n    conn = get_connection(db_path)\n    migrate(conn)\n    return conn\n\n\ndef _stub_handler(command: str, parsed: ParsedCommand, conn: sqlite3.Connection, context: dict) -> str:\n    \"\"\"Placeholder for commands not yet implemented.\"\"\"\n    return f\"Command '{command}' is not yet implemented.\"\n\n\n# Handler registry: command name -> callable(parsed, conn, context) -> str\n_handlers: dict[str, HandlerFn] = {\n    \"add\": _add_handler,\n}\n\n\ndef _get_handler(command: str) -> HandlerFn:\n    \"\"\"Look up a handler, falling back to stub.\"\"\"\n    return _handlers.get(command, lambda parsed, conn, ctx: _stub_handler(command, parsed, conn, ctx))\n\n\ndef register_handler(command: str, fn: HandlerFn) -> None:\n    \"\"\"Register a handler function for a top-level command.\"\"\"\n    _handlers[command] = fn\n\n\ndef dispatch(text: str, context: dict, db_path: str | None = None) -> str:\n    \"\"\"Parse the remainder text and dispatch to the appropriate handler.\n\n    *text* is the message content **after** the ``/todo`` prefix has been\n    stripped.  *context* must contain at least ``sender_id``.\n    \"\"\"\n    try:\n        parsed = parse(text)\n    except ParseError as exc:\n        return f\"Parse error: {exc}\"\n\n    command = parsed.command\n\n    if command not in _VALID_COMMANDS:\n        logger.info(\"Unknown command: %s\", command)\n        return f\"Unknown command: '{command}'\\n{USAGE}\"\n\n    logger.info(\"Dispatching command=%s\", command)\n\n    conn = _init_db(db_path)\n    try:\n        if command == \"project\":\n            return _dispatch_project(parsed, conn, context)\n\n        handler = _get_handler(command)\n        return handler(parsed, conn, context)\n    finally:\n        conn.close()\n\n\ndef _dispatch_project(parsed: ParsedCommand, conn: sqlite3.Connection, context: dict) -> str:\n    \"\"\"Route ``/todo project <subcommand>`` to the correct project handler.\"\"\"\n    # The subcommand is the first title_token or arg\n    sub_tokens = parsed.title_tokens or parsed.args\n    if not sub_tokens:\n        return PROJECT_USAGE\n\n    sub = sub_tokens[0].lower()\n\n    # Handle \"set-private\" and \"set-shared\" which may come as two tokens\n    # e.g. \"/todo project set-private MyProject\"\n    if sub not in _VALID_PROJECT_SUBS:\n        logger.info(\"Unknown project subcommand: %s\", sub)\n        return f\"Unknown project subcommand: '{sub}'\\n{PROJECT_USAGE}\"\n\n    logger.info(\"Dispatching command=project sub=%s\", sub)\n\n    handler_name = f\"project_{sub.replace('-', '_')}\"\n    handler: HandlerFn = _handlers.get(handler_name, lambda parsed, conn, ctx: _stub_handler(f\"project {sub}\", parsed, conn, ctx))\n    return handler(parsed, conn, context)\n", "numLines": 120, "startLine": 1, "totalLines": 120}}, "tool_use_id": "toolu_01YNaMVua8xdtaUkMaC9cYhs", "_ts": "2026-02-20T19:24:35+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/tests/test_cmd_add.py"}, "tool_use_id": "toolu_013E2WAvSMGS8bFUwJc13T2u", "_ts": "2026-02-20T19:24:36+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/tests/test_cmd_add.py"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/tests/test_cmd_add.py", "content": "\"\"\"Tests for the /todo add command handler.\"\"\"\n\nfrom __future__ import annotations\n\nimport json\n\nimport pytest\n\nfrom openclaw_todo.cmd_add import add_handler\nfrom openclaw_todo.db import get_connection\nfrom openclaw_todo.migrations import _migrations, migrate\nfrom openclaw_todo.parser import ParsedCommand\n\n\n@pytest.fixture(autouse=True)\ndef _load_v1():\n    \"\"\"Ensure V1 migration is registered.\"\"\"\n    saved = _migrations.copy()\n    _migrations.clear()\n    from openclaw_todo.schema_v1 import migrate_v1\n\n    if migrate_v1 not in _migrations:\n        _migrations.append(migrate_v1)\n    yield\n    _migrations.clear()\n    _migrations.extend(saved)\n\n\n@pytest.fixture()\ndef conn(tmp_path):\n    \"\"\"Return a migrated V1 connection.\"\"\"\n    c = get_connection(tmp_path / \"test.sqlite3\")\n    migrate(c)\n    yield c\n    c.close()\n\n\ndef _make_parsed(\n    *,\n    title_tokens: list[str] | None = None,\n    project: str | None = None,\n    section: str | None = None,\n    due: str | None = None,\n    mentions: list[str] | None = None,\n) -> ParsedCommand:\n    \"\"\"Helper to build a ParsedCommand for the add command.\"\"\"\n    return ParsedCommand(\n        command=\"add\",\n        args=[],\n        project=project,\n        section=section,\n        due=due,\n        mentions=mentions or [],\n        title_tokens=title_tokens or [],\n    )\n\n\nclass TestAddDefaultInbox:\n    \"\"\"Task added to Inbox with defaults when no project/section specified.\"\"\"\n\n    def test_add_default_inbox(self, conn):\n        parsed = _make_parsed(title_tokens=[\"Buy\", \"groceries\"])\n        ctx = {\"sender_id\": \"U001\"}\n\n        result = add_handler(parsed, conn, ctx)\n\n        assert \"Added #\" in result\n        assert \"(Inbox/backlog)\" in result\n        assert \"due:-\" in result\n        assert \"<@U001>\" in result\n        assert \"Buy groceries\" in result\n\n        # Verify DB row\n        row = conn.execute(\"SELECT title, section, status, due, created_by FROM tasks WHERE id = 1\").fetchone()\n        assert row == (\"Buy groceries\", \"backlog\", \"open\", None, \"U001\")\n\n        # Verify assignee\n        assignees = conn.execute(\"SELECT assignee_user_id FROM task_assignees WHERE task_id = 1\").fetchall()\n        assert assignees == [(\"U001\",)]\n\n\nclass TestAddWithProjectSectionDue:\n    \"\"\"Task created with explicit project, section, and due.\"\"\"\n\n    def test_add_with_project_section_due(self, conn):\n        # Create a shared project\n        conn.execute(\"INSERT INTO projects (name, visibility) VALUES ('Backend', 'shared');\")\n        conn.commit()\n\n        parsed = _make_parsed(\n            title_tokens=[\"Fix\", \"login\", \"bug\"],\n            project=\"Backend\",\n            section=\"doing\",\n            due=\"2026-03-15\",\n        )\n        ctx = {\"sender_id\": \"U001\"}\n\n        result = add_handler(parsed, conn, ctx)\n\n        assert \"(Backend/doing)\" in result\n        assert \"due:2026-03-15\" in result\n        assert \"Fix login bug\" in result\n\n        row = conn.execute(\"SELECT section, due, project_id FROM tasks WHERE id = 1\").fetchone()\n        assert row[0] == \"doing\"\n        assert row[1] == \"2026-03-15\"\n\n        # project_id should be the Backend project (id=2, after Inbox=1)\n        proj_row = conn.execute(\"SELECT id FROM projects WHERE name = 'Backend'\").fetchone()\n        assert row[2] == proj_row[0]\n\n\nclass TestAddPrivateRejectsOtherAssignee:\n    \"\"\"Private project + non-owner assignee is rejected.\"\"\"\n\n    def test_add_private_rejects_other_assignee(self, conn):\n        conn.execute(\n            \"INSERT INTO projects (name, visibility, owner_user_id) \"\n            \"VALUES ('MyPrivate', 'private', 'U001');\"\n        )\n        conn.commit()\n\n        parsed = _make_parsed(\n            title_tokens=[\"Secret\", \"task\"],\n            project=\"MyPrivate\",\n            mentions=[\"U002\"],\n        )\n        ctx = {\"sender_id\": \"U001\"}\n\n        result = add_handler(parsed, conn, ctx)\n\n        assert \"Warning\" in result\n        assert \"NOT created\" in result\n        assert \"<@U002>\" in result\n\n        # Verify no task was inserted\n        count = conn.execute(\"SELECT COUNT(*) FROM tasks\").fetchone()[0]\n        assert count == 0\n\n    def test_add_private_allows_owner_assignee(self, conn):\n        conn.execute(\n            \"INSERT INTO projects (name, visibility, owner_user_id) \"\n            \"VALUES ('MyPrivate', 'private', 'U001');\"\n        )\n        conn.commit()\n\n        parsed = _make_parsed(\n            title_tokens=[\"Owner\", \"task\"],\n            project=\"MyPrivate\",\n            mentions=[\"U001\"],\n        )\n        ctx = {\"sender_id\": \"U001\"}\n\n        result = add_handler(parsed, conn, ctx)\n\n        assert \"Added #\" in result\n        assert \"(MyPrivate/backlog)\" in result\n\n\nclass TestAddAssigneeDefaultsToSender:\n    \"\"\"When no mentions are provided, assignee defaults to sender.\"\"\"\n\n    def test_add_assignee_defaults_to_sender(self, conn):\n        parsed = _make_parsed(title_tokens=[\"Some\", \"task\"])\n        ctx = {\"sender_id\": \"USENDER\"}\n\n        result = add_handler(parsed, conn, ctx)\n\n        assert \"<@USENDER>\" in result\n\n        assignees = conn.execute(\n            \"SELECT assignee_user_id FROM task_assignees WHERE task_id = 1\"\n        ).fetchall()\n        assert assignees == [(\"USENDER\",)]\n\n\nclass TestAddMultipleAssignees:\n    \"\"\"Multiple mentions create multiple task_assignee rows.\"\"\"\n\n    def test_add_multiple_assignees(self, conn):\n        parsed = _make_parsed(\n            title_tokens=[\"Review\", \"PR\"],\n            mentions=[\"UBOB\", \"UCAROL\"],\n        )\n        ctx = {\"sender_id\": \"U001\"}\n\n        result = add_handler(parsed, conn, ctx)\n\n        assert \"<@UBOB>\" in result\n        assert \"<@UCAROL>\" in result\n\n        assignees = conn.execute(\n            \"SELECT assignee_user_id FROM task_assignees WHERE task_id = 1 ORDER BY assignee_user_id\"\n        ).fetchall()\n        assert assignees == [(\"UBOB\",), (\"UCAROL\",)]\n\n\nclass TestAddEventLogging:\n    \"\"\"Event is logged to the events table.\"\"\"\n\n    def test_event_logged(self, conn):\n        parsed = _make_parsed(title_tokens=[\"Task\", \"one\"])\n        ctx = {\"sender_id\": \"U001\"}\n\n        add_handler(parsed, conn, ctx)\n\n        event = conn.execute(\n            \"SELECT actor_user_id, action, task_id, payload FROM events WHERE action = 'task.add'\"\n        ).fetchone()\n        assert event is not None\n        assert event[0] == \"U001\"\n        assert event[1] == \"task.add\"\n        assert event[2] == 1\n\n        payload = json.loads(event[3])\n        assert payload[\"title\"] == \"Task one\"\n        assert payload[\"project\"] == \"Inbox\"\n        assert payload[\"section\"] == \"backlog\"\n\n\nclass TestAddEdgeCases:\n    \"\"\"Edge cases for the add handler.\"\"\"\n\n    def test_add_empty_title_returns_error(self, conn):\n        parsed = _make_parsed(title_tokens=[])\n        ctx = {\"sender_id\": \"U001\"}\n\n        result = add_handler(parsed, conn, ctx)\n\n        assert \"Error\" in result\n        assert \"title\" in result.lower()\n\n    def test_add_nonexistent_project_returns_error(self, conn):\n        parsed = _make_parsed(\n            title_tokens=[\"Some\", \"task\"],\n            project=\"NonExistent\",\n        )\n        ctx = {\"sender_id\": \"U001\"}\n\n        result = add_handler(parsed, conn, ctx)\n\n        assert \"Error\" in result\n        assert \"NonExistent\" in result\n\n    def test_add_due_clear_sentinel_stored_as_null(self, conn):\n        parsed = _make_parsed(title_tokens=[\"Task\"], due=\"-\")\n        ctx = {\"sender_id\": \"U001\"}\n\n        result = add_handler(parsed, conn, ctx)\n\n        assert \"due:-\" in result\n\n        row = conn.execute(\"SELECT due FROM tasks WHERE id = 1\").fetchone()\n        assert row[0] is None\n", "numLines": 255, "startLine": 1, "totalLines": 255}}, "tool_use_id": "toolu_013E2WAvSMGS8bFUwJc13T2u", "_ts": "2026-02-20T19:24:36+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/tests/test_dispatcher.py"}, "tool_use_id": "toolu_019EqRfTxsbG728b5JFLKr2S", "_ts": "2026-02-20T19:24:36+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/tests/test_dispatcher.py"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/tests/test_dispatcher.py", "content": "\"\"\"Tests for the command dispatcher and routing.\"\"\"\n\nfrom __future__ import annotations\n\nimport sqlite3\n\nimport pytest\n\nfrom openclaw_todo.dispatcher import (\n    _handlers,\n    dispatch,\n    register_handler,\n)\n\n\n@pytest.fixture()\ndef db_path(tmp_path):\n    \"\"\"Provide a temporary DB path for each test.\"\"\"\n    return str(tmp_path / \"test.sqlite3\")\n\n\n@pytest.fixture(autouse=True)\ndef _clean_handlers():\n    \"\"\"Ensure handler registry is clean between tests.\"\"\"\n    saved = dict(_handlers)\n    yield\n    _handlers.clear()\n    _handlers.update(saved)\n\n\nclass TestRoutesKnownCommands:\n    \"\"\"Verify that all valid command names are routed to their handler.\"\"\"\n\n    @pytest.mark.parametrize(\n        \"command\",\n        [\"list\", \"board\", \"move\", \"done\", \"drop\", \"edit\"],\n    )\n    def test_routes_known_commands(self, command, db_path):\n        \"\"\"Each known command reaches its handler (stub by default).\"\"\"\n        # For move/done/drop/edit, provide an id-like arg\n        if command in (\"move\", \"done\", \"drop\", \"edit\"):\n            text = f\"{command} 1\"\n        else:\n            text = f\"{command} something\"\n\n        result = dispatch(text, {\"sender_id\": \"U1\"}, db_path=db_path)\n        # Stub handlers return \"not yet implemented\"\n        assert \"not yet implemented\" in result.lower()\n\n    def test_add_routes_to_handler(self, db_path):\n        \"\"\"The add command routes to the real add handler.\"\"\"\n        result = dispatch(\"add something\", {\"sender_id\": \"U1\"}, db_path=db_path)\n        assert \"Added #\" in result\n\n    def test_registered_handler_called(self, db_path):\n        \"\"\"A registered handler is called instead of the stub.\"\"\"\n        called_with = {}\n\n        def fake_add(parsed, conn, ctx):\n            called_with[\"parsed\"] = parsed\n            called_with[\"ctx\"] = ctx\n            return \"added!\"\n\n        register_handler(\"add\", fake_add)\n\n        result = dispatch(\"add buy milk\", {\"sender_id\": \"U1\"}, db_path=db_path)\n        assert result == \"added!\"\n        assert called_with[\"parsed\"].command == \"add\"\n        assert \"buy\" in called_with[\"parsed\"].title_tokens\n\n\nclass TestProjectSubRouting:\n    \"\"\"Verify /todo project subcommand routing.\"\"\"\n\n    def test_project_list_routes(self, db_path):\n        \"\"\"``/todo project list`` routes to the project_list handler.\"\"\"\n        called = {\"hit\": False}\n\n        def fake_project_list(parsed, conn, ctx):\n            called[\"hit\"] = True\n            return \"project list!\"\n\n        register_handler(\"project_list\", fake_project_list)\n\n        result = dispatch(\"project list\", {\"sender_id\": \"U1\"}, db_path=db_path)\n        assert called[\"hit\"]\n        assert result == \"project list!\"\n\n    def test_project_set_private_routes(self, db_path):\n        \"\"\"``/todo project set-private`` routes correctly.\"\"\"\n        called = {\"hit\": False}\n\n        def fake_handler(parsed, conn, ctx):\n            called[\"hit\"] = True\n            return \"set private!\"\n\n        register_handler(\"project_set_private\", fake_handler)\n\n        result = dispatch(\"project set-private MyProj\", {\"sender_id\": \"U1\"}, db_path=db_path)\n        assert called[\"hit\"]\n        assert result == \"set private!\"\n\n    def test_project_set_shared_routes(self, db_path):\n        \"\"\"``/todo project set-shared`` routes correctly.\"\"\"\n        called = {\"hit\": False}\n\n        def fake_handler(parsed, conn, ctx):\n            called[\"hit\"] = True\n            return \"set shared!\"\n\n        register_handler(\"project_set_shared\", fake_handler)\n\n        result = dispatch(\"project set-shared MyProj\", {\"sender_id\": \"U1\"}, db_path=db_path)\n        assert called[\"hit\"]\n        assert result == \"set shared!\"\n\n    def test_project_no_subcommand(self, db_path):\n        \"\"\"``/todo project`` without subcommand returns usage.\"\"\"\n        result = dispatch(\"project\", {\"sender_id\": \"U1\"}, db_path=db_path)\n        assert \"Subcommands\" in result\n\n    def test_project_unknown_subcommand(self, db_path):\n        \"\"\"Unknown project subcommand returns error + usage.\"\"\"\n        result = dispatch(\"project foobar\", {\"sender_id\": \"U1\"}, db_path=db_path)\n        assert \"Unknown project subcommand\" in result\n        assert \"foobar\" in result\n\n\nclass TestUnknownCommandHelp:\n    \"\"\"Unknown commands return a helpful error message.\"\"\"\n\n    def test_unknown_command_help(self, db_path):\n        result = dispatch(\"foobar something\", {\"sender_id\": \"U1\"}, db_path=db_path)\n        assert \"Unknown command\" in result\n        assert \"foobar\" in result\n        assert \"Commands:\" in result\n\n    def test_parse_error_returned(self, db_path):\n        \"\"\"Parser errors are returned as user-facing messages.\"\"\"\n        # /s with invalid section should trigger ParseError\n        result = dispatch(\"add /s invalid_section title\", {\"sender_id\": \"U1\"}, db_path=db_path)\n        assert \"Parse error\" in result\n\n\nclass TestDbInitialization:\n    \"\"\"Verify DB is initialized before command execution.\"\"\"\n\n    def test_db_initialized_with_schema(self, db_path):\n        \"\"\"Dispatching a command initializes the DB with migrations.\"\"\"\n        dispatch(\"add something\", {\"sender_id\": \"U1\"}, db_path=db_path)\n\n        # Verify DB has schema_version table\n        conn = sqlite3.connect(db_path)\n        row = conn.execute(\"SELECT version FROM schema_version\").fetchone()\n        conn.close()\n        assert row is not None\n        assert row[0] >= 1\n", "numLines": 158, "startLine": 1, "totalLines": 158}}, "tool_use_id": "toolu_019EqRfTxsbG728b5JFLKr2S", "_ts": "2026-02-20T19:24:36+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/src/openclaw_todo/project_resolver.py"}, "tool_use_id": "toolu_01QV7HVQ7SZYejBoR3EivERw", "_ts": "2026-02-20T19:24:41+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/src/openclaw_todo/project_resolver.py"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/src/openclaw_todo/project_resolver.py", "content": "\"\"\"Project resolver: resolve project name to a project row (Option A — private first).\"\"\"\n\nfrom __future__ import annotations\n\nimport logging\nimport sqlite3\nfrom dataclasses import dataclass\n\nlogger = logging.getLogger(__name__)\n\n\nclass ProjectNotFoundError(Exception):\n    \"\"\"Raised when a project cannot be resolved.\"\"\"\n\n\n@dataclass\nclass Project:\n    \"\"\"Represents a resolved project row.\"\"\"\n\n    id: int\n    name: str\n    visibility: str  # 'shared' | 'private'\n    owner_user_id: str | None\n\n\ndef resolve_project(\n    conn: sqlite3.Connection, name: str, sender_id: str\n) -> Project:\n    \"\"\"Resolve a project name following PRD 3.2 Option A.\n\n    Resolution order:\n    1. Sender's private project with that name (private-first)\n    2. Shared project with that name\n    3. If name is ``Inbox``, auto-create as shared\n    4. Otherwise raise :class:`ProjectNotFoundError`\n    \"\"\"\n    # 1) Private project of sender\n    row = conn.execute(\n        \"SELECT id, name, visibility, owner_user_id FROM projects \"\n        \"WHERE name = ? AND visibility = 'private' AND owner_user_id = ?;\",\n        (name, sender_id),\n    ).fetchone()\n    if row:\n        project = Project(id=row[0], name=row[1], visibility=row[2], owner_user_id=row[3])\n        logger.debug(\n            \"Resolved project '%s' -> id=%d vis=%s (private match)\",\n            name, project.id, project.visibility,\n        )\n        return project\n\n    # 2) Shared project\n    row = conn.execute(\n        \"SELECT id, name, visibility, owner_user_id FROM projects \"\n        \"WHERE name = ? AND visibility = 'shared';\",\n        (name,),\n    ).fetchone()\n    if row:\n        project = Project(id=row[0], name=row[1], visibility=row[2], owner_user_id=row[3])\n        logger.debug(\n            \"Resolved project '%s' -> id=%d vis=%s (shared match)\",\n            name, project.id, project.visibility,\n        )\n        return project\n\n    # 3) Auto-create Inbox as shared\n    if name == \"Inbox\":\n        conn.execute(\n            \"INSERT OR IGNORE INTO projects (name, visibility, owner_user_id) \"\n            \"VALUES ('Inbox', 'shared', NULL);\",\n        )\n        conn.commit()\n        row = conn.execute(\n            \"SELECT id, name, visibility, owner_user_id FROM projects \"\n            \"WHERE name = 'Inbox' AND visibility = 'shared';\",\n        ).fetchone()\n        project = Project(id=row[0], name=row[1], visibility=row[2], owner_user_id=row[3])\n        logger.debug(\n            \"Resolved project '%s' -> id=%d vis=%s (auto-created)\",\n            name, project.id, project.visibility,\n        )\n        return project\n\n    # 4) Not found\n    raise ProjectNotFoundError(f\"Project not found: {name!r}\")\n", "numLines": 85, "startLine": 1, "totalLines": 85}}, "tool_use_id": "toolu_01QV7HVQ7SZYejBoR3EivERw", "_ts": "2026-02-20T19:24:41+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/src/openclaw_todo/parser.py"}, "tool_use_id": "toolu_01LN8ihqP139ABCoofC8kodx", "_ts": "2026-02-20T19:24:41+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/src/openclaw_todo/parser.py"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/src/openclaw_todo/parser.py", "content": "\"\"\"Command parser: tokenizer and option extraction for /todo commands.\"\"\"\n\nfrom __future__ import annotations\n\nimport logging\nimport re\nfrom dataclasses import dataclass, field\nfrom datetime import date, datetime\n\nlogger = logging.getLogger(__name__)\n\nVALID_SECTIONS = frozenset({\"backlog\", \"doing\", \"waiting\", \"done\", \"drop\"})\n\n_MENTION_RE = re.compile(r\"<@(U[A-Z0-9]+)>\")\n_DUE_RE = re.compile(r\"^due:(.+)$\")\n\n# Sentinel value indicating \"clear due date\"\nDUE_CLEAR = \"-\"\n\n\nclass ParseError(Exception):\n    \"\"\"Raised when the input cannot be parsed.\"\"\"\n\n\n@dataclass\nclass ParsedCommand:\n    \"\"\"Result of parsing a ``/todo`` message.\"\"\"\n\n    command: str\n    args: list[str] = field(default_factory=list)\n    project: str | None = None\n    section: str | None = None\n    due: str | None = None  # YYYY-MM-DD or DUE_CLEAR sentinel\n    mentions: list[str] = field(default_factory=list)\n    title_tokens: list[str] = field(default_factory=list)\n\n\ndef _normalise_due(raw: str) -> str:\n    \"\"\"Normalise a due-date string to ``YYYY-MM-DD`` or the clear sentinel.\n\n    Raises :class:`ParseError` for invalid dates.\n    \"\"\"\n    if raw == DUE_CLEAR:\n        return DUE_CLEAR\n\n    # Try full date first (YYYY-MM-DD)\n    try:\n        parsed = datetime.strptime(raw, \"%Y-%m-%d\").date()\n        return parsed.isoformat()\n    except ValueError:\n        pass\n\n    # Try MM-DD / M-D -- parse month and day as integers and construct with\n    # the current year directly. Using strptime(\"%m-%d\") would fail for Feb 29\n    # because its default year (1900) is not a leap year.\n    match = re.fullmatch(r\"(\\d{1,2})-(\\d{1,2})\", raw)\n    if match:\n        try:\n            parsed = date(date.today().year, int(match.group(1)), int(match.group(2)))\n            return parsed.isoformat()\n        except ValueError:\n            pass\n\n    raise ParseError(f\"Invalid due date: {raw!r}\")\n\n\ndef parse(text: str) -> ParsedCommand:\n    \"\"\"Parse the text *after* the ``/todo`` prefix.\n\n    Returns a :class:`ParsedCommand` with extracted options.\n    \"\"\"\n    tokens = text.strip().split()\n    if not tokens:\n        raise ParseError(\"Empty command\")\n\n    command = tokens[0].lower()\n    remaining = tokens[1:]\n\n    project: str | None = None\n    section: str | None = None\n    due: str | None = None\n    mentions: list[str] = []\n    title_tokens: list[str] = []\n    args: list[str] = []\n\n    i = 0\n    while i < len(remaining):\n        tok = remaining[i]\n\n        # /p <project>\n        if tok == \"/p\":\n            if i + 1 >= len(remaining):\n                raise ParseError(\"/p requires a project name\")\n            project = remaining[i + 1]\n            i += 2\n            continue\n\n        # /s <section>\n        if tok == \"/s\":\n            if i + 1 >= len(remaining):\n                raise ParseError(\"/s requires a section name\")\n            sec = remaining[i + 1].lower()\n            if sec not in VALID_SECTIONS:\n                raise ParseError(\n                    f\"Invalid section: {sec!r}. \"\n                    f\"Must be one of: {', '.join(sorted(VALID_SECTIONS))}\"\n                )\n            section = sec\n            i += 2\n            continue\n\n        # due:VALUE\n        due_match = _DUE_RE.match(tok)\n        if due_match:\n            due = _normalise_due(due_match.group(1))\n            i += 1\n            continue\n\n        # <@U...> mention\n        mention_match = _MENTION_RE.fullmatch(tok)\n        if mention_match:\n            mentions.append(mention_match.group(1))\n            i += 1\n            continue\n\n        # Everything else: title token or arg\n        title_tokens.append(tok)\n        i += 1\n\n    # For commands that take an id as first arg (move, done, drop, edit),\n    # extract it from title_tokens\n    if command in (\"move\", \"done\", \"drop\", \"edit\") and title_tokens:\n        args.append(title_tokens.pop(0))\n\n    result = ParsedCommand(\n        command=command,\n        args=args,\n        project=project,\n        section=section,\n        due=due,\n        mentions=mentions,\n        title_tokens=title_tokens,\n    )\n    logger.debug(\"Parsed: %s\", result)\n    return result\n", "numLines": 146, "startLine": 1, "totalLines": 146}}, "tool_use_id": "toolu_01LN8ihqP139ABCoofC8kodx", "_ts": "2026-02-20T19:24:41+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/src/openclaw_todo/schema_v1.py"}, "tool_use_id": "toolu_01TXXwpKmgtGjBeaTgJPxN1h", "_ts": "2026-02-20T19:24:42+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/src/openclaw_todo/schema_v1.py"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/src/openclaw_todo/schema_v1.py", "content": "\"\"\"V1 schema migration: projects, tasks, task_assignees, events tables.\"\"\"\n\nfrom __future__ import annotations\n\nimport logging\nimport sqlite3\n\nfrom openclaw_todo.migrations import register\n\nlogger = logging.getLogger(__name__)\n\n\n@register\ndef migrate_v1(conn: sqlite3.Connection) -> None:\n    \"\"\"Create the four core tables and seed the Inbox project.\"\"\"\n\n    conn.execute(\"\"\"\n        CREATE TABLE projects (\n            id              INTEGER PRIMARY KEY AUTOINCREMENT,\n            name            TEXT NOT NULL,\n            visibility      TEXT NOT NULL CHECK (visibility IN ('shared', 'private')),\n            owner_user_id   TEXT NULL,\n            created_at      TEXT NOT NULL DEFAULT (datetime('now')),\n            updated_at      TEXT NOT NULL DEFAULT (datetime('now'))\n        );\n    \"\"\")\n\n    conn.execute(\"\"\"\n        CREATE UNIQUE INDEX ux_projects_shared_name\n        ON projects(name) WHERE visibility = 'shared';\n    \"\"\")\n\n    conn.execute(\"\"\"\n        CREATE UNIQUE INDEX ux_projects_private_owner_name\n        ON projects(owner_user_id, name) WHERE visibility = 'private';\n    \"\"\")\n\n    conn.execute(\"\"\"\n        CREATE TABLE tasks (\n            id              INTEGER PRIMARY KEY AUTOINCREMENT,\n            title           TEXT NOT NULL,\n            project_id      INTEGER NOT NULL REFERENCES projects(id),\n            section         TEXT NOT NULL CHECK (section IN ('backlog', 'doing', 'waiting', 'done', 'drop')),\n            due             TEXT NULL,\n            status          TEXT NOT NULL CHECK (status IN ('open', 'done', 'dropped')),\n            created_by      TEXT NOT NULL,\n            created_at      TEXT NOT NULL DEFAULT (datetime('now')),\n            updated_at      TEXT NOT NULL DEFAULT (datetime('now')),\n            closed_at       TEXT NULL\n        );\n    \"\"\")\n\n    conn.execute(\"\"\"\n        CREATE TABLE task_assignees (\n            task_id             INTEGER NOT NULL REFERENCES tasks(id),\n            assignee_user_id    TEXT NOT NULL,\n            PRIMARY KEY (task_id, assignee_user_id)\n        );\n    \"\"\")\n\n    conn.execute(\"\"\"\n        CREATE INDEX ix_task_assignees_user\n        ON task_assignees(assignee_user_id, task_id);\n    \"\"\")\n\n    conn.execute(\"\"\"\n        CREATE TABLE events (\n            id              INTEGER PRIMARY KEY AUTOINCREMENT,\n            ts              TEXT NOT NULL DEFAULT (datetime('now')),\n            actor_user_id   TEXT,\n            action          TEXT,\n            task_id         INTEGER NULL,\n            payload         TEXT\n        );\n    \"\"\")\n\n    # Seed shared Inbox project\n    conn.execute(\"\"\"\n        INSERT OR IGNORE INTO projects (name, visibility, owner_user_id)\n        VALUES ('Inbox', 'shared', NULL);\n    \"\"\")\n\n    logger.info(\"V1 schema created: projects, tasks, task_assignees, events + Inbox seeded\")\n", "numLines": 84, "startLine": 1, "totalLines": 84}}, "tool_use_id": "toolu_01TXXwpKmgtGjBeaTgJPxN1h", "_ts": "2026-02-20T19:24:42+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "uv run pytest tests/test_cmd_add.py tests/test_dispatcher.py -v --tb=short 2>&1", "description": "Run tests for cmd_add and dispatcher"}, "tool_use_id": "toolu_01UtUL59UUmvXCcu7mTy97co", "_ts": "2026-02-20T19:24:45+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "uv run pytest tests/test_cmd_add.py tests/test_dispatcher.py -v --tb=short 2>&1", "description": "Run tests for cmd_add and dispatcher"}, "tool_response": {"stdout": "============================= test session starts ==============================\nplatform darwin -- Python 3.11.13, pytest-9.0.2, pluggy-1.6.0 -- /Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/.venv/bin/python\ncachedir: .pytest_cache\nrootdir: /Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add\nconfigfile: pyproject.toml\nplugins: cov-7.0.0\ncollecting ... collected 26 items\n\ntests/test_cmd_add.py::TestAddDefaultInbox::test_add_default_inbox PASSED [  3%]\ntests/test_cmd_add.py::TestAddWithProjectSectionDue::test_add_with_project_section_due PASSED [  7%]\ntests/test_cmd_add.py::TestAddPrivateRejectsOtherAssignee::test_add_private_rejects_other_assignee PASSED [ 11%]\ntests/test_cmd_add.py::TestAddPrivateRejectsOtherAssignee::test_add_private_allows_owner_assignee PASSED [ 15%]\ntests/test_cmd_add.py::TestAddAssigneeDefaultsToSender::test_add_assignee_defaults_to_sender PASSED [ 19%]\ntests/test_cmd_add.py::TestAddMultipleAssignees::test_add_multiple_assignees PASSED [ 23%]\ntests/test_cmd_add.py::TestAddEventLogging::test_event_logged PASSED     [ 26%]\ntests/test_cmd_add.py::TestAddEdgeCases::test_add_empty_title_returns_error PASSED [ 30%]\ntests/test_cmd_add.py::TestAddEdgeCases::test_add_nonexistent_project_returns_error PASSED [ 34%]\ntests/test_cmd_add.py::TestAddEdgeCases::test_add_due_clear_sentinel_stored_as_null PASSED [ 38%]\ntests/test_dispatcher.py::TestRoutesKnownCommands::test_routes_known_commands[list] PASSED [ 42%]\ntests/test_dispatcher.py::TestRoutesKnownCommands::test_routes_known_commands[board] PASSED [ 46%]\ntests/test_dispatcher.py::TestRoutesKnownCommands::test_routes_known_commands[move] PASSED [ 50%]\ntests/test_dispatcher.py::TestRoutesKnownCommands::test_routes_known_commands[done] PASSED [ 53%]\ntests/test_dispatcher.py::TestRoutesKnownCommands::test_routes_known_commands[drop] PASSED [ 57%]\ntests/test_dispatcher.py::TestRoutesKnownCommands::test_routes_known_commands[edit] PASSED [ 61%]\ntests/test_dispatcher.py::TestRoutesKnownCommands::test_add_routes_to_handler PASSED [ 65%]\ntests/test_dispatcher.py::TestRoutesKnownCommands::test_registered_handler_called PASSED [ 69%]\ntests/test_dispatcher.py::TestProjectSubRouting::test_project_list_routes PASSED [ 73%]\ntests/test_dispatcher.py::TestProjectSubRouting::test_project_set_private_routes PASSED [ 76%]\ntests/test_dispatcher.py::TestProjectSubRouting::test_project_set_shared_routes PASSED [ 80%]\ntests/test_dispatcher.py::TestProjectSubRouting::test_project_no_subcommand PASSED [ 84%]\ntests/test_dispatcher.py::TestProjectSubRouting::test_project_unknown_subcommand PASSED [ 88%]\ntests/test_dispatcher.py::TestUnknownCommandHelp::test_unknown_command_help PASSED [ 92%]\ntests/test_dispatcher.py::TestUnknownCommandHelp::test_parse_error_returned PASSED [ 96%]\ntests/test_dispatcher.py::TestDbInitialization::test_db_initialized_with_schema PASSED [100%]\n\n============================== 26 passed in 0.10s ==============================", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_01UtUL59UUmvXCcu7mTy97co", "_ts": "2026-02-20T19:24:47+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "SubagentStop", "stop_hook_active": false, "agent_id": "a4ab747", "agent_transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6/subagents/agent-a4ab747.jsonl", "agent_type": "reviewer", "_ts": "2026-02-20T19:25:28+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Task", "tool_input": {"description": "Review PR #18 Issue #6", "prompt": "Review PR #18 for Issue #6 (/todo add command) in the OpenClaw TODO Plugin project.\n\nThe PR branch is `feature/006-cmd-add` and the worktree is at `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/`.\n\nChanged files (all in the worktree):\n1. `src/openclaw_todo/cmd_add.py` — New add command handler (92 lines)\n2. `src/openclaw_todo/dispatcher.py` — Register add handler\n3. `tests/test_cmd_add.py` — 10 tests (254 lines)\n4. `tests/test_dispatcher.py` — Updated to handle add being a real handler\n\nContext:\n- This is a SQLite-based TODO plugin for Slack\n- Handler signature: `(ParsedCommand, sqlite3.Connection, dict) -> str`\n- Uses parameterized queries for SQL\n- The project resolver handles project lookup\n- Private project constraint: non-owner assignees must be rejected\n\nPerform a thorough code review with:\n\n**Code Quality**: correctness, edge cases, maintainability, complexity, test coverage\n**Security Audit**: SQL injection, input validation, auth bypass, hardcoded secrets\n\nRead the files in the worktree directory and write your review findings. DO NOT modify any files. Just provide me with:\n1. A list of findings (Critical/High/Medium/Low/Info) with file:line references\n2. Whether any fixes are needed\n3. Any follow-up items\n\nBe specific and reference exact lines. Focus on real issues, not style preferences.", "subagent_type": "reviewer"}, "tool_response": {"status": "completed", "prompt": "Review PR #18 for Issue #6 (/todo add command) in the OpenClaw TODO Plugin project.\n\nThe PR branch is `feature/006-cmd-add` and the worktree is at `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/`.\n\nChanged files (all in the worktree):\n1. `src/openclaw_todo/cmd_add.py` — New add command handler (92 lines)\n2. `src/openclaw_todo/dispatcher.py` — Register add handler\n3. `tests/test_cmd_add.py` — 10 tests (254 lines)\n4. `tests/test_dispatcher.py` — Updated to handle add being a real handler\n\nContext:\n- This is a SQLite-based TODO plugin for Slack\n- Handler signature: `(ParsedCommand, sqlite3.Connection, dict) -> str`\n- Uses parameterized queries for SQL\n- The project resolver handles project lookup\n- Private project constraint: non-owner assignees must be rejected\n\nPerform a thorough code review with:\n\n**Code Quality**: correctness, edge cases, maintainability, complexity, test coverage\n**Security Audit**: SQL injection, input validation, auth bypass, hardcoded secrets\n\nRead the files in the worktree directory and write your review findings. DO NOT modify any files. Just provide me with:\n1. A list of findings (Critical/High/Medium/Low/Info) with file:line references\n2. Whether any fixes are needed\n3. Any follow-up items\n\nBe specific and reference exact lines. Focus on real issues, not style preferences.", "agentId": "a4ab747", "content": [{"type": "text", "text": "All 26 tests pass. Here is my review.\n\n---\n\n## Review Findings for PR #18 (Issue #6 -- `/todo add` command)\n\n### Code Review\n\n**Overall Assessment**: This is a clean, well-structured PR. The handler follows the established patterns, SQL is parameterized throughout, tests are thorough (10 tests covering happy path, edge cases, and authorization). All 26 tests pass.\n\n#### Finding 1 -- INFO: No transaction rollback on partial failure\n**File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/src/openclaw_todo/cmd_add.py`, lines 52-80\n\nThe handler performs three separate writes (task INSERT, assignee INSERTs, event INSERT) followed by a single `conn.commit()` at line 80. If any write after the task INSERT raises an exception (e.g., a duplicate assignee violating the PK constraint on `task_assignees`), the partial writes remain uncommitted but the connection is left in a dirty state. The caller (`dispatcher.py` line 97) closes the connection in a `finally` block, which in SQLite implicitly rolls back -- so data integrity is preserved. However, an explicit transaction context manager would make the intent clearer and be more robust if the dispatcher pattern ever changes.\n\n**Verdict**: No functional bug today due to SQLite's implicit rollback-on-close behavior. Worth noting for a follow-up if the codebase moves to a connection pool or persistent connections.\n\n#### Finding 2 -- LOW: Missing `sender_id` key would raise an unhandled KeyError\n**File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/src/openclaw_todo/cmd_add.py`, line 22\n\n```python\nsender_id: str = context[\"sender_id\"]\n```\n\nIf `context` is missing `\"sender_id\"`, a raw `KeyError` propagates. The dispatcher contract requires `sender_id` in `context`, so this is defensive-coding territory rather than a real bug. Still, a descriptive error would help debugging.\n\n**Verdict**: Acceptable given the documented contract. Could be improved with `context.get(\"sender_id\")` plus an early return, but low priority.\n\n#### Finding 3 -- INFO: Title length is unbounded\n**File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/src/openclaw_todo/cmd_add.py`, line 23\n\n```python\ntitle = \" \".join(parsed.title_tokens)\n```\n\nThere is no upper-bound check on title length. Slack messages are capped at ~4000 characters so this is naturally bounded by the input source, but the handler itself does not enforce a limit. The DB column is `TEXT NOT NULL` with no length constraint.\n\n**Verdict**: Not a bug in practice (Slack constrains input). Consider adding a max-length check if the handler is ever exposed through other input sources.\n\n#### Finding 4 -- INFO: Good test coverage, one minor gap\n**File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/tests/test_cmd_add.py`\n\nThe 10 tests cover: default Inbox, explicit project/section/due, private project rejection, private project owner-allowed, assignee defaults, multiple assignees, event logging, empty title, nonexistent project, and DUE_CLEAR sentinel. This is solid.\n\nOne scenario not tested: a private project where the sender is NOT the owner attempts to add a task (no mentions, so assignee defaults to sender). The current code would allow this because `assignees = [sender_id]` and `sender_id != project.owner_user_id` would trigger the rejection. This is actually correct behavior per the PRD constraint -- the sender who is not the owner cannot self-assign to someone else's private project. But there is no test verifying this path.\n\n**Verdict**: Follow-up item. Add a test for \"non-owner sender adds to someone else's private project (self-assign blocked).\"\n\n### Security Findings\n\n#### Finding 5 -- INFO (No Issue): SQL Injection\n**File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/src/openclaw_todo/cmd_add.py`, lines 52-78\n\nAll SQL uses parameterized queries (`?` placeholders). No string interpolation in SQL. The project resolver (`project_resolver.py`) also uses parameterized queries. **No SQL injection risk.**\n\n#### Finding 6 -- INFO (No Issue): Input Validation\nThe parser (`parser.py`) validates sections against `VALID_SECTIONS` (line 103), normalizes due dates with strict parsing, and constrains mention format to `<@U[A-Z0-9]+>` via regex. The `cmd_add.py` handler validates empty titles and nonexistent projects. **Input validation is adequate.**\n\n#### Finding 7 -- LOW: Authorization -- non-owner access to private projects\n**File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/src/openclaw_todo/cmd_add.py`, lines 41-49\n\nThe private project constraint at lines 41-49 only checks whether *assignees* are non-owners. It does NOT check whether the *sender* is authorized to create tasks in someone else's private project. The `resolve_project` function (line 38 in `project_resolver.py`) does resolve private projects only for the sender (`owner_user_id = ?` with `sender_id`), which means a non-owner sender cannot resolve another user's private project by name -- the resolver would fall through to the shared lookup or raise `ProjectNotFoundError`. So the resolver provides implicit access control.\n\nHowever, if two users both have a private project named \"Work\", the resolver correctly scopes to the sender's own private project. This is safe.\n\n**Verdict**: The authorization model is sound due to the resolver's private-first scoping. The assignee check in `cmd_add.py` is an additional layer for the case where the owner themselves tries to assign others. No bypass possible.\n\n#### Finding 8 -- INFO (No Issue): No hardcoded secrets, no debug flags, no sensitive data exposure\nReviewed all changed files. No secrets, API keys, or debug configurations found.\n\n---\n\n### Summary\n\n| Severity | Count | Description |\n|----------|-------|-------------|\n| Critical | 0 | -- |\n| High | 0 | -- |\n| Medium | 0 | -- |\n| Low | 2 | Missing `sender_id` KeyError (Finding 2), title length unbounded (Finding 3) |\n| Info | 4 | Transaction explicitness (Finding 1), test gap (Finding 4), SQL/auth confirmation (Findings 5-7) |\n\n### Are fixes needed?\n\n**No fixes are required for this PR.** The code is correct, secure, and well-tested. All 26 tests pass. The SQL is fully parameterized, the authorization model is sound via the resolver's private-first scoping, and input validation is handled by the parser layer.\n\n### Follow-up items\n\n1. **Add a test for non-owner sender self-assigning to another user's private project.** This should verify the resolver returns `ProjectNotFoundError` rather than allowing the task creation. (Finding 4)\n\n2. **Consider wrapping the three DB writes in an explicit transaction context manager** (`with conn:`) instead of relying on the manual `conn.commit()` at the end. This would make rollback behavior explicit if an intermediate write fails. (Finding 1)\n\n3. **Consider a title max-length validation** (e.g., 500 chars) as a defensive measure if the handler surface area expands beyond Slack. (Finding 3)"}], "totalDurationMs": 56402, "totalTokens": 25842, "totalToolUseCount": 8, "usage": {"input_tokens": 1, "cache_creation_input_tokens": 1188, "cache_read_input_tokens": 22801, "output_tokens": 1852, "server_tool_use": {"web_search_requests": 0, "web_fetch_requests": 0}, "service_tier": "standard", "cache_creation": {"ephemeral_1h_input_tokens": 1188, "ephemeral_5m_input_tokens": 0}, "inference_geo": "", "iterations": [], "speed": "standard"}}, "tool_use_id": "toolu_01AN5UbMXybCCtNf2mqSoxk9", "_ts": "2026-02-20T19:25:28+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md"}, "tool_use_id": "toolu_01MqsTPmutmaoi7p2KDmBZ7L", "_ts": "2026-02-20T19:25:32+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "content": "# PR #2 Review Notes -- Issue #1: Plugin skeleton and entry point\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/001-plugin-skeleton`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `pyproject.toml` with Python >=3.11, pytest, pytest-cov dev deps | PASS | Correct. Uses `dependency-groups` (PEP 735) with hatchling backend. |\n| `src/openclaw_todo/__init__.py` exposes `__version__` | PASS | `__version__ = \"0.1.0\"` |\n| `handle_message(text: str, context: dict) -> str` entry point | PASS (minor note) | Return type is `str | None`, not `str`. The AC literally says `-> str` but `None` for ignored messages is the intended behavior per the next AC. Acceptable. |\n| Non-`/todo` messages silently ignored (returns `None`) | PASS | |\n| `uv sync && uv run pytest -q` passes | PASS | 4 tests, 100% coverage |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_ignores_non_todo_message` | PASS -- covers empty string, random text, `/todox` prefix-collision |\n| `test_dispatches_todo_prefix` | PASS -- verifies non-None response with subcommand text |\n\n### Findings\n\n#### [Info] Return type annotation mismatch with AC\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 12\n- The AC states `-> str` but the implementation is `-> str | None`. This is correct behavior (returning `None` for non-todo messages is explicitly required). The AC text is slightly imprecise; the code is right.\n- **Action**: None needed. Consider updating the AC wording if desired.\n\n#### [Info] `context` parameter unused\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 12\n- `context: dict` is accepted but never read in this skeleton. This is expected for M0 -- it will be used once the dispatcher (Issue #16) and DB commands are wired in.\n- **Action**: None. This is intentional scaffolding.\n\n#### [Info] Placeholder response includes raw user input\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 32\n- `f\"TODO command received: {remainder}\"` echoes back unescaped user input. This is a temporary placeholder (comment says \"will be replaced by dispatcher in Issue #16\"). In the current context (no HTML/web rendering, Slack DM only), this is not exploitable, but see Security Findings below.\n- **Action**: Track as part of Issue #16.\n\n#### [Info] Extra tests beyond AC requirements -- good\n\n- `test_todo_prefix_with_whitespace` and `test_todo_without_subcommand` are bonus tests covering whitespace handling and bare `/todo` usage message. Good coverage instinct.\n\n#### [Info] Version duplication\n\n- Version `0.1.0` appears in both `pyproject.toml` and `__init__.py`. Consider using `importlib.metadata` or dynamic versioning in a future issue to keep a single source of truth. Not a concern for M0.\n\n#### [Low] No type hints for `context` dict\n\n- `context: dict` is untyped (could be `dict[str, Any]` or a TypedDict). For M0 this is fine, but a `TypedDict` or dataclass should be introduced when the context shape solidifies.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and well-structured for a skeleton:\n\n- Prefix matching logic (`stripped == _TODO_PREFIX or stripped.startswith(_TODO_PREFIX + \" \")`) correctly avoids false positives on `/todox`.\n- Logging at appropriate levels (debug for all messages, info for matches).\n- Usage help returned for bare `/todo` is a nice touch.\n- Test coverage is 100%.\n\n**Verdict: APPROVE** -- no blocking issues.\n\n---\n\n## Security Findings\n\n### [Low] S1: User input echoed in placeholder response\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 32\n- **Description**: The placeholder `f\"TODO command received: {remainder}\"` reflects user-supplied text without sanitization. In the current Slack DM context, Slack handles rendering and this is not exploitable for XSS. However, once a web dashboard or logging UI is introduced, unsanitized echo could become a reflected XSS vector.\n- **Severity**: Low (Slack auto-escapes; placeholder will be replaced in Issue #16)\n- **Recommendation**: When building the real dispatcher, ensure any user text echoed in responses is sanitized if it ever reaches a web context. No fix needed now.\n\n### [Low] S2: No input length validation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 12\n- **Description**: `handle_message` accepts arbitrarily long strings. A malicious or buggy client could send extremely large messages. Slack itself limits messages to ~40,000 characters, so this is mitigated at the transport layer.\n- **Severity**: Low\n- **Recommendation**: Consider adding a max-length guard in the dispatcher (Issue #16) if the plugin is ever exposed outside Slack.\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in any reviewed files. Environment variable approach is correctly deferred to future DB/config work.\n\n### [Info] S4: Dependencies are minimal and current\n\n- Only dev dependencies: `pytest>=7.0` and `pytest-cov>=4.0`. No known CVEs for these versions. No runtime dependencies beyond the standard library.\n- Build backend `hatchling` is a well-maintained, standard tool.\n\n### [Info] S5: No SQL, no deserialization, no file I/O\n\n- The M0 skeleton has no database, no file operations, and no deserialization. The attack surface is effectively zero at this stage.\n\n### Security Summary\n\nNo Critical or High severity findings. The codebase has a minimal attack surface appropriate for a plugin skeleton. Security considerations will become relevant starting with Issue #2 (DB connection) and Issue #5 (parser with user-controlled input).\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Issue #16 (Dispatcher)**: When replacing the placeholder response, ensure user input is not echoed raw if the output context changes (e.g., web UI).\n2. **Future**: Introduce a `TypedDict` or dataclass for the `context` parameter to enforce shape and enable static analysis.\n3. **Future**: Consolidate version to a single source (e.g., `importlib.metadata.version(\"openclaw-todo-plugin\")`).\n\n---\n\n# PR #4 Review Notes -- Issue #2: DB module -- connection helper and pragma setup\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/002-db-connection`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| Directory is created recursively when absent | PASS | `db_dir.mkdir(parents=True, exist_ok=True)` on line 32. Test `test_creates_directory_and_file` verifies nested `nested/dir/` creation. |\n| SQLite connection returned with WAL mode enabled | PASS | `PRAGMA journal_mode=WAL` on line 36. Test verifies `fetchone()[0] == \"wal\"`. |\n| `busy_timeout` is 3000 | PASS | `PRAGMA busy_timeout=3000` on line 37. Test verifies `fetchone()[0] == 3000`. |\n| Calling `get_connection` twice returns usable connections (no lock conflict) | PASS | `test_two_connections_no_conflict` creates a table via conn1, reads via conn2. WAL mode enables this concurrency. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `tests/test_db.py::test_creates_directory_and_file` | PASS -- verifies both `db_path.exists()` and `db_path.parent.exists()` with nested `tmp_path` |\n| `tests/test_db.py::test_wal_mode_enabled` | PASS -- queries `PRAGMA journal_mode` and asserts `\"wal\"` |\n| `tests/test_db.py::test_busy_timeout` | PASS -- queries `PRAGMA busy_timeout` and asserts `3000` |\n\n### Findings\n\n#### [Info] TOCTOU in `is_new` logging check\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 29\n- `is_new = not db_path.exists()` is checked before `sqlite3.connect()`, which itself creates the file. In a concurrent scenario, the file could appear between the check and the connect. This only affects which log message is emitted (info vs. debug) and has no functional impact.\n- **Action**: None required. Purely cosmetic race condition.\n\n#### [Info] PRAGMA return values not checked\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, lines 36-37\n- `conn.execute(\"PRAGMA journal_mode=WAL;\")` returns a result set with the actual journal mode applied. On some edge cases (e.g., read-only filesystem, in-memory DB), WAL activation can silently fall back to another mode. The code does not verify the return.\n- **Action**: Low priority. Consider adding a debug-level assertion or log warning in a future hardening pass. The test suite already validates WAL is active in the happy path.\n\n#### [Info] Default path uses `Path.home()`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 11\n- `DEFAULT_DB_DIR = Path.home() / \".openclaw\" / \"workspace\" / \".todo\"` is evaluated at module import time. If `HOME` is unset (e.g., certain containerized environments), `Path.home()` raises `RuntimeError`. This is acceptable since: (a) the default is only used when `db_path is None`, and (b) the plugin is designed for environments where `HOME` is set. Callers in containers should pass an explicit path.\n- **Action**: None for M1. Document the `db_path` parameter as the recommended override for non-standard environments.\n\n#### [Info] Extra test beyond AC requirements -- good\n\n- `test_two_connections_no_conflict` is a bonus test that exercises concurrent WAL access. This directly validates the 4th acceptance criterion and is well-structured with proper cleanup in a `finally` block.\n\n#### [Low] Test cleanup uses `try/finally` instead of a fixture\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_db.py`, all tests\n- Each test manually opens a connection and closes it in `try/finally`. A pytest fixture (e.g., `@pytest.fixture` yielding the connection) would reduce boilerplate and guarantee cleanup even if assertion lines are added later. This is a minor style observation for 4 tests.\n- **Action**: Optional refactor. Not blocking.\n\n#### [Info] Coverage at 96%\n\n- Line 24 (`db_path = DEFAULT_DB_DIR / DEFAULT_DB_NAME`) is uncovered because all tests pass explicit `tmp_path` paths. This is correct -- testing the default path would write to the user's actual home directory. The uncovered line is trivial assignment logic.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and correct:\n\n- Function signature `get_connection(db_path: str | Path | None = None)` is flexible, accepting string, Path, or None.\n- `Path(db_path)` normalization on line 26 handles string inputs.\n- `exist_ok=True` on `mkdir` prevents race conditions with concurrent directory creation.\n- Logging at appropriate levels: `info` for creation, `debug` for opens.\n- No unnecessary dependencies -- uses only stdlib `sqlite3`, `pathlib`, and `logging`.\n- 96% test coverage with all acceptance criteria verified.\n\n**Verdict: APPROVE** -- no blocking issues.\n\n---\n\n## Security Findings\n\n### [Low] S1: `db_path` parameter accepts arbitrary filesystem paths\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 15\n- **Description**: `get_connection(db_path)` will create directories and an SQLite database at any filesystem path the process has write access to. If a future caller passes unsanitized user input as `db_path`, this could be used for arbitrary file creation (e.g., path traversal via `../../etc/cron.d/evil`).\n- **Severity**: Low (currently an internal API; no user-facing code path passes user input to `db_path`)\n- **Recommendation**: When wiring `db_path` into the dispatcher (Issue #16), ensure the path comes only from configuration (env var or config file), never from user-controlled message text. Consider adding a validation that `db_path` is within an expected base directory.\n\n### [Info] S2: No SQL injection risk\n\n- PRAGMA statements on lines 36-37 use hardcoded string literals with no interpolation. The `db_path` is passed to `sqlite3.connect()` as a filesystem path, not as a SQL query. No injection surface exists.\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `db.py` or `test_db.py`. The module uses only stdlib.\n\n### [Info] S4: No new dependencies introduced\n\n- This module uses only Python standard library (`sqlite3`, `pathlib`, `logging`). No new entries in `pyproject.toml` dependencies. Zero additional attack surface from third-party code.\n\n### [Info] S5: SQLite WAL mode is a security-positive choice\n\n- WAL mode improves concurrent access safety and reduces the risk of database corruption from concurrent writes. The `busy_timeout=3000` prevents immediate lock failures, which could otherwise cause data loss if a caller does not handle `sqlite3.OperationalError` properly.\n\n### Security Summary\n\nNo Critical or High severity findings. The attack surface is minimal -- a single function that creates a local SQLite database with hardcoded pragmas. The only surface to monitor is ensuring `db_path` remains configuration-controlled as the codebase grows.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Issue #3 (Migration framework)**: When implementing migrations, ensure SQL statements use parameterized queries (not string formatting) for any dynamic values. The migration runner should validate migration callables are from a trusted registry.\n2. **Future**: Add a pytest fixture for `get_connection` that yields and auto-closes, reducing `try/finally` boilerplate across DB-related test files.\n3. **Future**: Consider adding a `validate_db_path(path)` helper that constrains paths to an allowed base directory, for defense-in-depth when the dispatcher wires in configuration.\n\n---\n\n# PR #6 Review Notes -- Issue #3: Schema migration framework and schema_version table\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/003-schema-migration`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `schema_version` table created with single row `version=0` if absent | PASS | `_ensure_version_table` uses `CREATE TABLE IF NOT EXISTS` and inserts `version=0` only when no row exists (line 30-31). |\n| Migrations are Python callables registered in an ordered list | PASS | `_migrations: list[MigrationFn]` with `@register` decorator appending to the list. Index maps directly to migration version. |\n| Each migration runs inside a transaction; version incremented on success | PASS | `conn.commit()` after each successful migration (line 65). SQLite's implicit transaction wraps the migration + version update. |\n| Re-running on an up-to-date DB is a no-op | PASS | `current >= target` guard on line 52 returns immediately. Test `test_idempotent_on_rerun` verifies. |\n| Failing migration rolls back and raises with clear message | PASS | `conn.rollback()` in `except` block (line 67). `RuntimeError` with formatted message including version number and original exception (line 68-70). |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_fresh_db_gets_version_table` | PASS -- verifies `get_version` returns 0 and `schema_version` table exists in `sqlite_master` |\n| `test_applies_migrations_sequentially` | PASS -- registers two migrations, asserts final version is 2, verifies both tables created |\n| `test_idempotent_on_rerun` | PASS -- calls `migrate` twice, both return 1, no errors |\n| `test_rollback_on_failure` | PASS -- first migration commits (version 1, `t_ok` exists), second raises `ValueError`, caught as `RuntimeError`, version stays at 1 |\n\n### Findings\n\n#### [Medium] No constraint preventing multiple rows in `schema_version`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- The `schema_version` table is created with `(version INTEGER NOT NULL)` but has no PRIMARY KEY, UNIQUE constraint, or CHECK constraint limiting it to a single row. If a bug or manual intervention inserts a second row, `get_version` would return whichever row SQLite returns first from `SELECT version FROM schema_version` (non-deterministic without ORDER BY).\n- **Action**: Consider adding a single-row constraint in a future migration (e.g., `CHECK (rowid = 1)` or a dummy `id INTEGER PRIMARY KEY CHECK (id = 1)` column). Not blocking for M1 since all writes go through `_ensure_version_table` which correctly checks before inserting.\n\n#### [Low] Redundant `_ensure_version_table` calls\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, lines 48-49\n- `migrate()` calls `_ensure_version_table(conn)` on line 48, then calls `get_version(conn)` on line 49, which internally calls `_ensure_version_table` again. This results in two `CREATE TABLE IF NOT EXISTS` and two `SELECT version` queries on every `migrate` call.\n- **Action**: Minor performance concern. Could be refactored so `migrate` calls `_ensure_version_table` once and reads the version directly. Not blocking.\n\n#### [Info] Global mutable state for migrations registry\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 15\n- `_migrations` is a module-level mutable list. This is a common pattern for migration registries and works well for single-process applications. The test suite correctly saves/restores it via the `_clean_migrations` autouse fixture (lines 16-23 in test file).\n- **Action**: None. This is an appropriate pattern for this use case. If multi-process or plugin-based architectures are introduced later, consider a class-based registry.\n\n#### [Info] Test fixture properly isolates migration state\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_migrations.py`, lines 16-23\n- The `_clean_migrations` fixture saves the original list, clears it before each test, and restores it after. This prevents test pollution and is correctly marked `autouse=True`. The save-clear-yield-clear-extend pattern is the correct idiom.\n\n#### [Info] `conn` fixture uses `get_connection` from `db` module\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_migrations.py`, lines 27-31\n- The test fixture uses `get_connection` (from Issue #2) rather than raw `sqlite3.connect`. This ensures WAL mode and `busy_timeout` pragmas are applied, matching production behavior. This is a good integration practice.\n\n#### [Info] Coverage at 100%\n\n- All 41 statements in `migrations.py` are covered by the 4 tests. No untested branches.\n\n#### [Info] Error message includes original exception\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, lines 68-70\n- `raise RuntimeError(...) from exc` preserves the exception chain, making debugging easier. The message format `\"Migration to version {N} failed: {exc}\"` clearly identifies which migration failed. This follows the acceptance criterion for \"clear message.\"\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and minimal:\n\n- The `@register` decorator pattern is intuitive for defining migrations in order.\n- Transaction semantics are correctly handled: commit on success, rollback on failure.\n- The version update uses a parameterized query (`?` placeholder on line 63), avoiding SQL injection.\n- Logging at appropriate levels: `info` for migration steps and completion, `debug` for up-to-date status.\n- The code correctly handles the edge case where `current > target` (e.g., if migrations are removed), treating it the same as up-to-date.\n- 100% test coverage with all four required tests present and passing.\n\n**Verdict: APPROVE** -- no blocking issues. One medium finding (missing single-row constraint) noted for follow-up.\n\n---\n\n## Security Findings\n\n### [Medium] S1: `schema_version` table lacks row-count constraint\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- **Description**: The `schema_version` table has no mechanism to enforce that exactly one row exists. While the application code only writes through `_ensure_version_table` (which checks before inserting) and `migrate` (which uses `UPDATE`), a direct SQL injection in a future module or manual DB editing could insert additional rows, causing `get_version` to return an unpredictable value. This could lead to migrations being skipped or re-applied.\n- **Severity**: Medium (requires either a separate SQL injection vulnerability or direct DB access to exploit; impact is schema corruption)\n- **Recommendation**: In the V1 schema migration (Issue #4), alter or recreate the table with a single-row constraint, e.g., `CREATE TABLE schema_version (id INTEGER PRIMARY KEY CHECK (id = 1), version INTEGER NOT NULL)`.\n\n### [Info] S2: No SQL injection risk in migration runner\n\n- All SQL in `migrations.py` uses either hardcoded string literals or parameterized queries (`?` on line 63 for the version update). The `MigrationFn` type receives a `Connection` object, and it is the responsibility of each registered migration to use parameterized queries. This is correctly documented in the PR #4 review follow-up.\n\n### [Info] S3: Migration functions are trusted code\n\n- The `@register` decorator appends arbitrary callables to the migration list. Since migrations are defined at module import time by the application developer (not by user input), there is no injection risk. The registry is not exposed to any user-facing API.\n\n### [Info] S4: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `migrations.py` or `test_migrations.py`.\n\n### [Info] S5: No new dependencies introduced\n\n- This module uses only Python standard library (`sqlite3`, `logging`, `typing`). No new entries in `pyproject.toml` dependencies.\n\n### [Info] S6: Exception message does not leak sensitive data\n\n- The `RuntimeError` message on line 69 includes the migration version number and the string representation of the original exception. In this context (local SQLite, no user-supplied data in migration functions), this does not leak sensitive information. If migrations ever process user data, the exception wrapping should be reviewed to avoid leaking PII in logs.\n\n### Security Summary\n\nNo Critical or High severity findings. One Medium finding regarding the missing single-row constraint on `schema_version`, which could lead to schema version confusion if combined with a separate vulnerability that allows arbitrary SQL execution. The recommendation is to address this in the Issue #4 V1 schema migration.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Issue #4 (V1 schema)**: Add a single-row constraint to `schema_version` (e.g., `CHECK (id = 1)` on a primary key column) as part of the V1 migration to prevent version-table corruption.\n2. **Future**: Refactor `migrate()` to avoid redundant `_ensure_version_table` calls for minor performance improvement.\n3. **Future**: Consider adding a `--dry-run` mode to the migration runner that reports which migrations would be applied without executing them, useful for deployment verification.\n\n---\n\n# PR #8 Review Notes -- Issue #4: V1 schema migration -- projects, tasks, task_assignees, events\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/004-v1-schema`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `projects` table with `ux_projects_shared_name` and `ux_projects_private_owner_name` partial unique indexes | PASS | Table created on lines 18-26, indexes on lines 28-36 of `schema_v1.py`. Partial `WHERE` clauses match PRD exactly. |\n| `tasks` table with section and status CHECK constraints | PASS | Section CHECK on line 43 (`backlog, doing, waiting, done, drop`), status CHECK on line 45 (`open, done, dropped`). Both match PRD spec. |\n| `task_assignees` table with composite PK and secondary index | PASS | Composite `PRIMARY KEY (task_id, assignee_user_id)` on line 57, secondary index `ix_task_assignees_user` on lines 61-64. |\n| `events` audit table created | PASS | Table on lines 66-75. Columns match PRD. |\n| Shared `Inbox` project auto-created (INSERT OR IGNORE) | PASS | Line 78-81 uses `INSERT OR IGNORE` with `('Inbox', 'shared', NULL)`. |\n| `schema_version` = 1 after migration | PASS | Test `test_v1_schema_version` verifies `get_version(conn) == 1`. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_v1_tables_exist` | PASS -- verifies all four tables exist in `sqlite_master` |\n| `test_v1_inbox_created` | PASS -- verifies name='Inbox', visibility='shared', owner_user_id=None |\n| `test_v1_shared_unique_index_enforced` | PASS -- duplicate shared name raises `IntegrityError` |\n| `test_v1_private_unique_index_enforced` | PASS -- duplicate (owner, name) raises `IntegrityError`; different owner succeeds |\n\n### Findings\n\n#### [High] F1: Foreign keys not enforced -- `PRAGMA foreign_keys=ON` missing\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 35-37\n- **Description**: SQLite does not enforce `REFERENCES` (foreign key) clauses by default. The `PRAGMA foreign_keys=ON` must be executed on every new connection for FK constraints to be active. Without this, the `REFERENCES projects(id)` on `tasks.project_id` and `REFERENCES tasks(id)` on `task_assignees.task_id` are purely decorative -- you can insert tasks pointing to non-existent projects and assignees pointing to non-existent tasks.\n- **Impact**: Referential integrity is silently not enforced, leading to orphaned rows and data corruption.\n- **Fix applied**: Added `conn.execute(\"PRAGMA foreign_keys=ON;\")` to `get_connection()` in `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 38. All 19 tests pass after the fix.\n\n#### [Medium] F2: `schema_version` single-row constraint not added in V1\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- **Description**: The PR #6 review (Medium finding S1) recommended adding a single-row constraint to `schema_version` as part of the V1 migration. This was not addressed. The table still has no PK or CHECK constraint to prevent multiple rows.\n- **Action**: Should be addressed in a follow-up issue. Adding it retroactively in a later migration (e.g., V2) would require recreating the table since SQLite does not support `ALTER TABLE ADD CONSTRAINT`.\n\n#### [Low] F3: Minor PRD deviation on `events.ts` -- NOT NULL DEFAULT added\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/schema_v1.py`, line 69\n- **Description**: The PRD spec for `events.ts` says `ts TEXT` with no nullability or default constraint. The implementation adds `NOT NULL DEFAULT (datetime('now'))`. This is a sensible enhancement (audit timestamps should always be present), but it is a deviation from the spec.\n- **Action**: None needed. The implementation is better than the spec. Consider updating the PRD to match.\n\n#### [Low] F4: `events.id` uses AUTOINCREMENT, PRD says PK only\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/schema_v1.py`, line 68\n- **Description**: PRD says `id INTEGER PK` for the events table. The implementation uses `INTEGER PRIMARY KEY AUTOINCREMENT`. AUTOINCREMENT prevents rowid reuse after deletion, which is actually preferable for an audit log (guarantees monotonically increasing IDs). This is a minor deviation but a positive one.\n- **Action**: None needed. Consider updating the PRD.\n\n#### [Low] F5: No test for `task_assignees` composite PK enforcement\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_schema_v1.py`\n- **Description**: The acceptance criteria mention `task_assignees` table with composite PK, but there is no test verifying that inserting a duplicate `(task_id, assignee_user_id)` pair raises `IntegrityError`. The composite PK is created, but its enforcement is untested.\n- **Action**: Add a test in a follow-up to insert a duplicate pair and assert `IntegrityError`.\n\n#### [Low] F6: No test for foreign key enforcement\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_schema_v1.py`\n- **Description**: No test verifies that inserting a task with a non-existent `project_id` raises an error, or that inserting a `task_assignee` with a non-existent `task_id` raises an error. With the FK pragma fix (F1), these would now fail correctly, but there is no test coverage for this behavior.\n- **Action**: Add FK enforcement tests in a follow-up.\n\n#### [Info] F7: Test fixture pattern is well-structured\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_schema_v1.py`, lines 11-25\n- The `_load_v1_migration` autouse fixture correctly saves, clears, imports, and restores the migration registry. The `conn` fixture properly creates a temp DB, migrates, yields, and closes. This is clean test isolation.\n\n#### [Info] F8: CHECK constraint tests are thorough\n\n- Tests `test_v1_section_check_constraint` and `test_v1_status_check_constraint` go beyond the required tests to verify that invalid enum values are rejected. Good defensive testing.\n\n#### [Info] F9: 8 tests total for V1 schema, all passing\n\n- `test_v1_tables_exist`, `test_v1_schema_version`, `test_v1_inbox_created`, `test_v1_shared_unique_index_enforced`, `test_v1_private_unique_index_enforced`, `test_v1_section_check_constraint`, `test_v1_status_check_constraint` (7 tests in `test_schema_v1.py`). Plus the rollback test verifies `conn.rollback()` is correctly called after each constraint violation test.\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and closely follows the PRD spec:\n\n- All four tables are created with the correct columns, types, and constraints.\n- Partial unique indexes use the correct `WHERE` clause syntax.\n- CHECK constraints enumerate exactly the values specified in the PRD.\n- `INSERT OR IGNORE` for the Inbox seed is idempotent.\n- Parameterized queries are not needed here (all DDL uses string literals with no interpolation).\n- The `@register` decorator integrates seamlessly with the migration framework from Issue #3.\n- Test coverage is good, with 7 tests covering table existence, version, seed data, unique indexes, and CHECK constraints.\n\n**Verdict: APPROVE with one fix applied** -- the `PRAGMA foreign_keys=ON` fix (High, F1) has been applied directly. Medium/Low findings are noted for follow-up.\n\n---\n\n## Security Findings\n\n### [High] S1: Foreign key constraints not enforced (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 35-37\n- **Description**: Without `PRAGMA foreign_keys=ON`, all `REFERENCES` clauses in the V1 schema are ignored. This means a future command handler could insert tasks referencing non-existent projects or assignees referencing non-existent tasks, leading to data integrity violations that are silent and hard to debug. In a multi-user Slack plugin, this could allow one user's actions to create orphaned records that cause errors for other users.\n- **Severity**: High (data integrity violation in a multi-user context; silent failure mode)\n- **Fix**: Added `conn.execute(\"PRAGMA foreign_keys=ON;\")` to `get_connection()`. All 19 tests pass.\n\n### [Medium] S2: `schema_version` table remains unprotected against multi-row corruption\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- **Description**: Carried forward from PR #6 review. The `schema_version` table has no constraint preventing insertion of additional rows. If a separate vulnerability allows arbitrary SQL execution, an attacker could manipulate the schema version to skip or re-run migrations.\n- **Severity**: Medium (requires a chained vulnerability to exploit)\n- **Recommendation**: Address in a future migration that recreates the table with a single-row constraint.\n\n### [Info] S3: No SQL injection risk in V1 migration\n\n- All SQL in `schema_v1.py` uses hardcoded string literals. No user input, no string interpolation, no parameterized queries needed. The `INSERT OR IGNORE` for the Inbox seed uses literal values only.\n\n### [Info] S4: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `schema_v1.py` or `test_schema_v1.py`.\n\n### [Info] S5: No new dependencies introduced\n\n- The V1 migration uses only Python standard library (`sqlite3`, `logging`). No new entries in `pyproject.toml`.\n\n### [Info] S6: CHECK constraints provide defense-in-depth\n\n- The `section` and `status` CHECK constraints on the `tasks` table prevent invalid enum values at the database level, not just the application level. This is a security-positive pattern that prevents data corruption even if the application layer has a bug.\n\n### Security Summary\n\nOne High severity finding (S1: missing `PRAGMA foreign_keys=ON`) was identified and fixed directly in `db.py`. One Medium finding (S2: `schema_version` single-row constraint) is carried forward from the previous review. No Critical findings.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Test coverage**: Add tests for `task_assignees` composite PK enforcement (duplicate pair should raise `IntegrityError`).\n2. **Test coverage**: Add tests for foreign key enforcement (task with non-existent `project_id`, assignee with non-existent `task_id` should raise `IntegrityError` now that FK pragma is enabled).\n3. **Schema version constraint**: Address the `schema_version` single-row constraint in a future migration (V2 or later) by recreating the table with `CHECK (id = 1)`.\n4. **PRD sync**: Update PRD section 6.3 to add `NOT NULL DEFAULT (datetime('now'))` to `events.ts` and `AUTOINCREMENT` to `events.id` to match the implementation.\n5. **DB module**: Add a test for `PRAGMA foreign_keys` returning `1` in `test_db.py` to prevent regression.\n\n---\n\n# PR #10 Review Notes -- Issue #5: Command parser -- tokenizer and option extraction\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/005-parser-tokenizer`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `/p MyProject` correctly extracted; token consumed | PASS | `test_extract_project` verifies project name extracted, `/p` and value removed from `title_tokens`. |\n| `/s doing` validated; invalid section raises `ParseError` | PASS | `test_extract_section_valid` and `test_extract_section_invalid` cover both paths. Case-insensitive via `.lower()`. |\n| `due:03-15` normalised to `2026-03-15` (current year) | PASS | `test_due_mm_dd_normalisation` verifies with `date.today().year`. |\n| `due:2026-02-30` raises `ParseError` (invalid date) | PASS | `test_due_invalid_date` asserts `ParseError` with match on \"Invalid due date\". |\n| `<@U12345>` extracted into mentions list | PASS | `test_mentions_extraction` verifies two mentions extracted and not in `title_tokens`. |\n| Multiple mentions supported | PASS | Same test covers two mentions in order. |\n| Title tokens are non-option, non-mention tokens before first option | PASS | `test_title_extraction` verifies correct split with mixed options. Note: title tokens are collected from *all* positions, not just \"before first option\" -- this is arguably more flexible than the AC wording. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_extract_project` | PASS |\n| `test_extract_section_valid` | PASS |\n| `test_extract_section_invalid` | PASS |\n| `test_due_mm_dd_normalisation` | PASS |\n| `test_due_full_date` | PASS |\n| `test_due_invalid_date` | PASS |\n| `test_due_clear` | PASS |\n| `test_mentions_extraction` | PASS |\n| `test_title_extraction` | PASS |\n\nAll 9 required tests present and passing. 4 additional bonus tests (`test_command_extraction`, `test_move_extracts_id_as_arg`, `test_empty_command_raises`, `test_section_case_insensitive`). 13 parser tests total.\n\n### Findings\n\n#### [Medium] F1: Leap-year bug in `_normalise_due` for MM-DD format (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 53-62 (after fix)\n- **Description**: The original implementation used `datetime.strptime(raw, \"%m-%d\")` which defaults to year 1900 (not a leap year). This caused `due:02-29` to always be rejected, even when the current year is a leap year (e.g., 2028). The `replace(year=current_year)` call was never reached because `strptime` itself raised `ValueError`.\n- **Fix applied**: Replaced `strptime(\"%m-%d\")` with a regex match `(\\d{1,2})-(\\d{1,2})` followed by direct `date(current_year, month, day)` construction. This correctly validates Feb 29 against the actual current year.\n- **Impact**: Without fix, `due:02-29` would fail in leap years (2028, 2032, etc.) when it should succeed.\n\n#### [Low] F2: Duplicate options silently use \"last wins\" semantics\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 91-117\n- **Description**: If a user provides `/p First /p Second`, the parser silently uses `Second`. Same for `/s` and `due:`. This is not necessarily wrong, but it is undocumented. \"Last wins\" is a reasonable default, but \"first wins\" or \"raise error on duplicate\" are also valid choices.\n- **Action**: Document the \"last wins\" behavior in the docstring or PRD. No code change needed.\n\n#### [Low] F3: `/p` and `/s` error paths (missing argument) are untested\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_parser.py`\n- **Description**: Lines 93 and 101 (`raise ParseError(\"/p requires a project name\")` and `/s` equivalent) are uncovered. Manual testing confirmed they work correctly, but automated test coverage is missing for these edge cases.\n- **Action**: Add tests for `parse(\"add task /p\")` and `parse(\"add task /s\")` in a follow-up.\n\n#### [Low] F4: `_DUE_RE` uses `.+` which accepts any characters after `due:`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, line 15\n- **Description**: `_DUE_RE = re.compile(r\"^due:(.+)$\")` will match `due:anything` and pass the value to `_normalise_due`. This is not a bug since `_normalise_due` properly validates the value, but a tighter regex like `r\"^due:([\\d-]+)$\"` would reject obviously invalid inputs earlier and serve as documentation of expected format.\n- **Action**: Optional tightening. Not blocking since validation is correct.\n\n#### [Low] F5: Title tokens are collected from all positions, not just \"before first option\"\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 126-128\n- **Description**: The AC says \"Title tokens are non-option, non-mention tokens before first option.\" The implementation collects title tokens from all positions (e.g., `add Buy /p Home milk` would produce `title_tokens=[\"Buy\", \"milk\"]`). This is actually more flexible and user-friendly, but deviates from the literal AC wording.\n- **Action**: Consider updating the AC to match the implementation. The current behavior is better for UX.\n\n#### [Info] F6: `args` extraction for `move/done/drop/edit` is well-designed\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 130-133\n- The pattern of extracting the first title token as `args[0]` for ID-based commands is clean and tested by `test_move_extracts_id_as_arg`.\n\n#### [Info] F7: Coverage at 97%\n\n- Lines 93 and 101 (error paths for missing `/p` and `/s` arguments) are uncovered. All other branches are tested. This is acceptable for M1.\n\n#### [Info] F8: Bonus tests add good defensive coverage\n\n- `test_section_case_insensitive` ensures `/s DOING` normalizes to `doing`.\n- `test_command_extraction` verifies the first token becomes the command.\n- `test_empty_command_raises` covers the empty input guard.\n- `test_move_extracts_id_as_arg` covers the args extraction logic.\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and well-structured:\n\n- The tokenizer loop with explicit index management (`while i < len(remaining)`) is readable and handles two-token options (`/p`, `/s`) cleanly by advancing `i` by 2.\n- `ParsedCommand` dataclass provides a clear, typed result structure.\n- `VALID_SECTIONS` as a `frozenset` is the right choice for O(1) membership testing.\n- `_MENTION_RE` uses `fullmatch` (not `match` or `search`), preventing partial matches on tokens like `<@U123>extra`.\n- Error messages are descriptive and include the invalid value with `repr()` formatting.\n- Logging at debug level for parsed results is appropriate.\n- 97% test coverage with all 9 required tests present and 4 bonus tests.\n\n**Verdict: APPROVE with one fix applied** -- the leap-year bug in `_normalise_due` (Medium, F1) has been fixed directly. Low findings are noted for follow-up.\n\n---\n\n## Security Findings\n\n### [Medium] S1: Leap-year date validation bypass (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, `_normalise_due`\n- **Description**: The original `strptime(\"%m-%d\")` approach silently rejected valid dates (`02-29` in leap years) due to the 1900 default year. While this is a correctness issue rather than a security vulnerability, incorrect date validation can lead to denial of service (users unable to set valid due dates) and data integrity issues (dates that should be accepted are rejected).\n- **Severity**: Medium (correctness bug with functional impact)\n- **Fix**: Replaced with regex-based month/day extraction and direct `date()` construction with the current year.\n\n### [Low] S2: No ReDoS risk in compiled regexes\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 14-15\n- **Description**: Both `_MENTION_RE = re.compile(r\"<@(U[A-Z0-9]+)>\")` and `_DUE_RE = re.compile(r\"^due:(.+)$\")` were tested with 100,000-character inputs and completed in under 0.1ms. Neither pattern contains nested quantifiers or alternation that could cause catastrophic backtracking.\n- **Severity**: Low (no risk found, noting for completeness)\n\n### [Low] S3: No input length validation on parser input\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, line 72\n- **Description**: `parse(text)` accepts arbitrarily long strings. `text.strip().split()` will allocate a token list proportional to input size. Slack limits messages to ~40,000 characters, mitigating this at the transport layer, but if the parser is used outside Slack, extremely long inputs could cause memory pressure.\n- **Severity**: Low (mitigated by Slack transport layer limits)\n- **Recommendation**: Consider adding a max-length guard in the plugin entry point (`handle_message`) rather than the parser itself.\n\n### [Info] S4: No injection risks\n\n- The parser only tokenizes and validates strings. No SQL, no shell commands, no template rendering. User input flows into `ParsedCommand` fields which are plain strings. Security depends on how these values are consumed downstream (e.g., parameterized queries when writing to SQLite).\n\n### [Info] S5: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `parser.py` or `test_parser.py`.\n\n### [Info] S6: No new dependencies introduced\n\n- The parser uses only Python standard library (`re`, `datetime`, `dataclasses`, `logging`). No new entries in `pyproject.toml`.\n\n### Security Summary\n\nNo Critical or High severity findings. One Medium finding (S1: leap-year date validation) was identified and fixed. The parser has a minimal attack surface -- it tokenizes strings and validates against known patterns. The main security consideration going forward is ensuring that `ParsedCommand` field values are used safely downstream (parameterized SQL queries, no raw echo in web contexts).\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Test coverage**: Add tests for `/p` and `/s` without arguments (lines 93, 101) to cover the missing-argument error paths.\n2. **Documentation**: Document \"last wins\" semantics for duplicate `/p`, `/s`, and `due:` options in the PRD or parser docstring.\n3. **Optional**: Tighten `_DUE_RE` from `.+` to `[\\d-]+` for earlier rejection of obviously invalid due values.\n4. **AC clarification**: Update Issue #5 AC to reflect that title tokens are collected from all positions (not just \"before first option\"), matching the implemented behavior.\n\n---\n\n# PR #12 Review Notes -- Issue #7: Project resolver helper\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/007-project-resolver`\n# PR #14 Review Notes -- Issue #16: Command dispatcher and routing\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature-016-dispatcher`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| Private project of sender matched first | PASS | Query on line 38-42 filters by `visibility = 'private' AND owner_user_id = ?`. Test `test_private_takes_priority` verifies. |\n| Falls back to shared if no private match | PASS | Second query on line 52-56 filters by `visibility = 'shared'`. Test `test_falls_back_to_shared` verifies. |\n| Returns error when neither exists (except Inbox auto-created) | PASS | `ProjectNotFoundError` raised on line 84. Inbox auto-created on lines 66-81. Tests `test_unknown_project_error` and `test_inbox_auto_created` verify. |\n| Returns project row with id, name, visibility, owner_user_id | PASS | `Project` dataclass on lines 17-23 with all four fields. All tests assert on these fields. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_private_takes_priority` | PASS -- creates both shared and private \"Work\", verifies private is returned for owner U1 |\n| `test_falls_back_to_shared` | PASS -- creates shared \"Team\" only, verifies shared returned for U1 |\n| `test_inbox_auto_created` | PASS -- deletes seeded Inbox, verifies auto-creation as shared with null owner |\n| `test_unknown_project_error` | PASS -- verifies `ProjectNotFoundError` raised with descriptive message |\n\nAll 4 required tests present and passing. 2 additional bonus tests (`test_inbox_already_exists`, `test_private_different_owner_not_matched`). 6 tests total.\n\n### Findings\n\n#### [Low] F1: Project name matching is case-sensitive\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 39-42\n- **Description**: The SQL queries use `WHERE name = ?` which is case-sensitive in SQLite by default (for ASCII). If a user types `/p work` but the project is named `Work`, it will not match. The PRD does not specify case-sensitivity behavior, so this is not a bug per se, but it could cause user confusion.\n- **Action**: Document the case-sensitive behavior. Consider adding `COLLATE NOCASE` in a future iteration if case-insensitive matching is desired.\n\n#### [Low] F2: Repeated `Project(id=row[0], ...)` construction pattern\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 44, 58, 76\n- **Description**: The same `Project(id=row[0], name=row[1], visibility=row[2], owner_user_id=row[3])` pattern appears three times. This could be extracted to a helper (e.g., `Project._from_row(row)` classmethod or a module-level `_row_to_project` function) to reduce duplication and ensure consistency if columns change.\n- **Action**: Optional refactor. Not blocking for M1.\n\n#### [Low] F3: `conn.commit()` called inside resolver for Inbox auto-creation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, line 71\n- **Description**: The resolver calls `conn.commit()` directly after the `INSERT OR IGNORE` for Inbox auto-creation. This commits any pending transaction state on the connection, which could be surprising if the caller has uncommitted changes. In the current codebase this is not an issue (resolver is called early in command handling), but it couples the resolver to transaction management.\n- **Action**: Consider whether the caller should be responsible for committing. For M1 this is acceptable since the auto-creation is a one-time idempotent operation.\n\n#### [Low] F4: No test for Inbox auto-creation when a private Inbox exists\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/tests/test_project_resolver.py`\n- **Description**: If a user has a private project named \"Inbox\", `resolve_project(conn, \"Inbox\", user_id)` will return the private project (step 1 matches). The auto-creation path (step 3) is only reached if neither private nor shared \"Inbox\" exists. This behavior is correct per the resolution order, but there is no test covering the scenario where a user has a private \"Inbox\" and the shared \"Inbox\" also exists -- the test should verify that the private one is returned.\n- **Action**: Add a test for this edge case in a follow-up.\n\n#### [Info] F5: `INSERT OR IGNORE` is the correct pattern for Inbox auto-creation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 67-70\n- `INSERT OR IGNORE` handles the race condition where two concurrent requests try to auto-create Inbox simultaneously. The `ux_projects_shared_name` unique index on `(name) WHERE visibility = 'shared'` ensures only one shared Inbox can exist. The subsequent `SELECT` on lines 72-75 guarantees we return the correct row regardless of whether this request or another one performed the insert. This is well-designed.\n\n#### [Info] F6: Bonus tests add good defensive coverage\n\n- `test_inbox_already_exists` verifies that the seeded Inbox (from V1 migration) resolves without triggering auto-creation.\n- `test_private_different_owner_not_matched` verifies that a private project owned by U2 is not visible to U1, correctly raising `ProjectNotFoundError`.\n\n#### [Info] F7: Coverage at 100%\n\n- All 31 statements in `project_resolver.py` are covered by the 6 tests. No untested branches.\n\n#### [Info] F8: Test fixture pattern is consistent with prior PRs\n\n- The `_load_v1` autouse fixture and `conn` fixture follow the same save-clear-restore pattern established in prior PRs. Good consistency.\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and follows the PRD resolution order exactly:\n\n- Three-step resolution (private -> shared -> Inbox auto-create) with clear fallthrough logic.\n- All SQL queries use parameterized placeholders (`?`), preventing SQL injection.\n- `Project` dataclass provides a typed result with the four required fields.\n- `ProjectNotFoundError` is a well-named custom exception with descriptive message.\n- Logging at debug level for each resolution path aids troubleshooting.\n- `INSERT OR IGNORE` handles concurrent Inbox auto-creation safely.\n- 100% test coverage with all 4 required tests and 2 valuable bonus tests.\n- The code is 85 lines total -- minimal and readable.\n\n**Verdict: APPROVE** -- no Critical or High findings. All Low findings are noted for follow-up.\n### Changed Files\n\n| File | Change | Lines |\n|------|--------|-------|\n| `src/openclaw_todo/dispatcher.py` | NEW | 116 |\n| `src/openclaw_todo/plugin.py` | MODIFIED | 33 |\n| `tests/test_dispatcher.py` | NEW | 152 |\n| `tests/test_plugin.py` | MODIFIED | 39 |\n\n### Architecture Overview\n\nThe dispatcher implements a two-level routing architecture:\n\n1. **Plugin layer** (`plugin.py`): Strips `/todo` prefix, returns USAGE for bare `/todo`, delegates remainder to `dispatch()`.\n2. **Dispatcher layer** (`dispatcher.py`): Parses the remainder via the parser, validates command name against `_VALID_COMMANDS`, opens a DB connection with migration, routes to the appropriate handler (or stub), and closes the connection in a `finally` block.\n3. **Project sub-routing**: `project` command delegates to `_dispatch_project()` which extracts the subcommand from `parsed.title_tokens` and routes to `project_<subcommand>` handlers in the registry.\n\n### Findings\n\n#### [Low] F1: Weak test assertion on stub handler (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/tests/test_dispatcher.py`, line 48\n- **Description**: The original assertion was:\n  ```python\n  assert \"not yet implemented\" in result.lower() or isinstance(result, str)\n  ```\n  The `isinstance(result, str)` clause makes this trivially true since `dispatch()` always returns `str`. The test does not actually verify that the stub handler was invoked -- any string return would pass.\n- **Fix applied**: Removed the `or isinstance(result, str)` fallback. The assertion now strictly verifies that the stub handler message is present:\n  ```python\n  assert \"not yet implemented\" in result.lower()\n  ```\n- **Impact**: Test now correctly fails if the stub handler message format changes or if a different code path is taken.\n\n#### [Low] F2: `_stub_handler` signature differs from `HandlerFn` type alias\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 17, 47\n- **Description**: The `HandlerFn` type alias is `Callable[[ParsedCommand, Connection, dict], str]` (3 args), but `_stub_handler` takes 4 args: `(command, parsed, conn, context)`. This works because `_stub_handler` is never registered directly in `_handlers` -- it is always called via a lambda wrapper in `_get_handler` (line 59) and `_dispatch_project` (line 115) that captures `command` via closure. However, the mismatch makes the code harder to follow at a glance.\n- **Action**: Consider refactoring `_stub_handler` to accept `(parsed, conn, context)` and derive the command name from `parsed.command`. Not blocking since the current approach is correct.\n\n#### [Low] F3: Long line in `_dispatch_project`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 115\n- **Description**: Line 115 is 116 characters, exceeding typical line length limits (88 for black, 100 for many projects). The lambda + `_handlers.get` + `_stub_handler` call is dense.\n- **Action**: Consider breaking into multiple lines for readability. Not blocking.\n\n#### [Low] F4: Global mutable `_handlers` dict shared across tests\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 54\n- **Description**: The `_handlers` dict is module-level mutable state. The test fixture `_clean_handlers` (test file line 22-28) correctly saves and restores it between tests. However, if the test suite were run in parallel (e.g., `pytest-xdist`), the shared state could cause flaky tests.\n- **Action**: For a single-process Slack plugin this is fine. Document the limitation if parallel test execution is ever introduced.\n\n#### [Info] F5: DB connection lifecycle is correct\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 86-94\n- The `dispatch()` function opens the DB connection *after* validating the command name (line 80-82 returns early for unknown commands without touching the DB). The connection is always closed in a `finally` block (line 94), ensuring no leaks even if handlers raise exceptions. This is good resource management.\n\n#### [Info] F6: Unknown commands do not open a DB connection\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 80-82\n- The `if command not in _VALID_COMMANDS` check returns before `_init_db()` is called. This avoids unnecessary DB initialization for typos and invalid commands. Good design.\n\n#### [Info] F7: Parse errors are caught and returned as user-facing messages\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 73-76\n- `ParseError` is caught and formatted as `f\"Parse error: {exc}\"`. The parser's error messages are descriptive (e.g., \"Invalid section: 'xyz'\") and do not leak internal details. This is appropriate for a Slack DM context.\n\n#### [Info] F8: Plugin entry-point correctly wired to dispatcher\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/plugin.py`\n- The `handle_message()` function now delegates to `dispatch()` instead of the previous placeholder response. The prefix matching logic is unchanged and still correct. The `db_path` parameter flows through to `dispatch()` for testability.\n\n#### [Info] F9: Schema import triggers migration registration\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 14\n- `import openclaw_todo.schema_v1 as _schema_v1` with `# noqa: F401` ensures the `@register` decorator in `schema_v1.py` runs at import time, populating the migration registry before any `migrate()` call. This is the correct pattern for the decorator-based migration system.\n\n#### [Info] F10: Test coverage is comprehensive\n\n- 20 dispatcher + plugin tests covering:\n  - All 7 non-project commands routed to stubs (parametrized)\n  - Custom handler registration and invocation\n  - All 3 project subcommands routed correctly\n  - Project with no subcommand returns usage\n  - Unknown project subcommand returns error\n  - Unknown top-level command returns error with usage\n  - Parse error propagation\n  - DB initialization with schema migration\n  - Plugin prefix matching (non-todo, todo, whitespace, bare /todo)\n\n### Code Quality Summary\n\nThe dispatcher implementation is clean, well-structured, and follows good design principles:\n\n- **Separation of concerns**: Plugin handles prefix matching; dispatcher handles parsing, validation, DB init, and routing. Each has a single responsibility.\n- **Resource safety**: DB connection opened late (only for valid commands) and closed in `finally`.\n- **Extensibility**: The `register_handler()` function provides a clean API for future command implementations to plug in without modifying the dispatcher.\n- **Defensive routing**: Unknown commands and parse errors return helpful user-facing messages without touching the DB or raising unhandled exceptions.\n- **Project sub-routing**: The `project_<subcommand>` naming convention with `replace('-', '_')` is a clean pattern for hyphenated subcommands.\n- **Test isolation**: The `_clean_handlers` autouse fixture properly saves and restores the handler registry between tests.\n\n**Verdict: APPROVE with one fix applied** -- the weak test assertion (Low, F1) has been strengthened. No Critical or High code quality issues found.\n\n---\n\n## Security Findings\n\n### [Low] S1: No SQL injection risk -- parameterized queries used throughout\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 38-42, 52-56\n- **Description**: All SQL queries use `?` parameter placeholders for user-supplied values (`name` and `sender_id`). The Inbox auto-creation on lines 67-75 uses hardcoded string literals only. No string interpolation or f-strings are used in any SQL statement.\n- **Severity**: Low (no risk found, noting for completeness)\n\n### [Low] S2: `name` parameter is not length-validated\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, line 27\n- **Description**: `resolve_project(conn, name, sender_id)` accepts arbitrarily long `name` strings. While SQLite handles this safely (TEXT has no inherent length limit), an extremely long name would result in unnecessary query execution against the database. The parser upstream (Issue #5) extracts project names from `/p <name>` tokens, and Slack limits message length to ~40,000 characters, providing transport-layer mitigation.\n- **Severity**: Low (mitigated by upstream constraints)\n- **Recommendation**: Consider adding a max-length check for project names in the parser or a future validation layer.\n\n### [Low] S3: Inbox auto-creation commits transaction implicitly\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, line 71\n- **Description**: `conn.commit()` inside the resolver commits all pending changes on the connection, not just the Inbox insert. If a future caller has uncommitted writes before calling `resolve_project`, those writes would be committed as a side effect. This is not exploitable but could lead to partial commits in error scenarios.\n- **Severity**: Low (no current exploit path; architectural concern)\n- **Recommendation**: Consider using a savepoint pattern (`SAVEPOINT` / `RELEASE`) for the Inbox auto-creation to isolate its transaction from any outer transaction.\n\n### [Info] S4: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `project_resolver.py` or `test_project_resolver.py`.\n\n### [Info] S5: No new dependencies introduced\n\n- The module uses only Python standard library (`sqlite3`, `dataclasses`, `logging`). No new entries in `pyproject.toml`.\n\n### [Info] S6: Authorization model is correctly scoped\n\n- The `sender_id` parameter is used correctly in the private-project query to scope visibility. User U1 cannot resolve another user's private projects. Test `test_private_different_owner_not_matched` explicitly verifies this isolation. The shared-project query correctly omits owner filtering, as shared projects are visible to all users.\n\n### Security Summary\n\nNo Critical, High, or Medium severity findings. The implementation has a minimal attack surface -- three read queries and one idempotent insert, all using parameterized queries. The authorization model (private scoped to sender, shared visible to all) is correctly implemented and tested. Three Low findings are noted for awareness but require no immediate action.\n### [Low] S1: User input reflected in error messages\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 76, 82, 110\n- **Description**: Three error paths echo user-supplied values back in responses:\n  - `f\"Parse error: {exc}\"` (line 76) -- parser error messages may contain raw user input\n  - `f\"Unknown command: '{command}'\\n{USAGE}\"` (line 82) -- the command name is user input\n  - `f\"Unknown project subcommand: '{sub}'\\n{PROJECT_USAGE}\"` (line 110) -- the subcommand is user input\n- **Severity**: Low. In the Slack DM context, Slack handles message escaping. The reflected values are single tokens (no spaces, limited characters after `split()` tokenization). No HTML/JS injection is possible in this context.\n- **Recommendation**: If the plugin ever serves responses in a web context (e.g., dashboard, webhook response viewer), sanitize reflected values. No fix needed for current Slack-only usage.\n\n### [Low] S2: No input length validation at dispatcher level\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 67\n- **Description**: `dispatch(text, ...)` accepts arbitrarily long strings, which flow to `parse()` for tokenization. Slack limits messages to approximately 40,000 characters, providing transport-layer mitigation.\n- **Severity**: Low (mitigated by Slack transport layer)\n- **Recommendation**: Consider adding a max-length guard in `handle_message()` if the plugin is ever exposed outside Slack.\n\n### [Low] S3: Handler exception propagation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 91-92\n- **Description**: If a registered handler raises an unhandled exception, it propagates up through `dispatch()`. The `finally` block ensures the DB connection is closed, but the exception itself is not caught. In the current architecture, the caller (`handle_message` in `plugin.py`) does not catch exceptions either, so an unhandled handler error would propagate to the gateway framework.\n- **Severity**: Low. The stub handlers cannot raise exceptions (they return strings). Future handler implementations should handle their own errors. A catch-all `except Exception` in `dispatch()` could provide defense-in-depth but would also mask bugs during development.\n- **Recommendation**: Consider adding a top-level exception handler in `dispatch()` that logs the error and returns a generic \"Internal error\" message, once real handlers are implemented. During development, letting exceptions propagate is acceptable.\n\n### [Info] S4: No SQL injection risk\n\n- The dispatcher does not execute any SQL directly. DB interaction is limited to `_init_db()` which calls `get_connection()` and `migrate()` -- both use hardcoded SQL or parameterized queries. User input flows through `ParsedCommand` fields to handlers, which are responsible for using parameterized queries.\n\n### [Info] S5: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `dispatcher.py`, `plugin.py`, or their test files.\n\n### [Info] S6: `db_path` parameter is configuration-controlled\n\n- The `db_path` parameter in `dispatch()` and `handle_message()` flows from the caller (gateway framework), not from user input. In tests, it comes from `tmp_path`. There is no code path where a user's message text influences the DB path.\n\n### [Info] S7: No new dependencies introduced\n\n- The dispatcher uses only Python standard library (`sqlite3`, `logging`, `typing`) plus internal modules (`db`, `migrations`, `parser`, `schema_v1`). No new entries in `pyproject.toml`.\n\n### Security Summary\n\nNo Critical or High severity findings. Three Low findings related to input reflection, length validation, and exception propagation are noted. The dispatcher has a minimal attack surface -- it validates commands against a whitelist, delegates parsing to the parser, and routes to registered handlers. The main security consideration for future work is ensuring that handler implementations use parameterized queries and handle their own exceptions gracefully.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Refactor**: Extract `Project(id=row[0], ...)` into a `_row_to_project(row)` helper or `Project.from_row(row)` classmethod to reduce the triple duplication.\n2. **Test coverage**: Add a test for the edge case where a user has a private \"Inbox\" project and the shared \"Inbox\" also exists, verifying the private one is returned.\n3. **Transaction safety**: Consider using `SAVEPOINT` / `RELEASE` for Inbox auto-creation instead of bare `conn.commit()` to avoid committing unrelated pending changes.\n4. **Case sensitivity**: Document that project name matching is case-sensitive. Consider `COLLATE NOCASE` if case-insensitive matching is desired in a future iteration.\n5. **Input validation**: Add a max-length check for project names in the parser or validation layer to prevent unnecessarily large queries.\n1. **Exception handling**: Add a top-level `try/except` in `dispatch()` that catches unexpected handler exceptions, logs them at error level, and returns a generic user-facing error message. Defer until real handlers are implemented.\n2. **Refactor `_stub_handler`**: Align `_stub_handler` signature with `HandlerFn` type alias by deriving the command name from `parsed.command` instead of passing it as a separate argument. This also eliminates the lambda wrappers in `_get_handler` and `_dispatch_project`.\n3. **Line length**: Break the long line 115 in `_dispatch_project` for readability.\n4. **Context typing**: Introduce a `TypedDict` or dataclass for the `context` parameter (e.g., `class DispatchContext(TypedDict): sender_id: str`) to enable static type checking.\n5. **Input length guard**: Add a max-length check (e.g., 5000 chars) in `handle_message()` as defense-in-depth against oversized inputs.\n", "numLines": 947, "startLine": 1, "totalLines": 947}}, "tool_use_id": "toolu_01MqsTPmutmaoi7p2KDmBZ7L", "_ts": "2026-02-20T19:25:33+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "offset": 940, "limit": 10}, "tool_use_id": "toolu_01H7yZ8HFDFbhEDPnTN45EAa", "_ts": "2026-02-20T19:25:39+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "offset": 940, "limit": 10}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "content": "4. **Case sensitivity**: Document that project name matching is case-sensitive. Consider `COLLATE NOCASE` if case-insensitive matching is desired in a future iteration.\n5. **Input validation**: Add a max-length check for project names in the parser or validation layer to prevent unnecessarily large queries.\n1. **Exception handling**: Add a top-level `try/except` in `dispatch()` that catches unexpected handler exceptions, logs them at error level, and returns a generic user-facing error message. Defer until real handlers are implemented.\n2. **Refactor `_stub_handler`**: Align `_stub_handler` signature with `HandlerFn` type alias by deriving the command name from `parsed.command` instead of passing it as a separate argument. This also eliminates the lambda wrappers in `_get_handler` and `_dispatch_project`.\n3. **Line length**: Break the long line 115 in `_dispatch_project` for readability.\n4. **Context typing**: Introduce a `TypedDict` or dataclass for the `context` parameter (e.g., `class DispatchContext(TypedDict): sender_id: str`) to enable static type checking.\n5. **Input length guard**: Add a max-length check (e.g., 5000 chars) in `handle_message()` as defense-in-depth against oversized inputs.\n", "numLines": 8, "startLine": 940, "totalLines": 947}}, "tool_use_id": "toolu_01H7yZ8HFDFbhEDPnTN45EAa", "_ts": "2026-02-20T19:25:39+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "old_string": "5. **Input length guard**: Add a max-length check (e.g., 5000 chars) in `handle_message()` as defense-in-depth against oversized inputs.", "new_string": "5. **Input length guard**: Add a max-length check (e.g., 5000 chars) in `handle_message()` as defense-in-depth against oversized inputs.\n\n---\n\n# PR #18 Review Notes -- Issue #6: /todo add command\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/006-cmd-add`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| Task inserted with correct project_id, section, due, status='open', created_by | PASS | `test_add_default_inbox` and `test_add_with_project_section_due` verify all fields in DB |\n| Assignees default to sender when no mentions | PASS | `test_add_assignee_defaults_to_sender` verifies `task_assignees` row matches sender |\n| Multiple mentions create multiple task_assignee rows | PASS | `test_add_multiple_assignees` verifies two rows inserted and present in response |\n| Private project + non-owner assignee returns warning and does NOT insert | PASS | `test_add_private_rejects_other_assignee` verifies warning message and zero task rows |\n| Non-existent project: `Inbox` auto-created; others return error | PASS | `test_add_default_inbox` uses seeded Inbox; `test_add_nonexistent_project_returns_error` verifies error |\n| Response format: `Added #<id> (<project>/<section>) due:<due\\|-> assignees:<mentions> -- <title>` | PASS | All happy-path tests assert on this format |\n| Event row written to `events` table | PASS | `test_event_logged` verifies actor, action, task_id, and JSON payload fields |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_add_default_inbox` | PASS |\n| `test_add_with_project_section_due` | PASS |\n| `test_add_private_rejects_other_assignee` | PASS |\n| `test_add_assignee_defaults_to_sender` | PASS |\n| `test_add_multiple_assignees` | PASS |\n\nAll 5 required tests present and passing. 5 additional tests (`test_add_private_allows_owner_assignee`, `test_event_logged`, `test_add_empty_title_returns_error`, `test_add_nonexistent_project_returns_error`, `test_add_due_clear_sentinel_stored_as_null`). 10 tests total.\n\n### Findings\n\n#### [Info] F1: No explicit transaction wrapping for multi-statement write\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-80\n- **Description**: The handler performs three sequential writes (task INSERT, assignee INSERTs, event INSERT) followed by a single `conn.commit()` at line 80. If any write after the task INSERT raises (e.g., duplicate assignee PK violation), partial writes remain uncommitted. SQLite's implicit rollback-on-close in the dispatcher's `finally` block protects data integrity.\n- **Action**: Consider wrapping in `with conn:` (context manager) for explicit transaction semantics in a future refactor. No functional bug today.\n\n#### [Info] F2: Missing `sender_id` key would raise unhandled KeyError\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 22\n- **Description**: `context[\"sender_id\"]` raises `KeyError` if the key is absent. The dispatcher contract requires `sender_id` in context, so this is defensive-coding territory.\n- **Action**: Acceptable. Could be improved with `.get()` + early return, but low priority given the documented contract.\n\n#### [Info] F3: Test gap -- non-owner sender adding to another user's private project\n\n- **File**: `tests/test_cmd_add.py`\n- **Description**: No test covers the case where sender U2 tries to add a task to a private project owned by U1. The `resolve_project()` function would return `ProjectNotFoundError` (it only matches private projects of the sender), which is correct behavior. However, there is no explicit test verifying this path through `add_handler`.\n- **Action**: Follow-up item. Add a test for \"non-owner sender cannot resolve another user's private project.\"\n\n#### [Info] F4: Title length is unbounded\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 23\n- **Description**: No max-length check on `title`. Slack messages cap at ~4000 chars, providing natural limits. The DB column is `TEXT NOT NULL` with no length constraint.\n- **Action**: Consider adding a max-length check if the handler is exposed outside Slack.\n\n#### [Info] F5: Dispatcher test correctly updated\n\n- **File**: `tests/test_dispatcher.py`, lines 34-51\n- **Description**: The parametrized stub test removed `\"add\"` from the stub-check list and added a dedicated `test_add_routes_to_handler` test that asserts `\"Added #\"` in the result. This correctly reflects that `add` is no longer a stub.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and correct:\n\n- Uses `resolve_project()` for project resolution following PRD Option A (private-first).\n- Private assignee validation correctly rejects non-owner assignees with a descriptive warning.\n- All SQL uses parameterized queries (`?` placeholders).\n- Event payload is well-structured JSON with title, project, section, due, and assignees.\n- Response format matches the PRD/UX spec exactly.\n- 10 tests with thorough assertions on both the response string and DB state.\n- No unnecessary complexity or over-engineering.\n\n**Verdict: APPROVE** -- no blocking issues. No fixes required.\n\n---\n\n## Security Findings\n\n### [Info] S1: SQL injection -- No risk\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-78\n- **Description**: All three SQL statements (task INSERT, assignee INSERT, event INSERT) use `?` parameter placeholders. No string interpolation or f-strings in SQL. Title, project_id, section, due, sender_id, and assignee values are all passed as parameters.\n- **Severity**: Info (no risk found)\n\n### [Info] S2: Authorization model is sound\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 41-49\n- **Description**: Private project constraint correctly checks that all assignees match the project owner. The `resolve_project()` function provides implicit access control by only resolving the sender's own private projects (scoped by `owner_user_id = sender_id` in the SQL query). A non-owner sender cannot resolve another user's private project by name. The explicit assignee check in `cmd_add.py` is an additional layer for when the owner assigns tasks to others within their private project.\n- **Severity**: Info (no bypass possible)\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in any changed files.\n\n### [Info] S4: No new dependencies introduced\n\n- `cmd_add.py` uses only standard library (`json`, `logging`, `sqlite3`) plus internal modules (`parser`, `project_resolver`). No new entries in `pyproject.toml`.\n\n### [Info] S5: Input validation adequate\n\n- Empty title returns error (line 25-26).\n- Non-existent project returns error via `ProjectNotFoundError` (lines 30-33).\n- Section validation handled by parser upstream (`VALID_SECTIONS` check).\n- Due date validation handled by parser upstream (`_normalise_due`).\n- Mention format constrained by parser regex (`<@U[A-Z0-9]+>`).\n\n### Security Summary\n\nNo Critical, High, Medium, or Low severity findings. The implementation has a minimal attack surface -- three parameterized INSERT statements, project resolution with sender-scoped authorization, and input validation at both the parser and handler layers. The code is secure for the current Slack DM context.\n\n---\n\n## Follow-up Items\n\n1. **Test coverage**: Add a test for non-owner sender attempting to add a task to another user's private project (should get `ProjectNotFoundError` via resolver).\n2. **Transaction explicitness**: Consider wrapping the three DB writes in `with conn:` for explicit transaction semantics.\n3. **Title length**: Consider adding a max-length validation (e.g., 500 chars) as defense-in-depth.\n4. **Permissions module**: When Issue #17 (permissions helper) is merged, consider extracting the inline private-assignee validation to use the shared `validate_private_assignees()` function.", "replace_all": false}, "tool_use_id": "toolu_01FRenboYGGM7oXs1ekBeM3H", "_ts": "2026-02-20T19:26:31+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "old_string": "5. **Input length guard**: Add a max-length check (e.g., 5000 chars) in `handle_message()` as defense-in-depth against oversized inputs.", "new_string": "5. **Input length guard**: Add a max-length check (e.g., 5000 chars) in `handle_message()` as defense-in-depth against oversized inputs.\n\n---\n\n# PR #18 Review Notes -- Issue #6: /todo add command\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/006-cmd-add`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| Task inserted with correct project_id, section, due, status='open', created_by | PASS | `test_add_default_inbox` and `test_add_with_project_section_due` verify all fields in DB |\n| Assignees default to sender when no mentions | PASS | `test_add_assignee_defaults_to_sender` verifies `task_assignees` row matches sender |\n| Multiple mentions create multiple task_assignee rows | PASS | `test_add_multiple_assignees` verifies two rows inserted and present in response |\n| Private project + non-owner assignee returns warning and does NOT insert | PASS | `test_add_private_rejects_other_assignee` verifies warning message and zero task rows |\n| Non-existent project: `Inbox` auto-created; others return error | PASS | `test_add_default_inbox` uses seeded Inbox; `test_add_nonexistent_project_returns_error` verifies error |\n| Response format: `Added #<id> (<project>/<section>) due:<due\\|-> assignees:<mentions> -- <title>` | PASS | All happy-path tests assert on this format |\n| Event row written to `events` table | PASS | `test_event_logged` verifies actor, action, task_id, and JSON payload fields |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_add_default_inbox` | PASS |\n| `test_add_with_project_section_due` | PASS |\n| `test_add_private_rejects_other_assignee` | PASS |\n| `test_add_assignee_defaults_to_sender` | PASS |\n| `test_add_multiple_assignees` | PASS |\n\nAll 5 required tests present and passing. 5 additional tests (`test_add_private_allows_owner_assignee`, `test_event_logged`, `test_add_empty_title_returns_error`, `test_add_nonexistent_project_returns_error`, `test_add_due_clear_sentinel_stored_as_null`). 10 tests total.\n\n### Findings\n\n#### [Info] F1: No explicit transaction wrapping for multi-statement write\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-80\n- **Description**: The handler performs three sequential writes (task INSERT, assignee INSERTs, event INSERT) followed by a single `conn.commit()` at line 80. If any write after the task INSERT raises (e.g., duplicate assignee PK violation), partial writes remain uncommitted. SQLite's implicit rollback-on-close in the dispatcher's `finally` block protects data integrity.\n- **Action**: Consider wrapping in `with conn:` (context manager) for explicit transaction semantics in a future refactor. No functional bug today.\n\n#### [Info] F2: Missing `sender_id` key would raise unhandled KeyError\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 22\n- **Description**: `context[\"sender_id\"]` raises `KeyError` if the key is absent. The dispatcher contract requires `sender_id` in context, so this is defensive-coding territory.\n- **Action**: Acceptable. Could be improved with `.get()` + early return, but low priority given the documented contract.\n\n#### [Info] F3: Test gap -- non-owner sender adding to another user's private project\n\n- **File**: `tests/test_cmd_add.py`\n- **Description**: No test covers the case where sender U2 tries to add a task to a private project owned by U1. The `resolve_project()` function would return `ProjectNotFoundError` (it only matches private projects of the sender), which is correct behavior. However, there is no explicit test verifying this path through `add_handler`.\n- **Action**: Follow-up item. Add a test for \"non-owner sender cannot resolve another user's private project.\"\n\n#### [Info] F4: Title length is unbounded\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 23\n- **Description**: No max-length check on `title`. Slack messages cap at ~4000 chars, providing natural limits. The DB column is `TEXT NOT NULL` with no length constraint.\n- **Action**: Consider adding a max-length check if the handler is exposed outside Slack.\n\n#### [Info] F5: Dispatcher test correctly updated\n\n- **File**: `tests/test_dispatcher.py`, lines 34-51\n- **Description**: The parametrized stub test removed `\"add\"` from the stub-check list and added a dedicated `test_add_routes_to_handler` test that asserts `\"Added #\"` in the result. This correctly reflects that `add` is no longer a stub.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and correct:\n\n- Uses `resolve_project()` for project resolution following PRD Option A (private-first).\n- Private assignee validation correctly rejects non-owner assignees with a descriptive warning.\n- All SQL uses parameterized queries (`?` placeholders).\n- Event payload is well-structured JSON with title, project, section, due, and assignees.\n- Response format matches the PRD/UX spec exactly.\n- 10 tests with thorough assertions on both the response string and DB state.\n- No unnecessary complexity or over-engineering.\n\n**Verdict: APPROVE** -- no blocking issues. No fixes required.\n\n---\n\n## Security Findings\n\n### [Info] S1: SQL injection -- No risk\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-78\n- **Description**: All three SQL statements (task INSERT, assignee INSERT, event INSERT) use `?` parameter placeholders. No string interpolation or f-strings in SQL. Title, project_id, section, due, sender_id, and assignee values are all passed as parameters.\n- **Severity**: Info (no risk found)\n\n### [Info] S2: Authorization model is sound\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 41-49\n- **Description**: Private project constraint correctly checks that all assignees match the project owner. The `resolve_project()` function provides implicit access control by only resolving the sender's own private projects (scoped by `owner_user_id = sender_id` in the SQL query). A non-owner sender cannot resolve another user's private project by name. The explicit assignee check in `cmd_add.py` is an additional layer for when the owner assigns tasks to others within their private project.\n- **Severity**: Info (no bypass possible)\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in any changed files.\n\n### [Info] S4: No new dependencies introduced\n\n- `cmd_add.py` uses only standard library (`json`, `logging`, `sqlite3`) plus internal modules (`parser`, `project_resolver`). No new entries in `pyproject.toml`.\n\n### [Info] S5: Input validation adequate\n\n- Empty title returns error (line 25-26).\n- Non-existent project returns error via `ProjectNotFoundError` (lines 30-33).\n- Section validation handled by parser upstream (`VALID_SECTIONS` check).\n- Due date validation handled by parser upstream (`_normalise_due`).\n- Mention format constrained by parser regex (`<@U[A-Z0-9]+>`).\n\n### Security Summary\n\nNo Critical, High, Medium, or Low severity findings. The implementation has a minimal attack surface -- three parameterized INSERT statements, project resolution with sender-scoped authorization, and input validation at both the parser and handler layers. The code is secure for the current Slack DM context.\n\n---\n\n## Follow-up Items\n\n1. **Test coverage**: Add a test for non-owner sender attempting to add a task to another user's private project (should get `ProjectNotFoundError` via resolver).\n2. **Transaction explicitness**: Consider wrapping the three DB writes in `with conn:` for explicit transaction semantics.\n3. **Title length**: Consider adding a max-length validation (e.g., 500 chars) as defense-in-depth.\n4. **Permissions module**: When Issue #17 (permissions helper) is merged, consider extracting the inline private-assignee validation to use the shared `validate_private_assignees()` function.", "replace_all": false}, "tool_response": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "oldString": "5. **Input length guard**: Add a max-length check (e.g., 5000 chars) in `handle_message()` as defense-in-depth against oversized inputs.", "newString": "5. **Input length guard**: Add a max-length check (e.g., 5000 chars) in `handle_message()` as defense-in-depth against oversized inputs.\n\n---\n\n# PR #18 Review Notes -- Issue #6: /todo add command\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/006-cmd-add`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| Task inserted with correct project_id, section, due, status='open', created_by | PASS | `test_add_default_inbox` and `test_add_with_project_section_due` verify all fields in DB |\n| Assignees default to sender when no mentions | PASS | `test_add_assignee_defaults_to_sender` verifies `task_assignees` row matches sender |\n| Multiple mentions create multiple task_assignee rows | PASS | `test_add_multiple_assignees` verifies two rows inserted and present in response |\n| Private project + non-owner assignee returns warning and does NOT insert | PASS | `test_add_private_rejects_other_assignee` verifies warning message and zero task rows |\n| Non-existent project: `Inbox` auto-created; others return error | PASS | `test_add_default_inbox` uses seeded Inbox; `test_add_nonexistent_project_returns_error` verifies error |\n| Response format: `Added #<id> (<project>/<section>) due:<due\\|-> assignees:<mentions> -- <title>` | PASS | All happy-path tests assert on this format |\n| Event row written to `events` table | PASS | `test_event_logged` verifies actor, action, task_id, and JSON payload fields |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_add_default_inbox` | PASS |\n| `test_add_with_project_section_due` | PASS |\n| `test_add_private_rejects_other_assignee` | PASS |\n| `test_add_assignee_defaults_to_sender` | PASS |\n| `test_add_multiple_assignees` | PASS |\n\nAll 5 required tests present and passing. 5 additional tests (`test_add_private_allows_owner_assignee`, `test_event_logged`, `test_add_empty_title_returns_error`, `test_add_nonexistent_project_returns_error`, `test_add_due_clear_sentinel_stored_as_null`). 10 tests total.\n\n### Findings\n\n#### [Info] F1: No explicit transaction wrapping for multi-statement write\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-80\n- **Description**: The handler performs three sequential writes (task INSERT, assignee INSERTs, event INSERT) followed by a single `conn.commit()` at line 80. If any write after the task INSERT raises (e.g., duplicate assignee PK violation), partial writes remain uncommitted. SQLite's implicit rollback-on-close in the dispatcher's `finally` block protects data integrity.\n- **Action**: Consider wrapping in `with conn:` (context manager) for explicit transaction semantics in a future refactor. No functional bug today.\n\n#### [Info] F2: Missing `sender_id` key would raise unhandled KeyError\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 22\n- **Description**: `context[\"sender_id\"]` raises `KeyError` if the key is absent. The dispatcher contract requires `sender_id` in context, so this is defensive-coding territory.\n- **Action**: Acceptable. Could be improved with `.get()` + early return, but low priority given the documented contract.\n\n#### [Info] F3: Test gap -- non-owner sender adding to another user's private project\n\n- **File**: `tests/test_cmd_add.py`\n- **Description**: No test covers the case where sender U2 tries to add a task to a private project owned by U1. The `resolve_project()` function would return `ProjectNotFoundError` (it only matches private projects of the sender), which is correct behavior. However, there is no explicit test verifying this path through `add_handler`.\n- **Action**: Follow-up item. Add a test for \"non-owner sender cannot resolve another user's private project.\"\n\n#### [Info] F4: Title length is unbounded\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 23\n- **Description**: No max-length check on `title`. Slack messages cap at ~4000 chars, providing natural limits. The DB column is `TEXT NOT NULL` with no length constraint.\n- **Action**: Consider adding a max-length check if the handler is exposed outside Slack.\n\n#### [Info] F5: Dispatcher test correctly updated\n\n- **File**: `tests/test_dispatcher.py`, lines 34-51\n- **Description**: The parametrized stub test removed `\"add\"` from the stub-check list and added a dedicated `test_add_routes_to_handler` test that asserts `\"Added #\"` in the result. This correctly reflects that `add` is no longer a stub.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and correct:\n\n- Uses `resolve_project()` for project resolution following PRD Option A (private-first).\n- Private assignee validation correctly rejects non-owner assignees with a descriptive warning.\n- All SQL uses parameterized queries (`?` placeholders).\n- Event payload is well-structured JSON with title, project, section, due, and assignees.\n- Response format matches the PRD/UX spec exactly.\n- 10 tests with thorough assertions on both the response string and DB state.\n- No unnecessary complexity or over-engineering.\n\n**Verdict: APPROVE** -- no blocking issues. No fixes required.\n\n---\n\n## Security Findings\n\n### [Info] S1: SQL injection -- No risk\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-78\n- **Description**: All three SQL statements (task INSERT, assignee INSERT, event INSERT) use `?` parameter placeholders. No string interpolation or f-strings in SQL. Title, project_id, section, due, sender_id, and assignee values are all passed as parameters.\n- **Severity**: Info (no risk found)\n\n### [Info] S2: Authorization model is sound\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 41-49\n- **Description**: Private project constraint correctly checks that all assignees match the project owner. The `resolve_project()` function provides implicit access control by only resolving the sender's own private projects (scoped by `owner_user_id = sender_id` in the SQL query). A non-owner sender cannot resolve another user's private project by name. The explicit assignee check in `cmd_add.py` is an additional layer for when the owner assigns tasks to others within their private project.\n- **Severity**: Info (no bypass possible)\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in any changed files.\n\n### [Info] S4: No new dependencies introduced\n\n- `cmd_add.py` uses only standard library (`json`, `logging`, `sqlite3`) plus internal modules (`parser`, `project_resolver`). No new entries in `pyproject.toml`.\n\n### [Info] S5: Input validation adequate\n\n- Empty title returns error (line 25-26).\n- Non-existent project returns error via `ProjectNotFoundError` (lines 30-33).\n- Section validation handled by parser upstream (`VALID_SECTIONS` check).\n- Due date validation handled by parser upstream (`_normalise_due`).\n- Mention format constrained by parser regex (`<@U[A-Z0-9]+>`).\n\n### Security Summary\n\nNo Critical, High, Medium, or Low severity findings. The implementation has a minimal attack surface -- three parameterized INSERT statements, project resolution with sender-scoped authorization, and input validation at both the parser and handler layers. The code is secure for the current Slack DM context.\n\n---\n\n## Follow-up Items\n\n1. **Test coverage**: Add a test for non-owner sender attempting to add a task to another user's private project (should get `ProjectNotFoundError` via resolver).\n2. **Transaction explicitness**: Consider wrapping the three DB writes in `with conn:` for explicit transaction semantics.\n3. **Title length**: Consider adding a max-length validation (e.g., 500 chars) as defense-in-depth.\n4. **Permissions module**: When Issue #17 (permissions helper) is merged, consider extracting the inline private-assignee validation to use the shared `validate_private_assignees()` function.", "originalFile": "# PR #2 Review Notes -- Issue #1: Plugin skeleton and entry point\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/001-plugin-skeleton`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `pyproject.toml` with Python >=3.11, pytest, pytest-cov dev deps | PASS | Correct. Uses `dependency-groups` (PEP 735) with hatchling backend. |\n| `src/openclaw_todo/__init__.py` exposes `__version__` | PASS | `__version__ = \"0.1.0\"` |\n| `handle_message(text: str, context: dict) -> str` entry point | PASS (minor note) | Return type is `str | None`, not `str`. The AC literally says `-> str` but `None` for ignored messages is the intended behavior per the next AC. Acceptable. |\n| Non-`/todo` messages silently ignored (returns `None`) | PASS | |\n| `uv sync && uv run pytest -q` passes | PASS | 4 tests, 100% coverage |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_ignores_non_todo_message` | PASS -- covers empty string, random text, `/todox` prefix-collision |\n| `test_dispatches_todo_prefix` | PASS -- verifies non-None response with subcommand text |\n\n### Findings\n\n#### [Info] Return type annotation mismatch with AC\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 12\n- The AC states `-> str` but the implementation is `-> str | None`. This is correct behavior (returning `None` for non-todo messages is explicitly required). The AC text is slightly imprecise; the code is right.\n- **Action**: None needed. Consider updating the AC wording if desired.\n\n#### [Info] `context` parameter unused\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 12\n- `context: dict` is accepted but never read in this skeleton. This is expected for M0 -- it will be used once the dispatcher (Issue #16) and DB commands are wired in.\n- **Action**: None. This is intentional scaffolding.\n\n#### [Info] Placeholder response includes raw user input\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 32\n- `f\"TODO command received: {remainder}\"` echoes back unescaped user input. This is a temporary placeholder (comment says \"will be replaced by dispatcher in Issue #16\"). In the current context (no HTML/web rendering, Slack DM only), this is not exploitable, but see Security Findings below.\n- **Action**: Track as part of Issue #16.\n\n#### [Info] Extra tests beyond AC requirements -- good\n\n- `test_todo_prefix_with_whitespace` and `test_todo_without_subcommand` are bonus tests covering whitespace handling and bare `/todo` usage message. Good coverage instinct.\n\n#### [Info] Version duplication\n\n- Version `0.1.0` appears in both `pyproject.toml` and `__init__.py`. Consider using `importlib.metadata` or dynamic versioning in a future issue to keep a single source of truth. Not a concern for M0.\n\n#### [Low] No type hints for `context` dict\n\n- `context: dict` is untyped (could be `dict[str, Any]` or a TypedDict). For M0 this is fine, but a `TypedDict` or dataclass should be introduced when the context shape solidifies.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and well-structured for a skeleton:\n\n- Prefix matching logic (`stripped == _TODO_PREFIX or stripped.startswith(_TODO_PREFIX + \" \")`) correctly avoids false positives on `/todox`.\n- Logging at appropriate levels (debug for all messages, info for matches).\n- Usage help returned for bare `/todo` is a nice touch.\n- Test coverage is 100%.\n\n**Verdict: APPROVE** -- no blocking issues.\n\n---\n\n## Security Findings\n\n### [Low] S1: User input echoed in placeholder response\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 32\n- **Description**: The placeholder `f\"TODO command received: {remainder}\"` reflects user-supplied text without sanitization. In the current Slack DM context, Slack handles rendering and this is not exploitable for XSS. However, once a web dashboard or logging UI is introduced, unsanitized echo could become a reflected XSS vector.\n- **Severity**: Low (Slack auto-escapes; placeholder will be replaced in Issue #16)\n- **Recommendation**: When building the real dispatcher, ensure any user text echoed in responses is sanitized if it ever reaches a web context. No fix needed now.\n\n### [Low] S2: No input length validation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 12\n- **Description**: `handle_message` accepts arbitrarily long strings. A malicious or buggy client could send extremely large messages. Slack itself limits messages to ~40,000 characters, so this is mitigated at the transport layer.\n- **Severity**: Low\n- **Recommendation**: Consider adding a max-length guard in the dispatcher (Issue #16) if the plugin is ever exposed outside Slack.\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in any reviewed files. Environment variable approach is correctly deferred to future DB/config work.\n\n### [Info] S4: Dependencies are minimal and current\n\n- Only dev dependencies: `pytest>=7.0` and `pytest-cov>=4.0`. No known CVEs for these versions. No runtime dependencies beyond the standard library.\n- Build backend `hatchling` is a well-maintained, standard tool.\n\n### [Info] S5: No SQL, no deserialization, no file I/O\n\n- The M0 skeleton has no database, no file operations, and no deserialization. The attack surface is effectively zero at this stage.\n\n### Security Summary\n\nNo Critical or High severity findings. The codebase has a minimal attack surface appropriate for a plugin skeleton. Security considerations will become relevant starting with Issue #2 (DB connection) and Issue #5 (parser with user-controlled input).\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Issue #16 (Dispatcher)**: When replacing the placeholder response, ensure user input is not echoed raw if the output context changes (e.g., web UI).\n2. **Future**: Introduce a `TypedDict` or dataclass for the `context` parameter to enforce shape and enable static analysis.\n3. **Future**: Consolidate version to a single source (e.g., `importlib.metadata.version(\"openclaw-todo-plugin\")`).\n\n---\n\n# PR #4 Review Notes -- Issue #2: DB module -- connection helper and pragma setup\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/002-db-connection`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| Directory is created recursively when absent | PASS | `db_dir.mkdir(parents=True, exist_ok=True)` on line 32. Test `test_creates_directory_and_file` verifies nested `nested/dir/` creation. |\n| SQLite connection returned with WAL mode enabled | PASS | `PRAGMA journal_mode=WAL` on line 36. Test verifies `fetchone()[0] == \"wal\"`. |\n| `busy_timeout` is 3000 | PASS | `PRAGMA busy_timeout=3000` on line 37. Test verifies `fetchone()[0] == 3000`. |\n| Calling `get_connection` twice returns usable connections (no lock conflict) | PASS | `test_two_connections_no_conflict` creates a table via conn1, reads via conn2. WAL mode enables this concurrency. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `tests/test_db.py::test_creates_directory_and_file` | PASS -- verifies both `db_path.exists()` and `db_path.parent.exists()` with nested `tmp_path` |\n| `tests/test_db.py::test_wal_mode_enabled` | PASS -- queries `PRAGMA journal_mode` and asserts `\"wal\"` |\n| `tests/test_db.py::test_busy_timeout` | PASS -- queries `PRAGMA busy_timeout` and asserts `3000` |\n\n### Findings\n\n#### [Info] TOCTOU in `is_new` logging check\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 29\n- `is_new = not db_path.exists()` is checked before `sqlite3.connect()`, which itself creates the file. In a concurrent scenario, the file could appear between the check and the connect. This only affects which log message is emitted (info vs. debug) and has no functional impact.\n- **Action**: None required. Purely cosmetic race condition.\n\n#### [Info] PRAGMA return values not checked\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, lines 36-37\n- `conn.execute(\"PRAGMA journal_mode=WAL;\")` returns a result set with the actual journal mode applied. On some edge cases (e.g., read-only filesystem, in-memory DB), WAL activation can silently fall back to another mode. The code does not verify the return.\n- **Action**: Low priority. Consider adding a debug-level assertion or log warning in a future hardening pass. The test suite already validates WAL is active in the happy path.\n\n#### [Info] Default path uses `Path.home()`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 11\n- `DEFAULT_DB_DIR = Path.home() / \".openclaw\" / \"workspace\" / \".todo\"` is evaluated at module import time. If `HOME` is unset (e.g., certain containerized environments), `Path.home()` raises `RuntimeError`. This is acceptable since: (a) the default is only used when `db_path is None`, and (b) the plugin is designed for environments where `HOME` is set. Callers in containers should pass an explicit path.\n- **Action**: None for M1. Document the `db_path` parameter as the recommended override for non-standard environments.\n\n#### [Info] Extra test beyond AC requirements -- good\n\n- `test_two_connections_no_conflict` is a bonus test that exercises concurrent WAL access. This directly validates the 4th acceptance criterion and is well-structured with proper cleanup in a `finally` block.\n\n#### [Low] Test cleanup uses `try/finally` instead of a fixture\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_db.py`, all tests\n- Each test manually opens a connection and closes it in `try/finally`. A pytest fixture (e.g., `@pytest.fixture` yielding the connection) would reduce boilerplate and guarantee cleanup even if assertion lines are added later. This is a minor style observation for 4 tests.\n- **Action**: Optional refactor. Not blocking.\n\n#### [Info] Coverage at 96%\n\n- Line 24 (`db_path = DEFAULT_DB_DIR / DEFAULT_DB_NAME`) is uncovered because all tests pass explicit `tmp_path` paths. This is correct -- testing the default path would write to the user's actual home directory. The uncovered line is trivial assignment logic.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and correct:\n\n- Function signature `get_connection(db_path: str | Path | None = None)` is flexible, accepting string, Path, or None.\n- `Path(db_path)` normalization on line 26 handles string inputs.\n- `exist_ok=True` on `mkdir` prevents race conditions with concurrent directory creation.\n- Logging at appropriate levels: `info` for creation, `debug` for opens.\n- No unnecessary dependencies -- uses only stdlib `sqlite3`, `pathlib`, and `logging`.\n- 96% test coverage with all acceptance criteria verified.\n\n**Verdict: APPROVE** -- no blocking issues.\n\n---\n\n## Security Findings\n\n### [Low] S1: `db_path` parameter accepts arbitrary filesystem paths\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 15\n- **Description**: `get_connection(db_path)` will create directories and an SQLite database at any filesystem path the process has write access to. If a future caller passes unsanitized user input as `db_path`, this could be used for arbitrary file creation (e.g., path traversal via `../../etc/cron.d/evil`).\n- **Severity**: Low (currently an internal API; no user-facing code path passes user input to `db_path`)\n- **Recommendation**: When wiring `db_path` into the dispatcher (Issue #16), ensure the path comes only from configuration (env var or config file), never from user-controlled message text. Consider adding a validation that `db_path` is within an expected base directory.\n\n### [Info] S2: No SQL injection risk\n\n- PRAGMA statements on lines 36-37 use hardcoded string literals with no interpolation. The `db_path` is passed to `sqlite3.connect()` as a filesystem path, not as a SQL query. No injection surface exists.\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `db.py` or `test_db.py`. The module uses only stdlib.\n\n### [Info] S4: No new dependencies introduced\n\n- This module uses only Python standard library (`sqlite3`, `pathlib`, `logging`). No new entries in `pyproject.toml` dependencies. Zero additional attack surface from third-party code.\n\n### [Info] S5: SQLite WAL mode is a security-positive choice\n\n- WAL mode improves concurrent access safety and reduces the risk of database corruption from concurrent writes. The `busy_timeout=3000` prevents immediate lock failures, which could otherwise cause data loss if a caller does not handle `sqlite3.OperationalError` properly.\n\n### Security Summary\n\nNo Critical or High severity findings. The attack surface is minimal -- a single function that creates a local SQLite database with hardcoded pragmas. The only surface to monitor is ensuring `db_path` remains configuration-controlled as the codebase grows.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Issue #3 (Migration framework)**: When implementing migrations, ensure SQL statements use parameterized queries (not string formatting) for any dynamic values. The migration runner should validate migration callables are from a trusted registry.\n2. **Future**: Add a pytest fixture for `get_connection` that yields and auto-closes, reducing `try/finally` boilerplate across DB-related test files.\n3. **Future**: Consider adding a `validate_db_path(path)` helper that constrains paths to an allowed base directory, for defense-in-depth when the dispatcher wires in configuration.\n\n---\n\n# PR #6 Review Notes -- Issue #3: Schema migration framework and schema_version table\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/003-schema-migration`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `schema_version` table created with single row `version=0` if absent | PASS | `_ensure_version_table` uses `CREATE TABLE IF NOT EXISTS` and inserts `version=0` only when no row exists (line 30-31). |\n| Migrations are Python callables registered in an ordered list | PASS | `_migrations: list[MigrationFn]` with `@register` decorator appending to the list. Index maps directly to migration version. |\n| Each migration runs inside a transaction; version incremented on success | PASS | `conn.commit()` after each successful migration (line 65). SQLite's implicit transaction wraps the migration + version update. |\n| Re-running on an up-to-date DB is a no-op | PASS | `current >= target` guard on line 52 returns immediately. Test `test_idempotent_on_rerun` verifies. |\n| Failing migration rolls back and raises with clear message | PASS | `conn.rollback()` in `except` block (line 67). `RuntimeError` with formatted message including version number and original exception (line 68-70). |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_fresh_db_gets_version_table` | PASS -- verifies `get_version` returns 0 and `schema_version` table exists in `sqlite_master` |\n| `test_applies_migrations_sequentially` | PASS -- registers two migrations, asserts final version is 2, verifies both tables created |\n| `test_idempotent_on_rerun` | PASS -- calls `migrate` twice, both return 1, no errors |\n| `test_rollback_on_failure` | PASS -- first migration commits (version 1, `t_ok` exists), second raises `ValueError`, caught as `RuntimeError`, version stays at 1 |\n\n### Findings\n\n#### [Medium] No constraint preventing multiple rows in `schema_version`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- The `schema_version` table is created with `(version INTEGER NOT NULL)` but has no PRIMARY KEY, UNIQUE constraint, or CHECK constraint limiting it to a single row. If a bug or manual intervention inserts a second row, `get_version` would return whichever row SQLite returns first from `SELECT version FROM schema_version` (non-deterministic without ORDER BY).\n- **Action**: Consider adding a single-row constraint in a future migration (e.g., `CHECK (rowid = 1)` or a dummy `id INTEGER PRIMARY KEY CHECK (id = 1)` column). Not blocking for M1 since all writes go through `_ensure_version_table` which correctly checks before inserting.\n\n#### [Low] Redundant `_ensure_version_table` calls\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, lines 48-49\n- `migrate()` calls `_ensure_version_table(conn)` on line 48, then calls `get_version(conn)` on line 49, which internally calls `_ensure_version_table` again. This results in two `CREATE TABLE IF NOT EXISTS` and two `SELECT version` queries on every `migrate` call.\n- **Action**: Minor performance concern. Could be refactored so `migrate` calls `_ensure_version_table` once and reads the version directly. Not blocking.\n\n#### [Info] Global mutable state for migrations registry\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 15\n- `_migrations` is a module-level mutable list. This is a common pattern for migration registries and works well for single-process applications. The test suite correctly saves/restores it via the `_clean_migrations` autouse fixture (lines 16-23 in test file).\n- **Action**: None. This is an appropriate pattern for this use case. If multi-process or plugin-based architectures are introduced later, consider a class-based registry.\n\n#### [Info] Test fixture properly isolates migration state\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_migrations.py`, lines 16-23\n- The `_clean_migrations` fixture saves the original list, clears it before each test, and restores it after. This prevents test pollution and is correctly marked `autouse=True`. The save-clear-yield-clear-extend pattern is the correct idiom.\n\n#### [Info] `conn` fixture uses `get_connection` from `db` module\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_migrations.py`, lines 27-31\n- The test fixture uses `get_connection` (from Issue #2) rather than raw `sqlite3.connect`. This ensures WAL mode and `busy_timeout` pragmas are applied, matching production behavior. This is a good integration practice.\n\n#### [Info] Coverage at 100%\n\n- All 41 statements in `migrations.py` are covered by the 4 tests. No untested branches.\n\n#### [Info] Error message includes original exception\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, lines 68-70\n- `raise RuntimeError(...) from exc` preserves the exception chain, making debugging easier. The message format `\"Migration to version {N} failed: {exc}\"` clearly identifies which migration failed. This follows the acceptance criterion for \"clear message.\"\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and minimal:\n\n- The `@register` decorator pattern is intuitive for defining migrations in order.\n- Transaction semantics are correctly handled: commit on success, rollback on failure.\n- The version update uses a parameterized query (`?` placeholder on line 63), avoiding SQL injection.\n- Logging at appropriate levels: `info` for migration steps and completion, `debug` for up-to-date status.\n- The code correctly handles the edge case where `current > target` (e.g., if migrations are removed), treating it the same as up-to-date.\n- 100% test coverage with all four required tests present and passing.\n\n**Verdict: APPROVE** -- no blocking issues. One medium finding (missing single-row constraint) noted for follow-up.\n\n---\n\n## Security Findings\n\n### [Medium] S1: `schema_version` table lacks row-count constraint\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- **Description**: The `schema_version` table has no mechanism to enforce that exactly one row exists. While the application code only writes through `_ensure_version_table` (which checks before inserting) and `migrate` (which uses `UPDATE`), a direct SQL injection in a future module or manual DB editing could insert additional rows, causing `get_version` to return an unpredictable value. This could lead to migrations being skipped or re-applied.\n- **Severity**: Medium (requires either a separate SQL injection vulnerability or direct DB access to exploit; impact is schema corruption)\n- **Recommendation**: In the V1 schema migration (Issue #4), alter or recreate the table with a single-row constraint, e.g., `CREATE TABLE schema_version (id INTEGER PRIMARY KEY CHECK (id = 1), version INTEGER NOT NULL)`.\n\n### [Info] S2: No SQL injection risk in migration runner\n\n- All SQL in `migrations.py` uses either hardcoded string literals or parameterized queries (`?` on line 63 for the version update). The `MigrationFn` type receives a `Connection` object, and it is the responsibility of each registered migration to use parameterized queries. This is correctly documented in the PR #4 review follow-up.\n\n### [Info] S3: Migration functions are trusted code\n\n- The `@register` decorator appends arbitrary callables to the migration list. Since migrations are defined at module import time by the application developer (not by user input), there is no injection risk. The registry is not exposed to any user-facing API.\n\n### [Info] S4: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `migrations.py` or `test_migrations.py`.\n\n### [Info] S5: No new dependencies introduced\n\n- This module uses only Python standard library (`sqlite3`, `logging`, `typing`). No new entries in `pyproject.toml` dependencies.\n\n### [Info] S6: Exception message does not leak sensitive data\n\n- The `RuntimeError` message on line 69 includes the migration version number and the string representation of the original exception. In this context (local SQLite, no user-supplied data in migration functions), this does not leak sensitive information. If migrations ever process user data, the exception wrapping should be reviewed to avoid leaking PII in logs.\n\n### Security Summary\n\nNo Critical or High severity findings. One Medium finding regarding the missing single-row constraint on `schema_version`, which could lead to schema version confusion if combined with a separate vulnerability that allows arbitrary SQL execution. The recommendation is to address this in the Issue #4 V1 schema migration.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Issue #4 (V1 schema)**: Add a single-row constraint to `schema_version` (e.g., `CHECK (id = 1)` on a primary key column) as part of the V1 migration to prevent version-table corruption.\n2. **Future**: Refactor `migrate()` to avoid redundant `_ensure_version_table` calls for minor performance improvement.\n3. **Future**: Consider adding a `--dry-run` mode to the migration runner that reports which migrations would be applied without executing them, useful for deployment verification.\n\n---\n\n# PR #8 Review Notes -- Issue #4: V1 schema migration -- projects, tasks, task_assignees, events\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/004-v1-schema`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `projects` table with `ux_projects_shared_name` and `ux_projects_private_owner_name` partial unique indexes | PASS | Table created on lines 18-26, indexes on lines 28-36 of `schema_v1.py`. Partial `WHERE` clauses match PRD exactly. |\n| `tasks` table with section and status CHECK constraints | PASS | Section CHECK on line 43 (`backlog, doing, waiting, done, drop`), status CHECK on line 45 (`open, done, dropped`). Both match PRD spec. |\n| `task_assignees` table with composite PK and secondary index | PASS | Composite `PRIMARY KEY (task_id, assignee_user_id)` on line 57, secondary index `ix_task_assignees_user` on lines 61-64. |\n| `events` audit table created | PASS | Table on lines 66-75. Columns match PRD. |\n| Shared `Inbox` project auto-created (INSERT OR IGNORE) | PASS | Line 78-81 uses `INSERT OR IGNORE` with `('Inbox', 'shared', NULL)`. |\n| `schema_version` = 1 after migration | PASS | Test `test_v1_schema_version` verifies `get_version(conn) == 1`. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_v1_tables_exist` | PASS -- verifies all four tables exist in `sqlite_master` |\n| `test_v1_inbox_created` | PASS -- verifies name='Inbox', visibility='shared', owner_user_id=None |\n| `test_v1_shared_unique_index_enforced` | PASS -- duplicate shared name raises `IntegrityError` |\n| `test_v1_private_unique_index_enforced` | PASS -- duplicate (owner, name) raises `IntegrityError`; different owner succeeds |\n\n### Findings\n\n#### [High] F1: Foreign keys not enforced -- `PRAGMA foreign_keys=ON` missing\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 35-37\n- **Description**: SQLite does not enforce `REFERENCES` (foreign key) clauses by default. The `PRAGMA foreign_keys=ON` must be executed on every new connection for FK constraints to be active. Without this, the `REFERENCES projects(id)` on `tasks.project_id` and `REFERENCES tasks(id)` on `task_assignees.task_id` are purely decorative -- you can insert tasks pointing to non-existent projects and assignees pointing to non-existent tasks.\n- **Impact**: Referential integrity is silently not enforced, leading to orphaned rows and data corruption.\n- **Fix applied**: Added `conn.execute(\"PRAGMA foreign_keys=ON;\")` to `get_connection()` in `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 38. All 19 tests pass after the fix.\n\n#### [Medium] F2: `schema_version` single-row constraint not added in V1\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- **Description**: The PR #6 review (Medium finding S1) recommended adding a single-row constraint to `schema_version` as part of the V1 migration. This was not addressed. The table still has no PK or CHECK constraint to prevent multiple rows.\n- **Action**: Should be addressed in a follow-up issue. Adding it retroactively in a later migration (e.g., V2) would require recreating the table since SQLite does not support `ALTER TABLE ADD CONSTRAINT`.\n\n#### [Low] F3: Minor PRD deviation on `events.ts` -- NOT NULL DEFAULT added\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/schema_v1.py`, line 69\n- **Description**: The PRD spec for `events.ts` says `ts TEXT` with no nullability or default constraint. The implementation adds `NOT NULL DEFAULT (datetime('now'))`. This is a sensible enhancement (audit timestamps should always be present), but it is a deviation from the spec.\n- **Action**: None needed. The implementation is better than the spec. Consider updating the PRD to match.\n\n#### [Low] F4: `events.id` uses AUTOINCREMENT, PRD says PK only\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/schema_v1.py`, line 68\n- **Description**: PRD says `id INTEGER PK` for the events table. The implementation uses `INTEGER PRIMARY KEY AUTOINCREMENT`. AUTOINCREMENT prevents rowid reuse after deletion, which is actually preferable for an audit log (guarantees monotonically increasing IDs). This is a minor deviation but a positive one.\n- **Action**: None needed. Consider updating the PRD.\n\n#### [Low] F5: No test for `task_assignees` composite PK enforcement\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_schema_v1.py`\n- **Description**: The acceptance criteria mention `task_assignees` table with composite PK, but there is no test verifying that inserting a duplicate `(task_id, assignee_user_id)` pair raises `IntegrityError`. The composite PK is created, but its enforcement is untested.\n- **Action**: Add a test in a follow-up to insert a duplicate pair and assert `IntegrityError`.\n\n#### [Low] F6: No test for foreign key enforcement\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_schema_v1.py`\n- **Description**: No test verifies that inserting a task with a non-existent `project_id` raises an error, or that inserting a `task_assignee` with a non-existent `task_id` raises an error. With the FK pragma fix (F1), these would now fail correctly, but there is no test coverage for this behavior.\n- **Action**: Add FK enforcement tests in a follow-up.\n\n#### [Info] F7: Test fixture pattern is well-structured\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_schema_v1.py`, lines 11-25\n- The `_load_v1_migration` autouse fixture correctly saves, clears, imports, and restores the migration registry. The `conn` fixture properly creates a temp DB, migrates, yields, and closes. This is clean test isolation.\n\n#### [Info] F8: CHECK constraint tests are thorough\n\n- Tests `test_v1_section_check_constraint` and `test_v1_status_check_constraint` go beyond the required tests to verify that invalid enum values are rejected. Good defensive testing.\n\n#### [Info] F9: 8 tests total for V1 schema, all passing\n\n- `test_v1_tables_exist`, `test_v1_schema_version`, `test_v1_inbox_created`, `test_v1_shared_unique_index_enforced`, `test_v1_private_unique_index_enforced`, `test_v1_section_check_constraint`, `test_v1_status_check_constraint` (7 tests in `test_schema_v1.py`). Plus the rollback test verifies `conn.rollback()` is correctly called after each constraint violation test.\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and closely follows the PRD spec:\n\n- All four tables are created with the correct columns, types, and constraints.\n- Partial unique indexes use the correct `WHERE` clause syntax.\n- CHECK constraints enumerate exactly the values specified in the PRD.\n- `INSERT OR IGNORE` for the Inbox seed is idempotent.\n- Parameterized queries are not needed here (all DDL uses string literals with no interpolation).\n- The `@register` decorator integrates seamlessly with the migration framework from Issue #3.\n- Test coverage is good, with 7 tests covering table existence, version, seed data, unique indexes, and CHECK constraints.\n\n**Verdict: APPROVE with one fix applied** -- the `PRAGMA foreign_keys=ON` fix (High, F1) has been applied directly. Medium/Low findings are noted for follow-up.\n\n---\n\n## Security Findings\n\n### [High] S1: Foreign key constraints not enforced (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 35-37\n- **Description**: Without `PRAGMA foreign_keys=ON`, all `REFERENCES` clauses in the V1 schema are ignored. This means a future command handler could insert tasks referencing non-existent projects or assignees referencing non-existent tasks, leading to data integrity violations that are silent and hard to debug. In a multi-user Slack plugin, this could allow one user's actions to create orphaned records that cause errors for other users.\n- **Severity**: High (data integrity violation in a multi-user context; silent failure mode)\n- **Fix**: Added `conn.execute(\"PRAGMA foreign_keys=ON;\")` to `get_connection()`. All 19 tests pass.\n\n### [Medium] S2: `schema_version` table remains unprotected against multi-row corruption\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- **Description**: Carried forward from PR #6 review. The `schema_version` table has no constraint preventing insertion of additional rows. If a separate vulnerability allows arbitrary SQL execution, an attacker could manipulate the schema version to skip or re-run migrations.\n- **Severity**: Medium (requires a chained vulnerability to exploit)\n- **Recommendation**: Address in a future migration that recreates the table with a single-row constraint.\n\n### [Info] S3: No SQL injection risk in V1 migration\n\n- All SQL in `schema_v1.py` uses hardcoded string literals. No user input, no string interpolation, no parameterized queries needed. The `INSERT OR IGNORE` for the Inbox seed uses literal values only.\n\n### [Info] S4: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `schema_v1.py` or `test_schema_v1.py`.\n\n### [Info] S5: No new dependencies introduced\n\n- The V1 migration uses only Python standard library (`sqlite3`, `logging`). No new entries in `pyproject.toml`.\n\n### [Info] S6: CHECK constraints provide defense-in-depth\n\n- The `section` and `status` CHECK constraints on the `tasks` table prevent invalid enum values at the database level, not just the application level. This is a security-positive pattern that prevents data corruption even if the application layer has a bug.\n\n### Security Summary\n\nOne High severity finding (S1: missing `PRAGMA foreign_keys=ON`) was identified and fixed directly in `db.py`. One Medium finding (S2: `schema_version` single-row constraint) is carried forward from the previous review. No Critical findings.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Test coverage**: Add tests for `task_assignees` composite PK enforcement (duplicate pair should raise `IntegrityError`).\n2. **Test coverage**: Add tests for foreign key enforcement (task with non-existent `project_id`, assignee with non-existent `task_id` should raise `IntegrityError` now that FK pragma is enabled).\n3. **Schema version constraint**: Address the `schema_version` single-row constraint in a future migration (V2 or later) by recreating the table with `CHECK (id = 1)`.\n4. **PRD sync**: Update PRD section 6.3 to add `NOT NULL DEFAULT (datetime('now'))` to `events.ts` and `AUTOINCREMENT` to `events.id` to match the implementation.\n5. **DB module**: Add a test for `PRAGMA foreign_keys` returning `1` in `test_db.py` to prevent regression.\n\n---\n\n# PR #10 Review Notes -- Issue #5: Command parser -- tokenizer and option extraction\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/005-parser-tokenizer`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `/p MyProject` correctly extracted; token consumed | PASS | `test_extract_project` verifies project name extracted, `/p` and value removed from `title_tokens`. |\n| `/s doing` validated; invalid section raises `ParseError` | PASS | `test_extract_section_valid` and `test_extract_section_invalid` cover both paths. Case-insensitive via `.lower()`. |\n| `due:03-15` normalised to `2026-03-15` (current year) | PASS | `test_due_mm_dd_normalisation` verifies with `date.today().year`. |\n| `due:2026-02-30` raises `ParseError` (invalid date) | PASS | `test_due_invalid_date` asserts `ParseError` with match on \"Invalid due date\". |\n| `<@U12345>` extracted into mentions list | PASS | `test_mentions_extraction` verifies two mentions extracted and not in `title_tokens`. |\n| Multiple mentions supported | PASS | Same test covers two mentions in order. |\n| Title tokens are non-option, non-mention tokens before first option | PASS | `test_title_extraction` verifies correct split with mixed options. Note: title tokens are collected from *all* positions, not just \"before first option\" -- this is arguably more flexible than the AC wording. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_extract_project` | PASS |\n| `test_extract_section_valid` | PASS |\n| `test_extract_section_invalid` | PASS |\n| `test_due_mm_dd_normalisation` | PASS |\n| `test_due_full_date` | PASS |\n| `test_due_invalid_date` | PASS |\n| `test_due_clear` | PASS |\n| `test_mentions_extraction` | PASS |\n| `test_title_extraction` | PASS |\n\nAll 9 required tests present and passing. 4 additional bonus tests (`test_command_extraction`, `test_move_extracts_id_as_arg`, `test_empty_command_raises`, `test_section_case_insensitive`). 13 parser tests total.\n\n### Findings\n\n#### [Medium] F1: Leap-year bug in `_normalise_due` for MM-DD format (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 53-62 (after fix)\n- **Description**: The original implementation used `datetime.strptime(raw, \"%m-%d\")` which defaults to year 1900 (not a leap year). This caused `due:02-29` to always be rejected, even when the current year is a leap year (e.g., 2028). The `replace(year=current_year)` call was never reached because `strptime` itself raised `ValueError`.\n- **Fix applied**: Replaced `strptime(\"%m-%d\")` with a regex match `(\\d{1,2})-(\\d{1,2})` followed by direct `date(current_year, month, day)` construction. This correctly validates Feb 29 against the actual current year.\n- **Impact**: Without fix, `due:02-29` would fail in leap years (2028, 2032, etc.) when it should succeed.\n\n#### [Low] F2: Duplicate options silently use \"last wins\" semantics\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 91-117\n- **Description**: If a user provides `/p First /p Second`, the parser silently uses `Second`. Same for `/s` and `due:`. This is not necessarily wrong, but it is undocumented. \"Last wins\" is a reasonable default, but \"first wins\" or \"raise error on duplicate\" are also valid choices.\n- **Action**: Document the \"last wins\" behavior in the docstring or PRD. No code change needed.\n\n#### [Low] F3: `/p` and `/s` error paths (missing argument) are untested\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_parser.py`\n- **Description**: Lines 93 and 101 (`raise ParseError(\"/p requires a project name\")` and `/s` equivalent) are uncovered. Manual testing confirmed they work correctly, but automated test coverage is missing for these edge cases.\n- **Action**: Add tests for `parse(\"add task /p\")` and `parse(\"add task /s\")` in a follow-up.\n\n#### [Low] F4: `_DUE_RE` uses `.+` which accepts any characters after `due:`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, line 15\n- **Description**: `_DUE_RE = re.compile(r\"^due:(.+)$\")` will match `due:anything` and pass the value to `_normalise_due`. This is not a bug since `_normalise_due` properly validates the value, but a tighter regex like `r\"^due:([\\d-]+)$\"` would reject obviously invalid inputs earlier and serve as documentation of expected format.\n- **Action**: Optional tightening. Not blocking since validation is correct.\n\n#### [Low] F5: Title tokens are collected from all positions, not just \"before first option\"\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 126-128\n- **Description**: The AC says \"Title tokens are non-option, non-mention tokens before first option.\" The implementation collects title tokens from all positions (e.g., `add Buy /p Home milk` would produce `title_tokens=[\"Buy\", \"milk\"]`). This is actually more flexible and user-friendly, but deviates from the literal AC wording.\n- **Action**: Consider updating the AC to match the implementation. The current behavior is better for UX.\n\n#### [Info] F6: `args` extraction for `move/done/drop/edit` is well-designed\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 130-133\n- The pattern of extracting the first title token as `args[0]` for ID-based commands is clean and tested by `test_move_extracts_id_as_arg`.\n\n#### [Info] F7: Coverage at 97%\n\n- Lines 93 and 101 (error paths for missing `/p` and `/s` arguments) are uncovered. All other branches are tested. This is acceptable for M1.\n\n#### [Info] F8: Bonus tests add good defensive coverage\n\n- `test_section_case_insensitive` ensures `/s DOING` normalizes to `doing`.\n- `test_command_extraction` verifies the first token becomes the command.\n- `test_empty_command_raises` covers the empty input guard.\n- `test_move_extracts_id_as_arg` covers the args extraction logic.\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and well-structured:\n\n- The tokenizer loop with explicit index management (`while i < len(remaining)`) is readable and handles two-token options (`/p`, `/s`) cleanly by advancing `i` by 2.\n- `ParsedCommand` dataclass provides a clear, typed result structure.\n- `VALID_SECTIONS` as a `frozenset` is the right choice for O(1) membership testing.\n- `_MENTION_RE` uses `fullmatch` (not `match` or `search`), preventing partial matches on tokens like `<@U123>extra`.\n- Error messages are descriptive and include the invalid value with `repr()` formatting.\n- Logging at debug level for parsed results is appropriate.\n- 97% test coverage with all 9 required tests present and 4 bonus tests.\n\n**Verdict: APPROVE with one fix applied** -- the leap-year bug in `_normalise_due` (Medium, F1) has been fixed directly. Low findings are noted for follow-up.\n\n---\n\n## Security Findings\n\n### [Medium] S1: Leap-year date validation bypass (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, `_normalise_due`\n- **Description**: The original `strptime(\"%m-%d\")` approach silently rejected valid dates (`02-29` in leap years) due to the 1900 default year. While this is a correctness issue rather than a security vulnerability, incorrect date validation can lead to denial of service (users unable to set valid due dates) and data integrity issues (dates that should be accepted are rejected).\n- **Severity**: Medium (correctness bug with functional impact)\n- **Fix**: Replaced with regex-based month/day extraction and direct `date()` construction with the current year.\n\n### [Low] S2: No ReDoS risk in compiled regexes\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 14-15\n- **Description**: Both `_MENTION_RE = re.compile(r\"<@(U[A-Z0-9]+)>\")` and `_DUE_RE = re.compile(r\"^due:(.+)$\")` were tested with 100,000-character inputs and completed in under 0.1ms. Neither pattern contains nested quantifiers or alternation that could cause catastrophic backtracking.\n- **Severity**: Low (no risk found, noting for completeness)\n\n### [Low] S3: No input length validation on parser input\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, line 72\n- **Description**: `parse(text)` accepts arbitrarily long strings. `text.strip().split()` will allocate a token list proportional to input size. Slack limits messages to ~40,000 characters, mitigating this at the transport layer, but if the parser is used outside Slack, extremely long inputs could cause memory pressure.\n- **Severity**: Low (mitigated by Slack transport layer limits)\n- **Recommendation**: Consider adding a max-length guard in the plugin entry point (`handle_message`) rather than the parser itself.\n\n### [Info] S4: No injection risks\n\n- The parser only tokenizes and validates strings. No SQL, no shell commands, no template rendering. User input flows into `ParsedCommand` fields which are plain strings. Security depends on how these values are consumed downstream (e.g., parameterized queries when writing to SQLite).\n\n### [Info] S5: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `parser.py` or `test_parser.py`.\n\n### [Info] S6: No new dependencies introduced\n\n- The parser uses only Python standard library (`re`, `datetime`, `dataclasses`, `logging`). No new entries in `pyproject.toml`.\n\n### Security Summary\n\nNo Critical or High severity findings. One Medium finding (S1: leap-year date validation) was identified and fixed. The parser has a minimal attack surface -- it tokenizes strings and validates against known patterns. The main security consideration going forward is ensuring that `ParsedCommand` field values are used safely downstream (parameterized SQL queries, no raw echo in web contexts).\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Test coverage**: Add tests for `/p` and `/s` without arguments (lines 93, 101) to cover the missing-argument error paths.\n2. **Documentation**: Document \"last wins\" semantics for duplicate `/p`, `/s`, and `due:` options in the PRD or parser docstring.\n3. **Optional**: Tighten `_DUE_RE` from `.+` to `[\\d-]+` for earlier rejection of obviously invalid due values.\n4. **AC clarification**: Update Issue #5 AC to reflect that title tokens are collected from all positions (not just \"before first option\"), matching the implemented behavior.\n\n---\n\n# PR #12 Review Notes -- Issue #7: Project resolver helper\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/007-project-resolver`\n# PR #14 Review Notes -- Issue #16: Command dispatcher and routing\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature-016-dispatcher`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| Private project of sender matched first | PASS | Query on line 38-42 filters by `visibility = 'private' AND owner_user_id = ?`. Test `test_private_takes_priority` verifies. |\n| Falls back to shared if no private match | PASS | Second query on line 52-56 filters by `visibility = 'shared'`. Test `test_falls_back_to_shared` verifies. |\n| Returns error when neither exists (except Inbox auto-created) | PASS | `ProjectNotFoundError` raised on line 84. Inbox auto-created on lines 66-81. Tests `test_unknown_project_error` and `test_inbox_auto_created` verify. |\n| Returns project row with id, name, visibility, owner_user_id | PASS | `Project` dataclass on lines 17-23 with all four fields. All tests assert on these fields. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_private_takes_priority` | PASS -- creates both shared and private \"Work\", verifies private is returned for owner U1 |\n| `test_falls_back_to_shared` | PASS -- creates shared \"Team\" only, verifies shared returned for U1 |\n| `test_inbox_auto_created` | PASS -- deletes seeded Inbox, verifies auto-creation as shared with null owner |\n| `test_unknown_project_error` | PASS -- verifies `ProjectNotFoundError` raised with descriptive message |\n\nAll 4 required tests present and passing. 2 additional bonus tests (`test_inbox_already_exists`, `test_private_different_owner_not_matched`). 6 tests total.\n\n### Findings\n\n#### [Low] F1: Project name matching is case-sensitive\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 39-42\n- **Description**: The SQL queries use `WHERE name = ?` which is case-sensitive in SQLite by default (for ASCII). If a user types `/p work` but the project is named `Work`, it will not match. The PRD does not specify case-sensitivity behavior, so this is not a bug per se, but it could cause user confusion.\n- **Action**: Document the case-sensitive behavior. Consider adding `COLLATE NOCASE` in a future iteration if case-insensitive matching is desired.\n\n#### [Low] F2: Repeated `Project(id=row[0], ...)` construction pattern\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 44, 58, 76\n- **Description**: The same `Project(id=row[0], name=row[1], visibility=row[2], owner_user_id=row[3])` pattern appears three times. This could be extracted to a helper (e.g., `Project._from_row(row)` classmethod or a module-level `_row_to_project` function) to reduce duplication and ensure consistency if columns change.\n- **Action**: Optional refactor. Not blocking for M1.\n\n#### [Low] F3: `conn.commit()` called inside resolver for Inbox auto-creation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, line 71\n- **Description**: The resolver calls `conn.commit()` directly after the `INSERT OR IGNORE` for Inbox auto-creation. This commits any pending transaction state on the connection, which could be surprising if the caller has uncommitted changes. In the current codebase this is not an issue (resolver is called early in command handling), but it couples the resolver to transaction management.\n- **Action**: Consider whether the caller should be responsible for committing. For M1 this is acceptable since the auto-creation is a one-time idempotent operation.\n\n#### [Low] F4: No test for Inbox auto-creation when a private Inbox exists\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/tests/test_project_resolver.py`\n- **Description**: If a user has a private project named \"Inbox\", `resolve_project(conn, \"Inbox\", user_id)` will return the private project (step 1 matches). The auto-creation path (step 3) is only reached if neither private nor shared \"Inbox\" exists. This behavior is correct per the resolution order, but there is no test covering the scenario where a user has a private \"Inbox\" and the shared \"Inbox\" also exists -- the test should verify that the private one is returned.\n- **Action**: Add a test for this edge case in a follow-up.\n\n#### [Info] F5: `INSERT OR IGNORE` is the correct pattern for Inbox auto-creation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 67-70\n- `INSERT OR IGNORE` handles the race condition where two concurrent requests try to auto-create Inbox simultaneously. The `ux_projects_shared_name` unique index on `(name) WHERE visibility = 'shared'` ensures only one shared Inbox can exist. The subsequent `SELECT` on lines 72-75 guarantees we return the correct row regardless of whether this request or another one performed the insert. This is well-designed.\n\n#### [Info] F6: Bonus tests add good defensive coverage\n\n- `test_inbox_already_exists` verifies that the seeded Inbox (from V1 migration) resolves without triggering auto-creation.\n- `test_private_different_owner_not_matched` verifies that a private project owned by U2 is not visible to U1, correctly raising `ProjectNotFoundError`.\n\n#### [Info] F7: Coverage at 100%\n\n- All 31 statements in `project_resolver.py` are covered by the 6 tests. No untested branches.\n\n#### [Info] F8: Test fixture pattern is consistent with prior PRs\n\n- The `_load_v1` autouse fixture and `conn` fixture follow the same save-clear-restore pattern established in prior PRs. Good consistency.\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and follows the PRD resolution order exactly:\n\n- Three-step resolution (private -> shared -> Inbox auto-create) with clear fallthrough logic.\n- All SQL queries use parameterized placeholders (`?`), preventing SQL injection.\n- `Project` dataclass provides a typed result with the four required fields.\n- `ProjectNotFoundError` is a well-named custom exception with descriptive message.\n- Logging at debug level for each resolution path aids troubleshooting.\n- `INSERT OR IGNORE` handles concurrent Inbox auto-creation safely.\n- 100% test coverage with all 4 required tests and 2 valuable bonus tests.\n- The code is 85 lines total -- minimal and readable.\n\n**Verdict: APPROVE** -- no Critical or High findings. All Low findings are noted for follow-up.\n### Changed Files\n\n| File | Change | Lines |\n|------|--------|-------|\n| `src/openclaw_todo/dispatcher.py` | NEW | 116 |\n| `src/openclaw_todo/plugin.py` | MODIFIED | 33 |\n| `tests/test_dispatcher.py` | NEW | 152 |\n| `tests/test_plugin.py` | MODIFIED | 39 |\n\n### Architecture Overview\n\nThe dispatcher implements a two-level routing architecture:\n\n1. **Plugin layer** (`plugin.py`): Strips `/todo` prefix, returns USAGE for bare `/todo`, delegates remainder to `dispatch()`.\n2. **Dispatcher layer** (`dispatcher.py`): Parses the remainder via the parser, validates command name against `_VALID_COMMANDS`, opens a DB connection with migration, routes to the appropriate handler (or stub), and closes the connection in a `finally` block.\n3. **Project sub-routing**: `project` command delegates to `_dispatch_project()` which extracts the subcommand from `parsed.title_tokens` and routes to `project_<subcommand>` handlers in the registry.\n\n### Findings\n\n#### [Low] F1: Weak test assertion on stub handler (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/tests/test_dispatcher.py`, line 48\n- **Description**: The original assertion was:\n  ```python\n  assert \"not yet implemented\" in result.lower() or isinstance(result, str)\n  ```\n  The `isinstance(result, str)` clause makes this trivially true since `dispatch()` always returns `str`. The test does not actually verify that the stub handler was invoked -- any string return would pass.\n- **Fix applied**: Removed the `or isinstance(result, str)` fallback. The assertion now strictly verifies that the stub handler message is present:\n  ```python\n  assert \"not yet implemented\" in result.lower()\n  ```\n- **Impact**: Test now correctly fails if the stub handler message format changes or if a different code path is taken.\n\n#### [Low] F2: `_stub_handler` signature differs from `HandlerFn` type alias\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 17, 47\n- **Description**: The `HandlerFn` type alias is `Callable[[ParsedCommand, Connection, dict], str]` (3 args), but `_stub_handler` takes 4 args: `(command, parsed, conn, context)`. This works because `_stub_handler` is never registered directly in `_handlers` -- it is always called via a lambda wrapper in `_get_handler` (line 59) and `_dispatch_project` (line 115) that captures `command` via closure. However, the mismatch makes the code harder to follow at a glance.\n- **Action**: Consider refactoring `_stub_handler` to accept `(parsed, conn, context)` and derive the command name from `parsed.command`. Not blocking since the current approach is correct.\n\n#### [Low] F3: Long line in `_dispatch_project`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 115\n- **Description**: Line 115 is 116 characters, exceeding typical line length limits (88 for black, 100 for many projects). The lambda + `_handlers.get` + `_stub_handler` call is dense.\n- **Action**: Consider breaking into multiple lines for readability. Not blocking.\n\n#### [Low] F4: Global mutable `_handlers` dict shared across tests\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 54\n- **Description**: The `_handlers` dict is module-level mutable state. The test fixture `_clean_handlers` (test file line 22-28) correctly saves and restores it between tests. However, if the test suite were run in parallel (e.g., `pytest-xdist`), the shared state could cause flaky tests.\n- **Action**: For a single-process Slack plugin this is fine. Document the limitation if parallel test execution is ever introduced.\n\n#### [Info] F5: DB connection lifecycle is correct\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 86-94\n- The `dispatch()` function opens the DB connection *after* validating the command name (line 80-82 returns early for unknown commands without touching the DB). The connection is always closed in a `finally` block (line 94), ensuring no leaks even if handlers raise exceptions. This is good resource management.\n\n#### [Info] F6: Unknown commands do not open a DB connection\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 80-82\n- The `if command not in _VALID_COMMANDS` check returns before `_init_db()` is called. This avoids unnecessary DB initialization for typos and invalid commands. Good design.\n\n#### [Info] F7: Parse errors are caught and returned as user-facing messages\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 73-76\n- `ParseError` is caught and formatted as `f\"Parse error: {exc}\"`. The parser's error messages are descriptive (e.g., \"Invalid section: 'xyz'\") and do not leak internal details. This is appropriate for a Slack DM context.\n\n#### [Info] F8: Plugin entry-point correctly wired to dispatcher\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/plugin.py`\n- The `handle_message()` function now delegates to `dispatch()` instead of the previous placeholder response. The prefix matching logic is unchanged and still correct. The `db_path` parameter flows through to `dispatch()` for testability.\n\n#### [Info] F9: Schema import triggers migration registration\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 14\n- `import openclaw_todo.schema_v1 as _schema_v1` with `# noqa: F401` ensures the `@register` decorator in `schema_v1.py` runs at import time, populating the migration registry before any `migrate()` call. This is the correct pattern for the decorator-based migration system.\n\n#### [Info] F10: Test coverage is comprehensive\n\n- 20 dispatcher + plugin tests covering:\n  - All 7 non-project commands routed to stubs (parametrized)\n  - Custom handler registration and invocation\n  - All 3 project subcommands routed correctly\n  - Project with no subcommand returns usage\n  - Unknown project subcommand returns error\n  - Unknown top-level command returns error with usage\n  - Parse error propagation\n  - DB initialization with schema migration\n  - Plugin prefix matching (non-todo, todo, whitespace, bare /todo)\n\n### Code Quality Summary\n\nThe dispatcher implementation is clean, well-structured, and follows good design principles:\n\n- **Separation of concerns**: Plugin handles prefix matching; dispatcher handles parsing, validation, DB init, and routing. Each has a single responsibility.\n- **Resource safety**: DB connection opened late (only for valid commands) and closed in `finally`.\n- **Extensibility**: The `register_handler()` function provides a clean API for future command implementations to plug in without modifying the dispatcher.\n- **Defensive routing**: Unknown commands and parse errors return helpful user-facing messages without touching the DB or raising unhandled exceptions.\n- **Project sub-routing**: The `project_<subcommand>` naming convention with `replace('-', '_')` is a clean pattern for hyphenated subcommands.\n- **Test isolation**: The `_clean_handlers` autouse fixture properly saves and restores the handler registry between tests.\n\n**Verdict: APPROVE with one fix applied** -- the weak test assertion (Low, F1) has been strengthened. No Critical or High code quality issues found.\n\n---\n\n## Security Findings\n\n### [Low] S1: No SQL injection risk -- parameterized queries used throughout\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 38-42, 52-56\n- **Description**: All SQL queries use `?` parameter placeholders for user-supplied values (`name` and `sender_id`). The Inbox auto-creation on lines 67-75 uses hardcoded string literals only. No string interpolation or f-strings are used in any SQL statement.\n- **Severity**: Low (no risk found, noting for completeness)\n\n### [Low] S2: `name` parameter is not length-validated\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, line 27\n- **Description**: `resolve_project(conn, name, sender_id)` accepts arbitrarily long `name` strings. While SQLite handles this safely (TEXT has no inherent length limit), an extremely long name would result in unnecessary query execution against the database. The parser upstream (Issue #5) extracts project names from `/p <name>` tokens, and Slack limits message length to ~40,000 characters, providing transport-layer mitigation.\n- **Severity**: Low (mitigated by upstream constraints)\n- **Recommendation**: Consider adding a max-length check for project names in the parser or a future validation layer.\n\n### [Low] S3: Inbox auto-creation commits transaction implicitly\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, line 71\n- **Description**: `conn.commit()` inside the resolver commits all pending changes on the connection, not just the Inbox insert. If a future caller has uncommitted writes before calling `resolve_project`, those writes would be committed as a side effect. This is not exploitable but could lead to partial commits in error scenarios.\n- **Severity**: Low (no current exploit path; architectural concern)\n- **Recommendation**: Consider using a savepoint pattern (`SAVEPOINT` / `RELEASE`) for the Inbox auto-creation to isolate its transaction from any outer transaction.\n\n### [Info] S4: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `project_resolver.py` or `test_project_resolver.py`.\n\n### [Info] S5: No new dependencies introduced\n\n- The module uses only Python standard library (`sqlite3`, `dataclasses`, `logging`). No new entries in `pyproject.toml`.\n\n### [Info] S6: Authorization model is correctly scoped\n\n- The `sender_id` parameter is used correctly in the private-project query to scope visibility. User U1 cannot resolve another user's private projects. Test `test_private_different_owner_not_matched` explicitly verifies this isolation. The shared-project query correctly omits owner filtering, as shared projects are visible to all users.\n\n### Security Summary\n\nNo Critical, High, or Medium severity findings. The implementation has a minimal attack surface -- three read queries and one idempotent insert, all using parameterized queries. The authorization model (private scoped to sender, shared visible to all) is correctly implemented and tested. Three Low findings are noted for awareness but require no immediate action.\n### [Low] S1: User input reflected in error messages\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 76, 82, 110\n- **Description**: Three error paths echo user-supplied values back in responses:\n  - `f\"Parse error: {exc}\"` (line 76) -- parser error messages may contain raw user input\n  - `f\"Unknown command: '{command}'\\n{USAGE}\"` (line 82) -- the command name is user input\n  - `f\"Unknown project subcommand: '{sub}'\\n{PROJECT_USAGE}\"` (line 110) -- the subcommand is user input\n- **Severity**: Low. In the Slack DM context, Slack handles message escaping. The reflected values are single tokens (no spaces, limited characters after `split()` tokenization). No HTML/JS injection is possible in this context.\n- **Recommendation**: If the plugin ever serves responses in a web context (e.g., dashboard, webhook response viewer), sanitize reflected values. No fix needed for current Slack-only usage.\n\n### [Low] S2: No input length validation at dispatcher level\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 67\n- **Description**: `dispatch(text, ...)` accepts arbitrarily long strings, which flow to `parse()` for tokenization. Slack limits messages to approximately 40,000 characters, providing transport-layer mitigation.\n- **Severity**: Low (mitigated by Slack transport layer)\n- **Recommendation**: Consider adding a max-length guard in `handle_message()` if the plugin is ever exposed outside Slack.\n\n### [Low] S3: Handler exception propagation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 91-92\n- **Description**: If a registered handler raises an unhandled exception, it propagates up through `dispatch()`. The `finally` block ensures the DB connection is closed, but the exception itself is not caught. In the current architecture, the caller (`handle_message` in `plugin.py`) does not catch exceptions either, so an unhandled handler error would propagate to the gateway framework.\n- **Severity**: Low. The stub handlers cannot raise exceptions (they return strings). Future handler implementations should handle their own errors. A catch-all `except Exception` in `dispatch()` could provide defense-in-depth but would also mask bugs during development.\n- **Recommendation**: Consider adding a top-level exception handler in `dispatch()` that logs the error and returns a generic \"Internal error\" message, once real handlers are implemented. During development, letting exceptions propagate is acceptable.\n\n### [Info] S4: No SQL injection risk\n\n- The dispatcher does not execute any SQL directly. DB interaction is limited to `_init_db()` which calls `get_connection()` and `migrate()` -- both use hardcoded SQL or parameterized queries. User input flows through `ParsedCommand` fields to handlers, which are responsible for using parameterized queries.\n\n### [Info] S5: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `dispatcher.py`, `plugin.py`, or their test files.\n\n### [Info] S6: `db_path` parameter is configuration-controlled\n\n- The `db_path` parameter in `dispatch()` and `handle_message()` flows from the caller (gateway framework), not from user input. In tests, it comes from `tmp_path`. There is no code path where a user's message text influences the DB path.\n\n### [Info] S7: No new dependencies introduced\n\n- The dispatcher uses only Python standard library (`sqlite3`, `logging`, `typing`) plus internal modules (`db`, `migrations`, `parser`, `schema_v1`). No new entries in `pyproject.toml`.\n\n### Security Summary\n\nNo Critical or High severity findings. Three Low findings related to input reflection, length validation, and exception propagation are noted. The dispatcher has a minimal attack surface -- it validates commands against a whitelist, delegates parsing to the parser, and routes to registered handlers. The main security consideration for future work is ensuring that handler implementations use parameterized queries and handle their own exceptions gracefully.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Refactor**: Extract `Project(id=row[0], ...)` into a `_row_to_project(row)` helper or `Project.from_row(row)` classmethod to reduce the triple duplication.\n2. **Test coverage**: Add a test for the edge case where a user has a private \"Inbox\" project and the shared \"Inbox\" also exists, verifying the private one is returned.\n3. **Transaction safety**: Consider using `SAVEPOINT` / `RELEASE` for Inbox auto-creation instead of bare `conn.commit()` to avoid committing unrelated pending changes.\n4. **Case sensitivity**: Document that project name matching is case-sensitive. Consider `COLLATE NOCASE` if case-insensitive matching is desired in a future iteration.\n5. **Input validation**: Add a max-length check for project names in the parser or validation layer to prevent unnecessarily large queries.\n1. **Exception handling**: Add a top-level `try/except` in `dispatch()` that catches unexpected handler exceptions, logs them at error level, and returns a generic user-facing error message. Defer until real handlers are implemented.\n2. **Refactor `_stub_handler`**: Align `_stub_handler` signature with `HandlerFn` type alias by deriving the command name from `parsed.command` instead of passing it as a separate argument. This also eliminates the lambda wrappers in `_get_handler` and `_dispatch_project`.\n3. **Line length**: Break the long line 115 in `_dispatch_project` for readability.\n4. **Context typing**: Introduce a `TypedDict` or dataclass for the `context` parameter (e.g., `class DispatchContext(TypedDict): sender_id: str`) to enable static type checking.\n5. **Input length guard**: Add a max-length check (e.g., 5000 chars) in `handle_message()` as defense-in-depth against oversized inputs.\n", "structuredPatch": [{"oldStart": 944, "oldLines": 3, "newStart": 944, "newLines": 129, "lines": [" 3. **Line length**: Break the long line 115 in `_dispatch_project` for readability.", " 4. **Context typing**: Introduce a `TypedDict` or dataclass for the `context` parameter (e.g., `class DispatchContext(TypedDict): sender_id: str`) to enable static type checking.", " 5. **Input length guard**: Add a max-length check (e.g., 5000 chars) in `handle_message()` as defense-in-depth against oversized inputs.", "+", "+---", "+", "+# PR #18 Review Notes -- Issue #6: /todo add command", "+", "+> Reviewer: Claude Opus 4.6 (automated review)", "+> Date: 2026-02-20", "+> Branch: `feature/006-cmd-add`", "+", "+---", "+", "+## Code Review", "+", "+### Acceptance Criteria Checklist", "+", "+| Criterion | Status | Notes |", "+|-----------|--------|-------|", "+| Task inserted with correct project_id, section, due, status='open', created_by | PASS | `test_add_default_inbox` and `test_add_with_project_section_due` verify all fields in DB |", "+| Assignees default to sender when no mentions | PASS | `test_add_assignee_defaults_to_sender` verifies `task_assignees` row matches sender |", "+| Multiple mentions create multiple task_assignee rows | PASS | `test_add_multiple_assignees` verifies two rows inserted and present in response |", "+| Private project + non-owner assignee returns warning and does NOT insert | PASS | `test_add_private_rejects_other_assignee` verifies warning message and zero task rows |", "+| Non-existent project: `Inbox` auto-created; others return error | PASS | `test_add_default_inbox` uses seeded Inbox; `test_add_nonexistent_project_returns_error` verifies error |", "+| Response format: `Added #<id> (<project>/<section>) due:<due\\|-> assignees:<mentions> -- <title>` | PASS | All happy-path tests assert on this format |", "+| Event row written to `events` table | PASS | `test_event_logged` verifies actor, action, task_id, and JSON payload fields |", "+", "+### Required Tests", "+", "+| Test | Status |", "+|------|--------|", "+| `test_add_default_inbox` | PASS |", "+| `test_add_with_project_section_due` | PASS |", "+| `test_add_private_rejects_other_assignee` | PASS |", "+| `test_add_assignee_defaults_to_sender` | PASS |", "+| `test_add_multiple_assignees` | PASS |", "+", "+All 5 required tests present and passing. 5 additional tests (`test_add_private_allows_owner_assignee`, `test_event_logged`, `test_add_empty_title_returns_error`, `test_add_nonexistent_project_returns_error`, `test_add_due_clear_sentinel_stored_as_null`). 10 tests total.", "+", "+### Findings", "+", "+#### [Info] F1: No explicit transaction wrapping for multi-statement write", "+", "+- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-80", "+- **Description**: The handler performs three sequential writes (task INSERT, assignee INSERTs, event INSERT) followed by a single `conn.commit()` at line 80. If any write after the task INSERT raises (e.g., duplicate assignee PK violation), partial writes remain uncommitted. SQLite's implicit rollback-on-close in the dispatcher's `finally` block protects data integrity.", "+- **Action**: Consider wrapping in `with conn:` (context manager) for explicit transaction semantics in a future refactor. No functional bug today.", "+", "+#### [Info] F2: Missing `sender_id` key would raise unhandled KeyError", "+", "+- **File**: `src/openclaw_todo/cmd_add.py`, line 22", "+- **Description**: `context[\"sender_id\"]` raises `KeyError` if the key is absent. The dispatcher contract requires `sender_id` in context, so this is defensive-coding territory.", "+- **Action**: Acceptable. Could be improved with `.get()` + early return, but low priority given the documented contract.", "+", "+#### [Info] F3: Test gap -- non-owner sender adding to another user's private project", "+", "+- **File**: `tests/test_cmd_add.py`", "+- **Description**: No test covers the case where sender U2 tries to add a task to a private project owned by U1. The `resolve_project()` function would return `ProjectNotFoundError` (it only matches private projects of the sender), which is correct behavior. However, there is no explicit test verifying this path through `add_handler`.", "+- **Action**: Follow-up item. Add a test for \"non-owner sender cannot resolve another user's private project.\"", "+", "+#### [Info] F4: Title length is unbounded", "+", "+- **File**: `src/openclaw_todo/cmd_add.py`, line 23", "+- **Description**: No max-length check on `title`. Slack messages cap at ~4000 chars, providing natural limits. The DB column is `TEXT NOT NULL` with no length constraint.", "+- **Action**: Consider adding a max-length check if the handler is exposed outside Slack.", "+", "+#### [Info] F5: Dispatcher test correctly updated", "+", "+- **File**: `tests/test_dispatcher.py`, lines 34-51", "+- **Description**: The parametrized stub test removed `\"add\"` from the stub-check list and added a dedicated `test_add_routes_to_handler` test that asserts `\"Added #\"` in the result. This correctly reflects that `add` is no longer a stub.", "+", "+### Code Quality Summary", "+", "+The implementation is clean, minimal, and correct:", "+", "+- Uses `resolve_project()` for project resolution following PRD Option A (private-first).", "+- Private assignee validation correctly rejects non-owner assignees with a descriptive warning.", "+- All SQL uses parameterized queries (`?` placeholders).", "+- Event payload is well-structured JSON with title, project, section, due, and assignees.", "+- Response format matches the PRD/UX spec exactly.", "+- 10 tests with thorough assertions on both the response string and DB state.", "+- No unnecessary complexity or over-engineering.", "+", "+**Verdict: APPROVE** -- no blocking issues. No fixes required.", "+", "+---", "+", "+## Security Findings", "+", "+### [Info] S1: SQL injection -- No risk", "+", "+- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-78", "+- **Description**: All three SQL statements (task INSERT, assignee INSERT, event INSERT) use `?` parameter placeholders. No string interpolation or f-strings in SQL. Title, project_id, section, due, sender_id, and assignee values are all passed as parameters.", "+- **Severity**: Info (no risk found)", "+", "+### [Info] S2: Authorization model is sound", "+", "+- **File**: `src/openclaw_todo/cmd_add.py`, lines 41-49", "+- **Description**: Private project constraint correctly checks that all assignees match the project owner. The `resolve_project()` function provides implicit access control by only resolving the sender's own private projects (scoped by `owner_user_id = sender_id` in the SQL query). A non-owner sender cannot resolve another user's private project by name. The explicit assignee check in `cmd_add.py` is an additional layer for when the owner assigns tasks to others within their private project.", "+- **Severity**: Info (no bypass possible)", "+", "+### [Info] S3: No hardcoded secrets or credentials", "+", "+- No API keys, tokens, or secrets found in any changed files.", "+", "+### [Info] S4: No new dependencies introduced", "+", "+- `cmd_add.py` uses only standard library (`json`, `logging`, `sqlite3`) plus internal modules (`parser`, `project_resolver`). No new entries in `pyproject.toml`.", "+", "+### [Info] S5: Input validation adequate", "+", "+- Empty title returns error (line 25-26).", "+- Non-existent project returns error via `ProjectNotFoundError` (lines 30-33).", "+- Section validation handled by parser upstream (`VALID_SECTIONS` check).", "+- Due date validation handled by parser upstream (`_normalise_due`).", "+- Mention format constrained by parser regex (`<@U[A-Z0-9]+>`).", "+", "+### Security Summary", "+", "+No Critical, High, Medium, or Low severity findings. The implementation has a minimal attack surface -- three parameterized INSERT statements, project resolution with sender-scoped authorization, and input validation at both the parser and handler layers. The code is secure for the current Slack DM context.", "+", "+---", "+", "+## Follow-up Items", "+", "+1. **Test coverage**: Add a test for non-owner sender attempting to add a task to another user's private project (should get `ProjectNotFoundError` via resolver).", "+2. **Transaction explicitness**: Consider wrapping the three DB writes in `with conn:` for explicit transaction semantics.", "+3. **Title length**: Consider adding a max-length validation (e.g., 500 chars) as defense-in-depth.", "+4. **Permissions module**: When Issue #17 (permissions helper) is merged, consider extracting the inline private-assignee validation to use the shared `validate_private_assignees()` function."]}], "userModified": false, "replaceAll": false}, "tool_use_id": "toolu_01FRenboYGGM7oXs1ekBeM3H", "_ts": "2026-02-20T19:26:31+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "git add docs/review_notes.md && git commit -m \"$(cat <<'EOF'\ndocs(review): add review notes for PR #18 (Issue #6)\n\nCode review and security audit for the /todo add command handler.\nNo Critical/High findings. All 10 tests pass. APPROVE.\n\nCo-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>\nEOF\n)\" && git push 2>&1", "description": "Commit and push review notes"}, "tool_use_id": "toolu_01KafJV9X2z46s8WXkNYxKKV", "_ts": "2026-02-20T19:26:38+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "git add docs/review_notes.md && git commit -m \"$(cat <<'EOF'\ndocs(review): add review notes for PR #18 (Issue #6)\n\nCode review and security audit for the /todo add command handler.\nNo Critical/High findings. All 10 tests pass. APPROVE.\n\nCo-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>\nEOF\n)\" && git push 2>&1", "description": "Commit and push review notes"}, "tool_response": {"stdout": "[feature/006-cmd-add 5df5c3a] docs(review): add review notes for PR #18 (Issue #6)\n 1 file changed, 126 insertions(+)\nTo https://github.com/pillip/openclaw_todo_plugin.git\n   5c48855..5df5c3a  feature/006-cmd-add -> feature/006-cmd-add", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_01KafJV9X2z46s8WXkNYxKKV", "_ts": "2026-02-20T19:26:40+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "SubagentStop", "stop_hook_active": false, "agent_id": "a21debe", "agent_transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6/subagents/agent-a21debe.jsonl", "agent_type": "", "_ts": "2026-02-20T19:26:57+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "gh pr view 18 --json state,isDraft,mergeable,mergeStateStatus,statusCheckRollup 2>&1", "description": "Check PR #18 merge readiness"}, "tool_use_id": "toolu_01M9Fzar9rxD64ERrHozZvfs", "_ts": "2026-02-20T19:29:15+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "gh pr view 18 --json state,isDraft,mergeable,mergeStateStatus,statusCheckRollup 2>&1", "description": "Check PR #18 merge readiness"}, "tool_response": {"stdout": "{\"isDraft\":false,\"mergeStateStatus\":\"UNKNOWN\",\"mergeable\":\"UNKNOWN\",\"state\":\"OPEN\",\"statusCheckRollup\":[]}", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_01M9Fzar9rxD64ERrHozZvfs", "_ts": "2026-02-20T19:29:16+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "uv run pytest -q 2>&1", "description": "Run tests in worktree"}, "tool_use_id": "toolu_01K29TnnVvSmV1cpRbUQ9FAV", "_ts": "2026-02-20T19:29:16+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "uv run pytest -q 2>&1", "description": "Run tests in worktree"}, "tool_response": {"stdout": "................................................................         [100%]\n64 passed in 0.19s", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_01K29TnnVvSmV1cpRbUQ9FAV", "_ts": "2026-02-20T19:29:17+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Glob", "tool_input": {"pattern": "CHANGELOG.md", "path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add"}, "tool_use_id": "toolu_01RW9j6AD3yLjhyuK1YMkLfg", "_ts": "2026-02-20T19:29:21+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Glob", "tool_input": {"pattern": "CHANGELOG.md", "path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add"}, "tool_response": {"filenames": ["/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/CHANGELOG.md"], "durationMs": 434, "numFiles": 1, "truncated": false}, "tool_use_id": "toolu_01RW9j6AD3yLjhyuK1YMkLfg", "_ts": "2026-02-20T19:29:22+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/CHANGELOG.md"}, "tool_use_id": "toolu_01JevyV3Yp5t1qeBgdDyeFTi", "_ts": "2026-02-20T19:29:25+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/CHANGELOG.md"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/CHANGELOG.md", "content": "# Changelog\n\nAll notable changes to this project will be documented in this file.\n\n## [Unreleased]\n\n### Added\n- `db.py`: `get_connection(db_path)` helper with recursive directory creation, WAL mode, busy_timeout=3000\n- DB connection tests (4 tests)\n- `migrations.py`: sequential schema migration framework with `@register`, `migrate()`, `get_version()`\n- Migration tests (4 tests): fresh DB, sequential apply, idempotent rerun, rollback on failure\n- `schema_v1.py`: V1 migration creating projects, tasks, task_assignees, events tables\n- Partial unique indexes for shared/private project name constraints\n- Shared `Inbox` project auto-seeded\n- V1 schema tests (7 tests): tables, indexes, CHECK constraints, Inbox\n\n- `parser.py`: command tokenizer with `/p`, `/s`, `due:`, `<@U...>` extraction and `ParsedCommand` dataclass\n- Parser tests (13 tests): project, section, due normalisation, mentions, title extraction\n- `project_resolver.py`: project name resolution with private-first (PRD 3.2 Option A), Inbox auto-create\n- Project resolver tests (6 tests): private priority, shared fallback, Inbox auto-create, unknown error\n- `dispatcher.py`: command dispatcher with two-level routing (top-level + project subcommands), handler registry, DB init\n- Plugin `handle_message` delegates to dispatcher instead of placeholder response\n- Dispatcher tests (20 tests): command routing, project sub-routing, unknown commands, parse errors, DB init\n\n### Fixed\n- Enable `PRAGMA foreign_keys=ON` in `get_connection()` for referential integrity\n- Leap-year `due:02-29` parsing in MM-DD format (strptime year-1900 bug)\n\n## [0.1.0] - 2026-02-20\n\n### Added\n- Project scaffold with `pyproject.toml` (uv, Python >=3.11)\n- `src/openclaw_todo/` package with `__version__`\n- `handle_message(text, context)` plugin entry point\n- `/todo` prefix matching (non-todo messages silently ignored)\n- Smoke tests for plugin entry point (4 tests)\n", "numLines": 37, "startLine": 1, "totalLines": 37}}, "tool_use_id": "toolu_01JevyV3Yp5t1qeBgdDyeFTi", "_ts": "2026-02-20T19:29:25+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/CHANGELOG.md", "old_string": "- Plugin `handle_message` delegates to dispatcher instead of placeholder response\n- Dispatcher tests (20 tests): command routing, project sub-routing, unknown commands, parse errors, DB init", "new_string": "- Plugin `handle_message` delegates to dispatcher instead of placeholder response\n- Dispatcher tests (20 tests): command routing, project sub-routing, unknown commands, parse errors, DB init\n- `cmd_add.py`: `/todo add` command handler with project resolution, assignee defaults, private-project validation, event logging\n- `add` handler registered in dispatcher (replaces stub)\n- cmd_add tests (10 tests): default Inbox, explicit options, private rejection, assignee defaults, multiple assignees, event logging, edge cases", "replace_all": false}, "tool_use_id": "toolu_015henCtwS4WKRUM2inSYijy", "_ts": "2026-02-20T19:29:32+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/CHANGELOG.md", "old_string": "- Plugin `handle_message` delegates to dispatcher instead of placeholder response\n- Dispatcher tests (20 tests): command routing, project sub-routing, unknown commands, parse errors, DB init", "new_string": "- Plugin `handle_message` delegates to dispatcher instead of placeholder response\n- Dispatcher tests (20 tests): command routing, project sub-routing, unknown commands, parse errors, DB init\n- `cmd_add.py`: `/todo add` command handler with project resolution, assignee defaults, private-project validation, event logging\n- `add` handler registered in dispatcher (replaces stub)\n- cmd_add tests (10 tests): default Inbox, explicit options, private rejection, assignee defaults, multiple assignees, event logging, edge cases", "replace_all": false}, "tool_response": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/CHANGELOG.md", "oldString": "- Plugin `handle_message` delegates to dispatcher instead of placeholder response\n- Dispatcher tests (20 tests): command routing, project sub-routing, unknown commands, parse errors, DB init", "newString": "- Plugin `handle_message` delegates to dispatcher instead of placeholder response\n- Dispatcher tests (20 tests): command routing, project sub-routing, unknown commands, parse errors, DB init\n- `cmd_add.py`: `/todo add` command handler with project resolution, assignee defaults, private-project validation, event logging\n- `add` handler registered in dispatcher (replaces stub)\n- cmd_add tests (10 tests): default Inbox, explicit options, private rejection, assignee defaults, multiple assignees, event logging, edge cases", "originalFile": "# Changelog\n\nAll notable changes to this project will be documented in this file.\n\n## [Unreleased]\n\n### Added\n- `db.py`: `get_connection(db_path)` helper with recursive directory creation, WAL mode, busy_timeout=3000\n- DB connection tests (4 tests)\n- `migrations.py`: sequential schema migration framework with `@register`, `migrate()`, `get_version()`\n- Migration tests (4 tests): fresh DB, sequential apply, idempotent rerun, rollback on failure\n- `schema_v1.py`: V1 migration creating projects, tasks, task_assignees, events tables\n- Partial unique indexes for shared/private project name constraints\n- Shared `Inbox` project auto-seeded\n- V1 schema tests (7 tests): tables, indexes, CHECK constraints, Inbox\n\n- `parser.py`: command tokenizer with `/p`, `/s`, `due:`, `<@U...>` extraction and `ParsedCommand` dataclass\n- Parser tests (13 tests): project, section, due normalisation, mentions, title extraction\n- `project_resolver.py`: project name resolution with private-first (PRD 3.2 Option A), Inbox auto-create\n- Project resolver tests (6 tests): private priority, shared fallback, Inbox auto-create, unknown error\n- `dispatcher.py`: command dispatcher with two-level routing (top-level + project subcommands), handler registry, DB init\n- Plugin `handle_message` delegates to dispatcher instead of placeholder response\n- Dispatcher tests (20 tests): command routing, project sub-routing, unknown commands, parse errors, DB init\n\n### Fixed\n- Enable `PRAGMA foreign_keys=ON` in `get_connection()` for referential integrity\n- Leap-year `due:02-29` parsing in MM-DD format (strptime year-1900 bug)\n\n## [0.1.0] - 2026-02-20\n\n### Added\n- Project scaffold with `pyproject.toml` (uv, Python >=3.11)\n- `src/openclaw_todo/` package with `__version__`\n- `handle_message(text, context)` plugin entry point\n- `/todo` prefix matching (non-todo messages silently ignored)\n- Smoke tests for plugin entry point (4 tests)\n", "structuredPatch": [{"oldStart": 21, "oldLines": 6, "newStart": 21, "newLines": 9, "lines": [" - `dispatcher.py`: command dispatcher with two-level routing (top-level + project subcommands), handler registry, DB init", " - Plugin `handle_message` delegates to dispatcher instead of placeholder response", " - Dispatcher tests (20 tests): command routing, project sub-routing, unknown commands, parse errors, DB init", "+- `cmd_add.py`: `/todo add` command handler with project resolution, assignee defaults, private-project validation, event logging", "+- `add` handler registered in dispatcher (replaces stub)", "+- cmd_add tests (10 tests): default Inbox, explicit options, private rejection, assignee defaults, multiple assignees, event logging, edge cases", " ", " ### Fixed", " - Enable `PRAGMA foreign_keys=ON` in `get_connection()` for referential integrity"]}], "userModified": false, "replaceAll": false}, "tool_use_id": "toolu_015henCtwS4WKRUM2inSYijy", "_ts": "2026-02-20T19:29:32+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/STATUS.md"}, "tool_use_id": "toolu_017G1LZvipeTj8qvXkgxnG27", "_ts": "2026-02-20T19:29:36+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/STATUS.md"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/STATUS.md", "content": "# Project Status — OpenClaw TODO Plugin\n\n**Last updated:** 2026-02-20\n\n## Current Phase\n\n**Kickoff complete** — All planning documents generated. Ready to begin implementation.\n\n## Milestones\n\n| Milestone | Description | Status | Issues |\n|-----------|-------------|--------|--------|\n| M0 | Plugin skeleton + `/todo` command registration | **Done** | #1 |\n| M1 | DB init + migrations + schema_version | **Done** | #2, #3, #4 |\n| M2 | Parser (Slack mention, /p, /s, due correction) | **Done** | #5 |\n| M3 | Commands (add/list/board/move/done/drop/edit) | Not started | #6–#12, #16, #17 |\n| M4 | Project commands (list/set-private/set-shared) | Not started | #13, #14, #15 |\n| M5 | Tests (parser/unit + sqlite E2E) | Not started | #18, #19 |\n| M6 | Packaging / deployment | Not started | #20 |\n\n## Critical Path\n\n```\n#1 (skeleton) → #2 (DB conn) → #3 (migration framework) → #4 (V1 schema) → #7 (project resolver) → commands\n#5 (parser) can be developed in parallel with DB track\n```\n\n## Next Issues to Work On\n\n1. **#7** — Project resolver helper (M3)\n2. **#17** — Permission helper module (M3)\n3. **#16** — Command dispatcher and routing (M3)\n\n## Risks\n\n| Risk | Likelihood | Impact | Mitigation |\n|------|-----------|--------|------------|\n| SQLite write contention under concurrent access | Low | Medium | WAL mode + busy_timeout=3000 |\n| Private/shared name collision user confusion | Medium | Low | Option A (private-first) + guidance |\n| Schema migration failures on upgrade | Low | High | schema_version table + sequential migrations |\n| Slack rate limits on heavy usage | Low | Low | Responses are single messages per command |\n\n## Generated Documents\n\n- [x] `docs/requirements.md` — Functional & non-functional requirements\n- [x] `docs/ux_spec.md` — UX specification with all command flows\n- [x] `docs/architecture.md` — Software architecture design\n- [x] `docs/test_plan.md` — Test strategy with 80+ test cases\n- [x] `issues.md` — 20 issues across 7 milestones\n", "numLines": 50, "startLine": 1, "totalLines": 50}}, "tool_use_id": "toolu_017G1LZvipeTj8qvXkgxnG27", "_ts": "2026-02-20T19:29:36+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/STATUS.md", "content": "# Project Status — OpenClaw TODO Plugin\n\n**Last updated:** 2026-02-20\n\n## Current Phase\n\n**Kickoff complete** — All planning documents generated. Ready to begin implementation.\n\n## Milestones\n\n| Milestone | Description | Status | Issues |\n|-----------|-------------|--------|--------|\n| M0 | Plugin skeleton + `/todo` command registration | **Done** | #1 |\n| M1 | DB init + migrations + schema_version | **Done** | #2, #3, #4 |\n| M2 | Parser (Slack mention, /p, /s, due correction) | **Done** | #5 |\n| M3 | Commands (add/list/board/move/done/drop/edit) | **In progress** | #6 ✅, #16 ✅, #7 ✅, #17 ✅, #8–#12 |\n| M4 | Project commands (list/set-private/set-shared) | Not started | #13, #14, #15 |\n| M5 | Tests (parser/unit + sqlite E2E) | Not started | #18, #19 |\n| M6 | Packaging / deployment | Not started | #20 |\n\n## Critical Path\n\n```\n#1 (skeleton) → #2 (DB conn) → #3 (migration framework) → #4 (V1 schema) → #7 (project resolver) → commands\n#5 (parser) can be developed in parallel with DB track\n```\n\n## Next Issues to Work On\n\n1. **#8** — /todo list command (M3)\n2. **#10** — /todo move command (M3)\n3. **#13** — /todo project list command (M4)\n\n## Risks\n\n| Risk | Likelihood | Impact | Mitigation |\n|------|-----------|--------|------------|\n| SQLite write contention under concurrent access | Low | Medium | WAL mode + busy_timeout=3000 |\n| Private/shared name collision user confusion | Medium | Low | Option A (private-first) + guidance |\n| Schema migration failures on upgrade | Low | High | schema_version table + sequential migrations |\n| Slack rate limits on heavy usage | Low | Low | Responses are single messages per command |\n\n## Generated Documents\n\n- [x] `docs/requirements.md` — Functional & non-functional requirements\n- [x] `docs/ux_spec.md` — UX specification with all command flows\n- [x] `docs/architecture.md` — Software architecture design\n- [x] `docs/test_plan.md` — Test strategy with 80+ test cases\n- [x] `issues.md` — 20 issues across 7 milestones\n"}, "tool_use_id": "toolu_0163h3mHAAYtYkuARZQZDvri", "_ts": "2026-02-20T19:29:44+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Write", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/STATUS.md", "content": "# Project Status — OpenClaw TODO Plugin\n\n**Last updated:** 2026-02-20\n\n## Current Phase\n\n**Kickoff complete** — All planning documents generated. Ready to begin implementation.\n\n## Milestones\n\n| Milestone | Description | Status | Issues |\n|-----------|-------------|--------|--------|\n| M0 | Plugin skeleton + `/todo` command registration | **Done** | #1 |\n| M1 | DB init + migrations + schema_version | **Done** | #2, #3, #4 |\n| M2 | Parser (Slack mention, /p, /s, due correction) | **Done** | #5 |\n| M3 | Commands (add/list/board/move/done/drop/edit) | **In progress** | #6 ✅, #16 ✅, #7 ✅, #17 ✅, #8–#12 |\n| M4 | Project commands (list/set-private/set-shared) | Not started | #13, #14, #15 |\n| M5 | Tests (parser/unit + sqlite E2E) | Not started | #18, #19 |\n| M6 | Packaging / deployment | Not started | #20 |\n\n## Critical Path\n\n```\n#1 (skeleton) → #2 (DB conn) → #3 (migration framework) → #4 (V1 schema) → #7 (project resolver) → commands\n#5 (parser) can be developed in parallel with DB track\n```\n\n## Next Issues to Work On\n\n1. **#8** — /todo list command (M3)\n2. **#10** — /todo move command (M3)\n3. **#13** — /todo project list command (M4)\n\n## Risks\n\n| Risk | Likelihood | Impact | Mitigation |\n|------|-----------|--------|------------|\n| SQLite write contention under concurrent access | Low | Medium | WAL mode + busy_timeout=3000 |\n| Private/shared name collision user confusion | Medium | Low | Option A (private-first) + guidance |\n| Schema migration failures on upgrade | Low | High | schema_version table + sequential migrations |\n| Slack rate limits on heavy usage | Low | Low | Responses are single messages per command |\n\n## Generated Documents\n\n- [x] `docs/requirements.md` — Functional & non-functional requirements\n- [x] `docs/ux_spec.md` — UX specification with all command flows\n- [x] `docs/architecture.md` — Software architecture design\n- [x] `docs/test_plan.md` — Test strategy with 80+ test cases\n- [x] `issues.md` — 20 issues across 7 milestones\n"}, "tool_response": {"type": "update", "filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/STATUS.md", "content": "# Project Status — OpenClaw TODO Plugin\n\n**Last updated:** 2026-02-20\n\n## Current Phase\n\n**Kickoff complete** — All planning documents generated. Ready to begin implementation.\n\n## Milestones\n\n| Milestone | Description | Status | Issues |\n|-----------|-------------|--------|--------|\n| M0 | Plugin skeleton + `/todo` command registration | **Done** | #1 |\n| M1 | DB init + migrations + schema_version | **Done** | #2, #3, #4 |\n| M2 | Parser (Slack mention, /p, /s, due correction) | **Done** | #5 |\n| M3 | Commands (add/list/board/move/done/drop/edit) | **In progress** | #6 ✅, #16 ✅, #7 ✅, #17 ✅, #8–#12 |\n| M4 | Project commands (list/set-private/set-shared) | Not started | #13, #14, #15 |\n| M5 | Tests (parser/unit + sqlite E2E) | Not started | #18, #19 |\n| M6 | Packaging / deployment | Not started | #20 |\n\n## Critical Path\n\n```\n#1 (skeleton) → #2 (DB conn) → #3 (migration framework) → #4 (V1 schema) → #7 (project resolver) → commands\n#5 (parser) can be developed in parallel with DB track\n```\n\n## Next Issues to Work On\n\n1. **#8** — /todo list command (M3)\n2. **#10** — /todo move command (M3)\n3. **#13** — /todo project list command (M4)\n\n## Risks\n\n| Risk | Likelihood | Impact | Mitigation |\n|------|-----------|--------|------------|\n| SQLite write contention under concurrent access | Low | Medium | WAL mode + busy_timeout=3000 |\n| Private/shared name collision user confusion | Medium | Low | Option A (private-first) + guidance |\n| Schema migration failures on upgrade | Low | High | schema_version table + sequential migrations |\n| Slack rate limits on heavy usage | Low | Low | Responses are single messages per command |\n\n## Generated Documents\n\n- [x] `docs/requirements.md` — Functional & non-functional requirements\n- [x] `docs/ux_spec.md` — UX specification with all command flows\n- [x] `docs/architecture.md` — Software architecture design\n- [x] `docs/test_plan.md` — Test strategy with 80+ test cases\n- [x] `issues.md` — 20 issues across 7 milestones\n", "structuredPatch": [{"oldStart": 13, "oldLines": 7, "newStart": 13, "newLines": 7, "lines": [" | M0 | Plugin skeleton + `/todo` command registration | **Done** | #1 |", " | M1 | DB init + migrations + schema_version | **Done** | #2, #3, #4 |", " | M2 | Parser (Slack mention, /p, /s, due correction) | **Done** | #5 |", "-| M3 | Commands (add/list/board/move/done/drop/edit) | Not started | #6–#12, #16, #17 |", "+| M3 | Commands (add/list/board/move/done/drop/edit) | **In progress** | #6 ✅, #16 ✅, #7 ✅, #17 ✅, #8–#12 |", " | M4 | Project commands (list/set-private/set-shared) | Not started | #13, #14, #15 |", " | M5 | Tests (parser/unit + sqlite E2E) | Not started | #18, #19 |", " | M6 | Packaging / deployment | Not started | #20 |"]}, {"oldStart": 27, "oldLines": 9, "newStart": 27, "newLines": 9, "lines": [" ", " ## Next Issues to Work On", " ", "-1. **#7** — Project resolver helper (M3)", "-2. **#17** — Permission helper module (M3)", "-3. **#16** — Command dispatcher and routing (M3)", "+1. **#8** — /todo list command (M3)", "+2. **#10** — /todo move command (M3)", "+3. **#13** — /todo project list command (M4)", " ", " ## Risks", " "]}], "originalFile": "# Project Status — OpenClaw TODO Plugin\n\n**Last updated:** 2026-02-20\n\n## Current Phase\n\n**Kickoff complete** — All planning documents generated. Ready to begin implementation.\n\n## Milestones\n\n| Milestone | Description | Status | Issues |\n|-----------|-------------|--------|--------|\n| M0 | Plugin skeleton + `/todo` command registration | **Done** | #1 |\n| M1 | DB init + migrations + schema_version | **Done** | #2, #3, #4 |\n| M2 | Parser (Slack mention, /p, /s, due correction) | **Done** | #5 |\n| M3 | Commands (add/list/board/move/done/drop/edit) | Not started | #6–#12, #16, #17 |\n| M4 | Project commands (list/set-private/set-shared) | Not started | #13, #14, #15 |\n| M5 | Tests (parser/unit + sqlite E2E) | Not started | #18, #19 |\n| M6 | Packaging / deployment | Not started | #20 |\n\n## Critical Path\n\n```\n#1 (skeleton) → #2 (DB conn) → #3 (migration framework) → #4 (V1 schema) → #7 (project resolver) → commands\n#5 (parser) can be developed in parallel with DB track\n```\n\n## Next Issues to Work On\n\n1. **#7** — Project resolver helper (M3)\n2. **#17** — Permission helper module (M3)\n3. **#16** — Command dispatcher and routing (M3)\n\n## Risks\n\n| Risk | Likelihood | Impact | Mitigation |\n|------|-----------|--------|------------|\n| SQLite write contention under concurrent access | Low | Medium | WAL mode + busy_timeout=3000 |\n| Private/shared name collision user confusion | Medium | Low | Option A (private-first) + guidance |\n| Schema migration failures on upgrade | Low | High | schema_version table + sequential migrations |\n| Slack rate limits on heavy usage | Low | Low | Responses are single messages per command |\n\n## Generated Documents\n\n- [x] `docs/requirements.md` — Functional & non-functional requirements\n- [x] `docs/ux_spec.md` — UX specification with all command flows\n- [x] `docs/architecture.md` — Software architecture design\n- [x] `docs/test_plan.md` — Test strategy with 80+ test cases\n- [x] `issues.md` — 20 issues across 7 milestones\n"}, "tool_use_id": "toolu_0163h3mHAAYtYkuARZQZDvri", "_ts": "2026-02-20T19:29:44+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "git add CHANGELOG.md STATUS.md && git commit -m \"$(cat <<'EOF'\ndocs: update CHANGELOG and STATUS for Issue #6 ship\n\nCo-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>\nEOF\n)\" && git push 2>&1", "description": "Commit and push docs updates"}, "tool_use_id": "toolu_015PvGnfLAt9Tbgu8dpdFpW5", "_ts": "2026-02-20T19:29:49+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "git add CHANGELOG.md STATUS.md && git commit -m \"$(cat <<'EOF'\ndocs: update CHANGELOG and STATUS for Issue #6 ship\n\nCo-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>\nEOF\n)\" && git push 2>&1", "description": "Commit and push docs updates"}, "tool_response": {"stdout": "[feature/006-cmd-add b85fb9c] docs: update CHANGELOG and STATUS for Issue #6 ship\n 2 files changed, 7 insertions(+), 4 deletions(-)\nTo https://github.com/pillip/openclaw_todo_plugin.git\n   5df5c3a..b85fb9c  feature/006-cmd-add -> feature/006-cmd-add", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_015PvGnfLAt9Tbgu8dpdFpW5", "_ts": "2026-02-20T19:29:52+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "gh pr merge 18 --merge --delete-branch 2>&1", "description": "Merge PR #18 and delete branch"}, "tool_use_id": "toolu_01D2PjqTtEAdwDnWdyDq1y7P", "_ts": "2026-02-20T19:29:55+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUseFailure", "tool_name": "Bash", "tool_input": {"command": "gh pr merge 18 --merge --delete-branch 2>&1", "description": "Merge PR #18 and delete branch"}, "tool_use_id": "toolu_01D2PjqTtEAdwDnWdyDq1y7P", "error": "Exit code 1\nGraphQL: Pull Request is not mergeable (mergePullRequest)", "is_interrupt": false, "_ts": "2026-02-20T19:29:58+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "gh pr view 18 --json mergeable,mergeStateStatus 2>&1", "description": "Check merge state"}, "tool_use_id": "toolu_016Rqgp7ayrsPKuDJxR2N5Vk", "_ts": "2026-02-20T19:30:01+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "gh pr view 18 --json mergeable,mergeStateStatus 2>&1", "description": "Check merge state"}, "tool_response": {"stdout": "{\"mergeStateStatus\":\"DIRTY\",\"mergeable\":\"CONFLICTING\"}", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_016Rqgp7ayrsPKuDJxR2N5Vk", "_ts": "2026-02-20T19:30:03+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "git fetch origin main && git merge origin/main 2>&1", "description": "Merge main into feature branch"}, "tool_use_id": "toolu_013DJiZKEeP5fZMCRSUMKFj4", "_ts": "2026-02-20T19:30:07+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUseFailure", "tool_name": "Bash", "tool_input": {"command": "git fetch origin main && git merge origin/main 2>&1", "description": "Merge main into feature branch"}, "tool_use_id": "toolu_013DJiZKEeP5fZMCRSUMKFj4", "error": "Exit code 1\nhttps://github.com/pillip/openclaw_todo_plugin URL에서\n * branch            main       -> FETCH_HEAD\n\n자동 병합: CHANGELOG.md\n충돌 (내용): CHANGELOG.md에 병합 충돌\n자동 병합: docs/review_notes.md\n충돌 (내용): docs/review_notes.md에 병합 충돌\n자동 병합이 실패했습니다. 충돌을 바로잡고 결과물을 커밋하십시오.", "is_interrupt": false, "_ts": "2026-02-20T19:30:08+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/CHANGELOG.md"}, "tool_use_id": "toolu_01LtxAS3n8e8yeJZ6oZMw2WS", "_ts": "2026-02-20T19:30:11+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/CHANGELOG.md"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/CHANGELOG.md", "content": "# Changelog\n\nAll notable changes to this project will be documented in this file.\n\n## [Unreleased]\n\n### Added\n- `db.py`: `get_connection(db_path)` helper with recursive directory creation, WAL mode, busy_timeout=3000\n- DB connection tests (4 tests)\n- `migrations.py`: sequential schema migration framework with `@register`, `migrate()`, `get_version()`\n- Migration tests (4 tests): fresh DB, sequential apply, idempotent rerun, rollback on failure\n- `schema_v1.py`: V1 migration creating projects, tasks, task_assignees, events tables\n- Partial unique indexes for shared/private project name constraints\n- Shared `Inbox` project auto-seeded\n- V1 schema tests (7 tests): tables, indexes, CHECK constraints, Inbox\n\n- `parser.py`: command tokenizer with `/p`, `/s`, `due:`, `<@U...>` extraction and `ParsedCommand` dataclass\n- Parser tests (13 tests): project, section, due normalisation, mentions, title extraction\n- `project_resolver.py`: project name resolution with private-first (PRD 3.2 Option A), Inbox auto-create\n- Project resolver tests (6 tests): private priority, shared fallback, Inbox auto-create, unknown error\n- `dispatcher.py`: command dispatcher with two-level routing (top-level + project subcommands), handler registry, DB init\n- Plugin `handle_message` delegates to dispatcher instead of placeholder response\n- Dispatcher tests (20 tests): command routing, project sub-routing, unknown commands, parse errors, DB init\n<<<<<<< HEAD\n- `cmd_add.py`: `/todo add` command handler with project resolution, assignee defaults, private-project validation, event logging\n- `add` handler registered in dispatcher (replaces stub)\n- cmd_add tests (10 tests): default Inbox, explicit options, private rejection, assignee defaults, multiple assignees, event logging, edge cases\n=======\n- `permissions.py`: `can_write_task()` (private: owner only, shared: assignee/creator) and `validate_private_assignees()` helpers\n- Permission tests (11 tests): private/shared write checks, creator+assignee overlap, private assignee validation\n>>>>>>> origin/main\n\n### Fixed\n- Enable `PRAGMA foreign_keys=ON` in `get_connection()` for referential integrity\n- Leap-year `due:02-29` parsing in MM-DD format (strptime year-1900 bug)\n\n## [0.1.0] - 2026-02-20\n\n### Added\n- Project scaffold with `pyproject.toml` (uv, Python >=3.11)\n- `src/openclaw_todo/` package with `__version__`\n- `handle_message(text, context)` plugin entry point\n- `/todo` prefix matching (non-todo messages silently ignored)\n- Smoke tests for plugin entry point (4 tests)\n", "numLines": 45, "startLine": 1, "totalLines": 45}}, "tool_use_id": "toolu_01LtxAS3n8e8yeJZ6oZMw2WS", "_ts": "2026-02-20T19:30:11+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/CHANGELOG.md", "old_string": "<<<<<<< HEAD\n- `cmd_add.py`: `/todo add` command handler with project resolution, assignee defaults, private-project validation, event logging\n- `add` handler registered in dispatcher (replaces stub)\n- cmd_add tests (10 tests): default Inbox, explicit options, private rejection, assignee defaults, multiple assignees, event logging, edge cases\n=======\n- `permissions.py`: `can_write_task()` (private: owner only, shared: assignee/creator) and `validate_private_assignees()` helpers\n- Permission tests (11 tests): private/shared write checks, creator+assignee overlap, private assignee validation\n>>>>>>> origin/main", "new_string": "- `permissions.py`: `can_write_task()` (private: owner only, shared: assignee/creator) and `validate_private_assignees()` helpers\n- Permission tests (11 tests): private/shared write checks, creator+assignee overlap, private assignee validation\n- `cmd_add.py`: `/todo add` command handler with project resolution, assignee defaults, private-project validation, event logging\n- `add` handler registered in dispatcher (replaces stub)\n- cmd_add tests (10 tests): default Inbox, explicit options, private rejection, assignee defaults, multiple assignees, event logging, edge cases", "replace_all": false}, "tool_use_id": "toolu_018ChNYR2QRDs2wGvD63LZ9a", "_ts": "2026-02-20T19:30:17+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/CHANGELOG.md", "old_string": "<<<<<<< HEAD\n- `cmd_add.py`: `/todo add` command handler with project resolution, assignee defaults, private-project validation, event logging\n- `add` handler registered in dispatcher (replaces stub)\n- cmd_add tests (10 tests): default Inbox, explicit options, private rejection, assignee defaults, multiple assignees, event logging, edge cases\n=======\n- `permissions.py`: `can_write_task()` (private: owner only, shared: assignee/creator) and `validate_private_assignees()` helpers\n- Permission tests (11 tests): private/shared write checks, creator+assignee overlap, private assignee validation\n>>>>>>> origin/main", "new_string": "- `permissions.py`: `can_write_task()` (private: owner only, shared: assignee/creator) and `validate_private_assignees()` helpers\n- Permission tests (11 tests): private/shared write checks, creator+assignee overlap, private assignee validation\n- `cmd_add.py`: `/todo add` command handler with project resolution, assignee defaults, private-project validation, event logging\n- `add` handler registered in dispatcher (replaces stub)\n- cmd_add tests (10 tests): default Inbox, explicit options, private rejection, assignee defaults, multiple assignees, event logging, edge cases", "replace_all": false}, "tool_response": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/CHANGELOG.md", "oldString": "<<<<<<< HEAD\n- `cmd_add.py`: `/todo add` command handler with project resolution, assignee defaults, private-project validation, event logging\n- `add` handler registered in dispatcher (replaces stub)\n- cmd_add tests (10 tests): default Inbox, explicit options, private rejection, assignee defaults, multiple assignees, event logging, edge cases\n=======\n- `permissions.py`: `can_write_task()` (private: owner only, shared: assignee/creator) and `validate_private_assignees()` helpers\n- Permission tests (11 tests): private/shared write checks, creator+assignee overlap, private assignee validation\n>>>>>>> origin/main", "newString": "- `permissions.py`: `can_write_task()` (private: owner only, shared: assignee/creator) and `validate_private_assignees()` helpers\n- Permission tests (11 tests): private/shared write checks, creator+assignee overlap, private assignee validation\n- `cmd_add.py`: `/todo add` command handler with project resolution, assignee defaults, private-project validation, event logging\n- `add` handler registered in dispatcher (replaces stub)\n- cmd_add tests (10 tests): default Inbox, explicit options, private rejection, assignee defaults, multiple assignees, event logging, edge cases", "originalFile": "# Changelog\n\nAll notable changes to this project will be documented in this file.\n\n## [Unreleased]\n\n### Added\n- `db.py`: `get_connection(db_path)` helper with recursive directory creation, WAL mode, busy_timeout=3000\n- DB connection tests (4 tests)\n- `migrations.py`: sequential schema migration framework with `@register`, `migrate()`, `get_version()`\n- Migration tests (4 tests): fresh DB, sequential apply, idempotent rerun, rollback on failure\n- `schema_v1.py`: V1 migration creating projects, tasks, task_assignees, events tables\n- Partial unique indexes for shared/private project name constraints\n- Shared `Inbox` project auto-seeded\n- V1 schema tests (7 tests): tables, indexes, CHECK constraints, Inbox\n\n- `parser.py`: command tokenizer with `/p`, `/s`, `due:`, `<@U...>` extraction and `ParsedCommand` dataclass\n- Parser tests (13 tests): project, section, due normalisation, mentions, title extraction\n- `project_resolver.py`: project name resolution with private-first (PRD 3.2 Option A), Inbox auto-create\n- Project resolver tests (6 tests): private priority, shared fallback, Inbox auto-create, unknown error\n- `dispatcher.py`: command dispatcher with two-level routing (top-level + project subcommands), handler registry, DB init\n- Plugin `handle_message` delegates to dispatcher instead of placeholder response\n- Dispatcher tests (20 tests): command routing, project sub-routing, unknown commands, parse errors, DB init\n<<<<<<< HEAD\n- `cmd_add.py`: `/todo add` command handler with project resolution, assignee defaults, private-project validation, event logging\n- `add` handler registered in dispatcher (replaces stub)\n- cmd_add tests (10 tests): default Inbox, explicit options, private rejection, assignee defaults, multiple assignees, event logging, edge cases\n=======\n- `permissions.py`: `can_write_task()` (private: owner only, shared: assignee/creator) and `validate_private_assignees()` helpers\n- Permission tests (11 tests): private/shared write checks, creator+assignee overlap, private assignee validation\n>>>>>>> origin/main\n\n### Fixed\n- Enable `PRAGMA foreign_keys=ON` in `get_connection()` for referential integrity\n- Leap-year `due:02-29` parsing in MM-DD format (strptime year-1900 bug)\n\n## [0.1.0] - 2026-02-20\n\n### Added\n- Project scaffold with `pyproject.toml` (uv, Python >=3.11)\n- `src/openclaw_todo/` package with `__version__`\n- `handle_message(text, context)` plugin entry point\n- `/todo` prefix matching (non-todo messages silently ignored)\n- Smoke tests for plugin entry point (4 tests)\n", "structuredPatch": [{"oldStart": 21, "oldLines": 14, "newStart": 21, "newLines": 11, "lines": [" - `dispatcher.py`: command dispatcher with two-level routing (top-level + project subcommands), handler registry, DB init", " - Plugin `handle_message` delegates to dispatcher instead of placeholder response", " - Dispatcher tests (20 tests): command routing, project sub-routing, unknown commands, parse errors, DB init", "-<<<<<<< HEAD", "+- `permissions.py`: `can_write_task()` (private: owner only, shared: assignee/creator) and `validate_private_assignees()` helpers", "+- Permission tests (11 tests): private/shared write checks, creator+assignee overlap, private assignee validation", " - `cmd_add.py`: `/todo add` command handler with project resolution, assignee defaults, private-project validation, event logging", " - `add` handler registered in dispatcher (replaces stub)", " - cmd_add tests (10 tests): default Inbox, explicit options, private rejection, assignee defaults, multiple assignees, event logging, edge cases", "-=======", "-- `permissions.py`: `can_write_task()` (private: owner only, shared: assignee/creator) and `validate_private_assignees()` helpers", "-- Permission tests (11 tests): private/shared write checks, creator+assignee overlap, private assignee validation", "->>>>>>> origin/main", " ", " ### Fixed", " - Enable `PRAGMA foreign_keys=ON` in `get_connection()` for referential integrity"]}], "userModified": false, "replaceAll": false}, "tool_use_id": "toolu_018ChNYR2QRDs2wGvD63LZ9a", "_ts": "2026-02-20T19:30:17+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "grep -n \"<<<<<<\" /Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md 2>&1 | head -5", "description": "Find conflict markers in review_notes.md"}, "tool_use_id": "toolu_015G96pmjuKnEXni8kiGM6Xy", "_ts": "2026-02-20T19:30:21+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "grep -n \"<<<<<<\" /Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md 2>&1 | head -5", "description": "Find conflict markers in review_notes.md"}, "tool_response": {"stdout": "950:<<<<<<< HEAD\n972:<<<<<<< HEAD\n995:<<<<<<< HEAD\n1092:<<<<<<< HEAD", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_015G96pmjuKnEXni8kiGM6Xy", "_ts": "2026-02-20T19:30:21+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "offset": 945, "limit": 200}, "tool_use_id": "toolu_01HNMxSjGVugvmGC23RDSrWK", "_ts": "2026-02-20T19:30:24+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "offset": 945, "limit": 200}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "content": "4. **Context typing**: Introduce a `TypedDict` or dataclass for the `context` parameter (e.g., `class DispatchContext(TypedDict): sender_id: str`) to enable static type checking.\n5. **Input length guard**: Add a max-length check (e.g., 5000 chars) in `handle_message()` as defense-in-depth against oversized inputs.\n\n---\n\n<<<<<<< HEAD\n# PR #18 Review Notes -- Issue #6: /todo add command\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/006-cmd-add`\n=======\n# PR #16 Review Notes -- Issue #17: Permission helper module\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature-017-permissions`\n>>>>>>> origin/main\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n<<<<<<< HEAD\n| Task inserted with correct project_id, section, due, status='open', created_by | PASS | `test_add_default_inbox` and `test_add_with_project_section_due` verify all fields in DB |\n| Assignees default to sender when no mentions | PASS | `test_add_assignee_defaults_to_sender` verifies `task_assignees` row matches sender |\n| Multiple mentions create multiple task_assignee rows | PASS | `test_add_multiple_assignees` verifies two rows inserted and present in response |\n| Private project + non-owner assignee returns warning and does NOT insert | PASS | `test_add_private_rejects_other_assignee` verifies warning message and zero task rows |\n| Non-existent project: `Inbox` auto-created; others return error | PASS | `test_add_default_inbox` uses seeded Inbox; `test_add_nonexistent_project_returns_error` verifies error |\n| Response format: `Added #<id> (<project>/<section>) due:<due\\|-> assignees:<mentions> -- <title>` | PASS | All happy-path tests assert on this format |\n| Event row written to `events` table | PASS | `test_event_logged` verifies actor, action, task_id, and JSON payload fields |\n=======\n| `can_write_task(conn, task_id, sender_id) -> bool` exists | PASS | Function defined on line 11 of `permissions.py` with correct signature. |\n| Private project: only owner can write | PASS | Lines 34-40 check `sender_id == owner_user_id` when `visibility == \"private\"`. Tests `test_private_owner_can_write` and `test_private_non_owner_rejected` verify. |\n| Shared project: assignee or creator can write | PASS | Lines 43-60 check creator first, then query `task_assignees`. Tests `test_shared_assignee_can_write`, `test_shared_creator_can_write`, and `test_shared_unrelated_rejected` verify. |\n| Nonexistent task returns False | PASS | Lines 28-29 return `False` when row is None. Test `test_nonexistent_task` verifies. |\n| `validate_private_assignees(visibility, assignees, owner_id) -> str or None` exists | PASS | Function defined on line 63 with correct signature. |\n| Returns warning for non-owner assignees on private project | PASS | Lines 75-81. Test `test_validate_private_assignees_warning` verifies. |\n| Returns None for shared projects | PASS | Lines 72-73. Test `test_shared_always_ok` verifies. |\n| Returns None when all assignees are the owner | PASS | Lines 76-77. Test `test_private_all_owner_ok` verifies. |\n>>>>>>> origin/main\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n<<<<<<< HEAD\n| `test_add_default_inbox` | PASS |\n| `test_add_with_project_section_due` | PASS |\n| `test_add_private_rejects_other_assignee` | PASS |\n| `test_add_assignee_defaults_to_sender` | PASS |\n| `test_add_multiple_assignees` | PASS |\n\nAll 5 required tests present and passing. 5 additional tests (`test_add_private_allows_owner_assignee`, `test_event_logged`, `test_add_empty_title_returns_error`, `test_add_nonexistent_project_returns_error`, `test_add_due_clear_sentinel_stored_as_null`). 10 tests total.\n\n### Findings\n\n#### [Info] F1: No explicit transaction wrapping for multi-statement write\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-80\n- **Description**: The handler performs three sequential writes (task INSERT, assignee INSERTs, event INSERT) followed by a single `conn.commit()` at line 80. If any write after the task INSERT raises (e.g., duplicate assignee PK violation), partial writes remain uncommitted. SQLite's implicit rollback-on-close in the dispatcher's `finally` block protects data integrity.\n- **Action**: Consider wrapping in `with conn:` (context manager) for explicit transaction semantics in a future refactor. No functional bug today.\n\n#### [Info] F2: Missing `sender_id` key would raise unhandled KeyError\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 22\n- **Description**: `context[\"sender_id\"]` raises `KeyError` if the key is absent. The dispatcher contract requires `sender_id` in context, so this is defensive-coding territory.\n- **Action**: Acceptable. Could be improved with `.get()` + early return, but low priority given the documented contract.\n\n#### [Info] F3: Test gap -- non-owner sender adding to another user's private project\n\n- **File**: `tests/test_cmd_add.py`\n- **Description**: No test covers the case where sender U2 tries to add a task to a private project owned by U1. The `resolve_project()` function would return `ProjectNotFoundError` (it only matches private projects of the sender), which is correct behavior. However, there is no explicit test verifying this path through `add_handler`.\n- **Action**: Follow-up item. Add a test for \"non-owner sender cannot resolve another user's private project.\"\n\n#### [Info] F4: Title length is unbounded\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 23\n- **Description**: No max-length check on `title`. Slack messages cap at ~4000 chars, providing natural limits. The DB column is `TEXT NOT NULL` with no length constraint.\n- **Action**: Consider adding a max-length check if the handler is exposed outside Slack.\n\n#### [Info] F5: Dispatcher test correctly updated\n\n- **File**: `tests/test_dispatcher.py`, lines 34-51\n- **Description**: The parametrized stub test removed `\"add\"` from the stub-check list and added a dedicated `test_add_routes_to_handler` test that asserts `\"Added #\"` in the result. This correctly reflects that `add` is no longer a stub.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and correct:\n\n- Uses `resolve_project()` for project resolution following PRD Option A (private-first).\n- Private assignee validation correctly rejects non-owner assignees with a descriptive warning.\n- All SQL uses parameterized queries (`?` placeholders).\n- Event payload is well-structured JSON with title, project, section, due, and assignees.\n- Response format matches the PRD/UX spec exactly.\n- 10 tests with thorough assertions on both the response string and DB state.\n- No unnecessary complexity or over-engineering.\n\n**Verdict: APPROVE** -- no blocking issues. No fixes required.\n=======\n| `test_private_owner_can_write` | PASS |\n| `test_private_non_owner_rejected` | PASS |\n| `test_shared_assignee_can_write` | PASS |\n| `test_shared_creator_can_write` | PASS |\n| `test_shared_unrelated_rejected` | PASS |\n| `test_nonexistent_task` | PASS |\n| `test_validate_private_assignees_warning` | PASS |\n| `test_private_all_owner_ok` | PASS |\n| `test_shared_always_ok` | PASS |\n| `test_private_empty_assignees_ok` | PASS |\n\nAll 10 tests present and passing. 48 tests total in the suite.\n\n### Findings\n\n#### [Medium] F1: Shared project owner cannot modify tasks they did not create or get assigned to — CONFIRMED INTENTIONAL\n\n- **Description**: In a shared project, only the task creator and assignees are allowed to write. The project owner has no special privileges. User confirmed this is intentional: only task creator and assignees should have task write access.\n- **Status**: CLOSED as intentional design.\n\n#### [Low] F2: `validate_private_assignees` with `owner_id=None` marks all assignees as non-owner\n\n- **Description**: When `owner_id` is `None` on a private project (data integrity issue), all assignees would be flagged as non-owner. Function short-circuits for shared projects, so this only affects corrupted data.\n- **Status**: OPEN, non-blocking.\n\n#### [Low] F3: No test for shared project where sender is both creator and assignee — FIXED\n\n- **Description**: Added `test_shared_creator_and_assignee_can_write` in commit 594cad4. Creator short-circuit handles this correctly.\n- **Status**: FIXED.\n\n#### [Low] F4: `_create_project` helper uses complex SELECT instead of `last_insert_rowid()`\n\n- **Status**: OPEN, non-blocking.\n\n### Code Quality Summary\n\n**Verdict: APPROVE** -- no Critical or High findings. F1 confirmed intentional, F3 fixed.\n>>>>>>> origin/main\n\n---\n\n## Security Findings\n\n<<<<<<< HEAD\n### [Info] S1: SQL injection -- No risk\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-78\n- **Description**: All three SQL statements (task INSERT, assignee INSERT, event INSERT) use `?` parameter placeholders. No string interpolation or f-strings in SQL. Title, project_id, section, due, sender_id, and assignee values are all passed as parameters.\n- **Severity**: Info (no risk found)\n\n### [Info] S2: Authorization model is sound\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 41-49\n- **Description**: Private project constraint correctly checks that all assignees match the project owner. The `resolve_project()` function provides implicit access control by only resolving the sender's own private projects (scoped by `owner_user_id = sender_id` in the SQL query). A non-owner sender cannot resolve another user's private project by name. The explicit assignee check in `cmd_add.py` is an additional layer for when the owner assigns tasks to others within their private project.\n- **Severity**: Info (no bypass possible)\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in any changed files.\n\n### [Info] S4: No new dependencies introduced\n\n- `cmd_add.py` uses only standard library (`json`, `logging`, `sqlite3`) plus internal modules (`parser`, `project_resolver`). No new entries in `pyproject.toml`.\n\n### [Info] S5: Input validation adequate\n\n- Empty title returns error (line 25-26).\n- Non-existent project returns error via `ProjectNotFoundError` (lines 30-33).\n- Section validation handled by parser upstream (`VALID_SECTIONS` check).\n- Due date validation handled by parser upstream (`_normalise_due`).\n- Mention format constrained by parser regex (`<@U[A-Z0-9]+>`).\n\n### Security Summary\n\nNo Critical, High, Medium, or Low severity findings. The implementation has a minimal attack surface -- three parameterized INSERT statements, project resolution with sender-scoped authorization, and input validation at both the parser and handler layers. The code is secure for the current Slack DM context.\n\n---\n\n## Follow-up Items\n\n1. **Test coverage**: Add a test for non-owner sender attempting to add a task to another user's private project (should get `ProjectNotFoundError` via resolver).\n2. **Transaction explicitness**: Consider wrapping the three DB writes in `with conn:` for explicit transaction semantics.\n3. **Title length**: Consider adding a max-length validation (e.g., 500 chars) as defense-in-depth.\n4. **Permissions module**: When Issue #17 (permissions helper) is merged, consider extracting the inline private-assignee validation to use the shared `validate_private_assignees()` function.\n=======\nNo Critical, High, or Medium severity security findings. All SQL parameterized. Fail-closed design. Three Low findings noted for awareness.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Defensive guard**: Consider adding a log warning in `validate_private_assignees` when `visibility == \"private\"` and `owner_id is None`.\n2. **Test consistency**: Align `_create_project` helper to use `last_insert_rowid()` like `_create_task`.\n\n---\n", "numLines": 200, "startLine": 945, "totalLines": 1174}}, "tool_use_id": "toolu_01HNMxSjGVugvmGC23RDSrWK", "_ts": "2026-02-20T19:30:24+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "old_string": "<<<<<<< HEAD\n# PR #18 Review Notes -- Issue #6: /todo add command\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/006-cmd-add`\n=======\n# PR #16 Review Notes -- Issue #17: Permission helper module\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature-017-permissions`\n>>>>>>> origin/main", "new_string": "# PR #16 Review Notes -- Issue #17: Permission helper module\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature-017-permissions`", "replace_all": false}, "tool_use_id": "toolu_01J6W4c1jTSBp2KvRgt9ZA6f", "_ts": "2026-02-20T19:30:32+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "old_string": "<<<<<<< HEAD\n# PR #18 Review Notes -- Issue #6: /todo add command\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/006-cmd-add`\n=======\n# PR #16 Review Notes -- Issue #17: Permission helper module\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature-017-permissions`\n>>>>>>> origin/main", "new_string": "# PR #16 Review Notes -- Issue #17: Permission helper module\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature-017-permissions`", "replace_all": false}, "tool_response": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "oldString": "<<<<<<< HEAD\n# PR #18 Review Notes -- Issue #6: /todo add command\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/006-cmd-add`\n=======\n# PR #16 Review Notes -- Issue #17: Permission helper module\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature-017-permissions`\n>>>>>>> origin/main", "newString": "# PR #16 Review Notes -- Issue #17: Permission helper module\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature-017-permissions`", "originalFile": "# PR #2 Review Notes -- Issue #1: Plugin skeleton and entry point\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/001-plugin-skeleton`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `pyproject.toml` with Python >=3.11, pytest, pytest-cov dev deps | PASS | Correct. Uses `dependency-groups` (PEP 735) with hatchling backend. |\n| `src/openclaw_todo/__init__.py` exposes `__version__` | PASS | `__version__ = \"0.1.0\"` |\n| `handle_message(text: str, context: dict) -> str` entry point | PASS (minor note) | Return type is `str | None`, not `str`. The AC literally says `-> str` but `None` for ignored messages is the intended behavior per the next AC. Acceptable. |\n| Non-`/todo` messages silently ignored (returns `None`) | PASS | |\n| `uv sync && uv run pytest -q` passes | PASS | 4 tests, 100% coverage |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_ignores_non_todo_message` | PASS -- covers empty string, random text, `/todox` prefix-collision |\n| `test_dispatches_todo_prefix` | PASS -- verifies non-None response with subcommand text |\n\n### Findings\n\n#### [Info] Return type annotation mismatch with AC\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 12\n- The AC states `-> str` but the implementation is `-> str | None`. This is correct behavior (returning `None` for non-todo messages is explicitly required). The AC text is slightly imprecise; the code is right.\n- **Action**: None needed. Consider updating the AC wording if desired.\n\n#### [Info] `context` parameter unused\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 12\n- `context: dict` is accepted but never read in this skeleton. This is expected for M0 -- it will be used once the dispatcher (Issue #16) and DB commands are wired in.\n- **Action**: None. This is intentional scaffolding.\n\n#### [Info] Placeholder response includes raw user input\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 32\n- `f\"TODO command received: {remainder}\"` echoes back unescaped user input. This is a temporary placeholder (comment says \"will be replaced by dispatcher in Issue #16\"). In the current context (no HTML/web rendering, Slack DM only), this is not exploitable, but see Security Findings below.\n- **Action**: Track as part of Issue #16.\n\n#### [Info] Extra tests beyond AC requirements -- good\n\n- `test_todo_prefix_with_whitespace` and `test_todo_without_subcommand` are bonus tests covering whitespace handling and bare `/todo` usage message. Good coverage instinct.\n\n#### [Info] Version duplication\n\n- Version `0.1.0` appears in both `pyproject.toml` and `__init__.py`. Consider using `importlib.metadata` or dynamic versioning in a future issue to keep a single source of truth. Not a concern for M0.\n\n#### [Low] No type hints for `context` dict\n\n- `context: dict` is untyped (could be `dict[str, Any]` or a TypedDict). For M0 this is fine, but a `TypedDict` or dataclass should be introduced when the context shape solidifies.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and well-structured for a skeleton:\n\n- Prefix matching logic (`stripped == _TODO_PREFIX or stripped.startswith(_TODO_PREFIX + \" \")`) correctly avoids false positives on `/todox`.\n- Logging at appropriate levels (debug for all messages, info for matches).\n- Usage help returned for bare `/todo` is a nice touch.\n- Test coverage is 100%.\n\n**Verdict: APPROVE** -- no blocking issues.\n\n---\n\n## Security Findings\n\n### [Low] S1: User input echoed in placeholder response\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 32\n- **Description**: The placeholder `f\"TODO command received: {remainder}\"` reflects user-supplied text without sanitization. In the current Slack DM context, Slack handles rendering and this is not exploitable for XSS. However, once a web dashboard or logging UI is introduced, unsanitized echo could become a reflected XSS vector.\n- **Severity**: Low (Slack auto-escapes; placeholder will be replaced in Issue #16)\n- **Recommendation**: When building the real dispatcher, ensure any user text echoed in responses is sanitized if it ever reaches a web context. No fix needed now.\n\n### [Low] S2: No input length validation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 12\n- **Description**: `handle_message` accepts arbitrarily long strings. A malicious or buggy client could send extremely large messages. Slack itself limits messages to ~40,000 characters, so this is mitigated at the transport layer.\n- **Severity**: Low\n- **Recommendation**: Consider adding a max-length guard in the dispatcher (Issue #16) if the plugin is ever exposed outside Slack.\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in any reviewed files. Environment variable approach is correctly deferred to future DB/config work.\n\n### [Info] S4: Dependencies are minimal and current\n\n- Only dev dependencies: `pytest>=7.0` and `pytest-cov>=4.0`. No known CVEs for these versions. No runtime dependencies beyond the standard library.\n- Build backend `hatchling` is a well-maintained, standard tool.\n\n### [Info] S5: No SQL, no deserialization, no file I/O\n\n- The M0 skeleton has no database, no file operations, and no deserialization. The attack surface is effectively zero at this stage.\n\n### Security Summary\n\nNo Critical or High severity findings. The codebase has a minimal attack surface appropriate for a plugin skeleton. Security considerations will become relevant starting with Issue #2 (DB connection) and Issue #5 (parser with user-controlled input).\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Issue #16 (Dispatcher)**: When replacing the placeholder response, ensure user input is not echoed raw if the output context changes (e.g., web UI).\n2. **Future**: Introduce a `TypedDict` or dataclass for the `context` parameter to enforce shape and enable static analysis.\n3. **Future**: Consolidate version to a single source (e.g., `importlib.metadata.version(\"openclaw-todo-plugin\")`).\n\n---\n\n# PR #4 Review Notes -- Issue #2: DB module -- connection helper and pragma setup\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/002-db-connection`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| Directory is created recursively when absent | PASS | `db_dir.mkdir(parents=True, exist_ok=True)` on line 32. Test `test_creates_directory_and_file` verifies nested `nested/dir/` creation. |\n| SQLite connection returned with WAL mode enabled | PASS | `PRAGMA journal_mode=WAL` on line 36. Test verifies `fetchone()[0] == \"wal\"`. |\n| `busy_timeout` is 3000 | PASS | `PRAGMA busy_timeout=3000` on line 37. Test verifies `fetchone()[0] == 3000`. |\n| Calling `get_connection` twice returns usable connections (no lock conflict) | PASS | `test_two_connections_no_conflict` creates a table via conn1, reads via conn2. WAL mode enables this concurrency. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `tests/test_db.py::test_creates_directory_and_file` | PASS -- verifies both `db_path.exists()` and `db_path.parent.exists()` with nested `tmp_path` |\n| `tests/test_db.py::test_wal_mode_enabled` | PASS -- queries `PRAGMA journal_mode` and asserts `\"wal\"` |\n| `tests/test_db.py::test_busy_timeout` | PASS -- queries `PRAGMA busy_timeout` and asserts `3000` |\n\n### Findings\n\n#### [Info] TOCTOU in `is_new` logging check\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 29\n- `is_new = not db_path.exists()` is checked before `sqlite3.connect()`, which itself creates the file. In a concurrent scenario, the file could appear between the check and the connect. This only affects which log message is emitted (info vs. debug) and has no functional impact.\n- **Action**: None required. Purely cosmetic race condition.\n\n#### [Info] PRAGMA return values not checked\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, lines 36-37\n- `conn.execute(\"PRAGMA journal_mode=WAL;\")` returns a result set with the actual journal mode applied. On some edge cases (e.g., read-only filesystem, in-memory DB), WAL activation can silently fall back to another mode. The code does not verify the return.\n- **Action**: Low priority. Consider adding a debug-level assertion or log warning in a future hardening pass. The test suite already validates WAL is active in the happy path.\n\n#### [Info] Default path uses `Path.home()`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 11\n- `DEFAULT_DB_DIR = Path.home() / \".openclaw\" / \"workspace\" / \".todo\"` is evaluated at module import time. If `HOME` is unset (e.g., certain containerized environments), `Path.home()` raises `RuntimeError`. This is acceptable since: (a) the default is only used when `db_path is None`, and (b) the plugin is designed for environments where `HOME` is set. Callers in containers should pass an explicit path.\n- **Action**: None for M1. Document the `db_path` parameter as the recommended override for non-standard environments.\n\n#### [Info] Extra test beyond AC requirements -- good\n\n- `test_two_connections_no_conflict` is a bonus test that exercises concurrent WAL access. This directly validates the 4th acceptance criterion and is well-structured with proper cleanup in a `finally` block.\n\n#### [Low] Test cleanup uses `try/finally` instead of a fixture\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_db.py`, all tests\n- Each test manually opens a connection and closes it in `try/finally`. A pytest fixture (e.g., `@pytest.fixture` yielding the connection) would reduce boilerplate and guarantee cleanup even if assertion lines are added later. This is a minor style observation for 4 tests.\n- **Action**: Optional refactor. Not blocking.\n\n#### [Info] Coverage at 96%\n\n- Line 24 (`db_path = DEFAULT_DB_DIR / DEFAULT_DB_NAME`) is uncovered because all tests pass explicit `tmp_path` paths. This is correct -- testing the default path would write to the user's actual home directory. The uncovered line is trivial assignment logic.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and correct:\n\n- Function signature `get_connection(db_path: str | Path | None = None)` is flexible, accepting string, Path, or None.\n- `Path(db_path)` normalization on line 26 handles string inputs.\n- `exist_ok=True` on `mkdir` prevents race conditions with concurrent directory creation.\n- Logging at appropriate levels: `info` for creation, `debug` for opens.\n- No unnecessary dependencies -- uses only stdlib `sqlite3`, `pathlib`, and `logging`.\n- 96% test coverage with all acceptance criteria verified.\n\n**Verdict: APPROVE** -- no blocking issues.\n\n---\n\n## Security Findings\n\n### [Low] S1: `db_path` parameter accepts arbitrary filesystem paths\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 15\n- **Description**: `get_connection(db_path)` will create directories and an SQLite database at any filesystem path the process has write access to. If a future caller passes unsanitized user input as `db_path`, this could be used for arbitrary file creation (e.g., path traversal via `../../etc/cron.d/evil`).\n- **Severity**: Low (currently an internal API; no user-facing code path passes user input to `db_path`)\n- **Recommendation**: When wiring `db_path` into the dispatcher (Issue #16), ensure the path comes only from configuration (env var or config file), never from user-controlled message text. Consider adding a validation that `db_path` is within an expected base directory.\n\n### [Info] S2: No SQL injection risk\n\n- PRAGMA statements on lines 36-37 use hardcoded string literals with no interpolation. The `db_path` is passed to `sqlite3.connect()` as a filesystem path, not as a SQL query. No injection surface exists.\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `db.py` or `test_db.py`. The module uses only stdlib.\n\n### [Info] S4: No new dependencies introduced\n\n- This module uses only Python standard library (`sqlite3`, `pathlib`, `logging`). No new entries in `pyproject.toml` dependencies. Zero additional attack surface from third-party code.\n\n### [Info] S5: SQLite WAL mode is a security-positive choice\n\n- WAL mode improves concurrent access safety and reduces the risk of database corruption from concurrent writes. The `busy_timeout=3000` prevents immediate lock failures, which could otherwise cause data loss if a caller does not handle `sqlite3.OperationalError` properly.\n\n### Security Summary\n\nNo Critical or High severity findings. The attack surface is minimal -- a single function that creates a local SQLite database with hardcoded pragmas. The only surface to monitor is ensuring `db_path` remains configuration-controlled as the codebase grows.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Issue #3 (Migration framework)**: When implementing migrations, ensure SQL statements use parameterized queries (not string formatting) for any dynamic values. The migration runner should validate migration callables are from a trusted registry.\n2. **Future**: Add a pytest fixture for `get_connection` that yields and auto-closes, reducing `try/finally` boilerplate across DB-related test files.\n3. **Future**: Consider adding a `validate_db_path(path)` helper that constrains paths to an allowed base directory, for defense-in-depth when the dispatcher wires in configuration.\n\n---\n\n# PR #6 Review Notes -- Issue #3: Schema migration framework and schema_version table\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/003-schema-migration`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `schema_version` table created with single row `version=0` if absent | PASS | `_ensure_version_table` uses `CREATE TABLE IF NOT EXISTS` and inserts `version=0` only when no row exists (line 30-31). |\n| Migrations are Python callables registered in an ordered list | PASS | `_migrations: list[MigrationFn]` with `@register` decorator appending to the list. Index maps directly to migration version. |\n| Each migration runs inside a transaction; version incremented on success | PASS | `conn.commit()` after each successful migration (line 65). SQLite's implicit transaction wraps the migration + version update. |\n| Re-running on an up-to-date DB is a no-op | PASS | `current >= target` guard on line 52 returns immediately. Test `test_idempotent_on_rerun` verifies. |\n| Failing migration rolls back and raises with clear message | PASS | `conn.rollback()` in `except` block (line 67). `RuntimeError` with formatted message including version number and original exception (line 68-70). |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_fresh_db_gets_version_table` | PASS -- verifies `get_version` returns 0 and `schema_version` table exists in `sqlite_master` |\n| `test_applies_migrations_sequentially` | PASS -- registers two migrations, asserts final version is 2, verifies both tables created |\n| `test_idempotent_on_rerun` | PASS -- calls `migrate` twice, both return 1, no errors |\n| `test_rollback_on_failure` | PASS -- first migration commits (version 1, `t_ok` exists), second raises `ValueError`, caught as `RuntimeError`, version stays at 1 |\n\n### Findings\n\n#### [Medium] No constraint preventing multiple rows in `schema_version`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- The `schema_version` table is created with `(version INTEGER NOT NULL)` but has no PRIMARY KEY, UNIQUE constraint, or CHECK constraint limiting it to a single row. If a bug or manual intervention inserts a second row, `get_version` would return whichever row SQLite returns first from `SELECT version FROM schema_version` (non-deterministic without ORDER BY).\n- **Action**: Consider adding a single-row constraint in a future migration (e.g., `CHECK (rowid = 1)` or a dummy `id INTEGER PRIMARY KEY CHECK (id = 1)` column). Not blocking for M1 since all writes go through `_ensure_version_table` which correctly checks before inserting.\n\n#### [Low] Redundant `_ensure_version_table` calls\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, lines 48-49\n- `migrate()` calls `_ensure_version_table(conn)` on line 48, then calls `get_version(conn)` on line 49, which internally calls `_ensure_version_table` again. This results in two `CREATE TABLE IF NOT EXISTS` and two `SELECT version` queries on every `migrate` call.\n- **Action**: Minor performance concern. Could be refactored so `migrate` calls `_ensure_version_table` once and reads the version directly. Not blocking.\n\n#### [Info] Global mutable state for migrations registry\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 15\n- `_migrations` is a module-level mutable list. This is a common pattern for migration registries and works well for single-process applications. The test suite correctly saves/restores it via the `_clean_migrations` autouse fixture (lines 16-23 in test file).\n- **Action**: None. This is an appropriate pattern for this use case. If multi-process or plugin-based architectures are introduced later, consider a class-based registry.\n\n#### [Info] Test fixture properly isolates migration state\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_migrations.py`, lines 16-23\n- The `_clean_migrations` fixture saves the original list, clears it before each test, and restores it after. This prevents test pollution and is correctly marked `autouse=True`. The save-clear-yield-clear-extend pattern is the correct idiom.\n\n#### [Info] `conn` fixture uses `get_connection` from `db` module\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_migrations.py`, lines 27-31\n- The test fixture uses `get_connection` (from Issue #2) rather than raw `sqlite3.connect`. This ensures WAL mode and `busy_timeout` pragmas are applied, matching production behavior. This is a good integration practice.\n\n#### [Info] Coverage at 100%\n\n- All 41 statements in `migrations.py` are covered by the 4 tests. No untested branches.\n\n#### [Info] Error message includes original exception\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, lines 68-70\n- `raise RuntimeError(...) from exc` preserves the exception chain, making debugging easier. The message format `\"Migration to version {N} failed: {exc}\"` clearly identifies which migration failed. This follows the acceptance criterion for \"clear message.\"\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and minimal:\n\n- The `@register` decorator pattern is intuitive for defining migrations in order.\n- Transaction semantics are correctly handled: commit on success, rollback on failure.\n- The version update uses a parameterized query (`?` placeholder on line 63), avoiding SQL injection.\n- Logging at appropriate levels: `info` for migration steps and completion, `debug` for up-to-date status.\n- The code correctly handles the edge case where `current > target` (e.g., if migrations are removed), treating it the same as up-to-date.\n- 100% test coverage with all four required tests present and passing.\n\n**Verdict: APPROVE** -- no blocking issues. One medium finding (missing single-row constraint) noted for follow-up.\n\n---\n\n## Security Findings\n\n### [Medium] S1: `schema_version` table lacks row-count constraint\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- **Description**: The `schema_version` table has no mechanism to enforce that exactly one row exists. While the application code only writes through `_ensure_version_table` (which checks before inserting) and `migrate` (which uses `UPDATE`), a direct SQL injection in a future module or manual DB editing could insert additional rows, causing `get_version` to return an unpredictable value. This could lead to migrations being skipped or re-applied.\n- **Severity**: Medium (requires either a separate SQL injection vulnerability or direct DB access to exploit; impact is schema corruption)\n- **Recommendation**: In the V1 schema migration (Issue #4), alter or recreate the table with a single-row constraint, e.g., `CREATE TABLE schema_version (id INTEGER PRIMARY KEY CHECK (id = 1), version INTEGER NOT NULL)`.\n\n### [Info] S2: No SQL injection risk in migration runner\n\n- All SQL in `migrations.py` uses either hardcoded string literals or parameterized queries (`?` on line 63 for the version update). The `MigrationFn` type receives a `Connection` object, and it is the responsibility of each registered migration to use parameterized queries. This is correctly documented in the PR #4 review follow-up.\n\n### [Info] S3: Migration functions are trusted code\n\n- The `@register` decorator appends arbitrary callables to the migration list. Since migrations are defined at module import time by the application developer (not by user input), there is no injection risk. The registry is not exposed to any user-facing API.\n\n### [Info] S4: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `migrations.py` or `test_migrations.py`.\n\n### [Info] S5: No new dependencies introduced\n\n- This module uses only Python standard library (`sqlite3`, `logging`, `typing`). No new entries in `pyproject.toml` dependencies.\n\n### [Info] S6: Exception message does not leak sensitive data\n\n- The `RuntimeError` message on line 69 includes the migration version number and the string representation of the original exception. In this context (local SQLite, no user-supplied data in migration functions), this does not leak sensitive information. If migrations ever process user data, the exception wrapping should be reviewed to avoid leaking PII in logs.\n\n### Security Summary\n\nNo Critical or High severity findings. One Medium finding regarding the missing single-row constraint on `schema_version`, which could lead to schema version confusion if combined with a separate vulnerability that allows arbitrary SQL execution. The recommendation is to address this in the Issue #4 V1 schema migration.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Issue #4 (V1 schema)**: Add a single-row constraint to `schema_version` (e.g., `CHECK (id = 1)` on a primary key column) as part of the V1 migration to prevent version-table corruption.\n2. **Future**: Refactor `migrate()` to avoid redundant `_ensure_version_table` calls for minor performance improvement.\n3. **Future**: Consider adding a `--dry-run` mode to the migration runner that reports which migrations would be applied without executing them, useful for deployment verification.\n\n---\n\n# PR #8 Review Notes -- Issue #4: V1 schema migration -- projects, tasks, task_assignees, events\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/004-v1-schema`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `projects` table with `ux_projects_shared_name` and `ux_projects_private_owner_name` partial unique indexes | PASS | Table created on lines 18-26, indexes on lines 28-36 of `schema_v1.py`. Partial `WHERE` clauses match PRD exactly. |\n| `tasks` table with section and status CHECK constraints | PASS | Section CHECK on line 43 (`backlog, doing, waiting, done, drop`), status CHECK on line 45 (`open, done, dropped`). Both match PRD spec. |\n| `task_assignees` table with composite PK and secondary index | PASS | Composite `PRIMARY KEY (task_id, assignee_user_id)` on line 57, secondary index `ix_task_assignees_user` on lines 61-64. |\n| `events` audit table created | PASS | Table on lines 66-75. Columns match PRD. |\n| Shared `Inbox` project auto-created (INSERT OR IGNORE) | PASS | Line 78-81 uses `INSERT OR IGNORE` with `('Inbox', 'shared', NULL)`. |\n| `schema_version` = 1 after migration | PASS | Test `test_v1_schema_version` verifies `get_version(conn) == 1`. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_v1_tables_exist` | PASS -- verifies all four tables exist in `sqlite_master` |\n| `test_v1_inbox_created` | PASS -- verifies name='Inbox', visibility='shared', owner_user_id=None |\n| `test_v1_shared_unique_index_enforced` | PASS -- duplicate shared name raises `IntegrityError` |\n| `test_v1_private_unique_index_enforced` | PASS -- duplicate (owner, name) raises `IntegrityError`; different owner succeeds |\n\n### Findings\n\n#### [High] F1: Foreign keys not enforced -- `PRAGMA foreign_keys=ON` missing\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 35-37\n- **Description**: SQLite does not enforce `REFERENCES` (foreign key) clauses by default. The `PRAGMA foreign_keys=ON` must be executed on every new connection for FK constraints to be active. Without this, the `REFERENCES projects(id)` on `tasks.project_id` and `REFERENCES tasks(id)` on `task_assignees.task_id` are purely decorative -- you can insert tasks pointing to non-existent projects and assignees pointing to non-existent tasks.\n- **Impact**: Referential integrity is silently not enforced, leading to orphaned rows and data corruption.\n- **Fix applied**: Added `conn.execute(\"PRAGMA foreign_keys=ON;\")` to `get_connection()` in `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 38. All 19 tests pass after the fix.\n\n#### [Medium] F2: `schema_version` single-row constraint not added in V1\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- **Description**: The PR #6 review (Medium finding S1) recommended adding a single-row constraint to `schema_version` as part of the V1 migration. This was not addressed. The table still has no PK or CHECK constraint to prevent multiple rows.\n- **Action**: Should be addressed in a follow-up issue. Adding it retroactively in a later migration (e.g., V2) would require recreating the table since SQLite does not support `ALTER TABLE ADD CONSTRAINT`.\n\n#### [Low] F3: Minor PRD deviation on `events.ts` -- NOT NULL DEFAULT added\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/schema_v1.py`, line 69\n- **Description**: The PRD spec for `events.ts` says `ts TEXT` with no nullability or default constraint. The implementation adds `NOT NULL DEFAULT (datetime('now'))`. This is a sensible enhancement (audit timestamps should always be present), but it is a deviation from the spec.\n- **Action**: None needed. The implementation is better than the spec. Consider updating the PRD to match.\n\n#### [Low] F4: `events.id` uses AUTOINCREMENT, PRD says PK only\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/schema_v1.py`, line 68\n- **Description**: PRD says `id INTEGER PK` for the events table. The implementation uses `INTEGER PRIMARY KEY AUTOINCREMENT`. AUTOINCREMENT prevents rowid reuse after deletion, which is actually preferable for an audit log (guarantees monotonically increasing IDs). This is a minor deviation but a positive one.\n- **Action**: None needed. Consider updating the PRD.\n\n#### [Low] F5: No test for `task_assignees` composite PK enforcement\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_schema_v1.py`\n- **Description**: The acceptance criteria mention `task_assignees` table with composite PK, but there is no test verifying that inserting a duplicate `(task_id, assignee_user_id)` pair raises `IntegrityError`. The composite PK is created, but its enforcement is untested.\n- **Action**: Add a test in a follow-up to insert a duplicate pair and assert `IntegrityError`.\n\n#### [Low] F6: No test for foreign key enforcement\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_schema_v1.py`\n- **Description**: No test verifies that inserting a task with a non-existent `project_id` raises an error, or that inserting a `task_assignee` with a non-existent `task_id` raises an error. With the FK pragma fix (F1), these would now fail correctly, but there is no test coverage for this behavior.\n- **Action**: Add FK enforcement tests in a follow-up.\n\n#### [Info] F7: Test fixture pattern is well-structured\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_schema_v1.py`, lines 11-25\n- The `_load_v1_migration` autouse fixture correctly saves, clears, imports, and restores the migration registry. The `conn` fixture properly creates a temp DB, migrates, yields, and closes. This is clean test isolation.\n\n#### [Info] F8: CHECK constraint tests are thorough\n\n- Tests `test_v1_section_check_constraint` and `test_v1_status_check_constraint` go beyond the required tests to verify that invalid enum values are rejected. Good defensive testing.\n\n#### [Info] F9: 8 tests total for V1 schema, all passing\n\n- `test_v1_tables_exist`, `test_v1_schema_version`, `test_v1_inbox_created`, `test_v1_shared_unique_index_enforced`, `test_v1_private_unique_index_enforced`, `test_v1_section_check_constraint`, `test_v1_status_check_constraint` (7 tests in `test_schema_v1.py`). Plus the rollback test verifies `conn.rollback()` is correctly called after each constraint violation test.\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and closely follows the PRD spec:\n\n- All four tables are created with the correct columns, types, and constraints.\n- Partial unique indexes use the correct `WHERE` clause syntax.\n- CHECK constraints enumerate exactly the values specified in the PRD.\n- `INSERT OR IGNORE` for the Inbox seed is idempotent.\n- Parameterized queries are not needed here (all DDL uses string literals with no interpolation).\n- The `@register` decorator integrates seamlessly with the migration framework from Issue #3.\n- Test coverage is good, with 7 tests covering table existence, version, seed data, unique indexes, and CHECK constraints.\n\n**Verdict: APPROVE with one fix applied** -- the `PRAGMA foreign_keys=ON` fix (High, F1) has been applied directly. Medium/Low findings are noted for follow-up.\n\n---\n\n## Security Findings\n\n### [High] S1: Foreign key constraints not enforced (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 35-37\n- **Description**: Without `PRAGMA foreign_keys=ON`, all `REFERENCES` clauses in the V1 schema are ignored. This means a future command handler could insert tasks referencing non-existent projects or assignees referencing non-existent tasks, leading to data integrity violations that are silent and hard to debug. In a multi-user Slack plugin, this could allow one user's actions to create orphaned records that cause errors for other users.\n- **Severity**: High (data integrity violation in a multi-user context; silent failure mode)\n- **Fix**: Added `conn.execute(\"PRAGMA foreign_keys=ON;\")` to `get_connection()`. All 19 tests pass.\n\n### [Medium] S2: `schema_version` table remains unprotected against multi-row corruption\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- **Description**: Carried forward from PR #6 review. The `schema_version` table has no constraint preventing insertion of additional rows. If a separate vulnerability allows arbitrary SQL execution, an attacker could manipulate the schema version to skip or re-run migrations.\n- **Severity**: Medium (requires a chained vulnerability to exploit)\n- **Recommendation**: Address in a future migration that recreates the table with a single-row constraint.\n\n### [Info] S3: No SQL injection risk in V1 migration\n\n- All SQL in `schema_v1.py` uses hardcoded string literals. No user input, no string interpolation, no parameterized queries needed. The `INSERT OR IGNORE` for the Inbox seed uses literal values only.\n\n### [Info] S4: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `schema_v1.py` or `test_schema_v1.py`.\n\n### [Info] S5: No new dependencies introduced\n\n- The V1 migration uses only Python standard library (`sqlite3`, `logging`). No new entries in `pyproject.toml`.\n\n### [Info] S6: CHECK constraints provide defense-in-depth\n\n- The `section` and `status` CHECK constraints on the `tasks` table prevent invalid enum values at the database level, not just the application level. This is a security-positive pattern that prevents data corruption even if the application layer has a bug.\n\n### Security Summary\n\nOne High severity finding (S1: missing `PRAGMA foreign_keys=ON`) was identified and fixed directly in `db.py`. One Medium finding (S2: `schema_version` single-row constraint) is carried forward from the previous review. No Critical findings.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Test coverage**: Add tests for `task_assignees` composite PK enforcement (duplicate pair should raise `IntegrityError`).\n2. **Test coverage**: Add tests for foreign key enforcement (task with non-existent `project_id`, assignee with non-existent `task_id` should raise `IntegrityError` now that FK pragma is enabled).\n3. **Schema version constraint**: Address the `schema_version` single-row constraint in a future migration (V2 or later) by recreating the table with `CHECK (id = 1)`.\n4. **PRD sync**: Update PRD section 6.3 to add `NOT NULL DEFAULT (datetime('now'))` to `events.ts` and `AUTOINCREMENT` to `events.id` to match the implementation.\n5. **DB module**: Add a test for `PRAGMA foreign_keys` returning `1` in `test_db.py` to prevent regression.\n\n---\n\n# PR #10 Review Notes -- Issue #5: Command parser -- tokenizer and option extraction\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/005-parser-tokenizer`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `/p MyProject` correctly extracted; token consumed | PASS | `test_extract_project` verifies project name extracted, `/p` and value removed from `title_tokens`. |\n| `/s doing` validated; invalid section raises `ParseError` | PASS | `test_extract_section_valid` and `test_extract_section_invalid` cover both paths. Case-insensitive via `.lower()`. |\n| `due:03-15` normalised to `2026-03-15` (current year) | PASS | `test_due_mm_dd_normalisation` verifies with `date.today().year`. |\n| `due:2026-02-30` raises `ParseError` (invalid date) | PASS | `test_due_invalid_date` asserts `ParseError` with match on \"Invalid due date\". |\n| `<@U12345>` extracted into mentions list | PASS | `test_mentions_extraction` verifies two mentions extracted and not in `title_tokens`. |\n| Multiple mentions supported | PASS | Same test covers two mentions in order. |\n| Title tokens are non-option, non-mention tokens before first option | PASS | `test_title_extraction` verifies correct split with mixed options. Note: title tokens are collected from *all* positions, not just \"before first option\" -- this is arguably more flexible than the AC wording. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_extract_project` | PASS |\n| `test_extract_section_valid` | PASS |\n| `test_extract_section_invalid` | PASS |\n| `test_due_mm_dd_normalisation` | PASS |\n| `test_due_full_date` | PASS |\n| `test_due_invalid_date` | PASS |\n| `test_due_clear` | PASS |\n| `test_mentions_extraction` | PASS |\n| `test_title_extraction` | PASS |\n\nAll 9 required tests present and passing. 4 additional bonus tests (`test_command_extraction`, `test_move_extracts_id_as_arg`, `test_empty_command_raises`, `test_section_case_insensitive`). 13 parser tests total.\n\n### Findings\n\n#### [Medium] F1: Leap-year bug in `_normalise_due` for MM-DD format (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 53-62 (after fix)\n- **Description**: The original implementation used `datetime.strptime(raw, \"%m-%d\")` which defaults to year 1900 (not a leap year). This caused `due:02-29` to always be rejected, even when the current year is a leap year (e.g., 2028). The `replace(year=current_year)` call was never reached because `strptime` itself raised `ValueError`.\n- **Fix applied**: Replaced `strptime(\"%m-%d\")` with a regex match `(\\d{1,2})-(\\d{1,2})` followed by direct `date(current_year, month, day)` construction. This correctly validates Feb 29 against the actual current year.\n- **Impact**: Without fix, `due:02-29` would fail in leap years (2028, 2032, etc.) when it should succeed.\n\n#### [Low] F2: Duplicate options silently use \"last wins\" semantics\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 91-117\n- **Description**: If a user provides `/p First /p Second`, the parser silently uses `Second`. Same for `/s` and `due:`. This is not necessarily wrong, but it is undocumented. \"Last wins\" is a reasonable default, but \"first wins\" or \"raise error on duplicate\" are also valid choices.\n- **Action**: Document the \"last wins\" behavior in the docstring or PRD. No code change needed.\n\n#### [Low] F3: `/p` and `/s` error paths (missing argument) are untested\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_parser.py`\n- **Description**: Lines 93 and 101 (`raise ParseError(\"/p requires a project name\")` and `/s` equivalent) are uncovered. Manual testing confirmed they work correctly, but automated test coverage is missing for these edge cases.\n- **Action**: Add tests for `parse(\"add task /p\")` and `parse(\"add task /s\")` in a follow-up.\n\n#### [Low] F4: `_DUE_RE` uses `.+` which accepts any characters after `due:`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, line 15\n- **Description**: `_DUE_RE = re.compile(r\"^due:(.+)$\")` will match `due:anything` and pass the value to `_normalise_due`. This is not a bug since `_normalise_due` properly validates the value, but a tighter regex like `r\"^due:([\\d-]+)$\"` would reject obviously invalid inputs earlier and serve as documentation of expected format.\n- **Action**: Optional tightening. Not blocking since validation is correct.\n\n#### [Low] F5: Title tokens are collected from all positions, not just \"before first option\"\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 126-128\n- **Description**: The AC says \"Title tokens are non-option, non-mention tokens before first option.\" The implementation collects title tokens from all positions (e.g., `add Buy /p Home milk` would produce `title_tokens=[\"Buy\", \"milk\"]`). This is actually more flexible and user-friendly, but deviates from the literal AC wording.\n- **Action**: Consider updating the AC to match the implementation. The current behavior is better for UX.\n\n#### [Info] F6: `args` extraction for `move/done/drop/edit` is well-designed\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 130-133\n- The pattern of extracting the first title token as `args[0]` for ID-based commands is clean and tested by `test_move_extracts_id_as_arg`.\n\n#### [Info] F7: Coverage at 97%\n\n- Lines 93 and 101 (error paths for missing `/p` and `/s` arguments) are uncovered. All other branches are tested. This is acceptable for M1.\n\n#### [Info] F8: Bonus tests add good defensive coverage\n\n- `test_section_case_insensitive` ensures `/s DOING` normalizes to `doing`.\n- `test_command_extraction` verifies the first token becomes the command.\n- `test_empty_command_raises` covers the empty input guard.\n- `test_move_extracts_id_as_arg` covers the args extraction logic.\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and well-structured:\n\n- The tokenizer loop with explicit index management (`while i < len(remaining)`) is readable and handles two-token options (`/p`, `/s`) cleanly by advancing `i` by 2.\n- `ParsedCommand` dataclass provides a clear, typed result structure.\n- `VALID_SECTIONS` as a `frozenset` is the right choice for O(1) membership testing.\n- `_MENTION_RE` uses `fullmatch` (not `match` or `search`), preventing partial matches on tokens like `<@U123>extra`.\n- Error messages are descriptive and include the invalid value with `repr()` formatting.\n- Logging at debug level for parsed results is appropriate.\n- 97% test coverage with all 9 required tests present and 4 bonus tests.\n\n**Verdict: APPROVE with one fix applied** -- the leap-year bug in `_normalise_due` (Medium, F1) has been fixed directly. Low findings are noted for follow-up.\n\n---\n\n## Security Findings\n\n### [Medium] S1: Leap-year date validation bypass (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, `_normalise_due`\n- **Description**: The original `strptime(\"%m-%d\")` approach silently rejected valid dates (`02-29` in leap years) due to the 1900 default year. While this is a correctness issue rather than a security vulnerability, incorrect date validation can lead to denial of service (users unable to set valid due dates) and data integrity issues (dates that should be accepted are rejected).\n- **Severity**: Medium (correctness bug with functional impact)\n- **Fix**: Replaced with regex-based month/day extraction and direct `date()` construction with the current year.\n\n### [Low] S2: No ReDoS risk in compiled regexes\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 14-15\n- **Description**: Both `_MENTION_RE = re.compile(r\"<@(U[A-Z0-9]+)>\")` and `_DUE_RE = re.compile(r\"^due:(.+)$\")` were tested with 100,000-character inputs and completed in under 0.1ms. Neither pattern contains nested quantifiers or alternation that could cause catastrophic backtracking.\n- **Severity**: Low (no risk found, noting for completeness)\n\n### [Low] S3: No input length validation on parser input\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, line 72\n- **Description**: `parse(text)` accepts arbitrarily long strings. `text.strip().split()` will allocate a token list proportional to input size. Slack limits messages to ~40,000 characters, mitigating this at the transport layer, but if the parser is used outside Slack, extremely long inputs could cause memory pressure.\n- **Severity**: Low (mitigated by Slack transport layer limits)\n- **Recommendation**: Consider adding a max-length guard in the plugin entry point (`handle_message`) rather than the parser itself.\n\n### [Info] S4: No injection risks\n\n- The parser only tokenizes and validates strings. No SQL, no shell commands, no template rendering. User input flows into `ParsedCommand` fields which are plain strings. Security depends on how these values are consumed downstream (e.g., parameterized queries when writing to SQLite).\n\n### [Info] S5: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `parser.py` or `test_parser.py`.\n\n### [Info] S6: No new dependencies introduced\n\n- The parser uses only Python standard library (`re`, `datetime`, `dataclasses`, `logging`). No new entries in `pyproject.toml`.\n\n### Security Summary\n\nNo Critical or High severity findings. One Medium finding (S1: leap-year date validation) was identified and fixed. The parser has a minimal attack surface -- it tokenizes strings and validates against known patterns. The main security consideration going forward is ensuring that `ParsedCommand` field values are used safely downstream (parameterized SQL queries, no raw echo in web contexts).\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Test coverage**: Add tests for `/p` and `/s` without arguments (lines 93, 101) to cover the missing-argument error paths.\n2. **Documentation**: Document \"last wins\" semantics for duplicate `/p`, `/s`, and `due:` options in the PRD or parser docstring.\n3. **Optional**: Tighten `_DUE_RE` from `.+` to `[\\d-]+` for earlier rejection of obviously invalid due values.\n4. **AC clarification**: Update Issue #5 AC to reflect that title tokens are collected from all positions (not just \"before first option\"), matching the implemented behavior.\n\n---\n\n# PR #12 Review Notes -- Issue #7: Project resolver helper\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/007-project-resolver`\n# PR #14 Review Notes -- Issue #16: Command dispatcher and routing\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature-016-dispatcher`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| Private project of sender matched first | PASS | Query on line 38-42 filters by `visibility = 'private' AND owner_user_id = ?`. Test `test_private_takes_priority` verifies. |\n| Falls back to shared if no private match | PASS | Second query on line 52-56 filters by `visibility = 'shared'`. Test `test_falls_back_to_shared` verifies. |\n| Returns error when neither exists (except Inbox auto-created) | PASS | `ProjectNotFoundError` raised on line 84. Inbox auto-created on lines 66-81. Tests `test_unknown_project_error` and `test_inbox_auto_created` verify. |\n| Returns project row with id, name, visibility, owner_user_id | PASS | `Project` dataclass on lines 17-23 with all four fields. All tests assert on these fields. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_private_takes_priority` | PASS -- creates both shared and private \"Work\", verifies private is returned for owner U1 |\n| `test_falls_back_to_shared` | PASS -- creates shared \"Team\" only, verifies shared returned for U1 |\n| `test_inbox_auto_created` | PASS -- deletes seeded Inbox, verifies auto-creation as shared with null owner |\n| `test_unknown_project_error` | PASS -- verifies `ProjectNotFoundError` raised with descriptive message |\n\nAll 4 required tests present and passing. 2 additional bonus tests (`test_inbox_already_exists`, `test_private_different_owner_not_matched`). 6 tests total.\n\n### Findings\n\n#### [Low] F1: Project name matching is case-sensitive\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 39-42\n- **Description**: The SQL queries use `WHERE name = ?` which is case-sensitive in SQLite by default (for ASCII). If a user types `/p work` but the project is named `Work`, it will not match. The PRD does not specify case-sensitivity behavior, so this is not a bug per se, but it could cause user confusion.\n- **Action**: Document the case-sensitive behavior. Consider adding `COLLATE NOCASE` in a future iteration if case-insensitive matching is desired.\n\n#### [Low] F2: Repeated `Project(id=row[0], ...)` construction pattern\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 44, 58, 76\n- **Description**: The same `Project(id=row[0], name=row[1], visibility=row[2], owner_user_id=row[3])` pattern appears three times. This could be extracted to a helper (e.g., `Project._from_row(row)` classmethod or a module-level `_row_to_project` function) to reduce duplication and ensure consistency if columns change.\n- **Action**: Optional refactor. Not blocking for M1.\n\n#### [Low] F3: `conn.commit()` called inside resolver for Inbox auto-creation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, line 71\n- **Description**: The resolver calls `conn.commit()` directly after the `INSERT OR IGNORE` for Inbox auto-creation. This commits any pending transaction state on the connection, which could be surprising if the caller has uncommitted changes. In the current codebase this is not an issue (resolver is called early in command handling), but it couples the resolver to transaction management.\n- **Action**: Consider whether the caller should be responsible for committing. For M1 this is acceptable since the auto-creation is a one-time idempotent operation.\n\n#### [Low] F4: No test for Inbox auto-creation when a private Inbox exists\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/tests/test_project_resolver.py`\n- **Description**: If a user has a private project named \"Inbox\", `resolve_project(conn, \"Inbox\", user_id)` will return the private project (step 1 matches). The auto-creation path (step 3) is only reached if neither private nor shared \"Inbox\" exists. This behavior is correct per the resolution order, but there is no test covering the scenario where a user has a private \"Inbox\" and the shared \"Inbox\" also exists -- the test should verify that the private one is returned.\n- **Action**: Add a test for this edge case in a follow-up.\n\n#### [Info] F5: `INSERT OR IGNORE` is the correct pattern for Inbox auto-creation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 67-70\n- `INSERT OR IGNORE` handles the race condition where two concurrent requests try to auto-create Inbox simultaneously. The `ux_projects_shared_name` unique index on `(name) WHERE visibility = 'shared'` ensures only one shared Inbox can exist. The subsequent `SELECT` on lines 72-75 guarantees we return the correct row regardless of whether this request or another one performed the insert. This is well-designed.\n\n#### [Info] F6: Bonus tests add good defensive coverage\n\n- `test_inbox_already_exists` verifies that the seeded Inbox (from V1 migration) resolves without triggering auto-creation.\n- `test_private_different_owner_not_matched` verifies that a private project owned by U2 is not visible to U1, correctly raising `ProjectNotFoundError`.\n\n#### [Info] F7: Coverage at 100%\n\n- All 31 statements in `project_resolver.py` are covered by the 6 tests. No untested branches.\n\n#### [Info] F8: Test fixture pattern is consistent with prior PRs\n\n- The `_load_v1` autouse fixture and `conn` fixture follow the same save-clear-restore pattern established in prior PRs. Good consistency.\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and follows the PRD resolution order exactly:\n\n- Three-step resolution (private -> shared -> Inbox auto-create) with clear fallthrough logic.\n- All SQL queries use parameterized placeholders (`?`), preventing SQL injection.\n- `Project` dataclass provides a typed result with the four required fields.\n- `ProjectNotFoundError` is a well-named custom exception with descriptive message.\n- Logging at debug level for each resolution path aids troubleshooting.\n- `INSERT OR IGNORE` handles concurrent Inbox auto-creation safely.\n- 100% test coverage with all 4 required tests and 2 valuable bonus tests.\n- The code is 85 lines total -- minimal and readable.\n\n**Verdict: APPROVE** -- no Critical or High findings. All Low findings are noted for follow-up.\n### Changed Files\n\n| File | Change | Lines |\n|------|--------|-------|\n| `src/openclaw_todo/dispatcher.py` | NEW | 116 |\n| `src/openclaw_todo/plugin.py` | MODIFIED | 33 |\n| `tests/test_dispatcher.py` | NEW | 152 |\n| `tests/test_plugin.py` | MODIFIED | 39 |\n\n### Architecture Overview\n\nThe dispatcher implements a two-level routing architecture:\n\n1. **Plugin layer** (`plugin.py`): Strips `/todo` prefix, returns USAGE for bare `/todo`, delegates remainder to `dispatch()`.\n2. **Dispatcher layer** (`dispatcher.py`): Parses the remainder via the parser, validates command name against `_VALID_COMMANDS`, opens a DB connection with migration, routes to the appropriate handler (or stub), and closes the connection in a `finally` block.\n3. **Project sub-routing**: `project` command delegates to `_dispatch_project()` which extracts the subcommand from `parsed.title_tokens` and routes to `project_<subcommand>` handlers in the registry.\n\n### Findings\n\n#### [Low] F1: Weak test assertion on stub handler (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/tests/test_dispatcher.py`, line 48\n- **Description**: The original assertion was:\n  ```python\n  assert \"not yet implemented\" in result.lower() or isinstance(result, str)\n  ```\n  The `isinstance(result, str)` clause makes this trivially true since `dispatch()` always returns `str`. The test does not actually verify that the stub handler was invoked -- any string return would pass.\n- **Fix applied**: Removed the `or isinstance(result, str)` fallback. The assertion now strictly verifies that the stub handler message is present:\n  ```python\n  assert \"not yet implemented\" in result.lower()\n  ```\n- **Impact**: Test now correctly fails if the stub handler message format changes or if a different code path is taken.\n\n#### [Low] F2: `_stub_handler` signature differs from `HandlerFn` type alias\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 17, 47\n- **Description**: The `HandlerFn` type alias is `Callable[[ParsedCommand, Connection, dict], str]` (3 args), but `_stub_handler` takes 4 args: `(command, parsed, conn, context)`. This works because `_stub_handler` is never registered directly in `_handlers` -- it is always called via a lambda wrapper in `_get_handler` (line 59) and `_dispatch_project` (line 115) that captures `command` via closure. However, the mismatch makes the code harder to follow at a glance.\n- **Action**: Consider refactoring `_stub_handler` to accept `(parsed, conn, context)` and derive the command name from `parsed.command`. Not blocking since the current approach is correct.\n\n#### [Low] F3: Long line in `_dispatch_project`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 115\n- **Description**: Line 115 is 116 characters, exceeding typical line length limits (88 for black, 100 for many projects). The lambda + `_handlers.get` + `_stub_handler` call is dense.\n- **Action**: Consider breaking into multiple lines for readability. Not blocking.\n\n#### [Low] F4: Global mutable `_handlers` dict shared across tests\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 54\n- **Description**: The `_handlers` dict is module-level mutable state. The test fixture `_clean_handlers` (test file line 22-28) correctly saves and restores it between tests. However, if the test suite were run in parallel (e.g., `pytest-xdist`), the shared state could cause flaky tests.\n- **Action**: For a single-process Slack plugin this is fine. Document the limitation if parallel test execution is ever introduced.\n\n#### [Info] F5: DB connection lifecycle is correct\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 86-94\n- The `dispatch()` function opens the DB connection *after* validating the command name (line 80-82 returns early for unknown commands without touching the DB). The connection is always closed in a `finally` block (line 94), ensuring no leaks even if handlers raise exceptions. This is good resource management.\n\n#### [Info] F6: Unknown commands do not open a DB connection\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 80-82\n- The `if command not in _VALID_COMMANDS` check returns before `_init_db()` is called. This avoids unnecessary DB initialization for typos and invalid commands. Good design.\n\n#### [Info] F7: Parse errors are caught and returned as user-facing messages\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 73-76\n- `ParseError` is caught and formatted as `f\"Parse error: {exc}\"`. The parser's error messages are descriptive (e.g., \"Invalid section: 'xyz'\") and do not leak internal details. This is appropriate for a Slack DM context.\n\n#### [Info] F8: Plugin entry-point correctly wired to dispatcher\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/plugin.py`\n- The `handle_message()` function now delegates to `dispatch()` instead of the previous placeholder response. The prefix matching logic is unchanged and still correct. The `db_path` parameter flows through to `dispatch()` for testability.\n\n#### [Info] F9: Schema import triggers migration registration\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 14\n- `import openclaw_todo.schema_v1 as _schema_v1` with `# noqa: F401` ensures the `@register` decorator in `schema_v1.py` runs at import time, populating the migration registry before any `migrate()` call. This is the correct pattern for the decorator-based migration system.\n\n#### [Info] F10: Test coverage is comprehensive\n\n- 20 dispatcher + plugin tests covering:\n  - All 7 non-project commands routed to stubs (parametrized)\n  - Custom handler registration and invocation\n  - All 3 project subcommands routed correctly\n  - Project with no subcommand returns usage\n  - Unknown project subcommand returns error\n  - Unknown top-level command returns error with usage\n  - Parse error propagation\n  - DB initialization with schema migration\n  - Plugin prefix matching (non-todo, todo, whitespace, bare /todo)\n\n### Code Quality Summary\n\nThe dispatcher implementation is clean, well-structured, and follows good design principles:\n\n- **Separation of concerns**: Plugin handles prefix matching; dispatcher handles parsing, validation, DB init, and routing. Each has a single responsibility.\n- **Resource safety**: DB connection opened late (only for valid commands) and closed in `finally`.\n- **Extensibility**: The `register_handler()` function provides a clean API for future command implementations to plug in without modifying the dispatcher.\n- **Defensive routing**: Unknown commands and parse errors return helpful user-facing messages without touching the DB or raising unhandled exceptions.\n- **Project sub-routing**: The `project_<subcommand>` naming convention with `replace('-', '_')` is a clean pattern for hyphenated subcommands.\n- **Test isolation**: The `_clean_handlers` autouse fixture properly saves and restores the handler registry between tests.\n\n**Verdict: APPROVE with one fix applied** -- the weak test assertion (Low, F1) has been strengthened. No Critical or High code quality issues found.\n\n---\n\n## Security Findings\n\n### [Low] S1: No SQL injection risk -- parameterized queries used throughout\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 38-42, 52-56\n- **Description**: All SQL queries use `?` parameter placeholders for user-supplied values (`name` and `sender_id`). The Inbox auto-creation on lines 67-75 uses hardcoded string literals only. No string interpolation or f-strings are used in any SQL statement.\n- **Severity**: Low (no risk found, noting for completeness)\n\n### [Low] S2: `name` parameter is not length-validated\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, line 27\n- **Description**: `resolve_project(conn, name, sender_id)` accepts arbitrarily long `name` strings. While SQLite handles this safely (TEXT has no inherent length limit), an extremely long name would result in unnecessary query execution against the database. The parser upstream (Issue #5) extracts project names from `/p <name>` tokens, and Slack limits message length to ~40,000 characters, providing transport-layer mitigation.\n- **Severity**: Low (mitigated by upstream constraints)\n- **Recommendation**: Consider adding a max-length check for project names in the parser or a future validation layer.\n\n### [Low] S3: Inbox auto-creation commits transaction implicitly\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, line 71\n- **Description**: `conn.commit()` inside the resolver commits all pending changes on the connection, not just the Inbox insert. If a future caller has uncommitted writes before calling `resolve_project`, those writes would be committed as a side effect. This is not exploitable but could lead to partial commits in error scenarios.\n- **Severity**: Low (no current exploit path; architectural concern)\n- **Recommendation**: Consider using a savepoint pattern (`SAVEPOINT` / `RELEASE`) for the Inbox auto-creation to isolate its transaction from any outer transaction.\n\n### [Info] S4: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `project_resolver.py` or `test_project_resolver.py`.\n\n### [Info] S5: No new dependencies introduced\n\n- The module uses only Python standard library (`sqlite3`, `dataclasses`, `logging`). No new entries in `pyproject.toml`.\n\n### [Info] S6: Authorization model is correctly scoped\n\n- The `sender_id` parameter is used correctly in the private-project query to scope visibility. User U1 cannot resolve another user's private projects. Test `test_private_different_owner_not_matched` explicitly verifies this isolation. The shared-project query correctly omits owner filtering, as shared projects are visible to all users.\n\n### Security Summary\n\nNo Critical, High, or Medium severity findings. The implementation has a minimal attack surface -- three read queries and one idempotent insert, all using parameterized queries. The authorization model (private scoped to sender, shared visible to all) is correctly implemented and tested. Three Low findings are noted for awareness but require no immediate action.\n### [Low] S1: User input reflected in error messages\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 76, 82, 110\n- **Description**: Three error paths echo user-supplied values back in responses:\n  - `f\"Parse error: {exc}\"` (line 76) -- parser error messages may contain raw user input\n  - `f\"Unknown command: '{command}'\\n{USAGE}\"` (line 82) -- the command name is user input\n  - `f\"Unknown project subcommand: '{sub}'\\n{PROJECT_USAGE}\"` (line 110) -- the subcommand is user input\n- **Severity**: Low. In the Slack DM context, Slack handles message escaping. The reflected values are single tokens (no spaces, limited characters after `split()` tokenization). No HTML/JS injection is possible in this context.\n- **Recommendation**: If the plugin ever serves responses in a web context (e.g., dashboard, webhook response viewer), sanitize reflected values. No fix needed for current Slack-only usage.\n\n### [Low] S2: No input length validation at dispatcher level\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 67\n- **Description**: `dispatch(text, ...)` accepts arbitrarily long strings, which flow to `parse()` for tokenization. Slack limits messages to approximately 40,000 characters, providing transport-layer mitigation.\n- **Severity**: Low (mitigated by Slack transport layer)\n- **Recommendation**: Consider adding a max-length guard in `handle_message()` if the plugin is ever exposed outside Slack.\n\n### [Low] S3: Handler exception propagation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 91-92\n- **Description**: If a registered handler raises an unhandled exception, it propagates up through `dispatch()`. The `finally` block ensures the DB connection is closed, but the exception itself is not caught. In the current architecture, the caller (`handle_message` in `plugin.py`) does not catch exceptions either, so an unhandled handler error would propagate to the gateway framework.\n- **Severity**: Low. The stub handlers cannot raise exceptions (they return strings). Future handler implementations should handle their own errors. A catch-all `except Exception` in `dispatch()` could provide defense-in-depth but would also mask bugs during development.\n- **Recommendation**: Consider adding a top-level exception handler in `dispatch()` that logs the error and returns a generic \"Internal error\" message, once real handlers are implemented. During development, letting exceptions propagate is acceptable.\n\n### [Info] S4: No SQL injection risk\n\n- The dispatcher does not execute any SQL directly. DB interaction is limited to `_init_db()` which calls `get_connection()` and `migrate()` -- both use hardcoded SQL or parameterized queries. User input flows through `ParsedCommand` fields to handlers, which are responsible for using parameterized queries.\n\n### [Info] S5: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `dispatcher.py`, `plugin.py`, or their test files.\n\n### [Info] S6: `db_path` parameter is configuration-controlled\n\n- The `db_path` parameter in `dispatch()` and `handle_message()` flows from the caller (gateway framework), not from user input. In tests, it comes from `tmp_path`. There is no code path where a user's message text influences the DB path.\n\n### [Info] S7: No new dependencies introduced\n\n- The dispatcher uses only Python standard library (`sqlite3`, `logging`, `typing`) plus internal modules (`db`, `migrations`, `parser`, `schema_v1`). No new entries in `pyproject.toml`.\n\n### Security Summary\n\nNo Critical or High severity findings. Three Low findings related to input reflection, length validation, and exception propagation are noted. The dispatcher has a minimal attack surface -- it validates commands against a whitelist, delegates parsing to the parser, and routes to registered handlers. The main security consideration for future work is ensuring that handler implementations use parameterized queries and handle their own exceptions gracefully.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Refactor**: Extract `Project(id=row[0], ...)` into a `_row_to_project(row)` helper or `Project.from_row(row)` classmethod to reduce the triple duplication.\n2. **Test coverage**: Add a test for the edge case where a user has a private \"Inbox\" project and the shared \"Inbox\" also exists, verifying the private one is returned.\n3. **Transaction safety**: Consider using `SAVEPOINT` / `RELEASE` for Inbox auto-creation instead of bare `conn.commit()` to avoid committing unrelated pending changes.\n4. **Case sensitivity**: Document that project name matching is case-sensitive. Consider `COLLATE NOCASE` if case-insensitive matching is desired in a future iteration.\n5. **Input validation**: Add a max-length check for project names in the parser or validation layer to prevent unnecessarily large queries.\n1. **Exception handling**: Add a top-level `try/except` in `dispatch()` that catches unexpected handler exceptions, logs them at error level, and returns a generic user-facing error message. Defer until real handlers are implemented.\n2. **Refactor `_stub_handler`**: Align `_stub_handler` signature with `HandlerFn` type alias by deriving the command name from `parsed.command` instead of passing it as a separate argument. This also eliminates the lambda wrappers in `_get_handler` and `_dispatch_project`.\n3. **Line length**: Break the long line 115 in `_dispatch_project` for readability.\n4. **Context typing**: Introduce a `TypedDict` or dataclass for the `context` parameter (e.g., `class DispatchContext(TypedDict): sender_id: str`) to enable static type checking.\n5. **Input length guard**: Add a max-length check (e.g., 5000 chars) in `handle_message()` as defense-in-depth against oversized inputs.\n\n---\n\n<<<<<<< HEAD\n# PR #18 Review Notes -- Issue #6: /todo add command\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/006-cmd-add`\n=======\n# PR #16 Review Notes -- Issue #17: Permission helper module\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature-017-permissions`\n>>>>>>> origin/main\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n<<<<<<< HEAD\n| Task inserted with correct project_id, section, due, status='open', created_by | PASS | `test_add_default_inbox` and `test_add_with_project_section_due` verify all fields in DB |\n| Assignees default to sender when no mentions | PASS | `test_add_assignee_defaults_to_sender` verifies `task_assignees` row matches sender |\n| Multiple mentions create multiple task_assignee rows | PASS | `test_add_multiple_assignees` verifies two rows inserted and present in response |\n| Private project + non-owner assignee returns warning and does NOT insert | PASS | `test_add_private_rejects_other_assignee` verifies warning message and zero task rows |\n| Non-existent project: `Inbox` auto-created; others return error | PASS | `test_add_default_inbox` uses seeded Inbox; `test_add_nonexistent_project_returns_error` verifies error |\n| Response format: `Added #<id> (<project>/<section>) due:<due\\|-> assignees:<mentions> -- <title>` | PASS | All happy-path tests assert on this format |\n| Event row written to `events` table | PASS | `test_event_logged` verifies actor, action, task_id, and JSON payload fields |\n=======\n| `can_write_task(conn, task_id, sender_id) -> bool` exists | PASS | Function defined on line 11 of `permissions.py` with correct signature. |\n| Private project: only owner can write | PASS | Lines 34-40 check `sender_id == owner_user_id` when `visibility == \"private\"`. Tests `test_private_owner_can_write` and `test_private_non_owner_rejected` verify. |\n| Shared project: assignee or creator can write | PASS | Lines 43-60 check creator first, then query `task_assignees`. Tests `test_shared_assignee_can_write`, `test_shared_creator_can_write`, and `test_shared_unrelated_rejected` verify. |\n| Nonexistent task returns False | PASS | Lines 28-29 return `False` when row is None. Test `test_nonexistent_task` verifies. |\n| `validate_private_assignees(visibility, assignees, owner_id) -> str or None` exists | PASS | Function defined on line 63 with correct signature. |\n| Returns warning for non-owner assignees on private project | PASS | Lines 75-81. Test `test_validate_private_assignees_warning` verifies. |\n| Returns None for shared projects | PASS | Lines 72-73. Test `test_shared_always_ok` verifies. |\n| Returns None when all assignees are the owner | PASS | Lines 76-77. Test `test_private_all_owner_ok` verifies. |\n>>>>>>> origin/main\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n<<<<<<< HEAD\n| `test_add_default_inbox` | PASS |\n| `test_add_with_project_section_due` | PASS |\n| `test_add_private_rejects_other_assignee` | PASS |\n| `test_add_assignee_defaults_to_sender` | PASS |\n| `test_add_multiple_assignees` | PASS |\n\nAll 5 required tests present and passing. 5 additional tests (`test_add_private_allows_owner_assignee`, `test_event_logged`, `test_add_empty_title_returns_error`, `test_add_nonexistent_project_returns_error`, `test_add_due_clear_sentinel_stored_as_null`). 10 tests total.\n\n### Findings\n\n#### [Info] F1: No explicit transaction wrapping for multi-statement write\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-80\n- **Description**: The handler performs three sequential writes (task INSERT, assignee INSERTs, event INSERT) followed by a single `conn.commit()` at line 80. If any write after the task INSERT raises (e.g., duplicate assignee PK violation), partial writes remain uncommitted. SQLite's implicit rollback-on-close in the dispatcher's `finally` block protects data integrity.\n- **Action**: Consider wrapping in `with conn:` (context manager) for explicit transaction semantics in a future refactor. No functional bug today.\n\n#### [Info] F2: Missing `sender_id` key would raise unhandled KeyError\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 22\n- **Description**: `context[\"sender_id\"]` raises `KeyError` if the key is absent. The dispatcher contract requires `sender_id` in context, so this is defensive-coding territory.\n- **Action**: Acceptable. Could be improved with `.get()` + early return, but low priority given the documented contract.\n\n#### [Info] F3: Test gap -- non-owner sender adding to another user's private project\n\n- **File**: `tests/test_cmd_add.py`\n- **Description**: No test covers the case where sender U2 tries to add a task to a private project owned by U1. The `resolve_project()` function would return `ProjectNotFoundError` (it only matches private projects of the sender), which is correct behavior. However, there is no explicit test verifying this path through `add_handler`.\n- **Action**: Follow-up item. Add a test for \"non-owner sender cannot resolve another user's private project.\"\n\n#### [Info] F4: Title length is unbounded\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 23\n- **Description**: No max-length check on `title`. Slack messages cap at ~4000 chars, providing natural limits. The DB column is `TEXT NOT NULL` with no length constraint.\n- **Action**: Consider adding a max-length check if the handler is exposed outside Slack.\n\n#### [Info] F5: Dispatcher test correctly updated\n\n- **File**: `tests/test_dispatcher.py`, lines 34-51\n- **Description**: The parametrized stub test removed `\"add\"` from the stub-check list and added a dedicated `test_add_routes_to_handler` test that asserts `\"Added #\"` in the result. This correctly reflects that `add` is no longer a stub.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and correct:\n\n- Uses `resolve_project()` for project resolution following PRD Option A (private-first).\n- Private assignee validation correctly rejects non-owner assignees with a descriptive warning.\n- All SQL uses parameterized queries (`?` placeholders).\n- Event payload is well-structured JSON with title, project, section, due, and assignees.\n- Response format matches the PRD/UX spec exactly.\n- 10 tests with thorough assertions on both the response string and DB state.\n- No unnecessary complexity or over-engineering.\n\n**Verdict: APPROVE** -- no blocking issues. No fixes required.\n=======\n| `test_private_owner_can_write` | PASS |\n| `test_private_non_owner_rejected` | PASS |\n| `test_shared_assignee_can_write` | PASS |\n| `test_shared_creator_can_write` | PASS |\n| `test_shared_unrelated_rejected` | PASS |\n| `test_nonexistent_task` | PASS |\n| `test_validate_private_assignees_warning` | PASS |\n| `test_private_all_owner_ok` | PASS |\n| `test_shared_always_ok` | PASS |\n| `test_private_empty_assignees_ok` | PASS |\n\nAll 10 tests present and passing. 48 tests total in the suite.\n\n### Findings\n\n#### [Medium] F1: Shared project owner cannot modify tasks they did not create or get assigned to — CONFIRMED INTENTIONAL\n\n- **Description**: In a shared project, only the task creator and assignees are allowed to write. The project owner has no special privileges. User confirmed this is intentional: only task creator and assignees should have task write access.\n- **Status**: CLOSED as intentional design.\n\n#### [Low] F2: `validate_private_assignees` with `owner_id=None` marks all assignees as non-owner\n\n- **Description**: When `owner_id` is `None` on a private project (data integrity issue), all assignees would be flagged as non-owner. Function short-circuits for shared projects, so this only affects corrupted data.\n- **Status**: OPEN, non-blocking.\n\n#### [Low] F3: No test for shared project where sender is both creator and assignee — FIXED\n\n- **Description**: Added `test_shared_creator_and_assignee_can_write` in commit 594cad4. Creator short-circuit handles this correctly.\n- **Status**: FIXED.\n\n#### [Low] F4: `_create_project` helper uses complex SELECT instead of `last_insert_rowid()`\n\n- **Status**: OPEN, non-blocking.\n\n### Code Quality Summary\n\n**Verdict: APPROVE** -- no Critical or High findings. F1 confirmed intentional, F3 fixed.\n>>>>>>> origin/main\n\n---\n\n## Security Findings\n\n<<<<<<< HEAD\n### [Info] S1: SQL injection -- No risk\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-78\n- **Description**: All three SQL statements (task INSERT, assignee INSERT, event INSERT) use `?` parameter placeholders. No string interpolation or f-strings in SQL. Title, project_id, section, due, sender_id, and assignee values are all passed as parameters.\n- **Severity**: Info (no risk found)\n\n### [Info] S2: Authorization model is sound\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 41-49\n- **Description**: Private project constraint correctly checks that all assignees match the project owner. The `resolve_project()` function provides implicit access control by only resolving the sender's own private projects (scoped by `owner_user_id = sender_id` in the SQL query). A non-owner sender cannot resolve another user's private project by name. The explicit assignee check in `cmd_add.py` is an additional layer for when the owner assigns tasks to others within their private project.\n- **Severity**: Info (no bypass possible)\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in any changed files.\n\n### [Info] S4: No new dependencies introduced\n\n- `cmd_add.py` uses only standard library (`json`, `logging`, `sqlite3`) plus internal modules (`parser`, `project_resolver`). No new entries in `pyproject.toml`.\n\n### [Info] S5: Input validation adequate\n\n- Empty title returns error (line 25-26).\n- Non-existent project returns error via `ProjectNotFoundError` (lines 30-33).\n- Section validation handled by parser upstream (`VALID_SECTIONS` check).\n- Due date validation handled by parser upstream (`_normalise_due`).\n- Mention format constrained by parser regex (`<@U[A-Z0-9]+>`).\n\n### Security Summary\n\nNo Critical, High, Medium, or Low severity findings. The implementation has a minimal attack surface -- three parameterized INSERT statements, project resolution with sender-scoped authorization, and input validation at both the parser and handler layers. The code is secure for the current Slack DM context.\n\n---\n\n## Follow-up Items\n\n1. **Test coverage**: Add a test for non-owner sender attempting to add a task to another user's private project (should get `ProjectNotFoundError` via resolver).\n2. **Transaction explicitness**: Consider wrapping the three DB writes in `with conn:` for explicit transaction semantics.\n3. **Title length**: Consider adding a max-length validation (e.g., 500 chars) as defense-in-depth.\n4. **Permissions module**: When Issue #17 (permissions helper) is merged, consider extracting the inline private-assignee validation to use the shared `validate_private_assignees()` function.\n=======\nNo Critical, High, or Medium severity security findings. All SQL parameterized. Fail-closed design. Three Low findings noted for awareness.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Defensive guard**: Consider adding a log warning in `validate_private_assignees` when `visibility == \"private\"` and `owner_id is None`.\n2. **Test consistency**: Align `_create_project` helper to use `last_insert_rowid()` like `_create_task`.\n\n---\n\n## Review Pass 2\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Commit range: ff87515..594cad4\n\n### Purpose\n\nSecond review pass to verify the F3 fix (commit 594cad4) and confirm no remaining Critical/High issues.\n\n### F3 Fix Verification: `test_shared_creator_and_assignee_can_write`\n\n- **Status**: VERIFIED CORRECT\n- The test creates a shared project, a task where `U_BOTH` is the creator, assigns `U_BOTH` as an assignee, and asserts `can_write_task` returns `True`.\n- This exercises the creator short-circuit path, which returns `True` before the assignee query is reached.\n\n### Prior Findings Status\n\n| Finding | Severity | Status |\n|---------|----------|--------|\n| F1: Shared project owner has no implicit write | Medium | CLOSED -- Confirmed intentional by user. |\n| F2: `validate_private_assignees` with `owner_id=None` | Low | OPEN -- non-blocking. |\n| F3: Missing creator+assignee overlap test | Low | FIXED in 594cad4. Verified correct. |\n| F4: `_create_project` helper uses complex SELECT | Low | OPEN -- non-blocking. |\n\n### Verdict\n\n**APPROVE -- ready to merge.** All 49 tests pass. No Critical or High issues.\n>>>>>>> origin/main\n", "structuredPatch": [{"oldStart": 947, "oldLines": 19, "newStart": 947, "newLines": 11, "lines": [" ", " ---", " ", "-<<<<<<< HEAD", "-# PR #18 Review Notes -- Issue #6: /todo add command", "-", "-> Reviewer: Claude Opus 4.6 (automated review)", "-> Date: 2026-02-20", "-> Branch: `feature/006-cmd-add`", "-=======", " # PR #16 Review Notes -- Issue #17: Permission helper module", " ", " > Reviewer: Claude Opus 4.6 (automated review)", " > Date: 2026-02-20", " > Branch: `feature-017-permissions`", "->>>>>>> origin/main", " ", " ---", " "]}], "userModified": false, "replaceAll": false}, "tool_use_id": "toolu_01J6W4c1jTSBp2KvRgt9ZA6f", "_ts": "2026-02-20T19:30:32+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "old_string": "<<<<<<< HEAD\n| Task inserted with correct project_id, section, due, status='open', created_by | PASS | `test_add_default_inbox` and `test_add_with_project_section_due` verify all fields in DB |\n| Assignees default to sender when no mentions | PASS | `test_add_assignee_defaults_to_sender` verifies `task_assignees` row matches sender |\n| Multiple mentions create multiple task_assignee rows | PASS | `test_add_multiple_assignees` verifies two rows inserted and present in response |\n| Private project + non-owner assignee returns warning and does NOT insert | PASS | `test_add_private_rejects_other_assignee` verifies warning message and zero task rows |\n| Non-existent project: `Inbox` auto-created; others return error | PASS | `test_add_default_inbox` uses seeded Inbox; `test_add_nonexistent_project_returns_error` verifies error |\n| Response format: `Added #<id> (<project>/<section>) due:<due\\|-> assignees:<mentions> -- <title>` | PASS | All happy-path tests assert on this format |\n| Event row written to `events` table | PASS | `test_event_logged` verifies actor, action, task_id, and JSON payload fields |\n=======\n| `can_write_task(conn, task_id, sender_id) -> bool` exists | PASS | Function defined on line 11 of `permissions.py` with correct signature. |\n| Private project: only owner can write | PASS | Lines 34-40 check `sender_id == owner_user_id` when `visibility == \"private\"`. Tests `test_private_owner_can_write` and `test_private_non_owner_rejected` verify. |\n| Shared project: assignee or creator can write | PASS | Lines 43-60 check creator first, then query `task_assignees`. Tests `test_shared_assignee_can_write`, `test_shared_creator_can_write`, and `test_shared_unrelated_rejected` verify. |\n| Nonexistent task returns False | PASS | Lines 28-29 return `False` when row is None. Test `test_nonexistent_task` verifies. |\n| `validate_private_assignees(visibility, assignees, owner_id) -> str or None` exists | PASS | Function defined on line 63 with correct signature. |\n| Returns warning for non-owner assignees on private project | PASS | Lines 75-81. Test `test_validate_private_assignees_warning` verifies. |\n| Returns None for shared projects | PASS | Lines 72-73. Test `test_shared_always_ok` verifies. |\n| Returns None when all assignees are the owner | PASS | Lines 76-77. Test `test_private_all_owner_ok` verifies. |\n>>>>>>> origin/main", "new_string": "| `can_write_task(conn, task_id, sender_id) -> bool` exists | PASS | Function defined on line 11 of `permissions.py` with correct signature. |\n| Private project: only owner can write | PASS | Lines 34-40 check `sender_id == owner_user_id` when `visibility == \"private\"`. Tests `test_private_owner_can_write` and `test_private_non_owner_rejected` verify. |\n| Shared project: assignee or creator can write | PASS | Lines 43-60 check creator first, then query `task_assignees`. Tests `test_shared_assignee_can_write`, `test_shared_creator_can_write`, and `test_shared_unrelated_rejected` verify. |\n| Nonexistent task returns False | PASS | Lines 28-29 return `False` when row is None. Test `test_nonexistent_task` verifies. |\n| `validate_private_assignees(visibility, assignees, owner_id) -> str or None` exists | PASS | Function defined on line 63 with correct signature. |\n| Returns warning for non-owner assignees on private project | PASS | Lines 75-81. Test `test_validate_private_assignees_warning` verifies. |\n| Returns None for shared projects | PASS | Lines 72-73. Test `test_shared_always_ok` verifies. |\n| Returns None when all assignees are the owner | PASS | Lines 76-77. Test `test_private_all_owner_ok` verifies. |", "replace_all": false}, "tool_use_id": "toolu_01YL97wFwRKyfLHu9CSyFyUo", "_ts": "2026-02-20T19:30:47+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "old_string": "<<<<<<< HEAD\n| Task inserted with correct project_id, section, due, status='open', created_by | PASS | `test_add_default_inbox` and `test_add_with_project_section_due` verify all fields in DB |\n| Assignees default to sender when no mentions | PASS | `test_add_assignee_defaults_to_sender` verifies `task_assignees` row matches sender |\n| Multiple mentions create multiple task_assignee rows | PASS | `test_add_multiple_assignees` verifies two rows inserted and present in response |\n| Private project + non-owner assignee returns warning and does NOT insert | PASS | `test_add_private_rejects_other_assignee` verifies warning message and zero task rows |\n| Non-existent project: `Inbox` auto-created; others return error | PASS | `test_add_default_inbox` uses seeded Inbox; `test_add_nonexistent_project_returns_error` verifies error |\n| Response format: `Added #<id> (<project>/<section>) due:<due\\|-> assignees:<mentions> -- <title>` | PASS | All happy-path tests assert on this format |\n| Event row written to `events` table | PASS | `test_event_logged` verifies actor, action, task_id, and JSON payload fields |\n=======\n| `can_write_task(conn, task_id, sender_id) -> bool` exists | PASS | Function defined on line 11 of `permissions.py` with correct signature. |\n| Private project: only owner can write | PASS | Lines 34-40 check `sender_id == owner_user_id` when `visibility == \"private\"`. Tests `test_private_owner_can_write` and `test_private_non_owner_rejected` verify. |\n| Shared project: assignee or creator can write | PASS | Lines 43-60 check creator first, then query `task_assignees`. Tests `test_shared_assignee_can_write`, `test_shared_creator_can_write`, and `test_shared_unrelated_rejected` verify. |\n| Nonexistent task returns False | PASS | Lines 28-29 return `False` when row is None. Test `test_nonexistent_task` verifies. |\n| `validate_private_assignees(visibility, assignees, owner_id) -> str or None` exists | PASS | Function defined on line 63 with correct signature. |\n| Returns warning for non-owner assignees on private project | PASS | Lines 75-81. Test `test_validate_private_assignees_warning` verifies. |\n| Returns None for shared projects | PASS | Lines 72-73. Test `test_shared_always_ok` verifies. |\n| Returns None when all assignees are the owner | PASS | Lines 76-77. Test `test_private_all_owner_ok` verifies. |\n>>>>>>> origin/main", "new_string": "| `can_write_task(conn, task_id, sender_id) -> bool` exists | PASS | Function defined on line 11 of `permissions.py` with correct signature. |\n| Private project: only owner can write | PASS | Lines 34-40 check `sender_id == owner_user_id` when `visibility == \"private\"`. Tests `test_private_owner_can_write` and `test_private_non_owner_rejected` verify. |\n| Shared project: assignee or creator can write | PASS | Lines 43-60 check creator first, then query `task_assignees`. Tests `test_shared_assignee_can_write`, `test_shared_creator_can_write`, and `test_shared_unrelated_rejected` verify. |\n| Nonexistent task returns False | PASS | Lines 28-29 return `False` when row is None. Test `test_nonexistent_task` verifies. |\n| `validate_private_assignees(visibility, assignees, owner_id) -> str or None` exists | PASS | Function defined on line 63 with correct signature. |\n| Returns warning for non-owner assignees on private project | PASS | Lines 75-81. Test `test_validate_private_assignees_warning` verifies. |\n| Returns None for shared projects | PASS | Lines 72-73. Test `test_shared_always_ok` verifies. |\n| Returns None when all assignees are the owner | PASS | Lines 76-77. Test `test_private_all_owner_ok` verifies. |", "replace_all": false}, "tool_response": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "oldString": "<<<<<<< HEAD\n| Task inserted with correct project_id, section, due, status='open', created_by | PASS | `test_add_default_inbox` and `test_add_with_project_section_due` verify all fields in DB |\n| Assignees default to sender when no mentions | PASS | `test_add_assignee_defaults_to_sender` verifies `task_assignees` row matches sender |\n| Multiple mentions create multiple task_assignee rows | PASS | `test_add_multiple_assignees` verifies two rows inserted and present in response |\n| Private project + non-owner assignee returns warning and does NOT insert | PASS | `test_add_private_rejects_other_assignee` verifies warning message and zero task rows |\n| Non-existent project: `Inbox` auto-created; others return error | PASS | `test_add_default_inbox` uses seeded Inbox; `test_add_nonexistent_project_returns_error` verifies error |\n| Response format: `Added #<id> (<project>/<section>) due:<due\\|-> assignees:<mentions> -- <title>` | PASS | All happy-path tests assert on this format |\n| Event row written to `events` table | PASS | `test_event_logged` verifies actor, action, task_id, and JSON payload fields |\n=======\n| `can_write_task(conn, task_id, sender_id) -> bool` exists | PASS | Function defined on line 11 of `permissions.py` with correct signature. |\n| Private project: only owner can write | PASS | Lines 34-40 check `sender_id == owner_user_id` when `visibility == \"private\"`. Tests `test_private_owner_can_write` and `test_private_non_owner_rejected` verify. |\n| Shared project: assignee or creator can write | PASS | Lines 43-60 check creator first, then query `task_assignees`. Tests `test_shared_assignee_can_write`, `test_shared_creator_can_write`, and `test_shared_unrelated_rejected` verify. |\n| Nonexistent task returns False | PASS | Lines 28-29 return `False` when row is None. Test `test_nonexistent_task` verifies. |\n| `validate_private_assignees(visibility, assignees, owner_id) -> str or None` exists | PASS | Function defined on line 63 with correct signature. |\n| Returns warning for non-owner assignees on private project | PASS | Lines 75-81. Test `test_validate_private_assignees_warning` verifies. |\n| Returns None for shared projects | PASS | Lines 72-73. Test `test_shared_always_ok` verifies. |\n| Returns None when all assignees are the owner | PASS | Lines 76-77. Test `test_private_all_owner_ok` verifies. |\n>>>>>>> origin/main", "newString": "| `can_write_task(conn, task_id, sender_id) -> bool` exists | PASS | Function defined on line 11 of `permissions.py` with correct signature. |\n| Private project: only owner can write | PASS | Lines 34-40 check `sender_id == owner_user_id` when `visibility == \"private\"`. Tests `test_private_owner_can_write` and `test_private_non_owner_rejected` verify. |\n| Shared project: assignee or creator can write | PASS | Lines 43-60 check creator first, then query `task_assignees`. Tests `test_shared_assignee_can_write`, `test_shared_creator_can_write`, and `test_shared_unrelated_rejected` verify. |\n| Nonexistent task returns False | PASS | Lines 28-29 return `False` when row is None. Test `test_nonexistent_task` verifies. |\n| `validate_private_assignees(visibility, assignees, owner_id) -> str or None` exists | PASS | Function defined on line 63 with correct signature. |\n| Returns warning for non-owner assignees on private project | PASS | Lines 75-81. Test `test_validate_private_assignees_warning` verifies. |\n| Returns None for shared projects | PASS | Lines 72-73. Test `test_shared_always_ok` verifies. |\n| Returns None when all assignees are the owner | PASS | Lines 76-77. Test `test_private_all_owner_ok` verifies. |", "originalFile": "# PR #2 Review Notes -- Issue #1: Plugin skeleton and entry point\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/001-plugin-skeleton`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `pyproject.toml` with Python >=3.11, pytest, pytest-cov dev deps | PASS | Correct. Uses `dependency-groups` (PEP 735) with hatchling backend. |\n| `src/openclaw_todo/__init__.py` exposes `__version__` | PASS | `__version__ = \"0.1.0\"` |\n| `handle_message(text: str, context: dict) -> str` entry point | PASS (minor note) | Return type is `str | None`, not `str`. The AC literally says `-> str` but `None` for ignored messages is the intended behavior per the next AC. Acceptable. |\n| Non-`/todo` messages silently ignored (returns `None`) | PASS | |\n| `uv sync && uv run pytest -q` passes | PASS | 4 tests, 100% coverage |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_ignores_non_todo_message` | PASS -- covers empty string, random text, `/todox` prefix-collision |\n| `test_dispatches_todo_prefix` | PASS -- verifies non-None response with subcommand text |\n\n### Findings\n\n#### [Info] Return type annotation mismatch with AC\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 12\n- The AC states `-> str` but the implementation is `-> str | None`. This is correct behavior (returning `None` for non-todo messages is explicitly required). The AC text is slightly imprecise; the code is right.\n- **Action**: None needed. Consider updating the AC wording if desired.\n\n#### [Info] `context` parameter unused\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 12\n- `context: dict` is accepted but never read in this skeleton. This is expected for M0 -- it will be used once the dispatcher (Issue #16) and DB commands are wired in.\n- **Action**: None. This is intentional scaffolding.\n\n#### [Info] Placeholder response includes raw user input\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 32\n- `f\"TODO command received: {remainder}\"` echoes back unescaped user input. This is a temporary placeholder (comment says \"will be replaced by dispatcher in Issue #16\"). In the current context (no HTML/web rendering, Slack DM only), this is not exploitable, but see Security Findings below.\n- **Action**: Track as part of Issue #16.\n\n#### [Info] Extra tests beyond AC requirements -- good\n\n- `test_todo_prefix_with_whitespace` and `test_todo_without_subcommand` are bonus tests covering whitespace handling and bare `/todo` usage message. Good coverage instinct.\n\n#### [Info] Version duplication\n\n- Version `0.1.0` appears in both `pyproject.toml` and `__init__.py`. Consider using `importlib.metadata` or dynamic versioning in a future issue to keep a single source of truth. Not a concern for M0.\n\n#### [Low] No type hints for `context` dict\n\n- `context: dict` is untyped (could be `dict[str, Any]` or a TypedDict). For M0 this is fine, but a `TypedDict` or dataclass should be introduced when the context shape solidifies.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and well-structured for a skeleton:\n\n- Prefix matching logic (`stripped == _TODO_PREFIX or stripped.startswith(_TODO_PREFIX + \" \")`) correctly avoids false positives on `/todox`.\n- Logging at appropriate levels (debug for all messages, info for matches).\n- Usage help returned for bare `/todo` is a nice touch.\n- Test coverage is 100%.\n\n**Verdict: APPROVE** -- no blocking issues.\n\n---\n\n## Security Findings\n\n### [Low] S1: User input echoed in placeholder response\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 32\n- **Description**: The placeholder `f\"TODO command received: {remainder}\"` reflects user-supplied text without sanitization. In the current Slack DM context, Slack handles rendering and this is not exploitable for XSS. However, once a web dashboard or logging UI is introduced, unsanitized echo could become a reflected XSS vector.\n- **Severity**: Low (Slack auto-escapes; placeholder will be replaced in Issue #16)\n- **Recommendation**: When building the real dispatcher, ensure any user text echoed in responses is sanitized if it ever reaches a web context. No fix needed now.\n\n### [Low] S2: No input length validation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 12\n- **Description**: `handle_message` accepts arbitrarily long strings. A malicious or buggy client could send extremely large messages. Slack itself limits messages to ~40,000 characters, so this is mitigated at the transport layer.\n- **Severity**: Low\n- **Recommendation**: Consider adding a max-length guard in the dispatcher (Issue #16) if the plugin is ever exposed outside Slack.\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in any reviewed files. Environment variable approach is correctly deferred to future DB/config work.\n\n### [Info] S4: Dependencies are minimal and current\n\n- Only dev dependencies: `pytest>=7.0` and `pytest-cov>=4.0`. No known CVEs for these versions. No runtime dependencies beyond the standard library.\n- Build backend `hatchling` is a well-maintained, standard tool.\n\n### [Info] S5: No SQL, no deserialization, no file I/O\n\n- The M0 skeleton has no database, no file operations, and no deserialization. The attack surface is effectively zero at this stage.\n\n### Security Summary\n\nNo Critical or High severity findings. The codebase has a minimal attack surface appropriate for a plugin skeleton. Security considerations will become relevant starting with Issue #2 (DB connection) and Issue #5 (parser with user-controlled input).\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Issue #16 (Dispatcher)**: When replacing the placeholder response, ensure user input is not echoed raw if the output context changes (e.g., web UI).\n2. **Future**: Introduce a `TypedDict` or dataclass for the `context` parameter to enforce shape and enable static analysis.\n3. **Future**: Consolidate version to a single source (e.g., `importlib.metadata.version(\"openclaw-todo-plugin\")`).\n\n---\n\n# PR #4 Review Notes -- Issue #2: DB module -- connection helper and pragma setup\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/002-db-connection`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| Directory is created recursively when absent | PASS | `db_dir.mkdir(parents=True, exist_ok=True)` on line 32. Test `test_creates_directory_and_file` verifies nested `nested/dir/` creation. |\n| SQLite connection returned with WAL mode enabled | PASS | `PRAGMA journal_mode=WAL` on line 36. Test verifies `fetchone()[0] == \"wal\"`. |\n| `busy_timeout` is 3000 | PASS | `PRAGMA busy_timeout=3000` on line 37. Test verifies `fetchone()[0] == 3000`. |\n| Calling `get_connection` twice returns usable connections (no lock conflict) | PASS | `test_two_connections_no_conflict` creates a table via conn1, reads via conn2. WAL mode enables this concurrency. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `tests/test_db.py::test_creates_directory_and_file` | PASS -- verifies both `db_path.exists()` and `db_path.parent.exists()` with nested `tmp_path` |\n| `tests/test_db.py::test_wal_mode_enabled` | PASS -- queries `PRAGMA journal_mode` and asserts `\"wal\"` |\n| `tests/test_db.py::test_busy_timeout` | PASS -- queries `PRAGMA busy_timeout` and asserts `3000` |\n\n### Findings\n\n#### [Info] TOCTOU in `is_new` logging check\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 29\n- `is_new = not db_path.exists()` is checked before `sqlite3.connect()`, which itself creates the file. In a concurrent scenario, the file could appear between the check and the connect. This only affects which log message is emitted (info vs. debug) and has no functional impact.\n- **Action**: None required. Purely cosmetic race condition.\n\n#### [Info] PRAGMA return values not checked\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, lines 36-37\n- `conn.execute(\"PRAGMA journal_mode=WAL;\")` returns a result set with the actual journal mode applied. On some edge cases (e.g., read-only filesystem, in-memory DB), WAL activation can silently fall back to another mode. The code does not verify the return.\n- **Action**: Low priority. Consider adding a debug-level assertion or log warning in a future hardening pass. The test suite already validates WAL is active in the happy path.\n\n#### [Info] Default path uses `Path.home()`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 11\n- `DEFAULT_DB_DIR = Path.home() / \".openclaw\" / \"workspace\" / \".todo\"` is evaluated at module import time. If `HOME` is unset (e.g., certain containerized environments), `Path.home()` raises `RuntimeError`. This is acceptable since: (a) the default is only used when `db_path is None`, and (b) the plugin is designed for environments where `HOME` is set. Callers in containers should pass an explicit path.\n- **Action**: None for M1. Document the `db_path` parameter as the recommended override for non-standard environments.\n\n#### [Info] Extra test beyond AC requirements -- good\n\n- `test_two_connections_no_conflict` is a bonus test that exercises concurrent WAL access. This directly validates the 4th acceptance criterion and is well-structured with proper cleanup in a `finally` block.\n\n#### [Low] Test cleanup uses `try/finally` instead of a fixture\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_db.py`, all tests\n- Each test manually opens a connection and closes it in `try/finally`. A pytest fixture (e.g., `@pytest.fixture` yielding the connection) would reduce boilerplate and guarantee cleanup even if assertion lines are added later. This is a minor style observation for 4 tests.\n- **Action**: Optional refactor. Not blocking.\n\n#### [Info] Coverage at 96%\n\n- Line 24 (`db_path = DEFAULT_DB_DIR / DEFAULT_DB_NAME`) is uncovered because all tests pass explicit `tmp_path` paths. This is correct -- testing the default path would write to the user's actual home directory. The uncovered line is trivial assignment logic.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and correct:\n\n- Function signature `get_connection(db_path: str | Path | None = None)` is flexible, accepting string, Path, or None.\n- `Path(db_path)` normalization on line 26 handles string inputs.\n- `exist_ok=True` on `mkdir` prevents race conditions with concurrent directory creation.\n- Logging at appropriate levels: `info` for creation, `debug` for opens.\n- No unnecessary dependencies -- uses only stdlib `sqlite3`, `pathlib`, and `logging`.\n- 96% test coverage with all acceptance criteria verified.\n\n**Verdict: APPROVE** -- no blocking issues.\n\n---\n\n## Security Findings\n\n### [Low] S1: `db_path` parameter accepts arbitrary filesystem paths\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 15\n- **Description**: `get_connection(db_path)` will create directories and an SQLite database at any filesystem path the process has write access to. If a future caller passes unsanitized user input as `db_path`, this could be used for arbitrary file creation (e.g., path traversal via `../../etc/cron.d/evil`).\n- **Severity**: Low (currently an internal API; no user-facing code path passes user input to `db_path`)\n- **Recommendation**: When wiring `db_path` into the dispatcher (Issue #16), ensure the path comes only from configuration (env var or config file), never from user-controlled message text. Consider adding a validation that `db_path` is within an expected base directory.\n\n### [Info] S2: No SQL injection risk\n\n- PRAGMA statements on lines 36-37 use hardcoded string literals with no interpolation. The `db_path` is passed to `sqlite3.connect()` as a filesystem path, not as a SQL query. No injection surface exists.\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `db.py` or `test_db.py`. The module uses only stdlib.\n\n### [Info] S4: No new dependencies introduced\n\n- This module uses only Python standard library (`sqlite3`, `pathlib`, `logging`). No new entries in `pyproject.toml` dependencies. Zero additional attack surface from third-party code.\n\n### [Info] S5: SQLite WAL mode is a security-positive choice\n\n- WAL mode improves concurrent access safety and reduces the risk of database corruption from concurrent writes. The `busy_timeout=3000` prevents immediate lock failures, which could otherwise cause data loss if a caller does not handle `sqlite3.OperationalError` properly.\n\n### Security Summary\n\nNo Critical or High severity findings. The attack surface is minimal -- a single function that creates a local SQLite database with hardcoded pragmas. The only surface to monitor is ensuring `db_path` remains configuration-controlled as the codebase grows.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Issue #3 (Migration framework)**: When implementing migrations, ensure SQL statements use parameterized queries (not string formatting) for any dynamic values. The migration runner should validate migration callables are from a trusted registry.\n2. **Future**: Add a pytest fixture for `get_connection` that yields and auto-closes, reducing `try/finally` boilerplate across DB-related test files.\n3. **Future**: Consider adding a `validate_db_path(path)` helper that constrains paths to an allowed base directory, for defense-in-depth when the dispatcher wires in configuration.\n\n---\n\n# PR #6 Review Notes -- Issue #3: Schema migration framework and schema_version table\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/003-schema-migration`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `schema_version` table created with single row `version=0` if absent | PASS | `_ensure_version_table` uses `CREATE TABLE IF NOT EXISTS` and inserts `version=0` only when no row exists (line 30-31). |\n| Migrations are Python callables registered in an ordered list | PASS | `_migrations: list[MigrationFn]` with `@register` decorator appending to the list. Index maps directly to migration version. |\n| Each migration runs inside a transaction; version incremented on success | PASS | `conn.commit()` after each successful migration (line 65). SQLite's implicit transaction wraps the migration + version update. |\n| Re-running on an up-to-date DB is a no-op | PASS | `current >= target` guard on line 52 returns immediately. Test `test_idempotent_on_rerun` verifies. |\n| Failing migration rolls back and raises with clear message | PASS | `conn.rollback()` in `except` block (line 67). `RuntimeError` with formatted message including version number and original exception (line 68-70). |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_fresh_db_gets_version_table` | PASS -- verifies `get_version` returns 0 and `schema_version` table exists in `sqlite_master` |\n| `test_applies_migrations_sequentially` | PASS -- registers two migrations, asserts final version is 2, verifies both tables created |\n| `test_idempotent_on_rerun` | PASS -- calls `migrate` twice, both return 1, no errors |\n| `test_rollback_on_failure` | PASS -- first migration commits (version 1, `t_ok` exists), second raises `ValueError`, caught as `RuntimeError`, version stays at 1 |\n\n### Findings\n\n#### [Medium] No constraint preventing multiple rows in `schema_version`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- The `schema_version` table is created with `(version INTEGER NOT NULL)` but has no PRIMARY KEY, UNIQUE constraint, or CHECK constraint limiting it to a single row. If a bug or manual intervention inserts a second row, `get_version` would return whichever row SQLite returns first from `SELECT version FROM schema_version` (non-deterministic without ORDER BY).\n- **Action**: Consider adding a single-row constraint in a future migration (e.g., `CHECK (rowid = 1)` or a dummy `id INTEGER PRIMARY KEY CHECK (id = 1)` column). Not blocking for M1 since all writes go through `_ensure_version_table` which correctly checks before inserting.\n\n#### [Low] Redundant `_ensure_version_table` calls\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, lines 48-49\n- `migrate()` calls `_ensure_version_table(conn)` on line 48, then calls `get_version(conn)` on line 49, which internally calls `_ensure_version_table` again. This results in two `CREATE TABLE IF NOT EXISTS` and two `SELECT version` queries on every `migrate` call.\n- **Action**: Minor performance concern. Could be refactored so `migrate` calls `_ensure_version_table` once and reads the version directly. Not blocking.\n\n#### [Info] Global mutable state for migrations registry\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 15\n- `_migrations` is a module-level mutable list. This is a common pattern for migration registries and works well for single-process applications. The test suite correctly saves/restores it via the `_clean_migrations` autouse fixture (lines 16-23 in test file).\n- **Action**: None. This is an appropriate pattern for this use case. If multi-process or plugin-based architectures are introduced later, consider a class-based registry.\n\n#### [Info] Test fixture properly isolates migration state\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_migrations.py`, lines 16-23\n- The `_clean_migrations` fixture saves the original list, clears it before each test, and restores it after. This prevents test pollution and is correctly marked `autouse=True`. The save-clear-yield-clear-extend pattern is the correct idiom.\n\n#### [Info] `conn` fixture uses `get_connection` from `db` module\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_migrations.py`, lines 27-31\n- The test fixture uses `get_connection` (from Issue #2) rather than raw `sqlite3.connect`. This ensures WAL mode and `busy_timeout` pragmas are applied, matching production behavior. This is a good integration practice.\n\n#### [Info] Coverage at 100%\n\n- All 41 statements in `migrations.py` are covered by the 4 tests. No untested branches.\n\n#### [Info] Error message includes original exception\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, lines 68-70\n- `raise RuntimeError(...) from exc` preserves the exception chain, making debugging easier. The message format `\"Migration to version {N} failed: {exc}\"` clearly identifies which migration failed. This follows the acceptance criterion for \"clear message.\"\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and minimal:\n\n- The `@register` decorator pattern is intuitive for defining migrations in order.\n- Transaction semantics are correctly handled: commit on success, rollback on failure.\n- The version update uses a parameterized query (`?` placeholder on line 63), avoiding SQL injection.\n- Logging at appropriate levels: `info` for migration steps and completion, `debug` for up-to-date status.\n- The code correctly handles the edge case where `current > target` (e.g., if migrations are removed), treating it the same as up-to-date.\n- 100% test coverage with all four required tests present and passing.\n\n**Verdict: APPROVE** -- no blocking issues. One medium finding (missing single-row constraint) noted for follow-up.\n\n---\n\n## Security Findings\n\n### [Medium] S1: `schema_version` table lacks row-count constraint\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- **Description**: The `schema_version` table has no mechanism to enforce that exactly one row exists. While the application code only writes through `_ensure_version_table` (which checks before inserting) and `migrate` (which uses `UPDATE`), a direct SQL injection in a future module or manual DB editing could insert additional rows, causing `get_version` to return an unpredictable value. This could lead to migrations being skipped or re-applied.\n- **Severity**: Medium (requires either a separate SQL injection vulnerability or direct DB access to exploit; impact is schema corruption)\n- **Recommendation**: In the V1 schema migration (Issue #4), alter or recreate the table with a single-row constraint, e.g., `CREATE TABLE schema_version (id INTEGER PRIMARY KEY CHECK (id = 1), version INTEGER NOT NULL)`.\n\n### [Info] S2: No SQL injection risk in migration runner\n\n- All SQL in `migrations.py` uses either hardcoded string literals or parameterized queries (`?` on line 63 for the version update). The `MigrationFn` type receives a `Connection` object, and it is the responsibility of each registered migration to use parameterized queries. This is correctly documented in the PR #4 review follow-up.\n\n### [Info] S3: Migration functions are trusted code\n\n- The `@register` decorator appends arbitrary callables to the migration list. Since migrations are defined at module import time by the application developer (not by user input), there is no injection risk. The registry is not exposed to any user-facing API.\n\n### [Info] S4: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `migrations.py` or `test_migrations.py`.\n\n### [Info] S5: No new dependencies introduced\n\n- This module uses only Python standard library (`sqlite3`, `logging`, `typing`). No new entries in `pyproject.toml` dependencies.\n\n### [Info] S6: Exception message does not leak sensitive data\n\n- The `RuntimeError` message on line 69 includes the migration version number and the string representation of the original exception. In this context (local SQLite, no user-supplied data in migration functions), this does not leak sensitive information. If migrations ever process user data, the exception wrapping should be reviewed to avoid leaking PII in logs.\n\n### Security Summary\n\nNo Critical or High severity findings. One Medium finding regarding the missing single-row constraint on `schema_version`, which could lead to schema version confusion if combined with a separate vulnerability that allows arbitrary SQL execution. The recommendation is to address this in the Issue #4 V1 schema migration.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Issue #4 (V1 schema)**: Add a single-row constraint to `schema_version` (e.g., `CHECK (id = 1)` on a primary key column) as part of the V1 migration to prevent version-table corruption.\n2. **Future**: Refactor `migrate()` to avoid redundant `_ensure_version_table` calls for minor performance improvement.\n3. **Future**: Consider adding a `--dry-run` mode to the migration runner that reports which migrations would be applied without executing them, useful for deployment verification.\n\n---\n\n# PR #8 Review Notes -- Issue #4: V1 schema migration -- projects, tasks, task_assignees, events\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/004-v1-schema`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `projects` table with `ux_projects_shared_name` and `ux_projects_private_owner_name` partial unique indexes | PASS | Table created on lines 18-26, indexes on lines 28-36 of `schema_v1.py`. Partial `WHERE` clauses match PRD exactly. |\n| `tasks` table with section and status CHECK constraints | PASS | Section CHECK on line 43 (`backlog, doing, waiting, done, drop`), status CHECK on line 45 (`open, done, dropped`). Both match PRD spec. |\n| `task_assignees` table with composite PK and secondary index | PASS | Composite `PRIMARY KEY (task_id, assignee_user_id)` on line 57, secondary index `ix_task_assignees_user` on lines 61-64. |\n| `events` audit table created | PASS | Table on lines 66-75. Columns match PRD. |\n| Shared `Inbox` project auto-created (INSERT OR IGNORE) | PASS | Line 78-81 uses `INSERT OR IGNORE` with `('Inbox', 'shared', NULL)`. |\n| `schema_version` = 1 after migration | PASS | Test `test_v1_schema_version` verifies `get_version(conn) == 1`. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_v1_tables_exist` | PASS -- verifies all four tables exist in `sqlite_master` |\n| `test_v1_inbox_created` | PASS -- verifies name='Inbox', visibility='shared', owner_user_id=None |\n| `test_v1_shared_unique_index_enforced` | PASS -- duplicate shared name raises `IntegrityError` |\n| `test_v1_private_unique_index_enforced` | PASS -- duplicate (owner, name) raises `IntegrityError`; different owner succeeds |\n\n### Findings\n\n#### [High] F1: Foreign keys not enforced -- `PRAGMA foreign_keys=ON` missing\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 35-37\n- **Description**: SQLite does not enforce `REFERENCES` (foreign key) clauses by default. The `PRAGMA foreign_keys=ON` must be executed on every new connection for FK constraints to be active. Without this, the `REFERENCES projects(id)` on `tasks.project_id` and `REFERENCES tasks(id)` on `task_assignees.task_id` are purely decorative -- you can insert tasks pointing to non-existent projects and assignees pointing to non-existent tasks.\n- **Impact**: Referential integrity is silently not enforced, leading to orphaned rows and data corruption.\n- **Fix applied**: Added `conn.execute(\"PRAGMA foreign_keys=ON;\")` to `get_connection()` in `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 38. All 19 tests pass after the fix.\n\n#### [Medium] F2: `schema_version` single-row constraint not added in V1\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- **Description**: The PR #6 review (Medium finding S1) recommended adding a single-row constraint to `schema_version` as part of the V1 migration. This was not addressed. The table still has no PK or CHECK constraint to prevent multiple rows.\n- **Action**: Should be addressed in a follow-up issue. Adding it retroactively in a later migration (e.g., V2) would require recreating the table since SQLite does not support `ALTER TABLE ADD CONSTRAINT`.\n\n#### [Low] F3: Minor PRD deviation on `events.ts` -- NOT NULL DEFAULT added\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/schema_v1.py`, line 69\n- **Description**: The PRD spec for `events.ts` says `ts TEXT` with no nullability or default constraint. The implementation adds `NOT NULL DEFAULT (datetime('now'))`. This is a sensible enhancement (audit timestamps should always be present), but it is a deviation from the spec.\n- **Action**: None needed. The implementation is better than the spec. Consider updating the PRD to match.\n\n#### [Low] F4: `events.id` uses AUTOINCREMENT, PRD says PK only\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/schema_v1.py`, line 68\n- **Description**: PRD says `id INTEGER PK` for the events table. The implementation uses `INTEGER PRIMARY KEY AUTOINCREMENT`. AUTOINCREMENT prevents rowid reuse after deletion, which is actually preferable for an audit log (guarantees monotonically increasing IDs). This is a minor deviation but a positive one.\n- **Action**: None needed. Consider updating the PRD.\n\n#### [Low] F5: No test for `task_assignees` composite PK enforcement\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_schema_v1.py`\n- **Description**: The acceptance criteria mention `task_assignees` table with composite PK, but there is no test verifying that inserting a duplicate `(task_id, assignee_user_id)` pair raises `IntegrityError`. The composite PK is created, but its enforcement is untested.\n- **Action**: Add a test in a follow-up to insert a duplicate pair and assert `IntegrityError`.\n\n#### [Low] F6: No test for foreign key enforcement\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_schema_v1.py`\n- **Description**: No test verifies that inserting a task with a non-existent `project_id` raises an error, or that inserting a `task_assignee` with a non-existent `task_id` raises an error. With the FK pragma fix (F1), these would now fail correctly, but there is no test coverage for this behavior.\n- **Action**: Add FK enforcement tests in a follow-up.\n\n#### [Info] F7: Test fixture pattern is well-structured\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_schema_v1.py`, lines 11-25\n- The `_load_v1_migration` autouse fixture correctly saves, clears, imports, and restores the migration registry. The `conn` fixture properly creates a temp DB, migrates, yields, and closes. This is clean test isolation.\n\n#### [Info] F8: CHECK constraint tests are thorough\n\n- Tests `test_v1_section_check_constraint` and `test_v1_status_check_constraint` go beyond the required tests to verify that invalid enum values are rejected. Good defensive testing.\n\n#### [Info] F9: 8 tests total for V1 schema, all passing\n\n- `test_v1_tables_exist`, `test_v1_schema_version`, `test_v1_inbox_created`, `test_v1_shared_unique_index_enforced`, `test_v1_private_unique_index_enforced`, `test_v1_section_check_constraint`, `test_v1_status_check_constraint` (7 tests in `test_schema_v1.py`). Plus the rollback test verifies `conn.rollback()` is correctly called after each constraint violation test.\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and closely follows the PRD spec:\n\n- All four tables are created with the correct columns, types, and constraints.\n- Partial unique indexes use the correct `WHERE` clause syntax.\n- CHECK constraints enumerate exactly the values specified in the PRD.\n- `INSERT OR IGNORE` for the Inbox seed is idempotent.\n- Parameterized queries are not needed here (all DDL uses string literals with no interpolation).\n- The `@register` decorator integrates seamlessly with the migration framework from Issue #3.\n- Test coverage is good, with 7 tests covering table existence, version, seed data, unique indexes, and CHECK constraints.\n\n**Verdict: APPROVE with one fix applied** -- the `PRAGMA foreign_keys=ON` fix (High, F1) has been applied directly. Medium/Low findings are noted for follow-up.\n\n---\n\n## Security Findings\n\n### [High] S1: Foreign key constraints not enforced (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 35-37\n- **Description**: Without `PRAGMA foreign_keys=ON`, all `REFERENCES` clauses in the V1 schema are ignored. This means a future command handler could insert tasks referencing non-existent projects or assignees referencing non-existent tasks, leading to data integrity violations that are silent and hard to debug. In a multi-user Slack plugin, this could allow one user's actions to create orphaned records that cause errors for other users.\n- **Severity**: High (data integrity violation in a multi-user context; silent failure mode)\n- **Fix**: Added `conn.execute(\"PRAGMA foreign_keys=ON;\")` to `get_connection()`. All 19 tests pass.\n\n### [Medium] S2: `schema_version` table remains unprotected against multi-row corruption\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- **Description**: Carried forward from PR #6 review. The `schema_version` table has no constraint preventing insertion of additional rows. If a separate vulnerability allows arbitrary SQL execution, an attacker could manipulate the schema version to skip or re-run migrations.\n- **Severity**: Medium (requires a chained vulnerability to exploit)\n- **Recommendation**: Address in a future migration that recreates the table with a single-row constraint.\n\n### [Info] S3: No SQL injection risk in V1 migration\n\n- All SQL in `schema_v1.py` uses hardcoded string literals. No user input, no string interpolation, no parameterized queries needed. The `INSERT OR IGNORE` for the Inbox seed uses literal values only.\n\n### [Info] S4: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `schema_v1.py` or `test_schema_v1.py`.\n\n### [Info] S5: No new dependencies introduced\n\n- The V1 migration uses only Python standard library (`sqlite3`, `logging`). No new entries in `pyproject.toml`.\n\n### [Info] S6: CHECK constraints provide defense-in-depth\n\n- The `section` and `status` CHECK constraints on the `tasks` table prevent invalid enum values at the database level, not just the application level. This is a security-positive pattern that prevents data corruption even if the application layer has a bug.\n\n### Security Summary\n\nOne High severity finding (S1: missing `PRAGMA foreign_keys=ON`) was identified and fixed directly in `db.py`. One Medium finding (S2: `schema_version` single-row constraint) is carried forward from the previous review. No Critical findings.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Test coverage**: Add tests for `task_assignees` composite PK enforcement (duplicate pair should raise `IntegrityError`).\n2. **Test coverage**: Add tests for foreign key enforcement (task with non-existent `project_id`, assignee with non-existent `task_id` should raise `IntegrityError` now that FK pragma is enabled).\n3. **Schema version constraint**: Address the `schema_version` single-row constraint in a future migration (V2 or later) by recreating the table with `CHECK (id = 1)`.\n4. **PRD sync**: Update PRD section 6.3 to add `NOT NULL DEFAULT (datetime('now'))` to `events.ts` and `AUTOINCREMENT` to `events.id` to match the implementation.\n5. **DB module**: Add a test for `PRAGMA foreign_keys` returning `1` in `test_db.py` to prevent regression.\n\n---\n\n# PR #10 Review Notes -- Issue #5: Command parser -- tokenizer and option extraction\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/005-parser-tokenizer`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `/p MyProject` correctly extracted; token consumed | PASS | `test_extract_project` verifies project name extracted, `/p` and value removed from `title_tokens`. |\n| `/s doing` validated; invalid section raises `ParseError` | PASS | `test_extract_section_valid` and `test_extract_section_invalid` cover both paths. Case-insensitive via `.lower()`. |\n| `due:03-15` normalised to `2026-03-15` (current year) | PASS | `test_due_mm_dd_normalisation` verifies with `date.today().year`. |\n| `due:2026-02-30` raises `ParseError` (invalid date) | PASS | `test_due_invalid_date` asserts `ParseError` with match on \"Invalid due date\". |\n| `<@U12345>` extracted into mentions list | PASS | `test_mentions_extraction` verifies two mentions extracted and not in `title_tokens`. |\n| Multiple mentions supported | PASS | Same test covers two mentions in order. |\n| Title tokens are non-option, non-mention tokens before first option | PASS | `test_title_extraction` verifies correct split with mixed options. Note: title tokens are collected from *all* positions, not just \"before first option\" -- this is arguably more flexible than the AC wording. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_extract_project` | PASS |\n| `test_extract_section_valid` | PASS |\n| `test_extract_section_invalid` | PASS |\n| `test_due_mm_dd_normalisation` | PASS |\n| `test_due_full_date` | PASS |\n| `test_due_invalid_date` | PASS |\n| `test_due_clear` | PASS |\n| `test_mentions_extraction` | PASS |\n| `test_title_extraction` | PASS |\n\nAll 9 required tests present and passing. 4 additional bonus tests (`test_command_extraction`, `test_move_extracts_id_as_arg`, `test_empty_command_raises`, `test_section_case_insensitive`). 13 parser tests total.\n\n### Findings\n\n#### [Medium] F1: Leap-year bug in `_normalise_due` for MM-DD format (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 53-62 (after fix)\n- **Description**: The original implementation used `datetime.strptime(raw, \"%m-%d\")` which defaults to year 1900 (not a leap year). This caused `due:02-29` to always be rejected, even when the current year is a leap year (e.g., 2028). The `replace(year=current_year)` call was never reached because `strptime` itself raised `ValueError`.\n- **Fix applied**: Replaced `strptime(\"%m-%d\")` with a regex match `(\\d{1,2})-(\\d{1,2})` followed by direct `date(current_year, month, day)` construction. This correctly validates Feb 29 against the actual current year.\n- **Impact**: Without fix, `due:02-29` would fail in leap years (2028, 2032, etc.) when it should succeed.\n\n#### [Low] F2: Duplicate options silently use \"last wins\" semantics\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 91-117\n- **Description**: If a user provides `/p First /p Second`, the parser silently uses `Second`. Same for `/s` and `due:`. This is not necessarily wrong, but it is undocumented. \"Last wins\" is a reasonable default, but \"first wins\" or \"raise error on duplicate\" are also valid choices.\n- **Action**: Document the \"last wins\" behavior in the docstring or PRD. No code change needed.\n\n#### [Low] F3: `/p` and `/s` error paths (missing argument) are untested\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_parser.py`\n- **Description**: Lines 93 and 101 (`raise ParseError(\"/p requires a project name\")` and `/s` equivalent) are uncovered. Manual testing confirmed they work correctly, but automated test coverage is missing for these edge cases.\n- **Action**: Add tests for `parse(\"add task /p\")` and `parse(\"add task /s\")` in a follow-up.\n\n#### [Low] F4: `_DUE_RE` uses `.+` which accepts any characters after `due:`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, line 15\n- **Description**: `_DUE_RE = re.compile(r\"^due:(.+)$\")` will match `due:anything` and pass the value to `_normalise_due`. This is not a bug since `_normalise_due` properly validates the value, but a tighter regex like `r\"^due:([\\d-]+)$\"` would reject obviously invalid inputs earlier and serve as documentation of expected format.\n- **Action**: Optional tightening. Not blocking since validation is correct.\n\n#### [Low] F5: Title tokens are collected from all positions, not just \"before first option\"\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 126-128\n- **Description**: The AC says \"Title tokens are non-option, non-mention tokens before first option.\" The implementation collects title tokens from all positions (e.g., `add Buy /p Home milk` would produce `title_tokens=[\"Buy\", \"milk\"]`). This is actually more flexible and user-friendly, but deviates from the literal AC wording.\n- **Action**: Consider updating the AC to match the implementation. The current behavior is better for UX.\n\n#### [Info] F6: `args` extraction for `move/done/drop/edit` is well-designed\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 130-133\n- The pattern of extracting the first title token as `args[0]` for ID-based commands is clean and tested by `test_move_extracts_id_as_arg`.\n\n#### [Info] F7: Coverage at 97%\n\n- Lines 93 and 101 (error paths for missing `/p` and `/s` arguments) are uncovered. All other branches are tested. This is acceptable for M1.\n\n#### [Info] F8: Bonus tests add good defensive coverage\n\n- `test_section_case_insensitive` ensures `/s DOING` normalizes to `doing`.\n- `test_command_extraction` verifies the first token becomes the command.\n- `test_empty_command_raises` covers the empty input guard.\n- `test_move_extracts_id_as_arg` covers the args extraction logic.\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and well-structured:\n\n- The tokenizer loop with explicit index management (`while i < len(remaining)`) is readable and handles two-token options (`/p`, `/s`) cleanly by advancing `i` by 2.\n- `ParsedCommand` dataclass provides a clear, typed result structure.\n- `VALID_SECTIONS` as a `frozenset` is the right choice for O(1) membership testing.\n- `_MENTION_RE` uses `fullmatch` (not `match` or `search`), preventing partial matches on tokens like `<@U123>extra`.\n- Error messages are descriptive and include the invalid value with `repr()` formatting.\n- Logging at debug level for parsed results is appropriate.\n- 97% test coverage with all 9 required tests present and 4 bonus tests.\n\n**Verdict: APPROVE with one fix applied** -- the leap-year bug in `_normalise_due` (Medium, F1) has been fixed directly. Low findings are noted for follow-up.\n\n---\n\n## Security Findings\n\n### [Medium] S1: Leap-year date validation bypass (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, `_normalise_due`\n- **Description**: The original `strptime(\"%m-%d\")` approach silently rejected valid dates (`02-29` in leap years) due to the 1900 default year. While this is a correctness issue rather than a security vulnerability, incorrect date validation can lead to denial of service (users unable to set valid due dates) and data integrity issues (dates that should be accepted are rejected).\n- **Severity**: Medium (correctness bug with functional impact)\n- **Fix**: Replaced with regex-based month/day extraction and direct `date()` construction with the current year.\n\n### [Low] S2: No ReDoS risk in compiled regexes\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 14-15\n- **Description**: Both `_MENTION_RE = re.compile(r\"<@(U[A-Z0-9]+)>\")` and `_DUE_RE = re.compile(r\"^due:(.+)$\")` were tested with 100,000-character inputs and completed in under 0.1ms. Neither pattern contains nested quantifiers or alternation that could cause catastrophic backtracking.\n- **Severity**: Low (no risk found, noting for completeness)\n\n### [Low] S3: No input length validation on parser input\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, line 72\n- **Description**: `parse(text)` accepts arbitrarily long strings. `text.strip().split()` will allocate a token list proportional to input size. Slack limits messages to ~40,000 characters, mitigating this at the transport layer, but if the parser is used outside Slack, extremely long inputs could cause memory pressure.\n- **Severity**: Low (mitigated by Slack transport layer limits)\n- **Recommendation**: Consider adding a max-length guard in the plugin entry point (`handle_message`) rather than the parser itself.\n\n### [Info] S4: No injection risks\n\n- The parser only tokenizes and validates strings. No SQL, no shell commands, no template rendering. User input flows into `ParsedCommand` fields which are plain strings. Security depends on how these values are consumed downstream (e.g., parameterized queries when writing to SQLite).\n\n### [Info] S5: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `parser.py` or `test_parser.py`.\n\n### [Info] S6: No new dependencies introduced\n\n- The parser uses only Python standard library (`re`, `datetime`, `dataclasses`, `logging`). No new entries in `pyproject.toml`.\n\n### Security Summary\n\nNo Critical or High severity findings. One Medium finding (S1: leap-year date validation) was identified and fixed. The parser has a minimal attack surface -- it tokenizes strings and validates against known patterns. The main security consideration going forward is ensuring that `ParsedCommand` field values are used safely downstream (parameterized SQL queries, no raw echo in web contexts).\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Test coverage**: Add tests for `/p` and `/s` without arguments (lines 93, 101) to cover the missing-argument error paths.\n2. **Documentation**: Document \"last wins\" semantics for duplicate `/p`, `/s`, and `due:` options in the PRD or parser docstring.\n3. **Optional**: Tighten `_DUE_RE` from `.+` to `[\\d-]+` for earlier rejection of obviously invalid due values.\n4. **AC clarification**: Update Issue #5 AC to reflect that title tokens are collected from all positions (not just \"before first option\"), matching the implemented behavior.\n\n---\n\n# PR #12 Review Notes -- Issue #7: Project resolver helper\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/007-project-resolver`\n# PR #14 Review Notes -- Issue #16: Command dispatcher and routing\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature-016-dispatcher`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| Private project of sender matched first | PASS | Query on line 38-42 filters by `visibility = 'private' AND owner_user_id = ?`. Test `test_private_takes_priority` verifies. |\n| Falls back to shared if no private match | PASS | Second query on line 52-56 filters by `visibility = 'shared'`. Test `test_falls_back_to_shared` verifies. |\n| Returns error when neither exists (except Inbox auto-created) | PASS | `ProjectNotFoundError` raised on line 84. Inbox auto-created on lines 66-81. Tests `test_unknown_project_error` and `test_inbox_auto_created` verify. |\n| Returns project row with id, name, visibility, owner_user_id | PASS | `Project` dataclass on lines 17-23 with all four fields. All tests assert on these fields. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_private_takes_priority` | PASS -- creates both shared and private \"Work\", verifies private is returned for owner U1 |\n| `test_falls_back_to_shared` | PASS -- creates shared \"Team\" only, verifies shared returned for U1 |\n| `test_inbox_auto_created` | PASS -- deletes seeded Inbox, verifies auto-creation as shared with null owner |\n| `test_unknown_project_error` | PASS -- verifies `ProjectNotFoundError` raised with descriptive message |\n\nAll 4 required tests present and passing. 2 additional bonus tests (`test_inbox_already_exists`, `test_private_different_owner_not_matched`). 6 tests total.\n\n### Findings\n\n#### [Low] F1: Project name matching is case-sensitive\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 39-42\n- **Description**: The SQL queries use `WHERE name = ?` which is case-sensitive in SQLite by default (for ASCII). If a user types `/p work` but the project is named `Work`, it will not match. The PRD does not specify case-sensitivity behavior, so this is not a bug per se, but it could cause user confusion.\n- **Action**: Document the case-sensitive behavior. Consider adding `COLLATE NOCASE` in a future iteration if case-insensitive matching is desired.\n\n#### [Low] F2: Repeated `Project(id=row[0], ...)` construction pattern\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 44, 58, 76\n- **Description**: The same `Project(id=row[0], name=row[1], visibility=row[2], owner_user_id=row[3])` pattern appears three times. This could be extracted to a helper (e.g., `Project._from_row(row)` classmethod or a module-level `_row_to_project` function) to reduce duplication and ensure consistency if columns change.\n- **Action**: Optional refactor. Not blocking for M1.\n\n#### [Low] F3: `conn.commit()` called inside resolver for Inbox auto-creation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, line 71\n- **Description**: The resolver calls `conn.commit()` directly after the `INSERT OR IGNORE` for Inbox auto-creation. This commits any pending transaction state on the connection, which could be surprising if the caller has uncommitted changes. In the current codebase this is not an issue (resolver is called early in command handling), but it couples the resolver to transaction management.\n- **Action**: Consider whether the caller should be responsible for committing. For M1 this is acceptable since the auto-creation is a one-time idempotent operation.\n\n#### [Low] F4: No test for Inbox auto-creation when a private Inbox exists\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/tests/test_project_resolver.py`\n- **Description**: If a user has a private project named \"Inbox\", `resolve_project(conn, \"Inbox\", user_id)` will return the private project (step 1 matches). The auto-creation path (step 3) is only reached if neither private nor shared \"Inbox\" exists. This behavior is correct per the resolution order, but there is no test covering the scenario where a user has a private \"Inbox\" and the shared \"Inbox\" also exists -- the test should verify that the private one is returned.\n- **Action**: Add a test for this edge case in a follow-up.\n\n#### [Info] F5: `INSERT OR IGNORE` is the correct pattern for Inbox auto-creation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 67-70\n- `INSERT OR IGNORE` handles the race condition where two concurrent requests try to auto-create Inbox simultaneously. The `ux_projects_shared_name` unique index on `(name) WHERE visibility = 'shared'` ensures only one shared Inbox can exist. The subsequent `SELECT` on lines 72-75 guarantees we return the correct row regardless of whether this request or another one performed the insert. This is well-designed.\n\n#### [Info] F6: Bonus tests add good defensive coverage\n\n- `test_inbox_already_exists` verifies that the seeded Inbox (from V1 migration) resolves without triggering auto-creation.\n- `test_private_different_owner_not_matched` verifies that a private project owned by U2 is not visible to U1, correctly raising `ProjectNotFoundError`.\n\n#### [Info] F7: Coverage at 100%\n\n- All 31 statements in `project_resolver.py` are covered by the 6 tests. No untested branches.\n\n#### [Info] F8: Test fixture pattern is consistent with prior PRs\n\n- The `_load_v1` autouse fixture and `conn` fixture follow the same save-clear-restore pattern established in prior PRs. Good consistency.\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and follows the PRD resolution order exactly:\n\n- Three-step resolution (private -> shared -> Inbox auto-create) with clear fallthrough logic.\n- All SQL queries use parameterized placeholders (`?`), preventing SQL injection.\n- `Project` dataclass provides a typed result with the four required fields.\n- `ProjectNotFoundError` is a well-named custom exception with descriptive message.\n- Logging at debug level for each resolution path aids troubleshooting.\n- `INSERT OR IGNORE` handles concurrent Inbox auto-creation safely.\n- 100% test coverage with all 4 required tests and 2 valuable bonus tests.\n- The code is 85 lines total -- minimal and readable.\n\n**Verdict: APPROVE** -- no Critical or High findings. All Low findings are noted for follow-up.\n### Changed Files\n\n| File | Change | Lines |\n|------|--------|-------|\n| `src/openclaw_todo/dispatcher.py` | NEW | 116 |\n| `src/openclaw_todo/plugin.py` | MODIFIED | 33 |\n| `tests/test_dispatcher.py` | NEW | 152 |\n| `tests/test_plugin.py` | MODIFIED | 39 |\n\n### Architecture Overview\n\nThe dispatcher implements a two-level routing architecture:\n\n1. **Plugin layer** (`plugin.py`): Strips `/todo` prefix, returns USAGE for bare `/todo`, delegates remainder to `dispatch()`.\n2. **Dispatcher layer** (`dispatcher.py`): Parses the remainder via the parser, validates command name against `_VALID_COMMANDS`, opens a DB connection with migration, routes to the appropriate handler (or stub), and closes the connection in a `finally` block.\n3. **Project sub-routing**: `project` command delegates to `_dispatch_project()` which extracts the subcommand from `parsed.title_tokens` and routes to `project_<subcommand>` handlers in the registry.\n\n### Findings\n\n#### [Low] F1: Weak test assertion on stub handler (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/tests/test_dispatcher.py`, line 48\n- **Description**: The original assertion was:\n  ```python\n  assert \"not yet implemented\" in result.lower() or isinstance(result, str)\n  ```\n  The `isinstance(result, str)` clause makes this trivially true since `dispatch()` always returns `str`. The test does not actually verify that the stub handler was invoked -- any string return would pass.\n- **Fix applied**: Removed the `or isinstance(result, str)` fallback. The assertion now strictly verifies that the stub handler message is present:\n  ```python\n  assert \"not yet implemented\" in result.lower()\n  ```\n- **Impact**: Test now correctly fails if the stub handler message format changes or if a different code path is taken.\n\n#### [Low] F2: `_stub_handler` signature differs from `HandlerFn` type alias\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 17, 47\n- **Description**: The `HandlerFn` type alias is `Callable[[ParsedCommand, Connection, dict], str]` (3 args), but `_stub_handler` takes 4 args: `(command, parsed, conn, context)`. This works because `_stub_handler` is never registered directly in `_handlers` -- it is always called via a lambda wrapper in `_get_handler` (line 59) and `_dispatch_project` (line 115) that captures `command` via closure. However, the mismatch makes the code harder to follow at a glance.\n- **Action**: Consider refactoring `_stub_handler` to accept `(parsed, conn, context)` and derive the command name from `parsed.command`. Not blocking since the current approach is correct.\n\n#### [Low] F3: Long line in `_dispatch_project`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 115\n- **Description**: Line 115 is 116 characters, exceeding typical line length limits (88 for black, 100 for many projects). The lambda + `_handlers.get` + `_stub_handler` call is dense.\n- **Action**: Consider breaking into multiple lines for readability. Not blocking.\n\n#### [Low] F4: Global mutable `_handlers` dict shared across tests\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 54\n- **Description**: The `_handlers` dict is module-level mutable state. The test fixture `_clean_handlers` (test file line 22-28) correctly saves and restores it between tests. However, if the test suite were run in parallel (e.g., `pytest-xdist`), the shared state could cause flaky tests.\n- **Action**: For a single-process Slack plugin this is fine. Document the limitation if parallel test execution is ever introduced.\n\n#### [Info] F5: DB connection lifecycle is correct\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 86-94\n- The `dispatch()` function opens the DB connection *after* validating the command name (line 80-82 returns early for unknown commands without touching the DB). The connection is always closed in a `finally` block (line 94), ensuring no leaks even if handlers raise exceptions. This is good resource management.\n\n#### [Info] F6: Unknown commands do not open a DB connection\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 80-82\n- The `if command not in _VALID_COMMANDS` check returns before `_init_db()` is called. This avoids unnecessary DB initialization for typos and invalid commands. Good design.\n\n#### [Info] F7: Parse errors are caught and returned as user-facing messages\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 73-76\n- `ParseError` is caught and formatted as `f\"Parse error: {exc}\"`. The parser's error messages are descriptive (e.g., \"Invalid section: 'xyz'\") and do not leak internal details. This is appropriate for a Slack DM context.\n\n#### [Info] F8: Plugin entry-point correctly wired to dispatcher\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/plugin.py`\n- The `handle_message()` function now delegates to `dispatch()` instead of the previous placeholder response. The prefix matching logic is unchanged and still correct. The `db_path` parameter flows through to `dispatch()` for testability.\n\n#### [Info] F9: Schema import triggers migration registration\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 14\n- `import openclaw_todo.schema_v1 as _schema_v1` with `# noqa: F401` ensures the `@register` decorator in `schema_v1.py` runs at import time, populating the migration registry before any `migrate()` call. This is the correct pattern for the decorator-based migration system.\n\n#### [Info] F10: Test coverage is comprehensive\n\n- 20 dispatcher + plugin tests covering:\n  - All 7 non-project commands routed to stubs (parametrized)\n  - Custom handler registration and invocation\n  - All 3 project subcommands routed correctly\n  - Project with no subcommand returns usage\n  - Unknown project subcommand returns error\n  - Unknown top-level command returns error with usage\n  - Parse error propagation\n  - DB initialization with schema migration\n  - Plugin prefix matching (non-todo, todo, whitespace, bare /todo)\n\n### Code Quality Summary\n\nThe dispatcher implementation is clean, well-structured, and follows good design principles:\n\n- **Separation of concerns**: Plugin handles prefix matching; dispatcher handles parsing, validation, DB init, and routing. Each has a single responsibility.\n- **Resource safety**: DB connection opened late (only for valid commands) and closed in `finally`.\n- **Extensibility**: The `register_handler()` function provides a clean API for future command implementations to plug in without modifying the dispatcher.\n- **Defensive routing**: Unknown commands and parse errors return helpful user-facing messages without touching the DB or raising unhandled exceptions.\n- **Project sub-routing**: The `project_<subcommand>` naming convention with `replace('-', '_')` is a clean pattern for hyphenated subcommands.\n- **Test isolation**: The `_clean_handlers` autouse fixture properly saves and restores the handler registry between tests.\n\n**Verdict: APPROVE with one fix applied** -- the weak test assertion (Low, F1) has been strengthened. No Critical or High code quality issues found.\n\n---\n\n## Security Findings\n\n### [Low] S1: No SQL injection risk -- parameterized queries used throughout\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 38-42, 52-56\n- **Description**: All SQL queries use `?` parameter placeholders for user-supplied values (`name` and `sender_id`). The Inbox auto-creation on lines 67-75 uses hardcoded string literals only. No string interpolation or f-strings are used in any SQL statement.\n- **Severity**: Low (no risk found, noting for completeness)\n\n### [Low] S2: `name` parameter is not length-validated\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, line 27\n- **Description**: `resolve_project(conn, name, sender_id)` accepts arbitrarily long `name` strings. While SQLite handles this safely (TEXT has no inherent length limit), an extremely long name would result in unnecessary query execution against the database. The parser upstream (Issue #5) extracts project names from `/p <name>` tokens, and Slack limits message length to ~40,000 characters, providing transport-layer mitigation.\n- **Severity**: Low (mitigated by upstream constraints)\n- **Recommendation**: Consider adding a max-length check for project names in the parser or a future validation layer.\n\n### [Low] S3: Inbox auto-creation commits transaction implicitly\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, line 71\n- **Description**: `conn.commit()` inside the resolver commits all pending changes on the connection, not just the Inbox insert. If a future caller has uncommitted writes before calling `resolve_project`, those writes would be committed as a side effect. This is not exploitable but could lead to partial commits in error scenarios.\n- **Severity**: Low (no current exploit path; architectural concern)\n- **Recommendation**: Consider using a savepoint pattern (`SAVEPOINT` / `RELEASE`) for the Inbox auto-creation to isolate its transaction from any outer transaction.\n\n### [Info] S4: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `project_resolver.py` or `test_project_resolver.py`.\n\n### [Info] S5: No new dependencies introduced\n\n- The module uses only Python standard library (`sqlite3`, `dataclasses`, `logging`). No new entries in `pyproject.toml`.\n\n### [Info] S6: Authorization model is correctly scoped\n\n- The `sender_id` parameter is used correctly in the private-project query to scope visibility. User U1 cannot resolve another user's private projects. Test `test_private_different_owner_not_matched` explicitly verifies this isolation. The shared-project query correctly omits owner filtering, as shared projects are visible to all users.\n\n### Security Summary\n\nNo Critical, High, or Medium severity findings. The implementation has a minimal attack surface -- three read queries and one idempotent insert, all using parameterized queries. The authorization model (private scoped to sender, shared visible to all) is correctly implemented and tested. Three Low findings are noted for awareness but require no immediate action.\n### [Low] S1: User input reflected in error messages\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 76, 82, 110\n- **Description**: Three error paths echo user-supplied values back in responses:\n  - `f\"Parse error: {exc}\"` (line 76) -- parser error messages may contain raw user input\n  - `f\"Unknown command: '{command}'\\n{USAGE}\"` (line 82) -- the command name is user input\n  - `f\"Unknown project subcommand: '{sub}'\\n{PROJECT_USAGE}\"` (line 110) -- the subcommand is user input\n- **Severity**: Low. In the Slack DM context, Slack handles message escaping. The reflected values are single tokens (no spaces, limited characters after `split()` tokenization). No HTML/JS injection is possible in this context.\n- **Recommendation**: If the plugin ever serves responses in a web context (e.g., dashboard, webhook response viewer), sanitize reflected values. No fix needed for current Slack-only usage.\n\n### [Low] S2: No input length validation at dispatcher level\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 67\n- **Description**: `dispatch(text, ...)` accepts arbitrarily long strings, which flow to `parse()` for tokenization. Slack limits messages to approximately 40,000 characters, providing transport-layer mitigation.\n- **Severity**: Low (mitigated by Slack transport layer)\n- **Recommendation**: Consider adding a max-length guard in `handle_message()` if the plugin is ever exposed outside Slack.\n\n### [Low] S3: Handler exception propagation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 91-92\n- **Description**: If a registered handler raises an unhandled exception, it propagates up through `dispatch()`. The `finally` block ensures the DB connection is closed, but the exception itself is not caught. In the current architecture, the caller (`handle_message` in `plugin.py`) does not catch exceptions either, so an unhandled handler error would propagate to the gateway framework.\n- **Severity**: Low. The stub handlers cannot raise exceptions (they return strings). Future handler implementations should handle their own errors. A catch-all `except Exception` in `dispatch()` could provide defense-in-depth but would also mask bugs during development.\n- **Recommendation**: Consider adding a top-level exception handler in `dispatch()` that logs the error and returns a generic \"Internal error\" message, once real handlers are implemented. During development, letting exceptions propagate is acceptable.\n\n### [Info] S4: No SQL injection risk\n\n- The dispatcher does not execute any SQL directly. DB interaction is limited to `_init_db()` which calls `get_connection()` and `migrate()` -- both use hardcoded SQL or parameterized queries. User input flows through `ParsedCommand` fields to handlers, which are responsible for using parameterized queries.\n\n### [Info] S5: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `dispatcher.py`, `plugin.py`, or their test files.\n\n### [Info] S6: `db_path` parameter is configuration-controlled\n\n- The `db_path` parameter in `dispatch()` and `handle_message()` flows from the caller (gateway framework), not from user input. In tests, it comes from `tmp_path`. There is no code path where a user's message text influences the DB path.\n\n### [Info] S7: No new dependencies introduced\n\n- The dispatcher uses only Python standard library (`sqlite3`, `logging`, `typing`) plus internal modules (`db`, `migrations`, `parser`, `schema_v1`). No new entries in `pyproject.toml`.\n\n### Security Summary\n\nNo Critical or High severity findings. Three Low findings related to input reflection, length validation, and exception propagation are noted. The dispatcher has a minimal attack surface -- it validates commands against a whitelist, delegates parsing to the parser, and routes to registered handlers. The main security consideration for future work is ensuring that handler implementations use parameterized queries and handle their own exceptions gracefully.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Refactor**: Extract `Project(id=row[0], ...)` into a `_row_to_project(row)` helper or `Project.from_row(row)` classmethod to reduce the triple duplication.\n2. **Test coverage**: Add a test for the edge case where a user has a private \"Inbox\" project and the shared \"Inbox\" also exists, verifying the private one is returned.\n3. **Transaction safety**: Consider using `SAVEPOINT` / `RELEASE` for Inbox auto-creation instead of bare `conn.commit()` to avoid committing unrelated pending changes.\n4. **Case sensitivity**: Document that project name matching is case-sensitive. Consider `COLLATE NOCASE` if case-insensitive matching is desired in a future iteration.\n5. **Input validation**: Add a max-length check for project names in the parser or validation layer to prevent unnecessarily large queries.\n1. **Exception handling**: Add a top-level `try/except` in `dispatch()` that catches unexpected handler exceptions, logs them at error level, and returns a generic user-facing error message. Defer until real handlers are implemented.\n2. **Refactor `_stub_handler`**: Align `_stub_handler` signature with `HandlerFn` type alias by deriving the command name from `parsed.command` instead of passing it as a separate argument. This also eliminates the lambda wrappers in `_get_handler` and `_dispatch_project`.\n3. **Line length**: Break the long line 115 in `_dispatch_project` for readability.\n4. **Context typing**: Introduce a `TypedDict` or dataclass for the `context` parameter (e.g., `class DispatchContext(TypedDict): sender_id: str`) to enable static type checking.\n5. **Input length guard**: Add a max-length check (e.g., 5000 chars) in `handle_message()` as defense-in-depth against oversized inputs.\n\n---\n\n# PR #16 Review Notes -- Issue #17: Permission helper module\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature-017-permissions`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n<<<<<<< HEAD\n| Task inserted with correct project_id, section, due, status='open', created_by | PASS | `test_add_default_inbox` and `test_add_with_project_section_due` verify all fields in DB |\n| Assignees default to sender when no mentions | PASS | `test_add_assignee_defaults_to_sender` verifies `task_assignees` row matches sender |\n| Multiple mentions create multiple task_assignee rows | PASS | `test_add_multiple_assignees` verifies two rows inserted and present in response |\n| Private project + non-owner assignee returns warning and does NOT insert | PASS | `test_add_private_rejects_other_assignee` verifies warning message and zero task rows |\n| Non-existent project: `Inbox` auto-created; others return error | PASS | `test_add_default_inbox` uses seeded Inbox; `test_add_nonexistent_project_returns_error` verifies error |\n| Response format: `Added #<id> (<project>/<section>) due:<due\\|-> assignees:<mentions> -- <title>` | PASS | All happy-path tests assert on this format |\n| Event row written to `events` table | PASS | `test_event_logged` verifies actor, action, task_id, and JSON payload fields |\n=======\n| `can_write_task(conn, task_id, sender_id) -> bool` exists | PASS | Function defined on line 11 of `permissions.py` with correct signature. |\n| Private project: only owner can write | PASS | Lines 34-40 check `sender_id == owner_user_id` when `visibility == \"private\"`. Tests `test_private_owner_can_write` and `test_private_non_owner_rejected` verify. |\n| Shared project: assignee or creator can write | PASS | Lines 43-60 check creator first, then query `task_assignees`. Tests `test_shared_assignee_can_write`, `test_shared_creator_can_write`, and `test_shared_unrelated_rejected` verify. |\n| Nonexistent task returns False | PASS | Lines 28-29 return `False` when row is None. Test `test_nonexistent_task` verifies. |\n| `validate_private_assignees(visibility, assignees, owner_id) -> str or None` exists | PASS | Function defined on line 63 with correct signature. |\n| Returns warning for non-owner assignees on private project | PASS | Lines 75-81. Test `test_validate_private_assignees_warning` verifies. |\n| Returns None for shared projects | PASS | Lines 72-73. Test `test_shared_always_ok` verifies. |\n| Returns None when all assignees are the owner | PASS | Lines 76-77. Test `test_private_all_owner_ok` verifies. |\n>>>>>>> origin/main\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n<<<<<<< HEAD\n| `test_add_default_inbox` | PASS |\n| `test_add_with_project_section_due` | PASS |\n| `test_add_private_rejects_other_assignee` | PASS |\n| `test_add_assignee_defaults_to_sender` | PASS |\n| `test_add_multiple_assignees` | PASS |\n\nAll 5 required tests present and passing. 5 additional tests (`test_add_private_allows_owner_assignee`, `test_event_logged`, `test_add_empty_title_returns_error`, `test_add_nonexistent_project_returns_error`, `test_add_due_clear_sentinel_stored_as_null`). 10 tests total.\n\n### Findings\n\n#### [Info] F1: No explicit transaction wrapping for multi-statement write\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-80\n- **Description**: The handler performs three sequential writes (task INSERT, assignee INSERTs, event INSERT) followed by a single `conn.commit()` at line 80. If any write after the task INSERT raises (e.g., duplicate assignee PK violation), partial writes remain uncommitted. SQLite's implicit rollback-on-close in the dispatcher's `finally` block protects data integrity.\n- **Action**: Consider wrapping in `with conn:` (context manager) for explicit transaction semantics in a future refactor. No functional bug today.\n\n#### [Info] F2: Missing `sender_id` key would raise unhandled KeyError\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 22\n- **Description**: `context[\"sender_id\"]` raises `KeyError` if the key is absent. The dispatcher contract requires `sender_id` in context, so this is defensive-coding territory.\n- **Action**: Acceptable. Could be improved with `.get()` + early return, but low priority given the documented contract.\n\n#### [Info] F3: Test gap -- non-owner sender adding to another user's private project\n\n- **File**: `tests/test_cmd_add.py`\n- **Description**: No test covers the case where sender U2 tries to add a task to a private project owned by U1. The `resolve_project()` function would return `ProjectNotFoundError` (it only matches private projects of the sender), which is correct behavior. However, there is no explicit test verifying this path through `add_handler`.\n- **Action**: Follow-up item. Add a test for \"non-owner sender cannot resolve another user's private project.\"\n\n#### [Info] F4: Title length is unbounded\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 23\n- **Description**: No max-length check on `title`. Slack messages cap at ~4000 chars, providing natural limits. The DB column is `TEXT NOT NULL` with no length constraint.\n- **Action**: Consider adding a max-length check if the handler is exposed outside Slack.\n\n#### [Info] F5: Dispatcher test correctly updated\n\n- **File**: `tests/test_dispatcher.py`, lines 34-51\n- **Description**: The parametrized stub test removed `\"add\"` from the stub-check list and added a dedicated `test_add_routes_to_handler` test that asserts `\"Added #\"` in the result. This correctly reflects that `add` is no longer a stub.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and correct:\n\n- Uses `resolve_project()` for project resolution following PRD Option A (private-first).\n- Private assignee validation correctly rejects non-owner assignees with a descriptive warning.\n- All SQL uses parameterized queries (`?` placeholders).\n- Event payload is well-structured JSON with title, project, section, due, and assignees.\n- Response format matches the PRD/UX spec exactly.\n- 10 tests with thorough assertions on both the response string and DB state.\n- No unnecessary complexity or over-engineering.\n\n**Verdict: APPROVE** -- no blocking issues. No fixes required.\n=======\n| `test_private_owner_can_write` | PASS |\n| `test_private_non_owner_rejected` | PASS |\n| `test_shared_assignee_can_write` | PASS |\n| `test_shared_creator_can_write` | PASS |\n| `test_shared_unrelated_rejected` | PASS |\n| `test_nonexistent_task` | PASS |\n| `test_validate_private_assignees_warning` | PASS |\n| `test_private_all_owner_ok` | PASS |\n| `test_shared_always_ok` | PASS |\n| `test_private_empty_assignees_ok` | PASS |\n\nAll 10 tests present and passing. 48 tests total in the suite.\n\n### Findings\n\n#### [Medium] F1: Shared project owner cannot modify tasks they did not create or get assigned to — CONFIRMED INTENTIONAL\n\n- **Description**: In a shared project, only the task creator and assignees are allowed to write. The project owner has no special privileges. User confirmed this is intentional: only task creator and assignees should have task write access.\n- **Status**: CLOSED as intentional design.\n\n#### [Low] F2: `validate_private_assignees` with `owner_id=None` marks all assignees as non-owner\n\n- **Description**: When `owner_id` is `None` on a private project (data integrity issue), all assignees would be flagged as non-owner. Function short-circuits for shared projects, so this only affects corrupted data.\n- **Status**: OPEN, non-blocking.\n\n#### [Low] F3: No test for shared project where sender is both creator and assignee — FIXED\n\n- **Description**: Added `test_shared_creator_and_assignee_can_write` in commit 594cad4. Creator short-circuit handles this correctly.\n- **Status**: FIXED.\n\n#### [Low] F4: `_create_project` helper uses complex SELECT instead of `last_insert_rowid()`\n\n- **Status**: OPEN, non-blocking.\n\n### Code Quality Summary\n\n**Verdict: APPROVE** -- no Critical or High findings. F1 confirmed intentional, F3 fixed.\n>>>>>>> origin/main\n\n---\n\n## Security Findings\n\n<<<<<<< HEAD\n### [Info] S1: SQL injection -- No risk\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-78\n- **Description**: All three SQL statements (task INSERT, assignee INSERT, event INSERT) use `?` parameter placeholders. No string interpolation or f-strings in SQL. Title, project_id, section, due, sender_id, and assignee values are all passed as parameters.\n- **Severity**: Info (no risk found)\n\n### [Info] S2: Authorization model is sound\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 41-49\n- **Description**: Private project constraint correctly checks that all assignees match the project owner. The `resolve_project()` function provides implicit access control by only resolving the sender's own private projects (scoped by `owner_user_id = sender_id` in the SQL query). A non-owner sender cannot resolve another user's private project by name. The explicit assignee check in `cmd_add.py` is an additional layer for when the owner assigns tasks to others within their private project.\n- **Severity**: Info (no bypass possible)\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in any changed files.\n\n### [Info] S4: No new dependencies introduced\n\n- `cmd_add.py` uses only standard library (`json`, `logging`, `sqlite3`) plus internal modules (`parser`, `project_resolver`). No new entries in `pyproject.toml`.\n\n### [Info] S5: Input validation adequate\n\n- Empty title returns error (line 25-26).\n- Non-existent project returns error via `ProjectNotFoundError` (lines 30-33).\n- Section validation handled by parser upstream (`VALID_SECTIONS` check).\n- Due date validation handled by parser upstream (`_normalise_due`).\n- Mention format constrained by parser regex (`<@U[A-Z0-9]+>`).\n\n### Security Summary\n\nNo Critical, High, Medium, or Low severity findings. The implementation has a minimal attack surface -- three parameterized INSERT statements, project resolution with sender-scoped authorization, and input validation at both the parser and handler layers. The code is secure for the current Slack DM context.\n\n---\n\n## Follow-up Items\n\n1. **Test coverage**: Add a test for non-owner sender attempting to add a task to another user's private project (should get `ProjectNotFoundError` via resolver).\n2. **Transaction explicitness**: Consider wrapping the three DB writes in `with conn:` for explicit transaction semantics.\n3. **Title length**: Consider adding a max-length validation (e.g., 500 chars) as defense-in-depth.\n4. **Permissions module**: When Issue #17 (permissions helper) is merged, consider extracting the inline private-assignee validation to use the shared `validate_private_assignees()` function.\n=======\nNo Critical, High, or Medium severity security findings. All SQL parameterized. Fail-closed design. Three Low findings noted for awareness.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Defensive guard**: Consider adding a log warning in `validate_private_assignees` when `visibility == \"private\"` and `owner_id is None`.\n2. **Test consistency**: Align `_create_project` helper to use `last_insert_rowid()` like `_create_task`.\n\n---\n\n## Review Pass 2\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Commit range: ff87515..594cad4\n\n### Purpose\n\nSecond review pass to verify the F3 fix (commit 594cad4) and confirm no remaining Critical/High issues.\n\n### F3 Fix Verification: `test_shared_creator_and_assignee_can_write`\n\n- **Status**: VERIFIED CORRECT\n- The test creates a shared project, a task where `U_BOTH` is the creator, assigns `U_BOTH` as an assignee, and asserts `can_write_task` returns `True`.\n- This exercises the creator short-circuit path, which returns `True` before the assignee query is reached.\n\n### Prior Findings Status\n\n| Finding | Severity | Status |\n|---------|----------|--------|\n| F1: Shared project owner has no implicit write | Medium | CLOSED -- Confirmed intentional by user. |\n| F2: `validate_private_assignees` with `owner_id=None` | Low | OPEN -- non-blocking. |\n| F3: Missing creator+assignee overlap test | Low | FIXED in 594cad4. Verified correct. |\n| F4: `_create_project` helper uses complex SELECT | Low | OPEN -- non-blocking. |\n\n### Verdict\n\n**APPROVE -- ready to merge.** All 49 tests pass. No Critical or High issues.\n>>>>>>> origin/main\n", "structuredPatch": [{"oldStart": 961, "oldLines": 15, "newStart": 961, "newLines": 6, "lines": [" ", " | Criterion | Status | Notes |", " |-----------|--------|-------|", "-<<<<<<< HEAD", "-| Task inserted with correct project_id, section, due, status='open', created_by | PASS | `test_add_default_inbox` and `test_add_with_project_section_due` verify all fields in DB |", "-| Assignees default to sender when no mentions | PASS | `test_add_assignee_defaults_to_sender` verifies `task_assignees` row matches sender |", "-| Multiple mentions create multiple task_assignee rows | PASS | `test_add_multiple_assignees` verifies two rows inserted and present in response |", "-| Private project + non-owner assignee returns warning and does NOT insert | PASS | `test_add_private_rejects_other_assignee` verifies warning message and zero task rows |", "-| Non-existent project: `Inbox` auto-created; others return error | PASS | `test_add_default_inbox` uses seeded Inbox; `test_add_nonexistent_project_returns_error` verifies error |", "-| Response format: `Added #<id> (<project>/<section>) due:<due\\|-> assignees:<mentions> -- <title>` | PASS | All happy-path tests assert on this format |", "-| Event row written to `events` table | PASS | `test_event_logged` verifies actor, action, task_id, and JSON payload fields |", "-=======", " | `can_write_task(conn, task_id, sender_id) -> bool` exists | PASS | Function defined on line 11 of `permissions.py` with correct signature. |", " | Private project: only owner can write | PASS | Lines 34-40 check `sender_id == owner_user_id` when `visibility == \"private\"`. Tests `test_private_owner_can_write` and `test_private_non_owner_rejected` verify. |", " | Shared project: assignee or creator can write | PASS | Lines 43-60 check creator first, then query `task_assignees`. Tests `test_shared_assignee_can_write`, `test_shared_creator_can_write`, and `test_shared_unrelated_rejected` verify. |"]}, {"oldStart": 978, "oldLines": 7, "newStart": 969, "newLines": 6, "lines": [" | Returns warning for non-owner assignees on private project | PASS | Lines 75-81. Test `test_validate_private_assignees_warning` verifies. |", " | Returns None for shared projects | PASS | Lines 72-73. Test `test_shared_always_ok` verifies. |", " | Returns None when all assignees are the owner | PASS | Lines 76-77. Test `test_private_all_owner_ok` verifies. |", "->>>>>>> origin/main", " ", " ### Required Tests", " "]}], "userModified": false, "replaceAll": false}, "tool_use_id": "toolu_01YL97wFwRKyfLHu9CSyFyUo", "_ts": "2026-02-20T19:30:47+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "old_string": "<<<<<<< HEAD\n| `test_add_default_inbox` | PASS |\n| `test_add_with_project_section_due` | PASS |\n| `test_add_private_rejects_other_assignee` | PASS |\n| `test_add_assignee_defaults_to_sender` | PASS |\n| `test_add_multiple_assignees` | PASS |\n\nAll 5 required tests present and passing. 5 additional tests (`test_add_private_allows_owner_assignee`, `test_event_logged`, `test_add_empty_title_returns_error`, `test_add_nonexistent_project_returns_error`, `test_add_due_clear_sentinel_stored_as_null`). 10 tests total.\n\n### Findings\n\n#### [Info] F1: No explicit transaction wrapping for multi-statement write\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-80\n- **Description**: The handler performs three sequential writes (task INSERT, assignee INSERTs, event INSERT) followed by a single `conn.commit()` at line 80. If any write after the task INSERT raises (e.g., duplicate assignee PK violation), partial writes remain uncommitted. SQLite's implicit rollback-on-close in the dispatcher's `finally` block protects data integrity.\n- **Action**: Consider wrapping in `with conn:` (context manager) for explicit transaction semantics in a future refactor. No functional bug today.\n\n#### [Info] F2: Missing `sender_id` key would raise unhandled KeyError\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 22\n- **Description**: `context[\"sender_id\"]` raises `KeyError` if the key is absent. The dispatcher contract requires `sender_id` in context, so this is defensive-coding territory.\n- **Action**: Acceptable. Could be improved with `.get()` + early return, but low priority given the documented contract.\n\n#### [Info] F3: Test gap -- non-owner sender adding to another user's private project\n\n- **File**: `tests/test_cmd_add.py`\n- **Description**: No test covers the case where sender U2 tries to add a task to a private project owned by U1. The `resolve_project()` function would return `ProjectNotFoundError` (it only matches private projects of the sender), which is correct behavior. However, there is no explicit test verifying this path through `add_handler`.\n- **Action**: Follow-up item. Add a test for \"non-owner sender cannot resolve another user's private project.\"\n\n#### [Info] F4: Title length is unbounded\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 23\n- **Description**: No max-length check on `title`. Slack messages cap at ~4000 chars, providing natural limits. The DB column is `TEXT NOT NULL` with no length constraint.\n- **Action**: Consider adding a max-length check if the handler is exposed outside Slack.\n\n#### [Info] F5: Dispatcher test correctly updated\n\n- **File**: `tests/test_dispatcher.py`, lines 34-51\n- **Description**: The parametrized stub test removed `\"add\"` from the stub-check list and added a dedicated `test_add_routes_to_handler` test that asserts `\"Added #\"` in the result. This correctly reflects that `add` is no longer a stub.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and correct:\n\n- Uses `resolve_project()` for project resolution following PRD Option A (private-first).\n- Private assignee validation correctly rejects non-owner assignees with a descriptive warning.\n- All SQL uses parameterized queries (`?` placeholders).\n- Event payload is well-structured JSON with title, project, section, due, and assignees.\n- Response format matches the PRD/UX spec exactly.\n- 10 tests with thorough assertions on both the response string and DB state.\n- No unnecessary complexity or over-engineering.\n\n**Verdict: APPROVE** -- no blocking issues. No fixes required.\n=======\n| `test_private_owner_can_write` | PASS |\n| `test_private_non_owner_rejected` | PASS |\n| `test_shared_assignee_can_write` | PASS |\n| `test_shared_creator_can_write` | PASS |\n| `test_shared_unrelated_rejected` | PASS |\n| `test_nonexistent_task` | PASS |\n| `test_validate_private_assignees_warning` | PASS |\n| `test_private_all_owner_ok` | PASS |\n| `test_shared_always_ok` | PASS |\n| `test_private_empty_assignees_ok` | PASS |\n\nAll 10 tests present and passing. 48 tests total in the suite.\n\n### Findings\n\n#### [Medium] F1: Shared project owner cannot modify tasks they did not create or get assigned to — CONFIRMED INTENTIONAL\n\n- **Description**: In a shared project, only the task creator and assignees are allowed to write. The project owner has no special privileges. User confirmed this is intentional: only task creator and assignees should have task write access.\n- **Status**: CLOSED as intentional design.\n\n#### [Low] F2: `validate_private_assignees` with `owner_id=None` marks all assignees as non-owner\n\n- **Description**: When `owner_id` is `None` on a private project (data integrity issue), all assignees would be flagged as non-owner. Function short-circuits for shared projects, so this only affects corrupted data.\n- **Status**: OPEN, non-blocking.\n\n#### [Low] F3: No test for shared project where sender is both creator and assignee — FIXED\n\n- **Description**: Added `test_shared_creator_and_assignee_can_write` in commit 594cad4. Creator short-circuit handles this correctly.\n- **Status**: FIXED.\n\n#### [Low] F4: `_create_project` helper uses complex SELECT instead of `last_insert_rowid()`\n\n- **Status**: OPEN, non-blocking.\n\n### Code Quality Summary\n\n**Verdict: APPROVE** -- no Critical or High findings. F1 confirmed intentional, F3 fixed.\n>>>>>>> origin/main", "new_string": "| `test_private_owner_can_write` | PASS |\n| `test_private_non_owner_rejected` | PASS |\n| `test_shared_assignee_can_write` | PASS |\n| `test_shared_creator_can_write` | PASS |\n| `test_shared_unrelated_rejected` | PASS |\n| `test_nonexistent_task` | PASS |\n| `test_validate_private_assignees_warning` | PASS |\n| `test_private_all_owner_ok` | PASS |\n| `test_shared_always_ok` | PASS |\n| `test_private_empty_assignees_ok` | PASS |\n\nAll 10 tests present and passing. 48 tests total in the suite.\n\n### Findings\n\n#### [Medium] F1: Shared project owner cannot modify tasks they did not create or get assigned to — CONFIRMED INTENTIONAL\n\n- **Description**: In a shared project, only the task creator and assignees are allowed to write. The project owner has no special privileges. User confirmed this is intentional: only task creator and assignees should have task write access.\n- **Status**: CLOSED as intentional design.\n\n#### [Low] F2: `validate_private_assignees` with `owner_id=None` marks all assignees as non-owner\n\n- **Description**: When `owner_id` is `None` on a private project (data integrity issue), all assignees would be flagged as non-owner. Function short-circuits for shared projects, so this only affects corrupted data.\n- **Status**: OPEN, non-blocking.\n\n#### [Low] F3: No test for shared project where sender is both creator and assignee — FIXED\n\n- **Description**: Added `test_shared_creator_and_assignee_can_write` in commit 594cad4. Creator short-circuit handles this correctly.\n- **Status**: FIXED.\n\n#### [Low] F4: `_create_project` helper uses complex SELECT instead of `last_insert_rowid()`\n\n- **Status**: OPEN, non-blocking.\n\n### Code Quality Summary\n\n**Verdict: APPROVE** -- no Critical or High findings. F1 confirmed intentional, F3 fixed.", "replace_all": false}, "tool_use_id": "toolu_01BscBHwMYeSMBqAcVYJZwVF", "_ts": "2026-02-20T19:31:14+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "old_string": "<<<<<<< HEAD\n| `test_add_default_inbox` | PASS |\n| `test_add_with_project_section_due` | PASS |\n| `test_add_private_rejects_other_assignee` | PASS |\n| `test_add_assignee_defaults_to_sender` | PASS |\n| `test_add_multiple_assignees` | PASS |\n\nAll 5 required tests present and passing. 5 additional tests (`test_add_private_allows_owner_assignee`, `test_event_logged`, `test_add_empty_title_returns_error`, `test_add_nonexistent_project_returns_error`, `test_add_due_clear_sentinel_stored_as_null`). 10 tests total.\n\n### Findings\n\n#### [Info] F1: No explicit transaction wrapping for multi-statement write\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-80\n- **Description**: The handler performs three sequential writes (task INSERT, assignee INSERTs, event INSERT) followed by a single `conn.commit()` at line 80. If any write after the task INSERT raises (e.g., duplicate assignee PK violation), partial writes remain uncommitted. SQLite's implicit rollback-on-close in the dispatcher's `finally` block protects data integrity.\n- **Action**: Consider wrapping in `with conn:` (context manager) for explicit transaction semantics in a future refactor. No functional bug today.\n\n#### [Info] F2: Missing `sender_id` key would raise unhandled KeyError\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 22\n- **Description**: `context[\"sender_id\"]` raises `KeyError` if the key is absent. The dispatcher contract requires `sender_id` in context, so this is defensive-coding territory.\n- **Action**: Acceptable. Could be improved with `.get()` + early return, but low priority given the documented contract.\n\n#### [Info] F3: Test gap -- non-owner sender adding to another user's private project\n\n- **File**: `tests/test_cmd_add.py`\n- **Description**: No test covers the case where sender U2 tries to add a task to a private project owned by U1. The `resolve_project()` function would return `ProjectNotFoundError` (it only matches private projects of the sender), which is correct behavior. However, there is no explicit test verifying this path through `add_handler`.\n- **Action**: Follow-up item. Add a test for \"non-owner sender cannot resolve another user's private project.\"\n\n#### [Info] F4: Title length is unbounded\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 23\n- **Description**: No max-length check on `title`. Slack messages cap at ~4000 chars, providing natural limits. The DB column is `TEXT NOT NULL` with no length constraint.\n- **Action**: Consider adding a max-length check if the handler is exposed outside Slack.\n\n#### [Info] F5: Dispatcher test correctly updated\n\n- **File**: `tests/test_dispatcher.py`, lines 34-51\n- **Description**: The parametrized stub test removed `\"add\"` from the stub-check list and added a dedicated `test_add_routes_to_handler` test that asserts `\"Added #\"` in the result. This correctly reflects that `add` is no longer a stub.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and correct:\n\n- Uses `resolve_project()` for project resolution following PRD Option A (private-first).\n- Private assignee validation correctly rejects non-owner assignees with a descriptive warning.\n- All SQL uses parameterized queries (`?` placeholders).\n- Event payload is well-structured JSON with title, project, section, due, and assignees.\n- Response format matches the PRD/UX spec exactly.\n- 10 tests with thorough assertions on both the response string and DB state.\n- No unnecessary complexity or over-engineering.\n\n**Verdict: APPROVE** -- no blocking issues. No fixes required.\n=======\n| `test_private_owner_can_write` | PASS |\n| `test_private_non_owner_rejected` | PASS |\n| `test_shared_assignee_can_write` | PASS |\n| `test_shared_creator_can_write` | PASS |\n| `test_shared_unrelated_rejected` | PASS |\n| `test_nonexistent_task` | PASS |\n| `test_validate_private_assignees_warning` | PASS |\n| `test_private_all_owner_ok` | PASS |\n| `test_shared_always_ok` | PASS |\n| `test_private_empty_assignees_ok` | PASS |\n\nAll 10 tests present and passing. 48 tests total in the suite.\n\n### Findings\n\n#### [Medium] F1: Shared project owner cannot modify tasks they did not create or get assigned to — CONFIRMED INTENTIONAL\n\n- **Description**: In a shared project, only the task creator and assignees are allowed to write. The project owner has no special privileges. User confirmed this is intentional: only task creator and assignees should have task write access.\n- **Status**: CLOSED as intentional design.\n\n#### [Low] F2: `validate_private_assignees` with `owner_id=None` marks all assignees as non-owner\n\n- **Description**: When `owner_id` is `None` on a private project (data integrity issue), all assignees would be flagged as non-owner. Function short-circuits for shared projects, so this only affects corrupted data.\n- **Status**: OPEN, non-blocking.\n\n#### [Low] F3: No test for shared project where sender is both creator and assignee — FIXED\n\n- **Description**: Added `test_shared_creator_and_assignee_can_write` in commit 594cad4. Creator short-circuit handles this correctly.\n- **Status**: FIXED.\n\n#### [Low] F4: `_create_project` helper uses complex SELECT instead of `last_insert_rowid()`\n\n- **Status**: OPEN, non-blocking.\n\n### Code Quality Summary\n\n**Verdict: APPROVE** -- no Critical or High findings. F1 confirmed intentional, F3 fixed.\n>>>>>>> origin/main", "new_string": "| `test_private_owner_can_write` | PASS |\n| `test_private_non_owner_rejected` | PASS |\n| `test_shared_assignee_can_write` | PASS |\n| `test_shared_creator_can_write` | PASS |\n| `test_shared_unrelated_rejected` | PASS |\n| `test_nonexistent_task` | PASS |\n| `test_validate_private_assignees_warning` | PASS |\n| `test_private_all_owner_ok` | PASS |\n| `test_shared_always_ok` | PASS |\n| `test_private_empty_assignees_ok` | PASS |\n\nAll 10 tests present and passing. 48 tests total in the suite.\n\n### Findings\n\n#### [Medium] F1: Shared project owner cannot modify tasks they did not create or get assigned to — CONFIRMED INTENTIONAL\n\n- **Description**: In a shared project, only the task creator and assignees are allowed to write. The project owner has no special privileges. User confirmed this is intentional: only task creator and assignees should have task write access.\n- **Status**: CLOSED as intentional design.\n\n#### [Low] F2: `validate_private_assignees` with `owner_id=None` marks all assignees as non-owner\n\n- **Description**: When `owner_id` is `None` on a private project (data integrity issue), all assignees would be flagged as non-owner. Function short-circuits for shared projects, so this only affects corrupted data.\n- **Status**: OPEN, non-blocking.\n\n#### [Low] F3: No test for shared project where sender is both creator and assignee — FIXED\n\n- **Description**: Added `test_shared_creator_and_assignee_can_write` in commit 594cad4. Creator short-circuit handles this correctly.\n- **Status**: FIXED.\n\n#### [Low] F4: `_create_project` helper uses complex SELECT instead of `last_insert_rowid()`\n\n- **Status**: OPEN, non-blocking.\n\n### Code Quality Summary\n\n**Verdict: APPROVE** -- no Critical or High findings. F1 confirmed intentional, F3 fixed.", "replace_all": false}, "tool_response": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "oldString": "<<<<<<< HEAD\n| `test_add_default_inbox` | PASS |\n| `test_add_with_project_section_due` | PASS |\n| `test_add_private_rejects_other_assignee` | PASS |\n| `test_add_assignee_defaults_to_sender` | PASS |\n| `test_add_multiple_assignees` | PASS |\n\nAll 5 required tests present and passing. 5 additional tests (`test_add_private_allows_owner_assignee`, `test_event_logged`, `test_add_empty_title_returns_error`, `test_add_nonexistent_project_returns_error`, `test_add_due_clear_sentinel_stored_as_null`). 10 tests total.\n\n### Findings\n\n#### [Info] F1: No explicit transaction wrapping for multi-statement write\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-80\n- **Description**: The handler performs three sequential writes (task INSERT, assignee INSERTs, event INSERT) followed by a single `conn.commit()` at line 80. If any write after the task INSERT raises (e.g., duplicate assignee PK violation), partial writes remain uncommitted. SQLite's implicit rollback-on-close in the dispatcher's `finally` block protects data integrity.\n- **Action**: Consider wrapping in `with conn:` (context manager) for explicit transaction semantics in a future refactor. No functional bug today.\n\n#### [Info] F2: Missing `sender_id` key would raise unhandled KeyError\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 22\n- **Description**: `context[\"sender_id\"]` raises `KeyError` if the key is absent. The dispatcher contract requires `sender_id` in context, so this is defensive-coding territory.\n- **Action**: Acceptable. Could be improved with `.get()` + early return, but low priority given the documented contract.\n\n#### [Info] F3: Test gap -- non-owner sender adding to another user's private project\n\n- **File**: `tests/test_cmd_add.py`\n- **Description**: No test covers the case where sender U2 tries to add a task to a private project owned by U1. The `resolve_project()` function would return `ProjectNotFoundError` (it only matches private projects of the sender), which is correct behavior. However, there is no explicit test verifying this path through `add_handler`.\n- **Action**: Follow-up item. Add a test for \"non-owner sender cannot resolve another user's private project.\"\n\n#### [Info] F4: Title length is unbounded\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 23\n- **Description**: No max-length check on `title`. Slack messages cap at ~4000 chars, providing natural limits. The DB column is `TEXT NOT NULL` with no length constraint.\n- **Action**: Consider adding a max-length check if the handler is exposed outside Slack.\n\n#### [Info] F5: Dispatcher test correctly updated\n\n- **File**: `tests/test_dispatcher.py`, lines 34-51\n- **Description**: The parametrized stub test removed `\"add\"` from the stub-check list and added a dedicated `test_add_routes_to_handler` test that asserts `\"Added #\"` in the result. This correctly reflects that `add` is no longer a stub.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and correct:\n\n- Uses `resolve_project()` for project resolution following PRD Option A (private-first).\n- Private assignee validation correctly rejects non-owner assignees with a descriptive warning.\n- All SQL uses parameterized queries (`?` placeholders).\n- Event payload is well-structured JSON with title, project, section, due, and assignees.\n- Response format matches the PRD/UX spec exactly.\n- 10 tests with thorough assertions on both the response string and DB state.\n- No unnecessary complexity or over-engineering.\n\n**Verdict: APPROVE** -- no blocking issues. No fixes required.\n=======\n| `test_private_owner_can_write` | PASS |\n| `test_private_non_owner_rejected` | PASS |\n| `test_shared_assignee_can_write` | PASS |\n| `test_shared_creator_can_write` | PASS |\n| `test_shared_unrelated_rejected` | PASS |\n| `test_nonexistent_task` | PASS |\n| `test_validate_private_assignees_warning` | PASS |\n| `test_private_all_owner_ok` | PASS |\n| `test_shared_always_ok` | PASS |\n| `test_private_empty_assignees_ok` | PASS |\n\nAll 10 tests present and passing. 48 tests total in the suite.\n\n### Findings\n\n#### [Medium] F1: Shared project owner cannot modify tasks they did not create or get assigned to — CONFIRMED INTENTIONAL\n\n- **Description**: In a shared project, only the task creator and assignees are allowed to write. The project owner has no special privileges. User confirmed this is intentional: only task creator and assignees should have task write access.\n- **Status**: CLOSED as intentional design.\n\n#### [Low] F2: `validate_private_assignees` with `owner_id=None` marks all assignees as non-owner\n\n- **Description**: When `owner_id` is `None` on a private project (data integrity issue), all assignees would be flagged as non-owner. Function short-circuits for shared projects, so this only affects corrupted data.\n- **Status**: OPEN, non-blocking.\n\n#### [Low] F3: No test for shared project where sender is both creator and assignee — FIXED\n\n- **Description**: Added `test_shared_creator_and_assignee_can_write` in commit 594cad4. Creator short-circuit handles this correctly.\n- **Status**: FIXED.\n\n#### [Low] F4: `_create_project` helper uses complex SELECT instead of `last_insert_rowid()`\n\n- **Status**: OPEN, non-blocking.\n\n### Code Quality Summary\n\n**Verdict: APPROVE** -- no Critical or High findings. F1 confirmed intentional, F3 fixed.\n>>>>>>> origin/main", "newString": "| `test_private_owner_can_write` | PASS |\n| `test_private_non_owner_rejected` | PASS |\n| `test_shared_assignee_can_write` | PASS |\n| `test_shared_creator_can_write` | PASS |\n| `test_shared_unrelated_rejected` | PASS |\n| `test_nonexistent_task` | PASS |\n| `test_validate_private_assignees_warning` | PASS |\n| `test_private_all_owner_ok` | PASS |\n| `test_shared_always_ok` | PASS |\n| `test_private_empty_assignees_ok` | PASS |\n\nAll 10 tests present and passing. 48 tests total in the suite.\n\n### Findings\n\n#### [Medium] F1: Shared project owner cannot modify tasks they did not create or get assigned to — CONFIRMED INTENTIONAL\n\n- **Description**: In a shared project, only the task creator and assignees are allowed to write. The project owner has no special privileges. User confirmed this is intentional: only task creator and assignees should have task write access.\n- **Status**: CLOSED as intentional design.\n\n#### [Low] F2: `validate_private_assignees` with `owner_id=None` marks all assignees as non-owner\n\n- **Description**: When `owner_id` is `None` on a private project (data integrity issue), all assignees would be flagged as non-owner. Function short-circuits for shared projects, so this only affects corrupted data.\n- **Status**: OPEN, non-blocking.\n\n#### [Low] F3: No test for shared project where sender is both creator and assignee — FIXED\n\n- **Description**: Added `test_shared_creator_and_assignee_can_write` in commit 594cad4. Creator short-circuit handles this correctly.\n- **Status**: FIXED.\n\n#### [Low] F4: `_create_project` helper uses complex SELECT instead of `last_insert_rowid()`\n\n- **Status**: OPEN, non-blocking.\n\n### Code Quality Summary\n\n**Verdict: APPROVE** -- no Critical or High findings. F1 confirmed intentional, F3 fixed.", "originalFile": "# PR #2 Review Notes -- Issue #1: Plugin skeleton and entry point\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/001-plugin-skeleton`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `pyproject.toml` with Python >=3.11, pytest, pytest-cov dev deps | PASS | Correct. Uses `dependency-groups` (PEP 735) with hatchling backend. |\n| `src/openclaw_todo/__init__.py` exposes `__version__` | PASS | `__version__ = \"0.1.0\"` |\n| `handle_message(text: str, context: dict) -> str` entry point | PASS (minor note) | Return type is `str | None`, not `str`. The AC literally says `-> str` but `None` for ignored messages is the intended behavior per the next AC. Acceptable. |\n| Non-`/todo` messages silently ignored (returns `None`) | PASS | |\n| `uv sync && uv run pytest -q` passes | PASS | 4 tests, 100% coverage |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_ignores_non_todo_message` | PASS -- covers empty string, random text, `/todox` prefix-collision |\n| `test_dispatches_todo_prefix` | PASS -- verifies non-None response with subcommand text |\n\n### Findings\n\n#### [Info] Return type annotation mismatch with AC\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 12\n- The AC states `-> str` but the implementation is `-> str | None`. This is correct behavior (returning `None` for non-todo messages is explicitly required). The AC text is slightly imprecise; the code is right.\n- **Action**: None needed. Consider updating the AC wording if desired.\n\n#### [Info] `context` parameter unused\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 12\n- `context: dict` is accepted but never read in this skeleton. This is expected for M0 -- it will be used once the dispatcher (Issue #16) and DB commands are wired in.\n- **Action**: None. This is intentional scaffolding.\n\n#### [Info] Placeholder response includes raw user input\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 32\n- `f\"TODO command received: {remainder}\"` echoes back unescaped user input. This is a temporary placeholder (comment says \"will be replaced by dispatcher in Issue #16\"). In the current context (no HTML/web rendering, Slack DM only), this is not exploitable, but see Security Findings below.\n- **Action**: Track as part of Issue #16.\n\n#### [Info] Extra tests beyond AC requirements -- good\n\n- `test_todo_prefix_with_whitespace` and `test_todo_without_subcommand` are bonus tests covering whitespace handling and bare `/todo` usage message. Good coverage instinct.\n\n#### [Info] Version duplication\n\n- Version `0.1.0` appears in both `pyproject.toml` and `__init__.py`. Consider using `importlib.metadata` or dynamic versioning in a future issue to keep a single source of truth. Not a concern for M0.\n\n#### [Low] No type hints for `context` dict\n\n- `context: dict` is untyped (could be `dict[str, Any]` or a TypedDict). For M0 this is fine, but a `TypedDict` or dataclass should be introduced when the context shape solidifies.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and well-structured for a skeleton:\n\n- Prefix matching logic (`stripped == _TODO_PREFIX or stripped.startswith(_TODO_PREFIX + \" \")`) correctly avoids false positives on `/todox`.\n- Logging at appropriate levels (debug for all messages, info for matches).\n- Usage help returned for bare `/todo` is a nice touch.\n- Test coverage is 100%.\n\n**Verdict: APPROVE** -- no blocking issues.\n\n---\n\n## Security Findings\n\n### [Low] S1: User input echoed in placeholder response\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 32\n- **Description**: The placeholder `f\"TODO command received: {remainder}\"` reflects user-supplied text without sanitization. In the current Slack DM context, Slack handles rendering and this is not exploitable for XSS. However, once a web dashboard or logging UI is introduced, unsanitized echo could become a reflected XSS vector.\n- **Severity**: Low (Slack auto-escapes; placeholder will be replaced in Issue #16)\n- **Recommendation**: When building the real dispatcher, ensure any user text echoed in responses is sanitized if it ever reaches a web context. No fix needed now.\n\n### [Low] S2: No input length validation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 12\n- **Description**: `handle_message` accepts arbitrarily long strings. A malicious or buggy client could send extremely large messages. Slack itself limits messages to ~40,000 characters, so this is mitigated at the transport layer.\n- **Severity**: Low\n- **Recommendation**: Consider adding a max-length guard in the dispatcher (Issue #16) if the plugin is ever exposed outside Slack.\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in any reviewed files. Environment variable approach is correctly deferred to future DB/config work.\n\n### [Info] S4: Dependencies are minimal and current\n\n- Only dev dependencies: `pytest>=7.0` and `pytest-cov>=4.0`. No known CVEs for these versions. No runtime dependencies beyond the standard library.\n- Build backend `hatchling` is a well-maintained, standard tool.\n\n### [Info] S5: No SQL, no deserialization, no file I/O\n\n- The M0 skeleton has no database, no file operations, and no deserialization. The attack surface is effectively zero at this stage.\n\n### Security Summary\n\nNo Critical or High severity findings. The codebase has a minimal attack surface appropriate for a plugin skeleton. Security considerations will become relevant starting with Issue #2 (DB connection) and Issue #5 (parser with user-controlled input).\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Issue #16 (Dispatcher)**: When replacing the placeholder response, ensure user input is not echoed raw if the output context changes (e.g., web UI).\n2. **Future**: Introduce a `TypedDict` or dataclass for the `context` parameter to enforce shape and enable static analysis.\n3. **Future**: Consolidate version to a single source (e.g., `importlib.metadata.version(\"openclaw-todo-plugin\")`).\n\n---\n\n# PR #4 Review Notes -- Issue #2: DB module -- connection helper and pragma setup\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/002-db-connection`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| Directory is created recursively when absent | PASS | `db_dir.mkdir(parents=True, exist_ok=True)` on line 32. Test `test_creates_directory_and_file` verifies nested `nested/dir/` creation. |\n| SQLite connection returned with WAL mode enabled | PASS | `PRAGMA journal_mode=WAL` on line 36. Test verifies `fetchone()[0] == \"wal\"`. |\n| `busy_timeout` is 3000 | PASS | `PRAGMA busy_timeout=3000` on line 37. Test verifies `fetchone()[0] == 3000`. |\n| Calling `get_connection` twice returns usable connections (no lock conflict) | PASS | `test_two_connections_no_conflict` creates a table via conn1, reads via conn2. WAL mode enables this concurrency. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `tests/test_db.py::test_creates_directory_and_file` | PASS -- verifies both `db_path.exists()` and `db_path.parent.exists()` with nested `tmp_path` |\n| `tests/test_db.py::test_wal_mode_enabled` | PASS -- queries `PRAGMA journal_mode` and asserts `\"wal\"` |\n| `tests/test_db.py::test_busy_timeout` | PASS -- queries `PRAGMA busy_timeout` and asserts `3000` |\n\n### Findings\n\n#### [Info] TOCTOU in `is_new` logging check\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 29\n- `is_new = not db_path.exists()` is checked before `sqlite3.connect()`, which itself creates the file. In a concurrent scenario, the file could appear between the check and the connect. This only affects which log message is emitted (info vs. debug) and has no functional impact.\n- **Action**: None required. Purely cosmetic race condition.\n\n#### [Info] PRAGMA return values not checked\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, lines 36-37\n- `conn.execute(\"PRAGMA journal_mode=WAL;\")` returns a result set with the actual journal mode applied. On some edge cases (e.g., read-only filesystem, in-memory DB), WAL activation can silently fall back to another mode. The code does not verify the return.\n- **Action**: Low priority. Consider adding a debug-level assertion or log warning in a future hardening pass. The test suite already validates WAL is active in the happy path.\n\n#### [Info] Default path uses `Path.home()`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 11\n- `DEFAULT_DB_DIR = Path.home() / \".openclaw\" / \"workspace\" / \".todo\"` is evaluated at module import time. If `HOME` is unset (e.g., certain containerized environments), `Path.home()` raises `RuntimeError`. This is acceptable since: (a) the default is only used when `db_path is None`, and (b) the plugin is designed for environments where `HOME` is set. Callers in containers should pass an explicit path.\n- **Action**: None for M1. Document the `db_path` parameter as the recommended override for non-standard environments.\n\n#### [Info] Extra test beyond AC requirements -- good\n\n- `test_two_connections_no_conflict` is a bonus test that exercises concurrent WAL access. This directly validates the 4th acceptance criterion and is well-structured with proper cleanup in a `finally` block.\n\n#### [Low] Test cleanup uses `try/finally` instead of a fixture\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_db.py`, all tests\n- Each test manually opens a connection and closes it in `try/finally`. A pytest fixture (e.g., `@pytest.fixture` yielding the connection) would reduce boilerplate and guarantee cleanup even if assertion lines are added later. This is a minor style observation for 4 tests.\n- **Action**: Optional refactor. Not blocking.\n\n#### [Info] Coverage at 96%\n\n- Line 24 (`db_path = DEFAULT_DB_DIR / DEFAULT_DB_NAME`) is uncovered because all tests pass explicit `tmp_path` paths. This is correct -- testing the default path would write to the user's actual home directory. The uncovered line is trivial assignment logic.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and correct:\n\n- Function signature `get_connection(db_path: str | Path | None = None)` is flexible, accepting string, Path, or None.\n- `Path(db_path)` normalization on line 26 handles string inputs.\n- `exist_ok=True` on `mkdir` prevents race conditions with concurrent directory creation.\n- Logging at appropriate levels: `info` for creation, `debug` for opens.\n- No unnecessary dependencies -- uses only stdlib `sqlite3`, `pathlib`, and `logging`.\n- 96% test coverage with all acceptance criteria verified.\n\n**Verdict: APPROVE** -- no blocking issues.\n\n---\n\n## Security Findings\n\n### [Low] S1: `db_path` parameter accepts arbitrary filesystem paths\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 15\n- **Description**: `get_connection(db_path)` will create directories and an SQLite database at any filesystem path the process has write access to. If a future caller passes unsanitized user input as `db_path`, this could be used for arbitrary file creation (e.g., path traversal via `../../etc/cron.d/evil`).\n- **Severity**: Low (currently an internal API; no user-facing code path passes user input to `db_path`)\n- **Recommendation**: When wiring `db_path` into the dispatcher (Issue #16), ensure the path comes only from configuration (env var or config file), never from user-controlled message text. Consider adding a validation that `db_path` is within an expected base directory.\n\n### [Info] S2: No SQL injection risk\n\n- PRAGMA statements on lines 36-37 use hardcoded string literals with no interpolation. The `db_path` is passed to `sqlite3.connect()` as a filesystem path, not as a SQL query. No injection surface exists.\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `db.py` or `test_db.py`. The module uses only stdlib.\n\n### [Info] S4: No new dependencies introduced\n\n- This module uses only Python standard library (`sqlite3`, `pathlib`, `logging`). No new entries in `pyproject.toml` dependencies. Zero additional attack surface from third-party code.\n\n### [Info] S5: SQLite WAL mode is a security-positive choice\n\n- WAL mode improves concurrent access safety and reduces the risk of database corruption from concurrent writes. The `busy_timeout=3000` prevents immediate lock failures, which could otherwise cause data loss if a caller does not handle `sqlite3.OperationalError` properly.\n\n### Security Summary\n\nNo Critical or High severity findings. The attack surface is minimal -- a single function that creates a local SQLite database with hardcoded pragmas. The only surface to monitor is ensuring `db_path` remains configuration-controlled as the codebase grows.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Issue #3 (Migration framework)**: When implementing migrations, ensure SQL statements use parameterized queries (not string formatting) for any dynamic values. The migration runner should validate migration callables are from a trusted registry.\n2. **Future**: Add a pytest fixture for `get_connection` that yields and auto-closes, reducing `try/finally` boilerplate across DB-related test files.\n3. **Future**: Consider adding a `validate_db_path(path)` helper that constrains paths to an allowed base directory, for defense-in-depth when the dispatcher wires in configuration.\n\n---\n\n# PR #6 Review Notes -- Issue #3: Schema migration framework and schema_version table\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/003-schema-migration`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `schema_version` table created with single row `version=0` if absent | PASS | `_ensure_version_table` uses `CREATE TABLE IF NOT EXISTS` and inserts `version=0` only when no row exists (line 30-31). |\n| Migrations are Python callables registered in an ordered list | PASS | `_migrations: list[MigrationFn]` with `@register` decorator appending to the list. Index maps directly to migration version. |\n| Each migration runs inside a transaction; version incremented on success | PASS | `conn.commit()` after each successful migration (line 65). SQLite's implicit transaction wraps the migration + version update. |\n| Re-running on an up-to-date DB is a no-op | PASS | `current >= target` guard on line 52 returns immediately. Test `test_idempotent_on_rerun` verifies. |\n| Failing migration rolls back and raises with clear message | PASS | `conn.rollback()` in `except` block (line 67). `RuntimeError` with formatted message including version number and original exception (line 68-70). |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_fresh_db_gets_version_table` | PASS -- verifies `get_version` returns 0 and `schema_version` table exists in `sqlite_master` |\n| `test_applies_migrations_sequentially` | PASS -- registers two migrations, asserts final version is 2, verifies both tables created |\n| `test_idempotent_on_rerun` | PASS -- calls `migrate` twice, both return 1, no errors |\n| `test_rollback_on_failure` | PASS -- first migration commits (version 1, `t_ok` exists), second raises `ValueError`, caught as `RuntimeError`, version stays at 1 |\n\n### Findings\n\n#### [Medium] No constraint preventing multiple rows in `schema_version`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- The `schema_version` table is created with `(version INTEGER NOT NULL)` but has no PRIMARY KEY, UNIQUE constraint, or CHECK constraint limiting it to a single row. If a bug or manual intervention inserts a second row, `get_version` would return whichever row SQLite returns first from `SELECT version FROM schema_version` (non-deterministic without ORDER BY).\n- **Action**: Consider adding a single-row constraint in a future migration (e.g., `CHECK (rowid = 1)` or a dummy `id INTEGER PRIMARY KEY CHECK (id = 1)` column). Not blocking for M1 since all writes go through `_ensure_version_table` which correctly checks before inserting.\n\n#### [Low] Redundant `_ensure_version_table` calls\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, lines 48-49\n- `migrate()` calls `_ensure_version_table(conn)` on line 48, then calls `get_version(conn)` on line 49, which internally calls `_ensure_version_table` again. This results in two `CREATE TABLE IF NOT EXISTS` and two `SELECT version` queries on every `migrate` call.\n- **Action**: Minor performance concern. Could be refactored so `migrate` calls `_ensure_version_table` once and reads the version directly. Not blocking.\n\n#### [Info] Global mutable state for migrations registry\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 15\n- `_migrations` is a module-level mutable list. This is a common pattern for migration registries and works well for single-process applications. The test suite correctly saves/restores it via the `_clean_migrations` autouse fixture (lines 16-23 in test file).\n- **Action**: None. This is an appropriate pattern for this use case. If multi-process or plugin-based architectures are introduced later, consider a class-based registry.\n\n#### [Info] Test fixture properly isolates migration state\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_migrations.py`, lines 16-23\n- The `_clean_migrations` fixture saves the original list, clears it before each test, and restores it after. This prevents test pollution and is correctly marked `autouse=True`. The save-clear-yield-clear-extend pattern is the correct idiom.\n\n#### [Info] `conn` fixture uses `get_connection` from `db` module\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_migrations.py`, lines 27-31\n- The test fixture uses `get_connection` (from Issue #2) rather than raw `sqlite3.connect`. This ensures WAL mode and `busy_timeout` pragmas are applied, matching production behavior. This is a good integration practice.\n\n#### [Info] Coverage at 100%\n\n- All 41 statements in `migrations.py` are covered by the 4 tests. No untested branches.\n\n#### [Info] Error message includes original exception\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, lines 68-70\n- `raise RuntimeError(...) from exc` preserves the exception chain, making debugging easier. The message format `\"Migration to version {N} failed: {exc}\"` clearly identifies which migration failed. This follows the acceptance criterion for \"clear message.\"\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and minimal:\n\n- The `@register` decorator pattern is intuitive for defining migrations in order.\n- Transaction semantics are correctly handled: commit on success, rollback on failure.\n- The version update uses a parameterized query (`?` placeholder on line 63), avoiding SQL injection.\n- Logging at appropriate levels: `info` for migration steps and completion, `debug` for up-to-date status.\n- The code correctly handles the edge case where `current > target` (e.g., if migrations are removed), treating it the same as up-to-date.\n- 100% test coverage with all four required tests present and passing.\n\n**Verdict: APPROVE** -- no blocking issues. One medium finding (missing single-row constraint) noted for follow-up.\n\n---\n\n## Security Findings\n\n### [Medium] S1: `schema_version` table lacks row-count constraint\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- **Description**: The `schema_version` table has no mechanism to enforce that exactly one row exists. While the application code only writes through `_ensure_version_table` (which checks before inserting) and `migrate` (which uses `UPDATE`), a direct SQL injection in a future module or manual DB editing could insert additional rows, causing `get_version` to return an unpredictable value. This could lead to migrations being skipped or re-applied.\n- **Severity**: Medium (requires either a separate SQL injection vulnerability or direct DB access to exploit; impact is schema corruption)\n- **Recommendation**: In the V1 schema migration (Issue #4), alter or recreate the table with a single-row constraint, e.g., `CREATE TABLE schema_version (id INTEGER PRIMARY KEY CHECK (id = 1), version INTEGER NOT NULL)`.\n\n### [Info] S2: No SQL injection risk in migration runner\n\n- All SQL in `migrations.py` uses either hardcoded string literals or parameterized queries (`?` on line 63 for the version update). The `MigrationFn` type receives a `Connection` object, and it is the responsibility of each registered migration to use parameterized queries. This is correctly documented in the PR #4 review follow-up.\n\n### [Info] S3: Migration functions are trusted code\n\n- The `@register` decorator appends arbitrary callables to the migration list. Since migrations are defined at module import time by the application developer (not by user input), there is no injection risk. The registry is not exposed to any user-facing API.\n\n### [Info] S4: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `migrations.py` or `test_migrations.py`.\n\n### [Info] S5: No new dependencies introduced\n\n- This module uses only Python standard library (`sqlite3`, `logging`, `typing`). No new entries in `pyproject.toml` dependencies.\n\n### [Info] S6: Exception message does not leak sensitive data\n\n- The `RuntimeError` message on line 69 includes the migration version number and the string representation of the original exception. In this context (local SQLite, no user-supplied data in migration functions), this does not leak sensitive information. If migrations ever process user data, the exception wrapping should be reviewed to avoid leaking PII in logs.\n\n### Security Summary\n\nNo Critical or High severity findings. One Medium finding regarding the missing single-row constraint on `schema_version`, which could lead to schema version confusion if combined with a separate vulnerability that allows arbitrary SQL execution. The recommendation is to address this in the Issue #4 V1 schema migration.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Issue #4 (V1 schema)**: Add a single-row constraint to `schema_version` (e.g., `CHECK (id = 1)` on a primary key column) as part of the V1 migration to prevent version-table corruption.\n2. **Future**: Refactor `migrate()` to avoid redundant `_ensure_version_table` calls for minor performance improvement.\n3. **Future**: Consider adding a `--dry-run` mode to the migration runner that reports which migrations would be applied without executing them, useful for deployment verification.\n\n---\n\n# PR #8 Review Notes -- Issue #4: V1 schema migration -- projects, tasks, task_assignees, events\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/004-v1-schema`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `projects` table with `ux_projects_shared_name` and `ux_projects_private_owner_name` partial unique indexes | PASS | Table created on lines 18-26, indexes on lines 28-36 of `schema_v1.py`. Partial `WHERE` clauses match PRD exactly. |\n| `tasks` table with section and status CHECK constraints | PASS | Section CHECK on line 43 (`backlog, doing, waiting, done, drop`), status CHECK on line 45 (`open, done, dropped`). Both match PRD spec. |\n| `task_assignees` table with composite PK and secondary index | PASS | Composite `PRIMARY KEY (task_id, assignee_user_id)` on line 57, secondary index `ix_task_assignees_user` on lines 61-64. |\n| `events` audit table created | PASS | Table on lines 66-75. Columns match PRD. |\n| Shared `Inbox` project auto-created (INSERT OR IGNORE) | PASS | Line 78-81 uses `INSERT OR IGNORE` with `('Inbox', 'shared', NULL)`. |\n| `schema_version` = 1 after migration | PASS | Test `test_v1_schema_version` verifies `get_version(conn) == 1`. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_v1_tables_exist` | PASS -- verifies all four tables exist in `sqlite_master` |\n| `test_v1_inbox_created` | PASS -- verifies name='Inbox', visibility='shared', owner_user_id=None |\n| `test_v1_shared_unique_index_enforced` | PASS -- duplicate shared name raises `IntegrityError` |\n| `test_v1_private_unique_index_enforced` | PASS -- duplicate (owner, name) raises `IntegrityError`; different owner succeeds |\n\n### Findings\n\n#### [High] F1: Foreign keys not enforced -- `PRAGMA foreign_keys=ON` missing\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 35-37\n- **Description**: SQLite does not enforce `REFERENCES` (foreign key) clauses by default. The `PRAGMA foreign_keys=ON` must be executed on every new connection for FK constraints to be active. Without this, the `REFERENCES projects(id)` on `tasks.project_id` and `REFERENCES tasks(id)` on `task_assignees.task_id` are purely decorative -- you can insert tasks pointing to non-existent projects and assignees pointing to non-existent tasks.\n- **Impact**: Referential integrity is silently not enforced, leading to orphaned rows and data corruption.\n- **Fix applied**: Added `conn.execute(\"PRAGMA foreign_keys=ON;\")` to `get_connection()` in `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 38. All 19 tests pass after the fix.\n\n#### [Medium] F2: `schema_version` single-row constraint not added in V1\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- **Description**: The PR #6 review (Medium finding S1) recommended adding a single-row constraint to `schema_version` as part of the V1 migration. This was not addressed. The table still has no PK or CHECK constraint to prevent multiple rows.\n- **Action**: Should be addressed in a follow-up issue. Adding it retroactively in a later migration (e.g., V2) would require recreating the table since SQLite does not support `ALTER TABLE ADD CONSTRAINT`.\n\n#### [Low] F3: Minor PRD deviation on `events.ts` -- NOT NULL DEFAULT added\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/schema_v1.py`, line 69\n- **Description**: The PRD spec for `events.ts` says `ts TEXT` with no nullability or default constraint. The implementation adds `NOT NULL DEFAULT (datetime('now'))`. This is a sensible enhancement (audit timestamps should always be present), but it is a deviation from the spec.\n- **Action**: None needed. The implementation is better than the spec. Consider updating the PRD to match.\n\n#### [Low] F4: `events.id` uses AUTOINCREMENT, PRD says PK only\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/schema_v1.py`, line 68\n- **Description**: PRD says `id INTEGER PK` for the events table. The implementation uses `INTEGER PRIMARY KEY AUTOINCREMENT`. AUTOINCREMENT prevents rowid reuse after deletion, which is actually preferable for an audit log (guarantees monotonically increasing IDs). This is a minor deviation but a positive one.\n- **Action**: None needed. Consider updating the PRD.\n\n#### [Low] F5: No test for `task_assignees` composite PK enforcement\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_schema_v1.py`\n- **Description**: The acceptance criteria mention `task_assignees` table with composite PK, but there is no test verifying that inserting a duplicate `(task_id, assignee_user_id)` pair raises `IntegrityError`. The composite PK is created, but its enforcement is untested.\n- **Action**: Add a test in a follow-up to insert a duplicate pair and assert `IntegrityError`.\n\n#### [Low] F6: No test for foreign key enforcement\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_schema_v1.py`\n- **Description**: No test verifies that inserting a task with a non-existent `project_id` raises an error, or that inserting a `task_assignee` with a non-existent `task_id` raises an error. With the FK pragma fix (F1), these would now fail correctly, but there is no test coverage for this behavior.\n- **Action**: Add FK enforcement tests in a follow-up.\n\n#### [Info] F7: Test fixture pattern is well-structured\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_schema_v1.py`, lines 11-25\n- The `_load_v1_migration` autouse fixture correctly saves, clears, imports, and restores the migration registry. The `conn` fixture properly creates a temp DB, migrates, yields, and closes. This is clean test isolation.\n\n#### [Info] F8: CHECK constraint tests are thorough\n\n- Tests `test_v1_section_check_constraint` and `test_v1_status_check_constraint` go beyond the required tests to verify that invalid enum values are rejected. Good defensive testing.\n\n#### [Info] F9: 8 tests total for V1 schema, all passing\n\n- `test_v1_tables_exist`, `test_v1_schema_version`, `test_v1_inbox_created`, `test_v1_shared_unique_index_enforced`, `test_v1_private_unique_index_enforced`, `test_v1_section_check_constraint`, `test_v1_status_check_constraint` (7 tests in `test_schema_v1.py`). Plus the rollback test verifies `conn.rollback()` is correctly called after each constraint violation test.\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and closely follows the PRD spec:\n\n- All four tables are created with the correct columns, types, and constraints.\n- Partial unique indexes use the correct `WHERE` clause syntax.\n- CHECK constraints enumerate exactly the values specified in the PRD.\n- `INSERT OR IGNORE` for the Inbox seed is idempotent.\n- Parameterized queries are not needed here (all DDL uses string literals with no interpolation).\n- The `@register` decorator integrates seamlessly with the migration framework from Issue #3.\n- Test coverage is good, with 7 tests covering table existence, version, seed data, unique indexes, and CHECK constraints.\n\n**Verdict: APPROVE with one fix applied** -- the `PRAGMA foreign_keys=ON` fix (High, F1) has been applied directly. Medium/Low findings are noted for follow-up.\n\n---\n\n## Security Findings\n\n### [High] S1: Foreign key constraints not enforced (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 35-37\n- **Description**: Without `PRAGMA foreign_keys=ON`, all `REFERENCES` clauses in the V1 schema are ignored. This means a future command handler could insert tasks referencing non-existent projects or assignees referencing non-existent tasks, leading to data integrity violations that are silent and hard to debug. In a multi-user Slack plugin, this could allow one user's actions to create orphaned records that cause errors for other users.\n- **Severity**: High (data integrity violation in a multi-user context; silent failure mode)\n- **Fix**: Added `conn.execute(\"PRAGMA foreign_keys=ON;\")` to `get_connection()`. All 19 tests pass.\n\n### [Medium] S2: `schema_version` table remains unprotected against multi-row corruption\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- **Description**: Carried forward from PR #6 review. The `schema_version` table has no constraint preventing insertion of additional rows. If a separate vulnerability allows arbitrary SQL execution, an attacker could manipulate the schema version to skip or re-run migrations.\n- **Severity**: Medium (requires a chained vulnerability to exploit)\n- **Recommendation**: Address in a future migration that recreates the table with a single-row constraint.\n\n### [Info] S3: No SQL injection risk in V1 migration\n\n- All SQL in `schema_v1.py` uses hardcoded string literals. No user input, no string interpolation, no parameterized queries needed. The `INSERT OR IGNORE` for the Inbox seed uses literal values only.\n\n### [Info] S4: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `schema_v1.py` or `test_schema_v1.py`.\n\n### [Info] S5: No new dependencies introduced\n\n- The V1 migration uses only Python standard library (`sqlite3`, `logging`). No new entries in `pyproject.toml`.\n\n### [Info] S6: CHECK constraints provide defense-in-depth\n\n- The `section` and `status` CHECK constraints on the `tasks` table prevent invalid enum values at the database level, not just the application level. This is a security-positive pattern that prevents data corruption even if the application layer has a bug.\n\n### Security Summary\n\nOne High severity finding (S1: missing `PRAGMA foreign_keys=ON`) was identified and fixed directly in `db.py`. One Medium finding (S2: `schema_version` single-row constraint) is carried forward from the previous review. No Critical findings.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Test coverage**: Add tests for `task_assignees` composite PK enforcement (duplicate pair should raise `IntegrityError`).\n2. **Test coverage**: Add tests for foreign key enforcement (task with non-existent `project_id`, assignee with non-existent `task_id` should raise `IntegrityError` now that FK pragma is enabled).\n3. **Schema version constraint**: Address the `schema_version` single-row constraint in a future migration (V2 or later) by recreating the table with `CHECK (id = 1)`.\n4. **PRD sync**: Update PRD section 6.3 to add `NOT NULL DEFAULT (datetime('now'))` to `events.ts` and `AUTOINCREMENT` to `events.id` to match the implementation.\n5. **DB module**: Add a test for `PRAGMA foreign_keys` returning `1` in `test_db.py` to prevent regression.\n\n---\n\n# PR #10 Review Notes -- Issue #5: Command parser -- tokenizer and option extraction\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/005-parser-tokenizer`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `/p MyProject` correctly extracted; token consumed | PASS | `test_extract_project` verifies project name extracted, `/p` and value removed from `title_tokens`. |\n| `/s doing` validated; invalid section raises `ParseError` | PASS | `test_extract_section_valid` and `test_extract_section_invalid` cover both paths. Case-insensitive via `.lower()`. |\n| `due:03-15` normalised to `2026-03-15` (current year) | PASS | `test_due_mm_dd_normalisation` verifies with `date.today().year`. |\n| `due:2026-02-30` raises `ParseError` (invalid date) | PASS | `test_due_invalid_date` asserts `ParseError` with match on \"Invalid due date\". |\n| `<@U12345>` extracted into mentions list | PASS | `test_mentions_extraction` verifies two mentions extracted and not in `title_tokens`. |\n| Multiple mentions supported | PASS | Same test covers two mentions in order. |\n| Title tokens are non-option, non-mention tokens before first option | PASS | `test_title_extraction` verifies correct split with mixed options. Note: title tokens are collected from *all* positions, not just \"before first option\" -- this is arguably more flexible than the AC wording. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_extract_project` | PASS |\n| `test_extract_section_valid` | PASS |\n| `test_extract_section_invalid` | PASS |\n| `test_due_mm_dd_normalisation` | PASS |\n| `test_due_full_date` | PASS |\n| `test_due_invalid_date` | PASS |\n| `test_due_clear` | PASS |\n| `test_mentions_extraction` | PASS |\n| `test_title_extraction` | PASS |\n\nAll 9 required tests present and passing. 4 additional bonus tests (`test_command_extraction`, `test_move_extracts_id_as_arg`, `test_empty_command_raises`, `test_section_case_insensitive`). 13 parser tests total.\n\n### Findings\n\n#### [Medium] F1: Leap-year bug in `_normalise_due` for MM-DD format (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 53-62 (after fix)\n- **Description**: The original implementation used `datetime.strptime(raw, \"%m-%d\")` which defaults to year 1900 (not a leap year). This caused `due:02-29` to always be rejected, even when the current year is a leap year (e.g., 2028). The `replace(year=current_year)` call was never reached because `strptime` itself raised `ValueError`.\n- **Fix applied**: Replaced `strptime(\"%m-%d\")` with a regex match `(\\d{1,2})-(\\d{1,2})` followed by direct `date(current_year, month, day)` construction. This correctly validates Feb 29 against the actual current year.\n- **Impact**: Without fix, `due:02-29` would fail in leap years (2028, 2032, etc.) when it should succeed.\n\n#### [Low] F2: Duplicate options silently use \"last wins\" semantics\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 91-117\n- **Description**: If a user provides `/p First /p Second`, the parser silently uses `Second`. Same for `/s` and `due:`. This is not necessarily wrong, but it is undocumented. \"Last wins\" is a reasonable default, but \"first wins\" or \"raise error on duplicate\" are also valid choices.\n- **Action**: Document the \"last wins\" behavior in the docstring or PRD. No code change needed.\n\n#### [Low] F3: `/p` and `/s` error paths (missing argument) are untested\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_parser.py`\n- **Description**: Lines 93 and 101 (`raise ParseError(\"/p requires a project name\")` and `/s` equivalent) are uncovered. Manual testing confirmed they work correctly, but automated test coverage is missing for these edge cases.\n- **Action**: Add tests for `parse(\"add task /p\")` and `parse(\"add task /s\")` in a follow-up.\n\n#### [Low] F4: `_DUE_RE` uses `.+` which accepts any characters after `due:`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, line 15\n- **Description**: `_DUE_RE = re.compile(r\"^due:(.+)$\")` will match `due:anything` and pass the value to `_normalise_due`. This is not a bug since `_normalise_due` properly validates the value, but a tighter regex like `r\"^due:([\\d-]+)$\"` would reject obviously invalid inputs earlier and serve as documentation of expected format.\n- **Action**: Optional tightening. Not blocking since validation is correct.\n\n#### [Low] F5: Title tokens are collected from all positions, not just \"before first option\"\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 126-128\n- **Description**: The AC says \"Title tokens are non-option, non-mention tokens before first option.\" The implementation collects title tokens from all positions (e.g., `add Buy /p Home milk` would produce `title_tokens=[\"Buy\", \"milk\"]`). This is actually more flexible and user-friendly, but deviates from the literal AC wording.\n- **Action**: Consider updating the AC to match the implementation. The current behavior is better for UX.\n\n#### [Info] F6: `args` extraction for `move/done/drop/edit` is well-designed\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 130-133\n- The pattern of extracting the first title token as `args[0]` for ID-based commands is clean and tested by `test_move_extracts_id_as_arg`.\n\n#### [Info] F7: Coverage at 97%\n\n- Lines 93 and 101 (error paths for missing `/p` and `/s` arguments) are uncovered. All other branches are tested. This is acceptable for M1.\n\n#### [Info] F8: Bonus tests add good defensive coverage\n\n- `test_section_case_insensitive` ensures `/s DOING` normalizes to `doing`.\n- `test_command_extraction` verifies the first token becomes the command.\n- `test_empty_command_raises` covers the empty input guard.\n- `test_move_extracts_id_as_arg` covers the args extraction logic.\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and well-structured:\n\n- The tokenizer loop with explicit index management (`while i < len(remaining)`) is readable and handles two-token options (`/p`, `/s`) cleanly by advancing `i` by 2.\n- `ParsedCommand` dataclass provides a clear, typed result structure.\n- `VALID_SECTIONS` as a `frozenset` is the right choice for O(1) membership testing.\n- `_MENTION_RE` uses `fullmatch` (not `match` or `search`), preventing partial matches on tokens like `<@U123>extra`.\n- Error messages are descriptive and include the invalid value with `repr()` formatting.\n- Logging at debug level for parsed results is appropriate.\n- 97% test coverage with all 9 required tests present and 4 bonus tests.\n\n**Verdict: APPROVE with one fix applied** -- the leap-year bug in `_normalise_due` (Medium, F1) has been fixed directly. Low findings are noted for follow-up.\n\n---\n\n## Security Findings\n\n### [Medium] S1: Leap-year date validation bypass (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, `_normalise_due`\n- **Description**: The original `strptime(\"%m-%d\")` approach silently rejected valid dates (`02-29` in leap years) due to the 1900 default year. While this is a correctness issue rather than a security vulnerability, incorrect date validation can lead to denial of service (users unable to set valid due dates) and data integrity issues (dates that should be accepted are rejected).\n- **Severity**: Medium (correctness bug with functional impact)\n- **Fix**: Replaced with regex-based month/day extraction and direct `date()` construction with the current year.\n\n### [Low] S2: No ReDoS risk in compiled regexes\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 14-15\n- **Description**: Both `_MENTION_RE = re.compile(r\"<@(U[A-Z0-9]+)>\")` and `_DUE_RE = re.compile(r\"^due:(.+)$\")` were tested with 100,000-character inputs and completed in under 0.1ms. Neither pattern contains nested quantifiers or alternation that could cause catastrophic backtracking.\n- **Severity**: Low (no risk found, noting for completeness)\n\n### [Low] S3: No input length validation on parser input\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, line 72\n- **Description**: `parse(text)` accepts arbitrarily long strings. `text.strip().split()` will allocate a token list proportional to input size. Slack limits messages to ~40,000 characters, mitigating this at the transport layer, but if the parser is used outside Slack, extremely long inputs could cause memory pressure.\n- **Severity**: Low (mitigated by Slack transport layer limits)\n- **Recommendation**: Consider adding a max-length guard in the plugin entry point (`handle_message`) rather than the parser itself.\n\n### [Info] S4: No injection risks\n\n- The parser only tokenizes and validates strings. No SQL, no shell commands, no template rendering. User input flows into `ParsedCommand` fields which are plain strings. Security depends on how these values are consumed downstream (e.g., parameterized queries when writing to SQLite).\n\n### [Info] S5: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `parser.py` or `test_parser.py`.\n\n### [Info] S6: No new dependencies introduced\n\n- The parser uses only Python standard library (`re`, `datetime`, `dataclasses`, `logging`). No new entries in `pyproject.toml`.\n\n### Security Summary\n\nNo Critical or High severity findings. One Medium finding (S1: leap-year date validation) was identified and fixed. The parser has a minimal attack surface -- it tokenizes strings and validates against known patterns. The main security consideration going forward is ensuring that `ParsedCommand` field values are used safely downstream (parameterized SQL queries, no raw echo in web contexts).\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Test coverage**: Add tests for `/p` and `/s` without arguments (lines 93, 101) to cover the missing-argument error paths.\n2. **Documentation**: Document \"last wins\" semantics for duplicate `/p`, `/s`, and `due:` options in the PRD or parser docstring.\n3. **Optional**: Tighten `_DUE_RE` from `.+` to `[\\d-]+` for earlier rejection of obviously invalid due values.\n4. **AC clarification**: Update Issue #5 AC to reflect that title tokens are collected from all positions (not just \"before first option\"), matching the implemented behavior.\n\n---\n\n# PR #12 Review Notes -- Issue #7: Project resolver helper\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/007-project-resolver`\n# PR #14 Review Notes -- Issue #16: Command dispatcher and routing\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature-016-dispatcher`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| Private project of sender matched first | PASS | Query on line 38-42 filters by `visibility = 'private' AND owner_user_id = ?`. Test `test_private_takes_priority` verifies. |\n| Falls back to shared if no private match | PASS | Second query on line 52-56 filters by `visibility = 'shared'`. Test `test_falls_back_to_shared` verifies. |\n| Returns error when neither exists (except Inbox auto-created) | PASS | `ProjectNotFoundError` raised on line 84. Inbox auto-created on lines 66-81. Tests `test_unknown_project_error` and `test_inbox_auto_created` verify. |\n| Returns project row with id, name, visibility, owner_user_id | PASS | `Project` dataclass on lines 17-23 with all four fields. All tests assert on these fields. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_private_takes_priority` | PASS -- creates both shared and private \"Work\", verifies private is returned for owner U1 |\n| `test_falls_back_to_shared` | PASS -- creates shared \"Team\" only, verifies shared returned for U1 |\n| `test_inbox_auto_created` | PASS -- deletes seeded Inbox, verifies auto-creation as shared with null owner |\n| `test_unknown_project_error` | PASS -- verifies `ProjectNotFoundError` raised with descriptive message |\n\nAll 4 required tests present and passing. 2 additional bonus tests (`test_inbox_already_exists`, `test_private_different_owner_not_matched`). 6 tests total.\n\n### Findings\n\n#### [Low] F1: Project name matching is case-sensitive\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 39-42\n- **Description**: The SQL queries use `WHERE name = ?` which is case-sensitive in SQLite by default (for ASCII). If a user types `/p work` but the project is named `Work`, it will not match. The PRD does not specify case-sensitivity behavior, so this is not a bug per se, but it could cause user confusion.\n- **Action**: Document the case-sensitive behavior. Consider adding `COLLATE NOCASE` in a future iteration if case-insensitive matching is desired.\n\n#### [Low] F2: Repeated `Project(id=row[0], ...)` construction pattern\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 44, 58, 76\n- **Description**: The same `Project(id=row[0], name=row[1], visibility=row[2], owner_user_id=row[3])` pattern appears three times. This could be extracted to a helper (e.g., `Project._from_row(row)` classmethod or a module-level `_row_to_project` function) to reduce duplication and ensure consistency if columns change.\n- **Action**: Optional refactor. Not blocking for M1.\n\n#### [Low] F3: `conn.commit()` called inside resolver for Inbox auto-creation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, line 71\n- **Description**: The resolver calls `conn.commit()` directly after the `INSERT OR IGNORE` for Inbox auto-creation. This commits any pending transaction state on the connection, which could be surprising if the caller has uncommitted changes. In the current codebase this is not an issue (resolver is called early in command handling), but it couples the resolver to transaction management.\n- **Action**: Consider whether the caller should be responsible for committing. For M1 this is acceptable since the auto-creation is a one-time idempotent operation.\n\n#### [Low] F4: No test for Inbox auto-creation when a private Inbox exists\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/tests/test_project_resolver.py`\n- **Description**: If a user has a private project named \"Inbox\", `resolve_project(conn, \"Inbox\", user_id)` will return the private project (step 1 matches). The auto-creation path (step 3) is only reached if neither private nor shared \"Inbox\" exists. This behavior is correct per the resolution order, but there is no test covering the scenario where a user has a private \"Inbox\" and the shared \"Inbox\" also exists -- the test should verify that the private one is returned.\n- **Action**: Add a test for this edge case in a follow-up.\n\n#### [Info] F5: `INSERT OR IGNORE` is the correct pattern for Inbox auto-creation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 67-70\n- `INSERT OR IGNORE` handles the race condition where two concurrent requests try to auto-create Inbox simultaneously. The `ux_projects_shared_name` unique index on `(name) WHERE visibility = 'shared'` ensures only one shared Inbox can exist. The subsequent `SELECT` on lines 72-75 guarantees we return the correct row regardless of whether this request or another one performed the insert. This is well-designed.\n\n#### [Info] F6: Bonus tests add good defensive coverage\n\n- `test_inbox_already_exists` verifies that the seeded Inbox (from V1 migration) resolves without triggering auto-creation.\n- `test_private_different_owner_not_matched` verifies that a private project owned by U2 is not visible to U1, correctly raising `ProjectNotFoundError`.\n\n#### [Info] F7: Coverage at 100%\n\n- All 31 statements in `project_resolver.py` are covered by the 6 tests. No untested branches.\n\n#### [Info] F8: Test fixture pattern is consistent with prior PRs\n\n- The `_load_v1` autouse fixture and `conn` fixture follow the same save-clear-restore pattern established in prior PRs. Good consistency.\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and follows the PRD resolution order exactly:\n\n- Three-step resolution (private -> shared -> Inbox auto-create) with clear fallthrough logic.\n- All SQL queries use parameterized placeholders (`?`), preventing SQL injection.\n- `Project` dataclass provides a typed result with the four required fields.\n- `ProjectNotFoundError` is a well-named custom exception with descriptive message.\n- Logging at debug level for each resolution path aids troubleshooting.\n- `INSERT OR IGNORE` handles concurrent Inbox auto-creation safely.\n- 100% test coverage with all 4 required tests and 2 valuable bonus tests.\n- The code is 85 lines total -- minimal and readable.\n\n**Verdict: APPROVE** -- no Critical or High findings. All Low findings are noted for follow-up.\n### Changed Files\n\n| File | Change | Lines |\n|------|--------|-------|\n| `src/openclaw_todo/dispatcher.py` | NEW | 116 |\n| `src/openclaw_todo/plugin.py` | MODIFIED | 33 |\n| `tests/test_dispatcher.py` | NEW | 152 |\n| `tests/test_plugin.py` | MODIFIED | 39 |\n\n### Architecture Overview\n\nThe dispatcher implements a two-level routing architecture:\n\n1. **Plugin layer** (`plugin.py`): Strips `/todo` prefix, returns USAGE for bare `/todo`, delegates remainder to `dispatch()`.\n2. **Dispatcher layer** (`dispatcher.py`): Parses the remainder via the parser, validates command name against `_VALID_COMMANDS`, opens a DB connection with migration, routes to the appropriate handler (or stub), and closes the connection in a `finally` block.\n3. **Project sub-routing**: `project` command delegates to `_dispatch_project()` which extracts the subcommand from `parsed.title_tokens` and routes to `project_<subcommand>` handlers in the registry.\n\n### Findings\n\n#### [Low] F1: Weak test assertion on stub handler (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/tests/test_dispatcher.py`, line 48\n- **Description**: The original assertion was:\n  ```python\n  assert \"not yet implemented\" in result.lower() or isinstance(result, str)\n  ```\n  The `isinstance(result, str)` clause makes this trivially true since `dispatch()` always returns `str`. The test does not actually verify that the stub handler was invoked -- any string return would pass.\n- **Fix applied**: Removed the `or isinstance(result, str)` fallback. The assertion now strictly verifies that the stub handler message is present:\n  ```python\n  assert \"not yet implemented\" in result.lower()\n  ```\n- **Impact**: Test now correctly fails if the stub handler message format changes or if a different code path is taken.\n\n#### [Low] F2: `_stub_handler` signature differs from `HandlerFn` type alias\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 17, 47\n- **Description**: The `HandlerFn` type alias is `Callable[[ParsedCommand, Connection, dict], str]` (3 args), but `_stub_handler` takes 4 args: `(command, parsed, conn, context)`. This works because `_stub_handler` is never registered directly in `_handlers` -- it is always called via a lambda wrapper in `_get_handler` (line 59) and `_dispatch_project` (line 115) that captures `command` via closure. However, the mismatch makes the code harder to follow at a glance.\n- **Action**: Consider refactoring `_stub_handler` to accept `(parsed, conn, context)` and derive the command name from `parsed.command`. Not blocking since the current approach is correct.\n\n#### [Low] F3: Long line in `_dispatch_project`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 115\n- **Description**: Line 115 is 116 characters, exceeding typical line length limits (88 for black, 100 for many projects). The lambda + `_handlers.get` + `_stub_handler` call is dense.\n- **Action**: Consider breaking into multiple lines for readability. Not blocking.\n\n#### [Low] F4: Global mutable `_handlers` dict shared across tests\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 54\n- **Description**: The `_handlers` dict is module-level mutable state. The test fixture `_clean_handlers` (test file line 22-28) correctly saves and restores it between tests. However, if the test suite were run in parallel (e.g., `pytest-xdist`), the shared state could cause flaky tests.\n- **Action**: For a single-process Slack plugin this is fine. Document the limitation if parallel test execution is ever introduced.\n\n#### [Info] F5: DB connection lifecycle is correct\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 86-94\n- The `dispatch()` function opens the DB connection *after* validating the command name (line 80-82 returns early for unknown commands without touching the DB). The connection is always closed in a `finally` block (line 94), ensuring no leaks even if handlers raise exceptions. This is good resource management.\n\n#### [Info] F6: Unknown commands do not open a DB connection\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 80-82\n- The `if command not in _VALID_COMMANDS` check returns before `_init_db()` is called. This avoids unnecessary DB initialization for typos and invalid commands. Good design.\n\n#### [Info] F7: Parse errors are caught and returned as user-facing messages\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 73-76\n- `ParseError` is caught and formatted as `f\"Parse error: {exc}\"`. The parser's error messages are descriptive (e.g., \"Invalid section: 'xyz'\") and do not leak internal details. This is appropriate for a Slack DM context.\n\n#### [Info] F8: Plugin entry-point correctly wired to dispatcher\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/plugin.py`\n- The `handle_message()` function now delegates to `dispatch()` instead of the previous placeholder response. The prefix matching logic is unchanged and still correct. The `db_path` parameter flows through to `dispatch()` for testability.\n\n#### [Info] F9: Schema import triggers migration registration\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 14\n- `import openclaw_todo.schema_v1 as _schema_v1` with `# noqa: F401` ensures the `@register` decorator in `schema_v1.py` runs at import time, populating the migration registry before any `migrate()` call. This is the correct pattern for the decorator-based migration system.\n\n#### [Info] F10: Test coverage is comprehensive\n\n- 20 dispatcher + plugin tests covering:\n  - All 7 non-project commands routed to stubs (parametrized)\n  - Custom handler registration and invocation\n  - All 3 project subcommands routed correctly\n  - Project with no subcommand returns usage\n  - Unknown project subcommand returns error\n  - Unknown top-level command returns error with usage\n  - Parse error propagation\n  - DB initialization with schema migration\n  - Plugin prefix matching (non-todo, todo, whitespace, bare /todo)\n\n### Code Quality Summary\n\nThe dispatcher implementation is clean, well-structured, and follows good design principles:\n\n- **Separation of concerns**: Plugin handles prefix matching; dispatcher handles parsing, validation, DB init, and routing. Each has a single responsibility.\n- **Resource safety**: DB connection opened late (only for valid commands) and closed in `finally`.\n- **Extensibility**: The `register_handler()` function provides a clean API for future command implementations to plug in without modifying the dispatcher.\n- **Defensive routing**: Unknown commands and parse errors return helpful user-facing messages without touching the DB or raising unhandled exceptions.\n- **Project sub-routing**: The `project_<subcommand>` naming convention with `replace('-', '_')` is a clean pattern for hyphenated subcommands.\n- **Test isolation**: The `_clean_handlers` autouse fixture properly saves and restores the handler registry between tests.\n\n**Verdict: APPROVE with one fix applied** -- the weak test assertion (Low, F1) has been strengthened. No Critical or High code quality issues found.\n\n---\n\n## Security Findings\n\n### [Low] S1: No SQL injection risk -- parameterized queries used throughout\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 38-42, 52-56\n- **Description**: All SQL queries use `?` parameter placeholders for user-supplied values (`name` and `sender_id`). The Inbox auto-creation on lines 67-75 uses hardcoded string literals only. No string interpolation or f-strings are used in any SQL statement.\n- **Severity**: Low (no risk found, noting for completeness)\n\n### [Low] S2: `name` parameter is not length-validated\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, line 27\n- **Description**: `resolve_project(conn, name, sender_id)` accepts arbitrarily long `name` strings. While SQLite handles this safely (TEXT has no inherent length limit), an extremely long name would result in unnecessary query execution against the database. The parser upstream (Issue #5) extracts project names from `/p <name>` tokens, and Slack limits message length to ~40,000 characters, providing transport-layer mitigation.\n- **Severity**: Low (mitigated by upstream constraints)\n- **Recommendation**: Consider adding a max-length check for project names in the parser or a future validation layer.\n\n### [Low] S3: Inbox auto-creation commits transaction implicitly\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, line 71\n- **Description**: `conn.commit()` inside the resolver commits all pending changes on the connection, not just the Inbox insert. If a future caller has uncommitted writes before calling `resolve_project`, those writes would be committed as a side effect. This is not exploitable but could lead to partial commits in error scenarios.\n- **Severity**: Low (no current exploit path; architectural concern)\n- **Recommendation**: Consider using a savepoint pattern (`SAVEPOINT` / `RELEASE`) for the Inbox auto-creation to isolate its transaction from any outer transaction.\n\n### [Info] S4: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `project_resolver.py` or `test_project_resolver.py`.\n\n### [Info] S5: No new dependencies introduced\n\n- The module uses only Python standard library (`sqlite3`, `dataclasses`, `logging`). No new entries in `pyproject.toml`.\n\n### [Info] S6: Authorization model is correctly scoped\n\n- The `sender_id` parameter is used correctly in the private-project query to scope visibility. User U1 cannot resolve another user's private projects. Test `test_private_different_owner_not_matched` explicitly verifies this isolation. The shared-project query correctly omits owner filtering, as shared projects are visible to all users.\n\n### Security Summary\n\nNo Critical, High, or Medium severity findings. The implementation has a minimal attack surface -- three read queries and one idempotent insert, all using parameterized queries. The authorization model (private scoped to sender, shared visible to all) is correctly implemented and tested. Three Low findings are noted for awareness but require no immediate action.\n### [Low] S1: User input reflected in error messages\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 76, 82, 110\n- **Description**: Three error paths echo user-supplied values back in responses:\n  - `f\"Parse error: {exc}\"` (line 76) -- parser error messages may contain raw user input\n  - `f\"Unknown command: '{command}'\\n{USAGE}\"` (line 82) -- the command name is user input\n  - `f\"Unknown project subcommand: '{sub}'\\n{PROJECT_USAGE}\"` (line 110) -- the subcommand is user input\n- **Severity**: Low. In the Slack DM context, Slack handles message escaping. The reflected values are single tokens (no spaces, limited characters after `split()` tokenization). No HTML/JS injection is possible in this context.\n- **Recommendation**: If the plugin ever serves responses in a web context (e.g., dashboard, webhook response viewer), sanitize reflected values. No fix needed for current Slack-only usage.\n\n### [Low] S2: No input length validation at dispatcher level\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 67\n- **Description**: `dispatch(text, ...)` accepts arbitrarily long strings, which flow to `parse()` for tokenization. Slack limits messages to approximately 40,000 characters, providing transport-layer mitigation.\n- **Severity**: Low (mitigated by Slack transport layer)\n- **Recommendation**: Consider adding a max-length guard in `handle_message()` if the plugin is ever exposed outside Slack.\n\n### [Low] S3: Handler exception propagation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 91-92\n- **Description**: If a registered handler raises an unhandled exception, it propagates up through `dispatch()`. The `finally` block ensures the DB connection is closed, but the exception itself is not caught. In the current architecture, the caller (`handle_message` in `plugin.py`) does not catch exceptions either, so an unhandled handler error would propagate to the gateway framework.\n- **Severity**: Low. The stub handlers cannot raise exceptions (they return strings). Future handler implementations should handle their own errors. A catch-all `except Exception` in `dispatch()` could provide defense-in-depth but would also mask bugs during development.\n- **Recommendation**: Consider adding a top-level exception handler in `dispatch()` that logs the error and returns a generic \"Internal error\" message, once real handlers are implemented. During development, letting exceptions propagate is acceptable.\n\n### [Info] S4: No SQL injection risk\n\n- The dispatcher does not execute any SQL directly. DB interaction is limited to `_init_db()` which calls `get_connection()` and `migrate()` -- both use hardcoded SQL or parameterized queries. User input flows through `ParsedCommand` fields to handlers, which are responsible for using parameterized queries.\n\n### [Info] S5: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `dispatcher.py`, `plugin.py`, or their test files.\n\n### [Info] S6: `db_path` parameter is configuration-controlled\n\n- The `db_path` parameter in `dispatch()` and `handle_message()` flows from the caller (gateway framework), not from user input. In tests, it comes from `tmp_path`. There is no code path where a user's message text influences the DB path.\n\n### [Info] S7: No new dependencies introduced\n\n- The dispatcher uses only Python standard library (`sqlite3`, `logging`, `typing`) plus internal modules (`db`, `migrations`, `parser`, `schema_v1`). No new entries in `pyproject.toml`.\n\n### Security Summary\n\nNo Critical or High severity findings. Three Low findings related to input reflection, length validation, and exception propagation are noted. The dispatcher has a minimal attack surface -- it validates commands against a whitelist, delegates parsing to the parser, and routes to registered handlers. The main security consideration for future work is ensuring that handler implementations use parameterized queries and handle their own exceptions gracefully.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Refactor**: Extract `Project(id=row[0], ...)` into a `_row_to_project(row)` helper or `Project.from_row(row)` classmethod to reduce the triple duplication.\n2. **Test coverage**: Add a test for the edge case where a user has a private \"Inbox\" project and the shared \"Inbox\" also exists, verifying the private one is returned.\n3. **Transaction safety**: Consider using `SAVEPOINT` / `RELEASE` for Inbox auto-creation instead of bare `conn.commit()` to avoid committing unrelated pending changes.\n4. **Case sensitivity**: Document that project name matching is case-sensitive. Consider `COLLATE NOCASE` if case-insensitive matching is desired in a future iteration.\n5. **Input validation**: Add a max-length check for project names in the parser or validation layer to prevent unnecessarily large queries.\n1. **Exception handling**: Add a top-level `try/except` in `dispatch()` that catches unexpected handler exceptions, logs them at error level, and returns a generic user-facing error message. Defer until real handlers are implemented.\n2. **Refactor `_stub_handler`**: Align `_stub_handler` signature with `HandlerFn` type alias by deriving the command name from `parsed.command` instead of passing it as a separate argument. This also eliminates the lambda wrappers in `_get_handler` and `_dispatch_project`.\n3. **Line length**: Break the long line 115 in `_dispatch_project` for readability.\n4. **Context typing**: Introduce a `TypedDict` or dataclass for the `context` parameter (e.g., `class DispatchContext(TypedDict): sender_id: str`) to enable static type checking.\n5. **Input length guard**: Add a max-length check (e.g., 5000 chars) in `handle_message()` as defense-in-depth against oversized inputs.\n\n---\n\n# PR #16 Review Notes -- Issue #17: Permission helper module\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature-017-permissions`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `can_write_task(conn, task_id, sender_id) -> bool` exists | PASS | Function defined on line 11 of `permissions.py` with correct signature. |\n| Private project: only owner can write | PASS | Lines 34-40 check `sender_id == owner_user_id` when `visibility == \"private\"`. Tests `test_private_owner_can_write` and `test_private_non_owner_rejected` verify. |\n| Shared project: assignee or creator can write | PASS | Lines 43-60 check creator first, then query `task_assignees`. Tests `test_shared_assignee_can_write`, `test_shared_creator_can_write`, and `test_shared_unrelated_rejected` verify. |\n| Nonexistent task returns False | PASS | Lines 28-29 return `False` when row is None. Test `test_nonexistent_task` verifies. |\n| `validate_private_assignees(visibility, assignees, owner_id) -> str or None` exists | PASS | Function defined on line 63 with correct signature. |\n| Returns warning for non-owner assignees on private project | PASS | Lines 75-81. Test `test_validate_private_assignees_warning` verifies. |\n| Returns None for shared projects | PASS | Lines 72-73. Test `test_shared_always_ok` verifies. |\n| Returns None when all assignees are the owner | PASS | Lines 76-77. Test `test_private_all_owner_ok` verifies. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n<<<<<<< HEAD\n| `test_add_default_inbox` | PASS |\n| `test_add_with_project_section_due` | PASS |\n| `test_add_private_rejects_other_assignee` | PASS |\n| `test_add_assignee_defaults_to_sender` | PASS |\n| `test_add_multiple_assignees` | PASS |\n\nAll 5 required tests present and passing. 5 additional tests (`test_add_private_allows_owner_assignee`, `test_event_logged`, `test_add_empty_title_returns_error`, `test_add_nonexistent_project_returns_error`, `test_add_due_clear_sentinel_stored_as_null`). 10 tests total.\n\n### Findings\n\n#### [Info] F1: No explicit transaction wrapping for multi-statement write\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-80\n- **Description**: The handler performs three sequential writes (task INSERT, assignee INSERTs, event INSERT) followed by a single `conn.commit()` at line 80. If any write after the task INSERT raises (e.g., duplicate assignee PK violation), partial writes remain uncommitted. SQLite's implicit rollback-on-close in the dispatcher's `finally` block protects data integrity.\n- **Action**: Consider wrapping in `with conn:` (context manager) for explicit transaction semantics in a future refactor. No functional bug today.\n\n#### [Info] F2: Missing `sender_id` key would raise unhandled KeyError\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 22\n- **Description**: `context[\"sender_id\"]` raises `KeyError` if the key is absent. The dispatcher contract requires `sender_id` in context, so this is defensive-coding territory.\n- **Action**: Acceptable. Could be improved with `.get()` + early return, but low priority given the documented contract.\n\n#### [Info] F3: Test gap -- non-owner sender adding to another user's private project\n\n- **File**: `tests/test_cmd_add.py`\n- **Description**: No test covers the case where sender U2 tries to add a task to a private project owned by U1. The `resolve_project()` function would return `ProjectNotFoundError` (it only matches private projects of the sender), which is correct behavior. However, there is no explicit test verifying this path through `add_handler`.\n- **Action**: Follow-up item. Add a test for \"non-owner sender cannot resolve another user's private project.\"\n\n#### [Info] F4: Title length is unbounded\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 23\n- **Description**: No max-length check on `title`. Slack messages cap at ~4000 chars, providing natural limits. The DB column is `TEXT NOT NULL` with no length constraint.\n- **Action**: Consider adding a max-length check if the handler is exposed outside Slack.\n\n#### [Info] F5: Dispatcher test correctly updated\n\n- **File**: `tests/test_dispatcher.py`, lines 34-51\n- **Description**: The parametrized stub test removed `\"add\"` from the stub-check list and added a dedicated `test_add_routes_to_handler` test that asserts `\"Added #\"` in the result. This correctly reflects that `add` is no longer a stub.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and correct:\n\n- Uses `resolve_project()` for project resolution following PRD Option A (private-first).\n- Private assignee validation correctly rejects non-owner assignees with a descriptive warning.\n- All SQL uses parameterized queries (`?` placeholders).\n- Event payload is well-structured JSON with title, project, section, due, and assignees.\n- Response format matches the PRD/UX spec exactly.\n- 10 tests with thorough assertions on both the response string and DB state.\n- No unnecessary complexity or over-engineering.\n\n**Verdict: APPROVE** -- no blocking issues. No fixes required.\n=======\n| `test_private_owner_can_write` | PASS |\n| `test_private_non_owner_rejected` | PASS |\n| `test_shared_assignee_can_write` | PASS |\n| `test_shared_creator_can_write` | PASS |\n| `test_shared_unrelated_rejected` | PASS |\n| `test_nonexistent_task` | PASS |\n| `test_validate_private_assignees_warning` | PASS |\n| `test_private_all_owner_ok` | PASS |\n| `test_shared_always_ok` | PASS |\n| `test_private_empty_assignees_ok` | PASS |\n\nAll 10 tests present and passing. 48 tests total in the suite.\n\n### Findings\n\n#### [Medium] F1: Shared project owner cannot modify tasks they did not create or get assigned to — CONFIRMED INTENTIONAL\n\n- **Description**: In a shared project, only the task creator and assignees are allowed to write. The project owner has no special privileges. User confirmed this is intentional: only task creator and assignees should have task write access.\n- **Status**: CLOSED as intentional design.\n\n#### [Low] F2: `validate_private_assignees` with `owner_id=None` marks all assignees as non-owner\n\n- **Description**: When `owner_id` is `None` on a private project (data integrity issue), all assignees would be flagged as non-owner. Function short-circuits for shared projects, so this only affects corrupted data.\n- **Status**: OPEN, non-blocking.\n\n#### [Low] F3: No test for shared project where sender is both creator and assignee — FIXED\n\n- **Description**: Added `test_shared_creator_and_assignee_can_write` in commit 594cad4. Creator short-circuit handles this correctly.\n- **Status**: FIXED.\n\n#### [Low] F4: `_create_project` helper uses complex SELECT instead of `last_insert_rowid()`\n\n- **Status**: OPEN, non-blocking.\n\n### Code Quality Summary\n\n**Verdict: APPROVE** -- no Critical or High findings. F1 confirmed intentional, F3 fixed.\n>>>>>>> origin/main\n\n---\n\n## Security Findings\n\n<<<<<<< HEAD\n### [Info] S1: SQL injection -- No risk\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-78\n- **Description**: All three SQL statements (task INSERT, assignee INSERT, event INSERT) use `?` parameter placeholders. No string interpolation or f-strings in SQL. Title, project_id, section, due, sender_id, and assignee values are all passed as parameters.\n- **Severity**: Info (no risk found)\n\n### [Info] S2: Authorization model is sound\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 41-49\n- **Description**: Private project constraint correctly checks that all assignees match the project owner. The `resolve_project()` function provides implicit access control by only resolving the sender's own private projects (scoped by `owner_user_id = sender_id` in the SQL query). A non-owner sender cannot resolve another user's private project by name. The explicit assignee check in `cmd_add.py` is an additional layer for when the owner assigns tasks to others within their private project.\n- **Severity**: Info (no bypass possible)\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in any changed files.\n\n### [Info] S4: No new dependencies introduced\n\n- `cmd_add.py` uses only standard library (`json`, `logging`, `sqlite3`) plus internal modules (`parser`, `project_resolver`). No new entries in `pyproject.toml`.\n\n### [Info] S5: Input validation adequate\n\n- Empty title returns error (line 25-26).\n- Non-existent project returns error via `ProjectNotFoundError` (lines 30-33).\n- Section validation handled by parser upstream (`VALID_SECTIONS` check).\n- Due date validation handled by parser upstream (`_normalise_due`).\n- Mention format constrained by parser regex (`<@U[A-Z0-9]+>`).\n\n### Security Summary\n\nNo Critical, High, Medium, or Low severity findings. The implementation has a minimal attack surface -- three parameterized INSERT statements, project resolution with sender-scoped authorization, and input validation at both the parser and handler layers. The code is secure for the current Slack DM context.\n\n---\n\n## Follow-up Items\n\n1. **Test coverage**: Add a test for non-owner sender attempting to add a task to another user's private project (should get `ProjectNotFoundError` via resolver).\n2. **Transaction explicitness**: Consider wrapping the three DB writes in `with conn:` for explicit transaction semantics.\n3. **Title length**: Consider adding a max-length validation (e.g., 500 chars) as defense-in-depth.\n4. **Permissions module**: When Issue #17 (permissions helper) is merged, consider extracting the inline private-assignee validation to use the shared `validate_private_assignees()` function.\n=======\nNo Critical, High, or Medium severity security findings. All SQL parameterized. Fail-closed design. Three Low findings noted for awareness.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Defensive guard**: Consider adding a log warning in `validate_private_assignees` when `visibility == \"private\"` and `owner_id is None`.\n2. **Test consistency**: Align `_create_project` helper to use `last_insert_rowid()` like `_create_task`.\n\n---\n\n## Review Pass 2\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Commit range: ff87515..594cad4\n\n### Purpose\n\nSecond review pass to verify the F3 fix (commit 594cad4) and confirm no remaining Critical/High issues.\n\n### F3 Fix Verification: `test_shared_creator_and_assignee_can_write`\n\n- **Status**: VERIFIED CORRECT\n- The test creates a shared project, a task where `U_BOTH` is the creator, assigns `U_BOTH` as an assignee, and asserts `can_write_task` returns `True`.\n- This exercises the creator short-circuit path, which returns `True` before the assignee query is reached.\n\n### Prior Findings Status\n\n| Finding | Severity | Status |\n|---------|----------|--------|\n| F1: Shared project owner has no implicit write | Medium | CLOSED -- Confirmed intentional by user. |\n| F2: `validate_private_assignees` with `owner_id=None` | Low | OPEN -- non-blocking. |\n| F3: Missing creator+assignee overlap test | Low | FIXED in 594cad4. Verified correct. |\n| F4: `_create_project` helper uses complex SELECT | Low | OPEN -- non-blocking. |\n\n### Verdict\n\n**APPROVE -- ready to merge.** All 49 tests pass. No Critical or High issues.\n>>>>>>> origin/main\n", "structuredPatch": [{"oldStart": 974, "oldLines": 60, "newStart": 974, "newLines": 6, "lines": [" ", " | Test | Status |", " |------|--------|", "-<<<<<<< HEAD", "-| `test_add_default_inbox` | PASS |", "-| `test_add_with_project_section_due` | PASS |", "-| `test_add_private_rejects_other_assignee` | PASS |", "-| `test_add_assignee_defaults_to_sender` | PASS |", "-| `test_add_multiple_assignees` | PASS |", "-", "-All 5 required tests present and passing. 5 additional tests (`test_add_private_allows_owner_assignee`, `test_event_logged`, `test_add_empty_title_returns_error`, `test_add_nonexistent_project_returns_error`, `test_add_due_clear_sentinel_stored_as_null`). 10 tests total.", "-", "-### Findings", "-", "-#### [Info] F1: No explicit transaction wrapping for multi-statement write", "-", "-- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-80", "-- **Description**: The handler performs three sequential writes (task INSERT, assignee INSERTs, event INSERT) followed by a single `conn.commit()` at line 80. If any write after the task INSERT raises (e.g., duplicate assignee PK violation), partial writes remain uncommitted. SQLite's implicit rollback-on-close in the dispatcher's `finally` block protects data integrity.", "-- **Action**: Consider wrapping in `with conn:` (context manager) for explicit transaction semantics in a future refactor. No functional bug today.", "-", "-#### [Info] F2: Missing `sender_id` key would raise unhandled KeyError", "-", "-- **File**: `src/openclaw_todo/cmd_add.py`, line 22", "-- **Description**: `context[\"sender_id\"]` raises `KeyError` if the key is absent. The dispatcher contract requires `sender_id` in context, so this is defensive-coding territory.", "-- **Action**: Acceptable. Could be improved with `.get()` + early return, but low priority given the documented contract.", "-", "-#### [Info] F3: Test gap -- non-owner sender adding to another user's private project", "-", "-- **File**: `tests/test_cmd_add.py`", "-- **Description**: No test covers the case where sender U2 tries to add a task to a private project owned by U1. The `resolve_project()` function would return `ProjectNotFoundError` (it only matches private projects of the sender), which is correct behavior. However, there is no explicit test verifying this path through `add_handler`.", "-- **Action**: Follow-up item. Add a test for \"non-owner sender cannot resolve another user's private project.\"", "-", "-#### [Info] F4: Title length is unbounded", "-", "-- **File**: `src/openclaw_todo/cmd_add.py`, line 23", "-- **Description**: No max-length check on `title`. Slack messages cap at ~4000 chars, providing natural limits. The DB column is `TEXT NOT NULL` with no length constraint.", "-- **Action**: Consider adding a max-length check if the handler is exposed outside Slack.", "-", "-#### [Info] F5: Dispatcher test correctly updated", "-", "-- **File**: `tests/test_dispatcher.py`, lines 34-51", "-- **Description**: The parametrized stub test removed `\"add\"` from the stub-check list and added a dedicated `test_add_routes_to_handler` test that asserts `\"Added #\"` in the result. This correctly reflects that `add` is no longer a stub.", "-", "-### Code Quality Summary", "-", "-The implementation is clean, minimal, and correct:", "-", "-- Uses `resolve_project()` for project resolution following PRD Option A (private-first).", "-- Private assignee validation correctly rejects non-owner assignees with a descriptive warning.", "-- All SQL uses parameterized queries (`?` placeholders).", "-- Event payload is well-structured JSON with title, project, section, due, and assignees.", "-- Response format matches the PRD/UX spec exactly.", "-- 10 tests with thorough assertions on both the response string and DB state.", "-- No unnecessary complexity or over-engineering.", "-", "-**Verdict: APPROVE** -- no blocking issues. No fixes required.", "-=======", " | `test_private_owner_can_write` | PASS |", " | `test_private_non_owner_rejected` | PASS |", " | `test_shared_assignee_can_write` | PASS |"]}, {"oldStart": 1065, "oldLines": 7, "newStart": 1011, "newLines": 6, "lines": [" ### Code Quality Summary", " ", " **Verdict: APPROVE** -- no Critical or High findings. F1 confirmed intentional, F3 fixed.", "->>>>>>> origin/main", " ", " ---", " "]}], "userModified": false, "replaceAll": false}, "tool_use_id": "toolu_01BscBHwMYeSMBqAcVYJZwVF", "_ts": "2026-02-20T19:31:14+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "old_string": "<<<<<<< HEAD\n### [Info] S1: SQL injection -- No risk\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-78\n- **Description**: All three SQL statements (task INSERT, assignee INSERT, event INSERT) use `?` parameter placeholders. No string interpolation or f-strings in SQL. Title, project_id, section, due, sender_id, and assignee values are all passed as parameters.\n- **Severity**: Info (no risk found)\n\n### [Info] S2: Authorization model is sound\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 41-49\n- **Description**: Private project constraint correctly checks that all assignees match the project owner. The `resolve_project()` function provides implicit access control by only resolving the sender's own private projects (scoped by `owner_user_id = sender_id` in the SQL query). A non-owner sender cannot resolve another user's private project by name. The explicit assignee check in `cmd_add.py` is an additional layer for when the owner assigns tasks to others within their private project.\n- **Severity**: Info (no bypass possible)\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in any changed files.\n\n### [Info] S4: No new dependencies introduced\n\n- `cmd_add.py` uses only standard library (`json`, `logging`, `sqlite3`) plus internal modules (`parser`, `project_resolver`). No new entries in `pyproject.toml`.\n\n### [Info] S5: Input validation adequate\n\n- Empty title returns error (line 25-26).\n- Non-existent project returns error via `ProjectNotFoundError` (lines 30-33).\n- Section validation handled by parser upstream (`VALID_SECTIONS` check).\n- Due date validation handled by parser upstream (`_normalise_due`).\n- Mention format constrained by parser regex (`<@U[A-Z0-9]+>`).\n\n### Security Summary\n\nNo Critical, High, Medium, or Low severity findings. The implementation has a minimal attack surface -- three parameterized INSERT statements, project resolution with sender-scoped authorization, and input validation at both the parser and handler layers. The code is secure for the current Slack DM context.\n\n---\n\n## Follow-up Items\n\n1. **Test coverage**: Add a test for non-owner sender attempting to add a task to another user's private project (should get `ProjectNotFoundError` via resolver).\n2. **Transaction explicitness**: Consider wrapping the three DB writes in `with conn:` for explicit transaction semantics.\n3. **Title length**: Consider adding a max-length validation (e.g., 500 chars) as defense-in-depth.\n4. **Permissions module**: When Issue #17 (permissions helper) is merged, consider extracting the inline private-assignee validation to use the shared `validate_private_assignees()` function.\n=======\nNo Critical, High, or Medium severity security findings. All SQL parameterized. Fail-closed design. Three Low findings noted for awareness.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Defensive guard**: Consider adding a log warning in `validate_private_assignees` when `visibility == \"private\"` and `owner_id is None`.\n2. **Test consistency**: Align `_create_project` helper to use `last_insert_rowid()` like `_create_task`.\n\n---", "new_string": "No Critical, High, or Medium severity security findings. All SQL parameterized. Fail-closed design. Three Low findings noted for awareness.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Defensive guard**: Consider adding a log warning in `validate_private_assignees` when `visibility == \"private\"` and `owner_id is None`.\n2. **Test consistency**: Align `_create_project` helper to use `last_insert_rowid()` like `_create_task`.\n\n---\n\n# PR #18 Review Notes -- Issue #6: /todo add command\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/006-cmd-add`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| Task inserted with correct project_id, section, due, status='open', created_by | PASS | `test_add_default_inbox` and `test_add_with_project_section_due` verify all fields in DB |\n| Assignees default to sender when no mentions | PASS | `test_add_assignee_defaults_to_sender` verifies `task_assignees` row matches sender |\n| Multiple mentions create multiple task_assignee rows | PASS | `test_add_multiple_assignees` verifies two rows inserted and present in response |\n| Private project + non-owner assignee returns warning and does NOT insert | PASS | `test_add_private_rejects_other_assignee` verifies warning message and zero task rows |\n| Non-existent project: `Inbox` auto-created; others return error | PASS | `test_add_default_inbox` uses seeded Inbox; `test_add_nonexistent_project_returns_error` verifies error |\n| Response format: `Added #<id> (<project>/<section>) due:<due\\|-> assignees:<mentions> -- <title>` | PASS | All happy-path tests assert on this format |\n| Event row written to `events` table | PASS | `test_event_logged` verifies actor, action, task_id, and JSON payload fields |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_add_default_inbox` | PASS |\n| `test_add_with_project_section_due` | PASS |\n| `test_add_private_rejects_other_assignee` | PASS |\n| `test_add_assignee_defaults_to_sender` | PASS |\n| `test_add_multiple_assignees` | PASS |\n\nAll 5 required tests present and passing. 5 additional tests (`test_add_private_allows_owner_assignee`, `test_event_logged`, `test_add_empty_title_returns_error`, `test_add_nonexistent_project_returns_error`, `test_add_due_clear_sentinel_stored_as_null`). 10 tests total.\n\n### Findings\n\n#### [Info] F1: No explicit transaction wrapping for multi-statement write\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-80\n- **Description**: The handler performs three sequential writes (task INSERT, assignee INSERTs, event INSERT) followed by a single `conn.commit()` at line 80. If any write after the task INSERT raises (e.g., duplicate assignee PK violation), partial writes remain uncommitted. SQLite's implicit rollback-on-close in the dispatcher's `finally` block protects data integrity.\n- **Action**: Consider wrapping in `with conn:` (context manager) for explicit transaction semantics in a future refactor. No functional bug today.\n\n#### [Info] F2: Missing `sender_id` key would raise unhandled KeyError\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 22\n- **Description**: `context[\"sender_id\"]` raises `KeyError` if the key is absent. The dispatcher contract requires `sender_id` in context, so this is defensive-coding territory.\n- **Action**: Acceptable. Could be improved with `.get()` + early return, but low priority given the documented contract.\n\n#### [Info] F3: Test gap -- non-owner sender adding to another user's private project\n\n- **File**: `tests/test_cmd_add.py`\n- **Description**: No test covers the case where sender U2 tries to add a task to a private project owned by U1. The `resolve_project()` function would return `ProjectNotFoundError` (it only matches private projects of the sender), which is correct behavior. However, there is no explicit test verifying this path through `add_handler`.\n- **Action**: Follow-up item. Add a test for \"non-owner sender cannot resolve another user's private project.\"\n\n#### [Info] F4: Title length is unbounded\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 23\n- **Description**: No max-length check on `title`. Slack messages cap at ~4000 chars, providing natural limits. The DB column is `TEXT NOT NULL` with no length constraint.\n- **Action**: Consider adding a max-length check if the handler is exposed outside Slack.\n\n#### [Info] F5: Dispatcher test correctly updated\n\n- **File**: `tests/test_dispatcher.py`, lines 34-51\n- **Description**: The parametrized stub test removed `\"add\"` from the stub-check list and added a dedicated `test_add_routes_to_handler` test that asserts `\"Added #\"` in the result. This correctly reflects that `add` is no longer a stub.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and correct:\n\n- Uses `resolve_project()` for project resolution following PRD Option A (private-first).\n- Private assignee validation correctly rejects non-owner assignees with a descriptive warning.\n- All SQL uses parameterized queries (`?` placeholders).\n- Event payload is well-structured JSON with title, project, section, due, and assignees.\n- Response format matches the PRD/UX spec exactly.\n- 10 tests with thorough assertions on both the response string and DB state.\n- No unnecessary complexity or over-engineering.\n\n**Verdict: APPROVE** -- no blocking issues. No fixes required.\n\n---\n\n## Security Findings\n\n### [Info] S1: SQL injection -- No risk\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-78\n- **Description**: All three SQL statements (task INSERT, assignee INSERT, event INSERT) use `?` parameter placeholders. No string interpolation or f-strings in SQL. Title, project_id, section, due, sender_id, and assignee values are all passed as parameters.\n- **Severity**: Info (no risk found)\n\n### [Info] S2: Authorization model is sound\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 41-49\n- **Description**: Private project constraint correctly checks that all assignees match the project owner. The `resolve_project()` function provides implicit access control by only resolving the sender's own private projects (scoped by `owner_user_id = sender_id` in the SQL query). A non-owner sender cannot resolve another user's private project by name. The explicit assignee check in `cmd_add.py` is an additional layer for when the owner assigns tasks to others within their private project.\n- **Severity**: Info (no bypass possible)\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in any changed files.\n\n### [Info] S4: No new dependencies introduced\n\n- `cmd_add.py` uses only standard library (`json`, `logging`, `sqlite3`) plus internal modules (`parser`, `project_resolver`). No new entries in `pyproject.toml`.\n\n### [Info] S5: Input validation adequate\n\n- Empty title returns error (line 25-26).\n- Non-existent project returns error via `ProjectNotFoundError` (lines 30-33).\n- Section validation handled by parser upstream (`VALID_SECTIONS` check).\n- Due date validation handled by parser upstream (`_normalise_due`).\n- Mention format constrained by parser regex (`<@U[A-Z0-9]+>`).\n\n### Security Summary\n\nNo Critical, High, Medium, or Low severity findings. The implementation has a minimal attack surface -- three parameterized INSERT statements, project resolution with sender-scoped authorization, and input validation at both the parser and handler layers. The code is secure for the current Slack DM context.\n\n---\n\n## Follow-up Items\n\n1. **Test coverage**: Add a test for non-owner sender attempting to add a task to another user's private project (should get `ProjectNotFoundError` via resolver).\n2. **Transaction explicitness**: Consider wrapping the three DB writes in `with conn:` for explicit transaction semantics.\n3. **Title length**: Consider adding a max-length validation (e.g., 500 chars) as defense-in-depth.\n4. **Permissions module**: Consider extracting the inline private-assignee validation to use the shared `validate_private_assignees()` function from Issue #17.", "replace_all": false}, "tool_use_id": "toolu_01EmCcAtTpWS228G4otPU8pi", "_ts": "2026-02-20T19:31:52+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "old_string": "<<<<<<< HEAD\n### [Info] S1: SQL injection -- No risk\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-78\n- **Description**: All three SQL statements (task INSERT, assignee INSERT, event INSERT) use `?` parameter placeholders. No string interpolation or f-strings in SQL. Title, project_id, section, due, sender_id, and assignee values are all passed as parameters.\n- **Severity**: Info (no risk found)\n\n### [Info] S2: Authorization model is sound\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 41-49\n- **Description**: Private project constraint correctly checks that all assignees match the project owner. The `resolve_project()` function provides implicit access control by only resolving the sender's own private projects (scoped by `owner_user_id = sender_id` in the SQL query). A non-owner sender cannot resolve another user's private project by name. The explicit assignee check in `cmd_add.py` is an additional layer for when the owner assigns tasks to others within their private project.\n- **Severity**: Info (no bypass possible)\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in any changed files.\n\n### [Info] S4: No new dependencies introduced\n\n- `cmd_add.py` uses only standard library (`json`, `logging`, `sqlite3`) plus internal modules (`parser`, `project_resolver`). No new entries in `pyproject.toml`.\n\n### [Info] S5: Input validation adequate\n\n- Empty title returns error (line 25-26).\n- Non-existent project returns error via `ProjectNotFoundError` (lines 30-33).\n- Section validation handled by parser upstream (`VALID_SECTIONS` check).\n- Due date validation handled by parser upstream (`_normalise_due`).\n- Mention format constrained by parser regex (`<@U[A-Z0-9]+>`).\n\n### Security Summary\n\nNo Critical, High, Medium, or Low severity findings. The implementation has a minimal attack surface -- three parameterized INSERT statements, project resolution with sender-scoped authorization, and input validation at both the parser and handler layers. The code is secure for the current Slack DM context.\n\n---\n\n## Follow-up Items\n\n1. **Test coverage**: Add a test for non-owner sender attempting to add a task to another user's private project (should get `ProjectNotFoundError` via resolver).\n2. **Transaction explicitness**: Consider wrapping the three DB writes in `with conn:` for explicit transaction semantics.\n3. **Title length**: Consider adding a max-length validation (e.g., 500 chars) as defense-in-depth.\n4. **Permissions module**: When Issue #17 (permissions helper) is merged, consider extracting the inline private-assignee validation to use the shared `validate_private_assignees()` function.\n=======\nNo Critical, High, or Medium severity security findings. All SQL parameterized. Fail-closed design. Three Low findings noted for awareness.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Defensive guard**: Consider adding a log warning in `validate_private_assignees` when `visibility == \"private\"` and `owner_id is None`.\n2. **Test consistency**: Align `_create_project` helper to use `last_insert_rowid()` like `_create_task`.\n\n---", "new_string": "No Critical, High, or Medium severity security findings. All SQL parameterized. Fail-closed design. Three Low findings noted for awareness.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Defensive guard**: Consider adding a log warning in `validate_private_assignees` when `visibility == \"private\"` and `owner_id is None`.\n2. **Test consistency**: Align `_create_project` helper to use `last_insert_rowid()` like `_create_task`.\n\n---\n\n# PR #18 Review Notes -- Issue #6: /todo add command\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/006-cmd-add`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| Task inserted with correct project_id, section, due, status='open', created_by | PASS | `test_add_default_inbox` and `test_add_with_project_section_due` verify all fields in DB |\n| Assignees default to sender when no mentions | PASS | `test_add_assignee_defaults_to_sender` verifies `task_assignees` row matches sender |\n| Multiple mentions create multiple task_assignee rows | PASS | `test_add_multiple_assignees` verifies two rows inserted and present in response |\n| Private project + non-owner assignee returns warning and does NOT insert | PASS | `test_add_private_rejects_other_assignee` verifies warning message and zero task rows |\n| Non-existent project: `Inbox` auto-created; others return error | PASS | `test_add_default_inbox` uses seeded Inbox; `test_add_nonexistent_project_returns_error` verifies error |\n| Response format: `Added #<id> (<project>/<section>) due:<due\\|-> assignees:<mentions> -- <title>` | PASS | All happy-path tests assert on this format |\n| Event row written to `events` table | PASS | `test_event_logged` verifies actor, action, task_id, and JSON payload fields |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_add_default_inbox` | PASS |\n| `test_add_with_project_section_due` | PASS |\n| `test_add_private_rejects_other_assignee` | PASS |\n| `test_add_assignee_defaults_to_sender` | PASS |\n| `test_add_multiple_assignees` | PASS |\n\nAll 5 required tests present and passing. 5 additional tests (`test_add_private_allows_owner_assignee`, `test_event_logged`, `test_add_empty_title_returns_error`, `test_add_nonexistent_project_returns_error`, `test_add_due_clear_sentinel_stored_as_null`). 10 tests total.\n\n### Findings\n\n#### [Info] F1: No explicit transaction wrapping for multi-statement write\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-80\n- **Description**: The handler performs three sequential writes (task INSERT, assignee INSERTs, event INSERT) followed by a single `conn.commit()` at line 80. If any write after the task INSERT raises (e.g., duplicate assignee PK violation), partial writes remain uncommitted. SQLite's implicit rollback-on-close in the dispatcher's `finally` block protects data integrity.\n- **Action**: Consider wrapping in `with conn:` (context manager) for explicit transaction semantics in a future refactor. No functional bug today.\n\n#### [Info] F2: Missing `sender_id` key would raise unhandled KeyError\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 22\n- **Description**: `context[\"sender_id\"]` raises `KeyError` if the key is absent. The dispatcher contract requires `sender_id` in context, so this is defensive-coding territory.\n- **Action**: Acceptable. Could be improved with `.get()` + early return, but low priority given the documented contract.\n\n#### [Info] F3: Test gap -- non-owner sender adding to another user's private project\n\n- **File**: `tests/test_cmd_add.py`\n- **Description**: No test covers the case where sender U2 tries to add a task to a private project owned by U1. The `resolve_project()` function would return `ProjectNotFoundError` (it only matches private projects of the sender), which is correct behavior. However, there is no explicit test verifying this path through `add_handler`.\n- **Action**: Follow-up item. Add a test for \"non-owner sender cannot resolve another user's private project.\"\n\n#### [Info] F4: Title length is unbounded\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 23\n- **Description**: No max-length check on `title`. Slack messages cap at ~4000 chars, providing natural limits. The DB column is `TEXT NOT NULL` with no length constraint.\n- **Action**: Consider adding a max-length check if the handler is exposed outside Slack.\n\n#### [Info] F5: Dispatcher test correctly updated\n\n- **File**: `tests/test_dispatcher.py`, lines 34-51\n- **Description**: The parametrized stub test removed `\"add\"` from the stub-check list and added a dedicated `test_add_routes_to_handler` test that asserts `\"Added #\"` in the result. This correctly reflects that `add` is no longer a stub.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and correct:\n\n- Uses `resolve_project()` for project resolution following PRD Option A (private-first).\n- Private assignee validation correctly rejects non-owner assignees with a descriptive warning.\n- All SQL uses parameterized queries (`?` placeholders).\n- Event payload is well-structured JSON with title, project, section, due, and assignees.\n- Response format matches the PRD/UX spec exactly.\n- 10 tests with thorough assertions on both the response string and DB state.\n- No unnecessary complexity or over-engineering.\n\n**Verdict: APPROVE** -- no blocking issues. No fixes required.\n\n---\n\n## Security Findings\n\n### [Info] S1: SQL injection -- No risk\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-78\n- **Description**: All three SQL statements (task INSERT, assignee INSERT, event INSERT) use `?` parameter placeholders. No string interpolation or f-strings in SQL. Title, project_id, section, due, sender_id, and assignee values are all passed as parameters.\n- **Severity**: Info (no risk found)\n\n### [Info] S2: Authorization model is sound\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 41-49\n- **Description**: Private project constraint correctly checks that all assignees match the project owner. The `resolve_project()` function provides implicit access control by only resolving the sender's own private projects (scoped by `owner_user_id = sender_id` in the SQL query). A non-owner sender cannot resolve another user's private project by name. The explicit assignee check in `cmd_add.py` is an additional layer for when the owner assigns tasks to others within their private project.\n- **Severity**: Info (no bypass possible)\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in any changed files.\n\n### [Info] S4: No new dependencies introduced\n\n- `cmd_add.py` uses only standard library (`json`, `logging`, `sqlite3`) plus internal modules (`parser`, `project_resolver`). No new entries in `pyproject.toml`.\n\n### [Info] S5: Input validation adequate\n\n- Empty title returns error (line 25-26).\n- Non-existent project returns error via `ProjectNotFoundError` (lines 30-33).\n- Section validation handled by parser upstream (`VALID_SECTIONS` check).\n- Due date validation handled by parser upstream (`_normalise_due`).\n- Mention format constrained by parser regex (`<@U[A-Z0-9]+>`).\n\n### Security Summary\n\nNo Critical, High, Medium, or Low severity findings. The implementation has a minimal attack surface -- three parameterized INSERT statements, project resolution with sender-scoped authorization, and input validation at both the parser and handler layers. The code is secure for the current Slack DM context.\n\n---\n\n## Follow-up Items\n\n1. **Test coverage**: Add a test for non-owner sender attempting to add a task to another user's private project (should get `ProjectNotFoundError` via resolver).\n2. **Transaction explicitness**: Consider wrapping the three DB writes in `with conn:` for explicit transaction semantics.\n3. **Title length**: Consider adding a max-length validation (e.g., 500 chars) as defense-in-depth.\n4. **Permissions module**: Consider extracting the inline private-assignee validation to use the shared `validate_private_assignees()` function from Issue #17.", "replace_all": false}, "tool_response": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "oldString": "<<<<<<< HEAD\n### [Info] S1: SQL injection -- No risk\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-78\n- **Description**: All three SQL statements (task INSERT, assignee INSERT, event INSERT) use `?` parameter placeholders. No string interpolation or f-strings in SQL. Title, project_id, section, due, sender_id, and assignee values are all passed as parameters.\n- **Severity**: Info (no risk found)\n\n### [Info] S2: Authorization model is sound\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 41-49\n- **Description**: Private project constraint correctly checks that all assignees match the project owner. The `resolve_project()` function provides implicit access control by only resolving the sender's own private projects (scoped by `owner_user_id = sender_id` in the SQL query). A non-owner sender cannot resolve another user's private project by name. The explicit assignee check in `cmd_add.py` is an additional layer for when the owner assigns tasks to others within their private project.\n- **Severity**: Info (no bypass possible)\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in any changed files.\n\n### [Info] S4: No new dependencies introduced\n\n- `cmd_add.py` uses only standard library (`json`, `logging`, `sqlite3`) plus internal modules (`parser`, `project_resolver`). No new entries in `pyproject.toml`.\n\n### [Info] S5: Input validation adequate\n\n- Empty title returns error (line 25-26).\n- Non-existent project returns error via `ProjectNotFoundError` (lines 30-33).\n- Section validation handled by parser upstream (`VALID_SECTIONS` check).\n- Due date validation handled by parser upstream (`_normalise_due`).\n- Mention format constrained by parser regex (`<@U[A-Z0-9]+>`).\n\n### Security Summary\n\nNo Critical, High, Medium, or Low severity findings. The implementation has a minimal attack surface -- three parameterized INSERT statements, project resolution with sender-scoped authorization, and input validation at both the parser and handler layers. The code is secure for the current Slack DM context.\n\n---\n\n## Follow-up Items\n\n1. **Test coverage**: Add a test for non-owner sender attempting to add a task to another user's private project (should get `ProjectNotFoundError` via resolver).\n2. **Transaction explicitness**: Consider wrapping the three DB writes in `with conn:` for explicit transaction semantics.\n3. **Title length**: Consider adding a max-length validation (e.g., 500 chars) as defense-in-depth.\n4. **Permissions module**: When Issue #17 (permissions helper) is merged, consider extracting the inline private-assignee validation to use the shared `validate_private_assignees()` function.\n=======\nNo Critical, High, or Medium severity security findings. All SQL parameterized. Fail-closed design. Three Low findings noted for awareness.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Defensive guard**: Consider adding a log warning in `validate_private_assignees` when `visibility == \"private\"` and `owner_id is None`.\n2. **Test consistency**: Align `_create_project` helper to use `last_insert_rowid()` like `_create_task`.\n\n---", "newString": "No Critical, High, or Medium severity security findings. All SQL parameterized. Fail-closed design. Three Low findings noted for awareness.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Defensive guard**: Consider adding a log warning in `validate_private_assignees` when `visibility == \"private\"` and `owner_id is None`.\n2. **Test consistency**: Align `_create_project` helper to use `last_insert_rowid()` like `_create_task`.\n\n---\n\n# PR #18 Review Notes -- Issue #6: /todo add command\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/006-cmd-add`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| Task inserted with correct project_id, section, due, status='open', created_by | PASS | `test_add_default_inbox` and `test_add_with_project_section_due` verify all fields in DB |\n| Assignees default to sender when no mentions | PASS | `test_add_assignee_defaults_to_sender` verifies `task_assignees` row matches sender |\n| Multiple mentions create multiple task_assignee rows | PASS | `test_add_multiple_assignees` verifies two rows inserted and present in response |\n| Private project + non-owner assignee returns warning and does NOT insert | PASS | `test_add_private_rejects_other_assignee` verifies warning message and zero task rows |\n| Non-existent project: `Inbox` auto-created; others return error | PASS | `test_add_default_inbox` uses seeded Inbox; `test_add_nonexistent_project_returns_error` verifies error |\n| Response format: `Added #<id> (<project>/<section>) due:<due\\|-> assignees:<mentions> -- <title>` | PASS | All happy-path tests assert on this format |\n| Event row written to `events` table | PASS | `test_event_logged` verifies actor, action, task_id, and JSON payload fields |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_add_default_inbox` | PASS |\n| `test_add_with_project_section_due` | PASS |\n| `test_add_private_rejects_other_assignee` | PASS |\n| `test_add_assignee_defaults_to_sender` | PASS |\n| `test_add_multiple_assignees` | PASS |\n\nAll 5 required tests present and passing. 5 additional tests (`test_add_private_allows_owner_assignee`, `test_event_logged`, `test_add_empty_title_returns_error`, `test_add_nonexistent_project_returns_error`, `test_add_due_clear_sentinel_stored_as_null`). 10 tests total.\n\n### Findings\n\n#### [Info] F1: No explicit transaction wrapping for multi-statement write\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-80\n- **Description**: The handler performs three sequential writes (task INSERT, assignee INSERTs, event INSERT) followed by a single `conn.commit()` at line 80. If any write after the task INSERT raises (e.g., duplicate assignee PK violation), partial writes remain uncommitted. SQLite's implicit rollback-on-close in the dispatcher's `finally` block protects data integrity.\n- **Action**: Consider wrapping in `with conn:` (context manager) for explicit transaction semantics in a future refactor. No functional bug today.\n\n#### [Info] F2: Missing `sender_id` key would raise unhandled KeyError\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 22\n- **Description**: `context[\"sender_id\"]` raises `KeyError` if the key is absent. The dispatcher contract requires `sender_id` in context, so this is defensive-coding territory.\n- **Action**: Acceptable. Could be improved with `.get()` + early return, but low priority given the documented contract.\n\n#### [Info] F3: Test gap -- non-owner sender adding to another user's private project\n\n- **File**: `tests/test_cmd_add.py`\n- **Description**: No test covers the case where sender U2 tries to add a task to a private project owned by U1. The `resolve_project()` function would return `ProjectNotFoundError` (it only matches private projects of the sender), which is correct behavior. However, there is no explicit test verifying this path through `add_handler`.\n- **Action**: Follow-up item. Add a test for \"non-owner sender cannot resolve another user's private project.\"\n\n#### [Info] F4: Title length is unbounded\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 23\n- **Description**: No max-length check on `title`. Slack messages cap at ~4000 chars, providing natural limits. The DB column is `TEXT NOT NULL` with no length constraint.\n- **Action**: Consider adding a max-length check if the handler is exposed outside Slack.\n\n#### [Info] F5: Dispatcher test correctly updated\n\n- **File**: `tests/test_dispatcher.py`, lines 34-51\n- **Description**: The parametrized stub test removed `\"add\"` from the stub-check list and added a dedicated `test_add_routes_to_handler` test that asserts `\"Added #\"` in the result. This correctly reflects that `add` is no longer a stub.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and correct:\n\n- Uses `resolve_project()` for project resolution following PRD Option A (private-first).\n- Private assignee validation correctly rejects non-owner assignees with a descriptive warning.\n- All SQL uses parameterized queries (`?` placeholders).\n- Event payload is well-structured JSON with title, project, section, due, and assignees.\n- Response format matches the PRD/UX spec exactly.\n- 10 tests with thorough assertions on both the response string and DB state.\n- No unnecessary complexity or over-engineering.\n\n**Verdict: APPROVE** -- no blocking issues. No fixes required.\n\n---\n\n## Security Findings\n\n### [Info] S1: SQL injection -- No risk\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-78\n- **Description**: All three SQL statements (task INSERT, assignee INSERT, event INSERT) use `?` parameter placeholders. No string interpolation or f-strings in SQL. Title, project_id, section, due, sender_id, and assignee values are all passed as parameters.\n- **Severity**: Info (no risk found)\n\n### [Info] S2: Authorization model is sound\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 41-49\n- **Description**: Private project constraint correctly checks that all assignees match the project owner. The `resolve_project()` function provides implicit access control by only resolving the sender's own private projects (scoped by `owner_user_id = sender_id` in the SQL query). A non-owner sender cannot resolve another user's private project by name. The explicit assignee check in `cmd_add.py` is an additional layer for when the owner assigns tasks to others within their private project.\n- **Severity**: Info (no bypass possible)\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in any changed files.\n\n### [Info] S4: No new dependencies introduced\n\n- `cmd_add.py` uses only standard library (`json`, `logging`, `sqlite3`) plus internal modules (`parser`, `project_resolver`). No new entries in `pyproject.toml`.\n\n### [Info] S5: Input validation adequate\n\n- Empty title returns error (line 25-26).\n- Non-existent project returns error via `ProjectNotFoundError` (lines 30-33).\n- Section validation handled by parser upstream (`VALID_SECTIONS` check).\n- Due date validation handled by parser upstream (`_normalise_due`).\n- Mention format constrained by parser regex (`<@U[A-Z0-9]+>`).\n\n### Security Summary\n\nNo Critical, High, Medium, or Low severity findings. The implementation has a minimal attack surface -- three parameterized INSERT statements, project resolution with sender-scoped authorization, and input validation at both the parser and handler layers. The code is secure for the current Slack DM context.\n\n---\n\n## Follow-up Items\n\n1. **Test coverage**: Add a test for non-owner sender attempting to add a task to another user's private project (should get `ProjectNotFoundError` via resolver).\n2. **Transaction explicitness**: Consider wrapping the three DB writes in `with conn:` for explicit transaction semantics.\n3. **Title length**: Consider adding a max-length validation (e.g., 500 chars) as defense-in-depth.\n4. **Permissions module**: Consider extracting the inline private-assignee validation to use the shared `validate_private_assignees()` function from Issue #17.", "originalFile": "# PR #2 Review Notes -- Issue #1: Plugin skeleton and entry point\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/001-plugin-skeleton`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `pyproject.toml` with Python >=3.11, pytest, pytest-cov dev deps | PASS | Correct. Uses `dependency-groups` (PEP 735) with hatchling backend. |\n| `src/openclaw_todo/__init__.py` exposes `__version__` | PASS | `__version__ = \"0.1.0\"` |\n| `handle_message(text: str, context: dict) -> str` entry point | PASS (minor note) | Return type is `str | None`, not `str`. The AC literally says `-> str` but `None` for ignored messages is the intended behavior per the next AC. Acceptable. |\n| Non-`/todo` messages silently ignored (returns `None`) | PASS | |\n| `uv sync && uv run pytest -q` passes | PASS | 4 tests, 100% coverage |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_ignores_non_todo_message` | PASS -- covers empty string, random text, `/todox` prefix-collision |\n| `test_dispatches_todo_prefix` | PASS -- verifies non-None response with subcommand text |\n\n### Findings\n\n#### [Info] Return type annotation mismatch with AC\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 12\n- The AC states `-> str` but the implementation is `-> str | None`. This is correct behavior (returning `None` for non-todo messages is explicitly required). The AC text is slightly imprecise; the code is right.\n- **Action**: None needed. Consider updating the AC wording if desired.\n\n#### [Info] `context` parameter unused\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 12\n- `context: dict` is accepted but never read in this skeleton. This is expected for M0 -- it will be used once the dispatcher (Issue #16) and DB commands are wired in.\n- **Action**: None. This is intentional scaffolding.\n\n#### [Info] Placeholder response includes raw user input\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 32\n- `f\"TODO command received: {remainder}\"` echoes back unescaped user input. This is a temporary placeholder (comment says \"will be replaced by dispatcher in Issue #16\"). In the current context (no HTML/web rendering, Slack DM only), this is not exploitable, but see Security Findings below.\n- **Action**: Track as part of Issue #16.\n\n#### [Info] Extra tests beyond AC requirements -- good\n\n- `test_todo_prefix_with_whitespace` and `test_todo_without_subcommand` are bonus tests covering whitespace handling and bare `/todo` usage message. Good coverage instinct.\n\n#### [Info] Version duplication\n\n- Version `0.1.0` appears in both `pyproject.toml` and `__init__.py`. Consider using `importlib.metadata` or dynamic versioning in a future issue to keep a single source of truth. Not a concern for M0.\n\n#### [Low] No type hints for `context` dict\n\n- `context: dict` is untyped (could be `dict[str, Any]` or a TypedDict). For M0 this is fine, but a `TypedDict` or dataclass should be introduced when the context shape solidifies.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and well-structured for a skeleton:\n\n- Prefix matching logic (`stripped == _TODO_PREFIX or stripped.startswith(_TODO_PREFIX + \" \")`) correctly avoids false positives on `/todox`.\n- Logging at appropriate levels (debug for all messages, info for matches).\n- Usage help returned for bare `/todo` is a nice touch.\n- Test coverage is 100%.\n\n**Verdict: APPROVE** -- no blocking issues.\n\n---\n\n## Security Findings\n\n### [Low] S1: User input echoed in placeholder response\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 32\n- **Description**: The placeholder `f\"TODO command received: {remainder}\"` reflects user-supplied text without sanitization. In the current Slack DM context, Slack handles rendering and this is not exploitable for XSS. However, once a web dashboard or logging UI is introduced, unsanitized echo could become a reflected XSS vector.\n- **Severity**: Low (Slack auto-escapes; placeholder will be replaced in Issue #16)\n- **Recommendation**: When building the real dispatcher, ensure any user text echoed in responses is sanitized if it ever reaches a web context. No fix needed now.\n\n### [Low] S2: No input length validation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 12\n- **Description**: `handle_message` accepts arbitrarily long strings. A malicious or buggy client could send extremely large messages. Slack itself limits messages to ~40,000 characters, so this is mitigated at the transport layer.\n- **Severity**: Low\n- **Recommendation**: Consider adding a max-length guard in the dispatcher (Issue #16) if the plugin is ever exposed outside Slack.\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in any reviewed files. Environment variable approach is correctly deferred to future DB/config work.\n\n### [Info] S4: Dependencies are minimal and current\n\n- Only dev dependencies: `pytest>=7.0` and `pytest-cov>=4.0`. No known CVEs for these versions. No runtime dependencies beyond the standard library.\n- Build backend `hatchling` is a well-maintained, standard tool.\n\n### [Info] S5: No SQL, no deserialization, no file I/O\n\n- The M0 skeleton has no database, no file operations, and no deserialization. The attack surface is effectively zero at this stage.\n\n### Security Summary\n\nNo Critical or High severity findings. The codebase has a minimal attack surface appropriate for a plugin skeleton. Security considerations will become relevant starting with Issue #2 (DB connection) and Issue #5 (parser with user-controlled input).\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Issue #16 (Dispatcher)**: When replacing the placeholder response, ensure user input is not echoed raw if the output context changes (e.g., web UI).\n2. **Future**: Introduce a `TypedDict` or dataclass for the `context` parameter to enforce shape and enable static analysis.\n3. **Future**: Consolidate version to a single source (e.g., `importlib.metadata.version(\"openclaw-todo-plugin\")`).\n\n---\n\n# PR #4 Review Notes -- Issue #2: DB module -- connection helper and pragma setup\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/002-db-connection`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| Directory is created recursively when absent | PASS | `db_dir.mkdir(parents=True, exist_ok=True)` on line 32. Test `test_creates_directory_and_file` verifies nested `nested/dir/` creation. |\n| SQLite connection returned with WAL mode enabled | PASS | `PRAGMA journal_mode=WAL` on line 36. Test verifies `fetchone()[0] == \"wal\"`. |\n| `busy_timeout` is 3000 | PASS | `PRAGMA busy_timeout=3000` on line 37. Test verifies `fetchone()[0] == 3000`. |\n| Calling `get_connection` twice returns usable connections (no lock conflict) | PASS | `test_two_connections_no_conflict` creates a table via conn1, reads via conn2. WAL mode enables this concurrency. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `tests/test_db.py::test_creates_directory_and_file` | PASS -- verifies both `db_path.exists()` and `db_path.parent.exists()` with nested `tmp_path` |\n| `tests/test_db.py::test_wal_mode_enabled` | PASS -- queries `PRAGMA journal_mode` and asserts `\"wal\"` |\n| `tests/test_db.py::test_busy_timeout` | PASS -- queries `PRAGMA busy_timeout` and asserts `3000` |\n\n### Findings\n\n#### [Info] TOCTOU in `is_new` logging check\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 29\n- `is_new = not db_path.exists()` is checked before `sqlite3.connect()`, which itself creates the file. In a concurrent scenario, the file could appear between the check and the connect. This only affects which log message is emitted (info vs. debug) and has no functional impact.\n- **Action**: None required. Purely cosmetic race condition.\n\n#### [Info] PRAGMA return values not checked\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, lines 36-37\n- `conn.execute(\"PRAGMA journal_mode=WAL;\")` returns a result set with the actual journal mode applied. On some edge cases (e.g., read-only filesystem, in-memory DB), WAL activation can silently fall back to another mode. The code does not verify the return.\n- **Action**: Low priority. Consider adding a debug-level assertion or log warning in a future hardening pass. The test suite already validates WAL is active in the happy path.\n\n#### [Info] Default path uses `Path.home()`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 11\n- `DEFAULT_DB_DIR = Path.home() / \".openclaw\" / \"workspace\" / \".todo\"` is evaluated at module import time. If `HOME` is unset (e.g., certain containerized environments), `Path.home()` raises `RuntimeError`. This is acceptable since: (a) the default is only used when `db_path is None`, and (b) the plugin is designed for environments where `HOME` is set. Callers in containers should pass an explicit path.\n- **Action**: None for M1. Document the `db_path` parameter as the recommended override for non-standard environments.\n\n#### [Info] Extra test beyond AC requirements -- good\n\n- `test_two_connections_no_conflict` is a bonus test that exercises concurrent WAL access. This directly validates the 4th acceptance criterion and is well-structured with proper cleanup in a `finally` block.\n\n#### [Low] Test cleanup uses `try/finally` instead of a fixture\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_db.py`, all tests\n- Each test manually opens a connection and closes it in `try/finally`. A pytest fixture (e.g., `@pytest.fixture` yielding the connection) would reduce boilerplate and guarantee cleanup even if assertion lines are added later. This is a minor style observation for 4 tests.\n- **Action**: Optional refactor. Not blocking.\n\n#### [Info] Coverage at 96%\n\n- Line 24 (`db_path = DEFAULT_DB_DIR / DEFAULT_DB_NAME`) is uncovered because all tests pass explicit `tmp_path` paths. This is correct -- testing the default path would write to the user's actual home directory. The uncovered line is trivial assignment logic.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and correct:\n\n- Function signature `get_connection(db_path: str | Path | None = None)` is flexible, accepting string, Path, or None.\n- `Path(db_path)` normalization on line 26 handles string inputs.\n- `exist_ok=True` on `mkdir` prevents race conditions with concurrent directory creation.\n- Logging at appropriate levels: `info` for creation, `debug` for opens.\n- No unnecessary dependencies -- uses only stdlib `sqlite3`, `pathlib`, and `logging`.\n- 96% test coverage with all acceptance criteria verified.\n\n**Verdict: APPROVE** -- no blocking issues.\n\n---\n\n## Security Findings\n\n### [Low] S1: `db_path` parameter accepts arbitrary filesystem paths\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 15\n- **Description**: `get_connection(db_path)` will create directories and an SQLite database at any filesystem path the process has write access to. If a future caller passes unsanitized user input as `db_path`, this could be used for arbitrary file creation (e.g., path traversal via `../../etc/cron.d/evil`).\n- **Severity**: Low (currently an internal API; no user-facing code path passes user input to `db_path`)\n- **Recommendation**: When wiring `db_path` into the dispatcher (Issue #16), ensure the path comes only from configuration (env var or config file), never from user-controlled message text. Consider adding a validation that `db_path` is within an expected base directory.\n\n### [Info] S2: No SQL injection risk\n\n- PRAGMA statements on lines 36-37 use hardcoded string literals with no interpolation. The `db_path` is passed to `sqlite3.connect()` as a filesystem path, not as a SQL query. No injection surface exists.\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `db.py` or `test_db.py`. The module uses only stdlib.\n\n### [Info] S4: No new dependencies introduced\n\n- This module uses only Python standard library (`sqlite3`, `pathlib`, `logging`). No new entries in `pyproject.toml` dependencies. Zero additional attack surface from third-party code.\n\n### [Info] S5: SQLite WAL mode is a security-positive choice\n\n- WAL mode improves concurrent access safety and reduces the risk of database corruption from concurrent writes. The `busy_timeout=3000` prevents immediate lock failures, which could otherwise cause data loss if a caller does not handle `sqlite3.OperationalError` properly.\n\n### Security Summary\n\nNo Critical or High severity findings. The attack surface is minimal -- a single function that creates a local SQLite database with hardcoded pragmas. The only surface to monitor is ensuring `db_path` remains configuration-controlled as the codebase grows.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Issue #3 (Migration framework)**: When implementing migrations, ensure SQL statements use parameterized queries (not string formatting) for any dynamic values. The migration runner should validate migration callables are from a trusted registry.\n2. **Future**: Add a pytest fixture for `get_connection` that yields and auto-closes, reducing `try/finally` boilerplate across DB-related test files.\n3. **Future**: Consider adding a `validate_db_path(path)` helper that constrains paths to an allowed base directory, for defense-in-depth when the dispatcher wires in configuration.\n\n---\n\n# PR #6 Review Notes -- Issue #3: Schema migration framework and schema_version table\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/003-schema-migration`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `schema_version` table created with single row `version=0` if absent | PASS | `_ensure_version_table` uses `CREATE TABLE IF NOT EXISTS` and inserts `version=0` only when no row exists (line 30-31). |\n| Migrations are Python callables registered in an ordered list | PASS | `_migrations: list[MigrationFn]` with `@register` decorator appending to the list. Index maps directly to migration version. |\n| Each migration runs inside a transaction; version incremented on success | PASS | `conn.commit()` after each successful migration (line 65). SQLite's implicit transaction wraps the migration + version update. |\n| Re-running on an up-to-date DB is a no-op | PASS | `current >= target` guard on line 52 returns immediately. Test `test_idempotent_on_rerun` verifies. |\n| Failing migration rolls back and raises with clear message | PASS | `conn.rollback()` in `except` block (line 67). `RuntimeError` with formatted message including version number and original exception (line 68-70). |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_fresh_db_gets_version_table` | PASS -- verifies `get_version` returns 0 and `schema_version` table exists in `sqlite_master` |\n| `test_applies_migrations_sequentially` | PASS -- registers two migrations, asserts final version is 2, verifies both tables created |\n| `test_idempotent_on_rerun` | PASS -- calls `migrate` twice, both return 1, no errors |\n| `test_rollback_on_failure` | PASS -- first migration commits (version 1, `t_ok` exists), second raises `ValueError`, caught as `RuntimeError`, version stays at 1 |\n\n### Findings\n\n#### [Medium] No constraint preventing multiple rows in `schema_version`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- The `schema_version` table is created with `(version INTEGER NOT NULL)` but has no PRIMARY KEY, UNIQUE constraint, or CHECK constraint limiting it to a single row. If a bug or manual intervention inserts a second row, `get_version` would return whichever row SQLite returns first from `SELECT version FROM schema_version` (non-deterministic without ORDER BY).\n- **Action**: Consider adding a single-row constraint in a future migration (e.g., `CHECK (rowid = 1)` or a dummy `id INTEGER PRIMARY KEY CHECK (id = 1)` column). Not blocking for M1 since all writes go through `_ensure_version_table` which correctly checks before inserting.\n\n#### [Low] Redundant `_ensure_version_table` calls\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, lines 48-49\n- `migrate()` calls `_ensure_version_table(conn)` on line 48, then calls `get_version(conn)` on line 49, which internally calls `_ensure_version_table` again. This results in two `CREATE TABLE IF NOT EXISTS` and two `SELECT version` queries on every `migrate` call.\n- **Action**: Minor performance concern. Could be refactored so `migrate` calls `_ensure_version_table` once and reads the version directly. Not blocking.\n\n#### [Info] Global mutable state for migrations registry\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 15\n- `_migrations` is a module-level mutable list. This is a common pattern for migration registries and works well for single-process applications. The test suite correctly saves/restores it via the `_clean_migrations` autouse fixture (lines 16-23 in test file).\n- **Action**: None. This is an appropriate pattern for this use case. If multi-process or plugin-based architectures are introduced later, consider a class-based registry.\n\n#### [Info] Test fixture properly isolates migration state\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_migrations.py`, lines 16-23\n- The `_clean_migrations` fixture saves the original list, clears it before each test, and restores it after. This prevents test pollution and is correctly marked `autouse=True`. The save-clear-yield-clear-extend pattern is the correct idiom.\n\n#### [Info] `conn` fixture uses `get_connection` from `db` module\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_migrations.py`, lines 27-31\n- The test fixture uses `get_connection` (from Issue #2) rather than raw `sqlite3.connect`. This ensures WAL mode and `busy_timeout` pragmas are applied, matching production behavior. This is a good integration practice.\n\n#### [Info] Coverage at 100%\n\n- All 41 statements in `migrations.py` are covered by the 4 tests. No untested branches.\n\n#### [Info] Error message includes original exception\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, lines 68-70\n- `raise RuntimeError(...) from exc` preserves the exception chain, making debugging easier. The message format `\"Migration to version {N} failed: {exc}\"` clearly identifies which migration failed. This follows the acceptance criterion for \"clear message.\"\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and minimal:\n\n- The `@register` decorator pattern is intuitive for defining migrations in order.\n- Transaction semantics are correctly handled: commit on success, rollback on failure.\n- The version update uses a parameterized query (`?` placeholder on line 63), avoiding SQL injection.\n- Logging at appropriate levels: `info` for migration steps and completion, `debug` for up-to-date status.\n- The code correctly handles the edge case where `current > target` (e.g., if migrations are removed), treating it the same as up-to-date.\n- 100% test coverage with all four required tests present and passing.\n\n**Verdict: APPROVE** -- no blocking issues. One medium finding (missing single-row constraint) noted for follow-up.\n\n---\n\n## Security Findings\n\n### [Medium] S1: `schema_version` table lacks row-count constraint\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- **Description**: The `schema_version` table has no mechanism to enforce that exactly one row exists. While the application code only writes through `_ensure_version_table` (which checks before inserting) and `migrate` (which uses `UPDATE`), a direct SQL injection in a future module or manual DB editing could insert additional rows, causing `get_version` to return an unpredictable value. This could lead to migrations being skipped or re-applied.\n- **Severity**: Medium (requires either a separate SQL injection vulnerability or direct DB access to exploit; impact is schema corruption)\n- **Recommendation**: In the V1 schema migration (Issue #4), alter or recreate the table with a single-row constraint, e.g., `CREATE TABLE schema_version (id INTEGER PRIMARY KEY CHECK (id = 1), version INTEGER NOT NULL)`.\n\n### [Info] S2: No SQL injection risk in migration runner\n\n- All SQL in `migrations.py` uses either hardcoded string literals or parameterized queries (`?` on line 63 for the version update). The `MigrationFn` type receives a `Connection` object, and it is the responsibility of each registered migration to use parameterized queries. This is correctly documented in the PR #4 review follow-up.\n\n### [Info] S3: Migration functions are trusted code\n\n- The `@register` decorator appends arbitrary callables to the migration list. Since migrations are defined at module import time by the application developer (not by user input), there is no injection risk. The registry is not exposed to any user-facing API.\n\n### [Info] S4: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `migrations.py` or `test_migrations.py`.\n\n### [Info] S5: No new dependencies introduced\n\n- This module uses only Python standard library (`sqlite3`, `logging`, `typing`). No new entries in `pyproject.toml` dependencies.\n\n### [Info] S6: Exception message does not leak sensitive data\n\n- The `RuntimeError` message on line 69 includes the migration version number and the string representation of the original exception. In this context (local SQLite, no user-supplied data in migration functions), this does not leak sensitive information. If migrations ever process user data, the exception wrapping should be reviewed to avoid leaking PII in logs.\n\n### Security Summary\n\nNo Critical or High severity findings. One Medium finding regarding the missing single-row constraint on `schema_version`, which could lead to schema version confusion if combined with a separate vulnerability that allows arbitrary SQL execution. The recommendation is to address this in the Issue #4 V1 schema migration.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Issue #4 (V1 schema)**: Add a single-row constraint to `schema_version` (e.g., `CHECK (id = 1)` on a primary key column) as part of the V1 migration to prevent version-table corruption.\n2. **Future**: Refactor `migrate()` to avoid redundant `_ensure_version_table` calls for minor performance improvement.\n3. **Future**: Consider adding a `--dry-run` mode to the migration runner that reports which migrations would be applied without executing them, useful for deployment verification.\n\n---\n\n# PR #8 Review Notes -- Issue #4: V1 schema migration -- projects, tasks, task_assignees, events\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/004-v1-schema`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `projects` table with `ux_projects_shared_name` and `ux_projects_private_owner_name` partial unique indexes | PASS | Table created on lines 18-26, indexes on lines 28-36 of `schema_v1.py`. Partial `WHERE` clauses match PRD exactly. |\n| `tasks` table with section and status CHECK constraints | PASS | Section CHECK on line 43 (`backlog, doing, waiting, done, drop`), status CHECK on line 45 (`open, done, dropped`). Both match PRD spec. |\n| `task_assignees` table with composite PK and secondary index | PASS | Composite `PRIMARY KEY (task_id, assignee_user_id)` on line 57, secondary index `ix_task_assignees_user` on lines 61-64. |\n| `events` audit table created | PASS | Table on lines 66-75. Columns match PRD. |\n| Shared `Inbox` project auto-created (INSERT OR IGNORE) | PASS | Line 78-81 uses `INSERT OR IGNORE` with `('Inbox', 'shared', NULL)`. |\n| `schema_version` = 1 after migration | PASS | Test `test_v1_schema_version` verifies `get_version(conn) == 1`. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_v1_tables_exist` | PASS -- verifies all four tables exist in `sqlite_master` |\n| `test_v1_inbox_created` | PASS -- verifies name='Inbox', visibility='shared', owner_user_id=None |\n| `test_v1_shared_unique_index_enforced` | PASS -- duplicate shared name raises `IntegrityError` |\n| `test_v1_private_unique_index_enforced` | PASS -- duplicate (owner, name) raises `IntegrityError`; different owner succeeds |\n\n### Findings\n\n#### [High] F1: Foreign keys not enforced -- `PRAGMA foreign_keys=ON` missing\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 35-37\n- **Description**: SQLite does not enforce `REFERENCES` (foreign key) clauses by default. The `PRAGMA foreign_keys=ON` must be executed on every new connection for FK constraints to be active. Without this, the `REFERENCES projects(id)` on `tasks.project_id` and `REFERENCES tasks(id)` on `task_assignees.task_id` are purely decorative -- you can insert tasks pointing to non-existent projects and assignees pointing to non-existent tasks.\n- **Impact**: Referential integrity is silently not enforced, leading to orphaned rows and data corruption.\n- **Fix applied**: Added `conn.execute(\"PRAGMA foreign_keys=ON;\")` to `get_connection()` in `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 38. All 19 tests pass after the fix.\n\n#### [Medium] F2: `schema_version` single-row constraint not added in V1\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- **Description**: The PR #6 review (Medium finding S1) recommended adding a single-row constraint to `schema_version` as part of the V1 migration. This was not addressed. The table still has no PK or CHECK constraint to prevent multiple rows.\n- **Action**: Should be addressed in a follow-up issue. Adding it retroactively in a later migration (e.g., V2) would require recreating the table since SQLite does not support `ALTER TABLE ADD CONSTRAINT`.\n\n#### [Low] F3: Minor PRD deviation on `events.ts` -- NOT NULL DEFAULT added\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/schema_v1.py`, line 69\n- **Description**: The PRD spec for `events.ts` says `ts TEXT` with no nullability or default constraint. The implementation adds `NOT NULL DEFAULT (datetime('now'))`. This is a sensible enhancement (audit timestamps should always be present), but it is a deviation from the spec.\n- **Action**: None needed. The implementation is better than the spec. Consider updating the PRD to match.\n\n#### [Low] F4: `events.id` uses AUTOINCREMENT, PRD says PK only\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/schema_v1.py`, line 68\n- **Description**: PRD says `id INTEGER PK` for the events table. The implementation uses `INTEGER PRIMARY KEY AUTOINCREMENT`. AUTOINCREMENT prevents rowid reuse after deletion, which is actually preferable for an audit log (guarantees monotonically increasing IDs). This is a minor deviation but a positive one.\n- **Action**: None needed. Consider updating the PRD.\n\n#### [Low] F5: No test for `task_assignees` composite PK enforcement\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_schema_v1.py`\n- **Description**: The acceptance criteria mention `task_assignees` table with composite PK, but there is no test verifying that inserting a duplicate `(task_id, assignee_user_id)` pair raises `IntegrityError`. The composite PK is created, but its enforcement is untested.\n- **Action**: Add a test in a follow-up to insert a duplicate pair and assert `IntegrityError`.\n\n#### [Low] F6: No test for foreign key enforcement\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_schema_v1.py`\n- **Description**: No test verifies that inserting a task with a non-existent `project_id` raises an error, or that inserting a `task_assignee` with a non-existent `task_id` raises an error. With the FK pragma fix (F1), these would now fail correctly, but there is no test coverage for this behavior.\n- **Action**: Add FK enforcement tests in a follow-up.\n\n#### [Info] F7: Test fixture pattern is well-structured\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_schema_v1.py`, lines 11-25\n- The `_load_v1_migration` autouse fixture correctly saves, clears, imports, and restores the migration registry. The `conn` fixture properly creates a temp DB, migrates, yields, and closes. This is clean test isolation.\n\n#### [Info] F8: CHECK constraint tests are thorough\n\n- Tests `test_v1_section_check_constraint` and `test_v1_status_check_constraint` go beyond the required tests to verify that invalid enum values are rejected. Good defensive testing.\n\n#### [Info] F9: 8 tests total for V1 schema, all passing\n\n- `test_v1_tables_exist`, `test_v1_schema_version`, `test_v1_inbox_created`, `test_v1_shared_unique_index_enforced`, `test_v1_private_unique_index_enforced`, `test_v1_section_check_constraint`, `test_v1_status_check_constraint` (7 tests in `test_schema_v1.py`). Plus the rollback test verifies `conn.rollback()` is correctly called after each constraint violation test.\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and closely follows the PRD spec:\n\n- All four tables are created with the correct columns, types, and constraints.\n- Partial unique indexes use the correct `WHERE` clause syntax.\n- CHECK constraints enumerate exactly the values specified in the PRD.\n- `INSERT OR IGNORE` for the Inbox seed is idempotent.\n- Parameterized queries are not needed here (all DDL uses string literals with no interpolation).\n- The `@register` decorator integrates seamlessly with the migration framework from Issue #3.\n- Test coverage is good, with 7 tests covering table existence, version, seed data, unique indexes, and CHECK constraints.\n\n**Verdict: APPROVE with one fix applied** -- the `PRAGMA foreign_keys=ON` fix (High, F1) has been applied directly. Medium/Low findings are noted for follow-up.\n\n---\n\n## Security Findings\n\n### [High] S1: Foreign key constraints not enforced (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 35-37\n- **Description**: Without `PRAGMA foreign_keys=ON`, all `REFERENCES` clauses in the V1 schema are ignored. This means a future command handler could insert tasks referencing non-existent projects or assignees referencing non-existent tasks, leading to data integrity violations that are silent and hard to debug. In a multi-user Slack plugin, this could allow one user's actions to create orphaned records that cause errors for other users.\n- **Severity**: High (data integrity violation in a multi-user context; silent failure mode)\n- **Fix**: Added `conn.execute(\"PRAGMA foreign_keys=ON;\")` to `get_connection()`. All 19 tests pass.\n\n### [Medium] S2: `schema_version` table remains unprotected against multi-row corruption\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- **Description**: Carried forward from PR #6 review. The `schema_version` table has no constraint preventing insertion of additional rows. If a separate vulnerability allows arbitrary SQL execution, an attacker could manipulate the schema version to skip or re-run migrations.\n- **Severity**: Medium (requires a chained vulnerability to exploit)\n- **Recommendation**: Address in a future migration that recreates the table with a single-row constraint.\n\n### [Info] S3: No SQL injection risk in V1 migration\n\n- All SQL in `schema_v1.py` uses hardcoded string literals. No user input, no string interpolation, no parameterized queries needed. The `INSERT OR IGNORE` for the Inbox seed uses literal values only.\n\n### [Info] S4: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `schema_v1.py` or `test_schema_v1.py`.\n\n### [Info] S5: No new dependencies introduced\n\n- The V1 migration uses only Python standard library (`sqlite3`, `logging`). No new entries in `pyproject.toml`.\n\n### [Info] S6: CHECK constraints provide defense-in-depth\n\n- The `section` and `status` CHECK constraints on the `tasks` table prevent invalid enum values at the database level, not just the application level. This is a security-positive pattern that prevents data corruption even if the application layer has a bug.\n\n### Security Summary\n\nOne High severity finding (S1: missing `PRAGMA foreign_keys=ON`) was identified and fixed directly in `db.py`. One Medium finding (S2: `schema_version` single-row constraint) is carried forward from the previous review. No Critical findings.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Test coverage**: Add tests for `task_assignees` composite PK enforcement (duplicate pair should raise `IntegrityError`).\n2. **Test coverage**: Add tests for foreign key enforcement (task with non-existent `project_id`, assignee with non-existent `task_id` should raise `IntegrityError` now that FK pragma is enabled).\n3. **Schema version constraint**: Address the `schema_version` single-row constraint in a future migration (V2 or later) by recreating the table with `CHECK (id = 1)`.\n4. **PRD sync**: Update PRD section 6.3 to add `NOT NULL DEFAULT (datetime('now'))` to `events.ts` and `AUTOINCREMENT` to `events.id` to match the implementation.\n5. **DB module**: Add a test for `PRAGMA foreign_keys` returning `1` in `test_db.py` to prevent regression.\n\n---\n\n# PR #10 Review Notes -- Issue #5: Command parser -- tokenizer and option extraction\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/005-parser-tokenizer`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `/p MyProject` correctly extracted; token consumed | PASS | `test_extract_project` verifies project name extracted, `/p` and value removed from `title_tokens`. |\n| `/s doing` validated; invalid section raises `ParseError` | PASS | `test_extract_section_valid` and `test_extract_section_invalid` cover both paths. Case-insensitive via `.lower()`. |\n| `due:03-15` normalised to `2026-03-15` (current year) | PASS | `test_due_mm_dd_normalisation` verifies with `date.today().year`. |\n| `due:2026-02-30` raises `ParseError` (invalid date) | PASS | `test_due_invalid_date` asserts `ParseError` with match on \"Invalid due date\". |\n| `<@U12345>` extracted into mentions list | PASS | `test_mentions_extraction` verifies two mentions extracted and not in `title_tokens`. |\n| Multiple mentions supported | PASS | Same test covers two mentions in order. |\n| Title tokens are non-option, non-mention tokens before first option | PASS | `test_title_extraction` verifies correct split with mixed options. Note: title tokens are collected from *all* positions, not just \"before first option\" -- this is arguably more flexible than the AC wording. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_extract_project` | PASS |\n| `test_extract_section_valid` | PASS |\n| `test_extract_section_invalid` | PASS |\n| `test_due_mm_dd_normalisation` | PASS |\n| `test_due_full_date` | PASS |\n| `test_due_invalid_date` | PASS |\n| `test_due_clear` | PASS |\n| `test_mentions_extraction` | PASS |\n| `test_title_extraction` | PASS |\n\nAll 9 required tests present and passing. 4 additional bonus tests (`test_command_extraction`, `test_move_extracts_id_as_arg`, `test_empty_command_raises`, `test_section_case_insensitive`). 13 parser tests total.\n\n### Findings\n\n#### [Medium] F1: Leap-year bug in `_normalise_due` for MM-DD format (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 53-62 (after fix)\n- **Description**: The original implementation used `datetime.strptime(raw, \"%m-%d\")` which defaults to year 1900 (not a leap year). This caused `due:02-29` to always be rejected, even when the current year is a leap year (e.g., 2028). The `replace(year=current_year)` call was never reached because `strptime` itself raised `ValueError`.\n- **Fix applied**: Replaced `strptime(\"%m-%d\")` with a regex match `(\\d{1,2})-(\\d{1,2})` followed by direct `date(current_year, month, day)` construction. This correctly validates Feb 29 against the actual current year.\n- **Impact**: Without fix, `due:02-29` would fail in leap years (2028, 2032, etc.) when it should succeed.\n\n#### [Low] F2: Duplicate options silently use \"last wins\" semantics\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 91-117\n- **Description**: If a user provides `/p First /p Second`, the parser silently uses `Second`. Same for `/s` and `due:`. This is not necessarily wrong, but it is undocumented. \"Last wins\" is a reasonable default, but \"first wins\" or \"raise error on duplicate\" are also valid choices.\n- **Action**: Document the \"last wins\" behavior in the docstring or PRD. No code change needed.\n\n#### [Low] F3: `/p` and `/s` error paths (missing argument) are untested\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_parser.py`\n- **Description**: Lines 93 and 101 (`raise ParseError(\"/p requires a project name\")` and `/s` equivalent) are uncovered. Manual testing confirmed they work correctly, but automated test coverage is missing for these edge cases.\n- **Action**: Add tests for `parse(\"add task /p\")` and `parse(\"add task /s\")` in a follow-up.\n\n#### [Low] F4: `_DUE_RE` uses `.+` which accepts any characters after `due:`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, line 15\n- **Description**: `_DUE_RE = re.compile(r\"^due:(.+)$\")` will match `due:anything` and pass the value to `_normalise_due`. This is not a bug since `_normalise_due` properly validates the value, but a tighter regex like `r\"^due:([\\d-]+)$\"` would reject obviously invalid inputs earlier and serve as documentation of expected format.\n- **Action**: Optional tightening. Not blocking since validation is correct.\n\n#### [Low] F5: Title tokens are collected from all positions, not just \"before first option\"\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 126-128\n- **Description**: The AC says \"Title tokens are non-option, non-mention tokens before first option.\" The implementation collects title tokens from all positions (e.g., `add Buy /p Home milk` would produce `title_tokens=[\"Buy\", \"milk\"]`). This is actually more flexible and user-friendly, but deviates from the literal AC wording.\n- **Action**: Consider updating the AC to match the implementation. The current behavior is better for UX.\n\n#### [Info] F6: `args` extraction for `move/done/drop/edit` is well-designed\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 130-133\n- The pattern of extracting the first title token as `args[0]` for ID-based commands is clean and tested by `test_move_extracts_id_as_arg`.\n\n#### [Info] F7: Coverage at 97%\n\n- Lines 93 and 101 (error paths for missing `/p` and `/s` arguments) are uncovered. All other branches are tested. This is acceptable for M1.\n\n#### [Info] F8: Bonus tests add good defensive coverage\n\n- `test_section_case_insensitive` ensures `/s DOING` normalizes to `doing`.\n- `test_command_extraction` verifies the first token becomes the command.\n- `test_empty_command_raises` covers the empty input guard.\n- `test_move_extracts_id_as_arg` covers the args extraction logic.\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and well-structured:\n\n- The tokenizer loop with explicit index management (`while i < len(remaining)`) is readable and handles two-token options (`/p`, `/s`) cleanly by advancing `i` by 2.\n- `ParsedCommand` dataclass provides a clear, typed result structure.\n- `VALID_SECTIONS` as a `frozenset` is the right choice for O(1) membership testing.\n- `_MENTION_RE` uses `fullmatch` (not `match` or `search`), preventing partial matches on tokens like `<@U123>extra`.\n- Error messages are descriptive and include the invalid value with `repr()` formatting.\n- Logging at debug level for parsed results is appropriate.\n- 97% test coverage with all 9 required tests present and 4 bonus tests.\n\n**Verdict: APPROVE with one fix applied** -- the leap-year bug in `_normalise_due` (Medium, F1) has been fixed directly. Low findings are noted for follow-up.\n\n---\n\n## Security Findings\n\n### [Medium] S1: Leap-year date validation bypass (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, `_normalise_due`\n- **Description**: The original `strptime(\"%m-%d\")` approach silently rejected valid dates (`02-29` in leap years) due to the 1900 default year. While this is a correctness issue rather than a security vulnerability, incorrect date validation can lead to denial of service (users unable to set valid due dates) and data integrity issues (dates that should be accepted are rejected).\n- **Severity**: Medium (correctness bug with functional impact)\n- **Fix**: Replaced with regex-based month/day extraction and direct `date()` construction with the current year.\n\n### [Low] S2: No ReDoS risk in compiled regexes\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 14-15\n- **Description**: Both `_MENTION_RE = re.compile(r\"<@(U[A-Z0-9]+)>\")` and `_DUE_RE = re.compile(r\"^due:(.+)$\")` were tested with 100,000-character inputs and completed in under 0.1ms. Neither pattern contains nested quantifiers or alternation that could cause catastrophic backtracking.\n- **Severity**: Low (no risk found, noting for completeness)\n\n### [Low] S3: No input length validation on parser input\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, line 72\n- **Description**: `parse(text)` accepts arbitrarily long strings. `text.strip().split()` will allocate a token list proportional to input size. Slack limits messages to ~40,000 characters, mitigating this at the transport layer, but if the parser is used outside Slack, extremely long inputs could cause memory pressure.\n- **Severity**: Low (mitigated by Slack transport layer limits)\n- **Recommendation**: Consider adding a max-length guard in the plugin entry point (`handle_message`) rather than the parser itself.\n\n### [Info] S4: No injection risks\n\n- The parser only tokenizes and validates strings. No SQL, no shell commands, no template rendering. User input flows into `ParsedCommand` fields which are plain strings. Security depends on how these values are consumed downstream (e.g., parameterized queries when writing to SQLite).\n\n### [Info] S5: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `parser.py` or `test_parser.py`.\n\n### [Info] S6: No new dependencies introduced\n\n- The parser uses only Python standard library (`re`, `datetime`, `dataclasses`, `logging`). No new entries in `pyproject.toml`.\n\n### Security Summary\n\nNo Critical or High severity findings. One Medium finding (S1: leap-year date validation) was identified and fixed. The parser has a minimal attack surface -- it tokenizes strings and validates against known patterns. The main security consideration going forward is ensuring that `ParsedCommand` field values are used safely downstream (parameterized SQL queries, no raw echo in web contexts).\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Test coverage**: Add tests for `/p` and `/s` without arguments (lines 93, 101) to cover the missing-argument error paths.\n2. **Documentation**: Document \"last wins\" semantics for duplicate `/p`, `/s`, and `due:` options in the PRD or parser docstring.\n3. **Optional**: Tighten `_DUE_RE` from `.+` to `[\\d-]+` for earlier rejection of obviously invalid due values.\n4. **AC clarification**: Update Issue #5 AC to reflect that title tokens are collected from all positions (not just \"before first option\"), matching the implemented behavior.\n\n---\n\n# PR #12 Review Notes -- Issue #7: Project resolver helper\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/007-project-resolver`\n# PR #14 Review Notes -- Issue #16: Command dispatcher and routing\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature-016-dispatcher`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| Private project of sender matched first | PASS | Query on line 38-42 filters by `visibility = 'private' AND owner_user_id = ?`. Test `test_private_takes_priority` verifies. |\n| Falls back to shared if no private match | PASS | Second query on line 52-56 filters by `visibility = 'shared'`. Test `test_falls_back_to_shared` verifies. |\n| Returns error when neither exists (except Inbox auto-created) | PASS | `ProjectNotFoundError` raised on line 84. Inbox auto-created on lines 66-81. Tests `test_unknown_project_error` and `test_inbox_auto_created` verify. |\n| Returns project row with id, name, visibility, owner_user_id | PASS | `Project` dataclass on lines 17-23 with all four fields. All tests assert on these fields. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_private_takes_priority` | PASS -- creates both shared and private \"Work\", verifies private is returned for owner U1 |\n| `test_falls_back_to_shared` | PASS -- creates shared \"Team\" only, verifies shared returned for U1 |\n| `test_inbox_auto_created` | PASS -- deletes seeded Inbox, verifies auto-creation as shared with null owner |\n| `test_unknown_project_error` | PASS -- verifies `ProjectNotFoundError` raised with descriptive message |\n\nAll 4 required tests present and passing. 2 additional bonus tests (`test_inbox_already_exists`, `test_private_different_owner_not_matched`). 6 tests total.\n\n### Findings\n\n#### [Low] F1: Project name matching is case-sensitive\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 39-42\n- **Description**: The SQL queries use `WHERE name = ?` which is case-sensitive in SQLite by default (for ASCII). If a user types `/p work` but the project is named `Work`, it will not match. The PRD does not specify case-sensitivity behavior, so this is not a bug per se, but it could cause user confusion.\n- **Action**: Document the case-sensitive behavior. Consider adding `COLLATE NOCASE` in a future iteration if case-insensitive matching is desired.\n\n#### [Low] F2: Repeated `Project(id=row[0], ...)` construction pattern\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 44, 58, 76\n- **Description**: The same `Project(id=row[0], name=row[1], visibility=row[2], owner_user_id=row[3])` pattern appears three times. This could be extracted to a helper (e.g., `Project._from_row(row)` classmethod or a module-level `_row_to_project` function) to reduce duplication and ensure consistency if columns change.\n- **Action**: Optional refactor. Not blocking for M1.\n\n#### [Low] F3: `conn.commit()` called inside resolver for Inbox auto-creation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, line 71\n- **Description**: The resolver calls `conn.commit()` directly after the `INSERT OR IGNORE` for Inbox auto-creation. This commits any pending transaction state on the connection, which could be surprising if the caller has uncommitted changes. In the current codebase this is not an issue (resolver is called early in command handling), but it couples the resolver to transaction management.\n- **Action**: Consider whether the caller should be responsible for committing. For M1 this is acceptable since the auto-creation is a one-time idempotent operation.\n\n#### [Low] F4: No test for Inbox auto-creation when a private Inbox exists\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/tests/test_project_resolver.py`\n- **Description**: If a user has a private project named \"Inbox\", `resolve_project(conn, \"Inbox\", user_id)` will return the private project (step 1 matches). The auto-creation path (step 3) is only reached if neither private nor shared \"Inbox\" exists. This behavior is correct per the resolution order, but there is no test covering the scenario where a user has a private \"Inbox\" and the shared \"Inbox\" also exists -- the test should verify that the private one is returned.\n- **Action**: Add a test for this edge case in a follow-up.\n\n#### [Info] F5: `INSERT OR IGNORE` is the correct pattern for Inbox auto-creation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 67-70\n- `INSERT OR IGNORE` handles the race condition where two concurrent requests try to auto-create Inbox simultaneously. The `ux_projects_shared_name` unique index on `(name) WHERE visibility = 'shared'` ensures only one shared Inbox can exist. The subsequent `SELECT` on lines 72-75 guarantees we return the correct row regardless of whether this request or another one performed the insert. This is well-designed.\n\n#### [Info] F6: Bonus tests add good defensive coverage\n\n- `test_inbox_already_exists` verifies that the seeded Inbox (from V1 migration) resolves without triggering auto-creation.\n- `test_private_different_owner_not_matched` verifies that a private project owned by U2 is not visible to U1, correctly raising `ProjectNotFoundError`.\n\n#### [Info] F7: Coverage at 100%\n\n- All 31 statements in `project_resolver.py` are covered by the 6 tests. No untested branches.\n\n#### [Info] F8: Test fixture pattern is consistent with prior PRs\n\n- The `_load_v1` autouse fixture and `conn` fixture follow the same save-clear-restore pattern established in prior PRs. Good consistency.\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and follows the PRD resolution order exactly:\n\n- Three-step resolution (private -> shared -> Inbox auto-create) with clear fallthrough logic.\n- All SQL queries use parameterized placeholders (`?`), preventing SQL injection.\n- `Project` dataclass provides a typed result with the four required fields.\n- `ProjectNotFoundError` is a well-named custom exception with descriptive message.\n- Logging at debug level for each resolution path aids troubleshooting.\n- `INSERT OR IGNORE` handles concurrent Inbox auto-creation safely.\n- 100% test coverage with all 4 required tests and 2 valuable bonus tests.\n- The code is 85 lines total -- minimal and readable.\n\n**Verdict: APPROVE** -- no Critical or High findings. All Low findings are noted for follow-up.\n### Changed Files\n\n| File | Change | Lines |\n|------|--------|-------|\n| `src/openclaw_todo/dispatcher.py` | NEW | 116 |\n| `src/openclaw_todo/plugin.py` | MODIFIED | 33 |\n| `tests/test_dispatcher.py` | NEW | 152 |\n| `tests/test_plugin.py` | MODIFIED | 39 |\n\n### Architecture Overview\n\nThe dispatcher implements a two-level routing architecture:\n\n1. **Plugin layer** (`plugin.py`): Strips `/todo` prefix, returns USAGE for bare `/todo`, delegates remainder to `dispatch()`.\n2. **Dispatcher layer** (`dispatcher.py`): Parses the remainder via the parser, validates command name against `_VALID_COMMANDS`, opens a DB connection with migration, routes to the appropriate handler (or stub), and closes the connection in a `finally` block.\n3. **Project sub-routing**: `project` command delegates to `_dispatch_project()` which extracts the subcommand from `parsed.title_tokens` and routes to `project_<subcommand>` handlers in the registry.\n\n### Findings\n\n#### [Low] F1: Weak test assertion on stub handler (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/tests/test_dispatcher.py`, line 48\n- **Description**: The original assertion was:\n  ```python\n  assert \"not yet implemented\" in result.lower() or isinstance(result, str)\n  ```\n  The `isinstance(result, str)` clause makes this trivially true since `dispatch()` always returns `str`. The test does not actually verify that the stub handler was invoked -- any string return would pass.\n- **Fix applied**: Removed the `or isinstance(result, str)` fallback. The assertion now strictly verifies that the stub handler message is present:\n  ```python\n  assert \"not yet implemented\" in result.lower()\n  ```\n- **Impact**: Test now correctly fails if the stub handler message format changes or if a different code path is taken.\n\n#### [Low] F2: `_stub_handler` signature differs from `HandlerFn` type alias\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 17, 47\n- **Description**: The `HandlerFn` type alias is `Callable[[ParsedCommand, Connection, dict], str]` (3 args), but `_stub_handler` takes 4 args: `(command, parsed, conn, context)`. This works because `_stub_handler` is never registered directly in `_handlers` -- it is always called via a lambda wrapper in `_get_handler` (line 59) and `_dispatch_project` (line 115) that captures `command` via closure. However, the mismatch makes the code harder to follow at a glance.\n- **Action**: Consider refactoring `_stub_handler` to accept `(parsed, conn, context)` and derive the command name from `parsed.command`. Not blocking since the current approach is correct.\n\n#### [Low] F3: Long line in `_dispatch_project`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 115\n- **Description**: Line 115 is 116 characters, exceeding typical line length limits (88 for black, 100 for many projects). The lambda + `_handlers.get` + `_stub_handler` call is dense.\n- **Action**: Consider breaking into multiple lines for readability. Not blocking.\n\n#### [Low] F4: Global mutable `_handlers` dict shared across tests\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 54\n- **Description**: The `_handlers` dict is module-level mutable state. The test fixture `_clean_handlers` (test file line 22-28) correctly saves and restores it between tests. However, if the test suite were run in parallel (e.g., `pytest-xdist`), the shared state could cause flaky tests.\n- **Action**: For a single-process Slack plugin this is fine. Document the limitation if parallel test execution is ever introduced.\n\n#### [Info] F5: DB connection lifecycle is correct\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 86-94\n- The `dispatch()` function opens the DB connection *after* validating the command name (line 80-82 returns early for unknown commands without touching the DB). The connection is always closed in a `finally` block (line 94), ensuring no leaks even if handlers raise exceptions. This is good resource management.\n\n#### [Info] F6: Unknown commands do not open a DB connection\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 80-82\n- The `if command not in _VALID_COMMANDS` check returns before `_init_db()` is called. This avoids unnecessary DB initialization for typos and invalid commands. Good design.\n\n#### [Info] F7: Parse errors are caught and returned as user-facing messages\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 73-76\n- `ParseError` is caught and formatted as `f\"Parse error: {exc}\"`. The parser's error messages are descriptive (e.g., \"Invalid section: 'xyz'\") and do not leak internal details. This is appropriate for a Slack DM context.\n\n#### [Info] F8: Plugin entry-point correctly wired to dispatcher\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/plugin.py`\n- The `handle_message()` function now delegates to `dispatch()` instead of the previous placeholder response. The prefix matching logic is unchanged and still correct. The `db_path` parameter flows through to `dispatch()` for testability.\n\n#### [Info] F9: Schema import triggers migration registration\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 14\n- `import openclaw_todo.schema_v1 as _schema_v1` with `# noqa: F401` ensures the `@register` decorator in `schema_v1.py` runs at import time, populating the migration registry before any `migrate()` call. This is the correct pattern for the decorator-based migration system.\n\n#### [Info] F10: Test coverage is comprehensive\n\n- 20 dispatcher + plugin tests covering:\n  - All 7 non-project commands routed to stubs (parametrized)\n  - Custom handler registration and invocation\n  - All 3 project subcommands routed correctly\n  - Project with no subcommand returns usage\n  - Unknown project subcommand returns error\n  - Unknown top-level command returns error with usage\n  - Parse error propagation\n  - DB initialization with schema migration\n  - Plugin prefix matching (non-todo, todo, whitespace, bare /todo)\n\n### Code Quality Summary\n\nThe dispatcher implementation is clean, well-structured, and follows good design principles:\n\n- **Separation of concerns**: Plugin handles prefix matching; dispatcher handles parsing, validation, DB init, and routing. Each has a single responsibility.\n- **Resource safety**: DB connection opened late (only for valid commands) and closed in `finally`.\n- **Extensibility**: The `register_handler()` function provides a clean API for future command implementations to plug in without modifying the dispatcher.\n- **Defensive routing**: Unknown commands and parse errors return helpful user-facing messages without touching the DB or raising unhandled exceptions.\n- **Project sub-routing**: The `project_<subcommand>` naming convention with `replace('-', '_')` is a clean pattern for hyphenated subcommands.\n- **Test isolation**: The `_clean_handlers` autouse fixture properly saves and restores the handler registry between tests.\n\n**Verdict: APPROVE with one fix applied** -- the weak test assertion (Low, F1) has been strengthened. No Critical or High code quality issues found.\n\n---\n\n## Security Findings\n\n### [Low] S1: No SQL injection risk -- parameterized queries used throughout\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 38-42, 52-56\n- **Description**: All SQL queries use `?` parameter placeholders for user-supplied values (`name` and `sender_id`). The Inbox auto-creation on lines 67-75 uses hardcoded string literals only. No string interpolation or f-strings are used in any SQL statement.\n- **Severity**: Low (no risk found, noting for completeness)\n\n### [Low] S2: `name` parameter is not length-validated\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, line 27\n- **Description**: `resolve_project(conn, name, sender_id)` accepts arbitrarily long `name` strings. While SQLite handles this safely (TEXT has no inherent length limit), an extremely long name would result in unnecessary query execution against the database. The parser upstream (Issue #5) extracts project names from `/p <name>` tokens, and Slack limits message length to ~40,000 characters, providing transport-layer mitigation.\n- **Severity**: Low (mitigated by upstream constraints)\n- **Recommendation**: Consider adding a max-length check for project names in the parser or a future validation layer.\n\n### [Low] S3: Inbox auto-creation commits transaction implicitly\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, line 71\n- **Description**: `conn.commit()` inside the resolver commits all pending changes on the connection, not just the Inbox insert. If a future caller has uncommitted writes before calling `resolve_project`, those writes would be committed as a side effect. This is not exploitable but could lead to partial commits in error scenarios.\n- **Severity**: Low (no current exploit path; architectural concern)\n- **Recommendation**: Consider using a savepoint pattern (`SAVEPOINT` / `RELEASE`) for the Inbox auto-creation to isolate its transaction from any outer transaction.\n\n### [Info] S4: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `project_resolver.py` or `test_project_resolver.py`.\n\n### [Info] S5: No new dependencies introduced\n\n- The module uses only Python standard library (`sqlite3`, `dataclasses`, `logging`). No new entries in `pyproject.toml`.\n\n### [Info] S6: Authorization model is correctly scoped\n\n- The `sender_id` parameter is used correctly in the private-project query to scope visibility. User U1 cannot resolve another user's private projects. Test `test_private_different_owner_not_matched` explicitly verifies this isolation. The shared-project query correctly omits owner filtering, as shared projects are visible to all users.\n\n### Security Summary\n\nNo Critical, High, or Medium severity findings. The implementation has a minimal attack surface -- three read queries and one idempotent insert, all using parameterized queries. The authorization model (private scoped to sender, shared visible to all) is correctly implemented and tested. Three Low findings are noted for awareness but require no immediate action.\n### [Low] S1: User input reflected in error messages\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 76, 82, 110\n- **Description**: Three error paths echo user-supplied values back in responses:\n  - `f\"Parse error: {exc}\"` (line 76) -- parser error messages may contain raw user input\n  - `f\"Unknown command: '{command}'\\n{USAGE}\"` (line 82) -- the command name is user input\n  - `f\"Unknown project subcommand: '{sub}'\\n{PROJECT_USAGE}\"` (line 110) -- the subcommand is user input\n- **Severity**: Low. In the Slack DM context, Slack handles message escaping. The reflected values are single tokens (no spaces, limited characters after `split()` tokenization). No HTML/JS injection is possible in this context.\n- **Recommendation**: If the plugin ever serves responses in a web context (e.g., dashboard, webhook response viewer), sanitize reflected values. No fix needed for current Slack-only usage.\n\n### [Low] S2: No input length validation at dispatcher level\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 67\n- **Description**: `dispatch(text, ...)` accepts arbitrarily long strings, which flow to `parse()` for tokenization. Slack limits messages to approximately 40,000 characters, providing transport-layer mitigation.\n- **Severity**: Low (mitigated by Slack transport layer)\n- **Recommendation**: Consider adding a max-length guard in `handle_message()` if the plugin is ever exposed outside Slack.\n\n### [Low] S3: Handler exception propagation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 91-92\n- **Description**: If a registered handler raises an unhandled exception, it propagates up through `dispatch()`. The `finally` block ensures the DB connection is closed, but the exception itself is not caught. In the current architecture, the caller (`handle_message` in `plugin.py`) does not catch exceptions either, so an unhandled handler error would propagate to the gateway framework.\n- **Severity**: Low. The stub handlers cannot raise exceptions (they return strings). Future handler implementations should handle their own errors. A catch-all `except Exception` in `dispatch()` could provide defense-in-depth but would also mask bugs during development.\n- **Recommendation**: Consider adding a top-level exception handler in `dispatch()` that logs the error and returns a generic \"Internal error\" message, once real handlers are implemented. During development, letting exceptions propagate is acceptable.\n\n### [Info] S4: No SQL injection risk\n\n- The dispatcher does not execute any SQL directly. DB interaction is limited to `_init_db()` which calls `get_connection()` and `migrate()` -- both use hardcoded SQL or parameterized queries. User input flows through `ParsedCommand` fields to handlers, which are responsible for using parameterized queries.\n\n### [Info] S5: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `dispatcher.py`, `plugin.py`, or their test files.\n\n### [Info] S6: `db_path` parameter is configuration-controlled\n\n- The `db_path` parameter in `dispatch()` and `handle_message()` flows from the caller (gateway framework), not from user input. In tests, it comes from `tmp_path`. There is no code path where a user's message text influences the DB path.\n\n### [Info] S7: No new dependencies introduced\n\n- The dispatcher uses only Python standard library (`sqlite3`, `logging`, `typing`) plus internal modules (`db`, `migrations`, `parser`, `schema_v1`). No new entries in `pyproject.toml`.\n\n### Security Summary\n\nNo Critical or High severity findings. Three Low findings related to input reflection, length validation, and exception propagation are noted. The dispatcher has a minimal attack surface -- it validates commands against a whitelist, delegates parsing to the parser, and routes to registered handlers. The main security consideration for future work is ensuring that handler implementations use parameterized queries and handle their own exceptions gracefully.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Refactor**: Extract `Project(id=row[0], ...)` into a `_row_to_project(row)` helper or `Project.from_row(row)` classmethod to reduce the triple duplication.\n2. **Test coverage**: Add a test for the edge case where a user has a private \"Inbox\" project and the shared \"Inbox\" also exists, verifying the private one is returned.\n3. **Transaction safety**: Consider using `SAVEPOINT` / `RELEASE` for Inbox auto-creation instead of bare `conn.commit()` to avoid committing unrelated pending changes.\n4. **Case sensitivity**: Document that project name matching is case-sensitive. Consider `COLLATE NOCASE` if case-insensitive matching is desired in a future iteration.\n5. **Input validation**: Add a max-length check for project names in the parser or validation layer to prevent unnecessarily large queries.\n1. **Exception handling**: Add a top-level `try/except` in `dispatch()` that catches unexpected handler exceptions, logs them at error level, and returns a generic user-facing error message. Defer until real handlers are implemented.\n2. **Refactor `_stub_handler`**: Align `_stub_handler` signature with `HandlerFn` type alias by deriving the command name from `parsed.command` instead of passing it as a separate argument. This also eliminates the lambda wrappers in `_get_handler` and `_dispatch_project`.\n3. **Line length**: Break the long line 115 in `_dispatch_project` for readability.\n4. **Context typing**: Introduce a `TypedDict` or dataclass for the `context` parameter (e.g., `class DispatchContext(TypedDict): sender_id: str`) to enable static type checking.\n5. **Input length guard**: Add a max-length check (e.g., 5000 chars) in `handle_message()` as defense-in-depth against oversized inputs.\n\n---\n\n# PR #16 Review Notes -- Issue #17: Permission helper module\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature-017-permissions`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `can_write_task(conn, task_id, sender_id) -> bool` exists | PASS | Function defined on line 11 of `permissions.py` with correct signature. |\n| Private project: only owner can write | PASS | Lines 34-40 check `sender_id == owner_user_id` when `visibility == \"private\"`. Tests `test_private_owner_can_write` and `test_private_non_owner_rejected` verify. |\n| Shared project: assignee or creator can write | PASS | Lines 43-60 check creator first, then query `task_assignees`. Tests `test_shared_assignee_can_write`, `test_shared_creator_can_write`, and `test_shared_unrelated_rejected` verify. |\n| Nonexistent task returns False | PASS | Lines 28-29 return `False` when row is None. Test `test_nonexistent_task` verifies. |\n| `validate_private_assignees(visibility, assignees, owner_id) -> str or None` exists | PASS | Function defined on line 63 with correct signature. |\n| Returns warning for non-owner assignees on private project | PASS | Lines 75-81. Test `test_validate_private_assignees_warning` verifies. |\n| Returns None for shared projects | PASS | Lines 72-73. Test `test_shared_always_ok` verifies. |\n| Returns None when all assignees are the owner | PASS | Lines 76-77. Test `test_private_all_owner_ok` verifies. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_private_owner_can_write` | PASS |\n| `test_private_non_owner_rejected` | PASS |\n| `test_shared_assignee_can_write` | PASS |\n| `test_shared_creator_can_write` | PASS |\n| `test_shared_unrelated_rejected` | PASS |\n| `test_nonexistent_task` | PASS |\n| `test_validate_private_assignees_warning` | PASS |\n| `test_private_all_owner_ok` | PASS |\n| `test_shared_always_ok` | PASS |\n| `test_private_empty_assignees_ok` | PASS |\n\nAll 10 tests present and passing. 48 tests total in the suite.\n\n### Findings\n\n#### [Medium] F1: Shared project owner cannot modify tasks they did not create or get assigned to — CONFIRMED INTENTIONAL\n\n- **Description**: In a shared project, only the task creator and assignees are allowed to write. The project owner has no special privileges. User confirmed this is intentional: only task creator and assignees should have task write access.\n- **Status**: CLOSED as intentional design.\n\n#### [Low] F2: `validate_private_assignees` with `owner_id=None` marks all assignees as non-owner\n\n- **Description**: When `owner_id` is `None` on a private project (data integrity issue), all assignees would be flagged as non-owner. Function short-circuits for shared projects, so this only affects corrupted data.\n- **Status**: OPEN, non-blocking.\n\n#### [Low] F3: No test for shared project where sender is both creator and assignee — FIXED\n\n- **Description**: Added `test_shared_creator_and_assignee_can_write` in commit 594cad4. Creator short-circuit handles this correctly.\n- **Status**: FIXED.\n\n#### [Low] F4: `_create_project` helper uses complex SELECT instead of `last_insert_rowid()`\n\n- **Status**: OPEN, non-blocking.\n\n### Code Quality Summary\n\n**Verdict: APPROVE** -- no Critical or High findings. F1 confirmed intentional, F3 fixed.\n\n---\n\n## Security Findings\n\n<<<<<<< HEAD\n### [Info] S1: SQL injection -- No risk\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-78\n- **Description**: All three SQL statements (task INSERT, assignee INSERT, event INSERT) use `?` parameter placeholders. No string interpolation or f-strings in SQL. Title, project_id, section, due, sender_id, and assignee values are all passed as parameters.\n- **Severity**: Info (no risk found)\n\n### [Info] S2: Authorization model is sound\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 41-49\n- **Description**: Private project constraint correctly checks that all assignees match the project owner. The `resolve_project()` function provides implicit access control by only resolving the sender's own private projects (scoped by `owner_user_id = sender_id` in the SQL query). A non-owner sender cannot resolve another user's private project by name. The explicit assignee check in `cmd_add.py` is an additional layer for when the owner assigns tasks to others within their private project.\n- **Severity**: Info (no bypass possible)\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in any changed files.\n\n### [Info] S4: No new dependencies introduced\n\n- `cmd_add.py` uses only standard library (`json`, `logging`, `sqlite3`) plus internal modules (`parser`, `project_resolver`). No new entries in `pyproject.toml`.\n\n### [Info] S5: Input validation adequate\n\n- Empty title returns error (line 25-26).\n- Non-existent project returns error via `ProjectNotFoundError` (lines 30-33).\n- Section validation handled by parser upstream (`VALID_SECTIONS` check).\n- Due date validation handled by parser upstream (`_normalise_due`).\n- Mention format constrained by parser regex (`<@U[A-Z0-9]+>`).\n\n### Security Summary\n\nNo Critical, High, Medium, or Low severity findings. The implementation has a minimal attack surface -- three parameterized INSERT statements, project resolution with sender-scoped authorization, and input validation at both the parser and handler layers. The code is secure for the current Slack DM context.\n\n---\n\n## Follow-up Items\n\n1. **Test coverage**: Add a test for non-owner sender attempting to add a task to another user's private project (should get `ProjectNotFoundError` via resolver).\n2. **Transaction explicitness**: Consider wrapping the three DB writes in `with conn:` for explicit transaction semantics.\n3. **Title length**: Consider adding a max-length validation (e.g., 500 chars) as defense-in-depth.\n4. **Permissions module**: When Issue #17 (permissions helper) is merged, consider extracting the inline private-assignee validation to use the shared `validate_private_assignees()` function.\n=======\nNo Critical, High, or Medium severity security findings. All SQL parameterized. Fail-closed design. Three Low findings noted for awareness.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Defensive guard**: Consider adding a log warning in `validate_private_assignees` when `visibility == \"private\"` and `owner_id is None`.\n2. **Test consistency**: Align `_create_project` helper to use `last_insert_rowid()` like `_create_task`.\n\n---\n\n## Review Pass 2\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Commit range: ff87515..594cad4\n\n### Purpose\n\nSecond review pass to verify the F3 fix (commit 594cad4) and confirm no remaining Critical/High issues.\n\n### F3 Fix Verification: `test_shared_creator_and_assignee_can_write`\n\n- **Status**: VERIFIED CORRECT\n- The test creates a shared project, a task where `U_BOTH` is the creator, assigns `U_BOTH` as an assignee, and asserts `can_write_task` returns `True`.\n- This exercises the creator short-circuit path, which returns `True` before the assignee query is reached.\n\n### Prior Findings Status\n\n| Finding | Severity | Status |\n|---------|----------|--------|\n| F1: Shared project owner has no implicit write | Medium | CLOSED -- Confirmed intentional by user. |\n| F2: `validate_private_assignees` with `owner_id=None` | Low | OPEN -- non-blocking. |\n| F3: Missing creator+assignee overlap test | Low | FIXED in 594cad4. Verified correct. |\n| F4: `_create_project` helper uses complex SELECT | Low | OPEN -- non-blocking. |\n\n### Verdict\n\n**APPROVE -- ready to merge.** All 49 tests pass. No Critical or High issues.\n>>>>>>> origin/main\n", "structuredPatch": [{"oldStart": 1016, "oldLines": 7, "newStart": 1016, "newLines": 100, "lines": [" ", " ## Security Findings", " ", "-<<<<<<< HEAD", "+No Critical, High, or Medium severity security findings. All SQL parameterized. Fail-closed design. Three Low findings noted for awareness.", "+", "+---", "+", "+## Follow-up Issues (proposed)", "+", "+1. **Defensive guard**: Consider adding a log warning in `validate_private_assignees` when `visibility == \"private\"` and `owner_id is None`.", "+2. **Test consistency**: Align `_create_project` helper to use `last_insert_rowid()` like `_create_task`.", "+", "+---", "+", "+# PR #18 Review Notes -- Issue #6: /todo add command", "+", "+> Reviewer: Claude Opus 4.6 (automated review)", "+> Date: 2026-02-20", "+> Branch: `feature/006-cmd-add`", "+", "+---", "+", "+## Code Review", "+", "+### Acceptance Criteria Checklist", "+", "+| Criterion | Status | Notes |", "+|-----------|--------|-------|", "+| Task inserted with correct project_id, section, due, status='open', created_by | PASS | `test_add_default_inbox` and `test_add_with_project_section_due` verify all fields in DB |", "+| Assignees default to sender when no mentions | PASS | `test_add_assignee_defaults_to_sender` verifies `task_assignees` row matches sender |", "+| Multiple mentions create multiple task_assignee rows | PASS | `test_add_multiple_assignees` verifies two rows inserted and present in response |", "+| Private project + non-owner assignee returns warning and does NOT insert | PASS | `test_add_private_rejects_other_assignee` verifies warning message and zero task rows |", "+| Non-existent project: `Inbox` auto-created; others return error | PASS | `test_add_default_inbox` uses seeded Inbox; `test_add_nonexistent_project_returns_error` verifies error |", "+| Response format: `Added #<id> (<project>/<section>) due:<due\\|-> assignees:<mentions> -- <title>` | PASS | All happy-path tests assert on this format |", "+| Event row written to `events` table | PASS | `test_event_logged` verifies actor, action, task_id, and JSON payload fields |", "+", "+### Required Tests", "+", "+| Test | Status |", "+|------|--------|", "+| `test_add_default_inbox` | PASS |", "+| `test_add_with_project_section_due` | PASS |", "+| `test_add_private_rejects_other_assignee` | PASS |", "+| `test_add_assignee_defaults_to_sender` | PASS |", "+| `test_add_multiple_assignees` | PASS |", "+", "+All 5 required tests present and passing. 5 additional tests (`test_add_private_allows_owner_assignee`, `test_event_logged`, `test_add_empty_title_returns_error`, `test_add_nonexistent_project_returns_error`, `test_add_due_clear_sentinel_stored_as_null`). 10 tests total.", "+", "+### Findings", "+", "+#### [Info] F1: No explicit transaction wrapping for multi-statement write", "+", "+- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-80", "+- **Description**: The handler performs three sequential writes (task INSERT, assignee INSERTs, event INSERT) followed by a single `conn.commit()` at line 80. If any write after the task INSERT raises (e.g., duplicate assignee PK violation), partial writes remain uncommitted. SQLite's implicit rollback-on-close in the dispatcher's `finally` block protects data integrity.", "+- **Action**: Consider wrapping in `with conn:` (context manager) for explicit transaction semantics in a future refactor. No functional bug today.", "+", "+#### [Info] F2: Missing `sender_id` key would raise unhandled KeyError", "+", "+- **File**: `src/openclaw_todo/cmd_add.py`, line 22", "+- **Description**: `context[\"sender_id\"]` raises `KeyError` if the key is absent. The dispatcher contract requires `sender_id` in context, so this is defensive-coding territory.", "+- **Action**: Acceptable. Could be improved with `.get()` + early return, but low priority given the documented contract.", "+", "+#### [Info] F3: Test gap -- non-owner sender adding to another user's private project", "+", "+- **File**: `tests/test_cmd_add.py`", "+- **Description**: No test covers the case where sender U2 tries to add a task to a private project owned by U1. The `resolve_project()` function would return `ProjectNotFoundError` (it only matches private projects of the sender), which is correct behavior. However, there is no explicit test verifying this path through `add_handler`.", "+- **Action**: Follow-up item. Add a test for \"non-owner sender cannot resolve another user's private project.\"", "+", "+#### [Info] F4: Title length is unbounded", "+", "+- **File**: `src/openclaw_todo/cmd_add.py`, line 23", "+- **Description**: No max-length check on `title`. Slack messages cap at ~4000 chars, providing natural limits. The DB column is `TEXT NOT NULL` with no length constraint.", "+- **Action**: Consider adding a max-length check if the handler is exposed outside Slack.", "+", "+#### [Info] F5: Dispatcher test correctly updated", "+", "+- **File**: `tests/test_dispatcher.py`, lines 34-51", "+- **Description**: The parametrized stub test removed `\"add\"` from the stub-check list and added a dedicated `test_add_routes_to_handler` test that asserts `\"Added #\"` in the result. This correctly reflects that `add` is no longer a stub.", "+", "+### Code Quality Summary", "+", "+The implementation is clean, minimal, and correct:", "+", "+- Uses `resolve_project()` for project resolution following PRD Option A (private-first).", "+- Private assignee validation correctly rejects non-owner assignees with a descriptive warning.", "+- All SQL uses parameterized queries (`?` placeholders).", "+- Event payload is well-structured JSON with title, project, section, due, and assignees.", "+- Response format matches the PRD/UX spec exactly.", "+- 10 tests with thorough assertions on both the response string and DB state.", "+- No unnecessary complexity or over-engineering.", "+", "+**Verdict: APPROVE** -- no blocking issues. No fixes required.", "+", "+---", "+", "+## Security Findings", "+", " ### [Info] S1: SQL injection -- No risk", " ", " - **File**: `src/openclaw_todo/cmd_add.py`, lines 52-78"]}, {"oldStart": 1056, "oldLines": 19, "newStart": 1149, "newLines": 8, "lines": [" 1. **Test coverage**: Add a test for non-owner sender attempting to add a task to another user's private project (should get `ProjectNotFoundError` via resolver).", " 2. **Transaction explicitness**: Consider wrapping the three DB writes in `with conn:` for explicit transaction semantics.", " 3. **Title length**: Consider adding a max-length validation (e.g., 500 chars) as defense-in-depth.", "-4. **Permissions module**: When Issue #17 (permissions helper) is merged, consider extracting the inline private-assignee validation to use the shared `validate_private_assignees()` function.", "-=======", "-No Critical, High, or Medium severity security findings. All SQL parameterized. Fail-closed design. Three Low findings noted for awareness.", "+4. **Permissions module**: Consider extracting the inline private-assignee validation to use the shared `validate_private_assignees()` function from Issue #17.", " ", "----", "-", "-## Follow-up Issues (proposed)", "-", "-1. **Defensive guard**: Consider adding a log warning in `validate_private_assignees` when `visibility == \"private\"` and `owner_id is None`.", "-2. **Test consistency**: Align `_create_project` helper to use `last_insert_rowid()` like `_create_task`.", "-", "----", "-", " ## Review Pass 2", " ", " > Reviewer: Claude Opus 4.6 (automated review)"]}], "userModified": false, "replaceAll": false}, "tool_use_id": "toolu_01EmCcAtTpWS228G4otPU8pi", "_ts": "2026-02-20T19:31:52+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "grep -n \"<<<<<<\\|======\\|>>>>>>\" /Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md 2>&1 | head -5", "description": "Check for remaining conflict markers"}, "tool_use_id": "toolu_016sBMhHNSTFVvHuSBzLCLzW", "_ts": "2026-02-20T19:31:56+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "grep -n \"<<<<<<\\|======\\|>>>>>>\" /Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md 2>&1 | head -5", "description": "Check for remaining conflict markers"}, "tool_response": {"stdout": "1182:>>>>>>> origin/main", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_016sBMhHNSTFVvHuSBzLCLzW", "_ts": "2026-02-20T19:31:56+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "offset": 1175, "limit": 15}, "tool_use_id": "toolu_01HQDhGS18Hu6eDVPTZMN1cy", "_ts": "2026-02-20T19:32:00+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "offset": 1175, "limit": 15}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "content": "| F2: `validate_private_assignees` with `owner_id=None` | Low | OPEN -- non-blocking. |\n| F3: Missing creator+assignee overlap test | Low | FIXED in 594cad4. Verified correct. |\n| F4: `_create_project` helper uses complex SELECT | Low | OPEN -- non-blocking. |\n\n### Verdict\n\n**APPROVE -- ready to merge.** All 49 tests pass. No Critical or High issues.\n>>>>>>> origin/main\n", "numLines": 9, "startLine": 1175, "totalLines": 1183}}, "tool_use_id": "toolu_01HQDhGS18Hu6eDVPTZMN1cy", "_ts": "2026-02-20T19:32:00+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "old_string": "**APPROVE -- ready to merge.** All 49 tests pass. No Critical or High issues.\n>>>>>>> origin/main", "new_string": "**APPROVE -- ready to merge.** All 49 tests pass. No Critical or High issues.", "replace_all": false}, "tool_use_id": "toolu_01TRanFi1JSvVT8idncruXF2", "_ts": "2026-02-20T19:32:04+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "old_string": "**APPROVE -- ready to merge.** All 49 tests pass. No Critical or High issues.\n>>>>>>> origin/main", "new_string": "**APPROVE -- ready to merge.** All 49 tests pass. No Critical or High issues.", "replace_all": false}, "tool_response": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add/docs/review_notes.md", "oldString": "**APPROVE -- ready to merge.** All 49 tests pass. No Critical or High issues.\n>>>>>>> origin/main", "newString": "**APPROVE -- ready to merge.** All 49 tests pass. No Critical or High issues.", "originalFile": "# PR #2 Review Notes -- Issue #1: Plugin skeleton and entry point\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/001-plugin-skeleton`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `pyproject.toml` with Python >=3.11, pytest, pytest-cov dev deps | PASS | Correct. Uses `dependency-groups` (PEP 735) with hatchling backend. |\n| `src/openclaw_todo/__init__.py` exposes `__version__` | PASS | `__version__ = \"0.1.0\"` |\n| `handle_message(text: str, context: dict) -> str` entry point | PASS (minor note) | Return type is `str | None`, not `str`. The AC literally says `-> str` but `None` for ignored messages is the intended behavior per the next AC. Acceptable. |\n| Non-`/todo` messages silently ignored (returns `None`) | PASS | |\n| `uv sync && uv run pytest -q` passes | PASS | 4 tests, 100% coverage |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_ignores_non_todo_message` | PASS -- covers empty string, random text, `/todox` prefix-collision |\n| `test_dispatches_todo_prefix` | PASS -- verifies non-None response with subcommand text |\n\n### Findings\n\n#### [Info] Return type annotation mismatch with AC\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 12\n- The AC states `-> str` but the implementation is `-> str | None`. This is correct behavior (returning `None` for non-todo messages is explicitly required). The AC text is slightly imprecise; the code is right.\n- **Action**: None needed. Consider updating the AC wording if desired.\n\n#### [Info] `context` parameter unused\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 12\n- `context: dict` is accepted but never read in this skeleton. This is expected for M0 -- it will be used once the dispatcher (Issue #16) and DB commands are wired in.\n- **Action**: None. This is intentional scaffolding.\n\n#### [Info] Placeholder response includes raw user input\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 32\n- `f\"TODO command received: {remainder}\"` echoes back unescaped user input. This is a temporary placeholder (comment says \"will be replaced by dispatcher in Issue #16\"). In the current context (no HTML/web rendering, Slack DM only), this is not exploitable, but see Security Findings below.\n- **Action**: Track as part of Issue #16.\n\n#### [Info] Extra tests beyond AC requirements -- good\n\n- `test_todo_prefix_with_whitespace` and `test_todo_without_subcommand` are bonus tests covering whitespace handling and bare `/todo` usage message. Good coverage instinct.\n\n#### [Info] Version duplication\n\n- Version `0.1.0` appears in both `pyproject.toml` and `__init__.py`. Consider using `importlib.metadata` or dynamic versioning in a future issue to keep a single source of truth. Not a concern for M0.\n\n#### [Low] No type hints for `context` dict\n\n- `context: dict` is untyped (could be `dict[str, Any]` or a TypedDict). For M0 this is fine, but a `TypedDict` or dataclass should be introduced when the context shape solidifies.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and well-structured for a skeleton:\n\n- Prefix matching logic (`stripped == _TODO_PREFIX or stripped.startswith(_TODO_PREFIX + \" \")`) correctly avoids false positives on `/todox`.\n- Logging at appropriate levels (debug for all messages, info for matches).\n- Usage help returned for bare `/todo` is a nice touch.\n- Test coverage is 100%.\n\n**Verdict: APPROVE** -- no blocking issues.\n\n---\n\n## Security Findings\n\n### [Low] S1: User input echoed in placeholder response\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 32\n- **Description**: The placeholder `f\"TODO command received: {remainder}\"` reflects user-supplied text without sanitization. In the current Slack DM context, Slack handles rendering and this is not exploitable for XSS. However, once a web dashboard or logging UI is introduced, unsanitized echo could become a reflected XSS vector.\n- **Severity**: Low (Slack auto-escapes; placeholder will be replaced in Issue #16)\n- **Recommendation**: When building the real dispatcher, ensure any user text echoed in responses is sanitized if it ever reaches a web context. No fix needed now.\n\n### [Low] S2: No input length validation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/plugin.py`, line 12\n- **Description**: `handle_message` accepts arbitrarily long strings. A malicious or buggy client could send extremely large messages. Slack itself limits messages to ~40,000 characters, so this is mitigated at the transport layer.\n- **Severity**: Low\n- **Recommendation**: Consider adding a max-length guard in the dispatcher (Issue #16) if the plugin is ever exposed outside Slack.\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in any reviewed files. Environment variable approach is correctly deferred to future DB/config work.\n\n### [Info] S4: Dependencies are minimal and current\n\n- Only dev dependencies: `pytest>=7.0` and `pytest-cov>=4.0`. No known CVEs for these versions. No runtime dependencies beyond the standard library.\n- Build backend `hatchling` is a well-maintained, standard tool.\n\n### [Info] S5: No SQL, no deserialization, no file I/O\n\n- The M0 skeleton has no database, no file operations, and no deserialization. The attack surface is effectively zero at this stage.\n\n### Security Summary\n\nNo Critical or High severity findings. The codebase has a minimal attack surface appropriate for a plugin skeleton. Security considerations will become relevant starting with Issue #2 (DB connection) and Issue #5 (parser with user-controlled input).\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Issue #16 (Dispatcher)**: When replacing the placeholder response, ensure user input is not echoed raw if the output context changes (e.g., web UI).\n2. **Future**: Introduce a `TypedDict` or dataclass for the `context` parameter to enforce shape and enable static analysis.\n3. **Future**: Consolidate version to a single source (e.g., `importlib.metadata.version(\"openclaw-todo-plugin\")`).\n\n---\n\n# PR #4 Review Notes -- Issue #2: DB module -- connection helper and pragma setup\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/002-db-connection`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| Directory is created recursively when absent | PASS | `db_dir.mkdir(parents=True, exist_ok=True)` on line 32. Test `test_creates_directory_and_file` verifies nested `nested/dir/` creation. |\n| SQLite connection returned with WAL mode enabled | PASS | `PRAGMA journal_mode=WAL` on line 36. Test verifies `fetchone()[0] == \"wal\"`. |\n| `busy_timeout` is 3000 | PASS | `PRAGMA busy_timeout=3000` on line 37. Test verifies `fetchone()[0] == 3000`. |\n| Calling `get_connection` twice returns usable connections (no lock conflict) | PASS | `test_two_connections_no_conflict` creates a table via conn1, reads via conn2. WAL mode enables this concurrency. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `tests/test_db.py::test_creates_directory_and_file` | PASS -- verifies both `db_path.exists()` and `db_path.parent.exists()` with nested `tmp_path` |\n| `tests/test_db.py::test_wal_mode_enabled` | PASS -- queries `PRAGMA journal_mode` and asserts `\"wal\"` |\n| `tests/test_db.py::test_busy_timeout` | PASS -- queries `PRAGMA busy_timeout` and asserts `3000` |\n\n### Findings\n\n#### [Info] TOCTOU in `is_new` logging check\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 29\n- `is_new = not db_path.exists()` is checked before `sqlite3.connect()`, which itself creates the file. In a concurrent scenario, the file could appear between the check and the connect. This only affects which log message is emitted (info vs. debug) and has no functional impact.\n- **Action**: None required. Purely cosmetic race condition.\n\n#### [Info] PRAGMA return values not checked\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, lines 36-37\n- `conn.execute(\"PRAGMA journal_mode=WAL;\")` returns a result set with the actual journal mode applied. On some edge cases (e.g., read-only filesystem, in-memory DB), WAL activation can silently fall back to another mode. The code does not verify the return.\n- **Action**: Low priority. Consider adding a debug-level assertion or log warning in a future hardening pass. The test suite already validates WAL is active in the happy path.\n\n#### [Info] Default path uses `Path.home()`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 11\n- `DEFAULT_DB_DIR = Path.home() / \".openclaw\" / \"workspace\" / \".todo\"` is evaluated at module import time. If `HOME` is unset (e.g., certain containerized environments), `Path.home()` raises `RuntimeError`. This is acceptable since: (a) the default is only used when `db_path is None`, and (b) the plugin is designed for environments where `HOME` is set. Callers in containers should pass an explicit path.\n- **Action**: None for M1. Document the `db_path` parameter as the recommended override for non-standard environments.\n\n#### [Info] Extra test beyond AC requirements -- good\n\n- `test_two_connections_no_conflict` is a bonus test that exercises concurrent WAL access. This directly validates the 4th acceptance criterion and is well-structured with proper cleanup in a `finally` block.\n\n#### [Low] Test cleanup uses `try/finally` instead of a fixture\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_db.py`, all tests\n- Each test manually opens a connection and closes it in `try/finally`. A pytest fixture (e.g., `@pytest.fixture` yielding the connection) would reduce boilerplate and guarantee cleanup even if assertion lines are added later. This is a minor style observation for 4 tests.\n- **Action**: Optional refactor. Not blocking.\n\n#### [Info] Coverage at 96%\n\n- Line 24 (`db_path = DEFAULT_DB_DIR / DEFAULT_DB_NAME`) is uncovered because all tests pass explicit `tmp_path` paths. This is correct -- testing the default path would write to the user's actual home directory. The uncovered line is trivial assignment logic.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and correct:\n\n- Function signature `get_connection(db_path: str | Path | None = None)` is flexible, accepting string, Path, or None.\n- `Path(db_path)` normalization on line 26 handles string inputs.\n- `exist_ok=True` on `mkdir` prevents race conditions with concurrent directory creation.\n- Logging at appropriate levels: `info` for creation, `debug` for opens.\n- No unnecessary dependencies -- uses only stdlib `sqlite3`, `pathlib`, and `logging`.\n- 96% test coverage with all acceptance criteria verified.\n\n**Verdict: APPROVE** -- no blocking issues.\n\n---\n\n## Security Findings\n\n### [Low] S1: `db_path` parameter accepts arbitrary filesystem paths\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 15\n- **Description**: `get_connection(db_path)` will create directories and an SQLite database at any filesystem path the process has write access to. If a future caller passes unsanitized user input as `db_path`, this could be used for arbitrary file creation (e.g., path traversal via `../../etc/cron.d/evil`).\n- **Severity**: Low (currently an internal API; no user-facing code path passes user input to `db_path`)\n- **Recommendation**: When wiring `db_path` into the dispatcher (Issue #16), ensure the path comes only from configuration (env var or config file), never from user-controlled message text. Consider adding a validation that `db_path` is within an expected base directory.\n\n### [Info] S2: No SQL injection risk\n\n- PRAGMA statements on lines 36-37 use hardcoded string literals with no interpolation. The `db_path` is passed to `sqlite3.connect()` as a filesystem path, not as a SQL query. No injection surface exists.\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `db.py` or `test_db.py`. The module uses only stdlib.\n\n### [Info] S4: No new dependencies introduced\n\n- This module uses only Python standard library (`sqlite3`, `pathlib`, `logging`). No new entries in `pyproject.toml` dependencies. Zero additional attack surface from third-party code.\n\n### [Info] S5: SQLite WAL mode is a security-positive choice\n\n- WAL mode improves concurrent access safety and reduces the risk of database corruption from concurrent writes. The `busy_timeout=3000` prevents immediate lock failures, which could otherwise cause data loss if a caller does not handle `sqlite3.OperationalError` properly.\n\n### Security Summary\n\nNo Critical or High severity findings. The attack surface is minimal -- a single function that creates a local SQLite database with hardcoded pragmas. The only surface to monitor is ensuring `db_path` remains configuration-controlled as the codebase grows.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Issue #3 (Migration framework)**: When implementing migrations, ensure SQL statements use parameterized queries (not string formatting) for any dynamic values. The migration runner should validate migration callables are from a trusted registry.\n2. **Future**: Add a pytest fixture for `get_connection` that yields and auto-closes, reducing `try/finally` boilerplate across DB-related test files.\n3. **Future**: Consider adding a `validate_db_path(path)` helper that constrains paths to an allowed base directory, for defense-in-depth when the dispatcher wires in configuration.\n\n---\n\n# PR #6 Review Notes -- Issue #3: Schema migration framework and schema_version table\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/003-schema-migration`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `schema_version` table created with single row `version=0` if absent | PASS | `_ensure_version_table` uses `CREATE TABLE IF NOT EXISTS` and inserts `version=0` only when no row exists (line 30-31). |\n| Migrations are Python callables registered in an ordered list | PASS | `_migrations: list[MigrationFn]` with `@register` decorator appending to the list. Index maps directly to migration version. |\n| Each migration runs inside a transaction; version incremented on success | PASS | `conn.commit()` after each successful migration (line 65). SQLite's implicit transaction wraps the migration + version update. |\n| Re-running on an up-to-date DB is a no-op | PASS | `current >= target` guard on line 52 returns immediately. Test `test_idempotent_on_rerun` verifies. |\n| Failing migration rolls back and raises with clear message | PASS | `conn.rollback()` in `except` block (line 67). `RuntimeError` with formatted message including version number and original exception (line 68-70). |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_fresh_db_gets_version_table` | PASS -- verifies `get_version` returns 0 and `schema_version` table exists in `sqlite_master` |\n| `test_applies_migrations_sequentially` | PASS -- registers two migrations, asserts final version is 2, verifies both tables created |\n| `test_idempotent_on_rerun` | PASS -- calls `migrate` twice, both return 1, no errors |\n| `test_rollback_on_failure` | PASS -- first migration commits (version 1, `t_ok` exists), second raises `ValueError`, caught as `RuntimeError`, version stays at 1 |\n\n### Findings\n\n#### [Medium] No constraint preventing multiple rows in `schema_version`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- The `schema_version` table is created with `(version INTEGER NOT NULL)` but has no PRIMARY KEY, UNIQUE constraint, or CHECK constraint limiting it to a single row. If a bug or manual intervention inserts a second row, `get_version` would return whichever row SQLite returns first from `SELECT version FROM schema_version` (non-deterministic without ORDER BY).\n- **Action**: Consider adding a single-row constraint in a future migration (e.g., `CHECK (rowid = 1)` or a dummy `id INTEGER PRIMARY KEY CHECK (id = 1)` column). Not blocking for M1 since all writes go through `_ensure_version_table` which correctly checks before inserting.\n\n#### [Low] Redundant `_ensure_version_table` calls\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, lines 48-49\n- `migrate()` calls `_ensure_version_table(conn)` on line 48, then calls `get_version(conn)` on line 49, which internally calls `_ensure_version_table` again. This results in two `CREATE TABLE IF NOT EXISTS` and two `SELECT version` queries on every `migrate` call.\n- **Action**: Minor performance concern. Could be refactored so `migrate` calls `_ensure_version_table` once and reads the version directly. Not blocking.\n\n#### [Info] Global mutable state for migrations registry\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 15\n- `_migrations` is a module-level mutable list. This is a common pattern for migration registries and works well for single-process applications. The test suite correctly saves/restores it via the `_clean_migrations` autouse fixture (lines 16-23 in test file).\n- **Action**: None. This is an appropriate pattern for this use case. If multi-process or plugin-based architectures are introduced later, consider a class-based registry.\n\n#### [Info] Test fixture properly isolates migration state\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_migrations.py`, lines 16-23\n- The `_clean_migrations` fixture saves the original list, clears it before each test, and restores it after. This prevents test pollution and is correctly marked `autouse=True`. The save-clear-yield-clear-extend pattern is the correct idiom.\n\n#### [Info] `conn` fixture uses `get_connection` from `db` module\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_migrations.py`, lines 27-31\n- The test fixture uses `get_connection` (from Issue #2) rather than raw `sqlite3.connect`. This ensures WAL mode and `busy_timeout` pragmas are applied, matching production behavior. This is a good integration practice.\n\n#### [Info] Coverage at 100%\n\n- All 41 statements in `migrations.py` are covered by the 4 tests. No untested branches.\n\n#### [Info] Error message includes original exception\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, lines 68-70\n- `raise RuntimeError(...) from exc` preserves the exception chain, making debugging easier. The message format `\"Migration to version {N} failed: {exc}\"` clearly identifies which migration failed. This follows the acceptance criterion for \"clear message.\"\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and minimal:\n\n- The `@register` decorator pattern is intuitive for defining migrations in order.\n- Transaction semantics are correctly handled: commit on success, rollback on failure.\n- The version update uses a parameterized query (`?` placeholder on line 63), avoiding SQL injection.\n- Logging at appropriate levels: `info` for migration steps and completion, `debug` for up-to-date status.\n- The code correctly handles the edge case where `current > target` (e.g., if migrations are removed), treating it the same as up-to-date.\n- 100% test coverage with all four required tests present and passing.\n\n**Verdict: APPROVE** -- no blocking issues. One medium finding (missing single-row constraint) noted for follow-up.\n\n---\n\n## Security Findings\n\n### [Medium] S1: `schema_version` table lacks row-count constraint\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- **Description**: The `schema_version` table has no mechanism to enforce that exactly one row exists. While the application code only writes through `_ensure_version_table` (which checks before inserting) and `migrate` (which uses `UPDATE`), a direct SQL injection in a future module or manual DB editing could insert additional rows, causing `get_version` to return an unpredictable value. This could lead to migrations being skipped or re-applied.\n- **Severity**: Medium (requires either a separate SQL injection vulnerability or direct DB access to exploit; impact is schema corruption)\n- **Recommendation**: In the V1 schema migration (Issue #4), alter or recreate the table with a single-row constraint, e.g., `CREATE TABLE schema_version (id INTEGER PRIMARY KEY CHECK (id = 1), version INTEGER NOT NULL)`.\n\n### [Info] S2: No SQL injection risk in migration runner\n\n- All SQL in `migrations.py` uses either hardcoded string literals or parameterized queries (`?` on line 63 for the version update). The `MigrationFn` type receives a `Connection` object, and it is the responsibility of each registered migration to use parameterized queries. This is correctly documented in the PR #4 review follow-up.\n\n### [Info] S3: Migration functions are trusted code\n\n- The `@register` decorator appends arbitrary callables to the migration list. Since migrations are defined at module import time by the application developer (not by user input), there is no injection risk. The registry is not exposed to any user-facing API.\n\n### [Info] S4: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `migrations.py` or `test_migrations.py`.\n\n### [Info] S5: No new dependencies introduced\n\n- This module uses only Python standard library (`sqlite3`, `logging`, `typing`). No new entries in `pyproject.toml` dependencies.\n\n### [Info] S6: Exception message does not leak sensitive data\n\n- The `RuntimeError` message on line 69 includes the migration version number and the string representation of the original exception. In this context (local SQLite, no user-supplied data in migration functions), this does not leak sensitive information. If migrations ever process user data, the exception wrapping should be reviewed to avoid leaking PII in logs.\n\n### Security Summary\n\nNo Critical or High severity findings. One Medium finding regarding the missing single-row constraint on `schema_version`, which could lead to schema version confusion if combined with a separate vulnerability that allows arbitrary SQL execution. The recommendation is to address this in the Issue #4 V1 schema migration.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Issue #4 (V1 schema)**: Add a single-row constraint to `schema_version` (e.g., `CHECK (id = 1)` on a primary key column) as part of the V1 migration to prevent version-table corruption.\n2. **Future**: Refactor `migrate()` to avoid redundant `_ensure_version_table` calls for minor performance improvement.\n3. **Future**: Consider adding a `--dry-run` mode to the migration runner that reports which migrations would be applied without executing them, useful for deployment verification.\n\n---\n\n# PR #8 Review Notes -- Issue #4: V1 schema migration -- projects, tasks, task_assignees, events\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/004-v1-schema`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `projects` table with `ux_projects_shared_name` and `ux_projects_private_owner_name` partial unique indexes | PASS | Table created on lines 18-26, indexes on lines 28-36 of `schema_v1.py`. Partial `WHERE` clauses match PRD exactly. |\n| `tasks` table with section and status CHECK constraints | PASS | Section CHECK on line 43 (`backlog, doing, waiting, done, drop`), status CHECK on line 45 (`open, done, dropped`). Both match PRD spec. |\n| `task_assignees` table with composite PK and secondary index | PASS | Composite `PRIMARY KEY (task_id, assignee_user_id)` on line 57, secondary index `ix_task_assignees_user` on lines 61-64. |\n| `events` audit table created | PASS | Table on lines 66-75. Columns match PRD. |\n| Shared `Inbox` project auto-created (INSERT OR IGNORE) | PASS | Line 78-81 uses `INSERT OR IGNORE` with `('Inbox', 'shared', NULL)`. |\n| `schema_version` = 1 after migration | PASS | Test `test_v1_schema_version` verifies `get_version(conn) == 1`. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_v1_tables_exist` | PASS -- verifies all four tables exist in `sqlite_master` |\n| `test_v1_inbox_created` | PASS -- verifies name='Inbox', visibility='shared', owner_user_id=None |\n| `test_v1_shared_unique_index_enforced` | PASS -- duplicate shared name raises `IntegrityError` |\n| `test_v1_private_unique_index_enforced` | PASS -- duplicate (owner, name) raises `IntegrityError`; different owner succeeds |\n\n### Findings\n\n#### [High] F1: Foreign keys not enforced -- `PRAGMA foreign_keys=ON` missing\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 35-37\n- **Description**: SQLite does not enforce `REFERENCES` (foreign key) clauses by default. The `PRAGMA foreign_keys=ON` must be executed on every new connection for FK constraints to be active. Without this, the `REFERENCES projects(id)` on `tasks.project_id` and `REFERENCES tasks(id)` on `task_assignees.task_id` are purely decorative -- you can insert tasks pointing to non-existent projects and assignees pointing to non-existent tasks.\n- **Impact**: Referential integrity is silently not enforced, leading to orphaned rows and data corruption.\n- **Fix applied**: Added `conn.execute(\"PRAGMA foreign_keys=ON;\")` to `get_connection()` in `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 38. All 19 tests pass after the fix.\n\n#### [Medium] F2: `schema_version` single-row constraint not added in V1\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- **Description**: The PR #6 review (Medium finding S1) recommended adding a single-row constraint to `schema_version` as part of the V1 migration. This was not addressed. The table still has no PK or CHECK constraint to prevent multiple rows.\n- **Action**: Should be addressed in a follow-up issue. Adding it retroactively in a later migration (e.g., V2) would require recreating the table since SQLite does not support `ALTER TABLE ADD CONSTRAINT`.\n\n#### [Low] F3: Minor PRD deviation on `events.ts` -- NOT NULL DEFAULT added\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/schema_v1.py`, line 69\n- **Description**: The PRD spec for `events.ts` says `ts TEXT` with no nullability or default constraint. The implementation adds `NOT NULL DEFAULT (datetime('now'))`. This is a sensible enhancement (audit timestamps should always be present), but it is a deviation from the spec.\n- **Action**: None needed. The implementation is better than the spec. Consider updating the PRD to match.\n\n#### [Low] F4: `events.id` uses AUTOINCREMENT, PRD says PK only\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/schema_v1.py`, line 68\n- **Description**: PRD says `id INTEGER PK` for the events table. The implementation uses `INTEGER PRIMARY KEY AUTOINCREMENT`. AUTOINCREMENT prevents rowid reuse after deletion, which is actually preferable for an audit log (guarantees monotonically increasing IDs). This is a minor deviation but a positive one.\n- **Action**: None needed. Consider updating the PRD.\n\n#### [Low] F5: No test for `task_assignees` composite PK enforcement\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_schema_v1.py`\n- **Description**: The acceptance criteria mention `task_assignees` table with composite PK, but there is no test verifying that inserting a duplicate `(task_id, assignee_user_id)` pair raises `IntegrityError`. The composite PK is created, but its enforcement is untested.\n- **Action**: Add a test in a follow-up to insert a duplicate pair and assert `IntegrityError`.\n\n#### [Low] F6: No test for foreign key enforcement\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_schema_v1.py`\n- **Description**: No test verifies that inserting a task with a non-existent `project_id` raises an error, or that inserting a `task_assignee` with a non-existent `task_id` raises an error. With the FK pragma fix (F1), these would now fail correctly, but there is no test coverage for this behavior.\n- **Action**: Add FK enforcement tests in a follow-up.\n\n#### [Info] F7: Test fixture pattern is well-structured\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_schema_v1.py`, lines 11-25\n- The `_load_v1_migration` autouse fixture correctly saves, clears, imports, and restores the migration registry. The `conn` fixture properly creates a temp DB, migrates, yields, and closes. This is clean test isolation.\n\n#### [Info] F8: CHECK constraint tests are thorough\n\n- Tests `test_v1_section_check_constraint` and `test_v1_status_check_constraint` go beyond the required tests to verify that invalid enum values are rejected. Good defensive testing.\n\n#### [Info] F9: 8 tests total for V1 schema, all passing\n\n- `test_v1_tables_exist`, `test_v1_schema_version`, `test_v1_inbox_created`, `test_v1_shared_unique_index_enforced`, `test_v1_private_unique_index_enforced`, `test_v1_section_check_constraint`, `test_v1_status_check_constraint` (7 tests in `test_schema_v1.py`). Plus the rollback test verifies `conn.rollback()` is correctly called after each constraint violation test.\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and closely follows the PRD spec:\n\n- All four tables are created with the correct columns, types, and constraints.\n- Partial unique indexes use the correct `WHERE` clause syntax.\n- CHECK constraints enumerate exactly the values specified in the PRD.\n- `INSERT OR IGNORE` for the Inbox seed is idempotent.\n- Parameterized queries are not needed here (all DDL uses string literals with no interpolation).\n- The `@register` decorator integrates seamlessly with the migration framework from Issue #3.\n- Test coverage is good, with 7 tests covering table existence, version, seed data, unique indexes, and CHECK constraints.\n\n**Verdict: APPROVE with one fix applied** -- the `PRAGMA foreign_keys=ON` fix (High, F1) has been applied directly. Medium/Low findings are noted for follow-up.\n\n---\n\n## Security Findings\n\n### [High] S1: Foreign key constraints not enforced (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/db.py`, line 35-37\n- **Description**: Without `PRAGMA foreign_keys=ON`, all `REFERENCES` clauses in the V1 schema are ignored. This means a future command handler could insert tasks referencing non-existent projects or assignees referencing non-existent tasks, leading to data integrity violations that are silent and hard to debug. In a multi-user Slack plugin, this could allow one user's actions to create orphaned records that cause errors for other users.\n- **Severity**: High (data integrity violation in a multi-user context; silent failure mode)\n- **Fix**: Added `conn.execute(\"PRAGMA foreign_keys=ON;\")` to `get_connection()`. All 19 tests pass.\n\n### [Medium] S2: `schema_version` table remains unprotected against multi-row corruption\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/migrations.py`, line 27\n- **Description**: Carried forward from PR #6 review. The `schema_version` table has no constraint preventing insertion of additional rows. If a separate vulnerability allows arbitrary SQL execution, an attacker could manipulate the schema version to skip or re-run migrations.\n- **Severity**: Medium (requires a chained vulnerability to exploit)\n- **Recommendation**: Address in a future migration that recreates the table with a single-row constraint.\n\n### [Info] S3: No SQL injection risk in V1 migration\n\n- All SQL in `schema_v1.py` uses hardcoded string literals. No user input, no string interpolation, no parameterized queries needed. The `INSERT OR IGNORE` for the Inbox seed uses literal values only.\n\n### [Info] S4: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `schema_v1.py` or `test_schema_v1.py`.\n\n### [Info] S5: No new dependencies introduced\n\n- The V1 migration uses only Python standard library (`sqlite3`, `logging`). No new entries in `pyproject.toml`.\n\n### [Info] S6: CHECK constraints provide defense-in-depth\n\n- The `section` and `status` CHECK constraints on the `tasks` table prevent invalid enum values at the database level, not just the application level. This is a security-positive pattern that prevents data corruption even if the application layer has a bug.\n\n### Security Summary\n\nOne High severity finding (S1: missing `PRAGMA foreign_keys=ON`) was identified and fixed directly in `db.py`. One Medium finding (S2: `schema_version` single-row constraint) is carried forward from the previous review. No Critical findings.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Test coverage**: Add tests for `task_assignees` composite PK enforcement (duplicate pair should raise `IntegrityError`).\n2. **Test coverage**: Add tests for foreign key enforcement (task with non-existent `project_id`, assignee with non-existent `task_id` should raise `IntegrityError` now that FK pragma is enabled).\n3. **Schema version constraint**: Address the `schema_version` single-row constraint in a future migration (V2 or later) by recreating the table with `CHECK (id = 1)`.\n4. **PRD sync**: Update PRD section 6.3 to add `NOT NULL DEFAULT (datetime('now'))` to `events.ts` and `AUTOINCREMENT` to `events.id` to match the implementation.\n5. **DB module**: Add a test for `PRAGMA foreign_keys` returning `1` in `test_db.py` to prevent regression.\n\n---\n\n# PR #10 Review Notes -- Issue #5: Command parser -- tokenizer and option extraction\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/005-parser-tokenizer`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `/p MyProject` correctly extracted; token consumed | PASS | `test_extract_project` verifies project name extracted, `/p` and value removed from `title_tokens`. |\n| `/s doing` validated; invalid section raises `ParseError` | PASS | `test_extract_section_valid` and `test_extract_section_invalid` cover both paths. Case-insensitive via `.lower()`. |\n| `due:03-15` normalised to `2026-03-15` (current year) | PASS | `test_due_mm_dd_normalisation` verifies with `date.today().year`. |\n| `due:2026-02-30` raises `ParseError` (invalid date) | PASS | `test_due_invalid_date` asserts `ParseError` with match on \"Invalid due date\". |\n| `<@U12345>` extracted into mentions list | PASS | `test_mentions_extraction` verifies two mentions extracted and not in `title_tokens`. |\n| Multiple mentions supported | PASS | Same test covers two mentions in order. |\n| Title tokens are non-option, non-mention tokens before first option | PASS | `test_title_extraction` verifies correct split with mixed options. Note: title tokens are collected from *all* positions, not just \"before first option\" -- this is arguably more flexible than the AC wording. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_extract_project` | PASS |\n| `test_extract_section_valid` | PASS |\n| `test_extract_section_invalid` | PASS |\n| `test_due_mm_dd_normalisation` | PASS |\n| `test_due_full_date` | PASS |\n| `test_due_invalid_date` | PASS |\n| `test_due_clear` | PASS |\n| `test_mentions_extraction` | PASS |\n| `test_title_extraction` | PASS |\n\nAll 9 required tests present and passing. 4 additional bonus tests (`test_command_extraction`, `test_move_extracts_id_as_arg`, `test_empty_command_raises`, `test_section_case_insensitive`). 13 parser tests total.\n\n### Findings\n\n#### [Medium] F1: Leap-year bug in `_normalise_due` for MM-DD format (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 53-62 (after fix)\n- **Description**: The original implementation used `datetime.strptime(raw, \"%m-%d\")` which defaults to year 1900 (not a leap year). This caused `due:02-29` to always be rejected, even when the current year is a leap year (e.g., 2028). The `replace(year=current_year)` call was never reached because `strptime` itself raised `ValueError`.\n- **Fix applied**: Replaced `strptime(\"%m-%d\")` with a regex match `(\\d{1,2})-(\\d{1,2})` followed by direct `date(current_year, month, day)` construction. This correctly validates Feb 29 against the actual current year.\n- **Impact**: Without fix, `due:02-29` would fail in leap years (2028, 2032, etc.) when it should succeed.\n\n#### [Low] F2: Duplicate options silently use \"last wins\" semantics\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 91-117\n- **Description**: If a user provides `/p First /p Second`, the parser silently uses `Second`. Same for `/s` and `due:`. This is not necessarily wrong, but it is undocumented. \"Last wins\" is a reasonable default, but \"first wins\" or \"raise error on duplicate\" are also valid choices.\n- **Action**: Document the \"last wins\" behavior in the docstring or PRD. No code change needed.\n\n#### [Low] F3: `/p` and `/s` error paths (missing argument) are untested\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_parser.py`\n- **Description**: Lines 93 and 101 (`raise ParseError(\"/p requires a project name\")` and `/s` equivalent) are uncovered. Manual testing confirmed they work correctly, but automated test coverage is missing for these edge cases.\n- **Action**: Add tests for `parse(\"add task /p\")` and `parse(\"add task /s\")` in a follow-up.\n\n#### [Low] F4: `_DUE_RE` uses `.+` which accepts any characters after `due:`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, line 15\n- **Description**: `_DUE_RE = re.compile(r\"^due:(.+)$\")` will match `due:anything` and pass the value to `_normalise_due`. This is not a bug since `_normalise_due` properly validates the value, but a tighter regex like `r\"^due:([\\d-]+)$\"` would reject obviously invalid inputs earlier and serve as documentation of expected format.\n- **Action**: Optional tightening. Not blocking since validation is correct.\n\n#### [Low] F5: Title tokens are collected from all positions, not just \"before first option\"\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 126-128\n- **Description**: The AC says \"Title tokens are non-option, non-mention tokens before first option.\" The implementation collects title tokens from all positions (e.g., `add Buy /p Home milk` would produce `title_tokens=[\"Buy\", \"milk\"]`). This is actually more flexible and user-friendly, but deviates from the literal AC wording.\n- **Action**: Consider updating the AC to match the implementation. The current behavior is better for UX.\n\n#### [Info] F6: `args` extraction for `move/done/drop/edit` is well-designed\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 130-133\n- The pattern of extracting the first title token as `args[0]` for ID-based commands is clean and tested by `test_move_extracts_id_as_arg`.\n\n#### [Info] F7: Coverage at 97%\n\n- Lines 93 and 101 (error paths for missing `/p` and `/s` arguments) are uncovered. All other branches are tested. This is acceptable for M1.\n\n#### [Info] F8: Bonus tests add good defensive coverage\n\n- `test_section_case_insensitive` ensures `/s DOING` normalizes to `doing`.\n- `test_command_extraction` verifies the first token becomes the command.\n- `test_empty_command_raises` covers the empty input guard.\n- `test_move_extracts_id_as_arg` covers the args extraction logic.\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and well-structured:\n\n- The tokenizer loop with explicit index management (`while i < len(remaining)`) is readable and handles two-token options (`/p`, `/s`) cleanly by advancing `i` by 2.\n- `ParsedCommand` dataclass provides a clear, typed result structure.\n- `VALID_SECTIONS` as a `frozenset` is the right choice for O(1) membership testing.\n- `_MENTION_RE` uses `fullmatch` (not `match` or `search`), preventing partial matches on tokens like `<@U123>extra`.\n- Error messages are descriptive and include the invalid value with `repr()` formatting.\n- Logging at debug level for parsed results is appropriate.\n- 97% test coverage with all 9 required tests present and 4 bonus tests.\n\n**Verdict: APPROVE with one fix applied** -- the leap-year bug in `_normalise_due` (Medium, F1) has been fixed directly. Low findings are noted for follow-up.\n\n---\n\n## Security Findings\n\n### [Medium] S1: Leap-year date validation bypass (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, `_normalise_due`\n- **Description**: The original `strptime(\"%m-%d\")` approach silently rejected valid dates (`02-29` in leap years) due to the 1900 default year. While this is a correctness issue rather than a security vulnerability, incorrect date validation can lead to denial of service (users unable to set valid due dates) and data integrity issues (dates that should be accepted are rejected).\n- **Severity**: Medium (correctness bug with functional impact)\n- **Fix**: Replaced with regex-based month/day extraction and direct `date()` construction with the current year.\n\n### [Low] S2: No ReDoS risk in compiled regexes\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, lines 14-15\n- **Description**: Both `_MENTION_RE = re.compile(r\"<@(U[A-Z0-9]+)>\")` and `_DUE_RE = re.compile(r\"^due:(.+)$\")` were tested with 100,000-character inputs and completed in under 0.1ms. Neither pattern contains nested quantifiers or alternation that could cause catastrophic backtracking.\n- **Severity**: Low (no risk found, noting for completeness)\n\n### [Low] S3: No input length validation on parser input\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/src/openclaw_todo/parser.py`, line 72\n- **Description**: `parse(text)` accepts arbitrarily long strings. `text.strip().split()` will allocate a token list proportional to input size. Slack limits messages to ~40,000 characters, mitigating this at the transport layer, but if the parser is used outside Slack, extremely long inputs could cause memory pressure.\n- **Severity**: Low (mitigated by Slack transport layer limits)\n- **Recommendation**: Consider adding a max-length guard in the plugin entry point (`handle_message`) rather than the parser itself.\n\n### [Info] S4: No injection risks\n\n- The parser only tokenizes and validates strings. No SQL, no shell commands, no template rendering. User input flows into `ParsedCommand` fields which are plain strings. Security depends on how these values are consumed downstream (e.g., parameterized queries when writing to SQLite).\n\n### [Info] S5: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `parser.py` or `test_parser.py`.\n\n### [Info] S6: No new dependencies introduced\n\n- The parser uses only Python standard library (`re`, `datetime`, `dataclasses`, `logging`). No new entries in `pyproject.toml`.\n\n### Security Summary\n\nNo Critical or High severity findings. One Medium finding (S1: leap-year date validation) was identified and fixed. The parser has a minimal attack surface -- it tokenizes strings and validates against known patterns. The main security consideration going forward is ensuring that `ParsedCommand` field values are used safely downstream (parameterized SQL queries, no raw echo in web contexts).\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Test coverage**: Add tests for `/p` and `/s` without arguments (lines 93, 101) to cover the missing-argument error paths.\n2. **Documentation**: Document \"last wins\" semantics for duplicate `/p`, `/s`, and `due:` options in the PRD or parser docstring.\n3. **Optional**: Tighten `_DUE_RE` from `.+` to `[\\d-]+` for earlier rejection of obviously invalid due values.\n4. **AC clarification**: Update Issue #5 AC to reflect that title tokens are collected from all positions (not just \"before first option\"), matching the implemented behavior.\n\n---\n\n# PR #12 Review Notes -- Issue #7: Project resolver helper\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/007-project-resolver`\n# PR #14 Review Notes -- Issue #16: Command dispatcher and routing\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature-016-dispatcher`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| Private project of sender matched first | PASS | Query on line 38-42 filters by `visibility = 'private' AND owner_user_id = ?`. Test `test_private_takes_priority` verifies. |\n| Falls back to shared if no private match | PASS | Second query on line 52-56 filters by `visibility = 'shared'`. Test `test_falls_back_to_shared` verifies. |\n| Returns error when neither exists (except Inbox auto-created) | PASS | `ProjectNotFoundError` raised on line 84. Inbox auto-created on lines 66-81. Tests `test_unknown_project_error` and `test_inbox_auto_created` verify. |\n| Returns project row with id, name, visibility, owner_user_id | PASS | `Project` dataclass on lines 17-23 with all four fields. All tests assert on these fields. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_private_takes_priority` | PASS -- creates both shared and private \"Work\", verifies private is returned for owner U1 |\n| `test_falls_back_to_shared` | PASS -- creates shared \"Team\" only, verifies shared returned for U1 |\n| `test_inbox_auto_created` | PASS -- deletes seeded Inbox, verifies auto-creation as shared with null owner |\n| `test_unknown_project_error` | PASS -- verifies `ProjectNotFoundError` raised with descriptive message |\n\nAll 4 required tests present and passing. 2 additional bonus tests (`test_inbox_already_exists`, `test_private_different_owner_not_matched`). 6 tests total.\n\n### Findings\n\n#### [Low] F1: Project name matching is case-sensitive\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 39-42\n- **Description**: The SQL queries use `WHERE name = ?` which is case-sensitive in SQLite by default (for ASCII). If a user types `/p work` but the project is named `Work`, it will not match. The PRD does not specify case-sensitivity behavior, so this is not a bug per se, but it could cause user confusion.\n- **Action**: Document the case-sensitive behavior. Consider adding `COLLATE NOCASE` in a future iteration if case-insensitive matching is desired.\n\n#### [Low] F2: Repeated `Project(id=row[0], ...)` construction pattern\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 44, 58, 76\n- **Description**: The same `Project(id=row[0], name=row[1], visibility=row[2], owner_user_id=row[3])` pattern appears three times. This could be extracted to a helper (e.g., `Project._from_row(row)` classmethod or a module-level `_row_to_project` function) to reduce duplication and ensure consistency if columns change.\n- **Action**: Optional refactor. Not blocking for M1.\n\n#### [Low] F3: `conn.commit()` called inside resolver for Inbox auto-creation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, line 71\n- **Description**: The resolver calls `conn.commit()` directly after the `INSERT OR IGNORE` for Inbox auto-creation. This commits any pending transaction state on the connection, which could be surprising if the caller has uncommitted changes. In the current codebase this is not an issue (resolver is called early in command handling), but it couples the resolver to transaction management.\n- **Action**: Consider whether the caller should be responsible for committing. For M1 this is acceptable since the auto-creation is a one-time idempotent operation.\n\n#### [Low] F4: No test for Inbox auto-creation when a private Inbox exists\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/tests/test_project_resolver.py`\n- **Description**: If a user has a private project named \"Inbox\", `resolve_project(conn, \"Inbox\", user_id)` will return the private project (step 1 matches). The auto-creation path (step 3) is only reached if neither private nor shared \"Inbox\" exists. This behavior is correct per the resolution order, but there is no test covering the scenario where a user has a private \"Inbox\" and the shared \"Inbox\" also exists -- the test should verify that the private one is returned.\n- **Action**: Add a test for this edge case in a follow-up.\n\n#### [Info] F5: `INSERT OR IGNORE` is the correct pattern for Inbox auto-creation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 67-70\n- `INSERT OR IGNORE` handles the race condition where two concurrent requests try to auto-create Inbox simultaneously. The `ux_projects_shared_name` unique index on `(name) WHERE visibility = 'shared'` ensures only one shared Inbox can exist. The subsequent `SELECT` on lines 72-75 guarantees we return the correct row regardless of whether this request or another one performed the insert. This is well-designed.\n\n#### [Info] F6: Bonus tests add good defensive coverage\n\n- `test_inbox_already_exists` verifies that the seeded Inbox (from V1 migration) resolves without triggering auto-creation.\n- `test_private_different_owner_not_matched` verifies that a private project owned by U2 is not visible to U1, correctly raising `ProjectNotFoundError`.\n\n#### [Info] F7: Coverage at 100%\n\n- All 31 statements in `project_resolver.py` are covered by the 6 tests. No untested branches.\n\n#### [Info] F8: Test fixture pattern is consistent with prior PRs\n\n- The `_load_v1` autouse fixture and `conn` fixture follow the same save-clear-restore pattern established in prior PRs. Good consistency.\n\n### Code Quality Summary\n\nThe implementation is clean, correct, and follows the PRD resolution order exactly:\n\n- Three-step resolution (private -> shared -> Inbox auto-create) with clear fallthrough logic.\n- All SQL queries use parameterized placeholders (`?`), preventing SQL injection.\n- `Project` dataclass provides a typed result with the four required fields.\n- `ProjectNotFoundError` is a well-named custom exception with descriptive message.\n- Logging at debug level for each resolution path aids troubleshooting.\n- `INSERT OR IGNORE` handles concurrent Inbox auto-creation safely.\n- 100% test coverage with all 4 required tests and 2 valuable bonus tests.\n- The code is 85 lines total -- minimal and readable.\n\n**Verdict: APPROVE** -- no Critical or High findings. All Low findings are noted for follow-up.\n### Changed Files\n\n| File | Change | Lines |\n|------|--------|-------|\n| `src/openclaw_todo/dispatcher.py` | NEW | 116 |\n| `src/openclaw_todo/plugin.py` | MODIFIED | 33 |\n| `tests/test_dispatcher.py` | NEW | 152 |\n| `tests/test_plugin.py` | MODIFIED | 39 |\n\n### Architecture Overview\n\nThe dispatcher implements a two-level routing architecture:\n\n1. **Plugin layer** (`plugin.py`): Strips `/todo` prefix, returns USAGE for bare `/todo`, delegates remainder to `dispatch()`.\n2. **Dispatcher layer** (`dispatcher.py`): Parses the remainder via the parser, validates command name against `_VALID_COMMANDS`, opens a DB connection with migration, routes to the appropriate handler (or stub), and closes the connection in a `finally` block.\n3. **Project sub-routing**: `project` command delegates to `_dispatch_project()` which extracts the subcommand from `parsed.title_tokens` and routes to `project_<subcommand>` handlers in the registry.\n\n### Findings\n\n#### [Low] F1: Weak test assertion on stub handler (FIXED)\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/tests/test_dispatcher.py`, line 48\n- **Description**: The original assertion was:\n  ```python\n  assert \"not yet implemented\" in result.lower() or isinstance(result, str)\n  ```\n  The `isinstance(result, str)` clause makes this trivially true since `dispatch()` always returns `str`. The test does not actually verify that the stub handler was invoked -- any string return would pass.\n- **Fix applied**: Removed the `or isinstance(result, str)` fallback. The assertion now strictly verifies that the stub handler message is present:\n  ```python\n  assert \"not yet implemented\" in result.lower()\n  ```\n- **Impact**: Test now correctly fails if the stub handler message format changes or if a different code path is taken.\n\n#### [Low] F2: `_stub_handler` signature differs from `HandlerFn` type alias\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 17, 47\n- **Description**: The `HandlerFn` type alias is `Callable[[ParsedCommand, Connection, dict], str]` (3 args), but `_stub_handler` takes 4 args: `(command, parsed, conn, context)`. This works because `_stub_handler` is never registered directly in `_handlers` -- it is always called via a lambda wrapper in `_get_handler` (line 59) and `_dispatch_project` (line 115) that captures `command` via closure. However, the mismatch makes the code harder to follow at a glance.\n- **Action**: Consider refactoring `_stub_handler` to accept `(parsed, conn, context)` and derive the command name from `parsed.command`. Not blocking since the current approach is correct.\n\n#### [Low] F3: Long line in `_dispatch_project`\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 115\n- **Description**: Line 115 is 116 characters, exceeding typical line length limits (88 for black, 100 for many projects). The lambda + `_handlers.get` + `_stub_handler` call is dense.\n- **Action**: Consider breaking into multiple lines for readability. Not blocking.\n\n#### [Low] F4: Global mutable `_handlers` dict shared across tests\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 54\n- **Description**: The `_handlers` dict is module-level mutable state. The test fixture `_clean_handlers` (test file line 22-28) correctly saves and restores it between tests. However, if the test suite were run in parallel (e.g., `pytest-xdist`), the shared state could cause flaky tests.\n- **Action**: For a single-process Slack plugin this is fine. Document the limitation if parallel test execution is ever introduced.\n\n#### [Info] F5: DB connection lifecycle is correct\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 86-94\n- The `dispatch()` function opens the DB connection *after* validating the command name (line 80-82 returns early for unknown commands without touching the DB). The connection is always closed in a `finally` block (line 94), ensuring no leaks even if handlers raise exceptions. This is good resource management.\n\n#### [Info] F6: Unknown commands do not open a DB connection\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 80-82\n- The `if command not in _VALID_COMMANDS` check returns before `_init_db()` is called. This avoids unnecessary DB initialization for typos and invalid commands. Good design.\n\n#### [Info] F7: Parse errors are caught and returned as user-facing messages\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 73-76\n- `ParseError` is caught and formatted as `f\"Parse error: {exc}\"`. The parser's error messages are descriptive (e.g., \"Invalid section: 'xyz'\") and do not leak internal details. This is appropriate for a Slack DM context.\n\n#### [Info] F8: Plugin entry-point correctly wired to dispatcher\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/plugin.py`\n- The `handle_message()` function now delegates to `dispatch()` instead of the previous placeholder response. The prefix matching logic is unchanged and still correct. The `db_path` parameter flows through to `dispatch()` for testability.\n\n#### [Info] F9: Schema import triggers migration registration\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 14\n- `import openclaw_todo.schema_v1 as _schema_v1` with `# noqa: F401` ensures the `@register` decorator in `schema_v1.py` runs at import time, populating the migration registry before any `migrate()` call. This is the correct pattern for the decorator-based migration system.\n\n#### [Info] F10: Test coverage is comprehensive\n\n- 20 dispatcher + plugin tests covering:\n  - All 7 non-project commands routed to stubs (parametrized)\n  - Custom handler registration and invocation\n  - All 3 project subcommands routed correctly\n  - Project with no subcommand returns usage\n  - Unknown project subcommand returns error\n  - Unknown top-level command returns error with usage\n  - Parse error propagation\n  - DB initialization with schema migration\n  - Plugin prefix matching (non-todo, todo, whitespace, bare /todo)\n\n### Code Quality Summary\n\nThe dispatcher implementation is clean, well-structured, and follows good design principles:\n\n- **Separation of concerns**: Plugin handles prefix matching; dispatcher handles parsing, validation, DB init, and routing. Each has a single responsibility.\n- **Resource safety**: DB connection opened late (only for valid commands) and closed in `finally`.\n- **Extensibility**: The `register_handler()` function provides a clean API for future command implementations to plug in without modifying the dispatcher.\n- **Defensive routing**: Unknown commands and parse errors return helpful user-facing messages without touching the DB or raising unhandled exceptions.\n- **Project sub-routing**: The `project_<subcommand>` naming convention with `replace('-', '_')` is a clean pattern for hyphenated subcommands.\n- **Test isolation**: The `_clean_handlers` autouse fixture properly saves and restores the handler registry between tests.\n\n**Verdict: APPROVE with one fix applied** -- the weak test assertion (Low, F1) has been strengthened. No Critical or High code quality issues found.\n\n---\n\n## Security Findings\n\n### [Low] S1: No SQL injection risk -- parameterized queries used throughout\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, lines 38-42, 52-56\n- **Description**: All SQL queries use `?` parameter placeholders for user-supplied values (`name` and `sender_id`). The Inbox auto-creation on lines 67-75 uses hardcoded string literals only. No string interpolation or f-strings are used in any SQL statement.\n- **Severity**: Low (no risk found, noting for completeness)\n\n### [Low] S2: `name` parameter is not length-validated\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, line 27\n- **Description**: `resolve_project(conn, name, sender_id)` accepts arbitrarily long `name` strings. While SQLite handles this safely (TEXT has no inherent length limit), an extremely long name would result in unnecessary query execution against the database. The parser upstream (Issue #5) extracts project names from `/p <name>` tokens, and Slack limits message length to ~40,000 characters, providing transport-layer mitigation.\n- **Severity**: Low (mitigated by upstream constraints)\n- **Recommendation**: Consider adding a max-length check for project names in the parser or a future validation layer.\n\n### [Low] S3: Inbox auto-creation commits transaction implicitly\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-007-project-resolver/src/openclaw_todo/project_resolver.py`, line 71\n- **Description**: `conn.commit()` inside the resolver commits all pending changes on the connection, not just the Inbox insert. If a future caller has uncommitted writes before calling `resolve_project`, those writes would be committed as a side effect. This is not exploitable but could lead to partial commits in error scenarios.\n- **Severity**: Low (no current exploit path; architectural concern)\n- **Recommendation**: Consider using a savepoint pattern (`SAVEPOINT` / `RELEASE`) for the Inbox auto-creation to isolate its transaction from any outer transaction.\n\n### [Info] S4: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `project_resolver.py` or `test_project_resolver.py`.\n\n### [Info] S5: No new dependencies introduced\n\n- The module uses only Python standard library (`sqlite3`, `dataclasses`, `logging`). No new entries in `pyproject.toml`.\n\n### [Info] S6: Authorization model is correctly scoped\n\n- The `sender_id` parameter is used correctly in the private-project query to scope visibility. User U1 cannot resolve another user's private projects. Test `test_private_different_owner_not_matched` explicitly verifies this isolation. The shared-project query correctly omits owner filtering, as shared projects are visible to all users.\n\n### Security Summary\n\nNo Critical, High, or Medium severity findings. The implementation has a minimal attack surface -- three read queries and one idempotent insert, all using parameterized queries. The authorization model (private scoped to sender, shared visible to all) is correctly implemented and tested. Three Low findings are noted for awareness but require no immediate action.\n### [Low] S1: User input reflected in error messages\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 76, 82, 110\n- **Description**: Three error paths echo user-supplied values back in responses:\n  - `f\"Parse error: {exc}\"` (line 76) -- parser error messages may contain raw user input\n  - `f\"Unknown command: '{command}'\\n{USAGE}\"` (line 82) -- the command name is user input\n  - `f\"Unknown project subcommand: '{sub}'\\n{PROJECT_USAGE}\"` (line 110) -- the subcommand is user input\n- **Severity**: Low. In the Slack DM context, Slack handles message escaping. The reflected values are single tokens (no spaces, limited characters after `split()` tokenization). No HTML/JS injection is possible in this context.\n- **Recommendation**: If the plugin ever serves responses in a web context (e.g., dashboard, webhook response viewer), sanitize reflected values. No fix needed for current Slack-only usage.\n\n### [Low] S2: No input length validation at dispatcher level\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, line 67\n- **Description**: `dispatch(text, ...)` accepts arbitrarily long strings, which flow to `parse()` for tokenization. Slack limits messages to approximately 40,000 characters, providing transport-layer mitigation.\n- **Severity**: Low (mitigated by Slack transport layer)\n- **Recommendation**: Consider adding a max-length guard in `handle_message()` if the plugin is ever exposed outside Slack.\n\n### [Low] S3: Handler exception propagation\n\n- **File**: `/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-016-dispatcher/src/openclaw_todo/dispatcher.py`, lines 91-92\n- **Description**: If a registered handler raises an unhandled exception, it propagates up through `dispatch()`. The `finally` block ensures the DB connection is closed, but the exception itself is not caught. In the current architecture, the caller (`handle_message` in `plugin.py`) does not catch exceptions either, so an unhandled handler error would propagate to the gateway framework.\n- **Severity**: Low. The stub handlers cannot raise exceptions (they return strings). Future handler implementations should handle their own errors. A catch-all `except Exception` in `dispatch()` could provide defense-in-depth but would also mask bugs during development.\n- **Recommendation**: Consider adding a top-level exception handler in `dispatch()` that logs the error and returns a generic \"Internal error\" message, once real handlers are implemented. During development, letting exceptions propagate is acceptable.\n\n### [Info] S4: No SQL injection risk\n\n- The dispatcher does not execute any SQL directly. DB interaction is limited to `_init_db()` which calls `get_connection()` and `migrate()` -- both use hardcoded SQL or parameterized queries. User input flows through `ParsedCommand` fields to handlers, which are responsible for using parameterized queries.\n\n### [Info] S5: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in `dispatcher.py`, `plugin.py`, or their test files.\n\n### [Info] S6: `db_path` parameter is configuration-controlled\n\n- The `db_path` parameter in `dispatch()` and `handle_message()` flows from the caller (gateway framework), not from user input. In tests, it comes from `tmp_path`. There is no code path where a user's message text influences the DB path.\n\n### [Info] S7: No new dependencies introduced\n\n- The dispatcher uses only Python standard library (`sqlite3`, `logging`, `typing`) plus internal modules (`db`, `migrations`, `parser`, `schema_v1`). No new entries in `pyproject.toml`.\n\n### Security Summary\n\nNo Critical or High severity findings. Three Low findings related to input reflection, length validation, and exception propagation are noted. The dispatcher has a minimal attack surface -- it validates commands against a whitelist, delegates parsing to the parser, and routes to registered handlers. The main security consideration for future work is ensuring that handler implementations use parameterized queries and handle their own exceptions gracefully.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Refactor**: Extract `Project(id=row[0], ...)` into a `_row_to_project(row)` helper or `Project.from_row(row)` classmethod to reduce the triple duplication.\n2. **Test coverage**: Add a test for the edge case where a user has a private \"Inbox\" project and the shared \"Inbox\" also exists, verifying the private one is returned.\n3. **Transaction safety**: Consider using `SAVEPOINT` / `RELEASE` for Inbox auto-creation instead of bare `conn.commit()` to avoid committing unrelated pending changes.\n4. **Case sensitivity**: Document that project name matching is case-sensitive. Consider `COLLATE NOCASE` if case-insensitive matching is desired in a future iteration.\n5. **Input validation**: Add a max-length check for project names in the parser or validation layer to prevent unnecessarily large queries.\n1. **Exception handling**: Add a top-level `try/except` in `dispatch()` that catches unexpected handler exceptions, logs them at error level, and returns a generic user-facing error message. Defer until real handlers are implemented.\n2. **Refactor `_stub_handler`**: Align `_stub_handler` signature with `HandlerFn` type alias by deriving the command name from `parsed.command` instead of passing it as a separate argument. This also eliminates the lambda wrappers in `_get_handler` and `_dispatch_project`.\n3. **Line length**: Break the long line 115 in `_dispatch_project` for readability.\n4. **Context typing**: Introduce a `TypedDict` or dataclass for the `context` parameter (e.g., `class DispatchContext(TypedDict): sender_id: str`) to enable static type checking.\n5. **Input length guard**: Add a max-length check (e.g., 5000 chars) in `handle_message()` as defense-in-depth against oversized inputs.\n\n---\n\n# PR #16 Review Notes -- Issue #17: Permission helper module\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature-017-permissions`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| `can_write_task(conn, task_id, sender_id) -> bool` exists | PASS | Function defined on line 11 of `permissions.py` with correct signature. |\n| Private project: only owner can write | PASS | Lines 34-40 check `sender_id == owner_user_id` when `visibility == \"private\"`. Tests `test_private_owner_can_write` and `test_private_non_owner_rejected` verify. |\n| Shared project: assignee or creator can write | PASS | Lines 43-60 check creator first, then query `task_assignees`. Tests `test_shared_assignee_can_write`, `test_shared_creator_can_write`, and `test_shared_unrelated_rejected` verify. |\n| Nonexistent task returns False | PASS | Lines 28-29 return `False` when row is None. Test `test_nonexistent_task` verifies. |\n| `validate_private_assignees(visibility, assignees, owner_id) -> str or None` exists | PASS | Function defined on line 63 with correct signature. |\n| Returns warning for non-owner assignees on private project | PASS | Lines 75-81. Test `test_validate_private_assignees_warning` verifies. |\n| Returns None for shared projects | PASS | Lines 72-73. Test `test_shared_always_ok` verifies. |\n| Returns None when all assignees are the owner | PASS | Lines 76-77. Test `test_private_all_owner_ok` verifies. |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_private_owner_can_write` | PASS |\n| `test_private_non_owner_rejected` | PASS |\n| `test_shared_assignee_can_write` | PASS |\n| `test_shared_creator_can_write` | PASS |\n| `test_shared_unrelated_rejected` | PASS |\n| `test_nonexistent_task` | PASS |\n| `test_validate_private_assignees_warning` | PASS |\n| `test_private_all_owner_ok` | PASS |\n| `test_shared_always_ok` | PASS |\n| `test_private_empty_assignees_ok` | PASS |\n\nAll 10 tests present and passing. 48 tests total in the suite.\n\n### Findings\n\n#### [Medium] F1: Shared project owner cannot modify tasks they did not create or get assigned to — CONFIRMED INTENTIONAL\n\n- **Description**: In a shared project, only the task creator and assignees are allowed to write. The project owner has no special privileges. User confirmed this is intentional: only task creator and assignees should have task write access.\n- **Status**: CLOSED as intentional design.\n\n#### [Low] F2: `validate_private_assignees` with `owner_id=None` marks all assignees as non-owner\n\n- **Description**: When `owner_id` is `None` on a private project (data integrity issue), all assignees would be flagged as non-owner. Function short-circuits for shared projects, so this only affects corrupted data.\n- **Status**: OPEN, non-blocking.\n\n#### [Low] F3: No test for shared project where sender is both creator and assignee — FIXED\n\n- **Description**: Added `test_shared_creator_and_assignee_can_write` in commit 594cad4. Creator short-circuit handles this correctly.\n- **Status**: FIXED.\n\n#### [Low] F4: `_create_project` helper uses complex SELECT instead of `last_insert_rowid()`\n\n- **Status**: OPEN, non-blocking.\n\n### Code Quality Summary\n\n**Verdict: APPROVE** -- no Critical or High findings. F1 confirmed intentional, F3 fixed.\n\n---\n\n## Security Findings\n\nNo Critical, High, or Medium severity security findings. All SQL parameterized. Fail-closed design. Three Low findings noted for awareness.\n\n---\n\n## Follow-up Issues (proposed)\n\n1. **Defensive guard**: Consider adding a log warning in `validate_private_assignees` when `visibility == \"private\"` and `owner_id is None`.\n2. **Test consistency**: Align `_create_project` helper to use `last_insert_rowid()` like `_create_task`.\n\n---\n\n# PR #18 Review Notes -- Issue #6: /todo add command\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Branch: `feature/006-cmd-add`\n\n---\n\n## Code Review\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| Task inserted with correct project_id, section, due, status='open', created_by | PASS | `test_add_default_inbox` and `test_add_with_project_section_due` verify all fields in DB |\n| Assignees default to sender when no mentions | PASS | `test_add_assignee_defaults_to_sender` verifies `task_assignees` row matches sender |\n| Multiple mentions create multiple task_assignee rows | PASS | `test_add_multiple_assignees` verifies two rows inserted and present in response |\n| Private project + non-owner assignee returns warning and does NOT insert | PASS | `test_add_private_rejects_other_assignee` verifies warning message and zero task rows |\n| Non-existent project: `Inbox` auto-created; others return error | PASS | `test_add_default_inbox` uses seeded Inbox; `test_add_nonexistent_project_returns_error` verifies error |\n| Response format: `Added #<id> (<project>/<section>) due:<due\\|-> assignees:<mentions> -- <title>` | PASS | All happy-path tests assert on this format |\n| Event row written to `events` table | PASS | `test_event_logged` verifies actor, action, task_id, and JSON payload fields |\n\n### Required Tests\n\n| Test | Status |\n|------|--------|\n| `test_add_default_inbox` | PASS |\n| `test_add_with_project_section_due` | PASS |\n| `test_add_private_rejects_other_assignee` | PASS |\n| `test_add_assignee_defaults_to_sender` | PASS |\n| `test_add_multiple_assignees` | PASS |\n\nAll 5 required tests present and passing. 5 additional tests (`test_add_private_allows_owner_assignee`, `test_event_logged`, `test_add_empty_title_returns_error`, `test_add_nonexistent_project_returns_error`, `test_add_due_clear_sentinel_stored_as_null`). 10 tests total.\n\n### Findings\n\n#### [Info] F1: No explicit transaction wrapping for multi-statement write\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-80\n- **Description**: The handler performs three sequential writes (task INSERT, assignee INSERTs, event INSERT) followed by a single `conn.commit()` at line 80. If any write after the task INSERT raises (e.g., duplicate assignee PK violation), partial writes remain uncommitted. SQLite's implicit rollback-on-close in the dispatcher's `finally` block protects data integrity.\n- **Action**: Consider wrapping in `with conn:` (context manager) for explicit transaction semantics in a future refactor. No functional bug today.\n\n#### [Info] F2: Missing `sender_id` key would raise unhandled KeyError\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 22\n- **Description**: `context[\"sender_id\"]` raises `KeyError` if the key is absent. The dispatcher contract requires `sender_id` in context, so this is defensive-coding territory.\n- **Action**: Acceptable. Could be improved with `.get()` + early return, but low priority given the documented contract.\n\n#### [Info] F3: Test gap -- non-owner sender adding to another user's private project\n\n- **File**: `tests/test_cmd_add.py`\n- **Description**: No test covers the case where sender U2 tries to add a task to a private project owned by U1. The `resolve_project()` function would return `ProjectNotFoundError` (it only matches private projects of the sender), which is correct behavior. However, there is no explicit test verifying this path through `add_handler`.\n- **Action**: Follow-up item. Add a test for \"non-owner sender cannot resolve another user's private project.\"\n\n#### [Info] F4: Title length is unbounded\n\n- **File**: `src/openclaw_todo/cmd_add.py`, line 23\n- **Description**: No max-length check on `title`. Slack messages cap at ~4000 chars, providing natural limits. The DB column is `TEXT NOT NULL` with no length constraint.\n- **Action**: Consider adding a max-length check if the handler is exposed outside Slack.\n\n#### [Info] F5: Dispatcher test correctly updated\n\n- **File**: `tests/test_dispatcher.py`, lines 34-51\n- **Description**: The parametrized stub test removed `\"add\"` from the stub-check list and added a dedicated `test_add_routes_to_handler` test that asserts `\"Added #\"` in the result. This correctly reflects that `add` is no longer a stub.\n\n### Code Quality Summary\n\nThe implementation is clean, minimal, and correct:\n\n- Uses `resolve_project()` for project resolution following PRD Option A (private-first).\n- Private assignee validation correctly rejects non-owner assignees with a descriptive warning.\n- All SQL uses parameterized queries (`?` placeholders).\n- Event payload is well-structured JSON with title, project, section, due, and assignees.\n- Response format matches the PRD/UX spec exactly.\n- 10 tests with thorough assertions on both the response string and DB state.\n- No unnecessary complexity or over-engineering.\n\n**Verdict: APPROVE** -- no blocking issues. No fixes required.\n\n---\n\n## Security Findings\n\n### [Info] S1: SQL injection -- No risk\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 52-78\n- **Description**: All three SQL statements (task INSERT, assignee INSERT, event INSERT) use `?` parameter placeholders. No string interpolation or f-strings in SQL. Title, project_id, section, due, sender_id, and assignee values are all passed as parameters.\n- **Severity**: Info (no risk found)\n\n### [Info] S2: Authorization model is sound\n\n- **File**: `src/openclaw_todo/cmd_add.py`, lines 41-49\n- **Description**: Private project constraint correctly checks that all assignees match the project owner. The `resolve_project()` function provides implicit access control by only resolving the sender's own private projects (scoped by `owner_user_id = sender_id` in the SQL query). A non-owner sender cannot resolve another user's private project by name. The explicit assignee check in `cmd_add.py` is an additional layer for when the owner assigns tasks to others within their private project.\n- **Severity**: Info (no bypass possible)\n\n### [Info] S3: No hardcoded secrets or credentials\n\n- No API keys, tokens, or secrets found in any changed files.\n\n### [Info] S4: No new dependencies introduced\n\n- `cmd_add.py` uses only standard library (`json`, `logging`, `sqlite3`) plus internal modules (`parser`, `project_resolver`). No new entries in `pyproject.toml`.\n\n### [Info] S5: Input validation adequate\n\n- Empty title returns error (line 25-26).\n- Non-existent project returns error via `ProjectNotFoundError` (lines 30-33).\n- Section validation handled by parser upstream (`VALID_SECTIONS` check).\n- Due date validation handled by parser upstream (`_normalise_due`).\n- Mention format constrained by parser regex (`<@U[A-Z0-9]+>`).\n\n### Security Summary\n\nNo Critical, High, Medium, or Low severity findings. The implementation has a minimal attack surface -- three parameterized INSERT statements, project resolution with sender-scoped authorization, and input validation at both the parser and handler layers. The code is secure for the current Slack DM context.\n\n---\n\n## Follow-up Items\n\n1. **Test coverage**: Add a test for non-owner sender attempting to add a task to another user's private project (should get `ProjectNotFoundError` via resolver).\n2. **Transaction explicitness**: Consider wrapping the three DB writes in `with conn:` for explicit transaction semantics.\n3. **Title length**: Consider adding a max-length validation (e.g., 500 chars) as defense-in-depth.\n4. **Permissions module**: Consider extracting the inline private-assignee validation to use the shared `validate_private_assignees()` function from Issue #17.\n\n## Review Pass 2\n\n> Reviewer: Claude Opus 4.6 (automated review)\n> Date: 2026-02-20\n> Commit range: ff87515..594cad4\n\n### Purpose\n\nSecond review pass to verify the F3 fix (commit 594cad4) and confirm no remaining Critical/High issues.\n\n### F3 Fix Verification: `test_shared_creator_and_assignee_can_write`\n\n- **Status**: VERIFIED CORRECT\n- The test creates a shared project, a task where `U_BOTH` is the creator, assigns `U_BOTH` as an assignee, and asserts `can_write_task` returns `True`.\n- This exercises the creator short-circuit path, which returns `True` before the assignee query is reached.\n\n### Prior Findings Status\n\n| Finding | Severity | Status |\n|---------|----------|--------|\n| F1: Shared project owner has no implicit write | Medium | CLOSED -- Confirmed intentional by user. |\n| F2: `validate_private_assignees` with `owner_id=None` | Low | OPEN -- non-blocking. |\n| F3: Missing creator+assignee overlap test | Low | FIXED in 594cad4. Verified correct. |\n| F4: `_create_project` helper uses complex SELECT | Low | OPEN -- non-blocking. |\n\n### Verdict\n\n**APPROVE -- ready to merge.** All 49 tests pass. No Critical or High issues.\n>>>>>>> origin/main\n", "structuredPatch": [{"oldStart": 1179, "oldLines": 4, "newStart": 1179, "newLines": 3, "lines": [" ### Verdict", " ", " **APPROVE -- ready to merge.** All 49 tests pass. No Critical or High issues.", "->>>>>>> origin/main"]}], "userModified": false, "replaceAll": false}, "tool_use_id": "toolu_01TRanFi1JSvVT8idncruXF2", "_ts": "2026-02-20T19:32:04+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "uv run pytest -q 2>&1", "description": "Run tests after merge conflict resolution"}, "tool_use_id": "toolu_01UdUHnctWEm7Ciajt2rE2hy", "_ts": "2026-02-20T19:32:08+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "uv run pytest -q 2>&1", "description": "Run tests after merge conflict resolution"}, "tool_response": {"stdout": "........................................................................ [ 96%]\n...                                                                      [100%]\n75 passed in 0.22s", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_01UdUHnctWEm7Ciajt2rE2hy", "_ts": "2026-02-20T19:32:08+0900"}
{"session_id": "74fae4aa-631d-42f6-a511-2634490cdaa6", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/74fae4aa-631d-42f6-a511-2634490cdaa6.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin/.worktrees/feature-006-cmd-add", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "git add -A && git commit -m \"$(cat <<'EOF'\nmerge: resolve conflicts with main (permissions PR #17)\n\nMerge origin/main into feature/006-cmd-add, resolving conflicts in\nCHANGELOG.md and docs/review_notes.md. Both permissions and cmd_add\nentries preserved.\n\nCo-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>\nEOF\n)\" && git push 2>&1", "description": "Commit merge resolution and push"}, "tool_use_id": "toolu_01RXpJbMvHcjC35twcRyL9Dq", "_ts": "2026-02-20T19:32:15+0900"}
{"session_id": "e02e763a-9559-492f-8eda-46e7ce5ebc26", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/e02e763a-9559-492f-8eda-46e7ce5ebc26.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "git reset HEAD . 2>&1 && git checkout -- . 2>&1", "description": "Reset and clean working tree"}, "tool_response": {"stdout": "리셋 뒤에 스테이징하지 않은 변경 사항:\nM\t.claude/run/agent-state.json\nM\t.claude/run/events.jsonl\nM\tSTATUS.md\nM\tissues.md\nM\tsrc/openclaw_todo/__pycache__/__init__.cpython-311.pyc\nM\tsrc/openclaw_todo/__pycache__/parser.cpython-311.pyc\nM\ttests/__pycache__/__init__.cpython-311.pyc\nM\ttests/__pycache__/test_parser.cpython-311-pytest-9.0.2.pyc", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_01Rpi1nkxMJEKddD7h7GdUfk", "_ts": "2026-02-21T12:00:03+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md"}, "tool_use_id": "toolu_01D4z5zwXSkRgUdsZsm1gGbp", "_ts": "2026-02-21T12:00:15+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "content": "# Project Status — OpenClaw TODO Plugin\n\n**Last updated:** 2026-02-21\n\n## Current Phase\n\n**Kickoff complete** — All planning documents generated. Ready to begin implementation.\n\n## Milestones\n\n| Milestone | Description | Status | Issues |\n|-----------|-------------|--------|--------|\n| M0 | Plugin skeleton + `/todo` command registration | **Done** | #1 |\n| M1 | DB init + migrations + schema_version | **Done** | #2, #3, #4 |\n| M2 | Parser (Slack mention, /p, /s, due correction) | **Done** | #5 |\n| M3 | Commands (add/list/board/move/done/drop/edit) | **Done** | #6 ✅, #16 ✅, #7 ✅, #17 ✅, #10 ✅, #8 ✅, #11 ✅, #9 ✅, #12 ✅ |\n| M4 | Project commands (list/set-private/set-shared) | **Done** | #13 ✅, #14 ✅, #15 ✅ |\n| M5 | Tests (parser/unit + sqlite E2E) | Not started | #18, #19 |\n| M6 | Packaging / deployment | Not started | #20 |\n| DevOps | GitHub Actions CI | **Done** | #21 |\n\n## Critical Path\n\n```\n#1 (skeleton) → #2 (DB conn) → #3 (migration framework) → #4 (V1 schema) → #7 (project resolver) → commands\n#5 (parser) can be developed in parallel with DB track\n```\n\n## Next Issues to Work On\n\n1. **#18** — Parser comprehensive unit tests (M5)\n2. **#19** — SQLite E2E integration tests (M5)\n3. **#20** — Packaging and distribution setup (M6)\n\n## Risks\n\n| Risk | Likelihood | Impact | Mitigation |\n|------|-----------|--------|------------|\n| SQLite write contention under concurrent access | Low | Medium | WAL mode + busy_timeout=3000 |\n| Private/shared name collision user confusion | Medium | Low | Option A (private-first) + guidance |\n| Schema migration failures on upgrade | Low | High | schema_version table + sequential migrations |\n| Slack rate limits on heavy usage | Low | Low | Responses are single messages per command |\n\n## Generated Documents\n\n- [x] `docs/requirements.md` — Functional & non-functional requirements\n- [x] `docs/ux_spec.md` — UX specification with all command flows\n- [x] `docs/architecture.md` — Software architecture design\n- [x] `docs/test_plan.md` — Test strategy with 80+ test cases\n- [x] `issues.md` — 20 issues across 7 milestones\n", "numLines": 51, "startLine": 1, "totalLines": 51}}, "tool_use_id": "toolu_01D4z5zwXSkRgUdsZsm1gGbp", "_ts": "2026-02-21T12:00:15+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "old_string": "| M5 | Tests (parser/unit + sqlite E2E) | Not started | #18, #19 |", "new_string": "| M5 | Tests (parser/unit + sqlite E2E) | **Done** | #18 ✅, #19 ✅ |", "replace_all": false}, "tool_use_id": "toolu_01UvR2CpVSqUWRby1euhaRJM", "_ts": "2026-02-21T12:00:20+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "old_string": "| M5 | Tests (parser/unit + sqlite E2E) | Not started | #18, #19 |", "new_string": "| M5 | Tests (parser/unit + sqlite E2E) | **Done** | #18 ✅, #19 ✅ |", "replace_all": false}, "tool_response": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "oldString": "| M5 | Tests (parser/unit + sqlite E2E) | Not started | #18, #19 |", "newString": "| M5 | Tests (parser/unit + sqlite E2E) | **Done** | #18 ✅, #19 ✅ |", "originalFile": "# Project Status — OpenClaw TODO Plugin\n\n**Last updated:** 2026-02-21\n\n## Current Phase\n\n**Kickoff complete** — All planning documents generated. Ready to begin implementation.\n\n## Milestones\n\n| Milestone | Description | Status | Issues |\n|-----------|-------------|--------|--------|\n| M0 | Plugin skeleton + `/todo` command registration | **Done** | #1 |\n| M1 | DB init + migrations + schema_version | **Done** | #2, #3, #4 |\n| M2 | Parser (Slack mention, /p, /s, due correction) | **Done** | #5 |\n| M3 | Commands (add/list/board/move/done/drop/edit) | **Done** | #6 ✅, #16 ✅, #7 ✅, #17 ✅, #10 ✅, #8 ✅, #11 ✅, #9 ✅, #12 ✅ |\n| M4 | Project commands (list/set-private/set-shared) | **Done** | #13 ✅, #14 ✅, #15 ✅ |\n| M5 | Tests (parser/unit + sqlite E2E) | Not started | #18, #19 |\n| M6 | Packaging / deployment | Not started | #20 |\n| DevOps | GitHub Actions CI | **Done** | #21 |\n\n## Critical Path\n\n```\n#1 (skeleton) → #2 (DB conn) → #3 (migration framework) → #4 (V1 schema) → #7 (project resolver) → commands\n#5 (parser) can be developed in parallel with DB track\n```\n\n## Next Issues to Work On\n\n1. **#18** — Parser comprehensive unit tests (M5)\n2. **#19** — SQLite E2E integration tests (M5)\n3. **#20** — Packaging and distribution setup (M6)\n\n## Risks\n\n| Risk | Likelihood | Impact | Mitigation |\n|------|-----------|--------|------------|\n| SQLite write contention under concurrent access | Low | Medium | WAL mode + busy_timeout=3000 |\n| Private/shared name collision user confusion | Medium | Low | Option A (private-first) + guidance |\n| Schema migration failures on upgrade | Low | High | schema_version table + sequential migrations |\n| Slack rate limits on heavy usage | Low | Low | Responses are single messages per command |\n\n## Generated Documents\n\n- [x] `docs/requirements.md` — Functional & non-functional requirements\n- [x] `docs/ux_spec.md` — UX specification with all command flows\n- [x] `docs/architecture.md` — Software architecture design\n- [x] `docs/test_plan.md` — Test strategy with 80+ test cases\n- [x] `issues.md` — 20 issues across 7 milestones\n", "structuredPatch": [{"oldStart": 15, "oldLines": 7, "newStart": 15, "newLines": 7, "lines": [" | M2 | Parser (Slack mention, /p, /s, due correction) | **Done** | #5 |", " | M3 | Commands (add/list/board/move/done/drop/edit) | **Done** | #6 ✅, #16 ✅, #7 ✅, #17 ✅, #10 ✅, #8 ✅, #11 ✅, #9 ✅, #12 ✅ |", " | M4 | Project commands (list/set-private/set-shared) | **Done** | #13 ✅, #14 ✅, #15 ✅ |", "-| M5 | Tests (parser/unit + sqlite E2E) | Not started | #18, #19 |", "+| M5 | Tests (parser/unit + sqlite E2E) | **Done** | #18 ✅, #19 ✅ |", " | M6 | Packaging / deployment | Not started | #20 |", " | DevOps | GitHub Actions CI | **Done** | #21 |", " "]}], "userModified": false, "replaceAll": false}, "tool_use_id": "toolu_01UvR2CpVSqUWRby1euhaRJM", "_ts": "2026-02-21T12:00:20+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "old_string": "1. **#18** — Parser comprehensive unit tests (M5)\n2. **#19** — SQLite E2E integration tests (M5)\n3. **#20** — Packaging and distribution setup (M6)", "new_string": "1. **#20** — Packaging and distribution setup (M6)", "replace_all": false}, "tool_use_id": "toolu_01KSxqTsZYW81PVjEivZPXui", "_ts": "2026-02-21T12:00:24+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "old_string": "1. **#18** — Parser comprehensive unit tests (M5)\n2. **#19** — SQLite E2E integration tests (M5)\n3. **#20** — Packaging and distribution setup (M6)", "new_string": "1. **#20** — Packaging and distribution setup (M6)", "replace_all": false}, "tool_response": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "oldString": "1. **#18** — Parser comprehensive unit tests (M5)\n2. **#19** — SQLite E2E integration tests (M5)\n3. **#20** — Packaging and distribution setup (M6)", "newString": "1. **#20** — Packaging and distribution setup (M6)", "originalFile": "# Project Status — OpenClaw TODO Plugin\n\n**Last updated:** 2026-02-21\n\n## Current Phase\n\n**Kickoff complete** — All planning documents generated. Ready to begin implementation.\n\n## Milestones\n\n| Milestone | Description | Status | Issues |\n|-----------|-------------|--------|--------|\n| M0 | Plugin skeleton + `/todo` command registration | **Done** | #1 |\n| M1 | DB init + migrations + schema_version | **Done** | #2, #3, #4 |\n| M2 | Parser (Slack mention, /p, /s, due correction) | **Done** | #5 |\n| M3 | Commands (add/list/board/move/done/drop/edit) | **Done** | #6 ✅, #16 ✅, #7 ✅, #17 ✅, #10 ✅, #8 ✅, #11 ✅, #9 ✅, #12 ✅ |\n| M4 | Project commands (list/set-private/set-shared) | **Done** | #13 ✅, #14 ✅, #15 ✅ |\n| M5 | Tests (parser/unit + sqlite E2E) | **Done** | #18 ✅, #19 ✅ |\n| M6 | Packaging / deployment | Not started | #20 |\n| DevOps | GitHub Actions CI | **Done** | #21 |\n\n## Critical Path\n\n```\n#1 (skeleton) → #2 (DB conn) → #3 (migration framework) → #4 (V1 schema) → #7 (project resolver) → commands\n#5 (parser) can be developed in parallel with DB track\n```\n\n## Next Issues to Work On\n\n1. **#18** — Parser comprehensive unit tests (M5)\n2. **#19** — SQLite E2E integration tests (M5)\n3. **#20** — Packaging and distribution setup (M6)\n\n## Risks\n\n| Risk | Likelihood | Impact | Mitigation |\n|------|-----------|--------|------------|\n| SQLite write contention under concurrent access | Low | Medium | WAL mode + busy_timeout=3000 |\n| Private/shared name collision user confusion | Medium | Low | Option A (private-first) + guidance |\n| Schema migration failures on upgrade | Low | High | schema_version table + sequential migrations |\n| Slack rate limits on heavy usage | Low | Low | Responses are single messages per command |\n\n## Generated Documents\n\n- [x] `docs/requirements.md` — Functional & non-functional requirements\n- [x] `docs/ux_spec.md` — UX specification with all command flows\n- [x] `docs/architecture.md` — Software architecture design\n- [x] `docs/test_plan.md` — Test strategy with 80+ test cases\n- [x] `issues.md` — 20 issues across 7 milestones\n", "structuredPatch": [{"oldStart": 28, "oldLines": 9, "newStart": 28, "newLines": 7, "lines": [" ", " ## Next Issues to Work On", " ", "-1. **#18** — Parser comprehensive unit tests (M5)", "-2. **#19** — SQLite E2E integration tests (M5)", "-3. **#20** — Packaging and distribution setup (M6)", "+1. **#20** — Packaging and distribution setup (M6)", " ", " ## Risks", " "]}], "userModified": false, "replaceAll": false}, "tool_use_id": "toolu_01KSxqTsZYW81PVjEivZPXui", "_ts": "2026-02-21T12:00:24+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md", "offset": 746, "limit": 20}, "tool_use_id": "toolu_01QcWzhZjnCHCeYcbzsCJTJ2", "_ts": "2026-02-21T12:00:28+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md", "offset": 746, "limit": 20}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md", "content": "## Issue #19: SQLite end-to-end integration tests\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | QA                                     |\n| Milestone   | M5                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/019-e2e-tests`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nWrite integration tests that exercise the full flow through `handle_message` with a real (tmp_path) SQLite database. Cover the main user stories: add a task, list it, move it, mark done, edit it, manage projects, and validate private project constraints.\n\n**Acceptance Criteria**\n- [ ] Each test uses a fresh DB via `tmp_path` fixture\n- [ ] Scenarios: add->list, add->move->board, add->done, add->edit, project set-private rejection\n- [ ] Private project visibility enforced end-to-end", "numLines": 20, "startLine": 746, "totalLines": 890}}, "tool_use_id": "toolu_01QcWzhZjnCHCeYcbzsCJTJ2", "_ts": "2026-02-21T12:00:28+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md", "old_string": "| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/019-e2e-tests`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nWrite integration tests that exercise the full flow through `handle_message` with a real (tmp_path) SQLite database.", "new_string": "| Status      | done                                   |\n| Priority    | P1                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/019-e2e-tests`               |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/38 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/41 |\n\n**Description**\nWrite integration tests that exercise the full flow through `handle_message` with a real (tmp_path) SQLite database.", "replace_all": false}, "tool_use_id": "toolu_01P9UqEiq2bLGvejhodg4UmD", "_ts": "2026-02-21T12:00:34+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md", "old_string": "| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/019-e2e-tests`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nWrite integration tests that exercise the full flow through `handle_message` with a real (tmp_path) SQLite database.", "new_string": "| Status      | done                                   |\n| Priority    | P1                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/019-e2e-tests`               |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/38 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/41 |\n\n**Description**\nWrite integration tests that exercise the full flow through `handle_message` with a real (tmp_path) SQLite database.", "replace_all": false}, "tool_response": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md", "oldString": "| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/019-e2e-tests`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nWrite integration tests that exercise the full flow through `handle_message` with a real (tmp_path) SQLite database.", "newString": "| Status      | done                                   |\n| Priority    | P1                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/019-e2e-tests`               |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/38 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/41 |\n\n**Description**\nWrite integration tests that exercise the full flow through `handle_message` with a real (tmp_path) SQLite database.", "originalFile": "# OpenClaw TODO Plugin -- Issues\n\n> Auto-generated from `openclaw_todo_plugin_prd.md` (PRD v1.1)\n> Date: 2026-02-20\n\n---\n\n## Issue #1: Plugin skeleton and entry point\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M0                                     |\n| Status      | done                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/001-plugin-skeleton`          |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/1 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/2 |\n\n**Description**\nCreate the Python project scaffold: `pyproject.toml` (uv), `src/openclaw_todo/` package layout, and the plugin entry-point that the OpenClaw gateway will load. The plugin must expose a callable that receives raw Slack DM text and a sender context dict.\n\n**Acceptance Criteria**\n- [ ] `pyproject.toml` exists with Python >=3.11, pytest, pytest-cov dev deps\n- [ ] `src/openclaw_todo/__init__.py` exposes `__version__`\n- [ ] `src/openclaw_todo/plugin.py` contains `handle_message(text: str, context: dict) -> str` entry point\n- [ ] Messages not starting with `/todo` are silently ignored (returns `None`)\n- [ ] `uv sync && uv run pytest -q` passes (trivial smoke test)\n\n**Tests**\n- `tests/test_plugin.py::test_ignores_non_todo_message`\n- `tests/test_plugin.py::test_dispatches_todo_prefix`\n\n**Rollback**\nDelete branch; no runtime dependency.\n\n**Observability**\n`logger.debug` on every inbound message; `logger.info` when `/todo` prefix matched.\n\n**Dependencies**\nNone.\n\n---\n\n## Issue #2: DB module -- connection helper and pragma setup\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend / Data                         |\n| Milestone   | M1                                     |\n| Status      | done                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/002-db-connection`            |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/3 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/4 |\n\n**Description**\nImplement `src/openclaw_todo/db.py` with a `get_connection(db_path)` helper that creates the `~/.openclaw/workspace/.todo/` directory tree if missing, opens (or creates) `todo.sqlite3`, and applies `PRAGMA journal_mode=WAL` and `PRAGMA busy_timeout=3000`.\n\n**Acceptance Criteria**\n- [ ] Directory is created recursively when absent\n- [ ] SQLite connection returned with WAL mode enabled\n- [ ] `busy_timeout` is 3000\n- [ ] Calling `get_connection` twice returns usable connections (no lock conflict)\n\n**Tests**\n- `tests/test_db.py::test_creates_directory_and_file` (tmp_path)\n- `tests/test_db.py::test_wal_mode_enabled`\n- `tests/test_db.py::test_busy_timeout`\n\n**Rollback**\nRevert module; no schema changes yet.\n\n**Observability**\n`logger.info` on first DB creation; `logger.debug` on each connection open.\n\n**Dependencies**\n#1\n\n---\n\n## Issue #3: Schema migration framework and schema_version table\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend / Data                         |\n| Milestone   | M1                                     |\n| Status      | done                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/003-schema-migration`         |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/5 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/6 |\n\n**Description**\nImplement a simple sequential migration runner. On startup, read `schema_version` (create if missing), compare to available migrations list, and apply outstanding migrations in order inside a transaction.\n\n**Acceptance Criteria**\n- [ ] `schema_version` table created with single row `version=0` if absent\n- [ ] Migrations are Python callables registered in an ordered list\n- [ ] Each migration runs inside a transaction; version incremented on success\n- [ ] Re-running on an up-to-date DB is a no-op\n- [ ] Failing migration rolls back and raises with clear message\n\n**Tests**\n- `tests/test_migrations.py::test_fresh_db_gets_version_table`\n- `tests/test_migrations.py::test_applies_migrations_sequentially`\n- `tests/test_migrations.py::test_idempotent_on_rerun`\n- `tests/test_migrations.py::test_rollback_on_failure`\n\n**Rollback**\nDrop `schema_version` table; revert module.\n\n**Observability**\n`logger.info(\"Migrating from version %d to %d\", current, target)` per step.\n\n**Dependencies**\n#2\n\n---\n\n## Issue #4: V1 schema migration -- projects, tasks, task_assignees, events\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend / Data                         |\n| Milestone   | M1                                     |\n| Status      | done                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/004-v1-schema`                |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/7 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/8 |\n\n**Description**\nRegister migration v1 that creates the four tables (`projects`, `tasks`, `task_assignees`, `events`) with all columns, CHECK constraints, and partial unique indexes as specified in PRD section 6.3. Also seed shared project `Inbox`.\n\n**Acceptance Criteria**\n- [ ] `projects` table with `ux_projects_shared_name` and `ux_projects_private_owner_name` partial unique indexes\n- [ ] `tasks` table with section and status CHECK constraints\n- [ ] `task_assignees` table with composite PK and secondary index\n- [ ] `events` audit table created\n- [ ] Shared `Inbox` project auto-created (INSERT OR IGNORE)\n- [ ] `schema_version` = 1 after migration\n\n**Tests**\n- `tests/test_migrations.py::test_v1_tables_exist`\n- `tests/test_migrations.py::test_v1_inbox_created`\n- `tests/test_migrations.py::test_v1_shared_unique_index_enforced`\n- `tests/test_migrations.py::test_v1_private_unique_index_enforced`\n\n**Rollback**\nDrop all four tables + reset schema_version to 0.\n\n**Observability**\nLog table creation counts.\n\n**Dependencies**\n#3\n\n---\n\n## Issue #5: Command parser -- tokenizer and option extraction\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M2                                     |\n| Status      | doing                                  |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/005-parser-tokenizer`         |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/9 |\n| PR          | --                                     |\n\n**Description**\nImplement `src/openclaw_todo/parser.py` that takes raw message text (after `/todo` prefix) and returns a `ParsedCommand` dataclass containing: `command` (str), `args` (list), `project` (str|None), `section` (str|None), `due` (str|None, normalised to YYYY-MM-DD), `mentions` (list of Slack user IDs), and remaining `title_tokens`.\n\nParsing rules:\n- `/p <name>` extracts project\n- `/s <section>` extracts section (validate against enum)\n- `due:YYYY-MM-DD` or `due:MM-DD` extracts and normalises due date\n- `due:-` clears due (sentinel)\n- `<@U...>` patterns extracted as mentions\n- Everything else before first option token is title\n\n**Acceptance Criteria**\n- [ ] `/p MyProject` correctly extracted; token consumed\n- [ ] `/s doing` validated; invalid section raises `ParseError`\n- [ ] `due:03-15` normalised to `2026-03-15`\n- [ ] `due:2026-02-30` raises `ParseError` (invalid date)\n- [ ] `<@U12345>` extracted into mentions list\n- [ ] Multiple mentions supported\n- [ ] Title tokens are non-option, non-mention tokens before first option\n\n**Tests**\n- `tests/test_parser.py::test_extract_project`\n- `tests/test_parser.py::test_extract_section_valid`\n- `tests/test_parser.py::test_extract_section_invalid`\n- `tests/test_parser.py::test_due_mm_dd_normalisation`\n- `tests/test_parser.py::test_due_full_date`\n- `tests/test_parser.py::test_due_invalid_date`\n- `tests/test_parser.py::test_due_clear`\n- `tests/test_parser.py::test_mentions_extraction`\n- `tests/test_parser.py::test_title_extraction`\n\n**Rollback**\nRevert module; no side effects.\n\n**Observability**\n`logger.debug(\"Parsed: %s\", parsed_command)`\n\n**Dependencies**\n#1\n\n---\n\n## Issue #6: /todo add command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/006-cmd-add`                  |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `add` subcommand handler. Resolves project (default `Inbox`), applies defaults (section=`backlog`, assignees=sender if none mentioned), validates private-project assignee constraint (PRD 3.3), inserts task + task_assignees rows, logs event, and returns formatted confirmation.\n\n**Acceptance Criteria**\n- [ ] Task inserted with correct project_id, section, due, status='open', created_by\n- [ ] Assignees default to sender when no mentions\n- [ ] Multiple mentions create multiple task_assignee rows\n- [ ] Private project + non-owner assignee returns warning and does NOT insert\n- [ ] Non-existent project: `Inbox` auto-created as shared; others return error\n- [ ] Response format: `Added #<id> (<project>/<section>) due:<due|-> assignees:<mentions> -- <title>`\n- [ ] Event row written to `events` table\n\n**Tests**\n- `tests/test_cmd_add.py::test_add_default_inbox`\n- `tests/test_cmd_add.py::test_add_with_project_section_due`\n- `tests/test_cmd_add.py::test_add_private_rejects_other_assignee`\n- `tests/test_cmd_add.py::test_add_assignee_defaults_to_sender`\n- `tests/test_cmd_add.py::test_add_multiple_assignees`\n\n**Rollback**\nRevert handler; tasks table unchanged structurally.\n\n**Observability**\n`logger.info(\"Task #%d created in %s/%s by %s\", id, project, section, sender)`\n\n**Dependencies**\n#4, #5\n\n---\n\n## Issue #7: Project resolver helper\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/007-project-resolver`         |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `resolve_project(conn, name, sender_id) -> Project` following PRD 3.2 (Option A): sender's private project with that name takes priority, then shared, then error/auto-create for Inbox.\n\n**Acceptance Criteria**\n- [ ] Private project of sender matched first\n- [ ] Falls back to shared if no private match\n- [ ] Returns error when neither exists (except Inbox which is auto-created)\n- [ ] Returns project row with id, name, visibility, owner_user_id\n\n**Tests**\n- `tests/test_project_resolver.py::test_private_takes_priority`\n- `tests/test_project_resolver.py::test_falls_back_to_shared`\n- `tests/test_project_resolver.py::test_inbox_auto_created`\n- `tests/test_project_resolver.py::test_unknown_project_error`\n\n**Rollback**\nRevert module.\n\n**Observability**\n`logger.debug(\"Resolved project '%s' -> id=%d vis=%s\", name, id, visibility)`\n\n**Dependencies**\n#4\n\n---\n\n## Issue #8: /todo list command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/008-cmd-list`                 |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `list` subcommand. Supports scope (mine/all/<@USER>), project filter, section filter, status filter (open/done/drop), and limit. Sorting: due ASC (NULLs last), then id DESC. Excludes other users' private projects.\n\n**Acceptance Criteria**\n- [ ] Default scope=mine, status=open, limit=30\n- [ ] `mine` filters to tasks where sender is an assignee\n- [ ] `all` includes shared + sender's private (excludes others' private)\n- [ ] `/p` and `/s` filters applied correctly\n- [ ] Sorting: due NOT NULL first, due ASC, id DESC\n- [ ] limit:N respected\n- [ ] Output lists tasks in formatted lines\n\n**Tests**\n- `tests/test_cmd_list.py::test_list_mine_default`\n- `tests/test_cmd_list.py::test_list_all_excludes_others_private`\n- `tests/test_cmd_list.py::test_list_with_project_filter`\n- `tests/test_cmd_list.py::test_list_sorting_order`\n- `tests/test_cmd_list.py::test_list_limit`\n\n**Rollback**\nRevert handler; read-only operation.\n\n**Observability**\n`logger.info(\"list: scope=%s project=%s returned %d rows\", scope, project, count)`\n\n**Dependencies**\n#6, #7\n\n---\n\n## Issue #9: /todo board command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | done                                   |\n| Priority    | P1                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/009-cmd-board`                |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/30 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/31 |\n\n**Description**\nImplement the `board` subcommand. Groups tasks by section in fixed order (BACKLOG, DOING, WAITING, DONE, DROP), applies scope/project/status filters, and limits per section. Format: section headers with task lines underneath.\n\n**Acceptance Criteria**\n- [ ] Sections displayed in order: BACKLOG -> DOING -> WAITING -> DONE -> DROP\n- [ ] Empty sections shown with \"(empty)\" or omitted (decide and document)\n- [ ] `limitPerSection:N` caps items per section (default 10)\n- [ ] Scope/project filters identical to `list`\n- [ ] Each task line: `#id due:<date|-> assignees:<@U..> title`\n\n**Tests**\n- `tests/test_cmd_board.py::test_board_section_order`\n- `tests/test_cmd_board.py::test_board_limit_per_section`\n- `tests/test_cmd_board.py::test_board_scope_filter`\n\n**Rollback**\nRevert handler; read-only operation.\n\n**Observability**\n`logger.info(\"board: scope=%s project=%s sections=%s\", ...)`\n\n**Dependencies**\n#8\n\n---\n\n## Issue #10: /todo move command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | done                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/010-cmd-move`                 |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/23 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/24 |\n\n**Description**\nImplement the `move` subcommand. Validates section enum, checks permissions (private: owner only; shared: assignee or created_by), updates task section and updated_at, logs event.\n\n**Acceptance Criteria**\n- [ ] Section validated against enum; invalid returns error\n- [ ] Private project: only owner can move\n- [ ] Shared project: only assignee or created_by can move\n- [ ] `updated_at` set on change\n- [ ] Event logged\n- [ ] Response confirms new section\n\n**Tests**\n- `tests/test_cmd_move.py::test_move_valid_section`\n- `tests/test_cmd_move.py::test_move_invalid_section`\n- `tests/test_cmd_move.py::test_move_private_owner_only`\n- `tests/test_cmd_move.py::test_move_shared_permission`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"Task #%d moved to %s by %s\", id, section, sender)`\n\n**Dependencies**\n#6, #7\n\n---\n\n## Issue #11: /todo done and /todo drop commands\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | done                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/011-cmd-done-drop`            |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/26 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/27 |\n\n**Description**\nImplement `done` and `drop` subcommands. Both set section and status accordingly, record `closed_at`, validate permissions same as `move`, and log event.\n\n**Acceptance Criteria**\n- [ ] `done`: section='done', status='done', closed_at=now\n- [ ] `drop`: section='drop', status='dropped', closed_at=now\n- [ ] Permissions enforced (same as move)\n- [ ] Already-closed task returns informational message (idempotent or error -- decide)\n- [ ] Event logged for each\n\n**Tests**\n- `tests/test_cmd_done_drop.py::test_done_sets_fields`\n- `tests/test_cmd_done_drop.py::test_drop_sets_fields`\n- `tests/test_cmd_done_drop.py::test_permission_check`\n- `tests/test_cmd_done_drop.py::test_already_done`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"Task #%d %s by %s\", id, action, sender)`\n\n**Dependencies**\n#10\n\n---\n\n## Issue #12: /todo edit command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | done                                   |\n| Priority    | P1                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/012-cmd-edit`                 |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/34 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/35 |\n\n**Description**\nImplement the `edit` subcommand (v1 replace semantics). Supports changing title, assignees (full replace), project, section, and due. Validates private-project assignee constraint on both source and target project. Logs event with old/new diff in payload.\n\n**Acceptance Criteria**\n- [ ] Title updated only if non-option tokens present\n- [ ] Mentions present -> assignees fully replaced (DELETE + INSERT)\n- [ ] `due:-` clears due to NULL\n- [ ] `/p <newProject>` moves task to new project (project_id updated)\n- [ ] Private project assignee validation applied to target project\n- [ ] If moving to private project with non-owner assignees -> warning, no change\n- [ ] Event payload contains changed fields\n- [ ] Permissions: private owner only; shared assignee/created_by\n\n**Tests**\n- `tests/test_cmd_edit.py::test_edit_title`\n- `tests/test_cmd_edit.py::test_edit_assignees_replace`\n- `tests/test_cmd_edit.py::test_edit_due_clear`\n- `tests/test_cmd_edit.py::test_edit_move_project`\n- `tests/test_cmd_edit.py::test_edit_private_assignee_rejected`\n- `tests/test_cmd_edit.py::test_edit_no_change_fields`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"Task #%d edited by %s: fields=%s\", id, sender, changed_fields)`\n\n**Dependencies**\n#6, #7, #10\n\n---\n\n## Issue #13: /todo project list command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M4                                     |\n| Status      | done                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/013-cmd-project-list`         |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/28 |\n| PR          | Merged via PR #27 (bundled with Issue #11) |\n\n**Description**\nImplement `/todo project list`. Returns all shared projects and the sender's private projects. Format: grouped by visibility with name and task count.\n\n**Acceptance Criteria**\n- [ ] Shared projects listed regardless of sender\n- [ ] Sender's private projects listed\n- [ ] Other users' private projects NOT shown\n- [ ] Each project shows name, visibility, task count\n\n**Tests**\n- `tests/test_cmd_project.py::test_project_list_shows_shared`\n- `tests/test_cmd_project.py::test_project_list_shows_own_private`\n- `tests/test_cmd_project.py::test_project_list_hides_others_private`\n\n**Rollback**\nRevert handler; read-only.\n\n**Observability**\n`logger.info(\"project list: %d shared, %d private for %s\", ...)`\n\n**Dependencies**\n#7\n\n---\n\n## Issue #14: /todo project set-private command with assignee validation\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M4                                     |\n| Status      | done                                   |\n| Priority    | P0                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/014-cmd-project-set-private`  |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/32 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/33 |\n\n**Description**\nImplement `/todo project set-private <name>` with the assignee validation described in PRD 3.4. Resolution flow: if sender already has private with that name -> noop; if shared exists -> attempt conversion; if neither -> create new private. Conversion scans all tasks in the project and rejects if any task has a non-owner assignee.\n\n**Acceptance Criteria**\n- [ ] Already-private for sender: returns \"already private\" message\n- [ ] Shared -> private: scans tasks; all assignees are owner -> success (visibility='private', owner_user_id=sender)\n- [ ] Shared -> private: at least one non-owner assignee -> error with task IDs and violating assignee list (max 10)\n- [ ] Neither exists: creates new private project with owner=sender\n- [ ] Error message format matches PRD example\n- [ ] Event logged\n\n**Tests**\n- `tests/test_cmd_project.py::test_set_private_already_private`\n- `tests/test_cmd_project.py::test_set_private_shared_success`\n- `tests/test_cmd_project.py::test_set_private_shared_rejected_non_owner_assignee`\n- `tests/test_cmd_project.py::test_set_private_creates_new`\n- `tests/test_cmd_project.py::test_set_private_error_message_format`\n\n**Rollback**\nRevert handler; no schema change.\n\n**Observability**\n`logger.info(\"project set-private: %s result=%s by %s\", name, result, sender)`\n\n**Dependencies**\n#7, #13\n\n---\n\n## Issue #15: /todo project set-shared command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M4                                     |\n| Status      | done                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/015-cmd-project-set-shared`   |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/36 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/37 |\n\n**Description**\nImplement `/todo project set-shared <name>`. Creates a shared project if none exists. If a shared project with that name already exists, noop. Global uniqueness enforced by DB index.\n\n**Acceptance Criteria**\n- [ ] New shared project created when name is free\n- [ ] Existing shared project: returns \"already shared\" / noop\n- [ ] Name conflict with existing shared: returns exists message (index enforces)\n- [ ] Event logged\n\n**Tests**\n- `tests/test_cmd_project.py::test_set_shared_creates_new`\n- `tests/test_cmd_project.py::test_set_shared_already_exists_noop`\n- `tests/test_cmd_project.py::test_set_shared_name_conflict`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"project set-shared: %s result=%s\", name, result)`\n\n**Dependencies**\n#7, #13\n\n---\n\n## Issue #16: Command dispatcher and routing\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/016-dispatcher`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the dispatcher in `plugin.py` that maps the parsed command name to handler functions: `add`, `list`, `board`, `move`, `done`, `drop`, `edit`, `project`. The `project` command further dispatches to `list`, `set-private`, `set-shared`. Unknown commands return a help/error message.\n\n**Acceptance Criteria**\n- [ ] All valid command names routed to correct handler\n- [ ] `project` subcommands routed correctly\n- [ ] Unknown command returns usage hint\n- [ ] DB connection initialised (migration check) before first command execution\n\n**Tests**\n- `tests/test_dispatcher.py::test_routes_known_commands`\n- `tests/test_dispatcher.py::test_project_sub_routing`\n- `tests/test_dispatcher.py::test_unknown_command_help`\n\n**Rollback**\nRevert module.\n\n**Observability**\n`logger.info(\"Dispatching command=%s sub=%s\", command, sub)`\n\n**Dependencies**\n#5\n\n---\n\n## Issue #17: Permission helper module\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | done                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/017-permissions`              |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/21 |\n| PR          | (merged directly on main)              |\n\n**Description**\nExtract shared permission-checking logic into `src/openclaw_todo/permissions.py`. Provides `can_write_task(conn, task_id, sender_id) -> bool` and `validate_private_assignees(project, assignees, owner_id) -> Optional[str]` (returns warning message or None).\n\n**Acceptance Criteria**\n- [ ] Private project: only owner can write\n- [ ] Shared project: only assignee or created_by can write\n- [ ] `validate_private_assignees` returns warning string when non-owner assignees present for private project\n- [ ] Returns None for shared projects or when all assignees are owner\n\n**Tests**\n- `tests/test_permissions.py::test_private_owner_can_write`\n- `tests/test_permissions.py::test_private_non_owner_rejected`\n- `tests/test_permissions.py::test_shared_assignee_can_write`\n- `tests/test_permissions.py::test_shared_creator_can_write`\n- `tests/test_permissions.py::test_validate_private_assignees_warning`\n\n**Rollback**\nRevert module.\n\n**Observability**\n`logger.debug(\"Permission check: task=%d sender=%s result=%s\", ...)`\n\n**Dependencies**\n#4\n\n---\n\n## Issue #18: Parser unit tests (comprehensive)\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | QA                                     |\n| Milestone   | M5                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/018-parser-tests`             |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nExpand parser test coverage to include edge cases: multiple options in varied order, due at year boundary, empty title, mentions mixed with options, unicode in titles, extra whitespace handling.\n\n**Acceptance Criteria**\n- [ ] >=95% line coverage on `parser.py`\n- [ ] Edge cases documented in test docstrings\n- [ ] All tests pass with `uv run pytest tests/test_parser.py -v`\n\n**Tests**\n- `tests/test_parser.py::test_options_in_any_order`\n- `tests/test_parser.py::test_due_year_boundary`\n- `tests/test_parser.py::test_empty_title_no_crash`\n- `tests/test_parser.py::test_unicode_title`\n- `tests/test_parser.py::test_extra_whitespace`\n- `tests/test_parser.py::test_mixed_mentions_and_options`\n\n**Rollback**\nRevert test file; no production code change.\n\n**Observability**\nCI coverage report.\n\n**Dependencies**\n#5\n\n---\n\n## Issue #19: SQLite end-to-end integration tests\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | QA                                     |\n| Milestone   | M5                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/019-e2e-tests`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nWrite integration tests that exercise the full flow through `handle_message` with a real (tmp_path) SQLite database. Cover the main user stories: add a task, list it, move it, mark done, edit it, manage projects, and validate private project constraints.\n\n**Acceptance Criteria**\n- [ ] Each test uses a fresh DB via `tmp_path` fixture\n- [ ] Scenarios: add->list, add->move->board, add->done, add->edit, project set-private rejection\n- [ ] Private project visibility enforced end-to-end\n- [ ] Due normalisation verified in DB\n- [ ] All tests pass with `uv run pytest tests/test_e2e.py -v`\n\n**Tests**\n- `tests/test_e2e.py::test_add_and_list_roundtrip`\n- `tests/test_e2e.py::test_add_move_board`\n- `tests/test_e2e.py::test_done_and_drop`\n- `tests/test_e2e.py::test_edit_title_and_assignees`\n- `tests/test_e2e.py::test_private_project_isolation`\n- `tests/test_e2e.py::test_set_private_rejects_foreign_assignees`\n- `tests/test_e2e.py::test_due_normalisation_stored_correctly`\n\n**Rollback**\nRevert test file.\n\n**Observability**\nCI test results and coverage delta.\n\n**Dependencies**\n#6, #8, #9, #10, #11, #12, #14, #15\n\n---\n\n## Issue #20: Packaging and distribution setup\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | DevOps                                 |\n| Milestone   | M6                                     |\n| Status      | TODO                                   |\n| Priority    | P2                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/020-packaging`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nFinalise `pyproject.toml` metadata (name, version, description, license, entry-points), add a `Makefile` with targets for lint/test/build, and document installation instructions in README. Ensure the plugin can be installed as a package and discovered by the OpenClaw gateway.\n\n**Acceptance Criteria**\n- [ ] `pyproject.toml` has complete metadata and entry-point for OpenClaw plugin discovery\n- [ ] `make lint` runs ruff + black --check\n- [ ] `make test` runs pytest with coverage\n- [ ] `make build` produces a wheel via `uv build`\n- [ ] `pip install <wheel>` in a clean venv makes the plugin importable\n- [ ] README documents installation and configuration (DB path env var)\n\n**Tests**\n- Manual: install wheel in fresh venv, import module, call `handle_message`\n- `make test` passes in CI\n\n**Rollback**\nRevert packaging changes.\n\n**Observability**\nBuild artifact size logged; CI publishes wheel as artifact.\n\n**Dependencies**\n#19\n\n---\n\n## Dependency Graph (summary)\n\n```\n#1  Plugin skeleton\n |\n +--#2  DB connection\n |   |\n |   +--#3  Migration framework\n |       |\n |       +--#4  V1 schema\n |           |\n |           +--#7  Project resolver\n |           |   |\n |           |   +--#13 project list\n |           |   +--#14 project set-private\n |           |   +--#15 project set-shared\n |           |\n |           +--#17 Permissions helper\n |\n +--#5  Parser\n |   |\n |   +--#18 Parser tests (M5)\n |\n +--#16 Dispatcher\n     |\n     +--#6  cmd add       (#4,#5,#7,#17)\n     +--#8  cmd list      (#6,#7)\n     +--#9  cmd board     (#8)\n     +--#10 cmd move      (#6,#7,#17)\n     +--#11 cmd done/drop (#10)\n     +--#12 cmd edit      (#6,#7,#10,#17)\n\n#19 E2E tests    (all commands)\n#20 Packaging    (#19)\n#21 CI workflow   (standalone)\n```\n\n---\n\n## Issue #21: GitHub Actions CI 워크플로우\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | DevOps                                 |\n| Milestone   | M0                                     |\n| Status      | done                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/021-ci-workflow`              |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/19 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/20 |\n\n**Description**\nPR 머지 전 자동 테스트 검증을 위한 GitHub Actions CI 파이프라인을 추가합니다. push (main) + pull_request (main) 트리거로 Python 3.11 + uv + pytest 기반 테스트를 실행합니다.\n\n**Acceptance Criteria**\n- [ ] `.github/workflows/ci.yml` 생성\n- [ ] PR 생성 시 CI가 자동 실행됨\n- [ ] `uv run pytest -q --tb=short` 통과가 머지 조건\n\n**Dependencies**\nNone.\n", "structuredPatch": [{"oldStart": 749, "oldLines": 12, "newStart": 749, "newLines": 12, "lines": [" |-------------|----------------------------------------|", " | Track       | QA                                     |", " | Milestone   | M5                                     |", "-| Status      | TODO                                   |", "+| Status      | done                                   |", " | Priority    | P1                                     |", " | Estimate    | 1.5d                                   |", " | Branch      | `feature/019-e2e-tests`               |", "-| GH-Issue    | --                                     |", "-| PR          | --                                     |", "+| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/38 |", "+| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/41 |", " ", " **Description**", " Write integration tests that exercise the full flow through `handle_message` with a real (tmp_path) SQLite database. Cover the main user stories: add a task, list it, move it, mark done, edit it, manage projects, and validate private project constraints."]}], "userModified": false, "replaceAll": false}, "tool_use_id": "toolu_01P9UqEiq2bLGvejhodg4UmD", "_ts": "2026-02-21T12:00:34+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "git add issues.md STATUS.md && git commit -m \"$(cat <<'EOF'\ndocs: update issues.md and STATUS.md for Issue #19\n\nCo-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>\nEOF\n)\" && git push origin feature/019-e2e-tests", "description": "Commit and push docs update"}, "tool_use_id": "toolu_01Es444PZj7f9CARosUmacfg", "_ts": "2026-02-21T12:00:39+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "git add issues.md STATUS.md && git commit -m \"$(cat <<'EOF'\ndocs: update issues.md and STATUS.md for Issue #19\n\nCo-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>\nEOF\n)\" && git push origin feature/019-e2e-tests", "description": "Commit and push docs update"}, "tool_response": {"stdout": "[main d73be44] docs: update issues.md and STATUS.md for Issue #19\n 2 files changed, 5 insertions(+), 7 deletions(-)\nEverything up-to-date", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_01Es444PZj7f9CARosUmacfg", "_ts": "2026-02-21T12:00:41+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "git branch --show-current", "description": "Check current branch"}, "tool_use_id": "toolu_01VSDgT6Pob5gE1yXUBVpqBo", "_ts": "2026-02-21T12:00:45+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "git branch --show-current", "description": "Check current branch"}, "tool_response": {"stdout": "main", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_01VSDgT6Pob5gE1yXUBVpqBo", "_ts": "2026-02-21T12:00:45+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "COMMIT_SHA=$(git rev-parse HEAD) && git checkout feature/019-e2e-tests && git cherry-pick $COMMIT_SHA", "description": "Cherry-pick docs commit to correct branch"}, "tool_use_id": "toolu_018Def9zmc4RSjHQf3XPGfSH", "_ts": "2026-02-21T12:00:48+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUseFailure", "tool_name": "Bash", "tool_input": {"command": "COMMIT_SHA=$(git rev-parse HEAD) && git checkout feature/019-e2e-tests && git cherry-pick $COMMIT_SHA", "description": "Cherry-pick docs commit to correct branch"}, "tool_use_id": "toolu_018Def9zmc4RSjHQf3XPGfSH", "error": "Exit code 1\n'feature/019-e2e-tests' 브랜치로 전환합니다\nerror: 다음을 적용할(apply) 수 없습니다: d73be44... docs: update issues.md and STATUS.md for Issue #19\n힌트: After resolving the conflicts, mark them with\n힌트: \"git add/rm <pathspec>\", then run\n힌트: \"git cherry-pick --continue\".\n힌트: You can instead skip this commit with \"git cherry-pick --skip\".\n힌트: To abort and get back to the state before \"git cherry-pick\",\n힌트: run \"git cherry-pick --abort\".\n\nM\t.claude/run/agent-state.json\nM\t.claude/run/events.jsonl\n브랜치가 'origin/feature/019-e2e-tests'에 맞게 업데이트된 상태입니다.\n자동 병합: issues.md\n충돌 (내용): issues.md에 병합 충돌", "is_interrupt": false, "_ts": "2026-02-21T12:00:49+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "git cherry-pick --abort", "description": "Abort cherry-pick"}, "tool_use_id": "toolu_01Qhd98sbd4FdkShHiYSBcUN", "_ts": "2026-02-21T12:00:52+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "git cherry-pick --abort", "description": "Abort cherry-pick"}, "tool_response": {"stdout": "", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_01Qhd98sbd4FdkShHiYSBcUN", "_ts": "2026-02-21T12:00:52+0900"}
{"session_id": "e02e763a-9559-492f-8eda-46e7ce5ebc26", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/e02e763a-9559-492f-8eda-46e7ce5ebc26.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Write", "tool_input": {"file_path": "/tmp/review_notes_issue18.txt", "content": "# Code Review & Security Audit -- PR #40 (Issue #18: Parser unit tests)\n\n**Reviewer:** Claude Opus 4.6 (automated)\n**Date:** 2026-02-21\n**Branch:** `feature/018-parser-tests`\n**Files changed:** `tests/test_parser.py`, `STATUS.md`, `issues.md`\n\n---\n\n## Code Review\n\n### Verdict: APPROVE\n\nThis is a well-structured, thorough test expansion that brings `parser.py` from partial\ncoverage to 100% line coverage (83/83 statements). The new tests are organized into\nlogical test classes with clear docstrings, and all 50 tests pass.\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| >=95% line coverage on `parser.py` | PASS | 100% (83/83 stmts, 0 missing) |\n| Edge cases documented in test docstrings | PASS | Every test method has a docstring |\n| All tests pass with `uv run pytest tests/test_parser.py -v` | PASS | 50/50 passed |\n| `test_options_in_any_order` | PASS | `TestOptionsInAnyOrder` class (5 tests) |\n| `test_due_year_boundary` | PASS | `TestDueYearBoundary` class (6 tests) |\n| `test_empty_title_no_crash` | PASS | `TestEmptyTitleNoCrash` class (4 tests) |\n| `test_unicode_title` | PASS | `TestUnicodeTitle` class (3 tests) |\n| `test_extra_whitespace` | PASS | `TestExtraWhitespace` class (3 tests) |\n| `test_mixed_mentions_and_options` | PASS | `TestMixedMentionsAndOptions` class (3 tests) |\n\n### Coverage Gap Verification\n\nThe PR description claimed gaps at lines 61-62, 93, 101. These correspond to:\n- **Lines 61-62:** MM-DD date parsing branch where the `date()` constructor fails\n  (ValueError) -- now covered by `test_due_mm_dd_invalid_day` and `test_due_mm_dd_invalid_month`\n- **Line 93:** `/p` missing argument error path -- now covered by `test_p_at_end_without_value`\n- **Line 101:** `/s` missing argument error path -- now covered by `test_s_at_end_without_value`\n\nAll gaps are confirmed closed. Coverage is 100%.\n\n### Findings\n\n#### Positive\n\n1. **Well-organized structure.** The new tests use test classes grouped by concern\n   (`TestOptionsInAnyOrder`, `TestDueYearBoundary`, etc.), which improves readability\n   over a flat list of functions. The original 13 tests from Issue #5 are preserved\n   unchanged at the top of the file.\n\n2. **Good edge case coverage.** Tests cover: duplicate options (last-wins semantics),\n   garbage due date strings, whitespace-only input, tab characters, Korean/Japanese\n   unicode, emoji, single-digit month/day (`1-1`), all five valid sections via\n   parametrize, and negative tests for `add` not extracting an ID arg.\n\n3. **Parametrized section test.** `TestAllSections::test_valid_section` uses\n   `@pytest.mark.parametrize` for all 5 valid sections -- clean and maintainable.\n\n4. **No shared state.** Each test is fully independent; no fixtures, no class-level\n   setup, no global mutable state. The parser is pure-functional so this is appropriate.\n\n#### Minor Issues (non-blocking)\n\n1. **`ParsedCommand` import unused (line 5).** `ParsedCommand` is imported but never\n   referenced directly in any assertion. Tests rely on attribute access on the returned\n   object, which is correct, but the unused import could be removed for cleanliness.\n   Severity: trivial.\n\n2. **Hardcoded year 2026 in some tests.** Tests like `test_due_full_date` and\n   `test_due_feb_29_leap_year` use hardcoded years (2026, 2028). These are fine since\n   full-date parsing does not depend on the current year, but a comment noting this\n   intent would improve clarity. The MM-DD tests correctly use `date.today().year`.\n   Severity: trivial.\n\n3. **`from datetime import date` inside test functions (lines 32, 152, 159).** Three\n   tests import `date` locally rather than at the module top. This is harmless but\n   inconsistent -- the module-level imports section would be the conventional place.\n   Severity: trivial / style.\n\n4. **Duplicate due date test.** `test_due_invalid_date` (line 45, full YYYY-MM-DD\n   format `2026-02-30`) and `TestDueYearBoundary::test_due_mm_dd_invalid_day` (line\n   168, MM-DD format `2-30`) both test Feb 30, but via different code paths. This is\n   actually good -- they exercise different branches in `_normalise_due`. No action\n   needed.\n\n5. **No test for `due:` with empty value.** `parse(\"add Task due:\")` would match\n   `_DUE_RE` with an empty capture group, then hit `_normalise_due(\"\")`. This would\n   fail at both strptime and the MM-DD regex, ultimately raising `ParseError`. While\n   the behavior is correct, an explicit test would document it.\n   Severity: low.\n\n6. **No test for mention-like but invalid patterns.** E.g., `<@invalid>` (lowercase)\n   would NOT match `_MENTION_RE` (`U[A-Z0-9]+`) and would become a title token. An\n   explicit test documenting this behavior would be useful.\n   Severity: low.\n\n### Test Isolation & Fixtures\n\nNo issues. All tests are stateless. The parser module has no side effects (no DB, no\nnetwork, no filesystem). No fixtures are needed or used.\n\n---\n\n## Security Findings\n\nSince this PR contains only test code, the security surface is minimal.\n\n| # | Severity | Finding | Status |\n|---|----------|---------|--------|\n| 1 | Low | **No hardcoded secrets or credentials.** All test data uses placeholder Slack user IDs (`U12345`, `UALICE`, etc.) and project names. | PASS |\n| 2 | Low | **No dangerous imports.** Only `pytest` and project-internal modules are imported. No `os`, `subprocess`, `eval`, `pickle`, or network modules. | PASS |\n| 3 | Low | **No test code that could be exploited if deployed.** Tests only call the pure `parse()` function with string inputs. No file I/O, no exec. | PASS |\n| 4 | Info | **`__pycache__` bytecode files tracked in git.** The git status shows `.pyc` files are tracked. These should be in `.gitignore`. Not a security issue per se, but bytecode files can obscure code changes and should not be committed. | NOTE |\n\nNo security issues found in this PR.\n\n---\n\n## Follow-up Issues (Proposed)\n\n1. **Add `.pyc`/`__pycache__` to `.gitignore`.**\n   The repo tracks compiled Python bytecode files. Add `__pycache__/` and `*.pyc` to\n   `.gitignore` and remove them from tracking. This is a hygiene issue visible in the\n   git status output.\n\n2. **Test for `due:` with empty value.**\n   Add `test_due_empty_value` to verify that `parse(\"add Task due:\")` raises\n   `ParseError`. This documents the behavior for a plausible user typo.\n\n3. **Test for non-matching mention-like tokens.**\n   Add a test verifying that `<@lowercase>` or `<@>` are treated as title tokens,\n   not mentions. This documents the regex boundary behavior.\n\n4. **Move `from datetime import date` to module-level imports.**\n   Three tests import `date` inside the function body. Moving them to the top of the\n   file would follow Python conventions. Trivial cleanup.\n\n5. **Remove unused `ParsedCommand` import.**\n   Line 5 imports `ParsedCommand` but it is never used in assertions. Remove it or\n   add a type-annotation test that references it.\n\n---\n\n## Summary\n\nPR #40 meets all acceptance criteria for Issue #18. Coverage on `parser.py` is 100%.\nTests are well-organized, correctly validate parser behavior, and have no security\nconcerns. Recommend **APPROVE** with optional minor cleanups tracked as follow-ups.\n"}, "tool_use_id": "toolu_015tYnN25ZupRgNCQpcZnKUk", "_ts": "2026-02-21T12:00:54+0900"}
{"session_id": "e02e763a-9559-492f-8eda-46e7ce5ebc26", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/e02e763a-9559-492f-8eda-46e7ce5ebc26.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Write", "tool_input": {"file_path": "/tmp/review_notes_issue18.txt", "content": "# Code Review & Security Audit -- PR #40 (Issue #18: Parser unit tests)\n\n**Reviewer:** Claude Opus 4.6 (automated)\n**Date:** 2026-02-21\n**Branch:** `feature/018-parser-tests`\n**Files changed:** `tests/test_parser.py`, `STATUS.md`, `issues.md`\n\n---\n\n## Code Review\n\n### Verdict: APPROVE\n\nThis is a well-structured, thorough test expansion that brings `parser.py` from partial\ncoverage to 100% line coverage (83/83 statements). The new tests are organized into\nlogical test classes with clear docstrings, and all 50 tests pass.\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| >=95% line coverage on `parser.py` | PASS | 100% (83/83 stmts, 0 missing) |\n| Edge cases documented in test docstrings | PASS | Every test method has a docstring |\n| All tests pass with `uv run pytest tests/test_parser.py -v` | PASS | 50/50 passed |\n| `test_options_in_any_order` | PASS | `TestOptionsInAnyOrder` class (5 tests) |\n| `test_due_year_boundary` | PASS | `TestDueYearBoundary` class (6 tests) |\n| `test_empty_title_no_crash` | PASS | `TestEmptyTitleNoCrash` class (4 tests) |\n| `test_unicode_title` | PASS | `TestUnicodeTitle` class (3 tests) |\n| `test_extra_whitespace` | PASS | `TestExtraWhitespace` class (3 tests) |\n| `test_mixed_mentions_and_options` | PASS | `TestMixedMentionsAndOptions` class (3 tests) |\n\n### Coverage Gap Verification\n\nThe PR description claimed gaps at lines 61-62, 93, 101. These correspond to:\n- **Lines 61-62:** MM-DD date parsing branch where the `date()` constructor fails\n  (ValueError) -- now covered by `test_due_mm_dd_invalid_day` and `test_due_mm_dd_invalid_month`\n- **Line 93:** `/p` missing argument error path -- now covered by `test_p_at_end_without_value`\n- **Line 101:** `/s` missing argument error path -- now covered by `test_s_at_end_without_value`\n\nAll gaps are confirmed closed. Coverage is 100%.\n\n### Findings\n\n#### Positive\n\n1. **Well-organized structure.** The new tests use test classes grouped by concern\n   (`TestOptionsInAnyOrder`, `TestDueYearBoundary`, etc.), which improves readability\n   over a flat list of functions. The original 13 tests from Issue #5 are preserved\n   unchanged at the top of the file.\n\n2. **Good edge case coverage.** Tests cover: duplicate options (last-wins semantics),\n   garbage due date strings, whitespace-only input, tab characters, Korean/Japanese\n   unicode, emoji, single-digit month/day (`1-1`), all five valid sections via\n   parametrize, and negative tests for `add` not extracting an ID arg.\n\n3. **Parametrized section test.** `TestAllSections::test_valid_section` uses\n   `@pytest.mark.parametrize` for all 5 valid sections -- clean and maintainable.\n\n4. **No shared state.** Each test is fully independent; no fixtures, no class-level\n   setup, no global mutable state. The parser is pure-functional so this is appropriate.\n\n#### Minor Issues (non-blocking)\n\n1. **`ParsedCommand` import unused (line 5).** `ParsedCommand` is imported but never\n   referenced directly in any assertion. Tests rely on attribute access on the returned\n   object, which is correct, but the unused import could be removed for cleanliness.\n   Severity: trivial.\n\n2. **Hardcoded year 2026 in some tests.** Tests like `test_due_full_date` and\n   `test_due_feb_29_leap_year` use hardcoded years (2026, 2028). These are fine since\n   full-date parsing does not depend on the current year, but a comment noting this\n   intent would improve clarity. The MM-DD tests correctly use `date.today().year`.\n   Severity: trivial.\n\n3. **`from datetime import date` inside test functions (lines 32, 152, 159).** Three\n   tests import `date` locally rather than at the module top. This is harmless but\n   inconsistent -- the module-level imports section would be the conventional place.\n   Severity: trivial / style.\n\n4. **Duplicate due date test.** `test_due_invalid_date` (line 45, full YYYY-MM-DD\n   format `2026-02-30`) and `TestDueYearBoundary::test_due_mm_dd_invalid_day` (line\n   168, MM-DD format `2-30`) both test Feb 30, but via different code paths. This is\n   actually good -- they exercise different branches in `_normalise_due`. No action\n   needed.\n\n5. **No test for `due:` with empty value.** `parse(\"add Task due:\")` would match\n   `_DUE_RE` with an empty capture group, then hit `_normalise_due(\"\")`. This would\n   fail at both strptime and the MM-DD regex, ultimately raising `ParseError`. While\n   the behavior is correct, an explicit test would document it.\n   Severity: low.\n\n6. **No test for mention-like but invalid patterns.** E.g., `<@invalid>` (lowercase)\n   would NOT match `_MENTION_RE` (`U[A-Z0-9]+`) and would become a title token. An\n   explicit test documenting this behavior would be useful.\n   Severity: low.\n\n### Test Isolation & Fixtures\n\nNo issues. All tests are stateless. The parser module has no side effects (no DB, no\nnetwork, no filesystem). No fixtures are needed or used.\n\n---\n\n## Security Findings\n\nSince this PR contains only test code, the security surface is minimal.\n\n| # | Severity | Finding | Status |\n|---|----------|---------|--------|\n| 1 | Low | **No hardcoded secrets or credentials.** All test data uses placeholder Slack user IDs (`U12345`, `UALICE`, etc.) and project names. | PASS |\n| 2 | Low | **No dangerous imports.** Only `pytest` and project-internal modules are imported. No `os`, `subprocess`, `eval`, `pickle`, or network modules. | PASS |\n| 3 | Low | **No test code that could be exploited if deployed.** Tests only call the pure `parse()` function with string inputs. No file I/O, no exec. | PASS |\n| 4 | Info | **`__pycache__` bytecode files tracked in git.** The git status shows `.pyc` files are tracked. These should be in `.gitignore`. Not a security issue per se, but bytecode files can obscure code changes and should not be committed. | NOTE |\n\nNo security issues found in this PR.\n\n---\n\n## Follow-up Issues (Proposed)\n\n1. **Add `.pyc`/`__pycache__` to `.gitignore`.**\n   The repo tracks compiled Python bytecode files. Add `__pycache__/` and `*.pyc` to\n   `.gitignore` and remove them from tracking. This is a hygiene issue visible in the\n   git status output.\n\n2. **Test for `due:` with empty value.**\n   Add `test_due_empty_value` to verify that `parse(\"add Task due:\")` raises\n   `ParseError`. This documents the behavior for a plausible user typo.\n\n3. **Test for non-matching mention-like tokens.**\n   Add a test verifying that `<@lowercase>` or `<@>` are treated as title tokens,\n   not mentions. This documents the regex boundary behavior.\n\n4. **Move `from datetime import date` to module-level imports.**\n   Three tests import `date` inside the function body. Moving them to the top of the\n   file would follow Python conventions. Trivial cleanup.\n\n5. **Remove unused `ParsedCommand` import.**\n   Line 5 imports `ParsedCommand` but it is never used in assertions. Remove it or\n   add a type-annotation test that references it.\n\n---\n\n## Summary\n\nPR #40 meets all acceptance criteria for Issue #18. Coverage on `parser.py` is 100%.\nTests are well-organized, correctly validate parser behavior, and have no security\nconcerns. Recommend **APPROVE** with optional minor cleanups tracked as follow-ups.\n"}, "tool_response": {"type": "create", "filePath": "/tmp/review_notes_issue18.txt", "content": "# Code Review & Security Audit -- PR #40 (Issue #18: Parser unit tests)\n\n**Reviewer:** Claude Opus 4.6 (automated)\n**Date:** 2026-02-21\n**Branch:** `feature/018-parser-tests`\n**Files changed:** `tests/test_parser.py`, `STATUS.md`, `issues.md`\n\n---\n\n## Code Review\n\n### Verdict: APPROVE\n\nThis is a well-structured, thorough test expansion that brings `parser.py` from partial\ncoverage to 100% line coverage (83/83 statements). The new tests are organized into\nlogical test classes with clear docstrings, and all 50 tests pass.\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| >=95% line coverage on `parser.py` | PASS | 100% (83/83 stmts, 0 missing) |\n| Edge cases documented in test docstrings | PASS | Every test method has a docstring |\n| All tests pass with `uv run pytest tests/test_parser.py -v` | PASS | 50/50 passed |\n| `test_options_in_any_order` | PASS | `TestOptionsInAnyOrder` class (5 tests) |\n| `test_due_year_boundary` | PASS | `TestDueYearBoundary` class (6 tests) |\n| `test_empty_title_no_crash` | PASS | `TestEmptyTitleNoCrash` class (4 tests) |\n| `test_unicode_title` | PASS | `TestUnicodeTitle` class (3 tests) |\n| `test_extra_whitespace` | PASS | `TestExtraWhitespace` class (3 tests) |\n| `test_mixed_mentions_and_options` | PASS | `TestMixedMentionsAndOptions` class (3 tests) |\n\n### Coverage Gap Verification\n\nThe PR description claimed gaps at lines 61-62, 93, 101. These correspond to:\n- **Lines 61-62:** MM-DD date parsing branch where the `date()` constructor fails\n  (ValueError) -- now covered by `test_due_mm_dd_invalid_day` and `test_due_mm_dd_invalid_month`\n- **Line 93:** `/p` missing argument error path -- now covered by `test_p_at_end_without_value`\n- **Line 101:** `/s` missing argument error path -- now covered by `test_s_at_end_without_value`\n\nAll gaps are confirmed closed. Coverage is 100%.\n\n### Findings\n\n#### Positive\n\n1. **Well-organized structure.** The new tests use test classes grouped by concern\n   (`TestOptionsInAnyOrder`, `TestDueYearBoundary`, etc.), which improves readability\n   over a flat list of functions. The original 13 tests from Issue #5 are preserved\n   unchanged at the top of the file.\n\n2. **Good edge case coverage.** Tests cover: duplicate options (last-wins semantics),\n   garbage due date strings, whitespace-only input, tab characters, Korean/Japanese\n   unicode, emoji, single-digit month/day (`1-1`), all five valid sections via\n   parametrize, and negative tests for `add` not extracting an ID arg.\n\n3. **Parametrized section test.** `TestAllSections::test_valid_section` uses\n   `@pytest.mark.parametrize` for all 5 valid sections -- clean and maintainable.\n\n4. **No shared state.** Each test is fully independent; no fixtures, no class-level\n   setup, no global mutable state. The parser is pure-functional so this is appropriate.\n\n#### Minor Issues (non-blocking)\n\n1. **`ParsedCommand` import unused (line 5).** `ParsedCommand` is imported but never\n   referenced directly in any assertion. Tests rely on attribute access on the returned\n   object, which is correct, but the unused import could be removed for cleanliness.\n   Severity: trivial.\n\n2. **Hardcoded year 2026 in some tests.** Tests like `test_due_full_date` and\n   `test_due_feb_29_leap_year` use hardcoded years (2026, 2028). These are fine since\n   full-date parsing does not depend on the current year, but a comment noting this\n   intent would improve clarity. The MM-DD tests correctly use `date.today().year`.\n   Severity: trivial.\n\n3. **`from datetime import date` inside test functions (lines 32, 152, 159).** Three\n   tests import `date` locally rather than at the module top. This is harmless but\n   inconsistent -- the module-level imports section would be the conventional place.\n   Severity: trivial / style.\n\n4. **Duplicate due date test.** `test_due_invalid_date` (line 45, full YYYY-MM-DD\n   format `2026-02-30`) and `TestDueYearBoundary::test_due_mm_dd_invalid_day` (line\n   168, MM-DD format `2-30`) both test Feb 30, but via different code paths. This is\n   actually good -- they exercise different branches in `_normalise_due`. No action\n   needed.\n\n5. **No test for `due:` with empty value.** `parse(\"add Task due:\")` would match\n   `_DUE_RE` with an empty capture group, then hit `_normalise_due(\"\")`. This would\n   fail at both strptime and the MM-DD regex, ultimately raising `ParseError`. While\n   the behavior is correct, an explicit test would document it.\n   Severity: low.\n\n6. **No test for mention-like but invalid patterns.** E.g., `<@invalid>` (lowercase)\n   would NOT match `_MENTION_RE` (`U[A-Z0-9]+`) and would become a title token. An\n   explicit test documenting this behavior would be useful.\n   Severity: low.\n\n### Test Isolation & Fixtures\n\nNo issues. All tests are stateless. The parser module has no side effects (no DB, no\nnetwork, no filesystem). No fixtures are needed or used.\n\n---\n\n## Security Findings\n\nSince this PR contains only test code, the security surface is minimal.\n\n| # | Severity | Finding | Status |\n|---|----------|---------|--------|\n| 1 | Low | **No hardcoded secrets or credentials.** All test data uses placeholder Slack user IDs (`U12345`, `UALICE`, etc.) and project names. | PASS |\n| 2 | Low | **No dangerous imports.** Only `pytest` and project-internal modules are imported. No `os`, `subprocess`, `eval`, `pickle`, or network modules. | PASS |\n| 3 | Low | **No test code that could be exploited if deployed.** Tests only call the pure `parse()` function with string inputs. No file I/O, no exec. | PASS |\n| 4 | Info | **`__pycache__` bytecode files tracked in git.** The git status shows `.pyc` files are tracked. These should be in `.gitignore`. Not a security issue per se, but bytecode files can obscure code changes and should not be committed. | NOTE |\n\nNo security issues found in this PR.\n\n---\n\n## Follow-up Issues (Proposed)\n\n1. **Add `.pyc`/`__pycache__` to `.gitignore`.**\n   The repo tracks compiled Python bytecode files. Add `__pycache__/` and `*.pyc` to\n   `.gitignore` and remove them from tracking. This is a hygiene issue visible in the\n   git status output.\n\n2. **Test for `due:` with empty value.**\n   Add `test_due_empty_value` to verify that `parse(\"add Task due:\")` raises\n   `ParseError`. This documents the behavior for a plausible user typo.\n\n3. **Test for non-matching mention-like tokens.**\n   Add a test verifying that `<@lowercase>` or `<@>` are treated as title tokens,\n   not mentions. This documents the regex boundary behavior.\n\n4. **Move `from datetime import date` to module-level imports.**\n   Three tests import `date` inside the function body. Moving them to the top of the\n   file would follow Python conventions. Trivial cleanup.\n\n5. **Remove unused `ParsedCommand` import.**\n   Line 5 imports `ParsedCommand` but it is never used in assertions. Remove it or\n   add a type-annotation test that references it.\n\n---\n\n## Summary\n\nPR #40 meets all acceptance criteria for Issue #18. Coverage on `parser.py` is 100%.\nTests are well-organized, correctly validate parser behavior, and have no security\nconcerns. Recommend **APPROVE** with optional minor cleanups tracked as follow-ups.\n", "structuredPatch": [], "originalFile": null}, "tool_use_id": "toolu_015tYnN25ZupRgNCQpcZnKUk", "_ts": "2026-02-21T12:00:54+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md", "offset": 746, "limit": 15}, "tool_use_id": "toolu_01WbdKQ17Y7hEPi1FgU5MYcp", "_ts": "2026-02-21T12:00:56+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md", "offset": 746, "limit": 15}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md", "content": "## Issue #19: SQLite end-to-end integration tests\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | QA                                     |\n| Milestone   | M5                                     |\n| Status      | done                                   |\n| Priority    | P1                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/019-e2e-tests`               |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/38 |\n| PR          | --                                     |\n\n**Description**\nWrite integration tests that exercise the full flow through `handle_message` with a real (tmp_path) SQLite database. Cover the main user stories: add a task, list it, move it, mark done, edit it, manage projects, and validate private project constraints.", "numLines": 15, "startLine": 746, "totalLines": 890}}, "tool_use_id": "toolu_01WbdKQ17Y7hEPi1FgU5MYcp", "_ts": "2026-02-21T12:00:56+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md", "old_string": "| PR          | --                                     |\n\n**Description**\nWrite integration tests that exercise the full flow through `handle_message` with a real (tmp_path) SQLite database. Cover the main user stories: add a task, list it, move it, mark done, edit it, manage projects, and validate private project constraints.", "new_string": "| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/41 |\n\n**Description**\nWrite integration tests that exercise the full flow through `handle_message` with a real (tmp_path) SQLite database. Cover the main user stories: add a task, list it, move it, mark done, edit it, manage projects, and validate private project constraints.", "replace_all": false}, "tool_use_id": "toolu_01JDSKQq139gcFLuJuQ1HVay", "_ts": "2026-02-21T12:01:01+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md", "old_string": "| PR          | --                                     |\n\n**Description**\nWrite integration tests that exercise the full flow through `handle_message` with a real (tmp_path) SQLite database. Cover the main user stories: add a task, list it, move it, mark done, edit it, manage projects, and validate private project constraints.", "new_string": "| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/41 |\n\n**Description**\nWrite integration tests that exercise the full flow through `handle_message` with a real (tmp_path) SQLite database. Cover the main user stories: add a task, list it, move it, mark done, edit it, manage projects, and validate private project constraints.", "replace_all": false}, "tool_response": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/issues.md", "oldString": "| PR          | --                                     |\n\n**Description**\nWrite integration tests that exercise the full flow through `handle_message` with a real (tmp_path) SQLite database. Cover the main user stories: add a task, list it, move it, mark done, edit it, manage projects, and validate private project constraints.", "newString": "| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/41 |\n\n**Description**\nWrite integration tests that exercise the full flow through `handle_message` with a real (tmp_path) SQLite database. Cover the main user stories: add a task, list it, move it, mark done, edit it, manage projects, and validate private project constraints.", "originalFile": "# OpenClaw TODO Plugin -- Issues\n\n> Auto-generated from `openclaw_todo_plugin_prd.md` (PRD v1.1)\n> Date: 2026-02-20\n\n---\n\n## Issue #1: Plugin skeleton and entry point\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M0                                     |\n| Status      | done                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/001-plugin-skeleton`          |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/1 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/2 |\n\n**Description**\nCreate the Python project scaffold: `pyproject.toml` (uv), `src/openclaw_todo/` package layout, and the plugin entry-point that the OpenClaw gateway will load. The plugin must expose a callable that receives raw Slack DM text and a sender context dict.\n\n**Acceptance Criteria**\n- [ ] `pyproject.toml` exists with Python >=3.11, pytest, pytest-cov dev deps\n- [ ] `src/openclaw_todo/__init__.py` exposes `__version__`\n- [ ] `src/openclaw_todo/plugin.py` contains `handle_message(text: str, context: dict) -> str` entry point\n- [ ] Messages not starting with `/todo` are silently ignored (returns `None`)\n- [ ] `uv sync && uv run pytest -q` passes (trivial smoke test)\n\n**Tests**\n- `tests/test_plugin.py::test_ignores_non_todo_message`\n- `tests/test_plugin.py::test_dispatches_todo_prefix`\n\n**Rollback**\nDelete branch; no runtime dependency.\n\n**Observability**\n`logger.debug` on every inbound message; `logger.info` when `/todo` prefix matched.\n\n**Dependencies**\nNone.\n\n---\n\n## Issue #2: DB module -- connection helper and pragma setup\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend / Data                         |\n| Milestone   | M1                                     |\n| Status      | done                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/002-db-connection`            |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/3 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/4 |\n\n**Description**\nImplement `src/openclaw_todo/db.py` with a `get_connection(db_path)` helper that creates the `~/.openclaw/workspace/.todo/` directory tree if missing, opens (or creates) `todo.sqlite3`, and applies `PRAGMA journal_mode=WAL` and `PRAGMA busy_timeout=3000`.\n\n**Acceptance Criteria**\n- [ ] Directory is created recursively when absent\n- [ ] SQLite connection returned with WAL mode enabled\n- [ ] `busy_timeout` is 3000\n- [ ] Calling `get_connection` twice returns usable connections (no lock conflict)\n\n**Tests**\n- `tests/test_db.py::test_creates_directory_and_file` (tmp_path)\n- `tests/test_db.py::test_wal_mode_enabled`\n- `tests/test_db.py::test_busy_timeout`\n\n**Rollback**\nRevert module; no schema changes yet.\n\n**Observability**\n`logger.info` on first DB creation; `logger.debug` on each connection open.\n\n**Dependencies**\n#1\n\n---\n\n## Issue #3: Schema migration framework and schema_version table\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend / Data                         |\n| Milestone   | M1                                     |\n| Status      | done                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/003-schema-migration`         |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/5 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/6 |\n\n**Description**\nImplement a simple sequential migration runner. On startup, read `schema_version` (create if missing), compare to available migrations list, and apply outstanding migrations in order inside a transaction.\n\n**Acceptance Criteria**\n- [ ] `schema_version` table created with single row `version=0` if absent\n- [ ] Migrations are Python callables registered in an ordered list\n- [ ] Each migration runs inside a transaction; version incremented on success\n- [ ] Re-running on an up-to-date DB is a no-op\n- [ ] Failing migration rolls back and raises with clear message\n\n**Tests**\n- `tests/test_migrations.py::test_fresh_db_gets_version_table`\n- `tests/test_migrations.py::test_applies_migrations_sequentially`\n- `tests/test_migrations.py::test_idempotent_on_rerun`\n- `tests/test_migrations.py::test_rollback_on_failure`\n\n**Rollback**\nDrop `schema_version` table; revert module.\n\n**Observability**\n`logger.info(\"Migrating from version %d to %d\", current, target)` per step.\n\n**Dependencies**\n#2\n\n---\n\n## Issue #4: V1 schema migration -- projects, tasks, task_assignees, events\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend / Data                         |\n| Milestone   | M1                                     |\n| Status      | done                                   |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/004-v1-schema`                |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/7 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/8 |\n\n**Description**\nRegister migration v1 that creates the four tables (`projects`, `tasks`, `task_assignees`, `events`) with all columns, CHECK constraints, and partial unique indexes as specified in PRD section 6.3. Also seed shared project `Inbox`.\n\n**Acceptance Criteria**\n- [ ] `projects` table with `ux_projects_shared_name` and `ux_projects_private_owner_name` partial unique indexes\n- [ ] `tasks` table with section and status CHECK constraints\n- [ ] `task_assignees` table with composite PK and secondary index\n- [ ] `events` audit table created\n- [ ] Shared `Inbox` project auto-created (INSERT OR IGNORE)\n- [ ] `schema_version` = 1 after migration\n\n**Tests**\n- `tests/test_migrations.py::test_v1_tables_exist`\n- `tests/test_migrations.py::test_v1_inbox_created`\n- `tests/test_migrations.py::test_v1_shared_unique_index_enforced`\n- `tests/test_migrations.py::test_v1_private_unique_index_enforced`\n\n**Rollback**\nDrop all four tables + reset schema_version to 0.\n\n**Observability**\nLog table creation counts.\n\n**Dependencies**\n#3\n\n---\n\n## Issue #5: Command parser -- tokenizer and option extraction\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M2                                     |\n| Status      | doing                                  |\n| Priority    | P0                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/005-parser-tokenizer`         |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/9 |\n| PR          | --                                     |\n\n**Description**\nImplement `src/openclaw_todo/parser.py` that takes raw message text (after `/todo` prefix) and returns a `ParsedCommand` dataclass containing: `command` (str), `args` (list), `project` (str|None), `section` (str|None), `due` (str|None, normalised to YYYY-MM-DD), `mentions` (list of Slack user IDs), and remaining `title_tokens`.\n\nParsing rules:\n- `/p <name>` extracts project\n- `/s <section>` extracts section (validate against enum)\n- `due:YYYY-MM-DD` or `due:MM-DD` extracts and normalises due date\n- `due:-` clears due (sentinel)\n- `<@U...>` patterns extracted as mentions\n- Everything else before first option token is title\n\n**Acceptance Criteria**\n- [ ] `/p MyProject` correctly extracted; token consumed\n- [ ] `/s doing` validated; invalid section raises `ParseError`\n- [ ] `due:03-15` normalised to `2026-03-15`\n- [ ] `due:2026-02-30` raises `ParseError` (invalid date)\n- [ ] `<@U12345>` extracted into mentions list\n- [ ] Multiple mentions supported\n- [ ] Title tokens are non-option, non-mention tokens before first option\n\n**Tests**\n- `tests/test_parser.py::test_extract_project`\n- `tests/test_parser.py::test_extract_section_valid`\n- `tests/test_parser.py::test_extract_section_invalid`\n- `tests/test_parser.py::test_due_mm_dd_normalisation`\n- `tests/test_parser.py::test_due_full_date`\n- `tests/test_parser.py::test_due_invalid_date`\n- `tests/test_parser.py::test_due_clear`\n- `tests/test_parser.py::test_mentions_extraction`\n- `tests/test_parser.py::test_title_extraction`\n\n**Rollback**\nRevert module; no side effects.\n\n**Observability**\n`logger.debug(\"Parsed: %s\", parsed_command)`\n\n**Dependencies**\n#1\n\n---\n\n## Issue #6: /todo add command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/006-cmd-add`                  |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `add` subcommand handler. Resolves project (default `Inbox`), applies defaults (section=`backlog`, assignees=sender if none mentioned), validates private-project assignee constraint (PRD 3.3), inserts task + task_assignees rows, logs event, and returns formatted confirmation.\n\n**Acceptance Criteria**\n- [ ] Task inserted with correct project_id, section, due, status='open', created_by\n- [ ] Assignees default to sender when no mentions\n- [ ] Multiple mentions create multiple task_assignee rows\n- [ ] Private project + non-owner assignee returns warning and does NOT insert\n- [ ] Non-existent project: `Inbox` auto-created as shared; others return error\n- [ ] Response format: `Added #<id> (<project>/<section>) due:<due|-> assignees:<mentions> -- <title>`\n- [ ] Event row written to `events` table\n\n**Tests**\n- `tests/test_cmd_add.py::test_add_default_inbox`\n- `tests/test_cmd_add.py::test_add_with_project_section_due`\n- `tests/test_cmd_add.py::test_add_private_rejects_other_assignee`\n- `tests/test_cmd_add.py::test_add_assignee_defaults_to_sender`\n- `tests/test_cmd_add.py::test_add_multiple_assignees`\n\n**Rollback**\nRevert handler; tasks table unchanged structurally.\n\n**Observability**\n`logger.info(\"Task #%d created in %s/%s by %s\", id, project, section, sender)`\n\n**Dependencies**\n#4, #5\n\n---\n\n## Issue #7: Project resolver helper\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/007-project-resolver`         |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement `resolve_project(conn, name, sender_id) -> Project` following PRD 3.2 (Option A): sender's private project with that name takes priority, then shared, then error/auto-create for Inbox.\n\n**Acceptance Criteria**\n- [ ] Private project of sender matched first\n- [ ] Falls back to shared if no private match\n- [ ] Returns error when neither exists (except Inbox which is auto-created)\n- [ ] Returns project row with id, name, visibility, owner_user_id\n\n**Tests**\n- `tests/test_project_resolver.py::test_private_takes_priority`\n- `tests/test_project_resolver.py::test_falls_back_to_shared`\n- `tests/test_project_resolver.py::test_inbox_auto_created`\n- `tests/test_project_resolver.py::test_unknown_project_error`\n\n**Rollback**\nRevert module.\n\n**Observability**\n`logger.debug(\"Resolved project '%s' -> id=%d vis=%s\", name, id, visibility)`\n\n**Dependencies**\n#4\n\n---\n\n## Issue #8: /todo list command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P1                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/008-cmd-list`                 |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the `list` subcommand. Supports scope (mine/all/<@USER>), project filter, section filter, status filter (open/done/drop), and limit. Sorting: due ASC (NULLs last), then id DESC. Excludes other users' private projects.\n\n**Acceptance Criteria**\n- [ ] Default scope=mine, status=open, limit=30\n- [ ] `mine` filters to tasks where sender is an assignee\n- [ ] `all` includes shared + sender's private (excludes others' private)\n- [ ] `/p` and `/s` filters applied correctly\n- [ ] Sorting: due NOT NULL first, due ASC, id DESC\n- [ ] limit:N respected\n- [ ] Output lists tasks in formatted lines\n\n**Tests**\n- `tests/test_cmd_list.py::test_list_mine_default`\n- `tests/test_cmd_list.py::test_list_all_excludes_others_private`\n- `tests/test_cmd_list.py::test_list_with_project_filter`\n- `tests/test_cmd_list.py::test_list_sorting_order`\n- `tests/test_cmd_list.py::test_list_limit`\n\n**Rollback**\nRevert handler; read-only operation.\n\n**Observability**\n`logger.info(\"list: scope=%s project=%s returned %d rows\", scope, project, count)`\n\n**Dependencies**\n#6, #7\n\n---\n\n## Issue #9: /todo board command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | done                                   |\n| Priority    | P1                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/009-cmd-board`                |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/30 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/31 |\n\n**Description**\nImplement the `board` subcommand. Groups tasks by section in fixed order (BACKLOG, DOING, WAITING, DONE, DROP), applies scope/project/status filters, and limits per section. Format: section headers with task lines underneath.\n\n**Acceptance Criteria**\n- [ ] Sections displayed in order: BACKLOG -> DOING -> WAITING -> DONE -> DROP\n- [ ] Empty sections shown with \"(empty)\" or omitted (decide and document)\n- [ ] `limitPerSection:N` caps items per section (default 10)\n- [ ] Scope/project filters identical to `list`\n- [ ] Each task line: `#id due:<date|-> assignees:<@U..> title`\n\n**Tests**\n- `tests/test_cmd_board.py::test_board_section_order`\n- `tests/test_cmd_board.py::test_board_limit_per_section`\n- `tests/test_cmd_board.py::test_board_scope_filter`\n\n**Rollback**\nRevert handler; read-only operation.\n\n**Observability**\n`logger.info(\"board: scope=%s project=%s sections=%s\", ...)`\n\n**Dependencies**\n#8\n\n---\n\n## Issue #10: /todo move command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | done                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/010-cmd-move`                 |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/23 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/24 |\n\n**Description**\nImplement the `move` subcommand. Validates section enum, checks permissions (private: owner only; shared: assignee or created_by), updates task section and updated_at, logs event.\n\n**Acceptance Criteria**\n- [ ] Section validated against enum; invalid returns error\n- [ ] Private project: only owner can move\n- [ ] Shared project: only assignee or created_by can move\n- [ ] `updated_at` set on change\n- [ ] Event logged\n- [ ] Response confirms new section\n\n**Tests**\n- `tests/test_cmd_move.py::test_move_valid_section`\n- `tests/test_cmd_move.py::test_move_invalid_section`\n- `tests/test_cmd_move.py::test_move_private_owner_only`\n- `tests/test_cmd_move.py::test_move_shared_permission`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"Task #%d moved to %s by %s\", id, section, sender)`\n\n**Dependencies**\n#6, #7\n\n---\n\n## Issue #11: /todo done and /todo drop commands\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | done                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/011-cmd-done-drop`            |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/26 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/27 |\n\n**Description**\nImplement `done` and `drop` subcommands. Both set section and status accordingly, record `closed_at`, validate permissions same as `move`, and log event.\n\n**Acceptance Criteria**\n- [ ] `done`: section='done', status='done', closed_at=now\n- [ ] `drop`: section='drop', status='dropped', closed_at=now\n- [ ] Permissions enforced (same as move)\n- [ ] Already-closed task returns informational message (idempotent or error -- decide)\n- [ ] Event logged for each\n\n**Tests**\n- `tests/test_cmd_done_drop.py::test_done_sets_fields`\n- `tests/test_cmd_done_drop.py::test_drop_sets_fields`\n- `tests/test_cmd_done_drop.py::test_permission_check`\n- `tests/test_cmd_done_drop.py::test_already_done`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"Task #%d %s by %s\", id, action, sender)`\n\n**Dependencies**\n#10\n\n---\n\n## Issue #12: /todo edit command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | done                                   |\n| Priority    | P1                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/012-cmd-edit`                 |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/34 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/35 |\n\n**Description**\nImplement the `edit` subcommand (v1 replace semantics). Supports changing title, assignees (full replace), project, section, and due. Validates private-project assignee constraint on both source and target project. Logs event with old/new diff in payload.\n\n**Acceptance Criteria**\n- [ ] Title updated only if non-option tokens present\n- [ ] Mentions present -> assignees fully replaced (DELETE + INSERT)\n- [ ] `due:-` clears due to NULL\n- [ ] `/p <newProject>` moves task to new project (project_id updated)\n- [ ] Private project assignee validation applied to target project\n- [ ] If moving to private project with non-owner assignees -> warning, no change\n- [ ] Event payload contains changed fields\n- [ ] Permissions: private owner only; shared assignee/created_by\n\n**Tests**\n- `tests/test_cmd_edit.py::test_edit_title`\n- `tests/test_cmd_edit.py::test_edit_assignees_replace`\n- `tests/test_cmd_edit.py::test_edit_due_clear`\n- `tests/test_cmd_edit.py::test_edit_move_project`\n- `tests/test_cmd_edit.py::test_edit_private_assignee_rejected`\n- `tests/test_cmd_edit.py::test_edit_no_change_fields`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"Task #%d edited by %s: fields=%s\", id, sender, changed_fields)`\n\n**Dependencies**\n#6, #7, #10\n\n---\n\n## Issue #13: /todo project list command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M4                                     |\n| Status      | done                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/013-cmd-project-list`         |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/28 |\n| PR          | Merged via PR #27 (bundled with Issue #11) |\n\n**Description**\nImplement `/todo project list`. Returns all shared projects and the sender's private projects. Format: grouped by visibility with name and task count.\n\n**Acceptance Criteria**\n- [ ] Shared projects listed regardless of sender\n- [ ] Sender's private projects listed\n- [ ] Other users' private projects NOT shown\n- [ ] Each project shows name, visibility, task count\n\n**Tests**\n- `tests/test_cmd_project.py::test_project_list_shows_shared`\n- `tests/test_cmd_project.py::test_project_list_shows_own_private`\n- `tests/test_cmd_project.py::test_project_list_hides_others_private`\n\n**Rollback**\nRevert handler; read-only.\n\n**Observability**\n`logger.info(\"project list: %d shared, %d private for %s\", ...)`\n\n**Dependencies**\n#7\n\n---\n\n## Issue #14: /todo project set-private command with assignee validation\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M4                                     |\n| Status      | done                                   |\n| Priority    | P0                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/014-cmd-project-set-private`  |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/32 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/33 |\n\n**Description**\nImplement `/todo project set-private <name>` with the assignee validation described in PRD 3.4. Resolution flow: if sender already has private with that name -> noop; if shared exists -> attempt conversion; if neither -> create new private. Conversion scans all tasks in the project and rejects if any task has a non-owner assignee.\n\n**Acceptance Criteria**\n- [ ] Already-private for sender: returns \"already private\" message\n- [ ] Shared -> private: scans tasks; all assignees are owner -> success (visibility='private', owner_user_id=sender)\n- [ ] Shared -> private: at least one non-owner assignee -> error with task IDs and violating assignee list (max 10)\n- [ ] Neither exists: creates new private project with owner=sender\n- [ ] Error message format matches PRD example\n- [ ] Event logged\n\n**Tests**\n- `tests/test_cmd_project.py::test_set_private_already_private`\n- `tests/test_cmd_project.py::test_set_private_shared_success`\n- `tests/test_cmd_project.py::test_set_private_shared_rejected_non_owner_assignee`\n- `tests/test_cmd_project.py::test_set_private_creates_new`\n- `tests/test_cmd_project.py::test_set_private_error_message_format`\n\n**Rollback**\nRevert handler; no schema change.\n\n**Observability**\n`logger.info(\"project set-private: %s result=%s by %s\", name, result, sender)`\n\n**Dependencies**\n#7, #13\n\n---\n\n## Issue #15: /todo project set-shared command\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M4                                     |\n| Status      | done                                   |\n| Priority    | P1                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/015-cmd-project-set-shared`   |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/36 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/37 |\n\n**Description**\nImplement `/todo project set-shared <name>`. Creates a shared project if none exists. If a shared project with that name already exists, noop. Global uniqueness enforced by DB index.\n\n**Acceptance Criteria**\n- [ ] New shared project created when name is free\n- [ ] Existing shared project: returns \"already shared\" / noop\n- [ ] Name conflict with existing shared: returns exists message (index enforces)\n- [ ] Event logged\n\n**Tests**\n- `tests/test_cmd_project.py::test_set_shared_creates_new`\n- `tests/test_cmd_project.py::test_set_shared_already_exists_noop`\n- `tests/test_cmd_project.py::test_set_shared_name_conflict`\n\n**Rollback**\nRevert handler.\n\n**Observability**\n`logger.info(\"project set-shared: %s result=%s\", name, result)`\n\n**Dependencies**\n#7, #13\n\n---\n\n## Issue #16: Command dispatcher and routing\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | TODO                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/016-dispatcher`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nImplement the dispatcher in `plugin.py` that maps the parsed command name to handler functions: `add`, `list`, `board`, `move`, `done`, `drop`, `edit`, `project`. The `project` command further dispatches to `list`, `set-private`, `set-shared`. Unknown commands return a help/error message.\n\n**Acceptance Criteria**\n- [ ] All valid command names routed to correct handler\n- [ ] `project` subcommands routed correctly\n- [ ] Unknown command returns usage hint\n- [ ] DB connection initialised (migration check) before first command execution\n\n**Tests**\n- `tests/test_dispatcher.py::test_routes_known_commands`\n- `tests/test_dispatcher.py::test_project_sub_routing`\n- `tests/test_dispatcher.py::test_unknown_command_help`\n\n**Rollback**\nRevert module.\n\n**Observability**\n`logger.info(\"Dispatching command=%s sub=%s\", command, sub)`\n\n**Dependencies**\n#5\n\n---\n\n## Issue #17: Permission helper module\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | Backend                                |\n| Milestone   | M3                                     |\n| Status      | done                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/017-permissions`              |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/21 |\n| PR          | (merged directly on main)              |\n\n**Description**\nExtract shared permission-checking logic into `src/openclaw_todo/permissions.py`. Provides `can_write_task(conn, task_id, sender_id) -> bool` and `validate_private_assignees(project, assignees, owner_id) -> Optional[str]` (returns warning message or None).\n\n**Acceptance Criteria**\n- [ ] Private project: only owner can write\n- [ ] Shared project: only assignee or created_by can write\n- [ ] `validate_private_assignees` returns warning string when non-owner assignees present for private project\n- [ ] Returns None for shared projects or when all assignees are owner\n\n**Tests**\n- `tests/test_permissions.py::test_private_owner_can_write`\n- `tests/test_permissions.py::test_private_non_owner_rejected`\n- `tests/test_permissions.py::test_shared_assignee_can_write`\n- `tests/test_permissions.py::test_shared_creator_can_write`\n- `tests/test_permissions.py::test_validate_private_assignees_warning`\n\n**Rollback**\nRevert module.\n\n**Observability**\n`logger.debug(\"Permission check: task=%d sender=%s result=%s\", ...)`\n\n**Dependencies**\n#4\n\n---\n\n## Issue #18: Parser unit tests (comprehensive)\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | QA                                     |\n| Milestone   | M5                                     |\n| Status      | done                                   |\n| Priority    | P1                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/018-parser-tests`             |\n| GH-Issue    | issues/39                              |\n| PR          | pull/40                                |\n\n**Description**\nExpand parser test coverage to include edge cases: multiple options in varied order, due at year boundary, empty title, mentions mixed with options, unicode in titles, extra whitespace handling.\n\n**Acceptance Criteria**\n- [ ] >=95% line coverage on `parser.py`\n- [ ] Edge cases documented in test docstrings\n- [ ] All tests pass with `uv run pytest tests/test_parser.py -v`\n\n**Tests**\n- `tests/test_parser.py::test_options_in_any_order`\n- `tests/test_parser.py::test_due_year_boundary`\n- `tests/test_parser.py::test_empty_title_no_crash`\n- `tests/test_parser.py::test_unicode_title`\n- `tests/test_parser.py::test_extra_whitespace`\n- `tests/test_parser.py::test_mixed_mentions_and_options`\n\n**Rollback**\nRevert test file; no production code change.\n\n**Observability**\nCI coverage report.\n\n**Dependencies**\n#5\n\n---\n\n## Issue #19: SQLite end-to-end integration tests\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | QA                                     |\n| Milestone   | M5                                     |\n| Status      | done                                   |\n| Priority    | P1                                     |\n| Estimate    | 1.5d                                   |\n| Branch      | `feature/019-e2e-tests`               |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/38 |\n| PR          | --                                     |\n\n**Description**\nWrite integration tests that exercise the full flow through `handle_message` with a real (tmp_path) SQLite database. Cover the main user stories: add a task, list it, move it, mark done, edit it, manage projects, and validate private project constraints.\n\n**Acceptance Criteria**\n- [ ] Each test uses a fresh DB via `tmp_path` fixture\n- [ ] Scenarios: add->list, add->move->board, add->done, add->edit, project set-private rejection\n- [ ] Private project visibility enforced end-to-end\n- [ ] Due normalisation verified in DB\n- [ ] All tests pass with `uv run pytest tests/test_e2e.py -v`\n\n**Tests**\n- `tests/test_e2e.py::test_add_and_list_roundtrip`\n- `tests/test_e2e.py::test_add_move_board`\n- `tests/test_e2e.py::test_done_and_drop`\n- `tests/test_e2e.py::test_edit_title_and_assignees`\n- `tests/test_e2e.py::test_private_project_isolation`\n- `tests/test_e2e.py::test_set_private_rejects_foreign_assignees`\n- `tests/test_e2e.py::test_due_normalisation_stored_correctly`\n\n**Rollback**\nRevert test file.\n\n**Observability**\nCI test results and coverage delta.\n\n**Dependencies**\n#6, #8, #9, #10, #11, #12, #14, #15\n\n---\n\n## Issue #20: Packaging and distribution setup\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | DevOps                                 |\n| Milestone   | M6                                     |\n| Status      | TODO                                   |\n| Priority    | P2                                     |\n| Estimate    | 1d                                     |\n| Branch      | `feature/020-packaging`               |\n| GH-Issue    | --                                     |\n| PR          | --                                     |\n\n**Description**\nFinalise `pyproject.toml` metadata (name, version, description, license, entry-points), add a `Makefile` with targets for lint/test/build, and document installation instructions in README. Ensure the plugin can be installed as a package and discovered by the OpenClaw gateway.\n\n**Acceptance Criteria**\n- [ ] `pyproject.toml` has complete metadata and entry-point for OpenClaw plugin discovery\n- [ ] `make lint` runs ruff + black --check\n- [ ] `make test` runs pytest with coverage\n- [ ] `make build` produces a wheel via `uv build`\n- [ ] `pip install <wheel>` in a clean venv makes the plugin importable\n- [ ] README documents installation and configuration (DB path env var)\n\n**Tests**\n- Manual: install wheel in fresh venv, import module, call `handle_message`\n- `make test` passes in CI\n\n**Rollback**\nRevert packaging changes.\n\n**Observability**\nBuild artifact size logged; CI publishes wheel as artifact.\n\n**Dependencies**\n#19\n\n---\n\n## Dependency Graph (summary)\n\n```\n#1  Plugin skeleton\n |\n +--#2  DB connection\n |   |\n |   +--#3  Migration framework\n |       |\n |       +--#4  V1 schema\n |           |\n |           +--#7  Project resolver\n |           |   |\n |           |   +--#13 project list\n |           |   +--#14 project set-private\n |           |   +--#15 project set-shared\n |           |\n |           +--#17 Permissions helper\n |\n +--#5  Parser\n |   |\n |   +--#18 Parser tests (M5)\n |\n +--#16 Dispatcher\n     |\n     +--#6  cmd add       (#4,#5,#7,#17)\n     +--#8  cmd list      (#6,#7)\n     +--#9  cmd board     (#8)\n     +--#10 cmd move      (#6,#7,#17)\n     +--#11 cmd done/drop (#10)\n     +--#12 cmd edit      (#6,#7,#10,#17)\n\n#19 E2E tests    (all commands)\n#20 Packaging    (#19)\n#21 CI workflow   (standalone)\n```\n\n---\n\n## Issue #21: GitHub Actions CI 워크플로우\n\n| Field       | Value                                  |\n|-------------|----------------------------------------|\n| Track       | DevOps                                 |\n| Milestone   | M0                                     |\n| Status      | done                                   |\n| Priority    | P0                                     |\n| Estimate    | 0.5d                                   |\n| Branch      | `feature/021-ci-workflow`              |\n| GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/19 |\n| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/20 |\n\n**Description**\nPR 머지 전 자동 테스트 검증을 위한 GitHub Actions CI 파이프라인을 추가합니다. push (main) + pull_request (main) 트리거로 Python 3.11 + uv + pytest 기반 테스트를 실행합니다.\n\n**Acceptance Criteria**\n- [ ] `.github/workflows/ci.yml` 생성\n- [ ] PR 생성 시 CI가 자동 실행됨\n- [ ] `uv run pytest -q --tb=short` 통과가 머지 조건\n\n**Dependencies**\nNone.\n", "structuredPatch": [{"oldStart": 754, "oldLines": 7, "newStart": 754, "newLines": 7, "lines": [" | Estimate    | 1.5d                                   |", " | Branch      | `feature/019-e2e-tests`               |", " | GH-Issue    | https://github.com/pillip/openclaw_todo_plugin/issues/38 |", "-| PR          | --                                     |", "+| PR          | https://github.com/pillip/openclaw_todo_plugin/pull/41 |", " ", " **Description**", " Write integration tests that exercise the full flow through `handle_message` with a real (tmp_path) SQLite database. Cover the main user stories: add a task, list it, move it, mark done, edit it, manage projects, and validate private project constraints."]}], "userModified": false, "replaceAll": false}, "tool_use_id": "toolu_01JDSKQq139gcFLuJuQ1HVay", "_ts": "2026-02-21T12:01:01+0900"}
{"session_id": "e02e763a-9559-492f-8eda-46e7ce5ebc26", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/e02e763a-9559-492f-8eda-46e7ce5ebc26.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "SubagentStop", "stop_hook_active": false, "agent_id": "a000c80", "agent_transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/e02e763a-9559-492f-8eda-46e7ce5ebc26/subagents/agent-a000c80.jsonl", "agent_type": "reviewer", "_ts": "2026-02-21T12:01:03+0900"}
{"session_id": "e02e763a-9559-492f-8eda-46e7ce5ebc26", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/e02e763a-9559-492f-8eda-46e7ce5ebc26.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Task", "tool_input": {"description": "Review PR #40 Issue #18", "prompt": "Perform a code review + security audit of PR #40 for Issue #18: Parser unit tests (comprehensive).\n\n## Context\n- PR #40 on branch `feature/018-parser-tests`\n- Changed files: `tests/test_parser.py`, `STATUS.md`, `issues.md`\n- This is a **test-only** issue — no production code changes. The goal is to expand parser test coverage to >=95% (achieved 100%).\n- Parser module: `src/openclaw_todo/parser.py`\n\n## What to review\n1. **Code quality** of `tests/test_parser.py`:\n   - Correctness: Do tests actually validate the behavior they claim to test?\n   - Edge cases: Are there any missing edge cases that should be covered?\n   - Maintainability: Are tests well-organized, readable, documented with docstrings?\n   - Test isolation: No shared state, proper fixtures?\n   - Coverage: The PR claims 100% line coverage — verify the claimed gaps (lines 61-62, 93, 101) are now covered.\n\n2. **Security audit** (light, since this is test code):\n   - No hardcoded secrets or credentials in test code\n   - No test code that could be exploited if accidentally deployed\n   - No import of dangerous modules\n\n3. **Acceptance criteria check from issues.md**:\n   - >=95% line coverage on parser.py\n   - Edge cases documented in test docstrings\n   - All tests pass with `uv run pytest tests/test_parser.py -v`\n   - Required tests: test_options_in_any_order, test_due_year_boundary, test_empty_title_no_crash, test_unicode_title, test_extra_whitespace, test_mixed_mentions_and_options\n\nRead the files, run the tests with coverage, and write your review notes to `/tmp/review_notes_issue18.txt`.\n\nFormat the review notes as markdown with sections:\n- Code Review (verdict, acceptance criteria checklist, findings)\n- Security Findings\n- Follow-up Issues (proposed)\n", "subagent_type": "reviewer"}, "tool_response": {"status": "completed", "prompt": "Perform a code review + security audit of PR #40 for Issue #18: Parser unit tests (comprehensive).\n\n## Context\n- PR #40 on branch `feature/018-parser-tests`\n- Changed files: `tests/test_parser.py`, `STATUS.md`, `issues.md`\n- This is a **test-only** issue — no production code changes. The goal is to expand parser test coverage to >=95% (achieved 100%).\n- Parser module: `src/openclaw_todo/parser.py`\n\n## What to review\n1. **Code quality** of `tests/test_parser.py`:\n   - Correctness: Do tests actually validate the behavior they claim to test?\n   - Edge cases: Are there any missing edge cases that should be covered?\n   - Maintainability: Are tests well-organized, readable, documented with docstrings?\n   - Test isolation: No shared state, proper fixtures?\n   - Coverage: The PR claims 100% line coverage — verify the claimed gaps (lines 61-62, 93, 101) are now covered.\n\n2. **Security audit** (light, since this is test code):\n   - No hardcoded secrets or credentials in test code\n   - No test code that could be exploited if accidentally deployed\n   - No import of dangerous modules\n\n3. **Acceptance criteria check from issues.md**:\n   - >=95% line coverage on parser.py\n   - Edge cases documented in test docstrings\n   - All tests pass with `uv run pytest tests/test_parser.py -v`\n   - Required tests: test_options_in_any_order, test_due_year_boundary, test_empty_title_no_crash, test_unicode_title, test_extra_whitespace, test_mixed_mentions_and_options\n\nRead the files, run the tests with coverage, and write your review notes to `/tmp/review_notes_issue18.txt`.\n\nFormat the review notes as markdown with sections:\n- Code Review (verdict, acceptance criteria checklist, findings)\n- Security Findings\n- Follow-up Issues (proposed)\n", "agentId": "a000c80", "content": [{"type": "text", "text": "The review is complete. Here is a summary of the results:\n\n**Verdict: APPROVE**\n\nAll 50 tests pass. Coverage on `src/openclaw_todo/parser.py` is **100%** (83/83 statements, 0 missing). Every acceptance criterion from Issue #18 is met.\n\n**Key findings in `/tmp/review_notes_issue18.txt`:**\n\n**Code Review (positive):**\n- Well-organized test classes grouped by concern (e.g., `TestOptionsInAnyOrder`, `TestDueYearBoundary`, `TestUnicodeTitle`)\n- Every test has a docstring explaining the edge case\n- Good use of `pytest.mark.parametrize` for section validation\n- No shared state; full test isolation\n- Previously uncovered lines (61-62, 93, 101) are now exercised\n\n**Minor non-blocking issues:**\n1. Unused `ParsedCommand` import on line 5 of `tests/test_parser.py`\n2. `from datetime import date` imported inside 3 function bodies instead of at module level (style inconsistency)\n3. Missing edge case test for `due:` with empty value (e.g., `parse(\"add Task due:\")`)\n4. Missing test for non-matching mention-like patterns (e.g., `<@lowercase>`)\n\n**Security Findings:**\n- No secrets, no dangerous imports, no exploitable code. Clean.\n- One note: `__pycache__/` bytecode files are tracked in git and should be added to `.gitignore`.\n\n**5 follow-up issues proposed** (all minor/hygiene): `.gitignore` cleanup, empty due value test, non-matching mention test, import consolidation, unused import removal."}], "totalDurationMs": 99955, "totalTokens": 42763, "totalToolUseCount": 15, "usage": {"input_tokens": 1, "cache_creation_input_tokens": 2243, "cache_read_input_tokens": 40112, "output_tokens": 407, "server_tool_use": {"web_search_requests": 0, "web_fetch_requests": 0}, "service_tier": "standard", "cache_creation": {"ephemeral_1h_input_tokens": 2243, "ephemeral_5m_input_tokens": 0}, "inference_geo": "", "iterations": [], "speed": "standard"}}, "tool_use_id": "toolu_01RzXAAhvoVJWyYiXaUj3XSB", "_ts": "2026-02-21T12:01:03+0900"}
{"session_id": "e02e763a-9559-492f-8eda-46e7ce5ebc26", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/e02e763a-9559-492f-8eda-46e7ce5ebc26.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/tmp/review_notes_issue18.txt"}, "tool_use_id": "toolu_0192EteLb8QKDSu21nJmH9Zg", "_ts": "2026-02-21T12:01:07+0900"}
{"session_id": "e02e763a-9559-492f-8eda-46e7ce5ebc26", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/e02e763a-9559-492f-8eda-46e7ce5ebc26.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/tmp/review_notes_issue18.txt"}, "tool_response": {"type": "text", "file": {"filePath": "/tmp/review_notes_issue18.txt", "content": "# Code Review & Security Audit -- PR #40 (Issue #18: Parser unit tests)\n\n**Reviewer:** Claude Opus 4.6 (automated)\n**Date:** 2026-02-21\n**Branch:** `feature/018-parser-tests`\n**Files changed:** `tests/test_parser.py`, `STATUS.md`, `issues.md`\n\n---\n\n## Code Review\n\n### Verdict: APPROVE\n\nThis is a well-structured, thorough test expansion that brings `parser.py` from partial\ncoverage to 100% line coverage (83/83 statements). The new tests are organized into\nlogical test classes with clear docstrings, and all 50 tests pass.\n\n### Acceptance Criteria Checklist\n\n| Criterion | Status | Notes |\n|-----------|--------|-------|\n| >=95% line coverage on `parser.py` | PASS | 100% (83/83 stmts, 0 missing) |\n| Edge cases documented in test docstrings | PASS | Every test method has a docstring |\n| All tests pass with `uv run pytest tests/test_parser.py -v` | PASS | 50/50 passed |\n| `test_options_in_any_order` | PASS | `TestOptionsInAnyOrder` class (5 tests) |\n| `test_due_year_boundary` | PASS | `TestDueYearBoundary` class (6 tests) |\n| `test_empty_title_no_crash` | PASS | `TestEmptyTitleNoCrash` class (4 tests) |\n| `test_unicode_title` | PASS | `TestUnicodeTitle` class (3 tests) |\n| `test_extra_whitespace` | PASS | `TestExtraWhitespace` class (3 tests) |\n| `test_mixed_mentions_and_options` | PASS | `TestMixedMentionsAndOptions` class (3 tests) |\n\n### Coverage Gap Verification\n\nThe PR description claimed gaps at lines 61-62, 93, 101. These correspond to:\n- **Lines 61-62:** MM-DD date parsing branch where the `date()` constructor fails\n  (ValueError) -- now covered by `test_due_mm_dd_invalid_day` and `test_due_mm_dd_invalid_month`\n- **Line 93:** `/p` missing argument error path -- now covered by `test_p_at_end_without_value`\n- **Line 101:** `/s` missing argument error path -- now covered by `test_s_at_end_without_value`\n\nAll gaps are confirmed closed. Coverage is 100%.\n\n### Findings\n\n#### Positive\n\n1. **Well-organized structure.** The new tests use test classes grouped by concern\n   (`TestOptionsInAnyOrder`, `TestDueYearBoundary`, etc.), which improves readability\n   over a flat list of functions. The original 13 tests from Issue #5 are preserved\n   unchanged at the top of the file.\n\n2. **Good edge case coverage.** Tests cover: duplicate options (last-wins semantics),\n   garbage due date strings, whitespace-only input, tab characters, Korean/Japanese\n   unicode, emoji, single-digit month/day (`1-1`), all five valid sections via\n   parametrize, and negative tests for `add` not extracting an ID arg.\n\n3. **Parametrized section test.** `TestAllSections::test_valid_section` uses\n   `@pytest.mark.parametrize` for all 5 valid sections -- clean and maintainable.\n\n4. **No shared state.** Each test is fully independent; no fixtures, no class-level\n   setup, no global mutable state. The parser is pure-functional so this is appropriate.\n\n#### Minor Issues (non-blocking)\n\n1. **`ParsedCommand` import unused (line 5).** `ParsedCommand` is imported but never\n   referenced directly in any assertion. Tests rely on attribute access on the returned\n   object, which is correct, but the unused import could be removed for cleanliness.\n   Severity: trivial.\n\n2. **Hardcoded year 2026 in some tests.** Tests like `test_due_full_date` and\n   `test_due_feb_29_leap_year` use hardcoded years (2026, 2028). These are fine since\n   full-date parsing does not depend on the current year, but a comment noting this\n   intent would improve clarity. The MM-DD tests correctly use `date.today().year`.\n   Severity: trivial.\n\n3. **`from datetime import date` inside test functions (lines 32, 152, 159).** Three\n   tests import `date` locally rather than at the module top. This is harmless but\n   inconsistent -- the module-level imports section would be the conventional place.\n   Severity: trivial / style.\n\n4. **Duplicate due date test.** `test_due_invalid_date` (line 45, full YYYY-MM-DD\n   format `2026-02-30`) and `TestDueYearBoundary::test_due_mm_dd_invalid_day` (line\n   168, MM-DD format `2-30`) both test Feb 30, but via different code paths. This is\n   actually good -- they exercise different branches in `_normalise_due`. No action\n   needed.\n\n5. **No test for `due:` with empty value.** `parse(\"add Task due:\")` would match\n   `_DUE_RE` with an empty capture group, then hit `_normalise_due(\"\")`. This would\n   fail at both strptime and the MM-DD regex, ultimately raising `ParseError`. While\n   the behavior is correct, an explicit test would document it.\n   Severity: low.\n\n6. **No test for mention-like but invalid patterns.** E.g., `<@invalid>` (lowercase)\n   would NOT match `_MENTION_RE` (`U[A-Z0-9]+`) and would become a title token. An\n   explicit test documenting this behavior would be useful.\n   Severity: low.\n\n### Test Isolation & Fixtures\n\nNo issues. All tests are stateless. The parser module has no side effects (no DB, no\nnetwork, no filesystem). No fixtures are needed or used.\n\n---\n\n## Security Findings\n\nSince this PR contains only test code, the security surface is minimal.\n\n| # | Severity | Finding | Status |\n|---|----------|---------|--------|\n| 1 | Low | **No hardcoded secrets or credentials.** All test data uses placeholder Slack user IDs (`U12345`, `UALICE`, etc.) and project names. | PASS |\n| 2 | Low | **No dangerous imports.** Only `pytest` and project-internal modules are imported. No `os`, `subprocess`, `eval`, `pickle`, or network modules. | PASS |\n| 3 | Low | **No test code that could be exploited if deployed.** Tests only call the pure `parse()` function with string inputs. No file I/O, no exec. | PASS |\n| 4 | Info | **`__pycache__` bytecode files tracked in git.** The git status shows `.pyc` files are tracked. These should be in `.gitignore`. Not a security issue per se, but bytecode files can obscure code changes and should not be committed. | NOTE |\n\nNo security issues found in this PR.\n\n---\n\n## Follow-up Issues (Proposed)\n\n1. **Add `.pyc`/`__pycache__` to `.gitignore`.**\n   The repo tracks compiled Python bytecode files. Add `__pycache__/` and `*.pyc` to\n   `.gitignore` and remove them from tracking. This is a hygiene issue visible in the\n   git status output.\n\n2. **Test for `due:` with empty value.**\n   Add `test_due_empty_value` to verify that `parse(\"add Task due:\")` raises\n   `ParseError`. This documents the behavior for a plausible user typo.\n\n3. **Test for non-matching mention-like tokens.**\n   Add a test verifying that `<@lowercase>` or `<@>` are treated as title tokens,\n   not mentions. This documents the regex boundary behavior.\n\n4. **Move `from datetime import date` to module-level imports.**\n   Three tests import `date` inside the function body. Moving them to the top of the\n   file would follow Python conventions. Trivial cleanup.\n\n5. **Remove unused `ParsedCommand` import.**\n   Line 5 imports `ParsedCommand` but it is never used in assertions. Remove it or\n   add a type-annotation test that references it.\n\n---\n\n## Summary\n\nPR #40 meets all acceptance criteria for Issue #18. Coverage on `parser.py` is 100%.\nTests are well-organized, correctly validate parser behavior, and have no security\nconcerns. Recommend **APPROVE** with optional minor cleanups tracked as follow-ups.\n", "numLines": 149, "startLine": 1, "totalLines": 149}}, "tool_use_id": "toolu_0192EteLb8QKDSu21nJmH9Zg", "_ts": "2026-02-21T12:01:07+0900"}
{"session_id": "e02e763a-9559-492f-8eda-46e7ce5ebc26", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/e02e763a-9559-492f-8eda-46e7ce5ebc26.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "git branch --show-current", "description": "Verify current branch"}, "tool_use_id": "toolu_01S7Hoi2sYA8W2SnFSqhN1ZM", "_ts": "2026-02-21T12:01:12+0900"}
{"session_id": "e02e763a-9559-492f-8eda-46e7ce5ebc26", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/e02e763a-9559-492f-8eda-46e7ce5ebc26.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "git branch --show-current", "description": "Verify current branch"}, "tool_response": {"stdout": "feature/019-e2e-tests", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_01S7Hoi2sYA8W2SnFSqhN1ZM", "_ts": "2026-02-21T12:01:12+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "offset": 16, "limit": 6}, "tool_use_id": "toolu_01VUXceaGYWzmzDaM26P5wbU", "_ts": "2026-02-21T12:01:15+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "offset": 16, "limit": 6}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "content": "| M3 | Commands (add/list/board/move/done/drop/edit) | **Done** | #6 ✅, #16 ✅, #7 ✅, #17 ✅, #10 ✅, #8 ✅, #11 ✅, #9 ✅, #12 ✅ |\n| M4 | Project commands (list/set-private/set-shared) | **Done** | #13 ✅, #14 ✅, #15 ✅ |\n| M5 | Tests (parser/unit + sqlite E2E) | Not started | #18, #19 |\n| M6 | Packaging / deployment | Not started | #20 |\n| DevOps | GitHub Actions CI | **Done** | #21 |\n", "numLines": 6, "startLine": 16, "totalLines": 51}}, "tool_use_id": "toolu_01VUXceaGYWzmzDaM26P5wbU", "_ts": "2026-02-21T12:01:15+0900"}
{"session_id": "e02e763a-9559-492f-8eda-46e7ce5ebc26", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/e02e763a-9559-492f-8eda-46e7ce5ebc26.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "git checkout feature/018-parser-tests", "description": "Switch to Issue #18 branch"}, "tool_use_id": "toolu_01AFN3WiRfijGtvxmcUaJCdW", "_ts": "2026-02-21T12:01:15+0900"}
{"session_id": "e02e763a-9559-492f-8eda-46e7ce5ebc26", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/e02e763a-9559-492f-8eda-46e7ce5ebc26.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "git checkout feature/018-parser-tests", "description": "Switch to Issue #18 branch"}, "tool_response": {"stdout": "M\t.claude/run/agent-state.json\nM\t.claude/run/events.jsonl\nM\tissues.md\n브랜치가 'origin/feature/018-parser-tests'보다 1개 커밋만큼 앞에 있습니다.\n  (로컬에 있는 커밋을 제출하려면 \"git push\"를 사용하십시오)\n'feature/018-parser-tests' 브랜치로 전환합니다", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_01AFN3WiRfijGtvxmcUaJCdW", "_ts": "2026-02-21T12:01:15+0900"}
{"session_id": "e02e763a-9559-492f-8eda-46e7ce5ebc26", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/e02e763a-9559-492f-8eda-46e7ce5ebc26.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_parser.py", "limit": 10}, "tool_use_id": "toolu_01DBkwFdjdYAZ3VxmmYZLpVH", "_ts": "2026-02-21T12:01:19+0900"}
{"session_id": "e02e763a-9559-492f-8eda-46e7ce5ebc26", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/e02e763a-9559-492f-8eda-46e7ce5ebc26.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_parser.py", "limit": 10}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_parser.py", "content": "\"\"\"Tests for the command parser.\"\"\"\n\nimport pytest\n\nfrom openclaw_todo.parser import DUE_CLEAR, ParseError, ParsedCommand, parse\n\n\ndef test_extract_project():\n    \"\"\"/p MyProject should be extracted and token consumed.\"\"\"\n    result = parse(\"add Buy milk /p MyProject\")", "numLines": 10, "startLine": 1, "totalLines": 348}}, "tool_use_id": "toolu_01DBkwFdjdYAZ3VxmmYZLpVH", "_ts": "2026-02-21T12:01:19+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md"}, "tool_use_id": "toolu_018GmnifAkveM65N3tzkSxF6", "_ts": "2026-02-21T12:01:22+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md"}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "content": "# Project Status — OpenClaw TODO Plugin\n\n**Last updated:** 2026-02-21\n\n## Current Phase\n\n**Kickoff complete** — All planning documents generated. Ready to begin implementation.\n\n## Milestones\n\n| Milestone | Description | Status | Issues |\n|-----------|-------------|--------|--------|\n| M0 | Plugin skeleton + `/todo` command registration | **Done** | #1 |\n| M1 | DB init + migrations + schema_version | **Done** | #2, #3, #4 |\n| M2 | Parser (Slack mention, /p, /s, due correction) | **Done** | #5 |\n| M3 | Commands (add/list/board/move/done/drop/edit) | **Done** | #6 ✅, #16 ✅, #7 ✅, #17 ✅, #10 ✅, #8 ✅, #11 ✅, #9 ✅, #12 ✅ |\n| M4 | Project commands (list/set-private/set-shared) | **Done** | #13 ✅, #14 ✅, #15 ✅ |\n| M5 | Tests (parser/unit + sqlite E2E) | **In progress** | #18 ✅, #19 |\n| M6 | Packaging / deployment | Not started | #20 |\n| DevOps | GitHub Actions CI | **Done** | #21 |\n\n## Critical Path\n\n```\n#1 (skeleton) → #2 (DB conn) → #3 (migration framework) → #4 (V1 schema) → #7 (project resolver) → commands\n#5 (parser) can be developed in parallel with DB track\n```\n\n## Next Issues to Work On\n\n1. **#19** — SQLite E2E integration tests (M5)\n2. **#20** — Packaging and distribution setup (M6)\n\n## Risks\n\n| Risk | Likelihood | Impact | Mitigation |\n|------|-----------|--------|------------|\n| SQLite write contention under concurrent access | Low | Medium | WAL mode + busy_timeout=3000 |\n| Private/shared name collision user confusion | Medium | Low | Option A (private-first) + guidance |\n| Schema migration failures on upgrade | Low | High | schema_version table + sequential migrations |\n| Slack rate limits on heavy usage | Low | Low | Responses are single messages per command |\n\n## Generated Documents\n\n- [x] `docs/requirements.md` — Functional & non-functional requirements\n- [x] `docs/ux_spec.md` — UX specification with all command flows\n- [x] `docs/architecture.md` — Software architecture design\n- [x] `docs/test_plan.md` — Test strategy with 80+ test cases\n- [x] `issues.md` — 20 issues across 7 milestones\n", "numLines": 50, "startLine": 1, "totalLines": 50}}, "tool_use_id": "toolu_018GmnifAkveM65N3tzkSxF6", "_ts": "2026-02-21T12:01:22+0900"}
{"session_id": "e02e763a-9559-492f-8eda-46e7ce5ebc26", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/e02e763a-9559-492f-8eda-46e7ce5ebc26.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_parser.py", "old_string": "\"\"\"Tests for the command parser.\"\"\"\n\nimport pytest\n\nfrom openclaw_todo.parser import DUE_CLEAR, ParseError, ParsedCommand, parse", "new_string": "\"\"\"Tests for the command parser.\"\"\"\n\nfrom datetime import date\n\nimport pytest\n\nfrom openclaw_todo.parser import DUE_CLEAR, ParseError, parse", "replace_all": false}, "tool_use_id": "toolu_01KcPXcPg7aeoNb1D6nSX2ND", "_ts": "2026-02-21T12:01:24+0900"}
{"session_id": "e02e763a-9559-492f-8eda-46e7ce5ebc26", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/e02e763a-9559-492f-8eda-46e7ce5ebc26.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_parser.py", "old_string": "\"\"\"Tests for the command parser.\"\"\"\n\nimport pytest\n\nfrom openclaw_todo.parser import DUE_CLEAR, ParseError, ParsedCommand, parse", "new_string": "\"\"\"Tests for the command parser.\"\"\"\n\nfrom datetime import date\n\nimport pytest\n\nfrom openclaw_todo.parser import DUE_CLEAR, ParseError, parse", "replace_all": false}, "tool_response": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_parser.py", "oldString": "\"\"\"Tests for the command parser.\"\"\"\n\nimport pytest\n\nfrom openclaw_todo.parser import DUE_CLEAR, ParseError, ParsedCommand, parse", "newString": "\"\"\"Tests for the command parser.\"\"\"\n\nfrom datetime import date\n\nimport pytest\n\nfrom openclaw_todo.parser import DUE_CLEAR, ParseError, parse", "originalFile": "\"\"\"Tests for the command parser.\"\"\"\n\nimport pytest\n\nfrom openclaw_todo.parser import DUE_CLEAR, ParseError, ParsedCommand, parse\n\n\ndef test_extract_project():\n    \"\"\"/p MyProject should be extracted and token consumed.\"\"\"\n    result = parse(\"add Buy milk /p MyProject\")\n    assert result.project == \"MyProject\"\n    assert result.command == \"add\"\n    assert \"Buy\" in result.title_tokens\n    assert \"/p\" not in result.title_tokens\n    assert \"MyProject\" not in result.title_tokens\n\n\ndef test_extract_section_valid():\n    \"\"\"/s doing should be validated and extracted.\"\"\"\n    result = parse(\"add Task /s doing\")\n    assert result.section == \"doing\"\n\n\ndef test_extract_section_invalid():\n    \"\"\"Invalid section should raise ParseError.\"\"\"\n    with pytest.raises(ParseError, match=\"Invalid section\"):\n        parse(\"add Task /s invalid_section\")\n\n\ndef test_due_mm_dd_normalisation():\n    \"\"\"due:03-15 should be normalised to current-year YYYY-MM-DD.\"\"\"\n    from datetime import date\n\n    result = parse(\"add Task due:03-15\")\n    expected = f\"{date.today().year}-03-15\"\n    assert result.due == expected\n\n\ndef test_due_full_date():\n    \"\"\"due:2026-06-01 should be kept as-is.\"\"\"\n    result = parse(\"add Task due:2026-06-01\")\n    assert result.due == \"2026-06-01\"\n\n\ndef test_due_invalid_date():\n    \"\"\"due:2026-02-30 should raise ParseError.\"\"\"\n    with pytest.raises(ParseError, match=\"Invalid due date\"):\n        parse(\"add Task due:2026-02-30\")\n\n\ndef test_due_clear():\n    \"\"\"due:- should set the clear sentinel.\"\"\"\n    result = parse(\"add Task due:-\")\n    assert result.due == DUE_CLEAR\n\n\ndef test_mentions_extraction():\n    \"\"\"<@U12345> patterns should be extracted into mentions.\"\"\"\n    result = parse(\"add Task <@U12345> <@UABCDE>\")\n    assert result.mentions == [\"U12345\", \"UABCDE\"]\n    assert \"<@U12345>\" not in result.title_tokens\n\n\ndef test_title_extraction():\n    \"\"\"Non-option, non-mention tokens should become title_tokens.\"\"\"\n    result = parse(\"add Buy groceries and cook dinner /p Home due:2026-03-01\")\n    assert result.title_tokens == [\"Buy\", \"groceries\", \"and\", \"cook\", \"dinner\"]\n    assert result.project == \"Home\"\n    assert result.due == \"2026-03-01\"\n\n\ndef test_command_extraction():\n    \"\"\"The first token should be the command.\"\"\"\n    result = parse(\"list mine /p Work\")\n    assert result.command == \"list\"\n    assert \"mine\" in result.title_tokens\n\n\ndef test_move_extracts_id_as_arg():\n    \"\"\"move command should extract task id as first arg.\"\"\"\n    result = parse(\"move 42 /s doing\")\n    assert result.command == \"move\"\n    assert result.args == [\"42\"]\n    assert result.section == \"doing\"\n\n\ndef test_empty_command_raises():\n    \"\"\"Empty text after /todo should raise ParseError.\"\"\"\n    with pytest.raises(ParseError, match=\"Empty command\"):\n        parse(\"\")\n\n\ndef test_section_case_insensitive():\n    \"\"\"/s DOING should be normalised to lowercase.\"\"\"\n    result = parse(\"add Task /s DOING\")\n    assert result.section == \"doing\"\n\n\n# --- Issue #18: Comprehensive edge-case tests ---\n\n\nclass TestOptionsInAnyOrder:\n    \"\"\"Options (/p, /s, due:, mentions) can appear in any position.\"\"\"\n\n    def test_options_before_title(self):\n        \"\"\"Options placed before the title tokens are extracted correctly.\"\"\"\n        result = parse(\"add /p Work /s doing due:2026-05-01 Finish report\")\n        assert result.project == \"Work\"\n        assert result.section == \"doing\"\n        assert result.due == \"2026-05-01\"\n        assert result.title_tokens == [\"Finish\", \"report\"]\n\n    def test_options_interspersed(self):\n        \"\"\"Options interspersed between title tokens are all extracted.\"\"\"\n        result = parse(\"add Buy /p Home groceries /s backlog due:2026-06-01\")\n        assert result.project == \"Home\"\n        assert result.section == \"backlog\"\n        assert result.due == \"2026-06-01\"\n        assert result.title_tokens == [\"Buy\", \"groceries\"]\n\n    def test_all_options_at_end(self):\n        \"\"\"All options after the title tokens.\"\"\"\n        result = parse(\"add Deploy server <@UADMIN> /p Infra /s doing due:2026-07-15\")\n        assert result.project == \"Infra\"\n        assert result.section == \"doing\"\n        assert result.due == \"2026-07-15\"\n        assert result.mentions == [\"UADMIN\"]\n        assert result.title_tokens == [\"Deploy\", \"server\"]\n\n    def test_duplicate_option_last_wins(self):\n        \"\"\"If the same option appears twice, the last value wins.\"\"\"\n        result = parse(\"add Task /p Alpha /p Beta\")\n        assert result.project == \"Beta\"\n\n    def test_duplicate_section_last_wins(self):\n        \"\"\"If /s appears twice, the last value wins.\"\"\"\n        result = parse(\"add Task /s backlog /s doing\")\n        assert result.section == \"doing\"\n\n\nclass TestDueYearBoundary:\n    \"\"\"Due date edge cases around year boundaries and leap years.\"\"\"\n\n    def test_due_feb_29_leap_year(self):\n        \"\"\"due:02-29 should succeed if current year is a leap year (or use full date).\"\"\"\n        # Use full date format to guarantee a leap year\n        result = parse(\"add Task due:2028-02-29\")\n        assert result.due == \"2028-02-29\"\n\n    def test_due_dec_31(self):\n        \"\"\"due:12-31 should normalise to current year Dec 31.\"\"\"\n        from datetime import date\n        result = parse(\"add Task due:12-31\")\n        assert result.due == f\"{date.today().year}-12-31\"\n\n    def test_due_jan_01(self):\n        \"\"\"due:01-01 should normalise to current year Jan 1.\"\"\"\n        from datetime import date\n        result = parse(\"add Task due:1-1\")\n        assert result.due == f\"{date.today().year}-01-01\"\n\n    def test_due_mm_dd_invalid_month(self):\n        \"\"\"due:13-01 (invalid month) should raise ParseError.\"\"\"\n        with pytest.raises(ParseError, match=\"Invalid due date\"):\n            parse(\"add Task due:13-01\")\n\n    def test_due_mm_dd_invalid_day(self):\n        \"\"\"due:02-30 (Feb 30) in MM-DD format should raise ParseError.\"\"\"\n        with pytest.raises(ParseError, match=\"Invalid due date\"):\n            parse(\"add Task due:2-30\")\n\n    def test_due_garbage_string(self):\n        \"\"\"due:notadate should raise ParseError.\"\"\"\n        with pytest.raises(ParseError, match=\"Invalid due date\"):\n            parse(\"add Task due:notadate\")\n\n\nclass TestEmptyTitleNoCrash:\n    \"\"\"Commands with no title tokens should not crash.\"\"\"\n\n    def test_add_no_title_only_options(self):\n        \"\"\"add with only options and no title tokens produces empty title_tokens.\"\"\"\n        result = parse(\"add /p Work /s doing\")\n        assert result.command == \"add\"\n        assert result.title_tokens == []\n        assert result.project == \"Work\"\n\n    def test_list_no_extra_tokens(self):\n        \"\"\"list with no arguments produces empty title_tokens.\"\"\"\n        result = parse(\"list\")\n        assert result.command == \"list\"\n        assert result.title_tokens == []\n\n    def test_move_only_id(self):\n        \"\"\"move with only an ID and no other tokens.\"\"\"\n        result = parse(\"move 5\")\n        assert result.command == \"move\"\n        assert result.args == [\"5\"]\n        assert result.title_tokens == []\n\n    def test_whitespace_only_raises(self):\n        \"\"\"Whitespace-only input should raise ParseError.\"\"\"\n        with pytest.raises(ParseError, match=\"Empty command\"):\n            parse(\"   \")\n\n\nclass TestUnicodeTitle:\n    \"\"\"Unicode characters in titles should be preserved.\"\"\"\n\n    def test_korean_title(self):\n        \"\"\"Korean text in title should be preserved.\"\"\"\n        result = parse(\"add 우유 사기 /p 집\")\n        assert result.title_tokens == [\"우유\", \"사기\"]\n        assert result.project == \"집\"\n\n    def test_emoji_in_title(self):\n        \"\"\"Emoji characters in title should be preserved.\"\"\"\n        result = parse(\"add Fix bug 🐛 /s doing\")\n        assert \"🐛\" in result.title_tokens\n        assert result.section == \"doing\"\n\n    def test_mixed_unicode_and_ascii(self):\n        \"\"\"Mixed unicode and ASCII in the same command.\"\"\"\n        result = parse(\"add 日本語タスク due:2026-04-01 <@UJAPAN>\")\n        assert result.title_tokens == [\"日本語タスク\"]\n        assert result.due == \"2026-04-01\"\n        assert result.mentions == [\"UJAPAN\"]\n\n\nclass TestExtraWhitespace:\n    \"\"\"Extra whitespace should be handled gracefully.\"\"\"\n\n    def test_leading_trailing_whitespace(self):\n        \"\"\"Leading and trailing whitespace stripped.\"\"\"\n        result = parse(\"  add  Task  \")\n        assert result.command == \"add\"\n        assert result.title_tokens == [\"Task\"]\n\n    def test_multiple_spaces_between_tokens(self):\n        \"\"\"Multiple spaces between tokens treated as single separator.\"\"\"\n        result = parse(\"add   Buy   milk   /p   Home\")\n        assert result.title_tokens == [\"Buy\", \"milk\"]\n        assert result.project == \"Home\"\n\n    def test_tabs_in_input(self):\n        \"\"\"Tab characters should be treated as whitespace separators.\"\"\"\n        result = parse(\"add\\tTask\\t/s\\tdoing\")\n        assert result.command == \"add\"\n        assert result.title_tokens == [\"Task\"]\n        assert result.section == \"doing\"\n\n\nclass TestMixedMentionsAndOptions:\n    \"\"\"Mentions and options can appear together in any order.\"\"\"\n\n    def test_mentions_between_options(self):\n        \"\"\"Mentions between /p and /s should be extracted correctly.\"\"\"\n        result = parse(\"add Task /p Work <@UALICE> /s doing <@UBOB>\")\n        assert result.project == \"Work\"\n        assert result.section == \"doing\"\n        assert set(result.mentions) == {\"UALICE\", \"UBOB\"}\n        assert result.title_tokens == [\"Task\"]\n\n    def test_mentions_with_due(self):\n        \"\"\"Mentions combined with due date.\"\"\"\n        result = parse(\"add Review PR <@UDEV1> <@UDEV2> due:2026-03-20\")\n        assert result.mentions == [\"UDEV1\", \"UDEV2\"]\n        assert result.due == \"2026-03-20\"\n        assert result.title_tokens == [\"Review\", \"PR\"]\n\n    def test_all_options_and_multiple_mentions(self):\n        \"\"\"All option types plus multiple mentions in a single command.\"\"\"\n        result = parse(\"add Deploy <@UA> <@UB> /p Infra /s doing due:2026-08-01\")\n        assert result.project == \"Infra\"\n        assert result.section == \"doing\"\n        assert result.due == \"2026-08-01\"\n        assert result.mentions == [\"UA\", \"UB\"]\n        assert result.title_tokens == [\"Deploy\"]\n\n\nclass TestMissingOptionArguments:\n    \"\"\"Missing arguments for /p and /s should raise ParseError.\"\"\"\n\n    def test_p_at_end_without_value(self):\n        \"\"\"/p at end of input without a project name raises ParseError.\"\"\"\n        with pytest.raises(ParseError, match=\"/p requires a project name\"):\n            parse(\"add Task /p\")\n\n    def test_s_at_end_without_value(self):\n        \"\"\"/s at end of input without a section name raises ParseError.\"\"\"\n        with pytest.raises(ParseError, match=\"/s requires a section name\"):\n            parse(\"add Task /s\")\n\n\nclass TestIdExtractionCommands:\n    \"\"\"Commands that extract an ID as the first arg: move, done, drop, edit.\"\"\"\n\n    def test_done_extracts_id(self):\n        \"\"\"done command extracts task ID as first arg.\"\"\"\n        result = parse(\"done 99\")\n        assert result.command == \"done\"\n        assert result.args == [\"99\"]\n\n    def test_drop_extracts_id(self):\n        \"\"\"drop command extracts task ID as first arg.\"\"\"\n        result = parse(\"drop 7\")\n        assert result.command == \"drop\"\n        assert result.args == [\"7\"]\n\n    def test_edit_extracts_id_with_title_tokens(self):\n        \"\"\"edit command extracts ID and preserves remaining title tokens.\"\"\"\n        result = parse(\"edit 3 New title text /s doing\")\n        assert result.command == \"edit\"\n        assert result.args == [\"3\"]\n        assert result.title_tokens == [\"New\", \"title\", \"text\"]\n        assert result.section == \"doing\"\n\n    def test_add_does_not_extract_id(self):\n        \"\"\"add command does NOT extract first token as ID.\"\"\"\n        result = parse(\"add 42 is the answer\")\n        assert result.command == \"add\"\n        assert result.args == []\n        assert result.title_tokens == [\"42\", \"is\", \"the\", \"answer\"]\n\n\nclass TestCommandCaseInsensitive:\n    \"\"\"Command names should be case-insensitive.\"\"\"\n\n    def test_uppercase_command(self):\n        \"\"\"ADD should be normalised to add.\"\"\"\n        result = parse(\"ADD Task\")\n        assert result.command == \"add\"\n\n    def test_mixed_case_command(self):\n        \"\"\"LiSt should be normalised to list.\"\"\"\n        result = parse(\"LiSt\")\n        assert result.command == \"list\"\n\n\nclass TestAllSections:\n    \"\"\"All valid sections should be accepted.\"\"\"\n\n    @pytest.mark.parametrize(\"section\", [\"backlog\", \"doing\", \"waiting\", \"done\", \"drop\"])\n    def test_valid_section(self, section):\n        \"\"\"Each valid section name is accepted.\"\"\"\n        result = parse(f\"add Task /s {section}\")\n        assert result.section == section\n", "structuredPatch": [{"oldStart": 1, "oldLines": 8, "newStart": 1, "newLines": 10, "lines": [" \"\"\"Tests for the command parser.\"\"\"", " ", "+from datetime import date", "+", " import pytest", " ", "-from openclaw_todo.parser import DUE_CLEAR, ParseError, ParsedCommand, parse", "+from openclaw_todo.parser import DUE_CLEAR, ParseError, parse", " ", " ", " def test_extract_project():"]}], "userModified": false, "replaceAll": false}, "tool_use_id": "toolu_01KcPXcPg7aeoNb1D6nSX2ND", "_ts": "2026-02-21T12:01:24+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "old_string": "| M5 | Tests (parser/unit + sqlite E2E) | **In progress** | #18 ✅, #19 |", "new_string": "| M5 | Tests (parser/unit + sqlite E2E) | **Done** | #18 ✅, #19 ✅ |", "replace_all": false}, "tool_use_id": "toolu_01H3gkwLtetQ2oWswP1KGWWU", "_ts": "2026-02-21T12:01:26+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "old_string": "| M5 | Tests (parser/unit + sqlite E2E) | **In progress** | #18 ✅, #19 |", "new_string": "| M5 | Tests (parser/unit + sqlite E2E) | **Done** | #18 ✅, #19 ✅ |", "replace_all": false}, "tool_response": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "oldString": "| M5 | Tests (parser/unit + sqlite E2E) | **In progress** | #18 ✅, #19 |", "newString": "| M5 | Tests (parser/unit + sqlite E2E) | **Done** | #18 ✅, #19 ✅ |", "originalFile": "# Project Status — OpenClaw TODO Plugin\n\n**Last updated:** 2026-02-21\n\n## Current Phase\n\n**Kickoff complete** — All planning documents generated. Ready to begin implementation.\n\n## Milestones\n\n| Milestone | Description | Status | Issues |\n|-----------|-------------|--------|--------|\n| M0 | Plugin skeleton + `/todo` command registration | **Done** | #1 |\n| M1 | DB init + migrations + schema_version | **Done** | #2, #3, #4 |\n| M2 | Parser (Slack mention, /p, /s, due correction) | **Done** | #5 |\n| M3 | Commands (add/list/board/move/done/drop/edit) | **Done** | #6 ✅, #16 ✅, #7 ✅, #17 ✅, #10 ✅, #8 ✅, #11 ✅, #9 ✅, #12 ✅ |\n| M4 | Project commands (list/set-private/set-shared) | **Done** | #13 ✅, #14 ✅, #15 ✅ |\n| M5 | Tests (parser/unit + sqlite E2E) | **In progress** | #18 ✅, #19 |\n| M6 | Packaging / deployment | Not started | #20 |\n| DevOps | GitHub Actions CI | **Done** | #21 |\n\n## Critical Path\n\n```\n#1 (skeleton) → #2 (DB conn) → #3 (migration framework) → #4 (V1 schema) → #7 (project resolver) → commands\n#5 (parser) can be developed in parallel with DB track\n```\n\n## Next Issues to Work On\n\n1. **#19** — SQLite E2E integration tests (M5)\n2. **#20** — Packaging and distribution setup (M6)\n\n## Risks\n\n| Risk | Likelihood | Impact | Mitigation |\n|------|-----------|--------|------------|\n| SQLite write contention under concurrent access | Low | Medium | WAL mode + busy_timeout=3000 |\n| Private/shared name collision user confusion | Medium | Low | Option A (private-first) + guidance |\n| Schema migration failures on upgrade | Low | High | schema_version table + sequential migrations |\n| Slack rate limits on heavy usage | Low | Low | Responses are single messages per command |\n\n## Generated Documents\n\n- [x] `docs/requirements.md` — Functional & non-functional requirements\n- [x] `docs/ux_spec.md` — UX specification with all command flows\n- [x] `docs/architecture.md` — Software architecture design\n- [x] `docs/test_plan.md` — Test strategy with 80+ test cases\n- [x] `issues.md` — 20 issues across 7 milestones\n", "structuredPatch": [{"oldStart": 15, "oldLines": 7, "newStart": 15, "newLines": 7, "lines": [" | M2 | Parser (Slack mention, /p, /s, due correction) | **Done** | #5 |", " | M3 | Commands (add/list/board/move/done/drop/edit) | **Done** | #6 ✅, #16 ✅, #7 ✅, #17 ✅, #10 ✅, #8 ✅, #11 ✅, #9 ✅, #12 ✅ |", " | M4 | Project commands (list/set-private/set-shared) | **Done** | #13 ✅, #14 ✅, #15 ✅ |", "-| M5 | Tests (parser/unit + sqlite E2E) | **In progress** | #18 ✅, #19 |", "+| M5 | Tests (parser/unit + sqlite E2E) | **Done** | #18 ✅, #19 ✅ |", " | M6 | Packaging / deployment | Not started | #20 |", " | DevOps | GitHub Actions CI | **Done** | #21 |", " "]}], "userModified": false, "replaceAll": false}, "tool_use_id": "toolu_01H3gkwLtetQ2oWswP1KGWWU", "_ts": "2026-02-21T12:01:26+0900"}
{"session_id": "e02e763a-9559-492f-8eda-46e7ce5ebc26", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/e02e763a-9559-492f-8eda-46e7ce5ebc26.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Grep", "tool_input": {"pattern": "from datetime import date", "path": "/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_parser.py", "output_mode": "content", "-n": true}, "tool_use_id": "toolu_017HQgWjTXsbPQgyAyYz3igw", "_ts": "2026-02-21T12:01:28+0900"}
{"session_id": "e02e763a-9559-492f-8eda-46e7ce5ebc26", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/e02e763a-9559-492f-8eda-46e7ce5ebc26.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Grep", "tool_input": {"pattern": "from datetime import date", "path": "/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_parser.py", "output_mode": "content", "-n": true}, "tool_response": {"mode": "content", "numFiles": 0, "filenames": [], "content": "3:from datetime import date\n34:    from datetime import date\n154:        from datetime import date\n160:        from datetime import date", "numLines": 4}, "tool_use_id": "toolu_017HQgWjTXsbPQgyAyYz3igw", "_ts": "2026-02-21T12:01:29+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "old_string": "1. **#19** — SQLite E2E integration tests (M5)\n2. **#20** — Packaging and distribution setup (M6)", "new_string": "1. **#20** — Packaging and distribution setup (M6)", "replace_all": false}, "tool_use_id": "toolu_01M4DdDRQo37c1b4KVvM21Te", "_ts": "2026-02-21T12:01:30+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "old_string": "1. **#19** — SQLite E2E integration tests (M5)\n2. **#20** — Packaging and distribution setup (M6)", "new_string": "1. **#20** — Packaging and distribution setup (M6)", "replace_all": false}, "tool_response": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/STATUS.md", "oldString": "1. **#19** — SQLite E2E integration tests (M5)\n2. **#20** — Packaging and distribution setup (M6)", "newString": "1. **#20** — Packaging and distribution setup (M6)", "originalFile": "# Project Status — OpenClaw TODO Plugin\n\n**Last updated:** 2026-02-21\n\n## Current Phase\n\n**Kickoff complete** — All planning documents generated. Ready to begin implementation.\n\n## Milestones\n\n| Milestone | Description | Status | Issues |\n|-----------|-------------|--------|--------|\n| M0 | Plugin skeleton + `/todo` command registration | **Done** | #1 |\n| M1 | DB init + migrations + schema_version | **Done** | #2, #3, #4 |\n| M2 | Parser (Slack mention, /p, /s, due correction) | **Done** | #5 |\n| M3 | Commands (add/list/board/move/done/drop/edit) | **Done** | #6 ✅, #16 ✅, #7 ✅, #17 ✅, #10 ✅, #8 ✅, #11 ✅, #9 ✅, #12 ✅ |\n| M4 | Project commands (list/set-private/set-shared) | **Done** | #13 ✅, #14 ✅, #15 ✅ |\n| M5 | Tests (parser/unit + sqlite E2E) | **Done** | #18 ✅, #19 ✅ |\n| M6 | Packaging / deployment | Not started | #20 |\n| DevOps | GitHub Actions CI | **Done** | #21 |\n\n## Critical Path\n\n```\n#1 (skeleton) → #2 (DB conn) → #3 (migration framework) → #4 (V1 schema) → #7 (project resolver) → commands\n#5 (parser) can be developed in parallel with DB track\n```\n\n## Next Issues to Work On\n\n1. **#19** — SQLite E2E integration tests (M5)\n2. **#20** — Packaging and distribution setup (M6)\n\n## Risks\n\n| Risk | Likelihood | Impact | Mitigation |\n|------|-----------|--------|------------|\n| SQLite write contention under concurrent access | Low | Medium | WAL mode + busy_timeout=3000 |\n| Private/shared name collision user confusion | Medium | Low | Option A (private-first) + guidance |\n| Schema migration failures on upgrade | Low | High | schema_version table + sequential migrations |\n| Slack rate limits on heavy usage | Low | Low | Responses are single messages per command |\n\n## Generated Documents\n\n- [x] `docs/requirements.md` — Functional & non-functional requirements\n- [x] `docs/ux_spec.md` — UX specification with all command flows\n- [x] `docs/architecture.md` — Software architecture design\n- [x] `docs/test_plan.md` — Test strategy with 80+ test cases\n- [x] `issues.md` — 20 issues across 7 milestones\n", "structuredPatch": [{"oldStart": 28, "oldLines": 8, "newStart": 28, "newLines": 7, "lines": [" ", " ## Next Issues to Work On", " ", "-1. **#19** — SQLite E2E integration tests (M5)", "-2. **#20** — Packaging and distribution setup (M6)", "+1. **#20** — Packaging and distribution setup (M6)", " ", " ## Risks", " "]}], "userModified": false, "replaceAll": false}, "tool_use_id": "toolu_01M4DdDRQo37c1b4KVvM21Te", "_ts": "2026-02-21T12:01:30+0900"}
{"session_id": "e02e763a-9559-492f-8eda-46e7ce5ebc26", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/e02e763a-9559-492f-8eda-46e7ce5ebc26.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_parser.py", "offset": 31, "limit": 8}, "tool_use_id": "toolu_01H2ggUQHSGowRsERedz4555", "_ts": "2026-02-21T12:01:33+0900"}
{"session_id": "e02e763a-9559-492f-8eda-46e7ce5ebc26", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/e02e763a-9559-492f-8eda-46e7ce5ebc26.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Read", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_parser.py", "offset": 31, "limit": 8}, "tool_response": {"type": "text", "file": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_parser.py", "content": "\ndef test_due_mm_dd_normalisation():\n    \"\"\"due:03-15 should be normalised to current-year YYYY-MM-DD.\"\"\"\n    from datetime import date\n\n    result = parse(\"add Task due:03-15\")\n    expected = f\"{date.today().year}-03-15\"\n    assert result.due == expected", "numLines": 8, "startLine": 31, "totalLines": 350}}, "tool_use_id": "toolu_01H2ggUQHSGowRsERedz4555", "_ts": "2026-02-21T12:01:33+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "git branch --show-current", "description": "Verify still on correct branch"}, "tool_use_id": "toolu_018eTrXiUzNfdEV96dC9K6yF", "_ts": "2026-02-21T12:01:33+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PostToolUse", "tool_name": "Bash", "tool_input": {"command": "git branch --show-current", "description": "Verify still on correct branch"}, "tool_response": {"stdout": "feature/018-parser-tests", "stderr": "", "interrupted": false, "isImage": false, "noOutputExpected": false}, "tool_use_id": "toolu_018eTrXiUzNfdEV96dC9K6yF", "_ts": "2026-02-21T12:01:33+0900"}
{"session_id": "d9e9184e-8a93-462e-8612-6b90dd214d09", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/d9e9184e-8a93-462e-8612-6b90dd214d09.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "default", "hook_event_name": "PreToolUse", "tool_name": "Bash", "tool_input": {"command": "git stash && git checkout feature/019-e2e-tests && git stash pop", "description": "Switch to correct branch with changes"}, "tool_use_id": "toolu_017GviSChJkcqh6tUZ25umGy", "_ts": "2026-02-21T12:01:37+0900"}
{"session_id": "e02e763a-9559-492f-8eda-46e7ce5ebc26", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/e02e763a-9559-492f-8eda-46e7ce5ebc26.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PreToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_parser.py", "old_string": "def test_due_mm_dd_normalisation():\n    \"\"\"due:03-15 should be normalised to current-year YYYY-MM-DD.\"\"\"\n    from datetime import date\n\n    result = parse(\"add Task due:03-15\")", "new_string": "def test_due_mm_dd_normalisation():\n    \"\"\"due:03-15 should be normalised to current-year YYYY-MM-DD.\"\"\"\n    result = parse(\"add Task due:03-15\")", "replace_all": false}, "tool_use_id": "toolu_01XF4Vh7fUaygGufEPrYxWJQ", "_ts": "2026-02-21T12:01:37+0900"}
{"session_id": "e02e763a-9559-492f-8eda-46e7ce5ebc26", "transcript_path": "/Users/pillip/.claude/projects/-Users-pillip-project-practice-openclaw-todo-plugin/e02e763a-9559-492f-8eda-46e7ce5ebc26.jsonl", "cwd": "/Users/pillip/project/practice/openclaw_todo_plugin", "permission_mode": "acceptEdits", "hook_event_name": "PostToolUse", "tool_name": "Edit", "tool_input": {"file_path": "/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_parser.py", "old_string": "def test_due_mm_dd_normalisation():\n    \"\"\"due:03-15 should be normalised to current-year YYYY-MM-DD.\"\"\"\n    from datetime import date\n\n    result = parse(\"add Task due:03-15\")", "new_string": "def test_due_mm_dd_normalisation():\n    \"\"\"due:03-15 should be normalised to current-year YYYY-MM-DD.\"\"\"\n    result = parse(\"add Task due:03-15\")", "replace_all": false}, "tool_response": {"filePath": "/Users/pillip/project/practice/openclaw_todo_plugin/tests/test_parser.py", "oldString": "def test_due_mm_dd_normalisation():\n    \"\"\"due:03-15 should be normalised to current-year YYYY-MM-DD.\"\"\"\n    from datetime import date\n\n    result = parse(\"add Task due:03-15\")", "newString": "def test_due_mm_dd_normalisation():\n    \"\"\"due:03-15 should be normalised to current-year YYYY-MM-DD.\"\"\"\n    result = parse(\"add Task due:03-15\")", "originalFile": "\"\"\"Tests for the command parser.\"\"\"\n\nfrom datetime import date\n\nimport pytest\n\nfrom openclaw_todo.parser import DUE_CLEAR, ParseError, parse\n\n\ndef test_extract_project():\n    \"\"\"/p MyProject should be extracted and token consumed.\"\"\"\n    result = parse(\"add Buy milk /p MyProject\")\n    assert result.project == \"MyProject\"\n    assert result.command == \"add\"\n    assert \"Buy\" in result.title_tokens\n    assert \"/p\" not in result.title_tokens\n    assert \"MyProject\" not in result.title_tokens\n\n\ndef test_extract_section_valid():\n    \"\"\"/s doing should be validated and extracted.\"\"\"\n    result = parse(\"add Task /s doing\")\n    assert result.section == \"doing\"\n\n\ndef test_extract_section_invalid():\n    \"\"\"Invalid section should raise ParseError.\"\"\"\n    with pytest.raises(ParseError, match=\"Invalid section\"):\n        parse(\"add Task /s invalid_section\")\n\n\ndef test_due_mm_dd_normalisation():\n    \"\"\"due:03-15 should be normalised to current-year YYYY-MM-DD.\"\"\"\n    from datetime import date\n\n    result = parse(\"add Task due:03-15\")\n    expected = f\"{date.today().year}-03-15\"\n    assert result.due == expected\n\n\ndef test_due_full_date():\n    \"\"\"due:2026-06-01 should be kept as-is.\"\"\"\n    result = parse(\"add Task due:2026-06-01\")\n    assert result.due == \"2026-06-01\"\n\n\ndef test_due_invalid_date():\n    \"\"\"due:2026-02-30 should raise ParseError.\"\"\"\n    with pytest.raises(ParseError, match=\"Invalid due date\"):\n        parse(\"add Task due:2026-02-30\")\n\n\ndef test_due_clear():\n    \"\"\"due:- should set the clear sentinel.\"\"\"\n    result = parse(\"add Task due:-\")\n    assert result.due == DUE_CLEAR\n\n\ndef test_mentions_extraction():\n    \"\"\"<@U12345> patterns should be extracted into mentions.\"\"\"\n    result = parse(\"add Task <@U12345> <@UABCDE>\")\n    assert result.mentions == [\"U12345\", \"UABCDE\"]\n    assert \"<@U12345>\" not in result.title_tokens\n\n\ndef test_title_extraction():\n    \"\"\"Non-option, non-mention tokens should become title_tokens.\"\"\"\n    result = parse(\"add Buy groceries and cook dinner /p Home due:2026-03-01\")\n    assert result.title_tokens == [\"Buy\", \"groceries\", \"and\", \"cook\", \"dinner\"]\n    assert result.project == \"Home\"\n    assert result.due == \"2026-03-01\"\n\n\ndef test_command_extraction():\n    \"\"\"The first token should be the command.\"\"\"\n    result = parse(\"list mine /p Work\")\n    assert result.command == \"list\"\n    assert \"mine\" in result.title_tokens\n\n\ndef test_move_extracts_id_as_arg():\n    \"\"\"move command should extract task id as first arg.\"\"\"\n    result = parse(\"move 42 /s doing\")\n    assert result.command == \"move\"\n    assert result.args == [\"42\"]\n    assert result.section == \"doing\"\n\n\ndef test_empty_command_raises():\n    \"\"\"Empty text after /todo should raise ParseError.\"\"\"\n    with pytest.raises(ParseError, match=\"Empty command\"):\n        parse(\"\")\n\n\ndef test_section_case_insensitive():\n    \"\"\"/s DOING should be normalised to lowercase.\"\"\"\n    result = parse(\"add Task /s DOING\")\n    assert result.section == \"doing\"\n\n\n# --- Issue #18: Comprehensive edge-case tests ---\n\n\nclass TestOptionsInAnyOrder:\n    \"\"\"Options (/p, /s, due:, mentions) can appear in any position.\"\"\"\n\n    def test_options_before_title(self):\n        \"\"\"Options placed before the title tokens are extracted correctly.\"\"\"\n        result = parse(\"add /p Work /s doing due:2026-05-01 Finish report\")\n        assert result.project == \"Work\"\n        assert result.section == \"doing\"\n        assert result.due == \"2026-05-01\"\n        assert result.title_tokens == [\"Finish\", \"report\"]\n\n    def test_options_interspersed(self):\n        \"\"\"Options interspersed between title tokens are all extracted.\"\"\"\n        result = parse(\"add Buy /p Home groceries /s backlog due:2026-06-01\")\n        assert result.project == \"Home\"\n        assert result.section == \"backlog\"\n        assert result.due == \"2026-06-01\"\n        assert result.title_tokens == [\"Buy\", \"groceries\"]\n\n    def test_all_options_at_end(self):\n        \"\"\"All options after the title tokens.\"\"\"\n        result = parse(\"add Deploy server <@UADMIN> /p Infra /s doing due:2026-07-15\")\n        assert result.project == \"Infra\"\n        assert result.section == \"doing\"\n        assert result.due == \"2026-07-15\"\n        assert result.mentions == [\"UADMIN\"]\n        assert result.title_tokens == [\"Deploy\", \"server\"]\n\n    def test_duplicate_option_last_wins(self):\n        \"\"\"If the same option appears twice, the last value wins.\"\"\"\n        result = parse(\"add Task /p Alpha /p Beta\")\n        assert result.project == \"Beta\"\n\n    def test_duplicate_section_last_wins(self):\n        \"\"\"If /s appears twice, the last value wins.\"\"\"\n        result = parse(\"add Task /s backlog /s doing\")\n        assert result.section == \"doing\"\n\n\nclass TestDueYearBoundary:\n    \"\"\"Due date edge cases around year boundaries and leap years.\"\"\"\n\n    def test_due_feb_29_leap_year(self):\n        \"\"\"due:02-29 should succeed if current year is a leap year (or use full date).\"\"\"\n        # Use full date format to guarantee a leap year\n        result = parse(\"add Task due:2028-02-29\")\n        assert result.due == \"2028-02-29\"\n\n    def test_due_dec_31(self):\n        \"\"\"due:12-31 should normalise to current year Dec 31.\"\"\"\n        from datetime import date\n        result = parse(\"add Task due:12-31\")\n        assert result.due == f\"{date.today().year}-12-31\"\n\n    def test_due_jan_01(self):\n        \"\"\"due:01-01 should normalise to current year Jan 1.\"\"\"\n        from datetime import date\n        result = parse(\"add Task due:1-1\")\n        assert result.due == f\"{date.today().year}-01-01\"\n\n    def test_due_mm_dd_invalid_month(self):\n        \"\"\"due:13-01 (invalid month) should raise ParseError.\"\"\"\n        with pytest.raises(ParseError, match=\"Invalid due date\"):\n            parse(\"add Task due:13-01\")\n\n    def test_due_mm_dd_invalid_day(self):\n        \"\"\"due:02-30 (Feb 30) in MM-DD format should raise ParseError.\"\"\"\n        with pytest.raises(ParseError, match=\"Invalid due date\"):\n            parse(\"add Task due:2-30\")\n\n    def test_due_garbage_string(self):\n        \"\"\"due:notadate should raise ParseError.\"\"\"\n        with pytest.raises(ParseError, match=\"Invalid due date\"):\n            parse(\"add Task due:notadate\")\n\n\nclass TestEmptyTitleNoCrash:\n    \"\"\"Commands with no title tokens should not crash.\"\"\"\n\n    def test_add_no_title_only_options(self):\n        \"\"\"add with only options and no title tokens produces empty title_tokens.\"\"\"\n        result = parse(\"add /p Work /s doing\")\n        assert result.command == \"add\"\n        assert result.title_tokens == []\n        assert result.project == \"Work\"\n\n    def test_list_no_extra_tokens(self):\n        \"\"\"list with no arguments produces empty title_tokens.\"\"\"\n        result = parse(\"list\")\n        assert result.command == \"list\"\n        assert result.title_tokens == []\n\n    def test_move_only_id(self):\n        \"\"\"move with only an ID and no other tokens.\"\"\"\n        result = parse(\"move 5\")\n        assert result.command == \"move\"\n        assert result.args == [\"5\"]\n        assert result.title_tokens == []\n\n    def test_whitespace_only_raises(self):\n        \"\"\"Whitespace-only input should raise ParseError.\"\"\"\n        with pytest.raises(ParseError, match=\"Empty command\"):\n            parse(\"   \")\n\n\nclass TestUnicodeTitle:\n    \"\"\"Unicode characters in titles should be preserved.\"\"\"\n\n    def test_korean_title(self):\n        \"\"\"Korean text in title should be preserved.\"\"\"\n        result = parse(\"add 우유 사기 /p 집\")\n        assert result.title_tokens == [\"우유\", \"사기\"]\n        assert result.project == \"집\"\n\n    def test_emoji_in_title(self):\n        \"\"\"Emoji characters in title should be preserved.\"\"\"\n        result = parse(\"add Fix bug 🐛 /s doing\")\n        assert \"🐛\" in result.title_tokens\n        assert result.section == \"doing\"\n\n    def test_mixed_unicode_and_ascii(self):\n        \"\"\"Mixed unicode and ASCII in the same command.\"\"\"\n        result = parse(\"add 日本語タスク due:2026-04-01 <@UJAPAN>\")\n        assert result.title_tokens == [\"日本語タスク\"]\n        assert result.due == \"2026-04-01\"\n        assert result.mentions == [\"UJAPAN\"]\n\n\nclass TestExtraWhitespace:\n    \"\"\"Extra whitespace should be handled gracefully.\"\"\"\n\n    def test_leading_trailing_whitespace(self):\n        \"\"\"Leading and trailing whitespace stripped.\"\"\"\n        result = parse(\"  add  Task  \")\n        assert result.command == \"add\"\n        assert result.title_tokens == [\"Task\"]\n\n    def test_multiple_spaces_between_tokens(self):\n        \"\"\"Multiple spaces between tokens treated as single separator.\"\"\"\n        result = parse(\"add   Buy   milk   /p   Home\")\n        assert result.title_tokens == [\"Buy\", \"milk\"]\n        assert result.project == \"Home\"\n\n    def test_tabs_in_input(self):\n        \"\"\"Tab characters should be treated as whitespace separators.\"\"\"\n        result = parse(\"add\\tTask\\t/s\\tdoing\")\n        assert result.command == \"add\"\n        assert result.title_tokens == [\"Task\"]\n        assert result.section == \"doing\"\n\n\nclass TestMixedMentionsAndOptions:\n    \"\"\"Mentions and options can appear together in any order.\"\"\"\n\n    def test_mentions_between_options(self):\n        \"\"\"Mentions between /p and /s should be extracted correctly.\"\"\"\n        result = parse(\"add Task /p Work <@UALICE> /s doing <@UBOB>\")\n        assert result.project == \"Work\"\n        assert result.section == \"doing\"\n        assert set(result.mentions) == {\"UALICE\", \"UBOB\"}\n        assert result.title_tokens == [\"Task\"]\n\n    def test_mentions_with_due(self):\n        \"\"\"Mentions combined with due date.\"\"\"\n        result = parse(\"add Review PR <@UDEV1> <@UDEV2> due:2026-03-20\")\n        assert result.mentions == [\"UDEV1\", \"UDEV2\"]\n        assert result.due == \"2026-03-20\"\n        assert result.title_tokens == [\"Review\", \"PR\"]\n\n    def test_all_options_and_multiple_mentions(self):\n        \"\"\"All option types plus multiple mentions in a single command.\"\"\"\n        result = parse(\"add Deploy <@UA> <@UB> /p Infra /s doing due:2026-08-01\")\n        assert result.project == \"Infra\"\n        assert result.section == \"doing\"\n        assert result.due == \"2026-08-01\"\n        assert result.mentions == [\"UA\", \"UB\"]\n        assert result.title_tokens == [\"Deploy\"]\n\n\nclass TestMissingOptionArguments:\n    \"\"\"Missing arguments for /p and /s should raise ParseError.\"\"\"\n\n    def test_p_at_end_without_value(self):\n        \"\"\"/p at end of input without a project name raises ParseError.\"\"\"\n        with pytest.raises(ParseError, match=\"/p requires a project name\"):\n            parse(\"add Task /p\")\n\n    def test_s_at_end_without_value(self):\n        \"\"\"/s at end of input without a section name raises ParseError.\"\"\"\n        with pytest.raises(ParseError, match=\"/s requires a section name\"):\n            parse(\"add Task /s\")\n\n\nclass TestIdExtractionCommands:\n    \"\"\"Commands that extract an ID as the first arg: move, done, drop, edit.\"\"\"\n\n    def test_done_extracts_id(self):\n        \"\"\"done command extracts task ID as first arg.\"\"\"\n        result = parse(\"done 99\")\n        assert result.command == \"done\"\n        assert result.args == [\"99\"]\n\n    def test_drop_extracts_id(self):\n        \"\"\"drop command extracts task ID as first arg.\"\"\"\n        result = parse(\"drop 7\")\n        assert result.command == \"drop\"\n        assert result.args == [\"7\"]\n\n    def test_edit_extracts_id_with_title_tokens(self):\n        \"\"\"edit command extracts ID and preserves remaining title tokens.\"\"\"\n        result = parse(\"edit 3 New title text /s doing\")\n        assert result.command == \"edit\"\n        assert result.args == [\"3\"]\n        assert result.title_tokens == [\"New\", \"title\", \"text\"]\n        assert result.section == \"doing\"\n\n    def test_add_does_not_extract_id(self):\n        \"\"\"add command does NOT extract first token as ID.\"\"\"\n        result = parse(\"add 42 is the answer\")\n        assert result.command == \"add\"\n        assert result.args == []\n        assert result.title_tokens == [\"42\", \"is\", \"the\", \"answer\"]\n\n\nclass TestCommandCaseInsensitive:\n    \"\"\"Command names should be case-insensitive.\"\"\"\n\n    def test_uppercase_command(self):\n        \"\"\"ADD should be normalised to add.\"\"\"\n        result = parse(\"ADD Task\")\n        assert result.command == \"add\"\n\n    def test_mixed_case_command(self):\n        \"\"\"LiSt should be normalised to list.\"\"\"\n        result = parse(\"LiSt\")\n        assert result.command == \"list\"\n\n\nclass TestAllSections:\n    \"\"\"All valid sections should be accepted.\"\"\"\n\n    @pytest.mark.parametrize(\"section\", [\"backlog\", \"doing\", \"waiting\", \"done\", \"drop\"])\n    def test_valid_section(self, section):\n        \"\"\"Each valid section name is accepted.\"\"\"\n        result = parse(f\"add Task /s {section}\")\n        assert result.section == section\n", "structuredPatch": [{"oldStart": 31, "oldLines": 8, "newStart": 31, "newLines": 6, "lines": [" ", " def test_due_mm_dd_normalisation():", "     \"\"\"due:03-15 should be normalised to current-year YYYY-MM-DD.\"\"\"", "-    from datetime import date", "-", "     result = parse(\"add Task due:03-15\")", "     expected = f\"{date.today().year}-03-15\"", "     assert result.due == expected"]}], "userModified": false, "replaceAll": false}, "tool_use_id": "toolu_01XF4Vh7fUaygGufEPrYxWJQ", "_ts": "2026-02-21T12:01:38+0900"}
